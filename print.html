<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Xieby1&#x27;s Nix/NixOS Config</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">🏠主页</li><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> 📔README.md</a></li><li class="chapter-item expanded affix "><li class="part-title">🌏全局配置</li><li class="chapter-item expanded "><a href="config.nix.html"><strong aria-hidden="true">2.</strong> config.nix</a></li><li class="chapter-item expanded "><a href="nix/nix.conf.html"><strong aria-hidden="true">3.</strong> TODO: nix/nix.conf</a></li><li class="chapter-item expanded "><a href="opt.nix.html"><strong aria-hidden="true">4.</strong> opt.nix</a></li><li class="chapter-item expanded affix "><li class="part-title">🖥️系统配置(需sudo,用于NixOS)</li><li class="chapter-item expanded "><a href="system.nix.html"><strong aria-hidden="true">5.</strong> system.nix</a></li><li class="chapter-item expanded "><a href="sys/index.html"><strong aria-hidden="true">6.</strong> sys/</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">6.1.</strong> cli/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="sys/cli/build-machines.nix.html"><strong aria-hidden="true">6.1.1.</strong> build-machines.nix.md</a></li><li class="chapter-item expanded "><a href="sys/cli/default.nix.html"><strong aria-hidden="true">6.1.2.</strong> sys/cli</a></li></ol></li><li class="chapter-item expanded "><a href="sys/default.nix.html"><strong aria-hidden="true">6.2.</strong> sys/default.nix</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.3.</strong> gui/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="sys/gui/default.nix.html"><strong aria-hidden="true">6.3.1.</strong> default.nix.md</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.4.</strong> modules/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="sys/modules/cachix.nix.html"><strong aria-hidden="true">6.4.1.</strong> cachix.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="sys/wayland.html"><strong aria-hidden="true">6.5.</strong> Currently, Not Wayland, But X11</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">😺用户配置(无需sudo,用于Nix/NixOS)</li><li class="chapter-item expanded "><a href="home.nix.html"><strong aria-hidden="true">7.</strong> home.nix</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> usr/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/cli/index.html"><strong aria-hidden="true">8.1.</strong> cli/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/cli/clash.nix.html"><strong aria-hidden="true">8.1.1.</strong> clash.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/clashctl.nix.html"><strong aria-hidden="true">8.1.2.</strong> clashctl.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/ctags.nix.html"><strong aria-hidden="true">8.1.3.</strong> ctags.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/default.nix.html"><strong aria-hidden="true">8.1.4.</strong> default.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/deprecated.searxng.nix.html"><strong aria-hidden="true">8.1.5.</strong> When init searxng, it throws ERROR:searx.engines.wikidata: Fail to initialize</a></li><li class="chapter-item expanded "><a href="usr/cli/extra.nix.html"><strong aria-hidden="true">8.1.6.</strong> cli-extra.nix: Extra CLI configs (added to minimal cli config)</a></li><li class="chapter-item expanded "><a href="usr/cli/fzf.nix.html"><strong aria-hidden="true">8.1.7.</strong> fzf.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/gdb.nix.html"><strong aria-hidden="true">8.1.8.</strong> GDB configurations</a></li><li class="chapter-item expanded "><a href="usr/cli/git.nix.html"><strong aria-hidden="true">8.1.9.</strong> git.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/kaleido.nix.html"><strong aria-hidden="true">8.1.10.</strong> kaleido.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/ld.html"><strong aria-hidden="true">8.1.11.</strong> binutils's ld and gcc's ld collsion</a></li><li class="chapter-item expanded "><a href="usr/cli/mcfly.nix.html"><strong aria-hidden="true">8.1.12.</strong> * hstr: not handle ~ correctly, always expand</a></li><li class="chapter-item expanded "><a href="usr/cli/node.html"><strong aria-hidden="true">8.1.13.</strong> Nodejs packages (npm) in NixOS</a></li><li class="chapter-item expanded "><a href="usr/cli/python.html"><strong aria-hidden="true">8.1.14.</strong> Python in Nix/NixOS</a></li><li class="chapter-item expanded "><a href="usr/cli/ssh.nix.html"><strong aria-hidden="true">8.1.15.</strong> ssh.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/static_qemu.html"><strong aria-hidden="true">8.1.16.</strong> 静态链接，以qemu为例</a></li><li class="chapter-item expanded "><a href="usr/cli/tailscale.html"><strong aria-hidden="true">8.1.17.</strong> Tailscale/Headscale</a></li><li class="chapter-item expanded "><a href="usr/cli/tailscale.nix.html"><strong aria-hidden="true">8.1.18.</strong> tailscale.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/tmux.nix.html"><strong aria-hidden="true">8.1.19.</strong> tmux</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/index.html"><strong aria-hidden="true">8.1.20.</strong> 📑neovim</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/cli/vim/auto-session.nix.html"><strong aria-hidden="true">8.1.20.1.</strong> auto sessions management</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/blink-cmp.nix.html"><strong aria-hidden="true">8.1.20.2.</strong> completion</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/close-windows.nix.html"><strong aria-hidden="true">8.1.20.3.</strong> key bindings of closing windows</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/codecompanion-nvim.nix.html"><strong aria-hidden="true">8.1.20.4.</strong> Code Companion: AI</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/color-scheme.nix.html"><strong aria-hidden="true">8.1.20.5.</strong> 🎨My nvim color scheme</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/conform-nvim.nix.html"><strong aria-hidden="true">8.1.20.6.</strong> conform-nvim: formatter</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/default.nix.html"><strong aria-hidden="true">8.1.20.7.</strong> default.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/fold.nix.html"><strong aria-hidden="true">8.1.20.8.</strong> fold</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/git-wip.nix.html"><strong aria-hidden="true">8.1.20.9.</strong> git-wip: auto wip branch</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/gitsigns-nvim.nix.html"><strong aria-hidden="true">8.1.20.10.</strong> gitsigns-nvim: git support</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/hbac-nvim.nix.html"><strong aria-hidden="true">8.1.20.11.</strong> hbac-nvim: auto close buffer</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/leap-nvim.nix.html"><strong aria-hidden="true">8.1.20.12.</strong> leap-nvim.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/markdown-preview-nvim.nix.html"><strong aria-hidden="true">8.1.20.13.</strong> markdown-preview-nvim.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/mini-nvim.nix.html"><strong aria-hidden="true">8.1.20.14.</strong> mini-nvim: a nvim distro</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/minuet-ai-nvim.nix.html"><strong aria-hidden="true">8.1.20.15.</strong> minuet-ai-nvim.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-config-local.nix.html"><strong aria-hidden="true">8.1.20.16.</strong> nvim-config-local: secure load local vim config</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.1.20.17.</strong> nvim-lspconfig/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-lspconfig/c.nix.html"><strong aria-hidden="true">8.1.20.17.1.</strong> lspconfig for C/C++ language</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-lspconfig/default.nix.html"><strong aria-hidden="true">8.1.20.17.2.</strong> nvim-lspconfig</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-lspconfig/rust.nix.html"><strong aria-hidden="true">8.1.20.17.3.</strong> rust.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-lspconfig/scala.nix.html"><strong aria-hidden="true">8.1.20.17.4.</strong> If metals throw errors, check /.metals/metals.log</a></li></ol></li><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-nav.nix.html"><strong aria-hidden="true">8.1.20.18.</strong> nvim-nav.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-treesitter.nix.html"><strong aria-hidden="true">8.1.20.19.</strong> nvim-treesitter: languages parsing</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-window-picker.nix.html"><strong aria-hidden="true">8.1.20.20.</strong> nvim-window-picker</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/outline-nvim.nix.html"><strong aria-hidden="true">8.1.20.21.</strong> outline-nvim.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/reject.avante-nvim.nix.html"><strong aria-hidden="true">8.1.20.22.</strong> avante-nvim: AI</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/reject.distant-nvim.nix.html"><strong aria-hidden="true">8.1.20.23.</strong> distant-nvim: edit remote files with local nvim</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/reject.remote-sshfs-nvim.nix.html"><strong aria-hidden="true">8.1.20.24.</strong> Deprecated: remote-sshfs.nvim: integrate sshfs into nvim</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/smartyank-nvim.nix.html"><strong aria-hidden="true">8.1.20.25.</strong> smartyank-nvim: smart yank to clipboard</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/snacks-nvim.nix.html"><strong aria-hidden="true">8.1.20.26.</strong> image-nvim vs snacks-nvim问题</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/telescope-nvim.nix.html"><strong aria-hidden="true">8.1.20.27.</strong> telescope-nvim</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/venn-nvim.nix.html"><strong aria-hidden="true">8.1.20.28.</strong> DrawIt vs venn-nvim</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/vim-easy-align.nix.html"><strong aria-hidden="true">8.1.20.29.</strong> vim-easy-align: A simple, easy-to-use Vim alignment plugin.</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/vim-floaterm.nix.html"><strong aria-hidden="true">8.1.20.30.</strong> vim-floaterm: floating terminal</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/vim-hexokinase.nix.html"><strong aria-hidden="true">8.1.20.31.</strong> vim-hexokinase: display colors</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/vim-mark.nix.html"><strong aria-hidden="true">8.1.20.32.</strong> vim-mark: multi-color highlight</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/vim-matchup.nix.html"><strong aria-hidden="true">8.1.20.33.</strong> vim-matchup.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/winshift-nvim.nix.html"><strong aria-hidden="true">8.1.20.34.</strong> winshift-nvim: rearrange windows</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="usr/default.nix.html"><strong aria-hidden="true">8.2.</strong> usr/default.nix</a></li><li class="chapter-item expanded "><a href="usr/gui/index.html"><strong aria-hidden="true">8.3.</strong> gui/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/gui/default.nix.html"><strong aria-hidden="true">8.3.1.</strong> default.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/drawio.nix.html"><strong aria-hidden="true">8.3.2.</strong> drawio.nix.md</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.3.</strong> fcitx5/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/gui/fcitx5/default.nix.html"><strong aria-hidden="true">8.3.3.1.</strong> default.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/fcitx5/module.nix.html"><strong aria-hidden="true">8.3.3.2.</strong> module.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="usr/gui/feishu.html"><strong aria-hidden="true">8.3.4.</strong> 安装deb包，以飞书为例</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.5.</strong> firefox/</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.5.1.</strong> apps/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/gui/firefox/apps/default.nix.html"><strong aria-hidden="true">8.3.5.1.1.</strong> firefox-apps</a></li><li class="chapter-item expanded "><a href="usr/gui/firefox/apps/module.nix.html"><strong aria-hidden="true">8.3.5.1.2.</strong> firefox module</a></li><li class="chapter-item expanded "><a href="usr/gui/firefox/apps/single-tab.nix.html"><strong aria-hidden="true">8.3.5.1.3.</strong> single-tab.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="usr/gui/firefox/default.nix.html"><strong aria-hidden="true">8.3.5.2.</strong> firefox configurations</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.5.3.</strong> extensions/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/gui/firefox/extensions/brotab.nix.html"><strong aria-hidden="true">8.3.5.3.1.</strong> brotab.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/firefox/extensions/darkreader.nix.html"><strong aria-hidden="true">8.3.5.3.2.</strong> darkreader.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/firefox/extensions/default.nix.html"><strong aria-hidden="true">8.3.5.3.3.</strong> default.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/firefox/extensions/module.nix.html"><strong aria-hidden="true">8.3.5.3.4.</strong> module.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/firefox/extensions/sidebery.nix.html"><strong aria-hidden="true">8.3.5.3.5.</strong> TIPS (https://github.com/piroor/treestyletab/wiki/How-to-inspect-tree-of-tabs):</a></li><li class="chapter-item expanded "><a href="usr/gui/firefox/extensions/smart-toc.nix.html"><strong aria-hidden="true">8.3.5.3.6.</strong> smart-toc.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/firefox/extensions/smartproxy.nix.html"><strong aria-hidden="true">8.3.5.3.7.</strong> smartproxy.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/firefox/extensions/vimium.nix.html"><strong aria-hidden="true">8.3.5.3.8.</strong> vimium.nix.md</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="usr/gui/flameshot.nix.html"><strong aria-hidden="true">8.3.6.</strong> flameshot.nix.md</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.7.</strong> gnome/</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.7.1.</strong> calendar/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/gui/gnome/calendar/default.nix.html"><strong aria-hidden="true">8.3.7.1.1.</strong> default.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/calendar/module.nix.html"><strong aria-hidden="true">8.3.7.1.2.</strong> gnome-calendar module</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/calendar/template.nix.html"><strong aria-hidden="true">8.3.7.1.3.</strong> template.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="usr/gui/gnome/default.nix.html"><strong aria-hidden="true">8.3.7.2.</strong> default.nix.md</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.7.3.</strong> extensions/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/advanced-alttab-window-switcher.nix.html"><strong aria-hidden="true">8.3.7.3.1.</strong> advanced-alttab-window-switcher</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/auto-accent-colour.nix.html"><strong aria-hidden="true">8.3.7.3.2.</strong> auto-accent-colour.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/bing-wallpaper-changer.nix.html"><strong aria-hidden="true">8.3.7.3.3.</strong> BingWallpaper</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/bluetooth-battery-meter.nix.html"><strong aria-hidden="true">8.3.7.3.4.</strong> bluetooth battery meter</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/dash-to-dock.nix.html"><strong aria-hidden="true">8.3.7.3.5.</strong> dash-to-dock</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/default.nix.html"><strong aria-hidden="true">8.3.7.3.6.</strong> Gnome Extensions</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/deprecated.customize-ibus.nix.html"><strong aria-hidden="true">8.3.7.3.7.</strong> customize-ibus: input method customization</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/gtile.nix.html"><strong aria-hidden="true">8.3.7.3.8.</strong> gtile: tiled windows manager</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/hide-top-bar.nix.html"><strong aria-hidden="true">8.3.7.3.9.</strong> hide-top-bar</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/lunar-calendar.nix.html"><strong aria-hidden="true">8.3.7.3.10.</strong> lunar-calendar.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/pano.nix.html"><strong aria-hidden="true">8.3.7.3.11.</strong> pano: Next-gen Clipboard Manager for Gnome Shell</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/system-monitor.nix.html"><strong aria-hidden="true">8.3.7.3.12.</strong> system-monitor</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/transparent-top-bar.nix.html"><strong aria-hidden="true">8.3.7.3.13.</strong> transparent-top-bar: able to adjust transparency</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/unite.nix.html"><strong aria-hidden="true">8.3.7.3.14.</strong> unite: unite style</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="usr/gui/kdeconnect.nix.html"><strong aria-hidden="true">8.3.8.</strong> KDE Connect</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.9.</strong> kitty/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/gui/kitty/default.nix.html"><strong aria-hidden="true">8.3.9.1.</strong> kitty</a></li><li class="chapter-item expanded "><a href="usr/gui/kitty/search.nix.html"><strong aria-hidden="true">8.3.9.2.</strong> search.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/kitty/timer.nix.html"><strong aria-hidden="true">8.3.9.3.</strong> timer.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="usr/gui/mime.nix.html"><strong aria-hidden="true">8.3.10.</strong> https://nixos.org/manual/nixos/stable/#sec-writing-modules</a></li><li class="chapter-item expanded "><a href="usr/gui/rofi.nix.html"><strong aria-hidden="true">8.3.11.</strong> rofi.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/rustdesk.nix.html"><strong aria-hidden="true">8.3.12.</strong> rustdesk, the remote desktop app</a></li><li class="chapter-item expanded "><a href="usr/gui/singleton_apps.nix.html"><strong aria-hidden="true">8.3.13.</strong> singleton_apps.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/typora.html"><strong aria-hidden="true">8.3.14.</strong> Typora</a></li><li class="chapter-item expanded "><a href="usr/gui/warpd.nix.html"><strong aria-hidden="true">8.3.15.</strong> warpd.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/waydroid.html"><strong aria-hidden="true">8.3.16.</strong> Wayland</a></li><li class="chapter-item expanded "><a href="usr/gui/weixin.nix.html"><strong aria-hidden="true">8.3.17.</strong> weixin.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/wrapWine.nix.html"><strong aria-hidden="true">8.3.18.</strong> based on https://github.com/lucasew/nixcfg/blob/49d44c1a655f1c20d7354ecea942c78704067d50/pkgs/wrapWine.nix</a></li><li class="chapter-item expanded "><a href="usr/gui/wsl.nix.html"><strong aria-hidden="true">8.3.19.</strong> wsl.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/xcolor.nix.html"><strong aria-hidden="true">8.3.20.</strong> XColor</a></li><li class="chapter-item expanded "><a href="usr/gui/xdot.nix.html"><strong aria-hidden="true">8.3.21.</strong> xdot, the dot (graphviz) viewer</a></li><li class="chapter-item expanded "><a href="usr/gui/xelfviewer.nix.html"><strong aria-hidden="true">8.3.22.</strong> xelfviewer.nix.md</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.4.</strong> modules/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/modules/cachix.nix.html"><strong aria-hidden="true">8.4.1.</strong> cachix.nix.md</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">🤖安卓配置(无需sudo,复用"用户配置")</li><li class="chapter-item expanded "><a href="nix-on-droid.nix.html"><strong aria-hidden="true">9.</strong> nix-on-droid.nix</a></li><li class="chapter-item expanded affix "><li class="part-title">🔩通用模块</li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.</strong> modules/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="modules/cachix.nix.html"><strong aria-hidden="true">10.1.</strong> cachix.nix.md</a></li><li class="chapter-item expanded "><a href="modules/default.nix.html"><strong aria-hidden="true">10.2.</strong> default.nix.md</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">📝文档和心得体会</li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.</strong> docs/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="docs/explanation/index.html"><strong aria-hidden="true">11.1.</strong> explanation/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="docs/explanation/modules.html"><strong aria-hidden="true">11.1.1.</strong> Module</a></li><li class="chapter-item expanded "><a href="docs/explanation/nixpkgs.html"><strong aria-hidden="true">11.1.2.</strong> Nixpkgs</a></li></ol></li><li class="chapter-item expanded "><a href="docs/howto/index.html"><strong aria-hidden="true">11.2.</strong> howto/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="docs/howto/32bit.html"><strong aria-hidden="true">11.2.1.</strong> 打包/编译32位程序</a></li><li class="chapter-item expanded "><a href="docs/howto/auto_push_to_cachix/index.html"><strong aria-hidden="true">11.2.2.</strong> Auto Push Packages to Cachix</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="docs/howto/auto_push_to_cachix/cachix-package.nix.html"><strong aria-hidden="true">11.2.2.1.</strong> cachixPackage</a></li><li class="chapter-item expanded "><a href="docs/howto/auto_push_to_cachix/test.nix.html"><strong aria-hidden="true">11.2.2.2.</strong> Test for cachixPackage</a></li></ol></li><li class="chapter-item expanded "><a href="docs/howto/backup_binary_cache.html"><strong aria-hidden="true">11.2.3.</strong> 备份binary cache</a></li><li class="chapter-item expanded "><a href="docs/howto/cross.html"><strong aria-hidden="true">11.2.4.</strong> 交叉编译和安装跨平台程序</a></li><li class="chapter-item expanded "><a href="docs/howto/install_nixos.html"><strong aria-hidden="true">11.2.5.</strong> 安装NixOS</a></li><li class="chapter-item expanded "><a href="docs/howto/kernel_config.html"><strong aria-hidden="true">11.2.6.</strong> How To Config Linux Kernel in Nix</a></li></ol></li><li class="chapter-item expanded "><a href="docs/slides/index.html"><strong aria-hidden="true">11.3.</strong> slides/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="docs/slides/2023.nix-env.html"><strong aria-hidden="true">11.3.1.</strong> Nix让你的团队成员不再受环境问题困扰</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">📃Nix脚本（nix-shell和打包）</li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.</strong> scripts/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="scripts/fhs-shell/index.html"><strong aria-hidden="true">12.1.</strong> fhs-shell/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="scripts/fhs-shell/dynamorio.nix.html"><strong aria-hidden="true">12.1.1.</strong> dynamorio.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/fhs-shell/hello.nix.html"><strong aria-hidden="true">12.1.2.</strong> hello.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/fhs-shell/pin.nix.html"><strong aria-hidden="true">12.1.3.</strong> pin.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/fhs-shell/spec.nix.html"><strong aria-hidden="true">12.1.4.</strong> spec.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/fhs-shell/x11.nix.html"><strong aria-hidden="true">12.1.5.</strong> x11.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/fhs-shell/xilinx.nix.html"><strong aria-hidden="true">12.1.6.</strong> xilinx.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="scripts/pkgs/index.html"><strong aria-hidden="true">12.2.</strong> pkgs/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="scripts/pkgs/7z.nix.html"><strong aria-hidden="true">12.2.1.</strong> TODO: 7z need dynamical link 7z.so</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/android.html"><strong aria-hidden="true">12.2.2.</strong> 在NixOS上使用Android程序</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/android.nix.html"><strong aria-hidden="true">12.2.3.</strong> android.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/appimage_runtime.nix.html"><strong aria-hidden="true">12.2.4.</strong> appimage_runtime.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/coremarks.nix.html"><strong aria-hidden="true">12.2.5.</strong> coremarks.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/cross_mips.nix.html"><strong aria-hidden="true">12.2.6.</strong> cross_mips.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/cross_static_hello.nix.html"><strong aria-hidden="true">12.2.7.</strong> cross_static_hello.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/fhs_helloworld.nix.html"><strong aria-hidden="true">12.2.8.</strong> fhs_helloworld.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/fhs_spec2000_perl.nix.html"><strong aria-hidden="true">12.2.9.</strong> fhs_spec2000_perl.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/herdtools7.nix.html"><strong aria-hidden="true">12.2.10.</strong> herdtools7.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/nix-binary-tarballs-new.nix.html"><strong aria-hidden="true">12.2.11.</strong> nix-binary-tarballs-new.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/nix-binary-tarballs.nix.html"><strong aria-hidden="true">12.2.12.</strong> nix-binary-tarballs.nix.md</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.2.13.</strong> nix-docker-isa/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="scripts/pkgs/nix-docker-isa/default.nix.html"><strong aria-hidden="true">12.2.13.1.</strong> 🐳Nix Docker🐋 for Multiple ISAs</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/nix-docker-isa/dockers.nix.html"><strong aria-hidden="true">12.2.13.2.</strong> dockers.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="scripts/pkgs/nvchad.nix.html"><strong aria-hidden="true">12.2.14.</strong> nvchad.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/qemu-sys-static.nix.html"><strong aria-hidden="true">12.2.15.</strong> qemu-sys-static.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/qemu-sys_riscv64_static.nix.html"><strong aria-hidden="true">12.2.16.</strong> qemu-sys_riscv64_static.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/qemu_riscv64_static.nix.html"><strong aria-hidden="true">12.2.17.</strong> qemu_riscv64_static.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/qemu_static.nix.html"><strong aria-hidden="true">12.2.18.</strong> qemu_static.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/qemu_tests_tcg.nix.html"><strong aria-hidden="true">12.2.19.</strong> qemu_tests_tcg.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/qemus.nix.html"><strong aria-hidden="true">12.2.20.</strong> build by version</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/shellinabox.nix.html"><strong aria-hidden="true">12.2.21.</strong> https://github.com/NixOS/nixpkgs/issues/185773</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/xiangshan.nix.html"><strong aria-hidden="true">12.2.22.</strong> xiangshan.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="scripts/shell/index.html"><strong aria-hidden="true">12.3.</strong> shell/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="scripts/shell/LinkNan.nix.html"><strong aria-hidden="true">12.3.1.</strong> LinkNan.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/ccache.nix.html"><strong aria-hidden="true">12.3.2.</strong> ccache.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/chipyard.nix.html"><strong aria-hidden="true">12.3.3.</strong> chipyard.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/cross_mips.nix.html"><strong aria-hidden="true">12.3.4.</strong> cross_mips.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/cross_platform.nix.html"><strong aria-hidden="true">12.3.5.</strong> cross_platform.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/devshell_hello.nix.html"><strong aria-hidden="true">12.3.6.</strong> devshell_hello.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/gcc.nix.html"><strong aria-hidden="true">12.3.7.</strong> gcc.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/hello.nix.html"><strong aria-hidden="true">12.3.8.</strong> hello.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/pygame.nix.html"><strong aria-hidden="true">12.3.9.</strong> pygame.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/python_fhs_venv.nix.html"><strong aria-hidden="true">12.3.10.</strong> https://nixos.wiki/wiki/Python</a></li><li class="chapter-item expanded "><a href="scripts/shell/python_mach.nix.html"><strong aria-hidden="true">12.3.11.</strong> python_mach.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/python_venv.nix.html"><strong aria-hidden="true">12.3.12.</strong> python_venv.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/qemu_plugins.nix.html"><strong aria-hidden="true">12.3.13.</strong> qemu_plugins.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/qemu_tests_tcg.nix.html"><strong aria-hidden="true">12.3.14.</strong> qemu_tests_tcg.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/riscv-tests.nix.html"><strong aria-hidden="true">12.3.15.</strong> riscv-tests.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/spike.nix.html"><strong aria-hidden="true">12.3.16.</strong> spike.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/texlive.nix.html"><strong aria-hidden="true">12.3.17.</strong> texlive.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/ucasproposal.nix.html"><strong aria-hidden="true">12.3.18.</strong> ucasproposal.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/v8.nix.html"><strong aria-hidden="true">12.3.19.</strong> v8.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/venv.nix.html"><strong aria-hidden="true">12.3.20.</strong> venv.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/wine6.nix.html"><strong aria-hidden="true">12.3.21.</strong> wine6.nix.md</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">📌其他</li><li class="chapter-item expanded "><a href="shell.nix.html"><strong aria-hidden="true">13.</strong> shell.nix</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Xieby1&#x27;s Nix/NixOS Config</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/xieby1/nix_config" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p>🏗️ <em>我的Nix/NixOS配置详细文档正在施工中，完成进度：<span style="font-size:2em;"><strong>70/165</strong></span></em> 🏗️</p>
<p>为了更好的文档阅读体验，请看<a href="https://xieby1.github.io/nix_config/">GitHub Pages</a>的版本。</p>
<h2 id="目录"><a class="header" href="#目录">目录</a></h2>
<!-- vim-markdown-toc GFM -->
<ul>
<li><a href="index.html#nixnixos%E7%AE%80%E4%BB%8B">Nix/NixOS简介</a></li>
<li><a href="index.html#xieby1%E5%92%8Cnixnixos">xieby1和Nix/NixOS</a></li>
<li><a href="index.html#xieby1%E7%9A%84nixnixos%E9%85%8D%E7%BD%AE">xieby1的Nix/NixOS配置</a>
<ul>
<li><a href="index.html#%E6%96%87%E4%BB%B6%E5%A4%B9%E7%BB%93%E6%9E%84">文件夹结构</a></li>
<li><a href="index.html#nix%E8%84%9A%E6%9C%AC%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95">nix脚本的使用方法</a>
<ul>
<li><a href="index.html#nix-shell%E7%9A%84%E4%BE%8B%E5%AD%90">nix-shell的例子</a></li>
</ul>
</li>
<li><a href="index.html#nix%E9%85%8D%E7%BD%AE%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95">nix配置的使用方法</a></li>
<li><a href="index.html#%E5%BC%95%E7%94%A8">引用</a></li>
</ul>
</li>
</ul>
<!-- vim-markdown-toc -->
<h1 id="nixnixos简介"><a class="header" href="#nixnixos简介">Nix/NixOS简介</a></h1>
<p>Nix是一个可重现的（Reproducible）包管理器，也是一门纯函数式的（Pure Functional）编程语言。
理论上讲，Nix包管理器可以安装在任何Linux发行版上(比如Ubuntu、Debian和Arch等)，并与这些发行版原有的包管理器（比如snap、apt和pacman等）共存。
而NixOS则是完全由Nix包管理器进行管理的Linux发行版。</p>
<p>Nix/NixOS采用了“包（Package）”的理念，将Linux内核、驱动、函数库、用户程序、配置文件等方方面面抽象出来。
这类似于Linux内核将设备、磁盘文件、管道等都抽象为文件的理念。
这样的抽象使得Nix/NixOS能以一种统一的方式管理所有的包。</p>
<p>为了防止“包”被用户有意或无意地修改（即保证可重现性），Nix/NixOS将所有的包都放在一个只读文件系统中（挂载在<code>/nix/store</code>目录上）。
这个目录中的包仅能通过Nix包管理器和Nix语言编程进行增删改。
为了将<code>/nix/store</code>中的文件放置在它们应该在的地方（比如某个用户使用的包里存在<code>bin/</code>目录，则应当把bin/中所有的文件放入<code>/run/current-system/sw/bin/</code>），Nix/NixOS大量使用符号链接。</p>
<p>上述Nix/NixOS的特点和传统Linux发行版有着极大的区别。
这使得Nix/NixOS的学习曲线十分陡峭。
不过当你适应Nix/NixOS的这些特点后，它可以极大提升工程效率!</p>
<h1 id="xieby1和nixnixos"><a class="header" href="#xieby1和nixnixos">xieby1和Nix/NixOS</a></h1>
<p>多年来，Nix/NixOS已成为我学习和工作的重要基础，主要用于以下方面：</p>
<ul>
<li>学习Linux。
Nix/NixOS采用了“包（Package）”的理念，将Linux内核、驱动、函数库、用户程序、配置文件等方方面面抽象出来。
通过学习Nix语言，我能够以统一的方式了解Linux系统的各个方面，这是其他工具所无法提供的。</li>
<li>管理环境。
通过使用nix-shell管理所有依赖（包括库、环境变量、配置等），可以避免项目环境重现的问题。
类似的工具还有虚拟机和Docker。
相比使用虚拟机，它更轻量。
相比Docker，它支持可复现构建，采用Nix语言更灵活。
详细可见我于2023年为实验室同学们准备的<a href="https://xieby1.github.io/nix_config/docs/slides/2023.nix-env.html">推荐Nix/NixOS的幻灯片</a>。</li>
<li>备份电脑。
Nix/NixOS能够管理系统、软件及其配置。
虽然Nix/NixOS不直接管理数据，但Nix/NixOS可以很好地管理数据同步软件，比如Syncthing。
因此只要保留着Nix/NixOS的配置文件（由Nix语言编写），就能恢复出一个几乎一模一样<sup class="footnote-reference"><a href="#impure">1</a></sup>的软件环境/操作系统。</li>
</ul>
<h1 id="xieby1的nixnixos配置"><a class="header" href="#xieby1的nixnixos配置">xieby1的Nix/NixOS配置</a></h1>
<p>这个仓库<a href="https://github.com/xieby1/nix_config">Github: xieby1/nix_config</a>里存放着我的Nix/NixOS配置和文档。
该仓库使用nix expression，而非nix flakes；
使用NixOS稳定源（目前版本25.05），而非非稳定源（unstable）。
该仓库的配置在多个平台都可以正常使用：</p>
<ul>
<li>NixOS: QEMU✅，NixOS单系统✅，NixOS+Windows双系统✅</li>
<li>Nix: Linux✅，安卓（nix-on-droid）✅，WSL2✅</li>
</ul>
<p>你可以使用该仓库的配置，配置出完整NixOS操作系统。
也可以使用其中的部分包、模块，扩充自己的Nix/NixOS。
若你不仅只是想安装Nix/NixOS，还想了解更多Nix/NixOS的知识，
欢迎看看这个仓库的文档<a href="https://xieby1.github.io/nix_config">xieby1.github.io/nix_config</a>。</p>
<h2 id="文件夹结构"><a class="header" href="#文件夹结构">文件夹结构</a></h2>
<ul>
<li>docs/: 文档</li>
<li>scripts/: nix脚本
<ul>
<li>fhs-shell/: 采用FHS的nix-shell脚本</li>
<li>shell/: nix-shell脚本</li>
<li>pkgs/: 独立的软件包脚本</li>
</ul>
</li>
<li>sys/: 系统总体配置（nixos-rebuild的配置）
<ul>
<li>cli/: 系统命令行配置</li>
<li>gui/: 系统图形配置</li>
<li>modules/: 系统模块</li>
</ul>
</li>
<li>usr/: 用户总体配置（home-manager的配置）
<ul>
<li>cli/: 用户命令行配置</li>
<li>gui/: 用户图形配置</li>
<li>modules/: 用户模块</li>
</ul>
</li>
<li>nix-on-droid.nix: 安卓总体配置（nix-on-droid的配置）</li>
<li>modules/: nixos/home-manager通用的模块</li>
</ul>
<h2 id="nix脚本的使用方法"><a class="header" href="#nix脚本的使用方法">nix脚本的使用方法</a></h2>
<p>安装Nix不在此赘述，参考<a href="https://nixos.org/download.html">nixos.org/download.html</a>。</p>
<p>安装完Nix后，下载所需的nix脚本，然后：</p>
<ul>
<li><code>fhs-shell/</code>和<code>shell/</code>脚本用<code>nix-shell</code>命令进入shell环境；</li>
<li><code>pkgs/</code>脚本用<code>nix-build</code>命令生成软件包。</li>
</ul>
<h3 id="nix-shell的例子"><a class="header" href="#nix-shell的例子">nix-shell的例子</a></h3>
<pre><code class="language-bash"># 以xiangshan.nix配置香山开发环境为例
# 进入香山的根目录
cd Xiangshan
# 下载xiangshan.nix脚本，并重命名为shell.nix
wget https://raw.githubusercontent.com/xieby1/nix_config/main/scripts/shell/xiangshan.nix -O shell.nix
# 进入nix shell
nix-shell
</code></pre>
<h2 id="nix配置的使用方法"><a class="header" href="#nix配置的使用方法">nix配置的使用方法</a></h2>
<p>虚拟机/物理机单系统/物理机双系统 安装NixOS 可以参考我两年前的<a href="./docs/howto/install_nixos.html">NixOS安装</a>过程。
安装Nix/NixOS不在此赘述，参考<a href="https://nixos.org/download.html">nixos.org/download.html</a>。</p>
<p>安装完Nix/NixOS后，首先下载我的配置</p>
<pre><code class="language-bash">git clone https://github.com/xieby1/nix_config.git ~/.config/nixpkgs
# [仅NixOS] 在imports中添加sys/的路径
vim /etc/nixos/configuration.nix
</code></pre>
<p>然后设置软件源，在NixOS中推荐使用<code>sudo</code>。</p>
<ul>
<li>注一：更多其他nix channels参考
<a href="https://nixos.wiki/wiki/Nix_channels">NixOS Wiki: Nix channels</a>
和<a href="https://status.nixos.org/">Nix channel status</a>。</li>
<li>注二：为什么用https://nixos.org/channels/nixos-25.05，
而非https://github.com/NixOS/nixpkgs/archive/release-25.05.tar.gz？
前者包含额外内容，比如programs.command-not-found.dbPath，详细见<code>man configuration.nix</code>。</li>
</ul>
<pre><code class="language-bash"># [对于NixOS]
nix-channel --add https://nixos.org/channels/nixos-25.05 nixos
# [对于Nix]
nix-channel --add https://nixos.org/channels/nixos-25.05 nixpkgs
# 添加home manager源
nix-channel --add https://github.com/nix-community/home-manager/archive/release-25.05.tar.gz home-manager
nix-channel --update
</code></pre>
<p>最后部署配置</p>
<pre><code class="language-bash"># [仅NixOS]
sudo nixos-rebuild switch
# 安装home-manager
nix-shell '&lt;home-manager&gt;' -A install
# 在home-manager配置中添加usr/的路径
vim ~/.config/home-manager/home.nix
## 例如  imports = [ /home/xieby1/.config/nixpkgs/usr ];
# 用nix expression而不使用nix flakes
rm ~/.config/home-manager/flake.nix
home-manager switch
</code></pre>
<h2 id="引用"><a class="header" href="#引用">引用</a></h2>
<div class="footnote-definition" id="impure"><sup class="footnote-definition-label">1</sup>
<p>nix 2.8的impure特性和home-manager等会引入一些你几乎察觉不到的差异。</p>
</div>
<div class="footnote-definition" id="doc_thesis"><sup class="footnote-definition-label">2</sup>
<p>Dolstra, Eelco. “The purely functional software deployment model.” (2006).</p>
</div>
<div class="footnote-definition" id="nix-on-droid"><sup class="footnote-definition-label">3</sup>
<p><a href="https://github.com/t184256/nix-on-droid">github.com/t184256/nix-on-droid</a> termux的分支，支持nix。</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="confignix"><a class="header" href="#confignix">config.nix</a></h1>
<p>当初始化<code>nixpkgs</code>时，例如<code>pkgs = import &lt;nixpkgs&gt; {}</code>，
<code>nixpkgs</code>的初始化代码会读取<code>~/.config/nixpkgs/config.nix</code>作为<code>nixpkgs.config</code>参数。
如果你对<code>nixpkgs</code>的初始化感兴趣，可以去看看这部分的源代码<code>&lt;nixpkgs&gt;/pkgs/top-level/impure.nix</code>。</p>
<p><code>config.nix</code>文件（即<code>nixpkgs.config</code>）接受的参数可以参考nixpkgs的官方文档的
<a href="https://nixos.org/manual/nixpkgs/stable/#sec-config-options-reference">config Options Reference</a>章节，
或是去看nixpkgs这部分的源码<code>&lt;nixpkgs&gt;/pkgs/top-level/config.nix</code>。</p>
<p>下面是添加了注解的我的<code>config.nix</code>：</p>
<pre><code class="language-nix">{
</code></pre>
<p>禁用安装非本地的包，比如禁止x86_64-linux的包被安装到aarch64-linux上。</p>
<pre><code class="language-nix">  allowUnsupportedSystem = false;
  allowUnfree = true;
  packageOverrides = pkgs: rec {
</code></pre>
<p>添加nix user repository (NUR)到nixpkgs里。</p>
<pre><code class="language-nix">    nur = import (builtins.fetchTarball "https://github.com/nix-community/NUR/archive/master.tar.gz") {
      pkgs = pkgsu;
    };
</code></pre>
<p>添加非稳定版的nixpkgs到nixpkgs里，
比如非稳定版的hello可以通过<code>pkgs.pkgsu.hello</code>来访问。</p>
<pre><code class="language-nix">    pkgsu = import (builtins.fetchTarball "https://github.com/NixOS/nixpkgs/archive/master.tar.gz") {};
</code></pre>
<p>添加flake-compat，用于在nix expression中使用flake的包</p>
<pre><code class="language-nix">    flake-compat = import (builtins.fetchTarball {
      url = "https://github.com/edolstra/flake-compat/archive/0f9255e01c2351cc7d116c072cb317785dd33b33.tar.gz";
      sha256 = "0m9grvfsbwmvgwaxvdzv6cmyvjnlww004gfxjvcl806ndqaxzy4j";
    });
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="todo-nixnixconf"><a class="header" href="#todo-nixnixconf">TODO: nix/nix.conf</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="optnix"><a class="header" href="#optnix">opt.nix</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="systemnix"><a class="header" href="#systemnix">system.nix</a></h1>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  system.activationScripts.ssh_config = let
    # nix-daemon's ssh cannot find nc,
    # so I replace nc with absolute path.
    # The absolute path is recommended way in ssh ProxyCommand,
    # see `man ssh_config`
    ssh_config = pkgs.runCommand "ssh_config" {} ''
      sed 's,\&lt;nc\&gt;,${pkgs.libressl.nc}/bin/nc,g' ${/home/xieby1/Gist/Config/ssh.conf} &gt; $out
    '';
  in ''
    ln -sfn ${ssh_config} /root/.ssh/config
    for user_id_pub in /home/xieby1/Gist/Vault/id_*.pub; do
        user_id=''${user_id_pub%.pub}
        root_id_pub=/root/.ssh/''${user_id_pub##*/}
        root_id=''${root_id_pub%.pub}
      if [[ ! -e $root_id_pub ]]; then
        cp $user_id_pub $root_id_pub
        cp $user_id     $root_id
        chmod 600 $root_id
      fi
    done
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="syscli"><a class="header" href="#syscli">sys/cli</a></h1>
<p>本文件是NixOS的CLI配置。
主要包含两部分内容：</p>
<ul>
<li>系统环境管理（root的环境）</li>
<li>系统配置</li>
</ul>
<pre><code class="language-nix">{ config, pkgs, ... }:

{
</code></pre>
<h2 id="系统环境管理root的环境"><a class="header" href="#系统环境管理root的环境">系统环境管理（root的环境）</a></h2>
<pre><code class="language-nix">  imports = [
    ./build-machines.nix
  ];

  # List packages installed in system profile. To search, run:
  # $ nix search wget
  environment.systemPackages = with pkgs; [
    git
    file
    wget
    fzf
    linuxPackages.perf
  ];

  # neovim
  programs.neovim.enable = true;
  programs.neovim.defaultEditor = true;
  programs.neovim.viAlias = true;
  programs.neovim.vimAlias = true;

  # ssh
  services.openssh = {
    enable = true;
    settings = {
      X11Forwarding = true;
      PasswordAuthentication = false;
    };
  };

</code></pre>
<h2 id="系统配置"><a class="header" href="#系统配置">系统配置</a></h2>
<p>启用NTFS文件系统的支持。
如此就可以在NixOS/Windows双系统的电脑上挂在Windows的分区啦。</p>
<pre><code class="language-nix">  boot.supportedFilesystems = [ "ntfs" ];

</code></pre>
<p>启用podman。
podman是一个十分好用的docker实现。
支持用户态容器（不需要sudo），可以方便地挂在容器镜像的文件系统。</p>
<pre><code class="language-nix">  virtualisation.podman.enable = true;

</code></pre>
<p>配置binfmt，让非本地指令集的用户程序可以正常运行。
比如在x86_64-linux上运行aarch64-linux的用户程序。
注意：不能在配和本地一样的binfmt，比如不能在x86_64-linux的机器上配置x86_64-linux的binfmt。
不然会出现奇怪的嵌套？你执行任何一条命令（x86_64-linux）都需要去调用qemu-x86_64，
但qemu-x86_64本事也是x86_64-linux的，所以会死循环？
我做了个实验：在x86_64-linux的NixOS中启用x86_64-linux的binfmt。
任何程序都执行不了了，连关机都不行，只能强制重启。
不过好在NixOS可以回滚，轻松复原实验前的环境。
下面的<code>filterAttrs</code>就是用来保证不配置本地的binfmt。</p>
<pre><code class="language-nix">  boot.binfmt.registrations = pkgs.lib.filterAttrs (n: v: n!=builtins.currentSystem) {
    x86_64-linux = {
      interpreter = "${pkgs.pkgsStatic.qemu-user}/bin/qemu-x86_64";
      magicOrExtension = ''\x7fELF\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\x3e\x00'';
      mask = ''\xff\xff\xff\xff\xff\xfe\xfe\x00\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff'';
      wrapInterpreterInShell = false;
    };
    aarch64-linux = {
      interpreter = "${pkgs.pkgsStatic.qemu-user}/bin/qemu-aarch64";
      magicOrExtension = ''\x7fELF\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\xb7\x00'';
      mask = ''\xff\xff\xff\xff\xff\xff\xff\x00\xff\xff\xff\xff\xff\xff\x00\xff\xfe\xff\xff\xff'';
      wrapInterpreterInShell = false;
    };
    riscv64-linux = {
      interpreter = "${pkgs.pkgsStatic.qemu-user}/bin/qemu-riscv64";
      magicOrExtension = ''\x7fELF\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\xf3\x00'';
      mask = ''\xff\xff\xff\xff\xff\xff\xff\x00\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff'';
      wrapInterpreterInShell = false;
    };
  };

</code></pre>
<p>启用docdev。
在home-manager中装devdoc似乎有问题，得在NixOS中装才行。
之后有空再来详细研究。</p>
<pre><code class="language-nix">  # Make sure devdoc outputs are installed.
  documentation.dev.enable = true;
  # Make sure legacy path is installed as well.
  environment.pathsToLink = [ "/share/gtk-doc" ];

</code></pre>
<p>启用ADB，安卓搞事情必备。</p>
<pre><code class="language-nix">  programs.adb.enable = true;
  users.users.xieby1.extraGroups = ["adbusers"];

  nix.settings.trusted-users = ["root" "xieby1"];

  zramSwap.enable = true;

  boot.kernelPackages = pkgs.linuxPackages_xanmod;

  networking.firewall.enable = false;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sysdefaultnix"><a class="header" href="#sysdefaultnix">sys/default.nix</a></h1>
<p>本文件存放喆我的NixOS的配置。
NixOS的配置通过命令<code>sudo nixos-rebuild switch</code>生效。
因为NixOS的配置入口是<code>/etc/nixos/configuration.nix</code>，
所以需要在<code>/etc/nixos/configuration.nix</code>中import本文件，例如</p>
<pre><code class="language-nix"># /etc/nixos/configuration.nix:
{ config, pkgs, ... }: {
  imports = [
    ./hardware-configuration.nix
    # import my sys/ here!
    /home/xieby1/.config/nixpkgs/sys
  ];
  # other configs ...
}
</code></pre>
<p>NixOS配置可以使用的参数可参考configuration.nix的manpage，即<code>man configuration.nix</code>。
下面是我的NixOS的配置源码及注解：</p>
<pre><code class="language-nix"># add this file to /etc/nixos/configuration.nix: imports
{ config, pkgs, ... }:

{
</code></pre>
<p>让NixOS的nixpkgs使用和home-manager的nixpkgs采用相同的nixpkgs config</p>
<pre><code class="language-nix">  nixpkgs.config = import ../config.nix;

</code></pre>
<p>导入我的NixOS的CLI和GUI配置，
详细内容见文档<a href="sys/./cli/default.nix.html">./cli</a>和<a href="sys/./gui/default.nix.html">./gui</a>。</p>
<pre><code class="language-nix">  imports = [
    ./modules/cachix.nix
    ./cli
    ./gui
  ];

</code></pre>
<p>Nix binary cache的地址。
越靠前优先级越高。
由于cache.nixos.org需要梯子，
这里使用了清华Tuna提供的Nix binary cache镜像来加速。</p>
<pre><code class="language-nix">  nix.settings.substituters = [
    "https://cache.nixos.org/"
    "https://xieby1.cachix.org"
  ];

</code></pre>
<p>设置时区。</p>
<pre><code class="language-nix">  time.timeZone = "Asia/Shanghai";
  time.hardwareClockInLocalTime = true;

</code></pre>
<p>设置Linux账户信息。</p>
<pre><code class="language-nix">  users.mutableUsers = false;
</code></pre>
<p>当然GitHub上当然不能明文存储密码，这里使用hash过的密码。
可以使用命令行工具<code>mkpasswd</code>来生成hash过的密码。
给<code>root</code>用户设置hash过的密码。</p>
<pre><code class="language-nix">  users.users.root.hashedPassword = "$6$wRBpbr4zSTA/nh$XI/KUASw3mELIqyAxN1hUTWizz9ZBzPhP2u4HNDCA49h4KOWkZsyuiextyXkUti7jYsUHE9fTiRjGAoxBg0Gq/";
  users.users.xieby1 = {
    isNormalUser = true;
    createHome = true;
</code></pre>
<p>同上，给<code>xieby1</code>用户设置hash过的密码。</p>
<pre><code class="language-nix">    hashedPassword = "$6$Y4KJxhdaJTT$RSolbCpaUKK2UW1cdnuH.8n1Ky9p0Lnx0MP36BxGX9Q2AeVMjCp.bZOsZ11w689je/785TFRQoVgicMiOfA9B.";
</code></pre>
<p>给用户<code>xieby1</code>启用sudo。</p>
<pre><code class="language-nix">    extraGroups = [ "wheel" ];
</code></pre>
<p>ssh授权的公钥。这样设置后，我的所有的NixOS都相当于“自动授权”了。
我的<code>/home/xieby1/Gist/</code>文件夹存放着一些不方便放入Git仓库的文件，比如二进制文件，或是隐私文件。
该文件由<a href="https://github.com/syncthing/syncthing">syncthing</a>进行多设备同步。
简单的说，我的备份理念是“git备份配置，syncthing备份数据”。
“配置”即指这个<a href="https://github.com/xieby1/nix_config">nix_config仓库</a>，“数据”指<code>~/Gist/</code>、<code>~/Documents/</code>等文件夹。
有了这些备份就能轻松还原/复现我的整个工作环境。
TODO：单独专门介绍我的备份理念。</p>
<pre><code class="language-nix">    openssh.authorizedKeys.keyFiles = [] ++ (
      if builtins.pathExists /home/xieby1/Gist/Vault/y50_70.pub
      then [/home/xieby1/Gist/Vault/y50_70.pub]
      else []
    ) ++ (
      if builtins.pathExists /home/xieby1/Gist/Vault/yoga14s.pub
      then [/home/xieby1/Gist/Vault/yoga14s.pub]
      else []
    );
  };

</code></pre>
<p>让TTY自动登录我的账户，这样就可以自动启动用户级（user）的systemd服务了。
这样就可以在<span style="color:teal"><strong>非NixOS</strong></span>中（比如Ubuntu服务器、WSL2、Debian树莓派等）
自动拉起systemd<span style="color:teal"><strong>用户</strong></span>服务（比如syncthing、clash、tailscale等）。</p>
<pre><code class="language-nix">  services.getty.autologinUser = "xieby1";
</code></pre>
<p>有关systemd用户服务的配置，详细可见参考：</p>
<ul>
<li>home-manager配置的manpage的services词条，
比如<code>man home-configuration.nix</code>搜索<code>services.syncthing</code></li>
<li>我的syncthing配置<a href="sys/./usr/cli/default.nix.html#syncthing">./usr/cli: syncthing</a></li>
<li>我的clash配置<a href="sys/./usr/cli/clash.nix.html">./usr/cli/clash.nix</a></li>
<li>我的tailscale配置<a href="sys/./usr/cli/tailscale.nix.html">./usr/cli/tailscale.nix</a></li>
</ul>
<pre><code class="language-nix">}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, ... }:

{
  imports = [ # files

  ] ++ [{ # functions &amp; attrs
    # support fractional scaling for x11 gnome:
    # refer to https://nixos.wiki/wiki/Overlays#Overriding_a_package_inside_a_scope
    nixpkgs.overlays = [ (final: prev: {
      mutter = let
        mutter-x11-scaling = pkgs.fetchFromGitHub {
          owner = "puxplaying";
          repo = "mutter-x11-scaling";
          rev = "d19eeb27f6efb1f489ef49e0c987a9e02a072b31";
          hash = "sha256-NOMd7wyQNj+tp2WZ9l2tKITYUvL7toZ8OvVQssR14Ng=";
        };
      in prev.mutter.overrideAttrs (old: {
        patches = (pkgs.lib.optionals (old ? patches) old.patches) ++ [
          "${mutter-x11-scaling}/x11-Add-support-for-fractional-scaling-using-Randr.patch"
        ];
      });
      gnome-control-center = let
        gnome-control-center-x11-scaling = pkgs.fetchFromGitHub {
          owner = "puxplaying";
          repo = "gnome-control-center-x11-scaling";
          rev = "ec599022bbd39455043eeb5dd03ea6f1d33bbe23";
          hash = "sha256-Y5D1p+koFBfgkbgreIV8FE+TqJrA8TJIrRQ8cQkzdB8=";
        };
      in prev.gnome-control-center.overrideAttrs (old: {
        patches = (pkgs.lib.optionals (old ? patches) old.patches) ++ [
          "${gnome-control-center-x11-scaling}/display-Support-UI-scaled-logical-monitor-mode.patch"
          "${gnome-control-center-x11-scaling}/display-Allow-fractional-scaling-to-be-enabled.patch"
        ];
      });
    }) ];

    # push the overrided mutter and gnome to my cachix
    cachix_packages = with pkgs; [mutter gnome-control-center];
  }] ;

  # Enable the X11 windowing system.
  services.xserver.enable = true;
  services.xserver.videoDrivers = [
    # "nvidia"
    # default video drivers
    "radeon" "nouveau" "modesetting" "fbdev"
    "modesetting" "amdgpu"
  ];

  # Enable the GNOME Desktop Environment.
  services.xserver.displayManager.gdm.enable = true;
  services.xserver.displayManager.gdm.wayland = false;
  services.xserver.desktopManager.gnome.enable = true;

  # https://discourse.nixos.org/t/how-to-create-folder-in-var-lib-with-nix/15647
  system.activationScripts.user_account_conf = pkgs.lib.stringAfter [ "var" ] (let
    face = pkgs.fetchurl {
      url = "https://github.com/xieby1.png";
      sha256 = "1s20qy3205ljp29lk0wqs6aw5z67db3c0lvnp0p7v1q2bz97s9bm";
    };
  in ''
    mkdir -p /var/lib/AccountsService/users
    if [[ ! -f /var/lib/AccountsService/users/xieby1 ]]; then
    cat &gt; /var/lib/AccountsService/users/xieby1 &lt;&lt;XIEBY1_ACCOUNT
    [User]
    Session=
    Icon=/var/lib/AccountsService/icons/xieby1
    SystemAccount=false
    XIEBY1_ACCOUNT
    fi
    mkdir -p /var/lib/AccountsService/icons
    ln -sf ${face} /var/lib/AccountsService/icons/xieby1
  '');

  # Configure keymap in X11
  # services.xserver.layout = "us";
  # services.xserver.xkbOptions = "eurosign:e";

  # Enable CUPS to print documents.
  # https://nixos.wiki/wiki/Printing
  services.printing.enable = true;
  services.printing.drivers = [pkgs.hplip];
  services.avahi.enable = true;
  services.avahi.nssmdns4 = true;

  # Enable touchpad support (enabled default in most desktopManager).
  services.libinput.enable = true;

  nixpkgs.config.allowUnfree = true;

  # vim vista need nerd fonts
  # https://github.com/liuchengxu/vista.vim/issues/74
  # https://github.com/liuchengxu/space-vim/wiki/tips#programming-fonts
  # available nerd fonts: nixpkgs/pkgs/data/fonts/nerdfonts/shas.nix
  ## use non-variable noto font for feishu and other old electron apps
  ## for more details see: https://github.com/NixOS/nixpkgs/issues/171976
  fonts.packages = with pkgs; [
    noto-fonts-cjk-sans
    noto-fonts-cjk-serif
    noto-fonts-emoji
    noto-fonts-color-emoji
    noto-fonts-extra
    # The best developer fonts, see https://www.nerdfonts.com/
    nerd-fonts.hack
    nerd-fonts.meslo-lg
    nerd-fonts.sauce-code-pro
    nerd-fonts.fira-code
    nerd-fonts.terminess-ttf
    nerd-fonts.iosevka
    nerd-fonts.monoid
    nerd-fonts.fantasque-sans-mono
  ];
  # enable fontDir /run/current-system/sw/share/X11/fonts
  fonts.fontDir.enable = true;
  fonts.fontconfig.defaultFonts = {
    monospace = [
      "DejaVu Sans Mono"
      "Noto Color Emoji"
      "Noto Emoji"
    ];
  };

  services.gpm.enable = true;

  hardware.xone.enable = true;

  # for x11 gesture
  services.touchegg.enable = true;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, lib, ...}:

{
  imports = [../../modules/cachix.nix];
  config = lib.mkIf (
    (builtins.pathExists config.cachix_dhall) &amp;&amp;
    (config.cachix_packages != [])
  ) {
    system.activationScripts = {
      cachix_push = config._cachix_push;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="currently-not-wayland-but-x11"><a class="header" href="#currently-not-wayland-but-x11">Currently, Not Wayland, But X11</a></h1>
<p>Here list wayland problems I have met.</p>
<h2 id="warpd-not-work"><a class="header" href="#warpd-not-work">warpd not work</a></h2>
<h2 id="fcitx-input-method-not-work"><a class="header" href="#fcitx-input-method-not-work">fcitx input method not work</a></h2>
<h2 id="waydroid"><a class="header" href="#waydroid">waydroid</a></h2>
<p>waydroid tile not work</p>
<h2 id="tabbed-not-work"><a class="header" href="#tabbed-not-work">tabbed not work</a></h2>
<h2 id="gnome-terminal-headerbar-cannot-be-hidden"><a class="header" href="#gnome-terminal-headerbar-cannot-be-hidden">gnome terminal headerbar cannot be hidden</a></h2>
<p>Both gnome extension unite and gtk-title-bar
cannot hide gnome terminal(kitty and alacritty)'s headerbar.</p>
<ul>
<li>https://github.com/velitasali/gtktitlebar/issues/25</li>
<li>https://github.com/velitasali/gtktitlebar/issues/14</li>
</ul>
<h2 id="autokey-and-espanso-not-work-in-wayland"><a class="header" href="#autokey-and-espanso-not-work-in-wayland">autokey and espanso not work in wayland</a></h2>
<p>Autokey only works in X11,
while espanso officially disclaim it support wayland.
But my wayland experience is, espanso does not work either.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="homenix"><a class="header" href="#homenix">home.nix</a></h1>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  clashctl = pkgs.callPackage ./clashctl.nix {};
in {
  imports = [{
    home.packages = [
      pkgs.clash-meta
    ] ++ lib.optional (!config.isNixOnDroid) clashctl;
    cachix_packages = lib.optional (!config.isNixOnDroid) clashctl;

    systemd.user.services.clash = {
      Unit = {
        Description = "Auto start clash";
        After = ["network.target"];
      };
      Install = {
        WantedBy = ["default.target"];
      };
      Service = {
        ExecStart = "${pkgs.clash-meta.outPath}/bin/clash-meta -d ${config.home.homeDirectory}/Gist/clash";
      };
    };
    programs.bash.bashrcExtra = lib.mkBefore (lib.optionalString (!config.isNixOnDroid) ''
      # proxy
      ## default
      HTTP_PROXY="http://127.0.0.1:${toString config.proxyPort}"
      ## microsoft wsl
      # if [[ $(uname -r) == *"microsoft"* ]]; then
      #     hostip=$(cat /etc/resolv.conf | grep nameserver | awk '{ print $2 }')
      #     export HTTP_PROXY="http://$hostip:${toString config.proxyPort}"
      # fi
      export HTTPS_PROXY="$HTTP_PROXY"
      export HTTP_PROXY="$HTTP_PROXY"
      export FTP_PROXY="$HTTP_PROXY"
      export http_proxy="$HTTP_PROXY"
      export https_proxy="$HTTP_PROXY"
      export ftp_proxy="$HTTP_PROXY"
    '');
  }];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ lib
, rustPlatform
, fetchFromGitHub
}:
rustPlatform.buildRustPackage {
  name = "clashctl";

  src = fetchFromGitHub {
    # owner = "https://github.com/George-Miao/clashctl";
    owner = "George-Miao";
    repo = "clashctl";
    rev = "b09e1faf80f1a25fa855499d8b34d36491e5a081";
    hash = "sha256-c7y64SsZEKdC8+umCY8+XBwxAHxn4YpqR48ASbHpkdM=";
  };

  cargoHash = "sha256-Dt8AikjIaNTZ03vT/zV6ZTQ5QNoOjVxYYIc1AB/3De8=";

  doCheck = false;

  meta = with lib; {
    description = "CLI for interacting with clash";
    homepage = "https://github.com/George-Miao/clashctl";
    license = licenses.mit;
    maintainers = with maintainers; [ xieby1 ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = with pkgs; [
    universal-ctags
  ];
  home.file.exclude_ctags = {
    text = ''
      # exclude ccls generated directories
      --exclude=.ccls*
    '';
    target = ".config/ctags/exclude.ctags";
  };
  home.file.scala_ctags = {
    target = ".config/ctags/scala.ctags";
    text = ''
      --langdef=Scala
      --langmap=Scala:.scala
      --regex-Scala=/^[ \t]*class[ \t]*([a-zA-Z0-9_]+)/\1/c,classes/
      --regex-Scala=/^[ \t]*object[ \t]*([a-zA-Z0-9_]+)/\1/o,objects/
      --regex-Scala=/^[ \t]*trait[ \t]*([a-zA-Z0-9_]+)/\1/t,traits/
      --regex-Scala=/^[ \t]*case[ \t]*class[ \t]*([a-zA-Z0-9_]+)/\1/r,cclasses/
      --regex-Scala=/^[ \t]*abstract[ \t]*class[ \t]*([a-zA-Z0-9_]+)/\1/a,aclasses/
      --regex-Scala=/^[ \t]*def[ \t]*([a-zA-Z0-9_=]+)[ \t]*.*[:=]/\1/m,methods/
      --regex-Scala=/[ \t]*val[ \t]*([a-zA-Z0-9_]+)[ \t]*[:=]/\1/V,values/
      --regex-Scala=/[ \t]*var[ \t]*([a-zA-Z0-9_]+)[ \t]*[:=]/\1/v,variables/
      --regex-Scala=/^[ \t]*type[ \t]*([a-zA-Z0-9_]+)[ \t]*[\[&lt;&gt;=]/\1/T,types/
      --regex-Scala=/^[ \t]*import[ \t]*([a-zA-Z0-9_{}., \t=&gt;]+$)/\1/i,includes/
      --regex-Scala=/^[ \t]*package[ \t]*([a-zA-Z0-9_.]+$)/\1/p,packages/
    '';
  };
  programs.neovim = {
    extraConfig = ''
      "" tags support, ';' means upward search, referring to http://vimdoc.sourceforge.net/htmldoc/editing.html#file-searching
      set tags=./tags;
    '';
    plugins = [{
</code></pre>
<h2 id="a-bug-in-neovim-or-lspconfig"><a class="header" href="#a-bug-in-neovim-or-lspconfig">A bug in neovim or lspconfig?</a></h2>
<p>I want to jump to the definition of QEMU's <code>qemu_clock_get_ns</code> using ctags.
More specifically, when I press <code>g]</code> with my cursor under a <code>qemu_clock_get_ns</code> call,
neovim only lists one definition:</p>
<pre><code class="language-vim">  # pri kind tag                file
  1 F   Functionqemu_clock_get_ns /home/xieby1/Codes/qemu/tests/unit/ptimer-test-stubs.c
               \%86l\%9c
Type number and &lt;Enter&gt; (q or empty cancels):
</code></pre>
<p>However, there should be two definitions!
After tweaking a lot, I found out that clangd's lspconfig config directly or indirectly causes this.</p>
<pre><code class="language-lua">vim.lsp.config("clangd", {
  filetypes = { "c", "cc", "cpp", "c++", "objc", "objcpp", "cuda", "proto" }
})
vim.lsp.enable("clangd")
</code></pre>
<p>As long as the filetype of the current buffer is not clangd-related, ctags works correctly.
For example, if I <code>cd &lt;qemu-source-code&gt;</code>, then run <code>vim</code>, and finally <code>:ts qemu_clock_get_ns</code>,
I get the expected result:</p>
<pre><code class="language-vim">  # pri kind tag                file
  1 F   f    qemu_clock_get_ns  tests/unit/ptimer-test-stubs.c
               typeref:typename:int64_t
               int64_t qemu_clock_get_ns(QEMUClockType type)
  2 F   f    qemu_clock_get_ns  util/qemu-timer.c
               typeref:typename:int64_t
               int64_t qemu_clock_get_ns(QEMUClockType type)
Type number and &lt;Enter&gt; (q or empty cancels):
</code></pre>
<p>I searched through neovim's and nvim-lspconfig's github issues but didn't find any related issues.
I also tried searching for the weird string <code>\%.*l\%.*c</code> (%86l%9c) in neovim and lspconfig source code,
but found nothing.</p>
<p>As a result, I've decided to use a wrapper plugin for tags functionality.</p>
<p>nvim-telescope has builtin support tags <code>:lua require'telescope.builtin'.tags{}</code>.
However it is VERY SLOW!
So, I choose to install a plugin: nvim-telescope-ctags-plus.</p>
<pre><code class="language-nix">      plugin = pkgs.vimUtils.buildVimPlugin {
        name = "nvim-telescope-ctags-plus";
        src = pkgs.fetchFromGitHub {
          owner = "gnfisher";
          repo = "nvim-telescope-ctags-plus";
          rev = "455f24c0dcc6126c89cd3a3278e3fe322df061b1";
          hash = "sha256-P9uYkWvY4NzwlAxG40/0sNZoGEHezDhlYL/gKfBI/dA=";
        };
        doCheck = false;
      };
      type = "lua";
      config =''
        require('telescope').load_extension('ctags_plus')

        -- in vimscript:
        -- nnoremap g] &lt;cmd&gt;lua require('telescope').extensions.ctags_plus.jump_to_tag()&lt;cr&gt;
        vim.keymap.set('n', 'g]', function()
          require('telescope').extensions.ctags_plus.jump_to_tag()
        end, { noremap = true, silent = true })
      '';
    }];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  sysconfig = (
    # &lt;...&gt; are expression search in NIX_PATH
    if (builtins.tryEval &lt;nixos-config&gt;).success
    then import &lt;nixpkgs/nixos&gt; {}
    else import &lt;nixpkgs/nixos&gt; {configuration={};}
  ).config;
in
{
  imports = [
    ./extra.nix
    ./vim
    ./tmux.nix
    ./clash.nix
    ./tailscale.nix
    ./gdb.nix
    ./ctags.nix
    ./ssh.nix
    ./git.nix
    ./fzf.nix
    ./mcfly.nix
  ] ++ [{ # functions &amp; attrs
    home.packages = [pkgs.nix-index];
    home.file.nix_index_database = {
      source = builtins.fetchurl "https://github.com/Mic92/nix-index-database/releases/latest/download/index-${builtins.currentSystem}";
      target = ".cache/nix-index/files";
    };
  }{
</code></pre>
<h2 id="syncthing"><a class="header" href="#syncthing">Syncthing</a></h2>
<pre><code class="language-nix">    services.syncthing = {
      enable = true;
</code></pre>
<p>让syncthing的端口外部可访问。</p>
<pre><code class="language-nix">      extraOptions = lib.optional config.isCli "--gui-address=0.0.0.0:8384";
    };
</code></pre>
<p>启用代理，因为有些syncthing的服务器似乎是被墙了的。</p>
<pre><code class="language-nix">    systemd.user.services.syncthing.Service.Environment = [
      # https://docs.syncthing.net/users/proxying.html
      "http_proxy=http://127.0.0.1:${toString config.proxyPort}"
    ];
</code></pre>
<p>使用命令行浏览器browsh来实现syncthing-tui。</p>
<pre><code class="language-nix">    home.packages = lib.optional (!config.isMinimalConfig) (
      pkgs.writeShellScriptBin "syncthing-tui" ''
        ${pkgs.browsh}/bin/browsh --firefox.path ${pkgs.firefox}/bin/firefox http://127.0.0.1:8384
      ''
    );
  }{
    home.packages = with pkgs; [
      cachix
    ];
    home.file.cachix_dhall = {
      source = if (builtins.pathExists ~/Gist/Config/cachix.dhall)
        then ~/Gist/Config/cachix.dhall
        else builtins.toFile "empty-cachix.dhall" "";
      target = ".config/cachix/cachix.dhall";
    };
  }{
    home.packages = [
      pkgs.pkgsu.claude-code
    ];
    systemd.user.tmpfiles.rules = [
      "L? %h/.claude/settings.json - - - - %h/Gist/Config/claude.settings.json"
    ];
  }];

  home.packages = with pkgs; [
    # tools
    parallel
    comma
    xclip
    python3Packages.qrcode
    ## archive
    unar
    ## manage
    htop
    nix-tree
    ## text
    pandoc
    ## compile
    gnumake
    makefile2graph
    remake
    ## draw
    graphviz
    figlet
    nyancat
    d2
    ## manual
    tldr
    ## file system
    file
    # magika # detect file content types with deep learning
    tree
    ## network
    wget
    axel
    bind.dnsutils # nslookup
    netcat
    nload
    nmap
    nethogs
    nodePackages.browser-sync
    ## x11
    xdotool

    # programming
    inotify-tools
    clang-tools
    cmake
    capstone
    scc
    ## https://stackoverflow.com/questions/40165650/how-to-list-all-files-tracked-by-git-excluding-submodules
    (writeShellScriptBin "scc-git" "${scc}/bin/scc $(git grep --cached -l '')")
    sloccount
    flamegraph
    ## python
    ( python3.withPackages ( p: with p; [
      ipython
      pydot
      networkx
    ]))
    ## c
    (lib.setPrio # make bintools less prior
      (bintools-unwrapped.meta.priority + 1)
      bintools-unwrapped
    )
    (if builtins.currentSystem == "x86_64-linux"
      then gcc_multi
      else gcc
    )
    ### docs
    stdmanpages
    man-pages
    #gccStdenv
    bear
    ## xml
    libxml2
    ## bash
    bc
    ## nix
    nixos-option
    nix-output-monitor
    ### allow non-nixos access `man configuration.nix`
    # see: nixos/modules/misc/documentation.nix
    #        nixos/doc/manual/default.nix
    sysconfig.system.build.manual.nixos-configuration-reference-manpage
    nurl
  ];

  programs.eza.enable = true;

  # bash
  programs.bash.enable = true;
  programs.bash.bashrcExtra = ''
    # rewrite prompt format
    u_green="\[\033[01;32m\]"
    u_blue="\[\033[01;34m\]"
    u_white="\[\033[00m\]"
    PS1="''${debian_chroot:+($debian_chroot)}"
    if [[ $HOSTNAME =~ qemu.* ]]; then
        PS1+="(qemu)"
    fi
    if [[ -n "$IN_NIX_SHELL" ]]; then
        PS1+="(''${name}.$IN_NIX_SHELL)"
    fi
    PS1+="''${u_green}\u${lib.optionalString (!config.isNixOnDroid) "@\\h"}''${u_white}:"
    PS1+="''${u_blue}\w''${u_white}"
    PS1+="\n''${u_green}\$''${u_white} "
    unset u_green u_blue u_white
    ## change title
    ### https://unix.stackexchange.com/questions/177572/
    PS1+="\[\e]2;\w\a\]"

    # nixos obsidian
    export NIXPKGS_ALLOW_INSECURE=1

    # source my bashrc
    if [[ -f ~/Gist/Config/bashrc ]]; then
        source ~/Gist/Config/bashrc
    fi

    # user nix config setting
    export NIX_USER_CONF_FILES=~/.config/nixpkgs/nix/nix.conf
    if [[ -e ~/.nix-profile/etc/profile.d/nix.sh ]]; then
        source ~/.nix-profile/etc/profile.d/nix.sh
    fi

    # bash-completion, inspired by
    ##  https://discourse.nixos.org/t/whats-the-nix-way-of-bash-completion-for-packages/20209/16
    # system tools completion, e.g. nix
    XDG_DATA_DIRS+=":${sysconfig.system.path}/share"
    # home tools completion
    XDG_DATA_DIRS+=":${config.home.path}/share"
    export XDG_DATA_DIRS
    . ${pkgs.bash-completion}/etc/profile.d/bash_completion.sh

    # 解决tmux在nix-on-droid上不显示emoji和中文的问题
    export LANG=C.UTF-8

    if [[ -n $(command -v eza) ]]; then
        alias ls=eza
    fi
  '' + lib.optionalString config.isWSL2 ''
    # use the working directory of the current tab as the starting directory for a new tab
    # https://learn.microsoft.com/en-us/windows/terminal/tutorials/new-tab-same-directory#using-actions-to-duplicate-the-path
    PROMPT_COMMAND=''${PROMPT_COMMAND:+"$PROMPT_COMMAND"}'printf "\e]9;9;%s\e\\" "$(wslpath -w "$PWD")"'
  '';

  programs.direnv.enable = true;
  programs.direnv.nix-direnv.enable = true;

  programs.ripgrep = {
    enable = true;
    arguments = [
      "--no-ignore-vcs"
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># When init searxng, it throws `ERROR:searx.engines.wikidata: Fail to initialize`
# I have no idea, so deprecated it.
{ config, pkgs, stdenv, lib, ... }:
let
  searxng_yml = builtins.toFile "searxng.yml" ''
    # https://docs.searxng.org/admin/settings/settings.html#settings-yml-location
    # The initial settings.yml we be load from these locations:
    # * the full path specified in the SEARXNG_SETTINGS_PATH environment variable.
    # * /etc/searxng/settings.yml

    # Default settings see &lt;pkgs.searxng&gt;/lib/python3.11/site-packages/searx/settings.yml
    use_default_settings: true

    search:
      autocomplete: "google"
      default_lang: "en"

    server:
      # Is overwritten by $SEARXNG_SECRET
      secret_key: ${if builtins.pathExists ~/Gist/Config/passwordFile
                    then builtins.readFile ~/Gist/Config/passwordFile
                    else "miao"}

    outgoing:
      proxies:
        all://:
          - http://127.0.0.1:${toString config.proxyPort}

    engines:
      - name: bilibili
        engine: bilibili
        shortcut: bil
        disabled: false

      - name: bing
        engine: bing
        shortcut: bi
        disabled: false

      - name: qwant
        disabled: true
    ui:
      results_on_new_tab: true
  '';
in {
  systemd.user.services.searxng = {
    Unit = {
      Description = "Auto start searxng";
      After = ["network.target"];
    };
    Install = {
      WantedBy = ["default.target"];
    };
    Service = {
      Environment = [
        "SEARXNG_SETTINGS_PATH=${searxng_yml}"
      ];
      ExecStart = "${pkgs.searxng}/bin/searx-run";
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cli-extranix-extra-cli-configs-added-to-minimal-cli-config"><a class="header" href="#cli-extranix-extra-cli-configs-added-to-minimal-cli-config">cli-extra.nix: Extra CLI configs (added to minimal cli config)</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }: {
  imports = [{
    home.packages = [
      pkgs.act
      (pkgs.writeShellScriptBin "act-podman" ''
        export DOCKER_HOST=unix://$XDG_RUNTIME_DIR/podman/podman.sock
        CMD=(
          "${pkgs.act}/bin/act"
          "--bind"

          # use podman
          "--container-daemon-socket" "unix://$XDG_RUNTIME_DIR/podman/podman.sock"

          # use host proxy
          "--container-options" "--network=host"
          "--env" "HTTPS_PROXY='http://127.0.0.1:${toString config.proxyPort}'"
          "--env" "HTTP_PROXY='http://127.0.0.1:${toString config.proxyPort}'"
          "--env" "FTP_PROXY='http://127.0.0.1:${toString config.proxyPort}'"
          "--env" "https_proxy='http://127.0.0.1:${toString config.proxyPort}'"
          "--env" "http_proxy='http://127.0.0.1:${toString config.proxyPort}'"
          "--env" "ftp_proxy='http://127.0.0.1:${toString config.proxyPort}'"

          "$@"
        )
        eval "''${CMD[@]}"
      '')
    ];
  }];

config = lib.mkIf (!config.isMinimalConfig) {
  home.packages = with pkgs; [
    # tools
    imagemagick

    # programming
    ## c
    cling # c/cpp repl
    ## javascript
    nodePackages.typescript
    ### node
    nodejs
    ## java
    openjdk

    ### pdfcrop
    (texlive.combine {inherit (pkgs.texlive) scheme-minimal pdfcrop;})
    # runXonY
    qemu
  ] ++ lib.optional (builtins.currentSystem == "x86_64-linux") quickemu;
};
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: let
  fzf-doc = pkgs.writeScriptBin "fzf-doc" /*bash*/ ''
    allCmds() {
      # bash alias
      compgen -A alias

      # external commands
      # https://unix.stackexchange.com/questions/94775/list-all-commands-that-a-shell-knows
      case "$PATH" in
        (*[!:]:) PATH="$PATH:" ;;
      esac
      set -f
      IFS_OLD="$IFS"
      IFS=:
      for dir in $PATH; do
        set +f
        [ -z "$dir" ] &amp;&amp; dir="."
        for file in "$dir"/*; do
          if [ -x "$file" ] &amp;&amp; ! [ -d "$file" ]; then
            echo "''${file##*/}"
          fi
        done
      done
      IFS="$IFS_OLD"
    }

    cd ~/Documents
    FILE=$(fzf)
    [ -z "$FILE" ] &amp;&amp; exit

    # move o to the first line
    { echo o ; allCmds | grep -vw o; } | fzf \
      --bind     "enter:execute(      bash -ic '{} \"$FILE\"'               )+accept" \
      --bind "alt-enter:execute(nohup bash -ic '{} \"$FILE\"' &amp;&gt; /dev/null &amp;)+accept"
  '';
in {
  home.packages = [
    pkgs.fzf
    fzf-doc
  ];
  programs.bash.bashrcExtra = ''
    # FZF top-down display
    export FZF_DEFAULT_OPTS="--reverse"
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gdb-configurations"><a class="header" href="#gdb-configurations">GDB configurations</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.gdb
  ];
  home.file.gdbinit = {
    source = pkgs.fetchFromGitHub {
      owner = "cyrus-and";
      repo = "gdb-dashboard";
      rev = "616ed5100d3588bb70e3b86737ac0609ce0635cc";
      hash = "sha256-xoBkAFwkbaAsvgPwGwe1JxE1C8gPR6GP1iXeNKK5Z70=";
    } + /.gdbinit;
    target = ".gdbinit";
  };
  home.file.gdb_dashboard_init = {
    text = ''
      # gdb-dashboard init file

      # available layout modules
      #   stack registers history assembly
      #   breakpoints expressions memory
      #   source threads variables
      dashboard -layout source

      # https://en.wikipedia.org/wiki/ANSI_escape_code
      #dashboard -style prompt
      ## fg bold blue
      dashboard -style prompt_not_running "\\[\\e[1;34m\\]$\\[\\e[0m\\]"
      ## fg bold green
      dashboard -style prompt_running "\\[\\e[1;32m\\]$\\[\\e[0m\\]"
    '';
    target = ".gdbinit.d/init";
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: let
  git-wip = builtins.derivation {
    name = "git-wip";
    system = builtins.currentSystem;
    src = pkgs.fetchurl {
      url = "https://raw.githubusercontent.com/bartman/git-wip/1c095e93539261370ae811ebf47b8d3fe9166869/git-wip";
      sha256 = "00gq5bwwhjy68ig26a62307pww2i81y3zcx9yqr8fa36fsqaw37h";
    };
    builder = pkgs.writeShellScript "git-wip-builder" ''
      source ${pkgs.stdenv}/setup
      mkdir -p $out/bin
      dst=$out/bin/git-wip
      cp $src $dst
      chmod +w $dst
      sed -i 's/#!\/bin\/bash/#!\/usr\/bin\/env bash/g' $dst
      chmod -w $dst
      chmod a+x $dst
    '';
  };
in {
  home.packages = with pkgs; [
    mr
    git-wip
    git-quick-stats
  ];
  programs.git = {
    enable = true;
    package = pkgs.gitFull;
    userEmail = "xieby1@outlook.com";
    userName = "xieby1";
    extraConfig = {
      core = {
        editor = "vim";
      };
      credential.helper = "store";
      init.defaultBranch = "main";
    };
    aliases = {
      viz = "log --all --decorate --oneline --graph";
    };
    lfs.enable = true;
  };
  systemd.user.tmpfiles.rules = [
    "L? %h/.mrconfig - - - - %h/Gist/Config/mrconfig"
  ];
  # mr status not work in non-home dir
  programs.bash.shellAliases.mr = "mr -d ~";
  programs.lazygit = {
    enable = true;
    settings = {
      gui = {
        screenMode = "half";
        mainPanelSplitMode = "horizontal";
        commitAuthorLongLength = builtins.stringLength "xieby1";

        # https://pkg.go.dev/time#Time.Format
        # Year: "2006" "06"
        # Month: "Jan" "January" "01" "1"
        # Day of the week: "Mon" "Monday"
        # Day of the month: "2" "_2" "02"
        # Day of the year: "__2" "002"
        # Hour: "15" "3" "03" (PM or AM)
        # Minute: "4" "04"
        # Second: "5" "05"
        # AM/PM mark: "PM"
        timeFormat = "2006.01.02";
        shortTimeFormat = "15:04";
      };
      keybinding = {
        universal = {
          rangeSelectDown = "";
          rangeSelectUp = "";
          scrollUpMain-alt1 = "&lt;s-up&gt;";
          scrollDownMain-alt1 = "&lt;s-down&gt;";
        };
      };
      promptToReturnFromSubprocess = false;
      git = {
        autoFetch = false;
      };
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ buildPythonPackage
, lib
, nss
, nspr
, expat
, fetchPypi
}:
let
  rpath = lib.makeLibraryPath [
    nss
    nspr
    expat
  ];
in buildPythonPackage rec {
  pname = "kaleido";
  version = "0.2.1";
  format = "wheel";
  src = fetchPypi {
    inherit pname version format;
    platform = "manylinux1_x86_64";
    hash = "sha256-qiHPG/HHj4+lCp99ReEAPDh709b+CnZ8+780S5W9w6g=";
  };
  doCheck = false;
  postFixup = ''
    for file in $(find $out -type f \( -perm /0111 -o -name \*.so\* \) ); do
      patchelf --set-interpreter "$(cat $NIX_CC/nix-support/dynamic-linker)" "$file" || true
      patchelf --set-rpath ${rpath}:$out/lib/x86_64-linux-gnu $file || true
    done
    sed -i 's,#!/bin/bash,#!/usr/bin/env bash,' $out/lib/python3.11/site-packages/kaleido/executable/kaleido
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="binutilss-ld-and-gccs-ld-collsion"><a class="header" href="#binutilss-ld-and-gccs-ld-collsion">binutils's ld and gcc's ld collsion</a></h1>
<p>Background: I want to install <code>gcc</code> and <code>objdump</code>, where <code>objdump</code> is contained in <code>binutils</code>.
Home-manager tolds me <code>gcc</code>'s <code>ld</code> collides with <code>binutils</code>'s <code>ld</code>.
As I explore into <code>gcc</code> and <code>binutils</code>, weird thing comes.</p>
<p>Packages <code>binutils</code> and <code>gcc</code> both contain ld executable.
<code>binutils</code> and <code>gcc</code> has the same priority 10.</p>
<p>The WEIRD thing is,</p>
<ul>
<li><code>binutils</code> wants to have a lower priority than gcc-wrapper,
so sets its priority to 10,
see nixpkgs: <code>pkgs/development/tools/misc/binutils/default.nix</code>
<blockquote>
<p>Give binutils a lower priority than gcc-wrapper to prevent a
collision due to the ld/as wrappers/symlinks in the latter.</p>
</blockquote>
</li>
<li>Both <code>gcc</code> wrapper and all-packages set gcc priority to 10,
see nixpkgs: <code>pkgs/top-level/all-packages.nix</code> and
<code>pkgs/build-support/cc-wrapper/default.nix</code>
All-packages set priority by lowPrio function,
which will set priority to 10.
Cc-wrapper directly set priority to 10.</li>
</ul>
<p>As a result, <code>binutils</code> will definitely collide with <code>gcc</code>!</p>
<p>My solution: assign <code>binutils</code> a lower priority, like this</p>
<pre><code class="language-nix">home.packages = with pkgs; [
  (lib.setPrio # higher value, less prior
    (bintools-unwrapped.meta.priority + 1)
    bintools-unwrapped
  )
  gdb
]
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># * hstr: not handle `~` correctly, always expand
# * atuin: often not record my command, do know why
#   * besides, the network sync is redundant for me
{ ... }: {
  programs.mcfly = {
    enable = true;
    enableBashIntegration = true;
    fuzzySearchFactor = 3;
    fzf.enable = true;
    keyScheme = "vim";
  };
  programs.bash.bashrcExtra = /*bash*/ ''
    export MCFLY_RESULTS_SORT=LAST_RUN
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nodejs-packages-npm-in-nixos"><a class="header" href="#nodejs-packages-npm-in-nixos">Nodejs packages (npm) in NixOS</a></h1>
<h1 id="nixos中的nodejs包npm"><a class="header" href="#nixos中的nodejs包npm">NixOS中的Nodejs包（npm）</a></h1>
<p>太长不看：手动暴露<code>buildNodePackage</code>，添加自定义的npm包。</p>
<p>nixpkgs中的node包虽多但有限，
遇到需要的node包不存在时，是个麻烦事。</p>
<p>让我觉得十分诡异的是，
nixpkgs中存在一个十分方便的添加node包的函数<code>nodeEnv.buildNodePackage</code>，
但是这个函数却不暴露出来给用户。
甚至，有些nixpkgs中的包为了使用这个函数，
复制粘贴该函数到自己的包中。</p>
<p>在这些奇怪的事情的基础上，
还衍生出来自动生成该<code>buildNodePackage</code>函数软件<code>node2nix</code>。</p>
<p>所以这真的是存在即合理嘛？
还是我学艺不精，不能理解设计者的意图？</p>
<p>一个简单的暴露<code>buildNodePackage</code>的方法，
直接导入<code>buildNodePackage</code>所在的文件。
为了跨平台可用，
路径的构建采用了一点使用了点点小把戏，</p>
<pre><code class="language-nix">&lt;nixpkgs&gt; + /pkgs/development/node-packages/node-env.nix
</code></pre>
<p>以@types/node为例子，nodepkgs.nix：</p>
<pre><code class="language-nix">{ ... }:
let
  pkgs = import &lt;nixpkgs&gt; {};
  nodeEnv = import (&lt;nixpkgs&gt; + /pkgs/development/node-packages/node-env.nix) {
    inherit (pkgs) lib stdenv nodejs python2;
    inherit pkgs;
    inherit (pkgs) libtool runCommand writeTextFile writeShellScript;
  };
  globalBuildInputs = [];
in {
  "@types/node" = nodeEnv.buildNodePackage {
    name = "_at_types_slash_node";
    packageName = "@types/node";
    version = "18.7.15";
    src = pkgs.fetchurl {
      url = "https://registry.npmjs.org/@types/node/-/node-18.7.15.tgz";
      sha512 = "XnjpaI8Bgc3eBag2Aw4t2Uj/49lLBSStHWfqKvIuXD7FIrZyMLWp8KuAFHAqxMZYTF9l08N1ctUn9YNybZJVmQ==";
    };
    buildInputs = globalBuildInputs;
    meta = {
      description = "TypeScript definitions for Node.js";
      homepage = "https://github.com/DefinitelyTyped/DefinitelyTyped/tree/master/types/node";
      license = "MIT";
    };
    production = true;
    bypassCache = true;
    reconstructLock = true;
  };
}
</code></pre>
<p>该nodepkgs.nix文件为用户自定义的node包，
可以像nixpkgs一样使用这个文件，例如导入</p>
<pre><code class="language-nix">myNodePkgs = import ./cli/nodepkgs.nix {}
</code></pre>
<p>包的表达式为<code>myNodePkgs."@types/node"</code>。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="python-in-nixnixos"><a class="header" href="#python-in-nixnixos">Python in Nix/NixOS</a></h1>
<div style="text-align:right; font-size:3em;">2023.05.03</div>
<div class="table-wrapper"><table><thead><tr><th>Project</th><th>Maintained</th><th>Description</th><th>Purity</th><th>Compatibility</th></tr></thead><tbody>
<tr><td>venv</td><td></td><td></td><td>❌</td><td>100%?</td></tr>
<tr><td>mach-nix</td><td>✅</td><td></td><td></td><td></td></tr>
<tr><td>pypi2nix</td><td>❌</td><td></td><td></td><td></td></tr>
<tr><td>pip2nix</td><td>✅</td><td></td><td>✅</td><td></td></tr>
<tr><td><code>buildPythonPackage</code></td><td>✅</td><td></td><td>✅</td><td></td></tr>
<tr><td>[TODO] poetry</td><td></td><td></td><td></td><td></td></tr>
<tr><td>[TODO] dream2nix</td><td></td><td></td><td></td><td></td></tr>
</tbody></table>
</div>
<h2 id="pip2nix"><a class="header" href="#pip2nix">pip2nix</a></h2>
<p>Noted: Latest version of pip2nix only use python39.
While nixpkgs 22.11 (current stable) is python310.
I dont to install multiple versions of python3.</p>
<p>If pip2nix can overcome the disadvantage of that
generate a long list of python packages,
and reuse python3Packages in nixpkgs,
I would prefer to use pip2nix completely.</p>
<p>Currently, I use <code>buildPythonPackage</code>.</p>
<h2 id="buildpythonpackage"><a class="header" href="#buildpythonpackage"><code>buildPythonPackage</code></a></h2>
<p><code>pkgs.python3Packages.buildPythonPackage</code></p>
<h2 id="venv"><a class="header" href="#venv">venv</a></h2>
<p>Use virtualenv, <code>pip</code> is available, no need to write nix expressions to install packages.</p>
<p>Code see https://xieby1.github.io/scripts/index.html#venvnix</p>
<h2 id="poetry"><a class="header" href="#poetry">poetry</a></h2>
<div style="text-align:right; font-size:3em;">2022.05.15</div>
<p>According to <a href="https://www.reddit.com/r/NixOS/comments/q71v0e/what_is_the_correct_way_to_setup_pip_with_nix_to/">What is the correct way to setup pip with nix to install any python package in an isolated nix environment</a>,
I found two useful tools to install python packages in Nix/NixOS</p>
<ul>
<li>[TODO] poetry</li>
<li>mach-nix</li>
</ul>
<h2 id="mach-nix"><a class="header" href="#mach-nix">mach-nix</a></h2>
<p>mach-nix github repo:
<a href="https://github.com/DavHau/mach-nix">github.com/DavHau/mach-nix</a></p>
<p>Here is [python_mach.nix]({{ site.repo_url }}/scripts/shell/python_mach.nix),
an example which create a shell with a python package called expmcc.</p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, lib, pkgs, ... }: {
  home.packages = [
    pkgs.sshfs
  ];
  programs.ssh.enable = true;
  programs.ssh.includes = lib.optional (builtins.pathExists ~/Gist/Config/ssh.conf) "~/Gist/Config/ssh.conf";
  programs.bash.bashrcExtra = lib.optionalString config.isNixOnDroid ''
    # start sshd
    if [[ -z "$(pidof sshd-start)" ]]; then
        tmux new -d -s sshd-start sshd-start
    fi
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><div style="text-align:right; font-size:3em;">2022.05.29</div>
<h1 id="静态链接以qemu为例"><a class="header" href="#静态链接以qemu为例">静态链接，以qemu为例</a></h1>
<p>太长不看</p>
<ul>
<li>实现了qemu静态链接，无任何动态链接库的依赖。
采用了两个版本的qemu，当前版本Nix的qemu（nix 21.11, qemu 6.1.1）
和qemu3.1.0这两个版本。</li>
<li>nix脚本：<a href="https://github.com/xieby1/xieby1.github.io/blob/main/src/scripts/nix/pkgs_qemu_static.nix">pkgs_qemu_static.nix</a></li>
</ul>
<h2 id="pkgsstatic及其源代码"><a class="header" href="#pkgsstatic及其源代码">pkgsStatic及其源代码</a></h2>
<p>Nixpkgs含有pkgsStatic软件包，但是大多软件无法直接使用。
需要进行手动修复。</p>
<p>pkgsStatic加载过程的源码</p>
<ul>
<li>
<p>pkgs/top-level/stage.nix
将crossSystem设置为static且abi为musl。
之所以用Musl是因为，</p>
<blockquote>
<p>Currently uses Musl on Linux (couldn’t get static glibc to work).</p>
</blockquote>
<p>其代码大致的如下，</p>
<pre><code class="language-nix">pkgsStatic = nixpkgsFun {
  crossSystem = {
    isStatic = true;
    parsed = stdenv.hostPlatform.parsed // {
      abi = musl;
};};};
</code></pre>
<ul>
<li>nixpkgsFun = newArgs: import pkgs/top-level/default.nix (...)
<ul>
<li>pkgs/top-level/default.nix: stdenvStages {..., crossSystem, ...}
<ul>
<li>pkgs/stdenv/default.nix: stagesCross
<ul>
<li>pkgs/stdenv/cross/default.nix: stdenvAdapters.makeStatic
<ul>
<li>pkgs/stdenv/adapters.nix: makeStatic
<ul>
<li>makeStaticLibraries
<ul>
<li>添加configureFlags "--enable-static" "--disable-shared"</li>
<li>添加cmakeFlags "-DBUILD_SHARED_LIBS:BOOL=OFF"</li>
<li>添加mesonFlags "-Ddefault_library=static"</li>
</ul>
</li>
<li>makeStaticBinaries
<ul>
<li>添加NIX_CFLAGS_LINK "-static"</li>
<li>添加configureFlags "--disable-shared"</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>TODO: 读懂makeStaticLibraries和makeStaticBinaries。</p>
<h2 id="基本思路"><a class="header" href="#基本思路">基本思路</a></h2>
<p>对于当前版本的qemu，使用pkgsStatic.qemu
，挨个修复编译报错即可。</p>
<p>对于历史版本的qemu，以3.1.0为例，编译方式已和现在有区别，
比如之前完全是configure, make，而现在引入了meson。
初步设想两种方案，</p>
<ol>
<li>嫁接老版本nixpkgs到当前版本
将qemu-3.1.0对应的nixpkgs嫁接到当前的nixpkgs</li>
<li>改造新版本nixpkgs以适应老版本
通过overlay,override方法修改当前nixpkgs的qemu的nix表达式</li>
</ol>
<p>我采用的第一种办法，将老版本nixpkgs嫁接到当前版本nixpkgs。
使用<a href="https://lazamar.co.uk/nix-versions">lazamar.co.uk/nix-versions</a>
查询支持qemu-3.1.0的nixpkgs版本。
引入qemu-3.1.0的示例代码如下，详细见<a href="https://github.com/xieby1/xieby1.github.io/blob/main/src/scripts/nix/pkgs_qemu_static.nix">pkgs_qemu_static.nix</a></p>
<pre><code class="language-nix"># get old nixpkgs which contains qemu-3.1.0
oldNixpkgsSrc = builtins.fetchTarball {...}
qemu31 = pkgs.callPackage (
  oldNixpkgsSrc + "/pkgs/applications/virtualization/qemu/default.nix"
) {...}
</code></pre>
<p>然后挨个修复编译报错即可。</p>
<h2 id="调试手段"><a class="header" href="#调试手段">调试手段</a></h2>
<h3 id="还原构建环境"><a class="header" href="#还原构建环境">还原构建环境</a></h3>
<pre><code class="language-bash"># 保留构建失败的现场
nix-build pkgs_qemu_static.nix -K
</code></pre>
<p>进入现场包含env-vars文件和失败时的源码文件夹。
恢复环境，</p>
<pre><code class="language-bash">. ./env-vars
. $stdenv/setup
</code></pre>
<h3 id="查看依赖树"><a class="header" href="#查看依赖树">查看依赖树</a></h3>
<pre><code class="language-bash">nix-store --query --tree &lt;xxx.drv&gt;
</code></pre>
<h3 id="结果"><a class="header" href="#结果">结果</a></h3>
<p>目前仅需要命令行的qemu，因此为了省事，
我去掉了声音和图像支持。</p>
<p>注：在NixOS 21.11上和在ubuntu 22配合nix上编译出来的qemu二进制文件一模一样。</p>
<pre><font color="#4E9A06"><b>xieby1@yoga14s</b></font>:<font color="#3465A4"><b>~</b></font>
<font color="#4E9A06"><b>$</b></font> pkgs_qemu_static.nix 
/nix/store/gs6plgyc0jr9i5qams0ifksijnq9hkq2-qemu-static-x86_64-unknown-linux-musl-6.1.1
/nix/store/lm9kl1nm7bs4hy6l4qng03k4srx1x28n-qemu-3.1.0-x86_64-unknown-linux-musl
<font color="#4E9A06"><b>xieby1@yoga14s</b></font>:<font color="#3465A4"><b>~</b></font>
<font color="#4E9A06"><b>$</b></font> ldd result/bin/qemu-system-x86_64 
	not a dynamic executable
<font color="#4E9A06"><b>xieby1@yoga14s</b></font>:<font color="#3465A4"><b>~</b></font>
<font color="#4E9A06"><b>$</b></font> result/bin/qemu-system-x86_64 --version
QEMU emulator version 6.1.1
Copyright (c) 2003-2021 Fabrice Bellard and the QEMU Project developers
<font color="#4E9A06"><b>xieby1@yoga14s</b></font>:<font color="#3465A4"><b>~</b></font>
<font color="#4E9A06"><b>$</b></font> ldd result-2/bin/qemu-system-x86_64 
	not a dynamic executable
<font color="#4E9A06"><b>xieby1@yoga14s</b></font>:<font color="#3465A4"><b>~</b></font>
<font color="#4E9A06"><b>$</b></font> result-2/bin/qemu-system-x86_64  --version
QEMU emulator version 3.1.0
Copyright (c) 2003-2018 Fabrice Bellard and the QEMU Project developers</pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tailscaleheadscale"><a class="header" href="#tailscaleheadscale">Tailscale/Headscale</a></h1>
<h2 id="overview"><a class="header" href="#overview">overview</a></h2>
<ul>
<li>client
<ul>
<li>tailscale</li>
<li>tailscaled</li>
</ul>
</li>
<li>server
<ul>
<li>headscale</li>
</ul>
</li>
</ul>
<h2 id="command"><a class="header" href="#command">Command</a></h2>
<p>TODO: exit node</p>
<ul>
<li>https://www.reddit.com/r/Tailscale/comments/w9mtow/question_about_headscale_and_routing/</li>
<li>https://icloudnative.io/posts/how-to-set-up-or-migrate-headscale/</li>
</ul>
<p>TODO: headtail config
TODO: nix config</p>
<ul>
<li>rootless service</li>
<li>root service</li>
</ul>
<pre><code class="language-bash">tailscale --socket /tmp/tailscaled.sock up --login-server http://82.157.197.100
tailscale --socket /tmp/tailscaled.sock up --login-server http://82.157.197.100 --force-reauth
</code></pre>
<h3 id="enable-routes-exit-node"><a class="header" href="#enable-routes-exit-node">enable routes, exit node</a></h3>
<p>sudo tailscale --socket /tmp/tailscaled.sock up --login-server http://82.157.197.100 --advertise-routes=0.0.0.0/0,::/0 --accept-routes=true</p>
<p>sudo docker exec headscale headscale nodes routes enable -i 13 -a -r 0.0.0.0/0 -r ::/0</p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  tailscale-bash-completion = builtins.derivation {
    name = "tailscale-bash-completion";
    system = builtins.currentSystem;
    src = builtins.fetchurl "https://gist.githubusercontent.com/cmtsij/f0d0be209224a7bdd67592695e1427de/raw/tailscale";
    builder = pkgs.writeShellScript "tailscale-bash-completion-builder" ''
      source ${pkgs.stdenv}/setup
      dstdir=$out/share/bash-completion/completions
      dst=$dstdir/tailscale
      mkdir -p $dstdir
      cp $src $dst
    '';
  };
  tailscale-wrapper = {suffix, httpPort, socks5Port}: let
    tailscale-wrapped = pkgs.writeShellScriptBin "tailscale-${suffix}" ''
      tailscale --socket /tmp/tailscale-${suffix}.sock $@
    '';
    stateDir = "${config.home.homeDirectory}/.local/share/tailscale-${suffix}";
    tailscaled-wrapped = pkgs.writeShellScriptBin "tailscaled-${suffix}" ''
      TS_LOGS_DIR="${stateDir}" \
        ${pkgs.tailscale}/bin/tailscaled \
        --tun userspace-networking \
        --outbound-http-proxy-listen=localhost:${httpPort} \
        --socks5-server=localhost:${socks5Port} \
        --socket=/tmp/tailscale-${suffix}.sock \
        --state=${stateDir}/tailscaled.state \
        --statedir=${stateDir} \
        $@
    '';
    tailscale-wrapped-bash-completion = builtins.derivation {
      name = "tailscale-${suffix}-bash-completion";
      system = builtins.currentSystem;
      builder = pkgs.writeShellScript "tailscale-${suffix}-bash-completion-builder" ''
        source ${pkgs.stdenv}/setup
        reldir=share/bash-completion/completions
        dstdir=$out/$reldir
        dst=$dstdir/tailscale-${suffix}
        mkdir -p $dstdir
        touch $dst
        echo ". ${tailscale-bash-completion}/$reldir/tailscale" &gt;&gt; $dst
        echo "complete -F _tailscale tailscale-${suffix}" &gt;&gt; $dst
      '';
    };
  in {
    home.packages = [
      tailscale-wrapped
      tailscaled-wrapped
      tailscale-wrapped-bash-completion
    ];
    systemd.user.services."tailscaled-${suffix}" = {
      Unit = {
        Description = "Auto start tailscaled-${suffix} userspace network";
        After = ["clash.service"];
      };
      Install = {
        WantedBy = ["default.target"];
      };
      Service = {
        Environment = [
          "HTTPS_PROXY=http://127.0.0.1:${toString config.proxyPort}"
          "HTTP_PROXY=http://127.0.0.1:${toString config.proxyPort}"
          "https_proxy=http://127.0.0.1:${toString config.proxyPort}"
          "http_proxy=http://127.0.0.1:${toString config.proxyPort}"
        ];
        ExecStart = "${tailscaled-wrapped}/bin/tailscaled-${suffix}";
      };
    };
    programs.bash.bashrcExtra = lib.optionalString config.isNixOnDroid ''
      # start tailscale-${suffix}
      if [[ -z "$(pidof tailscaled-${suffix})" ]]; then
          tmux new -d -s tailscaled-${suffix} tailscaled-${suffix}
      fi
    '';
  };
in {
  imports = [{
    home.packages = [pkgs.tailscale tailscale-bash-completion];
  }
    # (tailscale-wrapper {suffix="headscale"; httpPort="1055"; socks5Port="1065";})
    (tailscale-wrapper {suffix="official";  httpPort="1056"; socks5Port="1066";})
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tmux"><a class="header" href="#tmux">tmux</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }: {
  home.packages = [pkgs.tmux];
</code></pre>
<h2 id="bash-config-for-tmux"><a class="header" href="#bash-config-for-tmux">bash config for tmux</a></h2>
<p>Auto start tmux in non-GUI device.
mkAfter ensure the tmux config is appended to the tail of .bashrc.</p>
<pre><code class="language-nix">  programs.bash.bashrcExtra = lib.mkAfter (lib.optionalString (!config.isGui) ''
    # Auto start tmux
    # see: https://unix.stackexchange.com/questions/43601/how-can-i-set-my-default-shell-to-start-up-tmux
    # ~~1. tmux exists on the system~~, nix ensure that tmux does exist
    # 2. we're in an interactive shell, and
    # 3. tmux doesn't try to run within itself
    if [ -n "$PS1" ] &amp;&amp; [[ ! "$TERM" =~ screen ]] &amp;&amp; [[ ! "$TERM" =~ tmux ]] &amp;&amp; [ -z "$TMUX" ]; then
      exec tmux
    fi
  '');
</code></pre>
<h2 id="tmux-config-file"><a class="header" href="#tmux-config-file">tmux config file</a></h2>
<pre><code class="language-nix">  home.file.tmux = {
    text = ''
      # display status at top
      set -g status-position top
      set -g status-right ""

      # status bar
      ## display title on terminal
      set -g set-titles on
      set -g window-status-format "#F#I #W #{=/-20/…:pane_title}"
      set -g window-status-current-format "🐶#F#I #W #{=/-20/…:pane_title}"
      ## hide status bar when only one window
      ### refer to
      ### https://www.reddit.com/r/tmux/comments/6lwb07/is_it_possible_to_hide_the_status_bar_in_only_a/
      ### It not good, since its global!
      # if -F "#{==:#{session_windows},1}" "set -g status off" "set -g status on"
      # set-hook -g window-linked 'if -F "#{==:#{session_windows},1}" "set -g status off" "set -g status on"'
      # set-hook -g window-unlinked 'if -F "#{==:#{session_windows},1}" "set -g status off" "set -g status on"'
      ## color
      ### colour256的前10个和终端(gnome-terminal tango)的配色一致
      set -g status-style "bg=white fg=black"
      set -g window-status-last-style "bg=white fg=green bold"
      set -g window-status-current-style "bg=black fg=green bold"
      set -g window-status-separator " ┇"

      # enable mouse scroll
      set -g mouse on

      # window index start from 1
      set -g base-index 1
      setw -g pane-base-index 1

      # auto re-number
      set -g renumber-windows on

      # Set new panes to open in current directory
      bind c new-window -c "#{pane_current_path}"
      bind '"' split-window -c "#{pane_current_path}"
      bind % split-window -h -c "#{pane_current_path}"

      # alt-num select window
      bind-key -n M-1 select-window -t 1
      bind-key -n M-2 select-window -t 2
      bind-key -n M-3 select-window -t 3
      bind-key -n M-4 select-window -t 4
      bind-key -n M-5 select-window -t 5
      bind-key -n M-6 select-window -t 6
      bind-key -n M-7 select-window -t 7
      bind-key -n M-8 select-window -t 8
      bind-key -n M-9 select-window -t 9
      # ctrl-t new window
      bind-key -n C-t new-window -c "#{pane_current_path}"

      # vi key bindings
      set -g mode-keys vi
      set -g status-keys vi

      # Home, End key not work in nix-on-droid
      # https://stackoverflow.com/questions/18600188/home-end-keys-do-not-work-in-tmux
      bind-key -n Home send Escape "OH"
      bind-key -n End send Escape "OF"

      set -g allow-passthrough on
    '';
    target = ".tmux.conf";
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="neovim"><a class="header" href="#neovim">📑neovim</a></h1>
<p>xieby1's neovim config!</p>
<p>See <a href="usr/cli/vim/./default.nix.html">default.nix</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="auto-sessions-management"><a class="header" href="#auto-sessions-management">auto sessions management</a></h1>
<p>auto-session vs persisted.nvim vs persistence-nvim</p>
<ul>
<li>auto-session support multiple sessions per path (customized session name),
while other two not support</li>
<li>persisted-nvim support telescope, while persistence-nvim not</li>
</ul>
<pre><code class="language-nix">{ pkgs, ... }: { programs.neovim.plugins = [{
  # TODO: replace this (2025.09.10) with nixpkgs's in future
  # use latest auto-session for auto use telescope
  plugin = pkgs.vimUtils.buildVimPlugin {
    name = "custom_session_tag";
    src = pkgs.fetchFromGitHub {
      owner = "rmagatti";
      repo = "auto-session";
      rev = "3b5d8947cf16ac582ef00443ede4cdd3dfa23af9";
      hash = "sha256-JOJNnz+1tzTJh5xTpkoTYPRAt4lR1HN7FP1fSXhzU2s=";
    };
    doCheck = false;
  };
  type = "lua";
  config = /*lua*/ ''
    require("auto-session").setup({
      -- auto_save will not update existing tag
      -- e.g.:
      -- * restore a session tag is (time1 win1┇win2)
      -- * ... some vim operations ...
      -- * when leave vim, there are only win1, the tag is expected to become (time2 win1)
      -- * However the tag is not updated, which is still (time1 win1┇win2)
      -- So I disable the original auto_save,
      -- and manually execute save when VimLeavePre,
      -- see VimLeavePre below.
      auto_save = false,
      auto_restore = false,
      args_allow_files_auto_save = true,
      -- auto purge session after 30 days
      purge_after_minutes = 60*24*30,
      session_lens = {
        -- for telescope
        picker_opts = { layout_config = { width = 0.95 } },
      },
    })
    vim.api.nvim_create_autocmd("VimLeavePre", { callback = function()
      local buffers = {}
      for _, win in ipairs(vim.api.nvim_list_wins()) do
        local buf = vim.api.nvim_win_get_buf(win)
        local buf_name = vim.api.nvim_buf_get_name(buf)
        if buf_name ~= "" then
          -- Extract just the filename from the full path
          local filename = vim.fn.fnamemodify(buf_name, ":~:.")
          table.insert(buffers, filename)
        end
      end

      local buffers_occurrences = {}
      for _, buf in ipairs(buffers) do
        if buffers_occurrences[buf] then
          buffers_occurrences[buf] = buffers_occurrences[buf] + 1
        else
          buffers_occurrences[buf] = 1
        end
      end

      local buffers_strs = {}
      for buf, occurrence in pairs(buffers_occurrences) do
        if occurrence == 1 then
          table.insert(buffers_strs, buf)
        else --[[occurrence &gt; 1]]
          table.insert(buffers_strs, string.format("%s[%d]", buf, occurrence))
        end
      end

      table.sort(buffers_strs)
      local buffers_string = table.concat(buffers_strs, ", ")

      -- save session iff buffers_string is not empty
      if buffers_string ~= "" then
        require("auto-session").SaveSession(string.format("%s %s: %s",
          os.date("%d日"),
          vim.fn.fnamemodify(vim.fn.getcwd(), ":~"),
          buffers_string
        ))
      end
    end})
  '';
}];}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="completion"><a class="header" href="#completion">completion</a></h1>
<h1 id="blink-cmp-vs-nvim-cmp"><a class="header" href="#blink-cmp-vs-nvim-cmp">blink-cmp vs nvim-cmp</a></h1>
<h1 id="-as-the-config-looks-too-hacking-and-too-many-issues-remaining-unsolved-in-github"><a class="header" href="#-as-the-config-looks-too-hacking-and-too-many-issues-remaining-unsolved-in-github">* as the config looks too hacking and too many issues remaining unsolved in github</a></h1>
<h1 id="-and-nvim-cmp-last-maintain-is-5-months-ago-blink-cmp-is-5-days-ago"><a class="header" href="#-and-nvim-cmp-last-maintain-is-5-months-ago-blink-cmp-is-5-days-ago">* and nvim-cmp last maintain is 5 months ago, blink-cmp is 5 days ago.</a></h1>
<h1 id="-and-minuet-ai-nvim-delay-in-nvim-cmp-and-not-solved-blink-cmp-is-async"><a class="header" href="#-and-minuet-ai-nvim-delay-in-nvim-cmp-and-not-solved-blink-cmp-is-async">* and minuet-ai-nvim delay in nvim-cmp and not solved, blink-cmp is async</a></h1>
<pre><code class="language-nix"># TODO: split providers into separate files
{ pkgs, ... }: { programs.neovim = {
  plugins = [(pkgs.vimUtils.buildVimPlugin {
    name = "blink-cmp-dictionary";
    version = "2025-09-17";
    # current nixpkgs version does not support capitalize_first &amp; capitalize_whole_word
    # TODO: use latest version from nixpkgs when support above options
    src = pkgs.fetchFromGitHub {
      owner = "Kaiser-Yang";
      repo = "blink-cmp-dictionary";
      rev = "43b701fe9728a704bc63e4667c5d8b398bf129b2";
      hash = "sha256-szCNbYLWkJTAVGWz9iRFh7NfQfM5t5jcQHdQeKzBx30=";
    };
    doCheck = false;
  }) {
    # match unicode characters =&gt; match alphabet characters instead.
    # E.g. I don't want to completion a long CJK sentence.
    # E.g. I want alphabet next to CJK can be completed: "例子example"
    #      In original blink-fuzzy-lib, "example" cannot be completed.
    # (Due to the libblink_cmp_fuzzy being not easy to be patched,
    # the nix patch code becomes a large chunk as below.)
    plugin = pkgs.vimPlugins.blink-cmp.overrideAttrs (old: let
      postPatch = ''
        ## This is where texts being collected
        sed -i 's/\\p{L}/a-zA-Z/g' lua/blink/cmp/fuzzy/rust/lib.rs
        ## This is where trigger range is decided
        ## This change will break blink-fuzzy-lib check, so doCheck=false
        sed -i 's/\\p{L}/a-zA-Z/g' lua/blink/cmp/fuzzy/rust/keyword.rs
      '';
    in {
      # Here, postPatch does not effect blink-fuzzy-lib,
      # however, for consistency between source code and libblink_cmp_fuzzy.so,
      # I patch the source code as well.
      inherit postPatch;

      preInstall = let
        ext = pkgs.stdenv.hostPlatform.extensions.sharedLibrary;
        blink-fuzzy-lib = old.passthru.blink-fuzzy-lib.overrideAttrs { inherit postPatch; doCheck=false; };
      in ''
        mkdir -p target/release
        ln -s ${blink-fuzzy-lib}/lib/libblink_cmp_fuzzy${ext} target/release/libblink_cmp_fuzzy${ext}
      '';
    });
    type = "lua";
    config = /*lua*/ ''
      require("blink.cmp").setup({
        keymap = { preset = 'none',
          ['&lt;Tab&gt;']   = { 'select_next', 'fallback' },
          ['&lt;S-Tab&gt;'] = { 'select_prev', 'fallback' },
          ['&lt;Up&gt;']   = { function(cmp) return cmp.select_prev({ auto_insert = false }) end, 'fallback' },
          ['&lt;Down&gt;'] = { function(cmp) return cmp.select_next({ auto_insert = false }) end, 'fallback' },
          ['&lt;CR&gt;'] = { 'accept', 'fallback' },
          ['&lt;A-1&gt;'] = { function(cmp) cmp.accept({ index = 1 }) end },
          ['&lt;A-2&gt;'] = { function(cmp) cmp.accept({ index = 2 }) end },
          ['&lt;A-3&gt;'] = { function(cmp) cmp.accept({ index = 3 }) end },
          ['&lt;A-4&gt;'] = { function(cmp) cmp.accept({ index = 4 }) end },
          ['&lt;A-5&gt;'] = { function(cmp) cmp.accept({ index = 5 }) end },
          ['&lt;A-6&gt;'] = { function(cmp) cmp.accept({ index = 6 }) end },
          ['&lt;A-7&gt;'] = { function(cmp) cmp.accept({ index = 7 }) end },
          ['&lt;A-8&gt;'] = { function(cmp) cmp.accept({ index = 8 }) end },
          ['&lt;A-9&gt;'] = { function(cmp) cmp.accept({ index = 9 }) end },
          ['&lt;A-0&gt;'] = { function(cmp) cmp.accept({ index = 10 }) end },
          ['&lt;A-y&gt;'] = require('minuet').make_blink_map(),
        },
        completion = {
          documentation = { auto_show = true },
          menu = {
            draw = {
              columns = {
                {'item_idx'},
                {'kind_icon'}, {'label', 'label_description', gap = 1},
                {'source_name'},
              },
              components = {
                item_idx = {
                  text = function(ctx) return ctx.idx == 10 and '0' or ctx.idx &gt;= 10 and ' ' or tostring(ctx.idx) end,
                  highlight = 'BlinkCmpSource' -- optional, only if you want to change its color
                },
              },
            },
          },
          list = { selection = { preselect = false }, },
        },
        sources = {
          default = {
            'lsp', 'path', 'buffer', 'snippets',
            'minuet',
            "dictionary"
          },
          providers = {
            -- &gt; By default, the buffer source will only show when the LSP source returns no items
            -- Always show buffer completion, defaults to `{ 'buffer' }`
            lsp = { fallbacks = {}, },
            minuet = {
              name = 'minuet',
              module = 'minuet.blink',
              async = true,
              -- Should match minuet.config.request_timeout * 1000,
              -- since minuet.config.request_timeout is in seconds
              timeout_ms = 3000,
              score_offset = 50, -- Gives minuet higher priority among suggestions
            },
            -- blink-cmp-dictionary vs blink-cmp-dat-word
            -- former can handle capitalization proper, while latter cannot
            dictionary = {
              name = 'dict',
              module = 'blink-cmp-dictionary',
              min_keyword_length = 3,
              score_offset = -4, -- lower priority than buffer's -3
              opts = { dictionary_directories = { vim.fn.expand('~/Gist/dicts/') }, },
            },
          },
        },
        cmdline = {
          -- TODO: blink-cmp cmdline cannot complete `'`,
          -- for example: `:h statusline` cannot complete to `:h 'statusline'`
          -- thus disable it currently
          enabled = false,
          keymap = { preset = 'inherit',
            ['&lt;Tab&gt;'] = { 'show_and_insert', 'select_next' },
            ['&lt;CR&gt;'] = { 'accept_and_enter', 'fallback' },
          },
          completion = { list = { selection = { preselect = false }, }, },
        },
      })
      vim.lsp.config('*', {
        capabilities = require('blink.cmp').get_lsp_capabilities(),
      })
    '';
  }];
};
home.file.dicts_words = {
  source = let
    words = pkgs.fetchurl {
      url = "https://github.com/first20hours/google-10000-english/raw/bdf4c221bc120b0b7f6c3f1eff1cc1abb975f8d8/google-10000-english-no-swears.txt";
      sha256 = "11pd0p6ckixr1b5qvi6qxj389wmzq1k42is1bm9fc2y3397y1cyn";
    };
  in pkgs.runCommand "words_more_than_5_letters" {} "awk 'length($0) &gt; 5' ${words} &gt; $out";
  target = "Gist/dicts/words.txt";
};
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="key-bindings-of-closing-windows"><a class="header" href="#key-bindings-of-closing-windows">key bindings of closing windows</a></h1>
<pre><code class="language-nix">{ ... }: { programs.neovim.extraLuaConfig = /*lua*/ ''
  for Dir, cmd in pairs({Left="h", Down="j", Up="k", Right="l"}) do
    local f = function()
      local beg = vim.api.nvim_get_current_win()
      local cur
      while true do
        vim.api.nvim_set_current_win(beg)
        vim.cmd(string.format("wincmd %s", cmd))
        cur = vim.api.nvim_get_current_win()
        if cur == beg then break end
        vim.cmd("q")
      end
    end
    vim.keymap.set('n', string.format("Z&lt;%s&gt;", Dir), f)
    vim.keymap.set('n', string.format("Z&lt;S-%s&gt;", Dir), f)
  end
  vim.keymap.set('n', "ZA", "&lt;CMD&gt;qa!&lt;CR&gt;")
'';}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="code-companion-ai"><a class="header" href="#code-companion-ai">Code Companion: AI</a></h1>
<pre><code class="language-nix">{ lib, pkgs, ... }: {
  programs.neovim.plugins = [{
    plugin = pkgs.vimPlugins.codecompanion-nvim;
    type = "lua";
    # https://codecompanion.olimorris.dev/configuration/adapters.html
    config = /*lua*/ ''
      require("codecompanion").setup({
        adapters = {
          deepseek = function() return require("codecompanion.adapters").extend("deepseek", {
            env = { api_key = "cmd:cat ~/Gist/Vault/deepseek_api_key_nvim.txt" },
            schema = { model = { default = "deepseek-chat" } },
          }) end,
        },
        display = {
          chat = {
            window = {
              position = "left",
              width = 40,
            },
            diff = { enabled = true },
          },
        },
        strategies = {
          chat = { adapter = "deepseek" },
          inline = { adapter = "deepseek" },
        },
      })

      -- key bindings of AI
      vim.keymap.set('n', '&lt;leader&gt;a', ':CodeCompanionChat Toggle&lt;CR&gt;')
      vim.keymap.set('v', '&lt;leader&gt;a', ':CodeCompanionChat Add&lt;CR&gt;')
    '';
  }];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="my-nvim-color-scheme"><a class="header" href="#my-nvim-color-scheme">🎨My nvim color scheme</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-color-scheme = {
    plugin = pkgs.vimPlugins.sonokai;
    config = ''
      nnoremap &lt;leader&gt;c :set termguicolors!&lt;CR&gt;
      set termguicolors

      let g:sonokai_transparent_background = 1

      let g:sonokai_colors_override = {
      \ 'black':    ['#111215', '237'],
      \ 'bg0':      ['#22232a', '235'],
      \ 'bg1':      ['#33353f', '236'],
      \ 'bg2':      ['#444754', '236'],
      \ 'bg3':      ['#555869', '237'],
      \ 'bg4':      ['#666a7e', '237'],
      \ 'grey':     ['#a5a5a6', '246'],
      \ 'grey_dim': ['#787879', '240'],
      \}

      " custom sonokai,
      " see section "How to use custom colors" of `:h sonokai.vim`
      function! s:sonokai_custom() abort
        let l:palette = sonokai#get_palette('default', {})
        call sonokai#highlight('StatusLine', l:palette.black, l:palette.fg, 'bold')
        call sonokai#highlight('StatusLineNC', l:palette.black, l:palette.grey, 'bold')
      endfunction
      augroup SonokaiCustom
        autocmd!
        autocmd ColorScheme sonokai call s:sonokai_custom()
      augroup END

      colorscheme sonokai
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-color-scheme
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="conform-nvim-formatter"><a class="header" href="#conform-nvim-formatter">conform-nvim: formatter</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim = {
   plugins = [{
    plugin = pkgs.vimPlugins.conform-nvim;
    type = "lua";
    config = ''
      require("conform").setup({
        formatters_by_ft = {
          nix = { "nixfmt" },
          c = { "clang_format" },
          cpp = { "clang_format" },
          json = { "js_beautify" },
          javascript = { "js_beautify" },
        },
      })

      -- refer to https://github.com/stevearc/conform.nvim/blob/master/doc/recipes.md#format-command
      vim.api.nvim_create_user_command("TrimWhitespace", function(args)
        local range = nil
        if args.count ~= -1 then
          local end_line = vim.api.nvim_buf_get_lines(0, args.line2 - 1, args.line2, true)[1]
          range = {
            start = { args.line1, 0 },
            ["end"] = { args.line2, end_line:len() },
          }
        end
        require("conform").format({ formatters = {"trim_whitespace"}, range = range })
      end, { range = true })
      vim.keymap.set({'n','v'}, '&lt;leader&gt;f', ':TrimWhitespace&lt;CR&gt;')

      vim.api.nvim_create_user_command("Format", function(args)
        local range = nil
        if args.count ~= -1 then
          local end_line = vim.api.nvim_buf_get_lines(0, args.line2 - 1, args.line2, true)[1]
          range = {
            start = { args.line1, 0 },
            ["end"] = { args.line2, end_line:len() },
          }
        end
        require("conform").format({ async = true, lsp_fallback = true, range = range })
      end, { range = true })
      vim.keymap.set({'n','v'}, '&lt;leader&gt;F', ':Format&lt;CR&gt;')
    '';
   }];
    extraPackages = with pkgs; [
      nixfmt-rfc-style
      clang-tools
      nodePackages.js-beautify
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }: {
</code></pre>
<p>Plugins with customizations:</p>
<pre><code class="language-nix">  imports = [
    ./fold.nix
    ./conform-nvim.nix
    ./nvim-lspconfig
    ./blink-cmp.nix
    ./vim-mark.nix
    ./nvim-treesitter.nix
    ./nvim-config-local.nix
    ./leap-nvim.nix
    ./telescope-nvim.nix
    ./git-wip.nix
    ./vim-floaterm.nix
    ./outline-nvim.nix
    ./vim-hexokinase.nix
    ./gitsigns-nvim.nix
    ./color-scheme.nix
    ./hbac-nvim.nix
    ./winshift-nvim.nix
    ./smartyank-nvim.nix
    ./mini-nvim.nix
    ./vim-easy-align.nix
    ./codecompanion-nvim.nix
    ./close-windows.nix
    ./nvim-window-picker.nix
    ./vim-matchup.nix
    ./nvim-nav.nix
    ./markdown-preview-nvim.nix
    ./venn-nvim.nix
    ./snacks-nvim.nix
    ./minuet-ai-nvim.nix
    ./auto-session.nix
  ];

  programs.bash.shellAliases.view = "nvim -R";
</code></pre>
<p>Set nvim as manpager.
see nvim <code>:h :Man</code>.
nvim manpage huge mange is SLOW! E.g. man configuration.nix.</p>
<pre><code class="language-nix">  programs.bash.shellAliases.nman = "env MANPAGER='nvim +Man!' man";

  programs.neovim = {
    enable = true;
    viAlias = true;
    vimAlias = true;
    vimdiffAlias = true;

</code></pre>
<p>Plugins without customizations:</p>
<pre><code class="language-nix">    plugins = with pkgs.vimPlugins; [
      vim-fugitive
      vim-nix
      vim-markdown-toc
      vim-commentary
      vim-surround
      otter-nvim
    ];

</code></pre>
<p>Vim config</p>
<pre><code class="language-nix">    extraConfig = /*vim*/ ''
      " vim
      "" Highlight searches
      set hlsearch
      nnoremap &lt;F3&gt; :nohlsearch&lt;CR&gt;
      "" Show line number
      set number
      "" Always show the signcolumn, otherwise it would shift the text each time
      "" diagnostics appear/become resolved
      set signcolumn=number
      "" indent
      """ On pressing tab, insert spaces
      set expandtab
      """ no markdown recommended indent style (recommended shiftwidth=4)
      let g:markdown_recommended_style = 0
      """ line wrap with ident
      set breakindent

      """ mouse support " select by pressing shift key!
      set mouse=a
      "" Preview
      nnoremap &lt;leader&gt;[ :pc&lt;CR&gt;
      "" highlight unwanted whitespace
      set list
      set listchars=tab:&gt;-,trail:-
      "" syntax
      syntax on
      "" backspace
      set backspace=indent,eol,start
      "" wrap line
      """ https://stackoverflow.com/questions/248102/is-there-any-command-to-toggle-enable-auto-text-wrapping
      :function ToggleWrap()
      : if (&amp;wrap == 1)
      :   set nowrap
      : else
      :   set wrap
      : endif
      :endfunction
      nnoremap &lt;F9&gt; :call ToggleWrap()&lt;CR&gt;
      set updatetime=400
      "" highlight current line
      set cursorlineopt=number
      augroup CursorLine
        au!
        au VimEnter,WinEnter,BufWinEnter * setlocal cursorline
        au WinLeave * setlocal nocursorline
      augroup END

      " filetype
      augroup filetype
          " detect LLVM IR file
          au! BufRead,BufNewFile *.ll     set filetype=llvm
          " cpp " from gem5
          au! BufRead,BufNewFile *.hh.inc,*.cc.inc set filetype=cpp
          " d2
          au! BufRead,BufNewFile *.d2 set filetype=d2
          au! FileType d2 setlocal commentstring=#\ %s
      augroup END

      " set terminal title
      "" https://stackoverflow.com/questions/15123477/tmux-tabs-with-name-of-file-open-in-vim
      autocmd BufEnter * let &amp;titlestring = "" . expand("%:t")
      set title

      nnoremap &lt;F10&gt; :echo "hi&lt;" . synIDattr(synID(line("."),col("."),1),"name") . '&gt; trans&lt;'
      \ . synIDattr(synID(line("."),col("."),0),"name") . "&gt; lo&lt;"
      \ . synIDattr(synIDtrans(synID(line("."),col("."),1)),"name") . "&gt;"&lt;CR&gt;

      " highlight
      augroup HiglightTODO
          autocmd!
          autocmd WinEnter,VimEnter * :silent! call matchadd('Todo', 'TODO', -1)
      augroup END

      " TODO: replace wildmenu with blink-cmp cmdline
      " wildmenu
      " see: https://github.com/neovim/neovim/pull/11001
      cnoremap &lt;expr&gt; &lt;Up&gt;    pumvisible() ? "\&lt;Left&gt;"  : "\&lt;Up&gt;"
      cnoremap &lt;expr&gt; &lt;Down&gt;  pumvisible() ? "\&lt;Right&gt;" : "\&lt;Down&gt;"
      cnoremap &lt;expr&gt; &lt;Left&gt;  pumvisible() ? "\&lt;Up&gt;"    : "\&lt;Left&gt;"
      cnoremap &lt;expr&gt; &lt;Right&gt; pumvisible() ? "\&lt;Down&gt;"  : "\&lt;Right&gt;"

      " prevent resizing other windows when splitting/closing a window
      set noequalalways
      nnoremap &lt;C-W&gt;&lt;C-Left&gt;  &lt;C-W&gt;&lt;Left&gt;
      nnoremap &lt;C-W&gt;&lt;C-Right&gt; &lt;C-W&gt;&lt;Right&gt;
      nnoremap &lt;C-W&gt;&lt;C-Up&gt;    &lt;C-W&gt;&lt;Up&gt;
      nnoremap &lt;C-W&gt;&lt;C-Down&gt;  &lt;C-W&gt;&lt;Down&gt;
    '';
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="fold"><a class="header" href="#fold">fold</a></h1>
<pre><code class="language-nix">{ ... }: {
  programs.neovim = {
    extraConfig = ''
      "" Fold
      """ fold text to be the first and last line
      """ refer to sbernheim4's reply at
      """ https://github.com/nvim-treesitter/nvim-treesitter/pull/390
      function! GetSpaces(foldLevel)
          if &amp;expandtab == 1
              " Indenting with spaces
              let str = repeat(" ", a:foldLevel / (&amp;shiftwidth + 1) - 1)
              return str
          elseif &amp;expandtab == 0
              " Indenting with tabs
              return repeat(" ", indent(v:foldstart) - (indent(v:foldstart) / &amp;shiftwidth))
          endif
      endfunction
      function! MyFoldText()
          let startLineText = getline(v:foldstart)
          let endLineText = trim(getline(v:foldend))
          let indentation = GetSpaces(foldlevel("."))
          let spaces = repeat(" ", 200)
          let str = indentation . startLineText . " …… " . endLineText . spaces
          return str
      endfunction
      "" toggle foldmethod between manual and indent
      set foldmethod=indent
      :function ToggleFoldmethod()
      : if (&amp;foldmethod == "manual")
      :   set foldmethod=indent
      : else
      :   set foldmethod=manual
      : endif
      :endfunction
      nnoremap &lt;Leader&gt;z :call ToggleFoldmethod()&lt;CR&gt;:echo &amp;foldmethod&lt;CR&gt;
      "" Custom display for text when folding
      set foldtext=MyFoldText()
      """ Set the foldlevel to a high setting,
      """ files are always loaded with opened folds.
      set foldlevel=20
    '';
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="git-wip-auto-wip-branch"><a class="header" href="#git-wip-auto-wip-branch">git-wip: auto wip branch</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  git-wip = pkgs.vimUtils.buildVimPlugin {
    name = "git-wip";
    src = pkgs.fetchFromGitHub {
      owner = "bartman";
      repo = "git-wip";
      rev = "1c095e93539261370ae811ebf47b8d3fe9166869";
      hash = "sha256-rjvg6sTOuUM3ltD3DuJqgBEDImLrsfdnK52qxCbu8vo=";
    };
    preInstall = "cd vim";
  };
in {
  programs.neovim = {
    plugins = [
      git-wip
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gitsigns-nvim-git-support"><a class="header" href="#gitsigns-nvim-git-support">gitsigns-nvim: git support</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-gitsigns-nvim = {
    plugin = pkgs.vimPlugins.gitsigns-nvim;
    type = "lua";
    config = /*lua*/ ''
      require('gitsigns').setup {
        signs_staged_enable = false,
        signcolumn = false,
        numhl      = true,
        linehl     = true,

        current_line_blame = true,
        current_line_blame_formatter = '🖂 &lt;author&gt; 🖃 &lt;author_time:%R&gt; 🖆 &lt;summary&gt;',

        -- keymaps
        on_attach = function(bufnr)
          local gs = package.loaded.gitsigns

          local function map(mode, l, r, opts)
            opts = opts or {}
            opts.buffer = bufnr
            vim.keymap.set(mode, l, r, opts)
          end

          -- Navigation
          map('n', ']c', function()
            if vim.wo.diff then return ']c' end
            vim.schedule(function() gs.next_hunk() end)
            return '&lt;Ignore&gt;'
          end, {expr=true})

          map('n', '[c', function()
            if vim.wo.diff then return '[c' end
            vim.schedule(function() gs.prev_hunk() end)
            return '&lt;Ignore&gt;'
          end, {expr=true})

          -- Actions
          map({'n', 'v'}, '&lt;leader&gt;hs', ':Gitsigns stage_hunk&lt;CR&gt;')
          map({'n', 'v'}, '&lt;leader&gt;hr', ':Gitsigns reset_hunk&lt;CR&gt;')
          map('n', '&lt;leader&gt;hS', gs.stage_buffer)
          map('n', '&lt;leader&gt;hu', gs.undo_stage_hunk)
          map('n', '&lt;leader&gt;hR', gs.reset_buffer)
          map('n', '&lt;leader&gt;hp', gs.preview_hunk)
          map('n', '&lt;leader&gt;hb', function() gs.blame_line{full=true} end)
          -- map('n', '&lt;leader&gt;tb', gs.toggle_current_line_blame)
          map('n', '&lt;leader&gt;hd', gs.diffthis)
          map('n', '&lt;leader&gt;hD', function() gs.diffthis('~') end)
          -- map('n', '&lt;leader&gt;td', gs.toggle_deleted)

          -- Text object
          map({'o', 'x'}, 'ih', ':&lt;C-U&gt;Gitsigns select_hunk&lt;CR&gt;')
        end
      }
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-gitsigns-nvim
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hbac-nvim-auto-close-buffer"><a class="header" href="#hbac-nvim-auto-close-buffer">hbac-nvim: auto close buffer</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-hbac = {
    plugin = pkgs.vimUtils.buildVimPlugin {
      name = "hbac.nvim";
      src = pkgs.fetchFromGitHub {
        owner = "axkirillov";
        repo = "hbac.nvim";
        rev = "e2e8333aa56ef43a577ac3a2a2e87bdf2f0d4cbb";
        hash = "sha256-7+e+p+0zMHPJjpnKNkL7QQHZJGQ1DFZ6fsofcsVNXaY=";
      };
      doCheck = false;
    };
    type = "lua";
    config = ''
      require("hbac").setup({
        autoclose     = true, -- set autoclose to false if you want to close manually
        threshold     = 10, -- hbac will start closing unedited buffers once that number is reached
        close_command = function(bufnr)
          vim.api.nvim_buf_delete(bufnr, {})
        end,
        close_buffers_with_windows = false, -- hbac will close buffers with associated windows if this option is `true`
        telescope = {
          -- See #telescope-configuration below
          },
      })
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-hbac
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-leap-nvim = {
    plugin = pkgs.vimPlugins.leap-nvim;
    type = "lua";
    config = ''
      require('leap').set_default_mappings()
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-leap-nvim
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim = {
    plugins = [{
      plugin = pkgs.vimPlugins.markdown-preview-nvim.overrideAttrs (old: {
        postPatch = toString [
        # use cjk2ch.js
        (let
          cjk2ch_js = pkgs.fetchurl {
            url = "https://github.com/xieby1/markdown_revealjs/raw/c9c91257d06b63adcf67d3464efbc392f55677ff/share/markdown_revealjs/cjk2ch.js";
            sha256 = "0d2xjy8g89zq8677ggklfpr3f9jd8lny37lbcdqr0asvmiqjgx9x";
          };
        # 添加cjk2ch.js
        # 给混淆过的index.js打补丁（这生成代码居然直接放git，😼😼😼啧啧啧，源码是index.jsx）
        # 通过code:not(:has(span))来识别哪些code可能是ascii art
        # 在refreshContent最后，即renderDot的后面调用cjk2ch(...)
        in ''
          cp ${cjk2ch_js} app/_static/cjk2ch.js
          sed -i 's,&lt;head&gt;,&amp;&lt;script src="/_static/cjk2ch.js"&gt;&lt;/script&gt;,' app/out/index.html
          sed -i 's,}var e;G(),;cjk2ch("code:not(:has(span))");&amp;,' app/out/_next/static/s7O4q0ISzv1r8jtwIkXLb/pages/index.js
        '')
        # set port to 7700~7799
        ''
          sed -i 's/port = port ||.*/port = port || (7700 + Number(`''${Date.now()}`.slice(-2)))/' app/server.js
        ''
        # set line-height of &lt;pre&gt;&lt;/pre&gt;
        ''
          sed -i 's/line-height: 1.45;/line-height: 1em;/' app/_static/markdown.css
        ''
        # upgrade mermaid
        (let
          mermaid_js = pkgs.fetchurl {
            url = "https://cdn.jsdelivr.net/npm/mermaid@11.9.0/dist/mermaid.min.js";
            sha256 = "1658hsyxrg9sh3nmafsisiylsw7z436dznpgv8akhdhp84vx8ghb";
          };
        in ''
          cp ${mermaid_js} app/_static/mermaid.min.js
        '')];
      });
      config = ''
        " allow LAN
        let g:mkdp_open_to_the_world = 1
        let g:mkdp_theme = 'light'

        " Use chromium-like browser to open rendered markdown instead of firefox,
        " because firefox only copy css in selected region, causing lost of styles!
        " See same bug report here:
        " https://discourse.mozilla.org/t/copy-rich-text-from-firefox-does-not-capture-style/97862/3
        function OpenMarkdownPreview (url)
          " run chromium in app mode in background
          execute "silent ! chromium --app='" . a:url . "' &amp;"
        endfunction
        let g:mkdp_browserfunc = 'OpenMarkdownPreview'
      '';
    }];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mini-nvim-a-nvim-distro"><a class="header" href="#mini-nvim-a-nvim-distro">mini-nvim: a nvim distro</a></h1>
<p>mini-nvim is wonderful nvim plugin!
I found it due to below link:
indent-blankline.nvim is too complex.
However, it does not support basic functionality like highlight current indentation
See: https://github.com/lukas-reineke/indent-blankline.nvim/issues/649</p>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-mini-nvim = {
    plugin = pkgs.vimPlugins.mini-nvim;
    type = "lua";
    config = ''
      require('mini.indentscope').setup{
        options = {
          try_as_border = true,
        },
      }

      -- mini.animate looks promising, and can totally replace vim-smoothie
      -- However, bugs seem exist:
      -- * touchpad scroll become slow
      -- * background color blinks when create window
      -- * background color broken after q::q
      -- require('mini.animate').setup()

      require('mini.icons').setup()
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-mini-nvim
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, lib, ... }: let
  api_key_file = "${config.home.homeDirectory}/Gist/Vault/siliconflow_api_key_chatbox.txt";
in { config = lib.mkIf (builtins.pathExists api_key_file) {
  # mkAfter makes sure statusline setting is after nvim-nav.nix
  programs.neovim.plugins = lib.mkAfter [pkgs.vimPlugins.plenary-nvim {
    plugin = pkgs.vimPlugins.minuet-ai-nvim;
    type = "lua";
    config = /*lua*/ ''
      require('minuet').setup {
        blink = { enable_auto_complete = false },
        provider = 'openai_fim_compatible',
        provider_options = {
          openai_fim_compatible = {
            name = 'Qwen',
            end_point = 'https://api.siliconflow.cn/v1/completions',
            api_key = function() return '${lib.fileContents api_key_file}' end,
            model = "Qwen/Qwen3-Coder-30B-A3B-Instruct",
            optional = {
              max_tokens = 256,
              top_p = 0.9,
            },
          },
          --[[
            Enable ollama:
            * ollama serve
            * ollama pull qwen2.5-coder:0.5b
            * or other model support completion and insert capabilities
              (I dont why need insert, and the ollama docs and minuet-ai-nvim docs don't explain about this)
          ]]
          -- openai_fim_compatible = {
          --   model = "qwen2.5-coder:0.5b",
          --   end_point = "localhost:11434/v1/completions",
          --   name = "Qwen2.5",
          --   stream = true,
          --   api_key = 'TERM',
          --   optional = {
          --     max_tokens = 5,
          --   },
          -- },
        },
        --context_window = 512,
      }

      -- function update_minuet_statusline()
      --   local minuet = require("minuet")
      --   vim.o.statusline = string.gsub(vim.o.statusline, "[ᯤ]*$",
      --     minuet.config.blink.enable_auto_complete and "ᯤ" or "")
      -- end
      -- vim.keymap.set({'n','i'}, '&lt;A-a&gt;', function()
      --   local minuet = require("minuet")
      --   minuet.config.blink.enable_auto_complete = not minuet.config.blink.enable_auto_complete
      --   update_minuet_statusline()
      -- end)
      -- update_minuet_statusline()
    '';
  }];
};}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nvim-config-local-secure-load-local-vim-config"><a class="header" href="#nvim-config-local-secure-load-local-vim-config">nvim-config-local: secure load local vim config</a></h1>
<pre><code class="language-nix">{ pkgs, ... }:
let
  my-nvim-config-local = {
    plugin = pkgs.vimPlugins.nvim-config-local;
    type = "lua";
    config = ''
      require('config-local').setup {
        config_files = { ".nvim.lua", ".nvimrc", ".exrc", ".vimrc" },
        lookup_parents = true,
        silent = true,
      }
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-nvim-config-local
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="lspconfig-for-cc-language"><a class="header" href="#lspconfig-for-cc-language">lspconfig for C/C++ language</a></h1>
<pre><code class="language-nix">{ pkgs, ...}: {
  programs.neovim = {
</code></pre>
<h2 id="cc"><a class="header" href="#cc">C/C++</a></h2>
<h3 id="why-use-clangd-instead-of-ccls"><a class="header" href="#why-use-clangd-instead-of-ccls">Why use clangd instead of ccls?</a></h3>
<p>I encountered the problem below,
when view https://github.com/xieby1/openc910 smart_run/logical/tb/sim_main1.cpp</p>
<pre><code>LSP[ccls]: Error NO_RESULT_CALLBACK_FOUND: {
  error = {
    code = -32603,
    message = "failed to index /home/xieby1/Codes/openc910/smart_run/work/fputc.c"
  },
  id = 1,
  jsonrpc = "2.0"
}
</code></pre>
<p>After some searching, I found</p>
<p><a href="https://github.com/neovim/neovim/issues/15844">GitHub: neovim: issue: lsp: NO_RESULT_CALLBACK_FOUND with ccls, rust-analyzer #15844</a></p>
<p>sapphire-arches found:</p>
<blockquote>
<p>Something is causing the r-a LSP to send two replies with the same ID, see the attached log:
lsp_debug.log</p>
<p>It would be nice for the neovim LSP to handle this more gracefully (not filling my screen with garbage and taking focus), but I do think the bug is in R-A here? The problem seems to be related to editor.action.triggerParameterHints?</p>
</blockquote>
<p><a href="https://github.com/MaskRay/ccls/issues/836">GitHub: ccls: issue: I'm very confused about this question, it's about ccls or neovim built in LSP? #836</a></p>
<p>No one try to fix the two-replies problem in ccls.
However, nimaipatel recommanded <a href="https://github.com/p00f/clangd_extensions.nvim">clangd_extensions</a>.</p>
<pre><code class="language-nix">    extraLuaConfig = ''
      vim.lsp.config('clangd', {
        filetypes = { "c", "cc", "cpp", "c++", "objc", "objcpp", "cuda", "proto" }
      })
      vim.lsp.enable("clangd")
      require("clangd_extensions.inlay_hints").setup_autocmd()
      require("clangd_extensions.inlay_hints").set_inlay_hints()
    '';
    plugins = [
      pkgs.vimPlugins.clangd_extensions-nvim
    ];
    extraPackages = with pkgs; [
      clang-tools
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nvim-lspconfig"><a class="header" href="#nvim-lspconfig">nvim-lspconfig</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  imports = [
    ./c.nix
    # bash
    {programs.neovim={extraLuaConfig="vim.lsp.enable('bashls')\n";extraPackages=[pkgs.bash-language-server];};}
    # html
    {programs.neovim={extraLuaConfig="vim.lsp.enable('html')\n";extraPackages=[pkgs.vscode-langservers-extracted];};}
    # lua
    {programs.neovim={extraLuaConfig="vim.lsp.enable('lua_ls')\n";extraPackages=[pkgs.lua-language-server];};}
    # nix
    {programs.neovim={extraLuaConfig="vim.lsp.enable('nixd')\n";extraPackages=[pkgs.nixd];};}
    # python
    {programs.neovim={extraLuaConfig="vim.lsp.enable('pyright')\n";extraPackages=[pkgs.pyright];};}
    # typos
    {programs.neovim={extraLuaConfig="vim.lsp.enable('typos_lsp')\n";extraPackages=[pkgs.typos-lsp];};}
    # xml
    {programs.neovim={extraLuaConfig="vim.lsp.enable('lemminx')\n";extraPackages=[pkgs.lemminx];};}
    # markdown
    {programs.neovim={extraLuaConfig="vim.lsp.enable('marksman')\n";extraPackages=[pkgs.marksman];};}
    # language checker
    {programs.neovim={extraLuaConfig="vim.lsp.enable('harper_ls')\n";extraPackages=[pkgs.harper];};}
    ./rust.nix
    ./scala.nix
  ];
  programs.neovim = {
    plugins = [{
      plugin = pkgs.vimPlugins.nvim-lspconfig;
      type = "lua";
</code></pre>
<h2 id="global-mappings"><a class="header" href="#global-mappings">Global mappings.</a></h2>
<pre><code class="language-nix">      config = /*lua*/ ''
        -- See `:help vim.diagnostic.*` for documentation on any of the below functions
        vim.keymap.set('n', '&lt;space&gt;e', vim.diagnostic.open_float)
        vim.keymap.set('n', '[d', vim.diagnostic.goto_prev)
        vim.keymap.set('n', ']d', vim.diagnostic.goto_next)
        vim.keymap.set('n', '&lt;space&gt;q', vim.diagnostic.setloclist)

        -- Use LspAttach autocommand to only map the following keys
        -- after the language server attaches to the current buffer
        vim.api.nvim_create_autocmd('LspAttach', {
          group = vim.api.nvim_create_augroup('UserLspConfig', {}),
          callback = function(ev)
            local opts = { buffer = ev.buf }
            local builtin = require("telescope.builtin")
            vim.keymap.set('n', 'gd', builtin.lsp_definitions, opts)
            vim.keymap.set('n', 'gD', vim.lsp.buf.declaration, opts)
            vim.keymap.set('n', 'gt', builtin.lsp_type_definitions, opts)
            vim.keymap.set('n', 'gr', builtin.lsp_references, opts)
            vim.keymap.set('n', 'gi', builtin.lsp_implementations, opts)
            vim.keymap.set('n', 'K', vim.lsp.buf.hover, opts)
            vim.keymap.set('n', '&lt;space&gt;rn', vim.lsp.buf.rename, opts)

            -- make sure lsp/vim native indent(share/nvim/runtime/indent/python.vim)
            -- don't override my setting
            vim.opt.tabstop = 2
            vim.opt.shiftwidth = 2
          end,
        })
      '';
    }];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim={
    extraLuaConfig = /*lua*/ ''
      vim.lsp.config("rust_analyzer", {
        settings = {
          ["rust-analyzer"] = {
            cargo = {
              -- goto definition of rust's lib needs this
              sysrootSrc = "${pkgs.rustPlatform.rustLibSrc}",
            },
          }
        },
      })
      vim.lsp.enable("rust_analyzer")
    '';
    extraPackages = [ pkgs.rust-analyzer ];
  };
  home.packages = [ pkgs.cargo ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># If metals throw errors, check &lt;workspace&gt;/.metals/metals.log
# Try following steps:
# * rm -rf .metals/ ~/.bloop/* ~/.cache/mill/ ~/.cache/coursier/
# * check all dependent libs have been downloaded to workspace, e.g. update git submodule
{ config, pkgs, ... }: let
  jre-with-proxy = let
    java-with-proxy = pkgs.writeShellScript "java" ''
      ${pkgs.jre}/bin/java \
        -Dhttp.proxyHost=127.0.0.1 \
        -Dhttp.proxyPort=${toString config.proxyPort} \
        -Dhttps.proxyHost=127.0.0.1 \
        -Dhttps.proxyPort=${toString config.proxyPort} \
        "$@"
    '';
  in pkgs.runCommand "jre_with_proxy" {} ''
    mkdir -p $out
    ${pkgs.xorg.lndir}/bin/lndir -silent ${pkgs.jre} $out
    rm $out/bin/java
    ln -s ${java-with-proxy} $out/bin/java
  '';
in {
  programs.neovim = {
    extraLuaConfig = /*lua*/ ''
      vim.lsp.enable("metals")
    '';
    extraPackages = [
      ((pkgs.metals.override {
        jre=jre-with-proxy;
      }).overrideAttrs (old: {
        extraJavaOpts = toString [
          old.extraJavaOpts
          /*
            User configuration options can optionally be provided via server properties using the -Dmetals. prefix.
            For more user configuration, see: https://scalameta.org/metals/docs/integrations/new-editor/#metals-user-configuration
          */
          # [Note1]: use mill in system, preventing the situation where I can compile but I cannot use metals
          "-Dmetals.millScript=mill"

          # If mill command (specified by millScript) is not found,
          # then metals will use java to run mill.contrib.bloop.Bloop/install
          "-Dmetals.javaHome=${jre-with-proxy}"
        ];
      }))
      (pkgs.coursier.override { jre = jre-with-proxy; })
    ];
    # extraWrapperArgs = [
    #   "--set-default" "JAVA_HOME" "${jre-with-proxy}"
    # ];
  };
  # [Paired with above Note1]:
  # If system does not have mill, then metals will use a 0.5.0 mill script to run:
  # Optional absolute path to a mill executable to use for running
  # `mill mill.contrib.bloop.Bloop/install`.
  # This mill needs JAVA_HOME.
  programs.bash.bashrcExtra = /*bash*/''
    # make .metals/mill happy.
    export JAVA_HOME=${jre-with-proxy};
  '';

  # nvim-metals proxy for bloop
  home.file.jvmopts = {
    text = ''
      -Dhttps.proxyHost=127.0.0.1
      -Dhttps.proxyPort=${toString config.proxyPort}
      -Dhttp.proxyHost=127.0.0.1
      -Dhttp.proxyPort=${toString config.proxyPort}
    '';
    target = ".bloop/.jvmopts";
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim = {
    plugins = [{
      plugin = pkgs.vimPlugins.nvim-navic;
      type = "lua";
      config = ''
        require("nvim-navic").setup {
          lsp = {
            auto_attach = true,
          },
        }
        -- https://unix.stackexchange.com/questions/224771/what-is-the-format-of-the-default-statusline
        -- %&lt;%f %h%w%m%r%=%-14.(%l,%c%V%) %P
        vim.o.statusline = "%&lt;%f %h%w%m%r┇" ..
          -- set maximum width of nvim-navic str: winwidth-40
          -- exec %{%...%} results in '%.xx(yyyy%)', where xx is the max width, yyyy is the navic str
          "%{%'%.' .. (winwidth(0)-40) .. '(' .. v:lua.require'nvim-navic'.get_location() .. '%)'%}" ..
          "%=┇%-8.(%l,%c%) %P"
      '';
    }{
      plugin = pkgs.vimPlugins.nvim-navbuddy;
      type = "lua";
      config = ''
        require("nvim-navbuddy").setup {
          lsp = {
            auto_attach = true,
          },
          mappings = {
            ["&lt;S-Tab&gt;"] = require("nvim-navbuddy.actions").parent(),
            ["&lt;Tab&gt;"]   = require("nvim-navbuddy.actions").children(),
          },
        }
      '';
    }];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nvim-treesitter-languages-parsing"><a class="header" href="#nvim-treesitter-languages-parsing">nvim-treesitter: languages parsing</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim = {
    plugins = [{
      # Available languages see:
      #   https://github.com/nvim-treesitter/nvim-treesitter
      # see `pkgs.tree-sitter.builtGrammars.`
      # with `tree-sitter-` prefix and `-grammar` suffix removed
      plugin = pkgs.vimPlugins.nvim-treesitter.withPlugins (_:
      pkgs.vimPlugins.nvim-treesitter.allGrammars ++ [
</code></pre>
<p>When edit a large d2 file using d2-vim, the cursor movement becomes lag.
However, tree-sitter-d2 works fluently.
So I replace the d2-vim with tree-sitter-d2.</p>
<pre><code class="language-nix">        (pkgs.tree-sitter.buildGrammar rec {
          language = "d2";
          # tree-sitter language version 14
          version = "0.5.1";
          src = pkgs.fetchFromGitHub {
            owner = "ravsii";
            repo = "tree-sitter-d2";
            rev = "v${version}";
            hash = "sha256-Ru+EAtnBl+Td4HxHPXLwcXOiFB/NbYPE5AhMNFyP2Kg=";
          };
        })
      ]);
      type = "lua";
      config = /*lua*/''
        require 'nvim-treesitter.configs'.setup {
          -- TODO: https://github.com/NixOS/nixpkgs/issues/189838
          -- ensure_installed = {"c", "cpp", "python", "markdown"},
          ensure_installed = {},
          sync_install = false,
          highlight = {
            enable = true,
          },
        }
      '';
    }];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nvim-window-picker"><a class="header" href="#nvim-window-picker">nvim-window-picker</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim = {
    plugins = [{
      plugin = pkgs.vimPlugins.nvim-window-picker;
      type = "lua";
      config = ''
        require 'window-picker'.setup({
          selection_chars = 'abcdefghijklmnopqrstuvwxyz',
          picker_config = {
            statusline_winbar_picker = {
              selection_display = function(char, windowid)
                return '[' .. char .. ']' .. vim.o.statusline
              end,
            },
          },
          show_prompt = false,
          highlights = {
            statusline = {
              unfocused = {
                fg = '#2c2e34',
                bg = '#7f8490',
                bold = true,
              },
            },
          },
        })
        vim.keymap.set('n', '&lt;C-j&gt;', function()
          vim.api.nvim_set_current_win( require('window-picker').pick_window() )
        end)
        vim.keymap.set('n', '&lt;C-w&gt;j', function()
          vim.api.nvim_set_current_win( require('window-picker').pick_window() )
        end)
      '';
    }];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim = {
    plugins = [{
      plugin = pkgs.vimPlugins.outline-nvim;
      type = "lua";
      config = /*lua*/ ''
        require("outline").setup({
          -- Outline.nvim seems not support setup multiple times
          -- So I merge outline-treesitter-provider's config here
          providers = {
            -- append "treesitter" to original priority
            priority = (function() -- start of a local scope
              local original = require("outline.config").defaults.providers.priority
              table.insert(original, "treesitter")
              return original
            end)(), -- end of a local scope
          },
          outline_window = {
            relative_width = false,
          },
          guides = {
            enabled = false, -- I already have mini indentscope
          },
          symbol_folding = {
            autofold_depth = 99,
          },
          keymaps = {
            close = {}, -- disable close key
          },
        })
      '';
    }(
      pkgs.vimUtils.buildVimPlugin {
        name = "outline-treesitter-provider.nvim";
        src = pkgs.fetchFromGitHub {
          owner = "epheien";
          repo = "outline-treesitter-provider.nvim";
          rev = "22dda7329cf608368cbf725effd43daf98c27f32";
          hash = "sha256-PFRiaQPxh+PPFGF1+yMIJIM/tGDOH7CO0xyoayDn78I=";
        };
        doCheck = false;
      }
    )];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="avante-nvim-ai"><a class="header" href="#avante-nvim-ai">avante-nvim: AI</a></h1>
<p>2025.1.27：使用中发现的问题：</p>
<ul>
<li>没有:h</li>
<li>说了要去掉nui但仍然没有https://news.ycombinator.com/item?id=41353835</li>
<li>安装了dressing、nui、plenary（telescope都没问题）插件仍然不识别
<pre><code class="language-vim">avante: require("avante.health").check()

avante.nvim ~
- ERROR Missing required plugin: stevearc/dressing.nvim
- ERROR Missing required plugin: MunifTanjim/nui.nvim
- ERROR Missing required plugin: nvim-lua/plenary.nvim
- OK Found required plugin: nvim-treesitter/nvim-treesitter
- OK Found icons plugin (nvim-web-devicons or mini.icons)
</code></pre>
简单看了代码avante checkhealth：lua/avante/utils/init.lua
居然要使用lazy。按claude.ai的说法
“啊,这是实际的源码实现,比我之前解释的要简单很多。让我详细解释一下这个函数:”
是不是就是因为简单，但是又没有强制要求安装lazy，遇到的问题？</li>
</ul>
<pre><code class="language-nix">{ lib, pkgs, ... }:
{
  programs.neovim = {
    plugins = with pkgs.pkgsu.vimPlugins; (lib.mkAfter [
      nui-nvim
      dressing-nvim
      {
        plugin = avante-nvim;
        type = "lua";
        config = ''
          require('avante_lib').load()
          require('avante').setup ({
            provider = "deepseek",
            vendors = {
              deepseek = {
                __inherited_from = "openai",
                api_key_name = "DEEPSEEK_API_KEY",
                endpoint = "https://api.deepseek.com",
                model = "deepseek-chat",
              },
            },
          })
        '';
      }
    ]);
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="distant-nvim-edit-remote-files-with-local-nvim"><a class="header" href="#distant-nvim-edit-remote-files-with-local-nvim">distant-nvim: edit remote files with local nvim</a></h1>
<p>不足:</p>
<ul>
<li>文档不在源码里，没有:h</li>
<li>文档写的很不清晰，找了半天才知道:DistantConnect和:DistantOpen</li>
<li>现有nvim文件操作似乎都不能用，比如:Ex比如<leader>ff等，都需要用它的:DistantOpen</li>
<li>简单尝试了xiangshan项目的跳转，没办法正常使用。但是sshfs一切正常</li>
</ul>
<pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim = {
    plugins = [{
      plugin = pkgs.pkgsu.vimPlugins.distant-nvim;
      type = "lua";
      config = ''
        require('distant'):setup()
      '';
    }];
    extraPackages = [
      pkgs.pkgsu.distant
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deprecated-remote-sshfsnvim-integrate-sshfs-into-nvim"><a class="header" href="#deprecated-remote-sshfsnvim-integrate-sshfs-into-nvim">Deprecated: remote-sshfs.nvim: integrate sshfs into nvim</a></h1>
<p>Reason of Deprecation: It is better to use sshfs CLI!</p>
<p>In my opinion, sshfs provides a better experience than distant.nvim</p>
<pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim = {
    plugins = [{
      plugin = pkgs.vimUtils.buildVimPlugin {
        pname = "remote-sshfs.nvim";
        version = "2025-2-10";
        src = pkgs.fetchFromGitHub {
          owner = "NOSDuco";
          repo = "remote-sshfs.nvim";
          rev = "03f6c40c4032eeb1ab91368e06db9c3f3a97a75d";
          hash = "sha256-vFEIISxhTIGSl9LzDYHuEIkjLGkU0y5XhfWI/i5DgN4=";
        };
      };
      type = "lua";
      config = ''
        require('telescope').load_extension 'remote-sshfs'
        require('remote-sshfs').setup{
          connections = {
            ssh_configs = {
              vim.fn.expand "$HOME" .. "/.ssh/config",
              vim.fn.expand "$HOME" .. "/Gist/Config/ssh.conf",
              "/etc/ssh/ssh_config",
            },
          },
        }
      '';
    }];
    extraPackages = [
      pkgs.sshfs
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="smartyank-nvim-smart-yank-to-clipboard"><a class="header" href="#smartyank-nvim-smart-yank-to-clipboard">smartyank-nvim: smart yank to clipboard</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-smartyank-nvim = {
    plugin = pkgs.vimPlugins.smartyank-nvim;
    type = "lua";
    config = ''
      require('smartyank').setup {
        highlight = {
          enabled = false, -- not enable highlight yanked text
        },
        validate_yank = function() return vim.v.operator == '"+y' end,
      }
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-smartyank-nvim
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># image-nvim vs snacks-nvim问题
# * image-nvim
#   * svg会变成png，非常不清晰，也没人提问题
#   * （幻灯片里）图片多了非常卡，会显示不出来
#   * 排版有问题，总有错位，issues说解决了，我这里用的最新版，仍然部分有问题
#   * 结论，不如用MarkdownPreview或snacks-nvim/image
{ pkgs, ... }: {
  programs.neovim = {
    plugins = [{
      plugin = pkgs.vimPlugins.snacks-nvim;
      type = "lua";
      config = /*lua*/ ''
        require("snacks").setup({
          image = {
            enabled = true,
            convert = {
              ---@type table&lt;string,snacks.image.args&gt;
              magick = (function() -- start of a local scope
                original = {
                  default = { "{src}[0]", "-scale", "1920x1080&gt;" }, -- default for raster images
                  vector = { "-density", 192, "{src}[0]" }, -- used by vector images like svg
                  -- math = { "-density", 192, "{src}[0]", "-trim" },
                  pdf = { "-density", 192, "{src}[0]", "-background", "white", "-alpha", "remove", "-trim" },
                }
                -- if vim background is dark then negate the image color
                for _, opts in pairs(original) do
                  if vim.o.background == "dark" then
                    table.insert(opts, "-channel")
                    table.insert(opts, "RGB")
                    table.insert(opts, "-negate")
                  end
                end
                return original
              end)(), -- end of a local scope
            },
          },
          scroll = {
            enabled = true,
          },
        })
      '';
    }];
    extraPackages = [
      # for drawing math.tex as images
      (pkgs.texlive.combine {
        inherit (pkgs.texlive)
        scheme-basic
        standalone
        varwidth
        preview
        mathtools
        xcolor
      ;})
      pkgs.ghostscript
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="telescope-nvim"><a class="header" href="#telescope-nvim">telescope-nvim</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-telescope-nvim = {
    plugin = pkgs.vimPlugins.telescope-nvim;
    config = ''
      " search relative to file
      "" https://github.com/nvim-telescope/telescope.nvim/pull/902
      nnoremap ff &lt;cmd&gt;lua require('telescope.builtin').find_files({cwd=require'telescope.utils'.buffer_dir()})&lt;cr&gt;
      nnoremap fF &lt;cmd&gt;lua require('telescope.builtin').find_files()&lt;cr&gt;
      nnoremap fb &lt;cmd&gt;lua require('telescope.builtin').buffers()&lt;cr&gt;
      nnoremap fh &lt;cmd&gt;lua require('telescope.builtin').help_tags()&lt;cr&gt;
      nnoremap ft &lt;cmd&gt;lua require('telescope.builtin').treesitter()&lt;cr&gt;
      nnoremap fc &lt;cmd&gt;lua require('telescope.builtin').command_history()&lt;cr&gt;
      nnoremap fC &lt;cmd&gt;lua require('telescope.builtin').commands()&lt;cr&gt;
    '';
  };
  # Problem: unable to fuzzy search parenthesis '('
  # https://github.com/nvim-telescope/telescope-fzf-native.nvim/issues/141
  my-telescope-fzf-native-nvim = {
    plugin = pkgs.vimPlugins.telescope-fzf-native-nvim;
    type = "lua";
    config = ''
      require('telescope').setup {
        extensions = {fzf = {}},
        defaults = {
          layout_strategy = 'vertical',
          layout_config = {
            height = 0.95,
            width = 0.95,
            -- do not disable preview
            preview_cutoff = 1,
          },
        },
      }
      require('telescope').load_extension('fzf')
    '';
  };
  my-telescope-live-grep-args-nvim = {
    plugin = pkgs.vimPlugins.telescope-live-grep-args-nvim;
    type = "lua";
    config = ''
      require('telescope').load_extension("live_grep_args")

      -- nnoremap fg &lt;cmd&gt;lua require('telescope.builtin').live_grep({cwd=require'telescope.utils'.buffer_dir()})&lt;cr&gt;
      vim.keymap.set('n', 'fg', '&lt;cmd&gt;lua require("telescope").extensions.live_grep_args.live_grep_args({search_dirs={require"telescope.utils".buffer_dir()}})&lt;cr&gt;')
      -- nnoremap fG &lt;cmd&gt;lua require('telescope.builtin').live_grep()&lt;cr&gt;
      vim.keymap.set('n', 'fG', '&lt;cmd&gt;lua require("telescope").extensions.live_grep_args.live_grep_args()&lt;cr&gt;')
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-telescope-nvim
      my-telescope-fzf-native-nvim
      pkgs.vimPlugins.plenary-nvim
      my-telescope-live-grep-args-nvim
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># DrawIt vs venn-nvim
# * DrawIt is slow when moving cursor adding spaces
{ pkgs, ... }: {
  programs.neovim = {
    plugins = [(
      pkgs.vimPlugins.venn-nvim.overrideAttrs (old: {
        # ▲ ▼ ◀ ▶
        postPatch = ''
          sed -i 's/►/▶/' lua/venn/init.lua
          sed -i 's/◄/◀/' lua/venn/init.lua
          sed -i 's/►/▶/' src/primitives/box.lua.t
          sed -i 's/◄/◀/' src/primitives/box.lua.t
        '';
      })
    )];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vim-easy-align-a-simple-easy-to-use-vim-alignment-plugin"><a class="header" href="#vim-easy-align-a-simple-easy-to-use-vim-alignment-plugin">vim-easy-align: A simple, easy-to-use Vim alignment plugin.</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-vim-easy-align = {
    plugin = pkgs.vimPlugins.vim-easy-align;
    config = ''
      " Start interactive EasyAlign in visual mode (e.g. vipga)
      xmap ga &lt;Plug&gt;(EasyAlign)

      " Start interactive EasyAlign for a motion/text object (e.g. gaip)
      nmap ga &lt;Plug&gt;(EasyAlign)

      let g:easy_align_delimiters = {
      \ '&gt;': { 'pattern': '&gt;&gt;\|=&gt;\|&gt;' },
      \ '/': {
      \     'pattern':         '//\+\|/\*\|\*/',
      \     'delimiter_align': 'l',
      \     'ignore_groups':   ['!Comment'] },
      \ ']': {
      \     'pattern':       '[\]]',
      \     'left_margin':   0,
      \     'right_margin':  0,
      \     'stick_to_left': 0
      \   },
      \ '[': {
      \     'pattern':       '[\[]',
      \     'left_margin':   0,
      \     'right_margin':  0,
      \     'stick_to_left': 0
      \   },
      \ ')': {
      \     'pattern':       '[)]',
      \     'left_margin':   0,
      \     'right_margin':  0,
      \     'stick_to_left': 0
      \   },
      \ '(': {
      \     'pattern':       '[(]',
      \     'left_margin':   0,
      \     'right_margin':  0,
      \     'stick_to_left': 0
      \   },
      \ }

      let g:easy_align_ignore_groups = [] " default: ['Comment', 'String']
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-vim-easy-align
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vim-floaterm-floating-terminal"><a class="header" href="#vim-floaterm-floating-terminal">vim-floaterm: floating terminal</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim.plugins = [{
    plugin = pkgs.vimPlugins.vim-floaterm;
    config = /*vim*/ ''
      nmap &lt;Leader&gt;t :FloatermNew --cwd=&lt;buffer&gt;&lt;CR&gt;
      nmap &lt;Leader&gt;T :FloatermNew&lt;CR&gt;
      " let g:floaterm_keymap_new = '&lt;Leader&gt;t'
      let g:floaterm_width = 0.8
      let g:floaterm_height = 0.8
    '';
  }];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vim-hexokinase-display-colors"><a class="header" href="#vim-hexokinase-display-colors">vim-hexokinase: display colors</a></h1>
<h2 id="highlight-color-code"><a class="header" href="#highlight-color-code">highlight color code</a></h2>
<p>TLDR: vim-hexokinase isn't perfect but works.
It need works in <code>termguicolors</code> mode.
It is better to choose a color scheme which is visualized in gui mode.
And it is very tricky to setting colors in <code>termguicolors</code> &amp; <code>notermguicolors</code> the same, which is insane.</p>
<p>It would be convenient, if color code can be visualised in editor, especially in web programming.
I found two candidates plugins to achieve this goal,
<a href="https://github.com/ap/vim-css-color">vim-css-color</a>,
<a href="https://github.com/RRethy/vim-hexokinase">vim-hexokinase</a>.</p>
<p>Vim-css-color is not compatible with tree-sitter, due to regex based highlight.
See <a href="https://github.com/ap/vim-css-color/issues/164">Github Issue: Neovim tree sitter support</a> for details.
Vim-css-color sometimes cannot render same text color.
I need to scroll my vim viewport, then it <strong>may</strong> render color correctly.</p>
<p>Vim-hexokinase is good, but must depends on <code>termguicolors</code> is turned on.
<code>termguicolors</code> will enable 24-bit RGB color,
while originally vim uses Base16 color.
The result is the color theme you familiar with will be changed.</p>
<p>Here is the visual comparison between vim-css-color and vim-hexokinase.
I copy these text as html from my vim.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">vcc</th><th style="text-align: center">vcc tgc</th><th style="text-align: center">vh tgc</th></tr></thead><tbody>
<tr><td style="text-align: center"><span style="background-color:#FF0000"><font color="#EEEEEC">#ff0000</font></span></td><td style="text-align: center"><span style="background-color:#FF0000"><font color="#FFFFFF">#ff0000</font></span></td><td style="text-align: center"><span style="background-color:#FF0000"><font color="#FFFFFF">#ff0000</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF0000"><font color="#EEEEEC">#ff1111</font></span></td><td style="text-align: center"><span style="background-color:#FF1111"><font color="#FFFFFF">#ff1111</font></span></td><td style="text-align: center"><span style="background-color:#FF1111"><font color="#FFFFFF">#ff1111</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF0000"><font color="#EEEEEC">#ff2222</font></span></td><td style="text-align: center"><span style="background-color:#FF2222"><font color="#FFFFFF">#ff2222</font></span></td><td style="text-align: center"><span style="background-color:#FF2222"><font color="#FFFFFF">#ff2222</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF0000"><font color="#EEEEEC">#ff3333</font></span></td><td style="text-align: center"><span style="background-color:#FF3333"><font color="#FFFFFF">#ff3333</font></span></td><td style="text-align: center"><span style="background-color:#FF3333"><font color="#FFFFFF">#ff3333</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF5F5F"><font color="#2E3436">#ff4444</font></span></td><td style="text-align: center"><span style="background-color:#FF4444"><font color="#000000">#ff4444</font></span></td><td style="text-align: center"><span style="background-color:#FF4444"><font color="#FFFFFF">#ff4444</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF5F5F"><font color="#2E3436">#ff5555</font></span></td><td style="text-align: center"><span style="background-color:#FF5555"><font color="#000000">#ff5555</font></span></td><td style="text-align: center"><span style="background-color:#FF5555"><font color="#FFFFFF">#ff5555</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF5F5F"><font color="#2E3436">#ff6666</font></span></td><td style="text-align: center"><span style="background-color:#FF6666"><font color="#000000">#ff6666</font></span></td><td style="text-align: center"><span style="background-color:#FF6666"><font color="#FFFFFF">#ff6666</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF8787"><font color="#2E3436">#ff7777</font></span></td><td style="text-align: center"><span style="background-color:#FF7777"><font color="#000000">#ff7777</font></span></td><td style="text-align: center"><span style="background-color:#FF7777"><font color="#FFFFFF">#ff7777</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF8787"><font color="#2E3436">#ff8888</font></span></td><td style="text-align: center"><span style="background-color:#FF8888"><font color="#000000">#ff8888</font></span></td><td style="text-align: center"><span style="background-color:#FF8888"><font color="#FFFFFF">#ff8888</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF8787"><font color="#2E3436">#ff9999</font></span></td><td style="text-align: center"><span style="background-color:#FF9999"><font color="#000000">#ff9999</font></span></td><td style="text-align: center"><span style="background-color:#FF9999"><font color="#FFFFFF">#ff9999</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FFAFAF"><font color="#2E3436">#ffaaaa</font></span></td><td style="text-align: center"><span style="background-color:#FFAAAA"><font color="#000000">#ffaaaa</font></span></td><td style="text-align: center"><span style="background-color:#FFAAAA"><font color="#000000">#ffaaaa</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FFAFAF"><font color="#2E3436">#ffbbbb</font></span></td><td style="text-align: center"><span style="background-color:#FFBBBB"><font color="#000000">#ffbbbb</font></span></td><td style="text-align: center"><span style="background-color:#FFBBBB"><font color="#000000">#ffbbbb</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FFD7D7"><font color="#2E3436">#ffcccc</font></span></td><td style="text-align: center"><span style="background-color:#FFCCCC"><font color="#000000">#ffcccc</font></span></td><td style="text-align: center"><span style="background-color:#FFCCCC"><font color="#000000">#ffcccc</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FFD7D7"><font color="#2E3436">#ffdddd</font></span></td><td style="text-align: center"><span style="background-color:#FFDDDD"><font color="#000000">#ffdddd</font></span></td><td style="text-align: center"><span style="background-color:#FFDDDD"><font color="#000000">#ffdddd</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#EEEEEE"><font color="#2E3436">#ffeeee</font></span></td><td style="text-align: center"><span style="background-color:#FFEEEE"><font color="#000000">#ffeeee</font></span></td><td style="text-align: center"><span style="background-color:#FFEEEE"><font color="#000000">#ffeeee</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FFFFFF"><font color="#2E3436">#ffffff</font></span></td><td style="text-align: center"><span style="background-color:#FFFFFF"><font color="#000000">#ffffff</font></span></td><td style="text-align: center"><span style="background-color:#FFFFFF"><font color="#000000">#ffffff</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#000000"><font color="#EEEEEC">#000000</font></span></td><td style="text-align: center"><span style="background-color:#000000"><font color="#FFFFFF">#000000</font></span></td><td style="text-align: center"><span style="background-color:#000000"><font color="#FFFFFF">#000000</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#121212"><font color="#EEEEEC">#111111</font></span></td><td style="text-align: center"><span style="background-color:#111111"><font color="#FFFFFF">#111111</font></span></td><td style="text-align: center"><span style="background-color:#111111"><font color="#FFFFFF">#111111</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#262626"><font color="#EEEEEC">#222222</font></span></td><td style="text-align: center"><span style="background-color:#222222"><font color="#FFFFFF">#222222</font></span></td><td style="text-align: center"><span style="background-color:#222222"><font color="#FFFFFF">#222222</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#303030"><font color="#EEEEEC">#333333</font></span></td><td style="text-align: center"><span style="background-color:#333333"><font color="#FFFFFF">#333333</font></span></td><td style="text-align: center"><span style="background-color:#333333"><font color="#FFFFFF">#333333</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#444444"><font color="#EEEEEC">#444444</font></span></td><td style="text-align: center"><span style="background-color:#444444"><font color="#FFFFFF">#444444</font></span></td><td style="text-align: center"><span style="background-color:#444444"><font color="#FFFFFF">#444444</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#585858"><font color="#EEEEEC">#555555</font></span></td><td style="text-align: center"><span style="background-color:#555555"><font color="#FFFFFF">#555555</font></span></td><td style="text-align: center"><span style="background-color:#555555"><font color="#FFFFFF">#555555</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#626262"><font color="#EEEEEC">#666666</font></span></td><td style="text-align: center"><span style="background-color:#666666"><font color="#FFFFFF">#666666</font></span></td><td style="text-align: center"><span style="background-color:#666666"><font color="#FFFFFF">#666666</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#767676"><font color="#EEEEEC">#777777</font></span></td><td style="text-align: center"><span style="background-color:#777777"><font color="#FFFFFF">#777777</font></span></td><td style="text-align: center"><span style="background-color:#777777"><font color="#FFFFFF">#777777</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#878787"><font color="#2E3436">#888888</font></span></td><td style="text-align: center"><span style="background-color:#888888"><font color="#000000">#888888</font></span></td><td style="text-align: center"><span style="background-color:#888888"><font color="#FFFFFF">#888888</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#9E9E9E"><font color="#2E3436">#999999</font></span></td><td style="text-align: center"><span style="background-color:#999999"><font color="#000000">#999999</font></span></td><td style="text-align: center"><span style="background-color:#999999"><font color="#FFFFFF">#999999</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#A8A8A8"><font color="#2E3436">#aaaaaa</font></span></td><td style="text-align: center"><span style="background-color:#AAAAAA"><font color="#000000">#aaaaaa</font></span></td><td style="text-align: center"><span style="background-color:#AAAAAA"><font color="#FFFFFF">#aaaaaa</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#BCBCBC"><font color="#2E3436">#bbbbbb</font></span></td><td style="text-align: center"><span style="background-color:#BBBBBB"><font color="#000000">#bbbbbb</font></span></td><td style="text-align: center"><span style="background-color:#BBBBBB"><font color="#000000">#bbbbbb</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#D0D0D0"><font color="#2E3436">#cccccc</font></span></td><td style="text-align: center"><span style="background-color:#CCCCCC"><font color="#000000">#cccccc</font></span></td><td style="text-align: center"><span style="background-color:#CCCCCC"><font color="#000000">#cccccc</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#DADADA"><font color="#2E3436">#dddddd</font></span></td><td style="text-align: center"><span style="background-color:#DDDDDD"><font color="#000000">#dddddd</font></span></td><td style="text-align: center"><span style="background-color:#DDDDDD"><font color="#000000">#dddddd</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#EEEEEE"><font color="#2E3436">#eeeeee</font></span></td><td style="text-align: center"><span style="background-color:#EEEEEE"><font color="#000000">#eeeeee</font></span></td><td style="text-align: center"><span style="background-color:#EEEEEE"><font color="#000000">#eeeeee</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FFFFFF"><font color="#2E3436">#ffffff</font></span></td><td style="text-align: center"><span style="background-color:#FFFFFF"><font color="#000000">#ffffff</font></span></td><td style="text-align: center"><span style="background-color:#FFFFFF"><font color="#000000">#ffffff</font></span></td></tr>
</tbody></table>
</div>
<p>Vim-css-color with out <code>termguicolors</code> cannot display color correctly (or say precisely),
if you dont believe your eye, see the source code of this page.</p>
<p>I think vim-hexokinase with a <code>termguicolors</code> toggle is a acceptable compromise.
Toggle <code>termguicolors</code> by <code>:set termguicolors!</code>.
I personally prefer to assign <code>&lt;leader&gt;c</code> to toggle <code>termguicolors</code>.</p>
<h3 id="cterm--gui"><a class="header" href="#cterm--gui">cterm &amp; gui</a></h3>
<p>TLDR: I still haven't find a elegant solution to keep <code>termguicolors</code> and <code>notermguicolors</code> visually same.</p>
<p>neovim has 2 color schemes cterm &amp; gui,
see <code>:h cterm-colors</code> &amp; <code>:h gui-colors</code>.
Default sntax colors are different in these two schemes.
For example, <code>:verbose highlight Comment</code> returns</p>
<pre><code class="language-vim">Comment        xxx ctermfg=14 guifg=#80a0ff
        Last set from /nix/store/pr1pwjjsm3k45rwi3w0xh2296rpymjlz-neovim-unwrapped-0.5.1/share/nvim/runtime/syntax/syncolor.vim
</code></pre>
<p>which means ctermfg uses the 14th color in ANSI colors,
while guifg use a hex color code.
The detailed setting is located in <code>${VIMRUNTIME}/syntax/syncolor.vim</code>.</p>
<p>I create a new syncolor.vim based the default one,
and modify the all ctermfg and guifg to same color name, like below.
The colors in two schemes are still different.</p>
<pre><code class="language-vim">if !exists("syntax_cmd") || syntax_cmd == "on"
  " ":syntax on" works like in Vim 5.7: set colors but keep links
  command -nargs=* SynColor hi &lt;args&gt;
  command -nargs=* SynLink hi link &lt;args&gt;
else
  if syntax_cmd == "enable"
    " ":syntax enable" keeps any existing colors
    command -nargs=* SynColor hi def &lt;args&gt;
    command -nargs=* SynLink hi def link &lt;args&gt;
  elseif syntax_cmd == "reset"
    " ":syntax reset" resets all colors to the default
    command -nargs=* SynColor hi &lt;args&gt;
    command -nargs=* SynLink hi! link &lt;args&gt;
  else
    " User defined syncolor file has already set the colors.
    finish
  endif
endif

" Many terminals can only use six different colors (plus black and white).
" Therefore the number of colors used is kept low. It doesn't look nice with
" too many colors anyway.
" Careful with "cterm=bold", it changes the color to bright for some terminals.
" There are two sets of defaults: for a dark and a light background.
if &amp;background == "dark"
  SynColor Comment	term=bold cterm=NONE ctermfg=Cyan ctermbg=NONE gui=NONE guifg=Cyan guibg=NONE
  SynColor Constant	term=underline cterm=NONE ctermfg=Magenta ctermbg=NONE gui=NONE guifg=Magenta guibg=NONE
  SynColor Special	term=bold cterm=NONE ctermfg=LightRed ctermbg=NONE gui=NONE guifg=LightRed guibg=NONE
  SynColor Identifier	term=underline cterm=bold ctermfg=Cyan ctermbg=NONE gui=bold guifg=Cyan guibg=NONE
  SynColor Statement	term=bold cterm=NONE ctermfg=Yellow ctermbg=NONE gui=NONE guifg=Yellow guibg=NONE
  SynColor PreProc	term=underline cterm=NONE ctermfg=LightBlue ctermbg=NONE gui=NONE guifg=LightBlue guibg=NONE
  SynColor Type		term=underline cterm=NONE ctermfg=LightGreen ctermbg=NONE gui=NONE guifg=LightGreen guibg=NONE
  SynColor Underlined	term=underline cterm=underline ctermfg=LightBlue gui=underline guifg=LightBlue
  SynColor Ignore	term=NONE cterm=NONE ctermfg=black ctermbg=NONE gui=NONE guifg=black guibg=NONE
else
  SynColor Comment	term=bold cterm=NONE ctermfg=DarkBlue ctermbg=NONE gui=NONE guifg=DarkBlue guibg=NONE
  SynColor Constant	term=underline cterm=NONE ctermfg=DarkRed ctermbg=NONE gui=NONE guifg=DarkBlue guibg=NONE
  SynColor Special	term=bold cterm=NONE ctermfg=DarkMagenta ctermbg=NONE gui=NONE guifg=DarkMagenta guibg=NONE
  SynColor Identifier	term=underline cterm=NONE ctermfg=DarkCyan ctermbg=NONE gui=NONE guifg=DarkCyan guibg=NONE
  SynColor Statement	term=bold cterm=NONE ctermfg=Brown ctermbg=NONE gui=bold guifg=Brown guibg=NONE
  SynColor PreProc	term=underline cterm=NONE ctermfg=DarkMagenta ctermbg=NONE gui=NONE guifg=DarkMagenta guibg=NONE
  SynColor Type		term=underline cterm=NONE ctermfg=DarkGreen ctermbg=NONE gui=NONE guifg=DarkGreen guibg=NONE
  SynColor Underlined	term=underline cterm=underline ctermfg=DarkMagenta gui=underline guifg=DarkMagenta
  SynColor Ignore	term=NONE cterm=NONE ctermfg=white ctermbg=NONE gui=NONE guifg=white guibg=NONE
endif
SynColor Error		term=reverse cterm=NONE ctermfg=White ctermbg=Red gui=NONE guifg=White guibg=Red
SynColor Todo		term=standout cterm=NONE ctermfg=Black ctermbg=Yellow gui=NONE guifg=Black guibg=Yellow
</code></pre>
<p>The Magenta is especially dazzling,
and cannot change it by below tries.</p>
<p>Refers to <a href="https://github.com/vim/vim/issues/2353">Change Vim's terminal colors when termguicolors is set #2353</a>,
<a href="http://neovim.io/doc/user/nvim_terminal_emulator.html#nvim-terminal-emulator-configuration">nvim-terminal-emulator-configuration</a>,</p>
<p><code>let g:terminal_color_13 = '#AD7FA8' " Magenta</code> doesn't work.</p>
<p>Finally I choose to add a color-scheme manager,
and choose a theme which has both cterm &amp; gui color scheme.</p>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-vim-hexokinase = {
    plugin = pkgs.vimPlugins.vim-hexokinase;
    config = ''
      let g:Hexokinase_highlighters = ['backgroundfull']
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-vim-hexokinase
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vim-mark-multi-color-highlight"><a class="header" href="#vim-mark-multi-color-highlight">vim-mark: multi-color highlight</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  vim-ingo-library = pkgs.vimUtils.buildVimPlugin {
    name = "vim-ingo-library";
    src = pkgs.fetchFromGitHub {
      owner = "inkarkat";
      repo = "vim-ingo-library";
      rev = "c93c33f803356b16bf4b4d122404d8251dc7b24d";
      hash = "sha256-85h3S+5IjVIbTkYJasPXU+z/ALc9oT+MzdyjvTOhIwg=";
    };
  };
  my-vim-mark = {
    plugin = pkgs.vimUtils.buildVimPlugin {
      name = "vim-mark";
      src = pkgs.fetchFromGitHub {
        owner = "inkarkat";
        repo = "vim-mark";
        rev = "76a25085d7c46f90fd5dfd7c43c3ba05b86ee192";
        hash = "sha256-h2uaZ8dCUopNJ7fpf3BEoZNRk+25zqFukcHa3LomPSk=";
      };
    };
    config = ''
      " clear highlight created by vim-mark
      nnoremap &lt;leader&gt;&lt;F3&gt; :MarkClear&lt;CR&gt;
      " show all marks
      nnoremap &lt;leader&gt;M :Marks&lt;CR&gt;
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-vim-mark
      vim-ingo-library
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim = {
    plugins = [{
      plugin = pkgs.vimPlugins.vim-matchup;
      type = "lua";
      config = ''
        vim.g.matchup_matchparen_offscreen = { method = "popup" }
        -- 不要加粗光标下的可匹配文字，不然写代码时常遇到的不协调感觉
        -- 比如写{}时{是普通字体}是加粗字体，光标左移一下，{变成加粗}是普通字体。
        vim.cmd("highlight MatchParenCur cterm=NONE gui=NONE")
      '';
    }];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="winshift-nvim-rearrange-windows"><a class="header" href="#winshift-nvim-rearrange-windows">winshift-nvim: rearrange windows</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-winshift-nvim = {
    plugin = pkgs.vimPlugins.winshift-nvim;
    type = "lua";
    config = ''
      -- Lua
      require("winshift").setup({
        highlight_moving_win = true,  -- Highlight the window being moved
        focused_hl_group = "Visual",  -- The highlight group used for the moving window
        -- moving_win_options = {
        --   -- These are local options applied to the moving window while it's
        --   -- being moved. They are unset when you leave Win-Move mode.
        --   wrap = true,
        --   cursorline = false,
        --   cursorcolumn = false,
        --   colorcolumn = "",
        -- },
        keymaps = {
          disable_defaults = false, -- Disable the default keymaps
          win_move_mode = {
            ["h"] = "left",
            ["j"] = "down",
            ["k"] = "up",
            ["l"] = "right",
            ["H"] = "far_left",
            ["J"] = "far_down",
            ["K"] = "far_up",
            ["L"] = "far_right",
            ["&lt;left&gt;"] = "left",
            ["&lt;down&gt;"] = "down",
            ["&lt;up&gt;"] = "up",
            ["&lt;right&gt;"] = "right",
            ["&lt;S-left&gt;"] = "far_left",
            ["&lt;S-down&gt;"] = "far_down",
            ["&lt;S-up&gt;"] = "far_up",
            ["&lt;S-right&gt;"] = "far_right",
          },
        },
        ---A function that should prompt the user to select a window.
        ---
        ---The window picker is used to select a window while swapping windows with
        ---`:WinShift swap`.
        ---@return integer? winid # Either the selected window ID, or `nil` to
        ---   indicate that the user cancelled / gave an invalid selection.
        window_picker = function()
          return require("winshift.lib").pick_window({
            -- A string of chars used as identifiers by the window picker.
            picker_chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890",
            filter_rules = {
              -- This table allows you to indicate to the window picker that a window
              -- should be ignored if its buffer matches any of the following criteria.
              cur_win = true, -- Filter out the current window
              floats = true,  -- Filter out floating windows
              filetype = {},  -- List of ignored file types
              buftype = {},   -- List of ignored buftypes
              bufname = {},   -- List of vim regex patterns matching ignored buffer names
            },
            ---A function used to filter the list of selectable windows.
            ---@param winids integer[] # The list of selectable window IDs.
            ---@return integer[] filtered # The filtered list of window IDs.
            filter_func = nil,
          })
        end,
      })

      vim.keymap.set('n', '&lt;C-W&gt;m', '&lt;Cmd&gt;WinShift&lt;CR&gt;')
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-winshift-nvim
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="usrdefaultnix"><a class="header" href="#usrdefaultnix">usr/default.nix</a></h1>
<p>home-manager的入口配置文件，它导入了：</p>
<ul>
<li><a href="usr/./usr/cli/default.nix.html"><code>./usr/cli</code></a>：我的所有CLI程序的配置</li>
<li><a href="usr/./usr/gui/default.nix.html"><code>./usr/gui</code></a>：我的所有GUI程序的配置</li>
</ul>
<p>因为部分系统不需要GUI程序，比如安卓手机nix-on-droid或是树莓派等。
我利用环境变量<code>DISPLAY</code>用于判断是否导入GUI程序的配置。</p>
<pre><code class="language-nix">{ ... }: {
  imports = [
    ../modules
    ./modules/cachix.nix
    ./cli
    ./gui
  ];
  news.display = "silent";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  xelfviewer = pkgs.callPackage ./xelfviewer.nix {};
in
{
  imports = [
    ./mime.nix
    ./kdeconnect.nix
    ./xdot.nix
    ./firefox
    ./warpd.nix
    ./rustdesk.nix
    ./gnome
    ./kitty
    ./singleton_apps.nix
    ./rofi.nix
    ./xcolor.nix
    ./wsl.nix
    ./drawio.nix
    ./flameshot.nix
    ./fcitx5
  ];

config = lib.mkIf config.isGui {
  home.packages = with pkgs; [
    (pkgs.writeShellScriptBin "o" ''nohup xdg-open "$@" &amp;&gt; /dev/null &amp;'')
    libnotify
    # browser
    # dont ask me for keyring chromium-like browsers!
    (chromium.override {commandLineArgs="--password-store=basic";})
  ] ++ [
    # network
  ] ++ pkgs.lib.optionals (builtins.currentSystem=="x86_64-linux") [
    feishu
    (wechat-uos.override {
      buildFHSEnv = args: buildFHSEnv (args // {
        # bubble wrap wechat-uos's home directory
        extraBwrapArgs = [
          "--bind ${config.home.homeDirectory}/.local/share/wechat-uos /home"
          "--chdir /home"
        ];
      });
    })
    # wine weixin waste too much memory, more than 4GB!!!
    #(import ./weixin.nix {})
    wemeet
    nur.repos.xddxdd.dingtalk
    # telegram desktop not provide aarch64 prebuilt
    tdesktop
  ] ++ [
    transmission_4-gtk
    # text
    #wpsoffice
    libreoffice
    meld
    # TODO: use this after switching to wayland
    #wl-clipboard
    textsnatcher
    # draw
    #aseprite-unfree
    inkscape
    gimp
    # viewer
  ] ++ pkgs.lib.optionals (builtins.currentSystem=="x86_64-linux") [
    imhex
    xelfviewer
  ] ++ [
    vlc
    obsidian
  ] ++ pkgs.lib.optionals (builtins.currentSystem=="x86_64-linux") [
    ghidra
  ] ++ [
    # management
  ] ++ pkgs.lib.optionals (builtins.currentSystem=="x86_64-linux") [
    zotero
  ] ++ [
    # pkgs.pkgsu.deskflow
    barrier
    keepassxc
    # entertainment
    antimicrox
  ];

  # home.file.autostart_deskflow = {
  #   source = "${pkgs.pkgsu.deskflow}/share/applications/org.deskflow.deskflow.desktop";
  #   target = ".config/autostart/org.deskflow.deskflow.desktop";
  # };
  # use barrier due to its support of hotkey toggle screen!
  #   see: https://github.com/deskflow/deskflow/issues/8006
  home.file.autostart_barrier = {
    source = "${pkgs.barrier}/share/applications/barrier.desktop";
    target = ".config/autostart/barrier.desktop";
  };
};}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.drawio
  ];
  xdg.mime.types = {
    drawio = {
      name = "draw-io";
      type = "text/draw-io";
      pattern = "*.drawio";
      defaultApp = "drawio.desktop";
    };
  };
  programs.neovim = {
    extraConfig = ''
      augroup filetype
        au! BufRead,BufNewFile *.drawio set filetype=xml
      augroup END
    '';
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p>Input method</p>
<p>Why replace ibus with fcitx5</p>
<ul>
<li>ibus mozc not support shift toggle activation</li>
<li>ibus configuration use db, not file</li>
<li>ibus cannot be configured by user (home-manager)</li>
</ul>
<pre><code class="language-nix">{ config, pkgs, ... }: {
  i18n.inputMethod = {
    enable = true;
    type = "fcitx5";
    fcitx5 = {
      addons = [
        pkgs.fcitx5-chinese-addons
        pkgs.fcitx5-pinyin-zhwiki
        pkgs.fcitx5-mozc-ut
        pkgs.fcitx5-hangul
      ];
    };
  };

  imports = [ ./module.nix ];
  config_fcitx5 = {
    profile = (pkgs.formats.ini {}).generate "profile" {
      "Groups/0" = {
        Name="Default";
        "Default Layout"="us";
      };
      "Groups/0/Items/0" = {
        Name="keyboard-us";
      };
      "Groups/0/Items/1" = {
        Name="pinyin";
      };
      "Groups/0/Items/2" = {
        Name="mozc";
      };
      "Groups/0/Items/3" = {
        Name="hangul";
      };
    };
    config = (pkgs.formats.ini {}).generate "config" {
      "Hotkey" = {
        # Disable default super+space, shift+super+space
        EnumerateGroupForwardKeys="";
        EnumerateGroupBackwardKeys="";
      };
      "Hotkey/TriggerKeys" = {
        "0"="Shift_L";
      };
      "Hotkey/EnumerateForwardKeys" = {
        "0"="Control+space";
      };
      "Hotkey/EnumerateBackwardKeys" = {
        "0"="Control+Shift+space";
      };
    };
    "conf/classicui.conf" = (pkgs.formats.keyValue {}).generate "classicui.conf" {
      Font=''"Sans Serif 16"'';
      MenuFont=''"Sans Serif 16"'';
      TrayFont=''"Sans Serif 16"'';
      Theme="default";
      DarkTheme="default-dark";
      # Follow system light/dark color scheme
      UseDarkTheme="True";
      # Follow system accent color if it is supported by theme and desktop
      UseAccentColor="True";
    };
    "conf/punctuation.conf" = (pkgs.formats.keyValue {}).generate "punctuation.conf" {
      # Half width punctuation after latin letter or number
      HalfWidthPuncAfterLetterOrNumber = "False";
    };
    # simplified/traditional chinese conversion
    "conf/chttrans.conf" = (pkgs.formats.ini {}).generate "chttrans.conf" {
      Hotkey."0" = "Alt+F";
    };
  };
  home.file.punc_mb_zh_CN = {
    source = pkgs.runCommand "punc.mb.zh_CN" {} /*bash*/ ''
      sed '/_ ——/d' ${pkgs.fcitx5-chinese-addons}/share/fcitx5/punctuation/punc.mb.zh_CN &gt; $out
      {
      cat &lt;&lt;APPEND
      &lt; &lt;
      &gt; &gt;
      ^ ^
      APPEND
      } &gt;&gt; $out
    '';
    target = ".local/share/fcitx5/punctuation/punc.mb.zh_CN";
  };

  dconf.settings = {
    # Disable ibus input method shortcuts
    "org/gnome/desktop/wm/keybindings" = {
      switch-input-source=[];
      switch-input-source-backward=[];
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, config, lib, ... }: {
  options = {
    config_fcitx5 = lib.mkOption {
      type = lib.types.attrsOf lib.types.path;
      default = {};
      description = ''
        The fcitx5 config files in ~/.config/fcitx5/
      '';
    };
  };
  config = {
    xdg.configFile = lib.mapAttrs' (path: source: lib.nameValuePair
      "config_fcitx5_${baseNameOf path}"
      (let
        relDir = "fcitx5";
        absDir = "${config.xdg.configHome}/${relDir}";
        _path_ = "${dirOf path}/_${baseNameOf path}_";
      in {
        target = "${relDir}/${_path_}";
        inherit source;
        onChange = ''
          if [[ -e ${absDir}/${path} ]]; then
            ${pkgs.crudini}/bin/crudini --merge ${absDir}/${path} &lt; ${absDir}/${_path_}
          else
            cat ${absDir}/${_path_} &gt; ${absDir}/${path}
          fi
        '';
      })
    ) config.config_fcitx5;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><div style="text-align:right; font-size:3em;">2022.05.11</div>
<h1 id="安装deb包以飞书为例"><a class="header" href="#安装deb包以飞书为例">安装deb包，以飞书为例</a></h1>
<p><strong>太长不看</strong></p>
<ul>
<li>nix文件: https://github.com/xieby1/nix_config/blob/main/usr/gui/feishu.nix</li>
<li>使用方法:
<pre><code class="language-nix">home.packages = with pkgs; [
  (callPackage ./feishu.nix {})
];
</code></pre>
</li>
</ul>
<p>参考nixpkgs/pkgs/applications/networking/instant-messengers/skypeforlinux/default.nix</p>
<h2 id="测试环境"><a class="header" href="#测试环境">测试环境</a></h2>
<p>nix-build -E "with import <nixpkgs> {}; callPackage ./default.nix {}"</p>
<h2 id="权限问题"><a class="header" href="#权限问题">权限问题</a></h2>
<p>nix-build遇到dpkg -x解压失败。
但是手动执行dpkg -x一切正常。</p>
<p>https://unix.stackexchange.com/questions/138188/easily-unpack-deb-edit-postinst-and-repack-deb</p>
<p>确认是权限问题的实验</p>
<p>是s权限的问题。
nix-build下不能添加s权限。
原因未知</p>
<p>复现方法</p>
<pre><code class="language-bash">touch $out/miao
chmox +s $out/miao
ls -l $out/miao
</code></pre>
<p>解决方法，使用fakeroot.</p>
<h2 id="补全库"><a class="header" href="#补全库">补全库</a></h2>
<p>使用ldd脚本，获取所有elf所需的库，挨个添加进rpath即可。</p>
<h2 id="桌面"><a class="header" href="#桌面">桌面</a></h2>
<p>application/<em>.desktop
menu/</em>.menu // 负责图标</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="firefox-apps"><a class="header" href="#firefox-apps">firefox-apps</a></h1>
<h2 id="comparison-of-chromium-based-browsers-and-firefox"><a class="header" href="#comparison-of-chromium-based-browsers-and-firefox">Comparison of chromium-based browsers and firefox</a></h2>
<ul>
<li>list windows: <code>wmctrl -l</code></li>
<li>list windows properties: <code>xprop -name &lt;WIN_NAME&gt; [PROP]</code></li>
</ul>
<p>second instance of chrome ignores <code>--class</code></p>
<ul>
<li>bing: chrome wm_class new instance
<ul>
<li>https://superuser.com/questions/1457060/how-can-you-start-two-chrome-windows-with-different-wm-class-attributes
<ul>
<li>https://issues.chromium.org/issues/40172351</li>
<li>目前看来最好的方法：--user-data-dir</li>
<li>firefox类似，用不同的profile</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>https://superuser.com/questions/1770285/custom-firefox-profiles-with-different-wm-class-and-icons</p>
<p>set WM_CLASS</p>
<ul>
<li>https://stackoverflow.com/questions/36650865/set-wm-class-with-wnck-xprop-or-something-else
能正常设置kitty的WM_CLASS，但是为什么chrome不行？</li>
</ul>
<p>所以选择firefox！</p>
<pre><code class="language-nix">{ config, pkgs, ... }: {
  imports = [
    ./module.nix
    ./single-tab.nix
  ];

  firefox-apps = [{
    name = "ms-todo";
    url = "https://to-do.live.com/";
    desktopEntryExtras = {
      name = "Microsoft To Do";
    };
    keybinding = "&lt;Super&gt;t";
  }{
    name = "ms-calendar"; # avoid singleton xdotool conflicts with system calendar
    url = "https://outlook.live.com/calendar";
    desktopEntryExtras = {
      name = "Microsoft Calendar";
      genericName = "outlook calendar mail";
    };
    keybinding = "&lt;Super&gt;c";
  }{
    name = "webweixin";
    url = "https://wx.qq.com";
    desktopEntryExtras = {
      name = "网页微信";
      genericName = "weixin";
    };
  }{
    name = "my_cheatsheet_html";
    url = "${config.home.homeDirectory}/Documents/Tech/my_cheatsheet.html";
    keybinding = "&lt;Super&gt;space";
    desktopEntryExtras = {
      name = "Cheatsheet HTML";
      genericName = "cheatsheet";
      icon = builtins.toFile "cheatsheet.svg" ''
        &lt;svg width="64" height="64" xmlns="http://www.w3.org/2000/svg"&gt;
          &lt;rect width="100%" height="100%" rx="20%" ry="20%" fill="#666666"/&gt;
          &lt;text x="50%" y="50%" text-anchor="middle" dominant-baseline="middle" font-size="18" font-weight="bold" fill="#F5F5F5"&gt;
            &lt;tspan x="50%" dy="-0.6em"&gt;CS&lt;/tspan&gt;
            &lt;tspan x="50%" dy="1.2em"&gt;html&lt;/tspan&gt;
          &lt;/text&gt;
        &lt;/svg&gt;
      '';
    };
  }{
    name = "bing_dict";
    url = "https://cn.bing.com/dict";
    keybinding = "&lt;Super&gt;b";
    desktopEntryExtras = {
      name = "Bing Dict";
      genericName = "dictionary";
    };
  }{
    name = "riyucidian";
    url = "https://www.mojidict.com";
    keybinding = "&lt;Super&gt;j";
    desktopEntryExtras = {
      name = "日语词典";
    };
  }{
    name = "devdocs";
    url = "https://devdocs.io";
    desktopEntryExtras = {
      name = "DevDocs";
    };
  }(let
    metacubexd = builtins.fetchTarball "https://github.com/MetaCubeX/metacubexd/archive/gh-pages.zip";
  in {
    name = "clash";
    url = "${metacubexd}/index.html";
    desktopEntryExtras = {
      icon = "${metacubexd}/pwa-192x192.png";
    };
  }){
    name = "ai";
    url = "https://web.chatboxai.app";
    desktopEntryExtras = {
      name = "AI Chatbox";
    };
  }{
    name = "deepseek";
    url = "https://chat.deepseek.com";
    keybinding = "&lt;Super&gt;a";
    desktopEntryExtras = {
      name = "DeepSeek";
    };
  }{
    name = "doubao";
    url = "https://www.doubao.com/chat";
    desktopEntryExtras = {
      name = "豆包";
    };
  }{
    name = "spotify";
    url = "https://open.spotify.com/search";
    desktopEntryExtras = {
      name = "Spotify (Search)";
    };
  }{
    name = "syncthing";
    url = "http://127.0.0.1:8384";
    icon = "${pkgs.syncthingtray-minimal}/share/icons/hicolor/scalable/apps/syncthingtray.svg";
  }{
    name = "emojidb";
    url = "https://emojidb.org";
    desktopEntryExtras = {
      name = "EmojiDB";
    };
  }{
    name = "wangyiyunyinyue-wyyyy";
    url = "https://music.163.com";
    desktopEntryExtras = {
      name = "网易云音乐";
    };
  }];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="firefox-module"><a class="header" href="#firefox-module">firefox module</a></h1>
<pre><code class="language-nix">{ config, pkgs, lib, ... }: let
  singleton = pkgs.writeShellScript "singleton.sh" ''
    if [[ $# -lt 2 || $1 == "-h" ]]
    then
      echo "Usage: ''${0##*/} &lt;wmclass&gt; &lt;command and its args&gt;"
      echo "  Only start a app once, if the app is running"
      echo "  then bring it to foreground"
      exit 0
    fi

    WID=$(${pkgs.xdotool}/bin/xdotool search --class "$1")
    if [[ -z $WID ]]; then
      eval "''${@:2}"
    else
      for WIN in $WID; do
        CURDESK=$(${pkgs.xdotool}/bin/xdotool get_desktop)
        ${pkgs.xdotool}/bin/xdotool set_desktop_for_window $WIN $CURDESK
        ${pkgs.xdotool}/bin/xdotool windowactivate $WIN
      done
    fi
  '';
in {
  options = {
    firefox-apps = lib.mkOption {
      type = lib.types.listOf (lib.types.submodule {
        options = {
          name = lib.mkOption {
            type = lib.types.str;
            default = null;
          };
          url = lib.mkOption {
            type = lib.types.str;
            default = null;
          };
          icon = lib.mkOption {
            type = lib.types.nullOr lib.types.path;
            default = null;
          };
          enableDesktopEntry = lib.mkOption {
            type = lib.types.bool;
            default = true;
          };
          desktopEntryExtras = lib.mkOption {
            type = lib.types.attrs;
            default = {};
            description = "extra settings for desktopEntry, see xdg.desktopEntries.&lt;xxx&gt;";
          };
          keybinding = lib.mkOption {
            default = null;
          };
        };
      });
    };
  };

  config = {
    programs.firefox.profiles = builtins.listToAttrs (
      lib.imap1 (i: firefox-app: {
        name = assert firefox-app.name!=null; firefox-app.name;
        value = {
          id = i;
          extensions.packages = with pkgs.nur.repos.rycee.firefox-addons; [
            # auto open all windows in fullscreen mode
            i-auto-fullscreen
            darkreader
            vimium
            ublock-origin
          ];
          settings = {
            # https://superuser.com/questions/1483037/making-firefox-fullscreen-like-without-actually-maximizing-the-window
            # the full screen hotkey/button will trigger fullscreen like normal, except it won't resize the window.
            "full-screen-api.ignore-widgets" = true;
            # Automatically enable extensions
            "extensions.autoDisableScopes" = 0;
            # https://stackoverflow.com/questions/51081754/cross-origin-request-blocked-when-loading-local-file
            "security.fileuri.strict_origin_policy" = false;
            # enable userChrome.css
            "toolkit.legacyUserProfileCustomizations.stylesheets" = true;
            # disable extensions auto update
            "extensions.update.enabled" = false;
          };
          userChrome = ''
            /* [Disabling the mouseover to reveal the address/toolbar while in fullscreen - old method doesn't work](https://support.mozilla.org/en-US/questions/1324666) */
            /* [prevent firefox from showing the address bar in fullscreen mode](https://support.mozilla.org/en-US/questions/1323320) */
            *|div#fullscr-toggler {display:none!important;}
          '';
        };
      }) config.firefox-apps
    );

    xdg.desktopEntries = let
      firefox-apps-with-desktopEntry = (builtins.filter (firefox-app: firefox-app.enableDesktopEntry) config.firefox-apps);
    in builtins.listToAttrs (
      map (firefox-app: {
        name = assert firefox-app.name!=null; firefox-app.name;
        value = {
          name = firefox-app.name;
          genericName = firefox-app.name;
          exec = assert firefox-app.url!=null;
            "firefox -P ${firefox-app.name} --class ${firefox-app.name} ${firefox-app.url}";
          icon = if firefox-app.icon != null then firefox-app.icon
          else builtins.fetchurl {
            url = "http://www.google.com/s2/favicons?domain=${firefox-app.url}&amp;sz=128";
            name = "${firefox-app.name}.png";
          };
          settings = {
            StartupWMClass = firefox-app.name;
          };
        } // firefox-app.desktopEntryExtras;
      }) firefox-apps-with-desktopEntry
    );

    dconf.settings = let
      firefox-apps-with-keybinding = (builtins.filter (firefox-app: firefox-app.keybinding!=null ) config.firefox-apps);
    in {
      "org/gnome/settings-daemon/plugins/media-keys".custom-keybindings = map (
        firefox-app: "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/${firefox-app.name}/"
      ) firefox-apps-with-keybinding;
    } // (builtins.listToAttrs (
      map (firefox-app: {
        name = "org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/${firefox-app.name}";
        value = {
          binding = firefox-app.keybinding;
          command = "${singleton} ${firefox-app.name} gtk-launch ${firefox-app.name}.desktop";
          name = firefox-app.name;
        };
      }) firefox-apps-with-keybinding
    ));
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: let
  name = "firefox-single-tab";
in {
  firefox-apps = [{
    inherit name;
    url = "";
    icon = builtins.toFile "${name}.svg" ''
      &lt;svg width="64" height="64" xmlns="http://www.w3.org/2000/svg"&gt;
        &lt;rect width="100%" height="100%" rx="20%" ry="20%" fill="white"/&gt;
        &lt;text x="50%" y="50%" text-anchor="middle" dominant-baseline="middle" font-size="14" font-weight="bold" fill="#6155d2"&gt;
          &lt;tspan x="50%" dy="-1em"&gt;Firefox&lt;/tspan&gt;
          &lt;tspan x="50%" dy="1em"&gt;Single&lt;/tspan&gt;
          &lt;tspan x="50%" dy="1em"&gt;Tab&lt;/tspan&gt;
        &lt;/text&gt;
      &lt;/svg&gt;
    '';
  }];

  home.packages = map (n: (
    pkgs.writeScriptBin n ''
      nohup firefox -P ${name} --class ${name} --new-window "$@" &amp;&gt; /dev/null &amp;
    ''
  )) [name "single-tab"];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="firefox-configurations"><a class="header" href="#firefox-configurations">firefox configurations</a></h1>
<pre><code class="language-nix">{ pkgs, config, ... }:
{
  imports = [
    ./apps
    ./extensions
  ];
  programs.firefox = {
    enable = true;
    # If state version ≥ 19.09 then this should be a wrapped Firefox
    package = pkgs.firefox.overrideAttrs (old: {
      # MOZ_USE_XINPUT2=1 allow more smooth (pixel-level) scroll and zoom
      buildCommand = old.buildCommand + ''
        mv $out/bin/firefox $out/bin/firefox-no-xinput2
        makeWrapper $out/bin/firefox-no-xinput2 $out/bin/firefox --set-default MOZ_USE_XINPUT2 1
      '';
    });
    # id is default 0, thus this profile is default
    profiles.xieby1 = {
      settings = {
        # https://superuser.com/questions/1483037/making-firefox-fullscreen-like-without-actually-maximizing-the-window
        # the full screen hotkey/button will trigger fullscreen like normal, except it won't resize the window.
        "full-screen-api.ignore-widgets" = true;
        # Disable `alt` key of toggling menu bar
        "ui.key.menuAccessKeyFocuses" = false;
        "ui.key.menuAccessKey" = -1; # original number 18
        # enable userChrome.css
        "toolkit.legacyUserProfileCustomizations.stylesheets" = true;

        # enable bookmarks sync to file
        "browser.bookmarks.autoExportHTML" = true;
        "browser.bookmarks.file" = "${config.home.homeDirectory}/Gist/Config/firefox-bookmarks.html";
        "browser.places.importBookmarksHTML" = true;
      };
      userChrome =
      # [Disabling the mouseover to reveal the address/toolbar while in fullscreen - old method doesn't work](https://support.mozilla.org/en-US/questions/1324666)
      # [prevent firefox from showing the address bar in fullscreen mode](https://support.mozilla.org/en-US/questions/1323320)
      ''
        *|div#fullscr-toggler {display:none!important;}
      '';
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  programs.firefox = {
    profiles.xieby1 = {
      extensions.packages = [ pkgs.nur.repos.rycee.firefox-addons.brotab ];
    };
  };

  home.packages = [ pkgs.brotab ];
  home.file.brotab_mediator = rec {
    target = ".mozilla/native-messaging-hosts/brotab_mediator.json";
    source = pkgs.runCommand "brotab_mediator" {} ''
      export HOME=.
      ${pkgs.brotab}/bin/brotab install
      cp ${target} $out
    '';
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: let
  darkreader = pkgs.nur.repos.rycee.firefox-addons.darkreader;
in {
  programs.firefox = {
    profiles.xieby1 = {
      extensions.packages = [ darkreader ];
    };
  };
  firefox-extensions.xieby1.browser-extension-data."${darkreader.addonId}" = {
    storage = {
      schemeVersion = 2;
      syncSettings = false;
      disabledFor = [
        # markdown-preview-nvim: x.x.x.x:7768
        # markdown_revealjs daemon: x.x.x.x:7782
        "/.*:77[0-9][0-9]/"
        # markdown_revealjs
        "//home/.*/slides/index.html/"
      ];
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  imports = [
    ./module.nix

    ./sidebery.nix
    ./darkreader.nix
    ./smartproxy.nix
    ./smart-toc.nix
    ./brotab.nix
    ./vimium.nix
  ];

  programs.firefox = {
    profiles.xieby1 = {
      extensions.packages = with pkgs.nur.repos.rycee.firefox-addons; [
        # 😾😾😾 Chinese users cannot use ad block extensions
        # https://discourse.mozilla.org/t/chinese-users-cant-use-ad-blocker-extensions/94823
        ublock-origin
        auto-tab-discard
        refined-github
        furiganaize
      ];
      settings = {
        # Automatically enable extensions
        "extensions.autoDisableScopes" = 0;
        # Disable extension auto update
        "extensions.update.enabled" = false;
      };
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, lib, ... }: {
  options = {
    firefox-extensions = lib.mkOption {
      #      per-profile
      type = lib.types.attrsOf (lib.types.submodule { options = {
        browser-extension-data = lib.mkOption {
          #      per-extension
          type = lib.types.attrsOf (lib.types.submodule { options = {
            storage = lib.mkOption {
              type = lib.types.attrs;
              default = {};
              description = ''
                Attrs that will be converted to json and merged to storage.js
              '';
            };
          };});
        };
        extension-settings = lib.mkOption {
          type = lib.types.mkOptionType {
            name = "attrsRecursiveUpdate";
            description = "attribute set";
            check = lib.isAttrs;
            merge = loc: lib.foldl' (res: def: lib.recursiveUpdate res def.value) { };
            emptyValue = {
              value = { };
            };
          };
          default = {};
          description = ''
            The extension-settings.json
          '';
        };
      };});
      default = {};
      description = ''
        Attrs of firefox-extensions settings

        You may ask: why not using `programs.firefox.profiles.&lt;name&gt;.extensions.settings`?
        Because it do not support partially updating the settings.

        Example:

        firefox-extensions = {
          profile0 = {
            browser-extension-data = {
              darkreader = {
                storage = {
                  schemeVersion = 2;
                  syncSettings = false;
                  disabledFor = [
                    "http://127.0.0.1:7768"
                  ];
                };
              };
            };
            extension-settings = {
              ...
            };
          };
          profile1 = {...};
        };
      '';
    };
  };

  config = {
    home.file = (builtins.listToAttrs (lib.flatten (
      lib.mapAttrsToList (profile: per-profile-settings: (
        lib.mapAttrsToList (extensionId: per-extension-settings: {
          name = "firefox-${profile}-${extensionId}";
          value = let
            relDir = "${config.programs.firefox.configPath}/${profile}/browser-extension-data/${extensionId}";
            absDir = "${config.home.homeDirectory}/${relDir}";
          in {
            target = "${relDir}/_storage_.js";
            text = builtins.toJSON per-extension-settings.storage;
            onChange = ''
              if [[ -e ${absDir}/storage.js ]]; then
                ${pkgs.yq-go}/bin/yq -i ea '. as $item ireduce ({}; . * $item )' ${absDir}/storage.js ${absDir}/_storage_.js
              else
                cat ${absDir}/_storage_.js &gt; ${absDir}/storage.js
              fi
            '';
          };
        }) per-profile-settings.browser-extension-data
      )) config.firefox-extensions
    ))) // (
      lib.mapAttrs' (profile: per-profile-settings: {
        name = "firefox-${profile}-extension-settings";
        value = let
          relDir = "${config.programs.firefox.configPath}/${profile}";
          absDir = "${config.home.homeDirectory}/${relDir}";
        in {
          target = "${relDir}/_extension-settings_.json";
          text = builtins.toJSON ({
            version = 3;
          } // per-profile-settings.extension-settings);
          onChange = ''
            if [[ -e ${absDir}/extension-settings.json ]]; then
              ${pkgs.yq-go}/bin/yq -i ea '. as $item ireduce ({}; . * $item )' ${absDir}/extension-settings.json ${absDir}/_extension-settings_.json
            else
              cat ${absDir}/_extension-settings_.json &gt; ${absDir}/extension-settings.json
            fi
          '';
        };
      }) config.firefox-extensions
    );

    programs.firefox.profiles = lib.mapAttrs (profile: _: {
      settings = {
        "extensions.webextensions.ExtensionStorageIDB.enabled" = false;
      };
    }) config.firefox-extensions;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># TIPS (https://github.com/piroor/treestyletab/wiki/How-to-inspect-tree-of-tabs):
# How to start debugger?
# 1. Type about:debugging into the address bar and hit the Enter key.
# 2. Choose "This Firefox" at the left pane.
# 3. Find "Tree Style Tab" from the list and click the Inspect button.
# 4. Then a debugger tab is opened.
#
# How to inspect the sidebar?
# 1. Start the debugger for TST.
# 2. On the top-right corner of the debugger window, there are some buttons, so click the Select an iframe as the currently targeted document button.
# 3. Choose /sidebar/sidebar.html from the list.
#   3.1. If you are opening multiple browser windows with their sidebar, you'll see multiple entries in the list.
#   3.2. /sidebar/sidebar.html items are sorted by the order they are initialized. If you hope to inspect the sidebar in the first browser window, you should choose first /sidebar/sidebar.html item in the list.
# 4. Choose the Inspector tab.

{ pkgs, ... }: let
  sidebery = pkgs.nur.repos.rycee.firefox-addons.sidebery;
in {
  programs.firefox = {
    profiles.xieby1 = {
      extensions.packages = [ sidebery ];
      # transparent floating sidebar
      # Why not use it?
      # Because: I tried two ways to adjust the height of sidebar dynamically, but all failed:
      # * user.js cannot inject js code
      # * css counter cannot used in height
      #
      #settings = {
      #  "browser.tabs.allow_transparent_browser" = true;
      #};
      #userChrome = ''
      #  #sidebar-box {
      #    height: 90%;
      #    top: 5%;
      #    right: 0;
      #    position: absolute;
      #    z-index: 99;
      #  }
      #  #browser,
      #  tabbox#tabbrowser-tabbox,
      #  #tabbrowser-tabpanels,
      #  #sidebar-box,
      #  #sidebar,
      #  window#webextpanels-window {
      #    background-color: transparent !important;
      #    background-image: none !important;
      #  }
      #'';
      #userContent = ''
      #  @-moz-document regexp("^moz-extension://.*/sidebar/sidebar.html") {
      #    :root {
      #      background-color: transparent !important;
      #    }
      #    #root.root {
      #      --frame-bg: transparent !important;
      #      --toolbar-bg: black !important;
      #      --frame-el-bg: black !important;
      #    }
      #  }
      #'';
      settings = {
        "sidebar.position_start" = false; # sidebar on the right
      };
      userChrome = ''
        /* Completely Remove Firefox Tab Bar */
        /* https://bricep.net/completely-remove-firefox-tab-bar/ */
        #TabsToolbar { visibility: collapse !important; }

        #sidebar-header { display: none; }
        #sidebar-splitter { display: none; }
        #sidebar-box {
          width: 13vw !important;
          min-width: 8em !important;
          max-width: 15em !important;
          padding: 0 !important;
        }
      '';
    };
  };

  firefox-extensions.xieby1 = {
    extension-settings = {
      commands = {
        # toggle sidebery
        _execute_sidebar_action = { precedenceList = [{
           id = sidebery.addonId;
           installDate = 0;
           value = { shortcut = "F1"; };
           enabled = true;
        }];};
        search = { precedenceList = [{
          id = sidebery.addonId;
          installDate = 0;
          value = { shortcut = "F2"; };
          enabled = true;
        }];};
        up_shift = { precedenceList = [{
          id = sidebery.addonId;
          installDate = 0;
          value = { shortcut = "Alt+Shift+Left"; };
          enabled = true;
        }];};
        down_shift = { precedenceList = [{
          id = sidebery.addonId;
          installDate = 0;
          value = { shortcut = "Alt+Shift+Right"; };
          enabled = true;
        }];};
        rm_tab_on_panel = { precedenceList = [{
          id = sidebery.addonId;
          installDate = 0;
          value = { shortcut = "Alt+Shift+Delete"; };
          enabled = true;
        }];};
        switch_to_next_tab = { precedenceList = [{
          id = sidebery.addonId;
          installDate = 0;
          value = { shortcut = "Alt+Shift+Down"; };
          enabled = true;
        }];};
        switch_to_prev_tab = { precedenceList = [{
          id = sidebery.addonId;
          installDate = 0;
          value = { shortcut = "Alt+Shift+Up"; };
          enabled = true;
        }];};
      };
    };
  };
  firefox-extensions.xieby1.browser-extension-data."${sidebery.addonId}" = {
    storage = {
      sidebarCSS = /*css*/ ''
        #root.root {
          /* make vertical line more clear */
          /* original: --tabs-lvl-opacity: 0.16 */
          --tabs-lvl-opacity: 0.8;
          /* white border for activated tab */
          --tabs-activated-shadow: 0 0 0 1px white;
        }
        /* make sure the top tab shadow (--tabs-activated-shadow) is not clipped */
        /* Why not using border?
           Because border will add size to the div, thus changing the layout.
           As a result, the vertical line is not aligned.
        */
        .AnimatedTabList { padding-top: 1px; }

        /* compact fav margin */
        .Tab[data-pin="false"] .fav {
          /* original: 0 var(--tabs-inner-gap)0 calc(var(--tabs-inner-gap) + 2px); */
          margin: 0;
        }
      '';
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, lib, ... }: let
  smart-toc = pkgs.nur.repos.rycee.firefox-addons.buildFirefoxXpiAddon {
    pname = "smart-toc";
    version = "0.11.25";
    addonId = "{40289693-01fe-4740-91ae-07344bf5b09b}";
    url = "https://addons.mozilla.org/firefox/downloads/file/4485577/smart_toc-0.11.25.xpi";
    sha256 = "17jpqy2qs3qc1m9l4kbqw14m5bkwfzb253wpf1x1b5p9q6sap8w8";
    meta = with lib; {
      mozPermissions = [
        "activeTab"
        "scripting"
        "storage"
        "tabs"
        "*://*/*"
        "file:///*"
      ];
      platforms = platforms.all;
    };
  };
in {
  programs.firefox = {
    profiles.xieby1 = {
      extensions.packages = [ smart-toc ];
    };
  };
  firefox-extensions.xieby1 = {
    extension-settings = {
      commands = {
        toggle = {precedenceList = [{
          id = smart-toc.addonId;
          installDate = 0;
          value = { shortcut = "Alt+E"; };
          enabled = true;
        }];};
      };
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, ... }: let
  inherit (pkgs.nur.repos.rycee.firefox-addons) smartproxy;
in {
  programs.firefox = {
    profiles.xieby1 = {
      extensions.packages = [ smartproxy ];
    };
  };
  firefox-extensions.xieby1 = {
    browser-extension-data."${smartproxy.addonId}" = {
      storage = {
        activeProfileId = "InternalProfile_SmartRules";
        defaultProxyServerId = "defaultProxyServerId";
        proxyServers = [{
          name = "nix";
          id = "defaultProxyServerId";
          order = 0;
          host = "127.0.0.1";
          port = config.proxyPort;
          protocol = "HTTP";
          username = "";
          password = "";
          proxyDNS = true;
          failoverTimeout = null;
        }];
        proxyProfiles = [{
          profileName = "Smart Proxy";
          profileId = "InternalProfile_SmartRules";
          profileProxyServerId = "defaultProxyServerId";
          profileType = 2;
          enabled = true;
          rulesSubscriptions = [{
            enabled = true;
            refreshRate = 6000;
            id = "gfwlist";
            name = "gfwlist";
            url = "https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt";
            obfuscation = "Base64";
            format = 0;
            applyProxy = 1;
            username = "";
            password = "";
          }];
          profileTypeConfig =  {
            builtin = true;
            editable = true;
            selectable = true;
            supportsSubscriptions = true;
            supportsProfileProxy = true;
            customProxyPerRule = true;
            canBeDisabled = true;
            supportsRuleActionWhitelist = true;
            defaultRuleActionIsWhitelist = false;
          };
        }];
      };
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, lib, ... }: let
  inherit (pkgs.nur.repos.rycee.firefox-addons) vimium;
in {
  programs.firefox = {
    profiles.xieby1 = {
      extensions.packages = [
        vimium
      ];
    };
  };

  home.file.vimium_sql = let
    # retrieve json:
    # sqlite3 storage-sync-v2.sqlite "SELECT data FROM storage_sync_data WHERE ext_id='{d7742d87-e61d-4b78-b8a1-b469842139fa}';"
    json = /*json*/ ''{
      "exclusionRules": [{
        "passKeys": "",
        "pattern": "*:77[0-9][0-9]*"
      }],
      "settingsVersion": "${lib.removePrefix "vimium-" vimium.name}"
    }'';
    relDir = "${config.programs.firefox.profilesPath}/xieby1";
    absDir = "${config.home.homeDirectory}/${relDir}";
    relTarget = "${relDir}/browser-extension-data/${vimium.addonId}/sql";
    absTarget = "${config.home.homeDirectory}/${relTarget}";
  in {
    text = /*sql*/ "UPDATE storage_sync_data SET data = '${json}' WHERE ext_id = '${vimium.addonId}';";
    target = relTarget;
    onChange = /*bash*/ ''
      if [[ -e ${absDir}/storage-sync-v2.sqlite ]]; then
        echo ⛁ updating vimium settings in ${absDir}/storage-sync-v2.sqlite
        ${pkgs.sqlite}/bin/sqlite3 ${absDir}/storage-sync-v2.sqlite &lt; ${absTarget}
      else
        echo ⛃ next time update vimium settings in ${absDir}/storage-sync-v2.sqlite
        rm ${absTarget}
      fi
    '';
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p>Advanced screenshot: flameshot</p>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.flameshot
  ];
  dconf.settings = {
    "org/gnome/shell/keybindings" = {
      screenshot = [];
      screenshot-window = [];
      show-screen-recording-ui = [];
      show-screenshot-ui = ["&lt;Shift&gt;Print"];
    };
    "org/gnome/settings-daemon/plugins/media-keys".custom-keybindings = [
      "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/flameshot/"
    ];
    "org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/flameshot" = {
      binding="Print";
      command="${pkgs.flameshot}/bin/flameshot gui";
      name="flameshot";
    };
  };
  home.file.autostart_flameshot = {
    source = "${pkgs.barrier}/share/applications/org.flameshot.Flameshot.desktop";
    target = ".config/autostart/org.flameshot.Flameshot.desktop";
  };
  systemd.user.tmpfiles.rules = [
    "L? %h/.config/flameshot/flameshot.ini - - - - %h/Gist/Config/flameshot.ini"
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, ... }: {
  imports = [
    ./module.nix
    { # my private calendars
      gnome-calendar = let
        caldavs = "${config.home.homeDirectory}/Gist/Vault/caldavs.nix";
      in if builtins.pathExists caldavs then import caldavs else {};
    }
  ];

  # public calendars
  gnome-calendar = {
    china_calendar = {
      # 包含所有类型日历（暂时除农历、天干地支）(时间段版本)
      url = "https://yangh9.github.io/ChinaCalendar/calendar_1.ics";
      settings = {
        Calendar = {
          Color = "#82B366";
        };
        # do not show notifications for this calendar
        Alarms = {
          IncludeMe = false;
          ForEveryEvent = false;
        };
      };
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gnome-calendar-module"><a class="header" href="#gnome-calendar-module">gnome-calendar module</a></h1>
<pre><code class="language-nix">{ config, pkgs, lib, ... }: {
  options = {
    gnome-calendar = lib.mkOption {
      # entry type
      type = lib.types.attrsOf (lib.types.submodule {
        options = {
          url = lib.mkOption {
            type = lib.types.str;
            default = "";
          };
          settings = lib.mkOption {
            type = lib.types.attrs;
            default = {};
          };
        };
      });
      default = {};
      description = ''
        Attrs of calendars settings.

        gnome-calendar = {
          calendar1 = {
            url = "...calendar1.ics";
            settings = {...calendar1 settings...}
          };
          calendar2 = {
            url = "...calendar2.ics";
            settings = {...calendar2 settings...}
          };
          ...
        };
      '';
    };
  };

  config = {
    # Available options: &lt;evolution-data-server&gt;/glib-2.0/schemas/org.gnome.evolution-data-server.calendar.gschema.xml
    dconf.settings."org/gnome/evolution-data-server/calendar" = {
      # Currently, cannot use audio, otherwise no notification pops out.
      # * https://gitlab.gnome.org/GNOME/gnome-calendar/-/issues/1226
      #   * https://gitlab.gnome.org/GNOME/gnome-calendar/-/issues/1280
      notify-enable-audio = false;
      notify-enable-display = true;

      # Default reminder for all events in chosen calendars
      defall-reminder-enabled = true;
      # defall-reminder-interval = 15
      # defall-reminder-units = minutes
    };
    home.file = lib.mapAttrs (name: entry:
      let
        parseUrl = urlString:
        let
          protocolSplit = lib.strings.splitString "://" urlString;
          protocol = builtins.head protocolSplit;
          afterProtocol = builtins.elemAt protocolSplit 1;
          hostPathSplit = lib.strings.splitString "/" afterProtocol;
          host = builtins.head hostPathSplit;
          path = "/" + lib.strings.concatStringsSep "/" (builtins.tail hostPathSplit);
        in {
          inherit protocol host path;
          port = if protocol == "http" then 80
            else if protocol == "https" then 443
            else throw "unknown protocol: ${protocol}";
          security = if protocol == "https" then "tls"
            else "";
        };
        parsedUrl = parseUrl entry.url;
        mergeCfg = lib.foldl lib.recursiveUpdate {};
        cal_cfg = mergeCfg [
          (import ./template.nix)
          {
            "Data Source" = {
              DisplayName = name;
            };
            Authentication = {
              Host=parsedUrl.host;
              Port=parsedUrl.port;
            };
            Security = {
              Method=parsedUrl.security;
            };
            "WebDAV Backend" = {
              ResourcePath=parsedUrl.path;
            };
          }
          entry.settings
        ];
        src = (pkgs.formats.ini {}).generate "${name}.source" cal_cfg;
        dst = "${config.home.homeDirectory}/.config/evolution/sources/${name}.source";
      # Why not using yq, due to Color=#xxxxxx, '#' will be identified as comment, and be striped
      in rec {
        target = ".config/evolution/sources/${name}.source.onChange";
        source = (pkgs.formats.ini {}).generate "${name}.source" cal_cfg;
        onChange = ''
          sed 's/LastNotified=.*/LastNotified='$(date -u +"%Y-%m-%dT%H:%M:%SZ")'/g' \
            ${target} &gt; ${lib.removeSuffix ".onChange" target}
        '';
      }
    ) config.gnome-calendar;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{
  "Data Source" = {
    DisplayName = "toBeFilled";
    Enabled=true;
    Parent="webcal-stub";
  };
  Authentication = {
    Host= "toBeFilled";
    Method="plain/password";
    Port=443;
    ProxyUid="system-proxy";
    RememberPassword=true;
    User="";
    CredentialName="";
    IsExternal=false;
  };
  Security = {
    Method="tls";
  };
  "WebDAV Backend" = {
    AvoidIfmatch=false;
    CalendarAutoSchedule=false;
    Color="";
    DisplayName="";
    EmailAddress="";
    ResourcePath= "toBeFilled";
    ResourceQuery="";
    SslTrust="";
    Order=4294967295;
    Timeout=90;
  };
  Calendar = {
    BackendName="webcal";
    Color = "#B85450";
    Selected=true;
    Order=0;
  };
  Offline = {
    StaySynchronized=true;
  };
  Refresh = {
    Enabled=true;
    EnabledOnMeteredNetwork=true;
    IntervalMinutes=30;
  };
  Alarms = {
    IncludeMe=true;
    # LastNotified="2025-02-24T13:27:00Z";
    LastNotified="";
    ForEveryEvent=true;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p>Gnome settings</p>
<pre><code class="language-nix">{ config, pkgs, lib, ... }: {
  imports = [
    ./calendar
    ./extensions
  ];
  home.packages = with pkgs; [
    gnome-sound-recorder
    dconf-editor
    devhelp
  ];

  # Setting: `gsettings set &lt;key(dot)&gt; &lt;value&gt;`
  # Getting: `dconf dump /&lt;key(path)&gt;`
  dconf.settings = {
    "org/gnome/shell" = {
      ## dock icons
      favorite-apps = [
        "org.gnome.Nautilus.desktop"
        "firefox.desktop"
        "firefox-single-tab.desktop"
        "chromium-browser.desktop"
        "spotify.desktop"
      ];
    };
    "org/gnome/shell/keybindings" = {
      # disable original super+A
      toggle-application-view = [];
    };

    "org/gnome/desktop/session" = {
      idle-delay=lib.hm.gvariant.mkUint32 0; # never turn off screen
    };
    "org/gnome/settings-daemon/plugins/power" = {
      ambient-enabled=false;
      idle-dim=false;
      power-button-action="nothing";
      sleep-inactive-ac-timeout=3600;
      sleep-inactive-ac-type="nothing";
      sleep-inactive-battery-type="suspend";
    };

    # predefined keyboard shortcuts
    "org/gnome/desktop/wm/keybindings" = {
      switch-applications=[];
      switch-applications-backward=[];
      switch-windows=["&lt;Alt&gt;Tab"];
      switch-windows-backward=["&lt;Shift&gt;&lt;Alt&gt;Tab"];
      maximize=["&lt;Super&gt;Up"];
      unmaximize=["&lt;Super&gt;Down"];
      minimize=[];
      move-to-workspace-left=["&lt;Control&gt;&lt;Super&gt;Left"];
      move-to-workspace-right=["&lt;Control&gt;&lt;Super&gt;Right"];
      # Disable alt+space binding
      activate-window-menu=[];
    };

    # nautilus
    "org/gtk/settings/file-chooser" = {
      sort-directories-first=true;
    };

    "org/gnome/desktop/interface" = {
      enable-hot-corners=false;
      show-battery-percentage=true;
      clock-show-weekday=true;
    };

    # proxy
    "system/proxy" = {mode = "manual";};
    "system/proxy/ftp" = {host="127.0.0.1"; port=config.proxyPort;};
    "system/proxy/http" = {host="127.0.0.1"; port=config.proxyPort;};
    "system/proxy/https" = {host="127.0.0.1"; port=config.proxyPort;};

    "org/gnome/mutter" = {
      dynamic-workspaces = true;
    };
  };

  systemd.user.tmpfiles.rules = [
    "L? %h/.config/gtk-3.0/bookmarks - - - - %h/Gist/Config/nautilus_bookmarks"
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="advanced-alttab-window-switcher"><a class="header" href="#advanced-alttab-window-switcher">advanced-alttab-window-switcher</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.gnomeExtensions.advanced-alttab-window-switcher
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "advanced-alt-tab@G-dH.github.com"
      ];
    };
    "org/gnome/shell/extensions/advanced-alt-tab-window-switcher" = {
      switcher-popup-preview-selected=2;
      win-switcher-popup-filter=2;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [(
    pkgs.gnomeExtensions.auto-accent-colour.overrideAttrs (old: {
      postPatch = ''
        substituteInPlace extension.js --replace "gjs" "${pkgs.gjs}/bin/gjs"
      '';
    })
  )];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "auto-accent-colour@Wartybix"
      ];
    };
    "org/gnome/shell/extensions/auto-accent-colour" = {
      hide-indicator = true;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bingwallpaper"><a class="header" href="#bingwallpaper">BingWallpaper</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.gnomeExtensions.bing-wallpaper-changer
    # random-wallpaper-wip-v3
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "BingWallpaper@ineffable-gmail.com"
        # "randomwallpaper@iflow.space"
      ];
    };
    "org/gnome/shell/extensions/bingwallpaper" = {
      market="zh-CN";
      delete-previous=true;
      download-folder="/tmp/pictures";
    };
    # "org/gnome/shell/extensions/space-iflow-randomwallpaper" = {
    #   auto-fetch = true;
    #   change-lock-screen = true;
    #   hours = 8;
    #   minutes = 29;
    #   source = "genericJSON";
    #   # source = "wallhaven";
    # };
    # "org/gnome/shell/extensions/space-iflow-randomwallpaper/genericJSON" = {
    #   generic-json-request-url = "http://www.bing.com/HPImageArchive.aspx?format=js&amp;idx=0&amp;n=1&amp;mkt=zh-CN";
    #   generic-json-response-path = "$.images[0].url";
    #   generic-json-url-prefix = "http://www.bing.com";
    # };
    # "org/gnome/shell/extensions/space-iflow-randomwallpaper/wallhaven" ={
    #   wallhaven-keyword="cardcaptor sakura";
    # };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bluetooth-battery-meter"><a class="header" href="#bluetooth-battery-meter">bluetooth battery meter</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.gnomeExtensions.bluetooth-battery-meter
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "Bluetooth-Battery-Meter@maniacx.github.com"
      ];
    };
    "org/gnome/shell/extensions/Bluetooth-Battery-Meter" = {
      enable-battery-level-text = true;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dash-to-dock"><a class="header" href="#dash-to-dock">dash-to-dock</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.gnomeExtensions.dash-to-dock
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "dash-to-dock@micxgx.gmail.com"
      ];
    };
    "org/gnome/shell/extensions/dash-to-dock" = {
      intellihide-mode="ALL_WINDOWS";
      # DOTS support at most 4 windows counting,
      # BINARY supports at most 2^4-1 windows counting
      running-indicator-style="BINARY";
      custom-theme-customize-running-dots=true;
      custom-theme-running-dots-border-color="rgb(0,0,0)";
      custom-theme-running-dots-border-width=4;
      custom-theme-running-dots-color="rgb(255,255,255)";

      click-action="focus-or-appspread";
      transparency-mode = "FIXED";
      background-opacity = 0.4;
      shortcut=["&lt;Shift&gt;&lt;Super&gt;h"];
      shortcut-text="&lt;Super&gt;&lt;Shift&gt;h";
      scroll-action="cycle-windows";
      shift-click-action="launch";
      middle-click-action="previews";
      # shift-middle-click-action="launch";
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gnome-extensions"><a class="header" href="#gnome-extensions">Gnome Extensions</a></h1>
<p>Each time home-manager switched, no need log out.
Just reload extension by <alt>+F2 r</p>
<pre><code class="language-nix">{ pkgs, ... }: {
  imports = [
    ./advanced-alttab-window-switcher.nix
    ./bing-wallpaper-changer.nix
    ./bluetooth-battery-meter.nix
    ./dash-to-dock.nix
    ./gtile.nix
    ./hide-top-bar.nix
    ./pano.nix
    ./system-monitor.nix
    ./transparent-top-bar.nix
    ./unite.nix
    ./lunar-calendar.nix
    ./auto-accent-colour.nix
  ];
  home.packages = with pkgs.gnomeExtensions; [
    always-show-titles-in-overview
    x11-gestures
  ] ++ [
    pkgs.gnome45Extensions."permanent-notifications@bonzini.gnu.org"
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      disable-extension-version-validation = true;
      ## enabled gnome extensions
      disable-user-extensions = false;
      disabled-extensions = [];
      enabled-extensions = [
        "Always-Show-Titles-In-Overview@gmail.com"
        "x11gestures@joseexposito.github.io"
        "permanent-notifications@bonzini.gnu.org"
      ];
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="customize-ibus-input-method-customization"><a class="header" href="#customize-ibus-input-method-customization">customize-ibus: input method customization</a></h1>
<pre><code class="language-nix">{ pkgs, lib, ... }: {
  home.packages = [
    pkgs.gnomeExtensions.customize-ibus
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "customize-ibus@hollowman.ml"
      ];
    };
    "org/gnome/desktop/input-sources" = {
      sources = with lib.hm.gvariant; mkArray
      "(${lib.concatStrings [type.string type.string]})" [
        (mkTuple ["xkb"  "us"])
        (mkTuple ["ibus" "rime"])
        (mkTuple ["ibus" "mozc-jp"])
        (mkTuple ["ibus" "hangul"])
      ];
    };
    "org/gnome/shell/extensions/customize-ibus" = {
      candidate-orientation = lib.hm.gvariant.mkUint32 1;
      custom-font="Iosevka Nerd Font 16";
      enable-orientation=true;
      input-indicator-only-on-toggle=false;
      input-indicator-only-use-ascii=false;
      use-custom-font=true;
      use-indicator-show-delay=true;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gtile-tiled-windows-manager"><a class="header" href="#gtile-tiled-windows-manager">gtile: tiled windows manager</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.gnomeExtensions.gtile
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "gTile@vibou"
      ];
    };
    "org/gnome/shell/extensions/gtile" = {
      animation=true;
      global-presets=true;
      grid-sizes="16x10";
      preset-resize-1=["&lt;Super&gt;bracketleft"];
      preset-resize-2=["&lt;Super&gt;bracketright"];
      preset-resize-3=["&lt;Super&gt;comma"];
      preset-resize-4=["&lt;Super&gt;period"];
      preset-resize-5=["&lt;Super&gt;semicolon"];
      preset-resize-6=["&lt;Super&gt;apostrophe"];
      preset-resize-7=["&lt;Super&gt;slash"];
      resize1="2x2 1:1 1:1";
      resize2="2x2 2:1 2:1";
      resize3="2x2 1:2 1:2";
      resize4="2x2 2:2 2:2";
      resize5="4x8 2:2 3:7";
      resize6="1x2 1:1 1:1";
      resize7="1x2 1:2 1:2";
      show-icon=false;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hide-top-bar"><a class="header" href="#hide-top-bar">hide-top-bar</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.gnomeExtensions.hide-top-bar
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "hidetopbar@mathieu.bidon.ca"
      ];
    };
    "org/gnome/shell/extensions/hidetopbar" = {
      mouse-sensitive = true;
      enable-active-window=false;
      enable-intellihide=true;
      # enable shortcut &lt;Super&gt;+v show nofication list, &lt;Super&gt;+s show quick settings, and so on
      keep-round-corners=true;
      shortcut-delay = 0.0;
      shortcut-keybind = ["&lt;Super&gt;h"];
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = with pkgs.gnomeExtensions; [
    lunar-calendar
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "lunarcal@ailin.nemui"
      ];
    };
    "org/gnome/shell/extensions/lunar-calendar" = {
      # 日历内的节日
      jrrilinei = true;
      # 顶栏日期
      show-date = true;
      # 顶栏时间
      show-time = false;
      # 语言：大陆
      yuyan = 0;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="pano-next-gen-clipboard-manager-for-gnome-shell"><a class="header" href="#pano-next-gen-clipboard-manager-for-gnome-shell">pano: Next-gen Clipboard Manager for Gnome Shell</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.gnomeExtensions.pano
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "pano@elhan.io"
      ];
    };
    "org/gnome/shell/extensions/pano" = {
      play-audio-on-copy=false;
      send-notification-on-copy=false;
      paste-on-select=false;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="system-monitor"><a class="header" href="#system-monitor">system-monitor</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    # replace system-monitor(-next) with vitals
    # refers to https://github.com/mgalgs/gnome-shell-system-monitor-applet/issues/57
    # vitals
    pkgs.gnomeExtensions.system-monitor-next
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        # "Vitals@CoreCoding.com"
        "system-monitor-next@paradoxxx.zero.gmail.com"
      ];
    };
    # "org/gnome/shell/extensions/vitals" = {
    #   fixed-widths = true;
    #   hide-icons = true;
    #   hot-sensors = [
    #     "_processor_usage_"
    #     "_memory_usage_"
    #     "__network-rx_max__"
    #     "__network-tx_max__"
    #   ];
    #   show-fan = false;
    #   show-system = false;
    #   show-temperature = false;
    #   show-voltage = false;
    #   update-time = 2;
    # };
    "org/gnome/shell/extensions/system-monitor-next-applet" = {
      compact-display = true;
      icon-display = false;
      swap-display = true;
      cpu-style = "digit";
      memory-style = "digit";
      net-style = "digit";
      swap-style = "digit";
      cpu-show-text = false;
      memory-show-text = false;
      net-show-text = false;
      swap-show-text = false;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="transparent-top-bar-able-to-adjust-transparency"><a class="header" href="#transparent-top-bar-able-to-adjust-transparency">transparent-top-bar: able to adjust transparency</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.gnomeExtensions.transparent-top-bar-adjustable-transparency
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "transparent-top-bar@ftpix.com"
      ];
    };
    "com/ftpix/transparentbar" = {
      dark-full-screen = false;
      transparency = 40;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="unite-unite-style"><a class="header" href="#unite-unite-style">unite: unite style</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.gnomeExtensions.unite
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [ "unite@hardpixel.eu" ];
    };
    "org/gnome/shell/extensions/unite" = {
      app-menu-ellipsize-mode="end";
      extend-left-box=false;
      greyscale-tray-icons=false;
      hide-app-menu-icon=false;
      hide-dropdown-arrows=true;
      hide-window-titlebars="always";
      notifications-position="center";
      reduce-panel-spacing=true;
      show-window-buttons="always";
      use-activities-text = false;
      window-buttons-placement="last";
      window-buttons-theme="materia";
      restrict-to-primary-screen=false;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="kde-connect"><a class="header" href="#kde-connect">KDE Connect</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  mykdeconnect = pkgs.plasma5Packages.kdeconnect-kde;
</code></pre>
<p>This customized version of KDE Connect allow share PC's keyboard smoothly to android.</p>
<pre><code class="language-nix">  #mykdeconnect = pkgs.kdeconnect.overrideAttrs (old: {
  #  patches = [( pkgs.fetchpatch {
  #    url = "https://raw.githubusercontent.com/xieby1/kdeconnect-kde-enhanced/4610431b932b2fab05d7e0fc55e7306dc7ff0910/diff.patch";
  #    hash = "sha256-NL/TVOMEhdJ/W7UTxjF7Qjnq7JciNvl08BC1wrBfvHo=";
  #  })];
  #  # cmakeFlags = "-DCMAKE_BUILD_TYPE=Debug -DQT_FORCE_STDERR_LOGGING=1";
  #});
in {
  home.packages = [
    mykdeconnect
  ];
</code></pre>
<p>Auto startup KDE Connect after Gnome GUI login.</p>
<pre><code class="language-nix">  home.file.kde_connect_indicator = {
    source = "${mykdeconnect}/share/applications/org.kde.kdeconnect.nonplasma.desktop";
    target = ".config/autostart/org.kde.kdeconnect.nonplasma.desktop";
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="kitty"><a class="header" href="#kitty">kitty</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
{
  # Terminal Comparsion
  # * gnome-terminal
  #   * Pros
  #   * Cons
  #     * Wrong window size, when window is tiled (e.g. use gTile)
  #     * Icon display incorrectly (e.g. Vim-vista)
  #     * It's hard to hide top bar
  # * alacritty
  #   * Pros
  #     * Esay configurable
  #     * Icon display correctly (e.g. Vim-vista)
  #     * input method fcitx works
  #   * Cons
  #     * Not native tab support
  #       https://github.com/alacritty/alacritty/issues/3129
  #       The developer(s?) with poor attitude
  #       * Compromise: tabbed
  #     * Alacritty is not work with espanso
  #       https://github.com/federico-terzi/espanso/issues/787
  #       https://github.com/federico-terzi/espanso/issues/1088
  #       In espanso auto mode, alacritty definitely will be stucked.
  #       In clipboard, alacritty may be stucked.
  #     * emoji display poorly.
  # * kitty
  #   * Pros
  #     * Esay configurable
  #   * Cons
  #     * Icon display incorrectly (e.g. Vim-vista)
  #     * input method support solved by fcitx5
  # * hyper
  #   * Cons
  #     * scroll speed is too fast!

  imports = [
    ./timer.nix
    ./search.nix
  ];

  # shortcuts
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys".custom-keybindings = [
    "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/kitty/"
    "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/fzf-doc/"
    "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/fzf-doc-background/"
  ];
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/kitty" = {
    binding="&lt;Primary&gt;&lt;Alt&gt;t";
    command = "kitty";
    name="terminal";
  };
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/fzf-doc" = {
    binding="&lt;Super&gt;f";
    # bash alias needs interative bash (-i)
    # https://askubuntu.com/questions/1109564/alias-not-working-inside-bash-shell-script
    command="kitty bash -i fzf-doc";
    name="fzf-doc";
  };

  programs.kitty = {
    enable = true;
    environment = {
      "TERM" = "xterm";
    };
    font = {
      name = "";
      size = 16;
    };
    settings = {
      allow_remote_control = "yes";
      listen_on = "unix:/tmp/mykitty";

      hide_window_decorations = "yes";
      cursor_blink_interval = "0.8";
      remember_window_size = "no";
      initial_window_width = "80c";
      initial_window_height = "20c";

      # tab
      tab_bar_edge = "top";
      tab_bar_style = "separator";
      # tab_separator = " ┇"; This is default, a space before the vertical line
      active_tab_foreground   = "#e2e2e3";
      active_tab_background   = "#2c2e34";
      active_tab_title_template = "🐱{fmt.fg.red}{bell_symbol}{activity_symbol}{fmt.fg.tab}{title}";
      inactive_tab_foreground = "#2c2e34";
      inactive_tab_background = "#e2e2e3";

      # tango dark
      background              = "#2c2e34";
      foreground              = "#e2e2e3";
      cursor                  = "#e2e2e3";
      color0                  = "#2c2e34";
      color8                  = "#555753";
      color1                  = "#cc0000";
      color9                  = "#ef2929";
      color2                  = "#4e9a06";
      color10                 = "#8ae234";
      color3                  = "#c4a000";
      color11                 = "#fce94f";
      color4                  = "#3465a4";
      color12                 = "#729fcf";
      color5                  = "#75507b";
      color13                 = "#ad7fa8";
      color6                  = "#06989a";
      color14                 = "#34e2e2";
      color7                  = "#e2e2e3";
      color15                 = "#eeeeec";
      # selection_foreground    = "#2c2e34";
      # selection_background    = "#e2e2e3";
    };
    extraConfig = ''
      map ctrl+equal change_font_size all +2.0
      map ctrl+plus change_font_size all +2.0
      map ctrl+kp_add change_font_size all +2.0
      map ctrl+minus change_font_size all -2.0
      map ctrl+kp_subtract change_font_size all -2.0
      map ctrl+0 change_font_size all 0

      map ctrl+shift+t new_tab_with_cwd
      map ctrl+shift+n new_os_window_with_cwd

      # disable opening of URLs with a plain click
      mouse_map left click ungrabbed no_op

      #: asks which tab to move the window into
      map f2 detach_window ask


      action_alias launch_window launch --cwd=current
      # Window layout
      enabled_layouts splits

      # Split and Create a new window
      map f5 launch_window --location=hsplit
      map f6 launch_window --location=vsplit

      # Goto window
      map alt+left neighboring_window left
      map alt+right neighboring_window right
      map alt+up neighboring_window up
      map alt+down neighboring_window down
    '';
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: let
  kitty-kitten-search = pkgs.runCommand "kitty-kitten-search" {
    src = pkgs.fetchFromGitHub {
      owner = "trygveaa";
      repo = "kitty-kitten-search";
      rev = "0760138fad617c5e4159403cbfce8421ccdfe571";
      hash = "sha256-egisza7V5dWplRYHIYt4bEQdqXa4E7UhibyWJAup8as=";
    };
  } ''
    mkdir $out
    cp $src/scroll_mark.py $out/scroll_mark.py
    sed 's/typing/typing_compat/' $src/search.py &gt; $out/search.py
  '';
in {
  home.file.kitty_search = {
    source = "${kitty-kitten-search}/search.py";
    target = ".config/kitty/search.py";
  };
  home.file.kitty_scroll_mark = {
    source = "${kitty-kitten-search}/scroll_mark.py";
    target = ".config/kitty/scroll_mark.py";
  };
  programs.kitty = {
    extraConfig = ''
      map ctrl+shift+f launch --location=hsplit --allow-remote-control kitty +kitten search.py @active-kitty-window-id
    '';
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ lib, ... }: {
  ## after direnv's bash.initExtra
  programs.bash.initExtra = lib.mkOrder 2000 ''
    # https://stackoverflow.com/questions/1862510/how-can-the-last-commands-wall-time-be-put-in-the-bash-prompt
    function timer_start {
      _timer=''${_timer:-$SECONDS}
    }
    function timer_stop {
      last_timer=$(($SECONDS - $_timer))
      unset _timer

      _notification="[''${last_timer}s⏰] Job finished!"
      if [[ "$TERM" =~ tmux ]]; then
        # https://github.com/tmux/tmux/issues/846
        printf '\033Ptmux;\033\x1b]99;;%s\033\x1b\\\033\\' "$_notification"
      else
        printf '\x1b]99;;%s\x1b\\' "$_notification"
      fi
    }
  '';
  programs.kitty = {
    extraConfig = ''
      # Notify when a long running command is finished
      ## https://github.com/kovidgoyal/kitty/issues/1892
      map f1 send_text all \x1a timer_start; fg; timer_stop \r
    '';
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># https://nixos.org/manual/nixos/stable/#sec-writing-modules
# refers to syncthing module

# list options:
#   home-manager option xdg.mime.types.\"*\"
#   nixos option
{ config
, lib
, pkgs
, ...
}:
with lib;
let
  cfg = config.xdg.mime.types;
in
{
  options = {
    xdg.mime.types = mkOption {
      default = {};
      description = "Set MIME types and default applications.";
      example = ''
        xdg.mime.types.dot = {
          name = "graphviz-dot";
          type = "text/graphviz-dot";
          pattern = "*.dot";
          defaultApp = "xdot.desktop";
        };
      '';
      type = types.attrsOf (types.submodule ({name, ...}:
      {
        options = {
          name = mkOption {
            type = types.str;
            default = name;
            description = "The name of the xml file.";
          };
          type = mkOption {
            type = types.str;
            default = "";
            description = "The mime-type.";
          };
          pattern = mkOption {
            type = types.str;
            default = "";
            description = "The glob pattern.";
          };
          defaultApp = mkOption {
            type = types.str;
            default = "";
            description = "Default application for opening this MIME type.";
          };
        };
      }));
    };
  };

  # builtins.mapAttrs (n: v: {wang=v.miao;}) {file1={miao=1;}; file2={miao=2;};}
  # =&gt; {file1={wang=1;}; file2={wang=2;};}
  config = {
    home.file = builtins.mapAttrs (n: v: {
      text = ''
        &lt;?xml version="1.0"?&gt;
        &lt;mime-info xmlns='http://www.freedesktop.org/standards/shared-mime-info'&gt;
          &lt;mime-type type="${v.type}"&gt;
            &lt;glob pattern="${v.pattern}"/&gt;
          &lt;/mime-type&gt;
        &lt;/mime-info&gt;
      '';
      target = ".local/share/mime-types/${v.name}.xml";
      onChange = ''
        ${pkgs.xdg-utils}/bin/xdg-mime install ~/.local/share/mime-types/${v.name}.xml
        ${pkgs.xdg-utils}/bin/xdg-mime default ${v.defaultApp} ${v.type}
      '';
    }) cfg;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    (pkgs.rofi.override { plugins = [ /*pkgs.rofi-file-browser*/ ]; })
    pkgs.wmctrl
  ];

  # gnome keyboard shortcuts
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys".custom-keybindings = [
    "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/rofi_window/"
    "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/rofi_drun/"
    "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/rofi_wm/"
  ];
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/rofi_window" = {
    binding="&lt;Super&gt;w";
    # The default -window-command is `wmctrl -i -R {window}` which is move window to current desktop
    # The only thing we need to do is to install wmctrl
    command=/*bash*/"rofi -show window -window-format '{c} {t}'";
    name="rofi window";
  };
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/rofi_drun" = {
    binding="&lt;Super&gt;d";
    command="rofi -show drun";
    name="rofi drun";
  };
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/rofi_wm" = let
    wm = pkgs.python3Packages.callPackage (pkgs.fetchFromGitHub {
      owner = "xieby1";
      repo = "rofi-wm";
      rev = "5d3a13d3293b2e3a06a528f03bdfa99db5d4fd7b";
      hash = "sha256-rWn4k2AD5vRv0Dz+K1aIOmG74Nilw5NZPs3xQCIS3Ew=";
    }) {};
  in {
    binding="&lt;Super&gt;q";
    command="rofi -show wm -modes wm:${wm}/bin/wm.py";
    name="rofi wm";
  };

  home.file.rofi_config = {
    target = ".config/rofi/config.rasi";
    text = ''
      /* This is a comment */
      /* rofi -dump-config */

      configuration {
        modes: [
          window,
          drun,
          run,
          ssh
          /* file-browser-extended */
        ];
        terminal: "kitty";
        dpi: 1;
        show-icons: true;
      }
      filebrowser {
        directory: "~/Documents";
      }

      /* man rofi-theme */

      window {
        width: 80%;
      }
    '';
  };

  # home.file.rofi_file_browser_config = let
  #   openDir = pkgs.writeScript "openDir" ''
  #     if [[ -d "$1" ]]; then
  #       xdg-open "$1"
  #     elif [[ -f "$1" ]]; then
  #       xdg-open "''${1%/*}"
  #     fi
  #   '';
  # in {
  #   target = ".config/rofi/file-browser";
  #   text = ''
  #     # This is a comment
  #     dir ~/Documents
  #     depth 0
  #     no-sort-by-type
  #     sort-by-depth

  #     # BUG: rofi -show-icons causes segmentation fault
  #     # oc-search-path
  #     # oc-cmd "nautilus"
  #     # oc-cmd "${openDir}"
  #   '';
  # };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rustdesk-the-remote-desktop-app"><a class="header" href="#rustdesk-the-remote-desktop-app">rustdesk, the remote desktop app</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
{
  home.packages = [
</code></pre>
<p>The new version of rustdesk is rustdesk-flutter,
which is cached in official nix binary cache.</p>
<pre><code class="language-nix">    pkgs.rustdesk-flutter
  ];
</code></pre>
<p>Auto startup rustdesk after Gnome GUI login.</p>
<pre><code class="language-nix">  # home.file.autostart_rustdesk_desktop = {
  #   source = "${pkgs.rustdesk-flutter}/share/applications/rustdesk.desktop";
  #   target = ".config/autostart/rustdesk.desktop";
  # };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, ... }:
# TODO: change it into a module
# TODO: split
let
  singleton = pkgs.writeShellScriptBin "singleton.sh" ''
    if [[ $# -lt 2 || $1 == "-h" ]]
    then
      echo "Usage: ''${0##*/} &lt;window&gt; &lt;command and its args&gt;"
      echo "  Only start a app once, if the app is running"
      echo "  then bring it to foreground"
      exit 0
    fi

    if [[ "$1" == "kdeconnect.app" ]]
    then
      WID=$(${pkgs.xdotool}/bin/xdotool search --classname "$1")
    else
      WID=$(${pkgs.xdotool}/bin/xdotool search --onlyvisible --name "$1")
    fi

    if [[ -z $WID ]]
    then
      eval "''${@:2}"
    else
      for WIN in $WID
      do
        CURDESK=$(${pkgs.xdotool}/bin/xdotool get_desktop)
        ${pkgs.xdotool}/bin/xdotool set_desktop_for_window $WIN $CURDESK
        ${pkgs.xdotool}/bin/xdotool windowactivate $WIN
      done
    fi
  '';
  singleton_sh = "${singleton}/bin/singleton.sh";

  # TODO: use kitty --class
  open_my_cheatsheet_md_sh = pkgs.writeShellScript "open_my_cheatsheet_md" ''
    cd ${config.home.homeDirectory}/Documents/Tech
    # Open Outline and focus on code
    kitty nvim my_cheatsheet.mkd -c Outline!
    if [[ ! -f my_cheatsheet.html || my_cheatsheet.html -ot my_cheatsheet.mkd ]]; then
      ~/Codes/MyRepos/markdown_cheatsheet/cheatsheet.sh my_cheatsheet.mkd
    fi
  '';
in
{
  xdg.desktopEntries = {
    # singleton apps
    my_cheatsheet_md = {
      name = "Cheatsheet Edit MD";
      genericName = "cheatsheet";
      exec = "${singleton_sh} my_cheatsheet.mkd ${open_my_cheatsheet_md_sh}";
      icon = builtins.toFile "cheatsheet.svg" ''
        &lt;svg width="64" height="64" xmlns="http://www.w3.org/2000/svg"&gt;
          &lt;rect width="100%" height="100%" rx="20%" ry="20%" fill="#666666"/&gt;
          &lt;text x="50%" y="50%" text-anchor="middle" dominant-baseline="middle" font-size="18" font-weight="bold" fill="#F5F5F5"&gt;
            &lt;tspan x="50%" dy="-1.0em"&gt;CS&lt;/tspan&gt;
            &lt;tspan x="50%" dy="1.0em"&gt;Edit&lt;/tspan&gt;
            &lt;tspan x="50%" dy="1.0em"&gt;MD&lt;/tspan&gt;
          &lt;/text&gt;
        &lt;/svg&gt;
      '';
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="typora"><a class="header" href="#typora">Typora</a></h1>
<p>采用nixpkgs支持的最后的typora版本，即0.9.98。</p>
<pre><code class="language-nix">mytypora = (pkgs.callPackage (pkgs.fetchurl {
  url = "https://raw.githubusercontent.com/NixOS/nixpkgs/137f19d1d48b6d7c7901bb86729a2bce3588d4e9/pkgs/applications/editors/typora/default.nix";
  sha256 = "057dk4hl4fljn50098g7l35sh7gwm7zqqqlrczv5lhmpgxi971c1";
}) {}).overrideAttrs (old: {
  src = pkgs.fetchurl {
    url = "https://web.archive.org/web/20211222112532/https://download.typora.io/linux/typora_0.9.98_amd64.deb";
    sha256 = "1srj1fdcblfdsfvdnrqnwsxd3y8qd1h45p4sf1mxn6hr7z2s6ai6";
  };
});
</code></pre>
<p>注：我尝试打包0.11.18，
发现这个版本会检测文件完整性，
因此基本上没办法用nix进行二次打包。</p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, lib, ... }: {
  home.packages = [ pkgs.warpd ];
  home.file.autostart_warpd = {
    target = ".config/autostart/warpd.desktop";
    text = ''
      [Desktop Entry]
      Type=Application
      Name=warpd
      Exec=${pkgs.warpd}/bin/warpd
    '';
  };

  # 为什么不用gnome快捷键？
  # * 一次性warpd启动比warpd后台运行慢
  # 为什么用gnome快捷键
  # * warpd没办法正确识别M-k键？或者是gnome抢了？要M-kk才行
  # dconf.settings."org/gnome/settings-daemon/plugins/media-keys".custom-keybindings = [
  #   "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/warpd-hint/"
  #   "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/warpd-normal/"
  # ];
  # dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/warpd-hint" = {
  #   binding="&lt;Super&gt;k";
  #   command = "warpd --hint";
  #   name="warpd-hint";
  # };
  # dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/warpd-normal" = {
  #   binding="&lt;Alt&gt;k";
  #   command = "warpd --normal";
  #   name="warpd-normal";
  # };
  home.file.warpd_config = {
    target = ".config/warpd/config";
    # Available options see `warpd --list-options`.
    # Available modifiers (according to warpd source code):
    # * alt: A-
    # * super/meta: M-
    # * shift: S-
    # * ctrl: C-
    # Available X11 key names by removing "XK_" prefix in ${pkgs.xorg.xorgproto}/include/X11/keysymdef.h
    text = lib.generators.toKeyValue {mkKeyValue=lib.generators.mkKeyValueDefault {} ": ";} {
      activation_key = "A-M-z"; # 一只手按A-M-z比A-M-c更方便！
      buttons = "q w e";
      left  = "Left";
      up    = "Up";
      right = "Right";
      down  = "Down";
      scroll_up   = "S-Up";
      scroll_down = "S-Down";
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="wayland"><a class="header" href="#wayland">Wayland</a></h1>
<pre><code class="language-nix">virtualisation.waydroid.enable = true;
</code></pre>
<p>尝试使用weston，消息来源参考：</p>
<ul>
<li>https://github.com/waydroid/waydroid/issues/470
<ul>
<li>https://wiki.archlinux.org/title/Waydroid</li>
</ul>
</li>
</ul>
<p>wayland images: <code>/var/lib/waydroid/images/</code></p>
<pre><code class="language-bash">weston --scale=2

# 在weston里
waydroid show-full-ui
</code></pre>
<p>weston快捷键参考<code>man weston-bindings</code></p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs ? import &lt;nixpkgs&gt; {}
, wrapWine ? import ./wrapWine.nix {inherit pkgs;}
}:

let
  name = "weixin";
  installer = builtins.fetchurl "https://dldir1.qq.com/weixin/Windows/WeChatSetup.exe";
  regfile = builtins.toFile "${name}.reg" ''
    Windows Registry Editor Version 5.00

    # [HKEY_LOCAL_MACHINE\System\CurrentControlSet\Hardware Profiles\Current\Software\Fonts]
    # "LogPixels"=dword:000000F0

    [HKEY_CURRENT_USER\Software\Wine\X11 Driver]
    "Decorated"="N"
  '';
  bin = wrapWine {
    inherit name;
    executable = "$WINEPREFIX/drive_c/Program Files/Tencent/WeChat/WeChat.exe";
    tricks = ["riched20" "msls31"];
    setupScript = ''
      LANG="zh_CN.UTF-8"
    '';
    firstrunScript = ''
      # prevent weixin polluting my Documents folder
      rm -f $WINEPREFIX/drive_c/users/$USER/Documents
      mkdir -p $WINEPREFIX/drive_c/users/$USER/Documents

      wine ${installer}

      # 占用磁盘空间持续增加
      # https://github.com/vufa/deepin-wine-wechat-arch/issues/225
      mkdir -p $WINEPREFIX/drive_c/users/xieby1/AppData/Roaming/Tencent/WeChat/xweb/crash/Crashpad/
      touch $WINEPREFIX/drive_c/users/xieby1/AppData/Roaming/Tencent/WeChat/xweb/crash/Crashpad/reports
    '';
    inherit regfile;
  };
  desktop = pkgs.makeDesktopItem {
    inherit name;
    desktopName = "Wine微信";
    genericName = "weixin";
    type = "Application";
    exec = "${bin}/bin/${name}";
    icon = pkgs.fetchurl {
      url = "https://cdn.cdnlogo.com/logos/w/79/wechat.svg";
      sha256 = "1xk1dsia6favc3p1rnmcncasjqb1ji4vkmlajgbks0i3xf60lskw";
    };
  };
in
pkgs.symlinkJoin {
  inherit name;
  paths = [bin desktop];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># based on https://github.com/lucasew/nixcfg/blob/49d44c1a655f1c20d7354ecea942c78704067d50/pkgs/wrapWine.nix
{ pkgs ? import &lt;nixpkgs&gt; {} }:
let
  inherit (builtins) length concatStringsSep;
  inherit (pkgs) lib cabextract
    writeShellScriptBin symlinkJoin;
  inherit (lib) makeBinPath;
in
{ is64bits ? false
, wine ? if is64bits then pkgs.wineWowPackages.stable else pkgs.wine
, wineFlags ? ""
, executable
, chdir ? null
, name
, tricks ? [ ]
, setupScript ? ""
, firstrunScript ? ""
, home ? ""
, regfile ? null
}:
let
  wineBin = "${wine}/bin/wine${if is64bits then "64" else ""}";
  requiredPackages = [
    wine
    cabextract
  ];
  PATH = makeBinPath requiredPackages;
  NAME = name;
  WINEARCH =
    if is64bits
    then "win64"
    else "win32";
  WINE_NIX = "$HOME/.wine-nix";
  WINEPREFIX = "${WINE_NIX}/${name}";
  setupHook = ''
    ${wine}/bin/wineboot
  '';
  tricksHook =
    if (length tricks) &gt; 0 then
      let
        tricksStr = concatStringsSep " " tricks;
        tricksCmd = ''
          ${pkgs.winetricks}/bin/winetricks ${tricksStr}
        '';
      in
      tricksCmd
    else "";
  run = writeShellScriptBin name ''
    export APP_NAME="${NAME}"
    export WINEARCH=${WINEARCH}
    export WINE_NIX=${WINE_NIX}
    export PATH=$PATH:${PATH}
    export WINEPREFIX="${WINEPREFIX}"
    export EXECUTABLE="${executable}"
    mkdir -p "$WINE_NIX"
    ${setupScript}
    if [ ! -e "$EXECUTABLE" ] # if the executable does not exist
    then
      ${if regfile!=null
        then ''${wineBin} regedit /C ${regfile}''
        else ""
      }
      ${setupHook}
      ${tricksHook}
      ${firstrunScript}
    else # no automatically run after installation!
      ${if chdir != null
        then ''cd "${chdir}"''
        else ""}
      if [ ! "$REPL" == "" ]; # if $REPL is setup then start a shell in the context
      then
        bash
        exit 0
      fi

      ${wineBin} ${wineFlags} "$EXECUTABLE" "$@"
    fi
  '';
  clean = writeShellScriptBin "${name}-clean" ''
    read -p "Are you sure you want to clean ${WINEPREFIX}? &lt;y/N&gt; " prompt
    if [[ $prompt =~ [yY](es)* ]]; then
      rm ${WINEPREFIX} -rf
    fi
  '';
  winecfg = writeShellScriptBin "${name}-cfg" ''
    export WINEARCH=${WINEARCH}
    WINEPREFIX=${WINE_NIX}/${name} winecfg $@
  '';
  _wine = writeShellScriptBin "${name}-wine" ''
    export WINEARCH=${WINEARCH}
    WINEPREFIX=${WINE_NIX}/${name} ${wineBin} $@
  '';
in
symlinkJoin {
  inherit name;
  paths = [run clean winecfg _wine];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, lib, pkgs, ... }: {
  config = lib.mkIf config.isWSL2 {
    fonts.fontconfig.enable = true;
    home.packages = with pkgs; [
      noto-fonts-cjk-sans
      noto-fonts-cjk-serif
      noto-fonts-emoji
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="xcolor"><a class="header" href="#xcolor">XColor</a></h1>
<p>Why use XColor instead of gcolor3 or eyedropper?
Because they do not support zoom: e.g. https://github.com/FineFindus/eyedropper/issues/79</p>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [(
    let
      name = "xcolor-sleep";
      # [Error when launching xcolor from the Activities overview: Could not grab pointer #38](https://github.com/Soft/xcolor/issues/38)
      exec = pkgs.writeShellScript name ''
        for ((n=0; n&lt;3; n++)); do
          ${pkgs.xcolor}/bin/xcolor -s &amp;&amp; break
          sleep 0.2
        done
      '';
    in
    pkgs.runCommand name {} ''
      mkdir -p $out
      ${pkgs.xorg.lndir}/bin/lndir -silent ${pkgs.xcolor} $out
      rm $out/share/applications/XColor.desktop
      sed 's,^Exec.*,Exec=${exec},' ${pkgs.xcolor}/share/applications/XColor.desktop &gt; $out/share/applications/XColor.desktop
    ''
  )];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="xdot-the-dot-graphviz-viewer"><a class="header" href="#xdot-the-dot-graphviz-viewer">xdot, the dot (graphviz) viewer</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
</code></pre>
<p>Add a xdot.desktop for my xdot.</p>
<pre><code class="language-nix">  myxdot = pkgs.symlinkJoin {
    name = "myxdot";
    paths = [
      pkgs.xdot
      (pkgs.makeDesktopItem {
        name = "xdot";
        desktopName = "xdot";
        exec = "xdot %U";
        icon = builtins.toFile "cheatsheet.svg" ''
          &lt;svg width="64" height="64" xmlns="http://www.w3.org/2000/svg"&gt;
            &lt;rect width="100%" height="100%" rx="20%" ry="20%" fill="#F5F5F5"/&gt;
            &lt;text x="50%" y="50%" text-anchor="middle" dominant-baseline="middle" font-size="18" font-weight="bold" fill="#333333"&gt;
              xdot
            &lt;/text&gt;
          &lt;/svg&gt;
        '';
  })];};
in {
  home.packages = [
    myxdot
  ];
</code></pre>
<p>Open *.dot files with xdot.desktop by default.</p>
<pre><code class="language-nix">  xdg.mime.types.dot = {
    name = "graphviz-dot";
    type = "text/graphviz-dot";
    pattern = "*.dot";
    defaultApp = "xdot.desktop";
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{
  lib,
  stdenv,
  fetchurl,
  dpkg,
  qt5
}:
let
  version = "0.05";
  rpath = lib.makeLibraryPath [
    qt5.qtbase
  ] + ":${stdenv.cc.cc.lib}/lib64";
  src =
    if stdenv.hostPlatform.system == "x86_64-linux" then
      fetchurl {
        urls = [
          "https://github.com/horsicq/XELFViewer/releases/download/0.05/xelfviewer_0.05_Ubuntu_22.04_amd64.deb"
        ];
        sha256 = "0l6j0pnpfzwr8205xzis95k4x2la0mfy08bv6hfg32rh3bw906bz";
      }
    else
      throw "xelfviewer is not supported on ${stdenv.hostPlatform.system}";
in
stdenv.mkDerivation {
  pname = "xelfviewer";
  inherit version;

  system = "x86_64-linux";

  inherit src;

  nativeBuildInputs = [ qt5.wrapQtAppsHook ];

  buildInputs = [ dpkg ];

  dontUnpack = true;
  installPhase = ''
    mkdir -p $out
    dpkg-deb -x $src $out
    mv $out/usr/* $out/
    rm -r $out/usr
  '';

  postFixup = ''
    for file in $(find $out -type f \( -perm /0111 -o -name \*.so\* \) ); do
      patchelf --set-interpreter "$(cat $NIX_CC/nix-support/dynamic-linker)" "$file" || true
      patchelf --set-rpath ${rpath}:$out/lib/xelfviewer $file || true
    done
  '';

  meta = with lib; {
    description = "XELFViewer";
    homepage = "https://github.com/horsicq/XELFViewer";
    license = licenses.mit;
    maintainers = with maintainers; [ xieby1 ];
    platforms = [ "x86_64-linux" ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, lib, ...}:

{
  imports = [../../modules/cachix.nix];
  config = lib.mkIf (
    (builtins.pathExists config.cachix_dhall) &amp;&amp;
    (config.cachix_packages != [])
  ) {
    home.activation.cachix_push = lib.hm.dag.entryAfter ["writeBoundary"] config._cachix_push;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nix-on-droidnix"><a class="header" href="#nix-on-droidnix">nix-on-droid.nix</a></h1>
<p><code>nix-on-droid.nix</code>是安卓nix-on-droid的入口配置文件。
因为原生termux并不能直接运行nix，
所以nix-on-droid的作者基于termux使用proot搞出来一个能运行nix的termux分支。</p>
<p>nix-on-droid并未自带很多常用linux命令行工具，
因此<code>nix-on-droid.nix</code>主要负责配置那些在linux常用的，但nix-on-droid没有默认提供的命令行工具。
其他命令行工具的配置则复用home-manager的配置<a href="./usr/default.nix.html"><code>./usr</code></a>。
下面是我的带注解的<code>nix-on-droid.nix</code>代码。</p>
<pre><code class="language-nix">{ pkgs, config, ... }:

{
</code></pre>
<p>添加<code>sshd-start</code>命令，用于在安卓上启动sshd服务。
通常安卓上是没有root权限的，无法写/etc/目录的文件，
因此将ssh的tmp目录和配置目录设定到home下面。
这部分内容参考<a href="https://github.com/t184256/nix-on-droid/wiki/SSH-access">nix-on-droid wiki: SSH access</a></p>
<pre><code class="language-nix">  imports = [(let
    sshdTmpDirectory = "${config.user.home}/sshd-tmp";
    sshdDirectory = "${config.user.home}/sshd";
    pathToPubKey = "${config.user.home}/.ssh/id_rsa.pub";
    port = 8022;
    sshd-start = pkgs.writeScriptBin "sshd-start" ''
      #!${pkgs.runtimeShell}

      echo "Starting sshd in non-daemonized way on port ${toString port}"
      ${pkgs.openssh}/bin/sshd -f "${sshdDirectory}/sshd_config" -D
    '';
  in {
    environment.packages = with pkgs; [
      sshd-start
    ];
    build.activation.sshd = ''
      $DRY_RUN_CMD mkdir $VERBOSE_ARG --parents "${config.user.home}/.ssh"
      $DRY_RUN_CMD cat ${pathToPubKey} &gt; "${config.user.home}/.ssh/authorized_keys"

      if [[ ! -d "${sshdDirectory}" ]]; then
        $DRY_RUN_CMD rm $VERBOSE_ARG --recursive --force "${sshdTmpDirectory}"
        $DRY_RUN_CMD mkdir $VERBOSE_ARG --parents "${sshdTmpDirectory}"

        $VERBOSE_ECHO "Generating host keys..."
        $DRY_RUN_CMD ${pkgs.openssh}/bin/ssh-keygen -t rsa -b 4096 -f "${sshdTmpDirectory}/ssh_host_rsa_key" -N ""

        $VERBOSE_ECHO "Writing sshd_config..."
        $DRY_RUN_CMD echo -e "HostKey ${sshdDirectory}/ssh_host_rsa_key\nPort ${toString port}\n" &gt; "${sshdTmpDirectory}/sshd_config"

        $DRY_RUN_CMD mv $VERBOSE_ARG "${sshdTmpDirectory}" "${sshdDirectory}"
      fi
    '';
  }) ({
</code></pre>
<p>自动配置termux。</p>
<pre><code class="language-nix">    build.activation.termux = ''
      DIR=${config.user.home}/.termux
      mkdir -p $DIR
      symlink() {
        if [[ -e $1 &amp;&amp; ! -e $2 ]]; then
          #echo "ln -s $1 $2"
          ln -s $1 $2
        fi
      }
      SRC=${config.user.home}/Gist/Config/termux.properties
      DST=$DIR/termux.properties
      symlink $SRC $DST
      SRC=${config.user.home}/Gist/Config/colors.properties
      DST=$DIR/colors.properties
      symlink $SRC $DST
    '';
  })];

</code></pre>
<p>下面是非常直观的软件安装。</p>
<pre><code class="language-nix">  # Simply install just the packages
  environment.packages = with pkgs; [
    # User-facing stuff that you really really want to have
    vim  # or some other editor, e.g. nano or neovim
    # Some common stuff that people expect to have
    diffutils
    findutils
    utillinux
    tzdata
    hostname
    man
    gnugrep
    gnupg
    gnused
    gnutar
    bzip2
    gzip
    xz
    zip
    unzip
    gawk
    openssh
    nettools
    (lib.setPrio # make bintools less prior
      (busybox.meta.priority + 10)
      busybox
    )
  ];

  # Backup etc files instead of failing to activate generation if a file already exists in /etc
  environment.etcBackupExtension = ".bak";

  # Read the changelog before changing this value
  system.stateVersion = "21.11";

</code></pre>
<p>导入home-manager的配置文件<a href="./usr/default.nix">./usr</a>的配置。
如此操作，所有home-manager的软件和配置都能nix-on-droid中复用。</p>
<pre><code class="language-nix">  home-manager.config = import ./usr;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p>用于自动push包到cachix的模块。
尽管cachix watch-store能自动push，但是我想更细粒度地管理需要push的包，所以有了这个模块。</p>
<pre><code class="language-nix">{ config, pkgs, lib, ...}:

{
  options = {
    cachix_packages = lib.mkOption {
      type = lib.types.listOf lib.types.package;
      default = [];
      description = ''
        This list of packages.

        If the the cachix.dhall file exists and cachix_packages is not empty,
        then the packages in cachix_packages will be pushed to cachix.
      '';
    };
    cachix_dhall = lib.mkOption {
      type = lib.types.str;
      default = "/home/xieby1/Gist/Config/cachix.dhall";
      description = ''
        The path of cachix.dhall.
      '';
    };
    cachix_name = lib.mkOption {
      type = lib.types.str;
      default = "xieby1";
      description = ''
        The cachix name.
      '';
    };
    _cachix_push = lib.mkOption {
      type = lib.types.str;
      default = ''
        mkdir -p ~/.config/cachix_push
        ${lib.concatMapStrings (pkg: ''
          symlink=~/.config/cachix_push/${pkg.name}
          if [[ ! (-h "$symlink" &amp;&amp; $(realpath "$symlink") == ${pkg}) ]]; then
            # the symlink are not the same to pkg, need to cachix push
            echo 📦 ${pkg}
            ${pkgs.cachix}/bin/cachix -c ${config.cachix_dhall} push ${config.cachix_name} ${pkg}
            rm -f "$symlink"
            ln -s ${pkg} "$symlink"
          fi
        '') config.cachix_packages}
      '';
      description = ''
        (Internal usage) The script of pushing packages to cachix.
      '';
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ lib, ... }: {
  options = {
    isMinimalConfig = lib.mkOption {
      type = lib.types.bool;
      default = false;
    };
    proxyPort = lib.mkOption {
      type = lib.types.number;
      default = 8889;
      description = "代理端口号，诸多网络程序需要用，比如clash和tailscale";
    };
    isCli = lib.mkOption {
      type = lib.types.bool;
      default = (builtins.getEnv "DISPLAY")=="";
      description = ''
        `isCli`和`isGui`的默认值通过环境变量`DISPLAY`来判断是否是CLI或GUI环境。
        这个方法有**局限**，比如ssh连接到一台有GUI的电脑上，ssh里是没有设置环境变量`DISPLAY`的。
        因此更好的方法是显示地声明sCli和isGui的值。
      '';
    };
    isGui = lib.mkOption {
      type = lib.types.bool;
      default = (builtins.getEnv "DISPLAY")!="";
    };
    isNixOnDroid = lib.mkOption {
      type = lib.types.bool;
      default = (builtins.getEnv "USER")=="nix-on-droid";
      description = ''
        默认值是通过用户名来判断是否是nix-on-droid。
      '';
    };
    isWSL2 = lib.mkOption {
      type = lib.types.bool;
      default = (builtins.getEnv "WSL_DISTRO_NAME")!="";
      description = ''
        默认值是通过环境变量`WSL_DISTRO_NAME`来判断是否是WSL2。
      '';
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><h1 id="module"><a class="header" href="#module">Module</a></h1>
<p>nixpkgs/lib/modules.nix:
从<code>loadModule</code>可以看出，imports可以接受Function、Attr、路径，不能够嵌套List。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nixpkgs"><a class="header" href="#nixpkgs">Nixpkgs</a></h1>
<h2 id="nixpkgs-crosssystem"><a class="header" href="#nixpkgs-crosssystem">nixpkgs crossSystem</a></h2>
<ul>
<li>default.nix
<ul>
<li>pkgs/top-level/impure.nix
<ul>
<li>pkgs/top-level/default.nix
<ul>
<li>lib.systems.elaborate crossSystem0;
<ul>
<li>lib/systems/default.nix: elaborate
<ul>
<li>parsed = parse.mkSystemFromString ... args.system; // args.system = crossSystem
<ul>
<li>lib/systems/parse.nix
<ul>
<li>mkSystemFromString = s: mkSystemFromSkeleton (mkSkeletonFromList (lib.splitString "-" s));
<ul>
<li>mkSkeletonFromList</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>注意mkSkeletonFromList通过
<code>${toString (length l)}</code>
实现了一个根据l长度的switch case。</p>
<p>crossSystem的4个域分别为cpu-vendor-kernel-abi</p>
<h2 id="import-nixpkgs"><a class="header" href="#import-nixpkgs">import nixpkgs</a></h2>
<p><code>import &lt;nixpgks&gt; {}</code>
的加载流程</p>
<ul>
<li>default.nix
<ul>
<li>pkgs/top-level/impure.nix
<ul>
<li>pkgs/top-level/default.nix
<ul>
<li>stdenvStages import pkgs/stdenv/default.nix
<ul>
<li>stagesLinux = import pkgs/stdenv/linux/
<ul>
<li>thisStdenv, stdenv = import pkgs/stdenv/generic/default.nix
<ul>
<li>import lib/default.nix
<h1 id="this-is-where-customisationnix-come-from"><a class="header" href="#this-is-where-customisationnix-come-from">this is where customisation.nix come from</a></h1>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>allPackages import pkgs/top-level/stage.nix
<ul>
<li>allPackages import pkgs/top-level/all-packages.nix</li>
</ul>
</li>
<li>boot = import pkgs/stdenv/booter.nix</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>vim_configurable.override {python = python3}
vimUtils.makeCustomizable (vim.override {python = python3})
vimUtils.makeCustomizable (vim.override {python = python3})</p>
<p>似乎是一个浮现override变量的最小集
f = a:{res = a+1;}
fo = pkgsMiao.makeOverride f
f 2</p>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><h1 id="打包编译32位程序"><a class="header" href="#打包编译32位程序">打包/编译32位程序</a></h1>
<p>参考<a href="https://nixos.wiki/wiki/Packaging/32bit_Applications">Packaging/32bit Applications</a>。</p>
<h2 id="仅32位"><a class="header" href="#仅32位">仅32位</a></h2>
<p>打包使用pkgs.pkgsi686Linux.stdenv.mkDerivation</p>
<p>编译使用pkgs.pkgsi686Linux.gcc</p>
<h2 id="32位且64位"><a class="header" href="#32位且64位">32位且64位</a></h2>
<p>打包使用pkgs.multiStdenv.mkDerivation。</p>
<p>编译使用pkgs.gcc_multi。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="auto-push-packages-to-cachix"><a class="header" href="#auto-push-packages-to-cachix">Auto Push Packages to Cachix</a></h1>
<p><strong>Objective</strong>:
Automatically push specific built packages to cachix during <code>home-manager switch</code>/<code>nixos-rebuild switch</code>/<code>nix-shell</code>.</p>
<p>Although there are several existing ways to achieve this:</p>
<ul>
<li>cachix's <a href="https://docs.cachix.org/pushing">watch-exec and watch-store</a></li>
<li>nix-build's <a href="https://nixos.org/manual/nix/stable/advanced-topics/post-build-hook">post-build-hook</a></li>
</ul>
<p>However, the granularity of these methods is coarse; they push all packages to cachix.
Is there a way to allow users to control which packages are pushed?</p>
<h2 id="conclusion-first"><a class="header" href="#conclusion-first">Conclusion First</a></h2>
<p>Use <strong>hooks</strong> to push the selected packages to cachix:</p>
<div class="table-wrapper"><table><thead><tr><th>Scenario</th><th>Hook</th><th>Example</th></tr></thead><tbody>
<tr><td>home-manager</td><td><code>home.activation</code></td><td><a href="docs/howto/auto_push_to_cachix/../../../modules/cachix.nix.html">modules/cachix.nix</a>, <a href="docs/howto/auto_push_to_cachix/../../../usr/modules/cachix.nix.html">usr/modules/cachix.nix</a></td></tr>
<tr><td>nixos-rebuild</td><td><code>system.activationScripts</code></td><td><a href="docs/howto/auto_push_to_cachix/../../../modules/cachix.nix.html">modules/cachix.nix</a>, <a href="docs/howto/auto_push_to_cachix/../../../sys/modules/cachix.nix.html">sys/modules/cachix.nix</a></td></tr>
<tr><td>nix-shell</td><td><code>shellHook</code></td><td><a href="https://github.com/xieby1/openc910/blob/main/shell.nix">openc910/shell.nix</a></td></tr>
</tbody></table>
</div>
<hr />
<h2 id="my-explorations"><a class="header" href="#my-explorations">My Explorations</a></h2>
<p><strong>Possible solutions</strong>:
Add a wrapper called <code>cachixPackages</code>, which recives the packages to be pushed and cachix information.
This <code>cachixPackages</code> is a dummy package whose build stages will push the packages to cachix.
However, normal nix packages are not allowed network access during building.
To tackle this, like how fetch* series functions are implemented, the <a href="https://nixos.org/manual/nix/stable/language/advanced-attributes#adv-attr-outputHash">fixed-output derivation</a> can be utilized to allow network access.</p>
<p>However, the above method seems not work as below,
because cachix needs accesses to some resources beyond nix-build process (such as nix-build's sandbox).</p>
<pre><code class="language-bash">nix-build test.nix
...
cachix: CppStdException e "\ESC[31;1merror:\ESC[0m creating directory '\ESC[35;1m/nix/var\ESC[0m': \ESC[35;1mPermission denied\ESC[0m"(Just "nix::SysError")
result 1
...
</code></pre>
<p>Even though I disable the nix-build sandbox by using <code>--no-sandbox</code>,
the cachix still does not satisfy as below.</p>
<pre><code class="language-bash">$ nix-build test.nix --no-sandbox
...
cachix: CppStdException e "\ESC[31;1merror:\ESC[0m cannot open connection to remote store '\ESC[35;1mdaemon\ESC[0m': \ESC[35;1m\ESC[31;1merror:\ESC[0m reading from file: \ESC[35;1mConnection reset by peer\ESC[0m\ESC[0m"(Just "nix::Error")
...
</code></pre>
<p>If you curious about my demo of <code>cachixPackages</code> and its test,
see <a href="docs/howto/auto_push_to_cachix/./cachix-package.nix.html">cachix-package.nix</a> and <a href="docs/howto/auto_push_to_cachix/./test.nix.html">test.nix</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cachixpackage"><a class="header" href="#cachixpackage">cachixPackage</a></h1>
<p>This file try to implement a package wrapper, which will automatically push <code>pkg</code> to cachix upon building.
However, this method seems not work, due to limited resources in nix-build environment.
For more details, see <a href="docs/howto/auto_push_to_cachix/./index.html">here</a>.</p>
<pre><code class="language-nix">{ cachix
, stdenv
, writeShellScript
}:

{ pkg
, sha256
, cachix_dhall
, cachix_name
, name ? "cachixed"
}:

builtins.derivation {
  inherit name;
  system = builtins.currentSystem;
  builder = writeShellScript "cachix-package-builder" ''
    source ${stdenv}/setup
    echo ${pkg} &gt; $out
    if [[ -f "${cachix_dhall}" ]]; then
      ${cachix}/bin/cachix -c ${cachix_dhall} push ${cachix_name} ${pkg}
      result=$?
      echo result $result
      exit $result
    fi
  '';

  outputHashMode = "flat";
  outputHashAlgo = "sha256";
  outputHash = sha256;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="test-for-cachixpackage"><a class="header" href="#test-for-cachixpackage">Test for cachixPackage</a></h1>
<p>To run the test:</p>
<pre><code class="language-bash"># run with nix-build sandbox
nix-build test.nix
# run without nix-build sandbox
nix-build test.nix --no-sandbox
</code></pre>
<pre><code class="language-nix">let
  pkgs = import &lt;nixpkgs&gt; {};
  cachixPackage = import ./cachix-package.nix {inherit (pkgs) cachix stdenv writeShellScript;};
in cachixPackage {
  pkg = pkgs.hello;
  sha256 = "01vm275n169r0ly8ywgq0shgk8lrzg79d1aarshwybwxwffj4q0q";
  cachix_dhall = /home/xieby1/Gist/Config/cachix.dhall;
  cachix_name = "xieby1";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="备份binary-cache"><a class="header" href="#备份binary-cache">备份binary cache</a></h1>
<h2 id="场景"><a class="header" href="#场景">场景</a></h2>
<p>官方binary cache没有的包， 自己花了很长时间编译出来。
值得把编译出来的的包及其依赖全部保存下来。</p>
<h2 id="目前的问题"><a class="header" href="#目前的问题">目前的问题</a></h2>
<p>nix copy --to <path> 备份的/nix/store如何使用？</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="交叉编译和安装跨平台程序"><a class="header" href="#交叉编译和安装跨平台程序">交叉编译和安装跨平台程序</a></h1>
<p>nixpkgs原生支持x86和arm指令集。
通过对nixpkgs配置可以轻松实现交叉编译，
跨平台程序的安装等功能。</p>
<h2 id="太长不看"><a class="header" href="#太长不看">太长不看</a></h2>
<ul>
<li>
<p>x86_64上的aarch64交叉编译器</p>
<p><code>(with import &lt;nixpkgs&gt; {crossSystem="aarch64-linux";}; stdenv.cc)</code></p>
</li>
<li>
<p>aarch64的hello应用程序</p>
<p><code>(with import &lt;nixpkgs&gt; {localSystem.system="aarch64-linux";crossSystem="aarch64-linux";}; hello)</code></p>
</li>
<li>
<p>应用于nix-shell的例子</p>
<p><a href="https://xieby1.github.io/scripts/index.html#shell_cross_platformnix">shell_cross_platform.nix</a></p>
</li>
</ul>
<h2 id="目录-1"><a class="header" href="#目录-1">目录</a></h2>
<!-- vim-markdown-toc GFM -->
<ul>
<li><a href="docs/howto/cross.html#%E7%AE%80%E4%BB%8B">简介</a></li>
<li><a href="docs/howto/cross.html#localsystem%E5%92%8Ccrosssystem%E7%9A%84%E8%AF%AD%E6%B3%95"><code>localSystem</code>和<code>crossSystem</code>的语法</a>
<ul>
<li><a href="docs/howto/cross.html#cpu-vendor-kernel-abi">cpu-vendor-kernel-abi</a>
<ul>
<li><a href="docs/howto/cross.html#cpu">cpu</a>
<ul>
<li><a href="docs/howto/cross.html#cputypes">cpuTypes</a></li>
</ul>
</li>
<li><a href="docs/howto/cross.html#vendor">vendor</a></li>
<li><a href="docs/howto/cross.html#kernel">kernel</a></li>
<li><a href="docs/howto/cross.html#abi">abi</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="docs/howto/cross.html#localsystem%E5%92%8Ccrosssystem%E7%9A%84%E5%BA%94%E7%94%A8"><code>localSystem</code>和<code>crossSystem</code>的应用</a>
<ul>
<li><a href="docs/howto/cross.html#aarch64%E4%BA%A4%E5%8F%89%E5%B7%A5%E5%85%B7%E9%93%BE%E5%92%8C%E7%A8%8B%E5%BA%8F%E7%9A%84%E8%AF%A6%E7%BB%86%E4%BE%8B%E5%AD%90">aarch64交叉工具链和程序的详细例子</a></li>
<li><a href="docs/howto/cross.html#mips%E4%BA%A4%E5%8F%89%E5%B7%A5%E5%85%B7%E9%93%BE%E7%9A%84%E4%BE%8B%E5%AD%90">mips交叉工具链的例子</a></li>
</ul>
</li>
<li><a href="docs/howto/cross.html#crosssystem%E7%9A%84%E4%BC%A0%E9%80%92">crossSystem的传递</a></li>
<li><a href="docs/howto/cross.html#%E5%BC%95%E7%94%A8">引用</a></li>
</ul>
<!-- vim-markdown-toc -->
<h2 id="简介"><a class="header" href="#简介">简介</a></h2>
<p>nixpkgs<sup class="footnote-reference"><a href="#version">1</a></sup>众多输入参数中，包含<code>localSystem</code>和<code>crossSystem</code><sup class="footnote-reference"><a href="#localSystem_crossSystem">2</a></sup>。</p>
<ul>
<li>
<p><code>localSystem</code></p>
<blockquote>
<p>The system packages will be built on.</p>
</blockquote>
<p>本地系统，即工具链运行的平台。</p>
</li>
<li>
<p><code>crossSystem</code></p>
<blockquote>
<p>The system packages will ultimately be run on.</p>
</blockquote>
<p>程序运行的平台。</p>
</li>
</ul>
<p>通过<code>localSystem</code>和<code>crossSystem</code>不同值的组合，
可以实现交叉编译、安装其他架构的原生应用。
下面从<code>localSystem</code>和<code>crossSystem</code>的语法和应用两方面进行介绍。
语法章节从nixpkgs源码的角度出发，介绍其语法的组成。
应用章节围绕一个nix-shell脚本的实际例子，
介绍x86_64平台的交叉编译和安装aarch64架构的原生应用的方法。</p>
<h2 id="localsystem和crosssystem的语法"><a class="header" href="#localsystem和crosssystem的语法"><code>localSystem</code>和<code>crossSystem</code>的语法</a></h2>
<p><code>localSystem</code>和<code>crossSystem</code>由4个维度去刻画一个系统：cpu, vendor, kernel, abi。
<code>localSystem</code>和<code>crossSystem</code>的值为字符串或者<code>{system=字符串;}</code><sup class="footnote-reference"><a href="#localSystem_crossSystem_type">3</a></sup>。
system字符串为可以包含前述4个维度的1~4个维度。
nix在解析时会将省略的维度按以某些默认值补充完整。
维度之间之间用<code>-</code>分割。
因此system字符串形式上为<code>"cpu-vendor-kernel-abi"</code>。
字符串不同数量的维度及其可用的值，
按匹配优先级由高到低列举如下<sup class="footnote-reference"><a href="#skeleton">4</a></sup>，</p>
<h3 id="cpu-vendor-kernel-abi"><a class="header" href="#cpu-vendor-kernel-abi">cpu-vendor-kernel-abi</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">system字符串</th><th style="text-align: center">cpu</th><th style="text-align: center">vendor</th><th style="text-align: center">kernel</th><th style="text-align: center">abi</th></tr></thead><tbody>
<tr><td style="text-align: center">"avr"</td><td style="text-align: center">avr</td><td style="text-align: center"></td><td style="text-align: center">none</td><td style="text-align: center">unknown</td></tr>
<tr><td style="text-align: center">"{cpu}-cygwin"</td><td style="text-align: center">{cpu}</td><td style="text-align: center"></td><td style="text-align: center">windows</td><td style="text-align: center">cygnus</td></tr>
<tr><td style="text-align: center">"{cpu}-windows"</td><td style="text-align: center">{cpu}</td><td style="text-align: center"></td><td style="text-align: center">windows</td><td style="text-align: center">msvc</td></tr>
<tr><td style="text-align: center">"{cpu}-elf"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">unknown</td><td style="text-align: center">none</td><td style="text-align: center">elf</td></tr>
<tr><td style="text-align: center">"{cpu}-{kernel}"</td><td style="text-align: center">{cpu}</td><td style="text-align: center"></td><td style="text-align: center">{kernel}</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-apple-{kernel}"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">apple</td><td style="text-align: center">{kernel}</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-linux-gnu"</td><td style="text-align: center">{cpu}</td><td style="text-align: center"></td><td style="text-align: center">linux</td><td style="text-align: center">gnu</td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-mingw32"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">{vendor}</td><td style="text-align: center">windows</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-wasi"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">{vendor}</td><td style="text-align: center">wasi</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-redox"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">{vendor}</td><td style="text-align: center">redox</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-mmixware"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">{vendor}</td><td style="text-align: center">mmixware</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-netbsd*"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">{vendor}</td><td style="text-align: center">netbsd*</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-eabi"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">unknown</td><td style="text-align: center">{kernel}</td><td style="text-align: center">eabi</td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-eabihf"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">unknown</td><td style="text-align: center">{kernel}</td><td style="text-align: center">eabihf</td></tr>
<tr><td style="text-align: center">"{cpu}-{kernel}-elf"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">unknown</td><td style="text-align: center">{kernel}</td><td style="text-align: center">elf</td></tr>
<tr><td style="text-align: center">"{cpu}-*-{ghcjs}"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">unknown</td><td style="text-align: center">ghcjs</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-genode"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">{vendor}</td><td style="text-align: center">genode</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-{kernel}-{abi} "</td><td style="text-align: center">{cpu}</td><td style="text-align: center">{vendor}</td><td style="text-align: center">{kernel}</td><td style="text-align: center">{abi}</td></tr>
</tbody></table>
</div>
<h4 id="cpu"><a class="header" href="#cpu">cpu</a></h4>
<p>cpu字符串可取的值列举如下<sup class="footnote-reference"><a href="#cpuTypes">5</a></sup>,</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">cpu字符串</th><th style="text-align: center">bits</th><th style="text-align: center">significantByte</th><th style="text-align: center">family</th><th style="text-align: center">version</th><th style="text-align: center">arch</th></tr></thead><tbody>
<tr><td style="text-align: center">"arm"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"armv5tel"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"5"</td><td style="text-align: center">"armv5t"</td></tr>
<tr><td style="text-align: center">"armv6m"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"6"</td><td style="text-align: center">"armv6-m"</td></tr>
<tr><td style="text-align: center">"armv6l"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"6"</td><td style="text-align: center">"armv6"</td></tr>
<tr><td style="text-align: center">"armv7a"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"7"</td><td style="text-align: center">"armv7-a"</td></tr>
<tr><td style="text-align: center">"armv7r"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"7"</td><td style="text-align: center">"armv7-r"</td></tr>
<tr><td style="text-align: center">"armv7m"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"7"</td><td style="text-align: center">"armv7-m"</td></tr>
<tr><td style="text-align: center">"armv7l"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"7"</td><td style="text-align: center">"armv7"</td></tr>
<tr><td style="text-align: center">"armv8a"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"8"</td><td style="text-align: center">"armv8-a"</td></tr>
<tr><td style="text-align: center">"armv8r"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"8"</td><td style="text-align: center">"armv8-a"</td></tr>
<tr><td style="text-align: center">"armv8m"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"8"</td><td style="text-align: center">"armv8-m"</td></tr>
<tr><td style="text-align: center">"aarch64"</td><td style="text-align: center">64</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"8"</td><td style="text-align: center">"armv8-a"</td></tr>
<tr><td style="text-align: center">"aarch64_be"</td><td style="text-align: center">64</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"8"</td><td style="text-align: center">"armv8-a"</td></tr>
<tr><td style="text-align: center">"i386"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"x86"</td><td style="text-align: center"></td><td style="text-align: center">"i386"</td></tr>
<tr><td style="text-align: center">"i486"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"x86"</td><td style="text-align: center"></td><td style="text-align: center">"i486"</td></tr>
<tr><td style="text-align: center">"i586"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"x86"</td><td style="text-align: center"></td><td style="text-align: center">"i586"</td></tr>
<tr><td style="text-align: center">"i686"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"x86"</td><td style="text-align: center"></td><td style="text-align: center">"i686"</td></tr>
<tr><td style="text-align: center">"x86_64"</td><td style="text-align: center">64</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"x86"</td><td style="text-align: center"></td><td style="text-align: center">"x86-64"</td></tr>
<tr><td style="text-align: center">"mips"</td><td style="text-align: center">32</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"mips"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"mipsel"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"mips"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"mips64"</td><td style="text-align: center">64</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"mips"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"mips64el"</td><td style="text-align: center">64</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"mips"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"mmix"</td><td style="text-align: center">64</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"mmix"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"m68k"</td><td style="text-align: center">32</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"m68k"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"powerpc"</td><td style="text-align: center">32</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"power"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"powerpc64"</td><td style="text-align: center">64</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"power"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"powerpc64le"</td><td style="text-align: center">64</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"power"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"powerpcle"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"power"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"riscv32"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"riscv"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"riscv64"</td><td style="text-align: center">64</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"riscv"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"s390"</td><td style="text-align: center">32</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"s390"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"s390x"</td><td style="text-align: center">64</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"s390"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"sparc"</td><td style="text-align: center">32</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"sparc"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"sparc64"</td><td style="text-align: center">64</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"sparc"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"wasm32"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"wasm"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"wasm64"</td><td style="text-align: center">64</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"wasm"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"alpha"</td><td style="text-align: center">64</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"alpha"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"msp430"</td><td style="text-align: center">16</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"msp430"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"avr"</td><td style="text-align: center">8</td><td style="text-align: center"></td><td style="text-align: center">"avr"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"vc4"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"vc4"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"or1k"</td><td style="text-align: center">32</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"or1k"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"js"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"js"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
</tbody></table>
</div>
<h5 id="cputypes"><a class="header" href="#cputypes">cpuTypes</a></h5>
<p>cpu之间的兼容性（具有传递性和自反性）如下<sup class="footnote-reference"><a href="#isCompatible">6</a></sup>，</p>
<p><img src="docs/howto/./images/cpu_isCompatible.dot.svg" alt="" /></p>
<h4 id="vendor"><a class="header" href="#vendor">vendor</a></h4>
<p>vendor字符串可取值<code>"apple"</code>, <code>"pc"</code>(windows), <code>"w64"</code>(MinGW-w64), <code>"none"</code>, <code>"unknown"</code>(default)。</p>
<h4 id="kernel"><a class="header" href="#kernel">kernel</a></h4>
<p>kernel字符串可取值如下表<sup class="footnote-reference"><a href="#kernels">7</a></sup>，</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">kernel字符串</th><th style="text-align: center">execFormat</th><th style="text-align: center">families</th></tr></thead><tbody>
<tr><td style="text-align: center">"macos"</td><td style="text-align: center">macho</td><td style="text-align: center">darwin</td></tr>
<tr><td style="text-align: center">"darwin"</td><td style="text-align: center">↑</td><td style="text-align: center">↑</td></tr>
<tr><td style="text-align: center">"ios"</td><td style="text-align: center">macho</td><td style="text-align: center">darwin</td></tr>
<tr><td style="text-align: center">"watchos"</td><td style="text-align: center">↑</td><td style="text-align: center">↑</td></tr>
<tr><td style="text-align: center">"tvos"</td><td style="text-align: center">↑</td><td style="text-align: center">↑</td></tr>
<tr><td style="text-align: center">"freebsd"</td><td style="text-align: center">elf</td><td style="text-align: center">bsd</td></tr>
<tr><td style="text-align: center">"linux"</td><td style="text-align: center">elf</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"netbsd"</td><td style="text-align: center">elf</td><td style="text-align: center">bsd</td></tr>
<tr><td style="text-align: center">"none"</td><td style="text-align: center">unknown</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"openbsd"</td><td style="text-align: center">elf</td><td style="text-align: center">bsd</td></tr>
<tr><td style="text-align: center">"solaris"</td><td style="text-align: center">elf</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"wasi"</td><td style="text-align: center">wasm</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"redox"</td><td style="text-align: center">elf</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"windows"</td><td style="text-align: center">pe</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"win32"</td><td style="text-align: center">↑</td><td style="text-align: center">↑</td></tr>
<tr><td style="text-align: center">"ghcjs"</td><td style="text-align: center">unknown</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"genode"</td><td style="text-align: center">elf</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"mmixware"</td><td style="text-align: center">unknown</td><td style="text-align: center"></td></tr>
</tbody></table>
</div>
<h4 id="abi"><a class="header" href="#abi">abi</a></h4>
<p>abi字符串可取的值列举如下<sup class="footnote-reference"><a href="#abis">8</a></sup>，</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">abi字符串</th><th style="text-align: center">float</th><th style="text-align: center">abi</th><th style="text-align: center">Note</th></tr></thead><tbody>
<tr><td style="text-align: center">"cygnus"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"msvc"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"eabi"</td><td style="text-align: center">soft</td><td style="text-align: center"></td><td style="text-align: center">for ARM, PowerPC</td></tr>
<tr><td style="text-align: center">"eabihf"</td><td style="text-align: center">hard</td><td style="text-align: center"></td><td style="text-align: center">for ARM, PowerPC</td></tr>
<tr><td style="text-align: center">"elf"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"androideabi"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"android"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center">not 32-bit</td></tr>
<tr><td style="text-align: center">"gnueabi"</td><td style="text-align: center">soft</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"gnueabihf"</td><td style="text-align: center">hard</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"gnu"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center">not 32-bit</td></tr>
<tr><td style="text-align: center">"gnuabi64"</td><td style="text-align: center"></td><td style="text-align: center">64</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"musleabi"</td><td style="text-align: center">soft</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"musleabihf"</td><td style="text-align: center">hard</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"musl"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"uclibceabihf"</td><td style="text-align: center">soft</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"uclibceabi"</td><td style="text-align: center">hard</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"uclibc"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"unknown"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
</tbody></table>
</div>
<h2 id="localsystem和crosssystem的应用"><a class="header" href="#localsystem和crosssystem的应用"><code>localSystem</code>和<code>crossSystem</code>的应用</a></h2>
<h3 id="aarch64交叉工具链和程序的详细例子"><a class="header" href="#aarch64交叉工具链和程序的详细例子">aarch64交叉工具链和程序的详细例子</a></h3>
<p>以x86为本地指令集，<code>localSystem</code>和<code>crossSystem</code>的组合有以下效果</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">↓<code>crossSystem</code>↓ →<code>localSystem</code>→</th><th style="text-align: center">"x86_64-linux"</th><th style="text-align: center">"aarch64-linux"</th></tr></thead><tbody>
<tr><td style="text-align: center">"x86_64-linux"</td><td style="text-align: center">通常情况</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"aarch64-linux"</td><td style="text-align: center">交叉编译aarch64</td><td style="text-align: center">原生aarch64应用</td></tr>
</tbody></table>
</div>
<p>因此基于这3种组合，可以在同一个shell环境中配置出3种软件，
代码见[cross_platform.nix]({{ site.repo_url }}/scripts/shell/cross_platform.nix)。</p>
<p><code>pkgs_arm_cross</code>软件包的<code>stdenv.cc</code>为x86平台的arm交叉编译器。
nixpkgs channel只包含了原生x86应用和原生arm应用。
交叉编译的arm应用和原生arm应用的derivation不一样。
因此使用<code>pkgs_arm_cross</code>中的应用，
则会使用交叉编译器从源码开始编译arm应用，
而不是直接拉取nixpkgs channel的原生arm应用。</p>
<p><code>pkgs_arm_native</code>软件包包含原生arm软件包。
从这个软件包拉取的应用和在arm平台的拉取到的应用一致。
例如<code>figlet</code>将直接从nix channel中拉取。</p>
<p><code>pkgs</code>即x86原生的软件包。</p>
<p>shell_cross_platform.nix使用例子，</p>
<pre><code class="language-bash"># 创建一个新的shell环境，包含stdenv.cc, figlet, qemu
$ nix-shell shell_cross_platform.nix

# 使用交叉编译工具链的c编译器
$ aarch64-unknown-linux-gnu-gcc helloworld.c -o helloworld
$ file helloworld
helloworld: ELF 64-bit LSB executable, ARM aarch64, version 1 (SYSV), dynamically linked, interpreter /nix/store/01kw0gb38phviarfv3fca49dpqh0qwlx-glibc-aarch64-unknown-linux-gnu-2.33-123/lib/ld-linux-aarch64.so.1, for GNU/Linux 2.6.32, with debug_info, not stripped

# arm原生应用
$ file `command -v figlet`
/nix/store/4f70f04bvd664n00jlnzccyzxd35lykw-figlet-2.2.5/bin/figlet: ELF 64-bit LSB executable, ARM aarch64, version 1 (SYSV), dynamically linked, interpreter /nix/store/rjc27shzir243n1w3127w713fijamf6v-glibc-2.33-123/lib/ld-linux-aarch64.so.1, for GNU/Linux 2.6.32, not stripped

# 直接执行figlet会出错
$ figlet
bash: /nix/store/4f70f04bvd664n00jlnzccyzxd35lykw-figlet-2.2.5/bin/figlet: cannot execute binary file: Exec format error

# 使用QEMU执行figlet即可
$ qemu-aarch64 `command -v figlet` miao!
           _             _
 _ __ ___ (_) __ _  ___ | |
| '_ ` _ \| |/ _` |/ _ \| |
| | | | | | | (_| | (_) |_|
|_| |_| |_|_|\__,_|\___/(_)
</code></pre>
<h3 id="mips交叉工具链的例子"><a class="header" href="#mips交叉工具链的例子">mips交叉工具链的例子</a></h3>
<p>[cross_mips.nix]({{ site.repo_url }}/scripts/shell/cross_mips.nix)</p>
<h2 id="crosssystem的传递"><a class="header" href="#crosssystem的传递">crossSystem的传递</a></h2>
<ul>
<li>pkgs/top-level/stage.nix:
<ul>
<li>
<pre><code class="language-nix">pkgsCross = lib.mapAttrs (n: crossSystem:
  nixpkgsFun { inherit crossSystem; })
  lib.systems.examples;
</code></pre>
</li>
</ul>
</li>
<li>其中pkgs/top-level/default.nix: <code>nixpkgsFun = newArgs: import ./. (args // newArgs);</code></li>
<li>也就是说lib.systems.examples的每个元素作为crossSystem传递给了pkgs/top-level/default.nix</li>
<li>pkgs/top-level/default.nix:
<ul>
<li>首先crossSystem = lib.systems.elaborate crossSystem0</li>
<li>接下来是推导</li>
<li>pkgs = boot stages;</li>
<li>pkgs = boot (stdenvStages {inherit crossSystem ...});</li>
<li>pkgs = boot (import ../stdenv {inherit crossSystem ...})</li>
</ul>
</li>
<li>pkgs/stdenv/default.nix:
<ul>
<li>pkgs = boot (import ./cross {inherit crossSystem ...})</li>
</ul>
</li>
<li>pkgs/stdenv/cross/default.nix:
<ul>
<li>pkgs = boot (lib.init bootStages ++ [(...) (..crossSystem..) (..crossSystem..)])</li>
<li>包含了若干个stages，包括本地的bootStages的前几个stages、和crossSystem相关的3个stages（其实只有最后两个stages使用了crossSystem）</li>
<li>这里需要搞清楚boot是怎么调用stages的</li>
<li>pkgs/top-level/default.nix:
<ul>
<li>boot = import ../stdenv/bo（__raw=false或未定义）oter.nix { inherit lib allPackages; };</li>
<li>boot = import ../stdenv/booter.nix { ...; allPackages = newArgs: import ./stage.nix ({inherit lib nixpkgsFun;} // newArgs);};</li>
</ul>
</li>
<li>pkgs/stdenv/booter.nix:
<ul>
<li>
<p>注释写了boot的功能，如下：
参数为一个函数数组，每个函数的输入为pkgset，输出要么是pkgset的参数（__raw=false或未定义），要么是pkgsset（__raw=true）。
（这里说的“pkgset的参数”会传给allPackages（是个函数，见上））</p>
<pre><code class="language-nix"># Type:
#   [ pkgset -&gt; (args to stage/default.nix) or ({ __raw = true; } // pkgs) ]
#   -&gt; pkgset
#
# In english: This takes a list of function from the previous stage pkgset and
# returns the final pkgset. Each of those functions returns, if `__raw` is
# undefined or false, args for this stage's pkgset (the most complex and
# important arg is the stdenv), or, if `__raw = true`, simply this stage's
# pkgset itself.
</code></pre>
</li>
</ul>
</li>
<li>所以最终还是得看下面两个使用了crossSystem的stages</li>
</ul>
</li>
<li>pkgs/stdenv/cross/default.nix:
<ul>
<li>
<p>pkgs = boot (lib.init bootStages ++ [(...) ❶(..crossSystem..) ❷(..crossSystem..)])</p>
</li>
<li>
<p>❶</p>
<pre><code class="language-nix">  # Build tool Packages
  (vanillaPackages: {
    ...
    stdenv = assert ...;
      vanillaPackages.stdenv.override { targetPlatform = crossSystem; };
    ...
  })
</code></pre>
<p>输入是vanillaPackages，输出是buildPackages的参数（为生成下一级的输入pkgset即buildPackages）。
因此，这一级（即buildPackages，pkgsCross.<xxx>.buildPackages）的3个平台为：</p>
<div class="table-wrapper"><table><thead><tr><th>build</th><th>host</th><th>target</th></tr></thead><tbody>
<tr><td>localSystem</td><td>localSystem</td><td>crossSystem</td></tr>
</tbody></table>
</div>
<p>因此这一级的包是用来构建各种交叉工具链的包。</p>
<p>注：nixpkgs里也有叫buildPackages的包，定义位于pkgs/top-level/stage.nix：
buildPackages是pkgsBuildHost的别名，其中pkgs<theirHost><theirTarget>。</p>
</li>
<li>
<p>❷</p>
<pre><code class="language-nix"># Run Packages
(buildPackages: let
  ...
  stdenNoCC = adaptStdenv (buildPackages.stdenv.override (old: rec {
    buildPlatform = localSystem;
    hostPlatform = crossSystem;
    targetPlatform = crossSystem;
    ...
  }));
in {
  ...
  stdenv = let
    baseStdenv = stdenNoCC.override {
      cc = ... buildPackages.gcc;
    }
  in ... baseStdenv;
  ...
})
</code></pre>
<p>这一级输入是buildPackages，输出就是我们平时pkgsCross.<xxx>的包集合了。
这一级（即pkgsCross.<xxx>）的3个平台为</p>
<div class="table-wrapper"><table><thead><tr><th>build</th><th>host</th><th>target</th></tr></thead><tbody>
<tr><td>localSystem</td><td>crossSystem</td><td>crossSystem</td></tr>
</tbody></table>
</div>
<p>其中要注意的是，pkgsCross.<xxx>.stdenv.cc就是pkgsCross.<xxx>.buildPackages.gcc。</p>
</li>
</ul>
</li>
</ul>
<h2 id="引用-1"><a class="header" href="#引用-1">引用</a></h2>
<div class="footnote-definition" id="version"><sup class="footnote-definition-label">1</sup>
<p>nixpkgs版本2022.01.20, commit hash: 7e149abe9db1509fa974bb2286f862a761ca0a07</p>
</div>
<div class="footnote-definition" id="localSystem_crossSystem"><sup class="footnote-definition-label">2</sup>
<p>nixpkgs/pkgs/top-level/default.nix</p>
</div>
<div class="footnote-definition" id="localSystem_crossSystem_type"><sup class="footnote-definition-label">3</sup>
<p>nixpkgs/lib/systems/default.nix: <code>elaborate</code></p>
</div>
<div class="footnote-definition" id="skeleton"><sup class="footnote-definition-label">4</sup>
<p>nixpkgs/lib/systems/parse.nix: <code>mkSkeletonFromList</code></p>
</div>
<div class="footnote-definition" id="cpuTypes"><sup class="footnote-definition-label">5</sup>
<p>nixpkgs/lib/systems/parse.nix: <code>cpuTypes</code></p>
</div>
<div class="footnote-definition" id="isCompatible"><sup class="footnote-definition-label">6</sup>
<p>nixpkgs/lib/systems/parse.nix: <code>isCompatible</code></p>
</div>
<div class="footnote-definition" id="kernels"><sup class="footnote-definition-label">7</sup>
<p>nixpkgs/lib/systems/parse.nix: <code>kernels</code></p>
</div>
<div class="footnote-definition" id="abis"><sup class="footnote-definition-label">8</sup>
<p>nixpkgs/lib/systems/parse.nix: <code>abis</code></p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="安装nixos"><a class="header" href="#安装nixos">安装NixOS</a></h1>
<p>安装过程采用<a href="https://nixos.org/manual/nixos/stable/#sec-installation">官方安装文档</a>。
若已安装NixOS，则可跳过该步骤，直接看安装我的配置。</p>
<h2 id="准备镜像"><a class="header" href="#准备镜像">准备镜像</a></h2>
<p>QEMU:</p>
<pre><code class="language-bash"># 下载minimal ISO镜像：https://nixos.org/download.html
# 创建qemu硬盘（大小32GB）
qemu-img create -f qcow2 &lt;output/path/to/nix.qcow2&gt; 32G
# 将ISO安装到qemu硬盘
qemu-system-x86_64 -display gtk,window-close=off -vga virtio -device e1000,netdev=net0 -netdev user,id=net0,hostfwd=tcp::5556-:22,smb=/home/xieby1/ -m 4G -smp 3 -enable-kvm -hda &lt;/path/to/nix.qcow2&gt; -cdrom &lt;/path/to/nixos-minial.iso&gt; -boot d &amp;
</code></pre>
<p>物理机:</p>
<pre><code class="language-bash"># 暂时未探究命令行连接wifi的方法
# 所以目前使用gnome版ISO，而非minimal ISO。
# 下载gnome ISO镜像：https://nixos.org/download.html
# 启动U盘制作
sudo dd if=&lt;path/to/nixos.iso&gt; of=&lt;/dev/your_usb&gt;
sync
# 重启进入U盘系统
# 注：需要在BIOS中取消secure boot，否则U盘无法启动。
</code></pre>
<h2 id="分区"><a class="header" href="#分区">分区</a></h2>
<p>进入ISO系统后，创建分区。
一共需要3个分区：启动分区，操作系统分区，swap分区。
QEMU和物理机单系统需要创建这3个分区。
物理机双系统中启动分区已有，只需创建剩下2个分区。</p>
<p>QEMU:</p>
<pre><code class="language-bash">sudo bash
parted /dev/sda -- mklabel msdos
parted /dev/sda -- mkpart primary 1MiB -8GiB
parted /dev/sda -- mkpart primary linux-swap -8GiB 100%
</code></pre>
<p>物理机单系统:</p>
<pre><code class="language-bash">parted /dev/sda -- mklabel gpt
parted /dev/sda -- mkpart primary 512MiB -8GiB
parted /dev/sda -- mkpart primary linux-swap -8GiB 100%
parted /dev/sda -- mkpart ESP fat32 1MiB 512MiB
parted /dev/sda -- set 3 esp on
</code></pre>
<p>物理机双系统:</p>
<p><strong>注</strong>：用disk创建的文件系统，权限不对，安装完后会有各种奇怪的问题。
因此推荐命令行操作，或者disk之后再执行下一节的指令。</p>
<p>还未探索parted详细用法，目前使用disk软件可视化分区。</p>
<ul>
<li>创建Ext4分区，取名为nixos</li>
<li>创建Other-&gt;swap分区</li>
</ul>
<h2 id="文件系统"><a class="header" href="#文件系统">文件系统</a></h2>
<pre><code class="language-bash">mkfs.ext4 -L nixos /dev/&lt;系统分区&gt;
mkswap -L swap /dev/&lt;swap分区&gt;
swapon /dev/&lt;swap分区&gt;
mkfs.fat -F 32 -n boot /dev/&lt;启动分区&gt;      # 物理机单系统
mount /dev/disk/by-label/nixos /mnt
mkdir -p /mnt/boot                          # 物理机单系统&amp;双系统
mount /dev/disk/by-label/boot /mnt/boot     # 物理机单系统&amp;双系统
</code></pre>
<h2 id="基础配置"><a class="header" href="#基础配置">基础配置</a></h2>
<ul>
<li>生成配置文件</li>
</ul>
<pre><code class="language-bash">nixos-generate-config --root /mnt
</code></pre>
<ul>
<li>修改/mnt/etc/nixos/configuration.nix，
<ul>
<li>修改名字<code>networking.hostName</code></li>
<li>启用代理
<ul>
<li>QEMU中宿主机器的ip为10.0.2.2</li>
<li>安装过程中需要借助别的计算机或宿主机的的代理服务</li>
<li>部署完我的nixos配置后，将会有clash服务，可以用虚拟机的代理服务</li>
<li><code>networking.proxy.default = "http://user:password@proxy:port/";</code></li>
<li><code>networking.proxy.noProxy = "127.0.0.1,localhost,internal.domain";</code></li>
</ul>
</li>
<li>（QEMU和物理机单系统）取消以下注释以开启grub支持
<ul>
<li><code>boot.loader.grub.device = "/dev/sda";</code></li>
</ul>
</li>
<li>取消防火墙，以便kdeconnect正常运行
<ul>
<li><code>networking.firewall.enable = false;</code></li>
</ul>
</li>
<li>（物理机双系统）自动探测操作系统启动项
<ul>
<li><code>boot.loader.grub.useOSProber = true;</code></li>
</ul>
</li>
<li>添加用户
<ul>
<li><code>users.users.xieby1</code></li>
</ul>
</li>
<li>添加软件
<ul>
<li><code>environment.systemPackages = with pkgs; [vim git];</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>最后</p>
<pre><code class="language-bash">nixos-install
reboot
</code></pre>
<p>重启之后，进入NixOS。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-config-linux-kernel-in-nix"><a class="header" href="#how-to-config-linux-kernel-in-nix">How To Config Linux Kernel in Nix</a></h1>
<p>Basic configuration tricks referring to <a href="https://nixos.wiki/wiki/Linux_kernel">nixos.wiki: Linux Kernel</a>.</p>
<h2 id="the-override-system-in-kernel"><a class="header" href="#the-override-system-in-kernel">The Override System in Kernel</a></h2>
<p>What do the <code>pkgs.linux.override</code>, <code>pkgs.linux.overrideAttrs</code> override?</p>
<p>To answer these questions, we need first to explore how kernel derivation is generated.
When we type <code>pkgs.linux</code>, how this derivation is generated by nix?</p>
<pre><code>* pkgs.linux
* pkgs/top-level/all-packages:
  * linuxPackages.kernel;
  * (linuxPackages = linuxKernel.packageAliases.linux_default).kernel;
  * (linuxPackages = (linuxKernel = recurseIntoAttrs (callPackage ./linux-kernels.nix { });).packageAliases.linux_default).kernel;
  * (recurseIntoAttrs (callPackage ./linux-kernels.nix { });).packageAliases.linux_default.kernel;
* pkgs/top-level/linux-kernels.nix:
  * packages.linux_6_6.kernel;
  * (recurseIntoAttrs (vanillaPackages // rtPackages // rpiPackages // { ... })).linux_6_6.kernel
  * (recurseIntoAttrs ({...; linux_6_6 = recurseIntoAttrs (packagesFor kernels.linux_6_6);...} // rtPackages // rpiPackages // { ... })).linux_6_6.kernel
  * (packagesFor kernels.linux_6_6).kernel
  * ((kernel_: {kernel = kernel_;}) kernels.linux_6_6).kernel
  * kernels.linux_6_6
  * ❶callPackage ../os-specific/linux/kernel/mainline.nix {
      branch = "6.6";
      kernelPatches = [
        kernelPatches.bridge_stp_helper
        kernelPatches.request_key_helper
      ];
    };
* pkgs/os-specific/linux/kernel/mainline.nix
  * buildLinux args'
  * ❷buildLinux ((builtins.removeAttrs args [ "branch" ])
    // {
      inherit src version;

      modDirVersion = lib.versions.pad 3 version;
      extraMeta.branch = branch;
    }
    // (args.argsOverride or { }))
  * (callPackage pkgs/os-specific/linux/kernel/generic.nix {}) args'
  * overridableKernel args'
  * (lib.makeOverridable ({...}: kernel.overrideAttrs (...))) args'
  * kernel.overrideAttrs (...)
  * ❸((callPackage ./manual-config.nix { inherit lib stdenv buildPackages; }) (basicArgs // { ... })).overrideAttrs (...)
</code></pre>
<p>因此</p>
<ul>
<li>❶ <code>override</code> is applied to <code>pkgs/os-specific/linux/kernel/mainline.nix</code></li>
<li>❷ <code>argsOverride</code> in <code>override (old: {argsOverride = {...} })</code> is applied to <code>pkgs/os-specific/linux/kernel/generic.nix</code></li>
<li>❸ <code>overrideAttrs</code> is applied to <code>pkgs/os-specific/linux/kernel/manual-config.nix</code></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><h1 id="nix让你的团队成员不再受环境问题困扰"><a class="header" href="#nix让你的团队成员不再受环境问题困扰">Nix让你的团队成员不再受环境问题困扰</a></h1>
<p>注：左下角菜单里可切换全屏</p>
<iframe src="./2023.nix-env.slides.html" style="width: 100%;aspect-ratio:12/7;" frameBorder="0"></iframe>
<div style="break-before: page; page-break-before: always;"></div><p>See all fhs-shell scripts on [Github repo: scripts/fhs-shell]({{ site.repo_url }}/scripts/fhs-shell)</p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
{ pkgs ? import &lt;nixpkgs&gt; {} }:
(pkgs.buildFHSUserEnv {
  name = "dynamoRIO";
  targetPkgs = pkgs: with pkgs; [
    (hiPrio gcc)
    snappy
    zlib
    zlib.dev
    lz4
    lz4.dev
    libunwind
    libunwind.dev
  ];
  profile = ''
    export CC=gcc
    export CXX=g++
  '';
}).env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
let
  pkgs = import &lt;nixpkgs&gt; {};
  fhs = pkgs.buildFHSUserEnv {
    name = "hello";
    targetPkgs = p: with p; [
      hello
    ];
    profile = ''
      export MIAO=1
    '';
  };
in
  fhs.env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
{ pkgs ? import &lt;nixpkgs&gt; {} }:
let
  pin = builtins.derivation {
    name = "pin-3.25";
    system = builtins.currentSystem;
    src = pkgs.fetchurl {
      url = "https://software.intel.com/sites/landingpage/pintool/downloads/pin-3.25-98650-g8f6168173-gcc-linux.tar.gz";
      hash = "sha256-Q8D0QSNLDly2XK+XFOYdMxbx5N33eGVzESGTCgWGX6E=";
    };
    builder = pkgs.writeShellScript "pin-builder" ''
      # make mkdir and tar and other useful tools added to PATH
      source ${pkgs.stdenv}/setup
      mkdir -p $out
      # strip leading directory
      tar -xf $src --strip-components=1 --directory=$out
    '';
  };
in
(pkgs.buildFHSUserEnv {
  name = "pin";
  targetPkgs = pkgs: with pkgs; [
  ];
  profile = ''
    PATH+=":${pin}"
  '';
}).env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
{ pkgs ? import &lt;nixpkgs&gt; {} }:
let
  zigenv = import /home/xieby1/Codes/nix-zig-stdenv {
    target = "x86_64-unknown-linux-musl";
  };
  noPrefixStaticStdenvCC = pkgs.runCommand "linkCC" {} ''
    mkdir -p $out/bin
    for file in ${pkgs.pkgsStatic.stdenv.cc}/bin/*; do
      ln -s $file $out/bin/''${file##*-}
    done
  '';
in
(pkgs.buildFHSUserEnv {
  name = "spec";
  targetPkgs = pkgs: with pkgs; [
    # (hiPrio zigenv.pkgs.stdenv.cc)
    # (hiPrio clangStdenv.cc)
    # (hiPrio gcc)
    # (hiPrio pkgsStatic.stdenv.cc)
    # noPrefixStaticStdenvCC
    gfortran
    # uclibc
    # musl
    # musl.dev
    glibc.static
    glibc.dev
  ];
}).env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
# https://ryantm.github.io/nixpkgs/builders/special/fhs-environments/

{ pkgs ? import &lt;nixpkgs&gt; {} }:

(pkgs.buildFHSUserEnv {
  name = "simple-x11-env";
  targetPkgs = pkgs: (with pkgs;
    [ udev
      alsa-lib
    ]) ++ (with pkgs.xorg;
    [ libX11
      libXcursor
      libXrandr
    ]);
  multiPkgs = pkgs: (with pkgs;
    [ udev
      alsa-lib
    ]);
  runScript = "bash";
}).env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
# based on https://github.com/nix-community/nix-environments
#   git commit: 40d9d98bab7750bb5a1a9a3b5bcc1c91a652f3be
{ pkgs ? import &lt;nixpkgs&gt; {} }:
let
  name = "xilinx-fhs";
  h_content = builtins.toFile "h_content" ''
    # ${pkgs.lib.toUpper "${name} usage"}

    **Commands**

    * Show this help: `h`
    * Start Vitis HLS IDE: `vitis_hls`
    * Start Vitis HLS REPL: `vitis_hls -i`

    **Files**

    * Vitis HLS Doc: `2022.vitis_hls.ug1399.pdf`
    * Local command doc: `Xilinx/Vitis/2022.2/doc/eng/man/`
    * TODO: `ug871-vivado-high-level-synthesis-tutorial.pdf`
    * TODO: `ug902-vivado-high-level-synthesis.pdf`

    **Examples**

    * [Vitis HLS examples](https://github.com/Xilinx/Vitis-HLS-Introductory-Examples)
    * Run an example: `vitis_hls -f run_hls.tcl`
  '';
  _h_ = pkgs.writeShellScriptBin "h" ''
    ${pkgs.glow}/bin/glow ${h_content}
  '';
in
(pkgs.buildFHSUserEnv {
  inherit name;
  targetPkgs = pkgs: with pkgs; [
    _h_

    bash
    coreutils
    zlib
    lsb-release
    stdenv.cc.cc
    ncurses5
    xorg.libXext
    xorg.libX11
    xorg.libXrender
    xorg.libXtst
    xorg.libXi
    xorg.libXft
    xorg.libxcb
    xorg.libxcb
    # common requirements
    freetype
    fontconfig
    glib
    gtk2
    gtk3
    # vitis_hls gcc needs
    glibc.dev

    # to compile some xilinx examples
    opencl-clhpp
    ocl-icd
    opencl-headers

    # from installLibs.sh
    graphviz
    (lib.hiPrio gcc)
    unzip
    nettools
  ];
  multiPkgs = null;
  profile = ''
    export LC_NUMERIC="en_US.UTF-8"
    source ~/Xilinx/Vitis_HLS/*/settings64.sh
    h
  '';
}).env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p>See all fhs-shell scripts on [Github repo: scripts/pkgs]({{ site.repo_url }}/scripts/pkgs)</p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># TODO: 7z need dynamical link 7z.so
#   but static compilation prevents this behavior?
{pkgs ? import &lt;nixpkgs&gt; {}}:
let cross = import /home/xieby1/Codes/nix-zig-stdenv {
  inherit pkgs;
  target = "x86_64-unknown-linux-musl";
};
in
cross.pkgs.p7zip.overrideAttrs (old: {
  postPatch = old.postPatch + ''
    sed -i '/CC=/d' makefile.machine
    sed -i '/CXX=/d' makefile.machine
  '';
})
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><div style="text-align:right; font-size:3em;">2022.04.19</div>
<h1 id="在nixos上使用android程序"><a class="header" href="#在nixos上使用android程序">在NixOS上使用Android程序</a></h1>
<p>TLDR: 使用Android Studio提供的Android Emulator体验最好，其次是使用QEMU+x86Android。</p>
<!-- vim-markdown-toc GFM -->
<ul>
<li><a href="scripts/pkgs/android.html#anbox--waydroid">Anbox &amp; Waydroid</a></li>
<li><a href="scripts/pkgs/android.html#qemu--x86-android">qemu + x86 Android</a></li>
<li><a href="scripts/pkgs/android.html#google-android-emulator">Google Android Emulator</a>
<ul>
<li><a href="scripts/pkgs/android.html#%E8%8E%B7%E5%8F%96apk-package%E5%92%8Cactivity">获取apk package和activity</a></li>
<li><a href="scripts/pkgs/android.html#avdmanager%E6%89%BE%E4%B8%8D%E5%88%B0%E9%95%9C%E5%83%8F">avdmanager找不到镜像</a></li>
<li><a href="scripts/pkgs/android.html#%E6%A8%A1%E6%8B%9F%E5%99%A8%E9%97%AA%E9%80%80">模拟器闪退</a></li>
<li><a href="scripts/pkgs/android.html#debug-%E6%96%B9%E6%B3%95">debug 方法</a></li>
<li><a href="scripts/pkgs/android.html#pci-bus-not-available-for-hda">PCI bus not available for hda</a></li>
</ul>
</li>
<li><a href="scripts/pkgs/android.html#google-android-studio">Google Android Studio</a></li>
<li><a href="scripts/pkgs/android.html#redroid">redroid</a></li>
</ul>
<!-- vim-markdown-toc -->
<h2 id="anbox--waydroid"><a class="header" href="#anbox--waydroid">Anbox &amp; Waydroid</a></h2>
<p>Anbox &amp; Waydroid属于将Android runtime移植到Linux上的项目。
都需要安装内核模块。</p>
<p>Anbox已未维护。</p>
<p>Waydroid需要Wayland支持。目前我还采用X11。</p>
<h2 id="qemu--x86-android"><a class="header" href="#qemu--x86-android">qemu + x86 Android</a></h2>
<p>虚拟机，没有找到图形和音频的加速方法。基本可用的程度。</p>
<ul>
<li>vanilla x86 android: OK</li>
<li>lineageOS: OK
<ul>
<li>same to vanilla x86 android</li>
<li>wechat not work</li>
</ul>
</li>
<li>phoenixOS: stuck in booting</li>
</ul>
<pre><code class="language-bash"># 安装在运行命令后添加-cdrom &lt;/path/to/iso&gt; -boot -d
# 运行命令
qemu-system-x86_64 -m 4G -smp 3 -hda ~/Img/andx64_vcm141r5.qcow2 -enable-kvm -display gtk,window-close=off -device AC97
</code></pre>
<p>注：-vga virtio不能启动图形界面，原因未探索。</p>
<h2 id="google-android-emulator"><a class="header" href="#google-android-emulator">Google Android Emulator</a></h2>
<p>使用nix提供的emulate-app.nix直接运行Google Android Emulator (魔改的QEMU)。</p>
<p>模拟器闪退无法启动，暂时没有尝试去解决。</p>
<p>参考</p>
<ul>
<li>https://nixos.wiki/wiki/Android
<ul>
<li><a href="https://sandervanderburg.blogspot.com/2014/02/reproducing-android-app-deployments-or.html">2014: Reproducing Android app deployments (or playing Angry Birds on NixOS)</a></li>
</ul>
</li>
<li><a href="https://stackoverflow.com/questions/24627978/run-android-app-in-qemu-arm">SO: Run Android app in qemu-arm?</a>
<ul>
<li><a href="https://www.linaro.org/blog/running-64bit-android-l-qemu/index.html">2014: Running Android L Developer Preview on 64-bit Arm QEMU</a></li>
</ul>
</li>
</ul>
<p>使用的nix脚本见android.nix</p>
<h3 id="获取apk-package和activity"><a class="header" href="#获取apk-package和activity">获取apk package和activity</a></h3>
<p>aapt已经淘汰，现在使用的是<a href="https://developer.android.com/studio/command-line/aapt2#download_aapt2">aapt2</a>，run by <a href="https://github.com/thiagokokada/nix-alien">nix-alien</a>。
例子，</p>
<pre><code class="language-bash">nix-alien aapt2 dump badging &lt;/path/to/apk&gt;
</code></pre>
<h3 id="avdmanager找不到镜像"><a class="header" href="#avdmanager找不到镜像">avdmanager找不到镜像</a></h3>
<p>Error: Package path is not valid. Valid system image paths are:ository...</p>
<p>相关问题</p>
<ul>
<li><a href="https://github.com/NixOS/nixpkgs/issues/154898">GH: avdmanager create avd fails with "Probably the SDK is read-only" #154898</a>
<ul>
<li><a href="https://github.com/NixOS/nixpkgs/issues/121146">GH: androidenv.emulateApp fails to start emulator (libvulkan.so.1: full) #121146</a></li>
</ul>
</li>
<li><a href="https://stackoverflow.com/questions/66597053">SO: error: package path is not valid. valid system image paths are:ository... null</a></li>
</ul>
<p>从pkgs/development/mobile/androidenv/compose-android-packages.nix看，
platformVersions, systemImageTypes, abiVersions需要和
pkgs/development/mobile/androidenv/repo.json
中的emulator项中的数据匹配。</p>
<p>看repo.json，而不是看<code>sdkmanager --list</code>，不一定有，但能看到已安装。</p>
<p>不匹配，在nix-build中不会报错，运行过程报上面的错误。</p>
<h3 id="模拟器闪退"><a class="header" href="#模拟器闪退">模拟器闪退</a></h3>
<p>和问题类似<a href="https://github.com/NixOS/nixpkgs/issues/121146">GH: androidenv.emulateApp fails to start emulator (libvulkan.so.1: full) #121146</a></p>
<p>报错内容，没解决</p>
<pre><code class="language-bash">cannot add library /nix/store/yz1p6cw09h3im4z7wmx7nshi054fzhw4-emulator-30.8.4/libexec/android-sdk/emulator/qemu/linux-x86_64/lib64/vulkan/libvulkan.so: failed
added library /nix/store/yz1p6cw09h3im4z7wmx7nshi054fzhw4-emulator-30.8.4/libexec/android-sdk/emulator/lib64/vulkan/libvulkan.so
emulator: WARNING: Ignoring invalid http proxy: Bad format: invalid port number (must be decimal)
Device state has been reached
LLVM ERROR: Cannot select: intrinsic %llvm.x86.sse41.pblendvb
</code></pre>
<h3 id="debug-方法"><a class="header" href="#debug-方法">debug 方法</a></h3>
<p>参考https://nixos.wiki/wiki/Nixpkgs/Create_and_debug_packages#How_to_install_from_the_local_repository</p>
<p>使用本地nixpkgs，修改，nix-shell看变量
例子：</p>
<pre><code class="language-bash">nix-shell -E 'with import "/home/xieby1/temp-nixpkgs" {config.android_sdk.accept_license = true;}; (androidenv.composeAndroidPackages {includeSystemImages =true; platformVersions=["16"];}).androidsdk'
</code></pre>
<p>nix expression调用关系</p>
<ul>
<li>emulate-app.nix
<ul>
<li>compose-android-packages.nix
<ul>
<li>tools.nix
<ul>
<li>tools/26.nix
<ul>
<li>deploy-androidpackage.nix</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="pci-bus-not-available-for-hda"><a class="header" href="#pci-bus-not-available-for-hda">PCI bus not available for hda</a></h3>
<p>https://stackoverflow.com/questions/69297141/android-11-emulator-gives-pci-bus-not-available-for-hda</p>
<p>修改./result/bin/run-test-emulator添加-qemu -machine virt到Launch the emulator的指令后</p>
<pre><code class="language-bash">/nix/store/0q68cfq7rnbw752l89fkxf425v1pb2r6-androidsdk/libexec/android-sdk/emulator/emulator -avd device -no-boot-anim -port $port $NIX_ANDROID_EMULATORFLAGS -qemu -machine virt &amp;
</code></pre>
<h2 id="google-android-studio"><a class="header" href="#google-android-studio">Google Android Studio</a></h2>
<p>使用Android Studio的AVD安装Android emulator最省心。</p>
<p>可以使用微信（公众号闪退），语音视频流畅，小游戏流畅。</p>
<h2 id="redroid"><a class="header" href="#redroid">redroid</a></h2>
<p>暂时没成功</p>
<p>文档并未提供和各个参数相关的源文件？</p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build

# https://nixos.wiki/wiki/Android
#  Building Android applications with the Nix package manager: https://sandervanderburg.blogspot.com/2014/02/reproducing-android-app-deployments-or.html
let
  # current nixpkgs-unstable
  pkgs = import (with import &lt;nixpkgs&gt; {}; fetchFromGitHub {
    owner = "NixOS";
    repo = "nixpkgs";
    rev = "1c851e8c92b76a00ce84167984a7ec7ba2b1f29c";
    hash = "sha256-vRxti8pOuXS0rJmqjbD8ueEEFXWSK22ISHoCWkhgzzg=";
  }){
    config.android_sdk.accept_license = true;
    config.allowUnfree = true;
  };
in pkgs.androidenv.emulateApp {
  name = "androidEmuApp";
  app = pkgs.fetchurl {
    url = "https://github.com/SimpleMobileTools/Simple-Calendar/releases/download/6.13.5/calendar-release.apk";
    sha256 = "12vzcd6klnk38b55szmd5a8ydc70fk6aak31qvlild83jy9z21zk";
  };
  enableGPU = false;
  # get these info by `pkgs/development/mobile/androidenv/repo.json`
  # see if installed `sdkmanager --list`
  platformVersion = "32";
  abiVersion = "x86";
  systemImageType = "google_apis";

  package = "com.simplemobiletools.calendar.pro";

  avdHomeDir = "$HOME/.android";
  sdkExtraArgs = {
    includeSystemImages = true;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  pkgs = import &lt;nixpkgs&gt; {};
  squashfuse-with-headers = pkgs.pkgsStatic.squashfuse.overrideAttrs (old: {
    src = pkgs.fetchurl {
      url = "https://github.com/vasi/squashfuse/archive/e51978c.tar.gz";
      hash = "sha256-9UQCmtMNj73k5FQMV0uM3G04uU3wJamNhVGpRB8H00E=";
    };
    postInstall = ''
      mkdir -p $out/include/squashfuse
      cp *.h $out/include/squashfuse
    '';
  });
  srcRev = "c1ea7509bc179a05d907baca64f41875662f35f2";
in pkgs.stdenv.mkDerivation {
  name = "appimage-runtime";
  src = pkgs.fetchFromGitHub {
    owner = "AppImage";
    repo = "type2-runtime";
    rev = "${srcRev}";
    sha256 = "1gr853iz1x6pgyav3w1kqaaaz2ybbx67dcg74kj54yrwlakrh165";
  };
  nativeBuildInputs = with pkgs; [
    pkg-config
  ];
  buildInputs = (with pkgs.pkgsStatic; [
    squashfuse-with-headers
    fuse
    zstd
    zlib

    lz4.out
    lzo
    lzma.out
  ]) ++ (with pkgs; [
    glibc.static
  ]);
  sourceRoot = "source/src/runtime";
  buildPhase = ''
    export CFLAGS="-std=gnu99 -s -Os -D_FILE_OFFSET_BITS=64 -DGIT_COMMIT=\"${srcRev}\" -T data_sections.ld -ffunction-sections -fdata-sections -Wl,--gc-sections -static"
    export LIBS="-lsquashfuse -lsquashfuse_ll -lzstd -lz -llz4 -llzo2 -llzma"
    $CC -I${squashfuse-with-headers}/include/squashfuse -I${pkgs.pkgsStatic.fuse}/include/fuse -o runtime-fuse2.o -c $CFLAGS runtime.c
    $CC $CFLAGS runtime-fuse2.o $LIBS -lfuse -o runtime-fuse2
  '';
  installPhase = ''
    mkdir -p $out/bin
    cp runtime-fuse2 $out/bin/
  '';
}

# in pkgs.mkShell {
#   name = "appimage-runtime";
#   packages = (with pkgs.pkgsStatic; [
#     squashfuse-with-headers
#     fuse
#     zstd
#     zlib

#     lz4.out
#     lzo
#     lzma.out
#   ]) ++ (with pkgs; [
#     glibc.static
#     pkg-config
#   ]);
# }

# in (pkgs.buildFHSUserEnv {
#   name = "appimage-runtime-fhs";
#   targetPkgs = pkgs: (with pkgs.pkgsStatic; [
#     squashfuse-with-headers
#     fuse
#     zstd
#     zlib

#     lz4.out
#     lzo
#     lzma.out
#   ]) ++ (with pkgs; [
#     glibc.static
#     pkg-config
#   ]);
# }).env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-build -o coremarks
{pkgs ? import &lt;nixpkgs&gt; {}}:
let
  # function mkCoremark
  mkCoremark = {
    pkgs ? import &lt;nixpkgs&gt; {},
    stdenv ? pkgs.stdenv,
    simple ? false,
  }:
  let
    name = "coremark";
    variant = pkgs.lib.concatStrings [
      "${stdenv.targetPlatform.config}"
      # TODO: all zig-env are static?
      # (if stdenv.targetPlatform.isStatic then ".static" else "")
      (if simple then ".simple" else "")
    ];
  in
  stdenv.mkDerivation {
    inherit name;
    src = pkgs.fetchFromGitHub {
      owner = "eembc";
      repo = "coremark";
      rev = "d26d6fdcefa1f9107ddde70024b73325bfe50ed2";
      sha256 = "0kd6bnrnd3f325ypxzn0w5ii4fmc98h16sbvvjikvzhm78y60wz3";
    };
    preBuild = ''
      # no float point insts
      export CFLAGS="-DHAS_FLOAT=0"

      # simple assumes CC = gcc, this is a bug!
      sed -i '/CC =/d' simple/core_portme.mak
      ${if simple
        then "export PORT_DIR=simple"
        else ""}
    '';
    buildFlags = ["compile"];
    installPhase = ''
      mkdir -p $out/bin
      mv coremark.exe $out/bin/${name}.${variant}.exe
    '';
  };
  zig-env-src = pkgs.fetchFromGitHub {
    owner = "Cloudef";
    repo = "nix-zig-stdenv";
    rev = "6de72ec32ecf0cfb9ad9dab5a8400d532e17f8c5";
    hash = "sha256-hQHOzjkHWO5YxQb3mgZJOfyIuvbiLFocVCMK/A9HTic=";
  };
in
pkgs.symlinkJoin {
  name = "coremarks";
  paths = [
    # x86_64 linux
    (mkCoremark {
      inherit (import zig-env-src {
        target = "x86_64-unknown-linux-gnu";
      }) stdenv;
    })
    # x86_64 linux static
    (mkCoremark {
      inherit (import zig-env-src {
        target = "x86_64-unknown-linux-musl";
      }) stdenv;
    })
    # aarch64 linux
    (mkCoremark {
      inherit (import zig-env-src {
        target = "aarch64-unknown-linux-gnu";
      }) stdenv;
    })
    # aarch64 linux static
    (mkCoremark {
      inherit (import zig-env-src {
        target = "aarch64-unknown-linux-musl";
      }) stdenv;
    })
    # riscv64 linux
    # (mkCoremark {
    #   inherit (import zig-env-src {
    #     target = "riscv64-unknown-linux-gnu";
    #   }) stdenv;
    # })
    # riscv64 linux static
    (mkCoremark {
      inherit (import zig-env-src {
        target = "riscv64-unknown-linux-musl";
      }) stdenv;
    })
    # x86_64 windows
    (mkCoremark {
      inherit (import zig-env-src {
        target = "x86_64-w64-mingw32";
      }) stdenv;
      simple = true;
    })
    # x86_64 darwin can only compiled on x86_64/aarch64 darwin
    #   https://github.com/NixOS/nixpkgs/issues/165804
    # while it is possible compile manually inside darling
    #(mkCoremark {
    #  stdenv = pkgs.pkgsCross.x86_64-darwin.stdenv;
    #})
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-env -i -f
# xieby1: 2022.05.16
with (import &lt;nixpkgs&gt; {crossSystem = "mips-linux";}); {
  gdb = lib.lowPrio buildPackages.gdb;
  gcc = lib.lowPrio buildPackages.gcc;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build
let
  pkgs = import (builtins.fetchTarball {
    url = "https://github.com/NixOS/nixpkgs/archive/e60c3e2abb8ae9df3d89820c706cc736fad01ff7.tar.gz";
    sha256 = "0vyjpf1jw4cvw7kfbk055faq08q4swz6v1h2mf9zw4r8frhqa73w";
  }) {};
in
pkgs.pkgsCross.aarch64-multiplatform.pkgsStatic.glib
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-build -o fhs_helloworld

# xieby1: 2022.11.17
# inspired by
#   https://discourse.nixos.org/t/derivation-that-builds-standard-linux-binaries/21557/4
#   https://github.com/NixOS/nixpkgs/compare/master...ElvishJerricco:nixpkgs:run-in-fhs
# TODO-1:
#   I have copy all dependencies to a directory (ld-linux-x86-64.so.2, libc.so)
#   But result cannot run in chroot, error message is `cannot find libc.so`.
# TODO-2:
#   I didn't find a proper package/bundle tool
#   * nix-bundle: not work
#   * appimage: depends on libfuse.so, cannot run directly on nixos

{ pkgs ? import &lt;nixpkgs&gt; {} }:
let
  name = "helloworld";
  fhsEnv = pkgs.buildFHSUserEnv {
    name = "${name}-fhs";
    targetPkgs = pkgs: with pkgs; [
      gcc
      # gcc-unwrapped binutils-unwrapped
      glibc
      glibc.dev
    ];
    # refer to https://discourse.nixos.org/t/using-a-raw-gcc-inside-buildfhsuserenv/12864
    runScript = (pkgs.writeShellScript "${name}-fhsbuilder" ''
      # For gcc-unwrapped and binutils-unwrapped
      # export LIBRARY_PATH=/usr/lib
      # export C_INCLUDE_PATH=/usr/include
      # export CPLUS_INCLUDE_PATH=/usr/include
      # export CMAKE_LIBRARY_PATH=/usr/lib
      # export CMAKE_INCLUDE_PATH=/usr/include
      ## TODO: not work? have to add gcc -Wl,--dynamic-linker=/usr/lib64/ld-linux-x86-64.so.2 ?
      # export LDFLAGS=--dynamic-linker=/usr/lib64/ld-linux-x86-64.so.2

      # For gcc
      export NIX_LDFLAGS="--dynamic-linker=/usr/lib64/ld-linux-x86-64.so.2"
      gcc $src -o $out
    '');
  };
in
builtins.derivation {
  inherit name;
  system = builtins.currentSystem;
  src = builtins.toFile "${name}.c" ''
    #include &lt;stdio.h&gt;
    int main(void) {
      printf("Hello, world! \n");
      return 0;
    }
  '';
  builder = "${fhsEnv}/bin/${fhsEnv.name}";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  name = "perl";
  pkgs = import &lt;nixpkgs&gt; {};
  fhsEnv = pkgs.buildFHSUserEnv {
    name = "${name}-fhs";
    targetPkgs = pkgs: with pkgs; [
      gnumake
    ];
    runScript = (pkgs.writeShellScript "${name}-fhsbuilder" ''
      ls
      cd $src/tools/src
      ls
      DOPERL=1 ./buildtools
    '');
  };
in builtins.derivation {
  inherit name;
  system = builtins.currentSystem;
  src = /home/xieby1/Codes/spec2000;
  builder = "${fhsEnv}/bin/${fhsEnv.name}";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
 pkgs = import &lt;nixpkgs&gt; {};
in
pkgs.stdenv.mkDerivation {
  name = "herdtool7";
  src = pkgs.fetchFromGitHub {
    owner = "herd";
    repo = "herdtools7";
    rev = "7c36d32e7e0dd546296ddd05c5279ae42665a4cf";
    hash = "sha256-gGxM2JYZwbtveQu3PRMKvr4XePJA0jtQK9WUEpCTn8c=";
  };
  buildInputs = [
    pkgs.which
    pkgs.ocamlPackages.ocaml
    pkgs.ocamlPackages.findlib
    pkgs.ocamlPackages.dune_3
    pkgs.ocamlPackages.menhir
    pkgs.ocamlPackages.menhirLib
    pkgs.ocamlPackages.zarith
  ];
  makeFlags = [
    "PREFIX=$(out)"
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-build -o nix-binary-tarballs
</code></pre>
<h1 id="nix-official-installer-new"><a class="header" href="#nix-official-installer-new">Nix official installer (new)</a></h1>
<p>Use nix (&gt;2.18) binary-tarball script, which has not been merged into mainline nixpkgs.</p>
<p>See <a href="scripts/pkgs/./nix-binary-tarballs.nix.html">nix-binary-tarballs.nix</a> for current nix binary-tarball script.</p>
<pre><code class="language-nix">let
  pkgs = import &lt;nixpkgs&gt; {};
  nix_src = pkgs.fetchFromGitHub {
    owner = "NixOS";
    repo = "nix";
    rev = "d0c7da131fb64526bc72144949b6955c25367d92";
    hash = "sha256-Z4RlluZjNXH5BdJiXoe0k43Ry9ptK3jHAsKjlQ3jVZg=";
  };
in pkgs.symlinkJoin {
  name = "nix-binary-tarballs";
  paths = [
    (pkgs.callPackage "${nix_src}/scripts/binary-tarball.nix" {})
    (pkgs.callPackage "${nix_src}/scripts/binary-tarball.nix" {
      nix    = pkgs.pkgsCross.riscv64.nix;
      system = pkgs.pkgsCross.riscv64.nix.stdenv.system;
    })
    (pkgs.callPackage "${nix_src}/scripts/binary-tarball.nix" {
      nix    = pkgs.pkgsCross.loongarch64-linux.nix;
      system = pkgs.pkgsCross.loongarch64-linux.nix.stdenv.system;
    })
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-build -o nix-binary-tarballs
</code></pre>
<h1 id="nix-official-installer"><a class="header" href="#nix-official-installer">Nix official installer</a></h1>
<p>The <code>binaryTarball</code> function is extracted from <a href="https://github.com/NixOS/nix/blob/2.18.2/flake.nix">nix-2.18's flake.nix</a></p>
<p><strong>Noted</strong>:
Although the latest nix has seperate binaryTarball as a independent file,
current unstable nixpkgs still use nix-2.18,
which embed binaryTarball function in nix/flake.nix.
If reuse the binaryTarball file in new nix, then this script can be hugely simplified,
e.g. <a href="scripts/pkgs/./nix-binary-tarballs-new.nix.html">nix-binary-tarballs-new.nix</a>.
As long as, new nix is merged to mainline nixpkgs,
I will deprecate this script and adopt the new script.</p>
<pre><code class="language-nix">let
  pkgs = import &lt;nixpkgs&gt; {};
  binaryTarball =
    { nix
    , buildPackages
    , cacert
    }:
    let
      installerClosureInfo = buildPackages.closureInfo { rootPaths = [ nix cacert ]; };
    in buildPackages.runCommand "nix-binary-tarball-${nix.version}" {
      #nativeBuildInputs = lib.optional (system != "aarch64-linux") shellcheck;
      meta.description = "Distribution-independent Nix bootstrap binaries for ${nix.stdenv.system}";
    } ''
      cp ${installerClosureInfo}/registration $TMPDIR/reginfo
      cp ${nix.src}/scripts/create-darwin-volume.sh $TMPDIR/create-darwin-volume.sh
      substitute ${nix.src}/scripts/install-nix-from-closure.sh $TMPDIR/install \
        --subst-var-by nix ${nix} \
        --subst-var-by cacert ${cacert}
    
      substitute ${nix.src}/scripts/install-darwin-multi-user.sh $TMPDIR/install-darwin-multi-user.sh \
        --subst-var-by nix ${nix} \
        --subst-var-by cacert ${cacert}
      substitute ${nix.src}/scripts/install-systemd-multi-user.sh $TMPDIR/install-systemd-multi-user.sh \
        --subst-var-by nix ${nix} \
        --subst-var-by cacert ${cacert}
      substitute ${nix.src}/scripts/install-multi-user.sh $TMPDIR/install-multi-user \
        --subst-var-by nix ${nix} \
        --subst-var-by cacert ${cacert}
    
      if type -p shellcheck; then
        # SC1090: Don't worry about not being able to find
        #         $nix/etc/profile.d/nix.sh
        shellcheck --exclude SC1090 $TMPDIR/install
        shellcheck $TMPDIR/create-darwin-volume.sh
        shellcheck $TMPDIR/install-darwin-multi-user.sh
        shellcheck $TMPDIR/install-systemd-multi-user.sh
    
        # SC1091: Don't panic about not being able to source
        #         /etc/profile
        # SC2002: Ignore "useless cat" "error", when loading
        #         .reginfo, as the cat is a much cleaner
        #         implementation, even though it is "useless"
        # SC2116: Allow ROOT_HOME=$(echo ~root) for resolving
        #         root's home directory
        shellcheck --external-sources \
          --exclude SC1091,SC2002,SC2116 $TMPDIR/install-multi-user
      fi
    
      chmod +x $TMPDIR/install
      chmod +x $TMPDIR/create-darwin-volume.sh
      chmod +x $TMPDIR/install-darwin-multi-user.sh
      chmod +x $TMPDIR/install-systemd-multi-user.sh
      chmod +x $TMPDIR/install-multi-user
      dir=nix-${nix.version}-${nix.stdenv.system}
      fn=$out/$dir.tar.xz
      mkdir -p $out/nix-support
      echo "file binary-dist $fn" &gt;&gt; $out/nix-support/hydra-build-products
      tar cvfJ $fn \
        --owner=0 --group=0 --mode=u+rw,uga+r \
        --mtime='1970-01-01' \
        --absolute-names \
        --hard-dereference \
        --transform "s,$TMPDIR/install,$dir/install," \
        --transform "s,$TMPDIR/create-darwin-volume.sh,$dir/create-darwin-volume.sh," \
        --transform "s,$TMPDIR/reginfo,$dir/.reginfo," \
        --transform "s,$NIX_STORE,$dir/store,S" \
        $TMPDIR/install \
        $TMPDIR/create-darwin-volume.sh \
        $TMPDIR/install-darwin-multi-user.sh \
        $TMPDIR/install-systemd-multi-user.sh \
        $TMPDIR/install-multi-user \
        $TMPDIR/reginfo \
        $(cat ${installerClosureInfo}/store-paths)
    '';
in pkgs.symlinkJoin {
  name = "nix-binary-tarballs";
  paths = [
    # local nix installer
    (pkgs.callPackage binaryTarball {})
    # riscv64 nix installer
    (pkgs.callPackage binaryTarball {nix=pkgs.pkgsCross.riscv64.nix;})
    # loongarch64 nix installer
    (pkgs.callPackage binaryTarball {nix=pkgs.pkgsCross.loongarch64-linux.nix;})
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nix-docker-for-multiple-isas"><a class="header" href="#nix-docker-for-multiple-isas">🐳Nix Docker🐋 for Multiple ISAs</a></h1>
<p>This script is inspired by https://github.com/nix-community/docker-nixpkgs/images/nix</p>
<p>currently: this riscv64 nix docker can <code>nix-env -iA nixpkgs.hello/tmux</code> and so on,
which is completely built from source including toolchains (stdenv) in x86/aarch64/riscv64/...</p>
<pre><code class="language-nix">{ pkgs ? import &lt;nixpkgs&gt; {}
, pkgsCross ? pkgs
, useTmux ? true
}:
let
  name = "nix-docker-${pkgsCross.stdenv.system}";
  image = pkgs.dockerTools.buildImageWithNixDb {
    inherit name;
    copyToRoot = pkgs.buildEnv {
      name = "image-root";
      paths = (with pkgsCross; [
        bashInteractive
        cacert
        coreutils
        file
        gitMinimal
        gnutar
        nix
        openssh
        vim
        wget
      ]
      ++ lib.optional useTmux (tmux.override {withSystemd=false;})
      ) ++ [
        ./imageFiles
      ];
    };
    extraCommands = ''
      # for /usr/bin/env
      mkdir usr
      ln -s bin usr/bin

      # make sure /tmp exists
      mkdir -m 1777 tmp

      # need a HOME
      mkdir -vp root
    '';
    config = {
      Cmd = if useTmux
        then [ "/bin/tmux" ]
        else [ "/bin/bash" ];
      Env = [
        "NIX_BUILD_SHELL=/bin/bash"
        "PAGER=cat"
        "PATH=/bin"
        "SSL_CERT_FILE=${pkgs.cacert}/etc/ssl/certs/ca-bundle.crt"
        "USER=root"
      ];
    };
  };
in pkgs.writeShellScriptBin name ''
  command -v podman &amp;&gt; /dev/null || echo "podman not found TODO: install" || exit 1

  outName="$(basename ${image})"
  outHash=$(echo "$outName" | cut -d - -f 1)
  imageName=localhost/${name}:$outHash

  # check whether image has been loaded
  podman images $imageName | grep ${name} | grep $outHash &amp;&gt; /dev/null
  # image has not been loaded, then load it
  if [[ $? != 0 ]]; then
    podman load -i ${image}
  fi

  BINFMTS=""
  for binfmt in /run/binfmt/*; do
      BINFMTS+=" -v $(realpath $binfmt):$binfmt"
  done

  containerName=${name}-$outHash
  # run container
  OPTS=(
    "--name=$containerName"
    "$BINFMTS"
    "--network=host"
    "-it"
    "$imageName"
  )
  eval "podman run ''${OPTS[@]}"
  podman commit $containerName $imageName
  podman rm $containerName
''
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build
</code></pre>
<h1 id="instantiatio-of-nix-dockers"><a class="header" href="#instantiatio-of-nix-dockers">Instantiatio of nix dockers</a></h1>
<p>For more details, see <a href="scripts/pkgs/nix-docker-isa/./default.nix.html">default.nix</a></p>
<pre><code class="language-nix">{ pkgs ? import &lt;nixpkgs&gt; {}
, ...
}: [
</code></pre>
<h2 id="x86_64-docker"><a class="header" href="#x86_64-docker">x86_64 docker</a></h2>
<pre><code class="language-nix">  (import ./. {inherit pkgs; pkgsCross=pkgs.pkgsCross.gnu64;})
</code></pre>
<h2 id="aarhc64-docker"><a class="header" href="#aarhc64-docker">aarhc64 docker</a></h2>
<pre><code class="language-nix">  (import ./. {inherit pkgs; pkgsCross=pkgs.pkgsCross.aarch64-multiplatform;})
</code></pre>
<h2 id="riscv64-docker"><a class="header" href="#riscv64-docker">riscv64 docker</a></h2>
<pre><code class="language-nix">  (import ./. {inherit pkgs; pkgsCross=pkgs.pkgsCross.riscv64;})
]
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  flake-compat = import (builtins.fetchTarball {
    url = "https://github.com/edolstra/flake-compat/archive/0f9255e01c2351cc7d116c072cb317785dd33b33.tar.gz";
    sha256 = "0m9grvfsbwmvgwaxvdzv6cmyvjnlww004gfxjvcl806ndqaxzy4j";
  });
  nix2nvchad = flake-compat {
    src=  builtins.fetchTarball {
      url = "https://github.com/nix-community/nix4nvchad/archive/360ff667893eab066b3db906a856de2956fc710e.tar.gz";
      sha256 = "01gvcg7nhzpizp4yzvww2x42i1ifsb7sygfwmqzrshqz47p1ir5y";
    };
  };
in nix2nvchad.defaultNix.packages."${builtins.currentSystem}".default
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build
# xieby1: 2022.05.24
# build static qemu (current version 6.1.1) into ./result/
# $ nix-build &lt;this-file&gt; -A qemu
# build static qemu-3.1.0 into ./result/
# $ nix-build &lt;this-file&gt; -A qemu31
# build and install static qemu
# $ nix-env -i -f &lt;this-file&gt; -A qemu
# build and install static qemu-3.1.0
# $ nix-env -i -f &lt;this-file&gt; -A qemu31
let
  # https://lazamar.co.uk/nix-versions
  pinnedPkgsForQemu31Src = builtins.fetchTarball {
    name = "nixos-20.03-with-qemu-3.1.0";
    url = "https://github.com/NixOS/nixpkgs/archive/81d4e65891f92e8e72c244da663c83c1e40dc919.tar.gz";
    sha256 = "0dk1k1zqy2bnp9gsy9mdxk0idkazyvnmqrj2jpbwzfnhjzpmzq1w";
  };
  pinnedPkgsSrc = builtins.fetchTarball {
    name = "nixos-static-qemu";
    url = "https://github.com/nixos/nixpkgs/archive/e7d63bd0d50df412f5a1d8acfa3caae75522e347.tar.gz";
    sha256 = "132pc4f9ixisyv4117p2jirmlyl6sd76bfaz33rhlcwakg7bhjm7";
  };
  pkgsForQemu31 = import pinnedPkgsForQemu31Src {};
  pkgs = import pinnedPkgsSrc {};
  mypkgs = import pinnedPkgsSrc {
    overlays = [(self: super: {

      cdparanoiaIII = super.pkgsStatic.cdparanoiaIII.overrideAttrs (old: {
        preConfigure = old.preConfigure + ''
          cp ${super.gnu-config}/config.sub configure.sub
          cp ${super.gnu-config}/config.guess configure.guess
        '';
        # Makefile needs this to compile static
        STATIC="TRUE";
        buildPhase = ''
          make lib
          make cdparanoia
        '';
        preInstallPhases = ["preInstallPhase"];
        preInstallPhase = ''
          sed -i '/so/d' Makefile
        '';
      });

      liburing = super.pkgsStatic.liburing.overrideDerivation (old: {
        configureFlags = "";
        ENABLE_SHARED = 0;
      });

      # p11-kit cannot be used as a static library
      # https://github.com/p11-glue/p11-kit/issues/355
      p11-kit = super.pkgsMusl.p11-kit;
      # gnutls depends on p11-kit
      gnutls = super.pkgsMusl.gnutls;

      pam = super.pkgsStatic.openpam;

      # support both static and shared
      libselinux = (super.pkgsMusl.libselinux.override {
        libsepol = super.pkgsStatic.libsepol;
      }).overrideAttrs (old: {
         makeFlags = old.makeFlags ++ [
           "LIBDIR=$(out)/lib"
         ];
      });

      glib = (super.pkgsStatic.glib.override {
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        pkg-config = pkgs.pkg-config;
        perl = pkgs.perl;
        python3 = pkgs.python3;
        gettext = pkgs.gettext;
        gtk-doc = pkgs.gtk-doc;
        docbook_xsl = pkgs.docbook_xsl;
        docbook_xml_dtd_45 = pkgs.docbook_xml_dtd_45;
        libxml2 = pkgs.libxml2;
      }).overrideAttrs (old: {
        outputs = super.lib.lists.remove "devdoc" old.outputs;
        buildInputs = old.buildInputs ++ [
          super.pkgsStatic.libsepol
        ];
        preBuild = ''
          sed -i "s/get_option('libmount')/get_option('libmount'), static: true/g" ../meson.build
          sed -i "s/get_option('selinux')/get_option('selinux'), static: true/g" ../meson.build
        '';
        # no devdoc from non-static glibc
        # ${pname} &amp; ${version} is correct due to lazy assignment
        postInstall = pkgs.glib.postInstall;
      });

      gtk3 = super.pkgsStatic.gtk3.override {
        trackerSupport = false;
        cupsSupport = false;
        withGtkDoc = false;

        # nativeBuildInputs
        inherit (pkgs) gettext gobject-introspection makeWrapper meson ninja
        pkg-config python3 sassc docbook_xml_dtd_43 docbook-xsl-nons gtk-doc libxml2;
      };

      qemu = ((super.pkgsStatic.qemu.override {
        alsaSupport = false;
        spiceSupport = false;
        sdlSupport = false;
        smartcardSupport = false;
        gtkSupport = false;
        pulseSupport = false;

        # nativeBuildInputs
        makeWrapper = pkgs.makeWrapper;
        python = pkgs.python3;
        pkg-config = pkgs.pkg-config;
        flex = pkgs.flex;
        bison = pkgs.bison;
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        perl = pkgs.perl;
      }).overrideAttrs (old: {
        nativeBuildInputs = old.nativeBuildInputs ++ [
          pkgs.binutils
          # perl as nativeBuildInputs has been added in nixpkgs master
          # while it is backported to nixpkgs 21.11 (nixos 21.11).
          # If without perl as nativeBuildInputs,
          # ./scripts/shaderinclude.pl can not be patchShebangs'ed.
          pkgs.perl # without it cannot patchShebangs
        ];
        # qemu-6.1.1 has contained sigrtminmax patch, can not be patched again
        patches = builtins.filter (
          x: ! super.lib.hasSuffix "sigrtminmax.patch" x
        ) old.patches;
      })).overrideDerivation (old: let
        # qemu configure uses "--static" instead of standard "--disable-shared" and "--enable-static"
        configureFlags_no_DS = super.lib.lists.remove "--disable-shared" old.configureFlags;
        configureFlags_no_DS_no_ES = super.lib.lists.remove "--enable-static" configureFlags_no_DS;
      in {
        configureFlags = configureFlags_no_DS_no_ES ++ [
          "--static"
          # "--target-list-exclude="
          "--target-list=x86_64-softmmu"
        ];
      });

      qemu31 = (((super.callPackage (
        pinnedPkgsForQemu31Src + "/pkgs/applications/virtualization/qemu/default.nix"
      ) {
        inherit (super.darwin.apple_sdk.frameworks) CoreServices Cocoa Hypervisor;
        inherit (super.darwin.stubs) rez setfile;
      }).override {
        # In nixpkgs 20.03, stdenv contains lib attr.
        stdenv = pkgs.pkgsStatic.stdenv // {lib = super.lib;};
        alsaLib = null;
        spiceSupport = false;
        sdlSupport = false;
        smartcardSupport = false;
        gtkSupport = false;
        pulseSupport = false;

        # nativeBuildInputs
        makeWrapper = pkgs.makeWrapper;
        python2 = pkgs.python2;
        pkgconfig = pkgs.pkgconfig;
        flex = pkgs.flex;
        bison = pkgs.bison;
        perl = pkgs.perl;
      }).overrideAttrs (old: {
        nativeBuildInputs = old.nativeBuildInputs ++ [
          # Several issues report ld version &gt;= 2.34 will failed due to
          # PHDR segment not covered by LOAD segment.
          # https://github.com/OpenOrbis/OpenOrbis-PS4-Toolchain/issues/122
          # https://github.com/genodelabs/genode/issues/4003
          # So I downgrade ld version &lt; 2.34.
          # I still do not figure out why the same version ld in
          # qemu 6.1.1 static works correctly?
          pkgsForQemu31.binutils
        ];
      })).overrideDerivation (old: let
        # drop audio configure flag
        configureFlags_no_audio = builtins.filter (
          x: ! super.lib.hasPrefix "--audio-drv-list" x
        ) old.configureFlags;
        # qemu configure uses "--static" instead of standard "--disable-shared" and "--enable-static"
        configureFlags_no_DS = super.lib.lists.remove "--disable-shared" configureFlags_no_audio;
        configureFlags_no_DS_no_ES = super.lib.lists.remove "--enable-static" configureFlags_no_DS;
      in {
        configureFlags = configureFlags_no_DS_no_ES ++ [
          # "--static"
          # "--target-list-exclude="
          "--target-list=x86_64-softmmu"
          "--disable-gnutls"
          "--disable-tools"
        ];
        makeFlags = [
          # "V=1" # qemu Makefile verbose
          # It is neccessary to use ld in binutils, otherwise pc-bios build will fail.
          # In qemu 6.1.1 static, it is using ld in binutils, instead of ld from musl-gcc
          "AR=${pkgs.binutils-unwrapped}/bin/ar"
          "AS=${pkgs.binutils}/bin/as"
          "LD=${pkgs.binutils}/bin/ld"
          "NIX_BINTOOLS=${pkgs.binutils}"
        ];
      });
    })];

  };
in
{
  inherit (mypkgs.pkgsStatic) qemu qemu31;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build
# xieby1: 2022.05.24
# build static qemu (current version 6.1.1) into ./result/
# $ nix-build &lt;this-file&gt; -A qemu
# build static qemu-3.1.0 into ./result/
# $ nix-build &lt;this-file&gt; -A qemu31
# build and install static qemu
# $ nix-env -i -f &lt;this-file&gt; -A qemu
# build and install static qemu-3.1.0
# $ nix-env -i -f &lt;this-file&gt; -A qemu31
let
  pinnedPkgsSrc = builtins.fetchTarball {
    name = "nixos-static-qemu";
    url = "https://github.com/nixos/nixpkgs/archive/e7d63bd0d50df412f5a1d8acfa3caae75522e347.tar.gz";
    sha256 = "132pc4f9ixisyv4117p2jirmlyl6sd76bfaz33rhlcwakg7bhjm7";
  };
  # pkgs = import pinnedPkgsSrc {};
  # mypkgs = import pinnedPkgsSrc {
  pkgs = import &lt;nixpkgs&gt; {};
  mypkgs = import &lt;nixpkgs&gt; {
    overlays = [(self: super: {

      cdparanoiaIII = super.pkgsStatic.cdparanoiaIII.overrideAttrs (old: {
        preConfigure = old.preConfigure + ''
          cp ${super.gnu-config}/config.sub configure.sub
          cp ${super.gnu-config}/config.guess configure.guess
        '';
        # Makefile needs this to compile static
        STATIC="TRUE";
        buildPhase = ''
          make lib
          make cdparanoia
        '';
        preInstallPhases = ["preInstallPhase"];
        preInstallPhase = ''
          sed -i '/so/d' Makefile
        '';
      });

      liburing = super.pkgsStatic.liburing.overrideDerivation (old: {
        configureFlags = "";
        ENABLE_SHARED = 0;
      });

      # p11-kit cannot be used as a static library
      # https://github.com/p11-glue/p11-kit/issues/355
      p11-kit = super.pkgsMusl.p11-kit;
      # gnutls depends on p11-kit
      gnutls = super.pkgsMusl.gnutls;

      pam = super.pkgsStatic.openpam;

      # support both static and shared
      libselinux = (super.pkgsMusl.libselinux.override {
        libsepol = super.pkgsStatic.libsepol;
      }).overrideAttrs (old: {
         makeFlags = old.makeFlags ++ [
           "LIBDIR=$(out)/lib"
         ];
      });

      glib = (super.pkgsStatic.glib.override {
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        pkg-config = pkgs.pkg-config;
        perl = pkgs.perl;
        python3 = pkgs.python3;
        gettext = pkgs.gettext;
        gtk-doc = pkgs.gtk-doc;
        docbook_xsl = pkgs.docbook_xsl;
        docbook_xml_dtd_45 = pkgs.docbook_xml_dtd_45;
        libxml2 = pkgs.libxml2;
      }).overrideAttrs (old: {
        outputs = super.lib.lists.remove "devdoc" old.outputs;
        buildInputs = old.buildInputs ++ [
          super.pkgsStatic.libsepol
        ];
        preBuild = ''
          sed -i "s/get_option('libmount')/get_option('libmount'), static: true/g" ../meson.build
          sed -i "s/get_option('selinux')/get_option('selinux'), static: true/g" ../meson.build
        '';
        # no devdoc from non-static glibc
        # ${pname} &amp; ${version} is correct due to lazy assignment
        postInstall = pkgs.glib.postInstall;
      });

      gtk3 = super.pkgsStatic.gtk3.override {
        trackerSupport = false;
        cupsSupport = false;
        withGtkDoc = false;

        # nativeBuildInputs
        inherit (pkgs) gettext gobject-introspection makeWrapper meson ninja
        pkg-config python3 sassc docbook_xml_dtd_43 docbook-xsl-nons gtk-doc libxml2;
      };

      qemu = ((super.pkgsStatic.qemu.override {
        alsaSupport = false;
        spiceSupport = false;
        sdlSupport = false;
        smartcardSupport = false;
        gtkSupport = false;
        pulseSupport = false;

        # nativeBuildInputs
        makeWrapper = pkgs.makeWrapper;
        python = pkgs.python3;
        pkg-config = pkgs.pkg-config;
        flex = pkgs.flex;
        bison = pkgs.bison;
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        perl = pkgs.perl;
      }).overrideAttrs (old: {
        nativeBuildInputs = old.nativeBuildInputs ++ [
          pkgs.binutils
          # perl as nativeBuildInputs has been added in nixpkgs master
          # while it is backported to nixpkgs 21.11 (nixos 21.11).
          # If without perl as nativeBuildInputs,
          # ./scripts/shaderinclude.pl can not be patchShebangs'ed.
          pkgs.perl # without it cannot patchShebangs
        ];
        # qemu-6.1.1 has contained sigrtminmax patch, can not be patched again
        patches = builtins.filter (
          x: ! super.lib.hasSuffix "sigrtminmax.patch" x
        ) old.patches;
      })).overrideDerivation (old: let
        # qemu configure uses "--static" instead of standard "--disable-shared" and "--enable-static"
        configureFlags_no_DS = super.lib.lists.remove "--disable-shared" old.configureFlags;
        configureFlags_no_DS_no_ES = super.lib.lists.remove "--enable-static" configureFlags_no_DS;
      in {
        configureFlags = configureFlags_no_DS_no_ES ++ [
          "--static"
          # "--target-list-exclude="
          "--target-list=x86_64-softmmu"
        ];
      });
    })];
  };
in
{
  inherit (mypkgs.pkgsStatic.pkgsCross.riscv64) qemu;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build
# xieby1: 2022.05.24
# build static qemu (current version 6.1.1) into ./result/
# $ nix-build &lt;this-file&gt; -A qemu
# build static qemu-3.1.0 into ./result/
# $ nix-build &lt;this-file&gt; -A qemu31
# build and install static qemu
# $ nix-env -i -f &lt;this-file&gt; -A qemu
# build and install static qemu-3.1.0
# $ nix-env -i -f &lt;this-file&gt; -A qemu31
let
  pinnedPkgsSrc = builtins.fetchTarball {
    name = "nixos-static-qemu";
    url = "https://github.com/nixos/nixpkgs/archive/e7d63bd0d50df412f5a1d8acfa3caae75522e347.tar.gz";
    sha256 = "132pc4f9ixisyv4117p2jirmlyl6sd76bfaz33rhlcwakg7bhjm7";
  };
  # pkgs = import pinnedPkgsSrc {};
  # mypkgs = import pinnedPkgsSrc {
  pkgs = import &lt;nixpkgs&gt; {};
  mypkgs = import &lt;nixpkgs&gt; {
    overlays = [(self: super: {

      cdparanoiaIII = super.pkgsStatic.cdparanoiaIII.overrideAttrs (old: {
        preConfigure = old.preConfigure + ''
          cp ${super.gnu-config}/config.sub configure.sub
          cp ${super.gnu-config}/config.guess configure.guess
        '';
        # Makefile needs this to compile static
        STATIC="TRUE";
        buildPhase = ''
          make lib
          make cdparanoia
        '';
        preInstallPhases = ["preInstallPhase"];
        preInstallPhase = ''
          sed -i '/so/d' Makefile
        '';
      });

      liburing = super.pkgsStatic.liburing.overrideDerivation (old: {
        configureFlags = "";
        ENABLE_SHARED = 0;
      });

      # p11-kit cannot be used as a static library
      # https://github.com/p11-glue/p11-kit/issues/355
      p11-kit = super.pkgsMusl.p11-kit;
      # gnutls depends on p11-kit
      gnutls = super.pkgsMusl.gnutls;

      pam = super.pkgsStatic.openpam;

      # support both static and shared
      libselinux = (super.pkgsMusl.libselinux.override {
        libsepol = super.pkgsStatic.libsepol;
      }).overrideAttrs (old: {
         makeFlags = old.makeFlags ++ [
           "LIBDIR=$(out)/lib"
         ];
      });

      glib = (super.pkgsStatic.glib.override {
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        pkg-config = pkgs.pkg-config;
        perl = pkgs.perl;
        python3 = pkgs.python3;
        gettext = pkgs.gettext;
        gtk-doc = pkgs.gtk-doc;
        docbook_xsl = pkgs.docbook_xsl;
        docbook_xml_dtd_45 = pkgs.docbook_xml_dtd_45;
        libxml2 = pkgs.libxml2;
      }).overrideAttrs (old: {
        outputs = super.lib.lists.remove "devdoc" old.outputs;
        buildInputs = old.buildInputs ++ [
          super.pkgsStatic.libsepol
        ];
        preBuild = ''
          sed -i "s/get_option('libmount')/get_option('libmount'), static: true/g" ../meson.build
          sed -i "s/get_option('selinux')/get_option('selinux'), static: true/g" ../meson.build
        '';
        # no devdoc from non-static glibc
        # ${pname} &amp; ${version} is correct due to lazy assignment
        postInstall = pkgs.glib.postInstall;
      });

      gtk3 = super.pkgsStatic.gtk3.override {
        trackerSupport = false;
        cupsSupport = false;
        withGtkDoc = false;

        # nativeBuildInputs
        inherit (pkgs) gettext gobject-introspection makeWrapper meson ninja
        pkg-config python3 sassc docbook_xml_dtd_43 docbook-xsl-nons gtk-doc libxml2;
      };

      qemu = ((super.pkgsStatic.qemu.override {
        alsaSupport = false;
        spiceSupport = false;
        sdlSupport = false;
        smartcardSupport = false;
        gtkSupport = false;
        pulseSupport = false;

        # nativeBuildInputs
        makeWrapper = pkgs.makeWrapper;
        python = pkgs.python3;
        pkg-config = pkgs.pkg-config;
        flex = pkgs.flex;
        bison = pkgs.bison;
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        perl = pkgs.perl;
      }).overrideAttrs (old: {
        nativeBuildInputs = old.nativeBuildInputs ++ [
          pkgs.binutils
          # perl as nativeBuildInputs has been added in nixpkgs master
          # while it is backported to nixpkgs 21.11 (nixos 21.11).
          # If without perl as nativeBuildInputs,
          # ./scripts/shaderinclude.pl can not be patchShebangs'ed.
          pkgs.perl # without it cannot patchShebangs
        ];
        # qemu-6.1.1 has contained sigrtminmax patch, can not be patched again
        patches = builtins.filter (
          x: ! super.lib.hasSuffix "sigrtminmax.patch" x
        ) old.patches;
      })).overrideDerivation (old: let
        # qemu configure uses "--static" instead of standard "--disable-shared" and "--enable-static"
        configureFlags_no_DS = super.lib.lists.remove "--disable-shared" old.configureFlags;
        configureFlags_no_DS_no_ES = super.lib.lists.remove "--enable-static" configureFlags_no_DS;
      in {
        configureFlags = configureFlags_no_DS_no_ES ++ [
          "--static"
          # "--target-list-exclude="
          "--target-list=x86_64-softmmu"
        ];
      });
    })];
  };
in
{
  inherit (mypkgs.pkgsStatic.pkgsCross.riscv64) qemu;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build
# xieby1: 2022.05.24
# build static qemu (current version 6.1.1) into ./result/
# $ nix-build &lt;this-file&gt; -A qemu
# build static qemu-3.1.0 into ./result/
# $ nix-build &lt;this-file&gt; -A qemu31
# build and install static qemu
# $ nix-env -i -f &lt;this-file&gt; -A qemu
# build and install static qemu-3.1.0
# $ nix-env -i -f &lt;this-file&gt; -A qemu31
let
  # https://lazamar.co.uk/nix-versions
  pinnedPkgsForQemu31Src = builtins.fetchTarball {
    name = "nixos-20.03-with-qemu-3.1.0";
    url = "https://github.com/NixOS/nixpkgs/archive/81d4e65891f92e8e72c244da663c83c1e40dc919.tar.gz";
    sha256 = "0dk1k1zqy2bnp9gsy9mdxk0idkazyvnmqrj2jpbwzfnhjzpmzq1w";
  };
  pinnedPkgsSrc = builtins.fetchTarball {
    name = "nixos-static-qemu";
    url = "https://github.com/nixos/nixpkgs/archive/e7d63bd0d50df412f5a1d8acfa3caae75522e347.tar.gz";
    sha256 = "132pc4f9ixisyv4117p2jirmlyl6sd76bfaz33rhlcwakg7bhjm7";
  };
  pkgsForQemu31 = import pinnedPkgsForQemu31Src {};
  pkgs = import pinnedPkgsSrc {};
  mypkgs = import pinnedPkgsSrc {
    overlays = [(self: super: {

      cdparanoiaIII = super.pkgsStatic.cdparanoiaIII.overrideAttrs (old: {
        preConfigure = old.preConfigure + ''
          cp ${super.gnu-config}/config.sub configure.sub
          cp ${super.gnu-config}/config.guess configure.guess
        '';
        # Makefile needs this to compile static
        STATIC="TRUE";
        buildPhase = ''
          make lib
          make cdparanoia
        '';
        preInstallPhases = ["preInstallPhase"];
        preInstallPhase = ''
          sed -i '/so/d' Makefile
        '';
      });

      liburing = super.pkgsStatic.liburing.overrideDerivation (old: {
        configureFlags = "";
        ENABLE_SHARED = 0;
      });

      # p11-kit cannot be used as a static library
      # https://github.com/p11-glue/p11-kit/issues/355
      p11-kit = super.pkgsMusl.p11-kit;
      # gnutls depends on p11-kit
      gnutls = super.pkgsMusl.gnutls;

      pam = super.pkgsStatic.openpam;

      # support both static and shared
      libselinux = (super.pkgsMusl.libselinux.override {
        libsepol = super.pkgsStatic.libsepol;
      }).overrideAttrs (old: {
         makeFlags = old.makeFlags ++ [
           "LIBDIR=$(out)/lib"
         ];
      });

      glib = (super.pkgsStatic.glib.override {
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        pkg-config = pkgs.pkg-config;
        perl = pkgs.perl;
        python3 = pkgs.python3;
        gettext = pkgs.gettext;
        gtk-doc = pkgs.gtk-doc;
        docbook_xsl = pkgs.docbook_xsl;
        docbook_xml_dtd_45 = pkgs.docbook_xml_dtd_45;
        libxml2 = pkgs.libxml2;
      }).overrideAttrs (old: {
        outputs = super.lib.lists.remove "devdoc" old.outputs;
        buildInputs = old.buildInputs ++ [
          super.pkgsStatic.libsepol
        ];
        preBuild = ''
          sed -i "s/get_option('libmount')/get_option('libmount'), static: true/g" ../meson.build
          sed -i "s/get_option('selinux')/get_option('selinux'), static: true/g" ../meson.build
        '';
        # no devdoc from non-static glibc
        # ${pname} &amp; ${version} is correct due to lazy assignment
        postInstall = pkgs.glib.postInstall;
      });

      gtk3 = super.pkgsStatic.gtk3.override {
        trackerSupport = false;
        cupsSupport = false;
        withGtkDoc = false;

        # nativeBuildInputs
        inherit (pkgs) gettext gobject-introspection makeWrapper meson ninja
        pkg-config python3 sassc docbook_xml_dtd_43 docbook-xsl-nons gtk-doc libxml2;
      };

      qemu = ((super.pkgsStatic.qemu.override {
        alsaSupport = false;
        spiceSupport = false;
        sdlSupport = false;
        smartcardSupport = false;
        gtkSupport = false;
        pulseSupport = false;

        # nativeBuildInputs
        makeWrapper = pkgs.makeWrapper;
        python = pkgs.python3;
        pkg-config = pkgs.pkg-config;
        flex = pkgs.flex;
        bison = pkgs.bison;
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        perl = pkgs.perl;
      }).overrideAttrs (old: {
        nativeBuildInputs = old.nativeBuildInputs ++ [
          pkgs.binutils
          # perl as nativeBuildInputs has been added in nixpkgs master
          # while it is backported to nixpkgs 21.11 (nixos 21.11).
          # If without perl as nativeBuildInputs,
          # ./scripts/shaderinclude.pl can not be patchShebangs'ed.
          pkgs.perl # without it cannot patchShebangs
        ];
        # qemu-6.1.1 has contained sigrtminmax patch, can not be patched again
        patches = builtins.filter (
          x: ! super.lib.hasSuffix "sigrtminmax.patch" x
        ) old.patches;
      })).overrideDerivation (old: let
        # qemu configure uses "--static" instead of standard "--disable-shared" and "--enable-static"
        configureFlags_no_DS = super.lib.lists.remove "--disable-shared" old.configureFlags;
        configureFlags_no_DS_no_ES = super.lib.lists.remove "--enable-static" configureFlags_no_DS;
      in {
        configureFlags = configureFlags_no_DS_no_ES ++ [
          "--static"
          # "--target-list-exclude="
          "--target-list=x86_64-softmmu"
        ];
      });

      qemu31 = (((super.callPackage (
        pinnedPkgsForQemu31Src + "/pkgs/applications/virtualization/qemu/default.nix"
      ) {
        inherit (super.darwin.apple_sdk.frameworks) CoreServices Cocoa Hypervisor;
        inherit (super.darwin.stubs) rez setfile;
      }).override {
        # In nixpkgs 20.03, stdenv contains lib attr.
        stdenv = pkgs.pkgsStatic.stdenv // {lib = super.lib;};
        alsaLib = null;
        spiceSupport = false;
        sdlSupport = false;
        smartcardSupport = false;
        gtkSupport = false;
        pulseSupport = false;

        # nativeBuildInputs
        makeWrapper = pkgs.makeWrapper;
        python2 = pkgs.python2;
        pkgconfig = pkgs.pkgconfig;
        flex = pkgs.flex;
        bison = pkgs.bison;
        perl = pkgs.perl;
      }).overrideAttrs (old: {
        nativeBuildInputs = old.nativeBuildInputs ++ [
          # Several issues report ld version &gt;= 2.34 will failed due to
          # PHDR segment not covered by LOAD segment.
          # https://github.com/OpenOrbis/OpenOrbis-PS4-Toolchain/issues/122
          # https://github.com/genodelabs/genode/issues/4003
          # So I downgrade ld version &lt; 2.34.
          # I still do not figure out why the same version ld in
          # qemu 6.1.1 static works correctly?
          pkgsForQemu31.binutils
        ];
      })).overrideDerivation (old: let
        # drop audio configure flag
        configureFlags_no_audio = builtins.filter (
          x: ! super.lib.hasPrefix "--audio-drv-list" x
        ) old.configureFlags;
        # qemu configure uses "--static" instead of standard "--disable-shared" and "--enable-static"
        configureFlags_no_DS = super.lib.lists.remove "--disable-shared" configureFlags_no_audio;
        configureFlags_no_DS_no_ES = super.lib.lists.remove "--enable-static" configureFlags_no_DS;
      in {
        configureFlags = configureFlags_no_DS_no_ES ++ [
          # "--static"
          # "--target-list-exclude="
          "--target-list=x86_64-softmmu"
          "--disable-gnutls"
          "--disable-tools"
        ];
        makeFlags = [
          # "V=1" # qemu Makefile verbose
          # It is neccessary to use ld in binutils, otherwise pc-bios build will fail.
          # In qemu 6.1.1 static, it is using ld in binutils, instead of ld from musl-gcc
          "AR=${pkgs.binutils-unwrapped}/bin/ar"
          "AS=${pkgs.binutils}/bin/as"
          "LD=${pkgs.binutils}/bin/ld"
          "NIX_BINTOOLS=${pkgs.binutils}"
        ];
      });
    })];

  };
in
{
  inherit (mypkgs.pkgsStatic) qemu qemu31;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build
# TODO
# Ref: ~/Documents/Tech/BT/QEMU/test.md
let
  pkgs = import &lt;nixpkgs&gt; {};
in
pkgs.stdenv.mkDerivation {
  buildInputs = with pkgs; [
    # configure needs
    ninja
    pkg-config
    glib
    # make needs
    glibc.static # TODO: this will cause configure failed
  ];
  buildFlags = [
    "CFLAGS=-O" # override CFLAGS
    "build-tcg-tests-x86_64-linux-user"
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># build by version
# nix-build pkgs_qemu.nix -A v1_0
# build by date
# nix-build pkgs_qemu.nix -A d2011_12_01
{ pkgs ? import &lt;nixpkgs&gt; {} }:
let
  pname = "qemu";
in rec {
  v1_0 = let
    version = "1.0";
  in pkgs.gcc49Stdenv.mkDerivation {
    inherit pname version;
    src = pkgs.fetchurl {
      url = "https://download.qemu.org/qemu-${version}.tar.xz";
      sha256 = "0y1018xia238pcqb7ad9v299b478c0838fiayl6qkzyd95gk0xbb";
    };
    buildInputs = with pkgs; [
      zlib
      pkg-config
      glib
      python2
    ];
    patches = [
      ./qemu-v1.0.patch
    ];
    configureFlags = [
      "--target-list=x86_64-linux-user"
      "--disable-docs"
    ];
  };
  d2011_12_01 = v1_0;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># https://github.com/NixOS/nixpkgs/issues/185773
{ lib, callPackage, fetchFromGitHub, fetchurl, openssl_1_1 }:

((callPackage (import (fetchFromGitHub {
  owner = "NixOS";
  repo = "nixpkgs";
  rev = "363ef08971726937cd6a63de0efef7f8ba657b18";
  sha256 = "sha256-QRKAn5yLMyohZKsK72Vkd6HQUh3t5tDpFyI/Y7T3ASg=";
}) { }).shellinabox.override) { openssl = openssl_1_1; }).overrideAttrs
({ patches, ... }: {
  patches = patches ++ [
    # OpenSSL 1.1
    (fetchurl {
      url =
        "https://github.com/shellinabox/shellinabox/commit/c32f3d365a0848eb6b3350ec521fcd4d1d098295.patch";
      hash = "sha256-Q8otJUip1YQJb0ZSF89BjSvrCh4PQe4R7Rb7mtm33tk=";
    })
  ];
})
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs ? import (fetchTarball {
    url = "https://github.com/NixOS/nixpkgs/archive/1dab772dd4a68a7bba5d9460685547ff8e17d899.tar.gz";
    sha256 = "18qwmspcsmi0ryhcg66p9i42qwismm7l0706m39zw5ziq6n11fc9";
  }) {}
, CONFIG ? "XSNoCTopConfig" # "DefaultConfig"
, EMU_THREADS ? "4"
, NUM_CORES ? "1"
, EMU_TRACE ? "fst" # "fst" or "vcd"
, genRTL ? false
}:
let
  xs-src = (pkgs.fetchFromGitHub {
    owner = "OpenXiangShan";
    repo = "XiangShan";
    rev = "ff4344e4e52d4e58ba1570da9ace0dafaca74de0";
    hash = "sha256-2vaeqiEOGRlEkcSZLzneqwVe1IldhPMK552ydUnKS+s=";
    forceFetchGit = true;
  }).overrideAttrs (old: {
    # NOTE: Why not use leaveDotGit/deepClone here?
    # see pkgs/build-support/fetchgit/nix-prefetch-git:
    # # &gt; # shallow with leaveDotGit will change hashes
    # In other words: If deepClone/leaveDotGit co-exists with fetchSubmodules
    # (here we only fetch selected submodules by NIX_PREFETCH_GIT_CHECKOUT_HOOK)
    # then hash changes every time.
    #
    # old nixpkgs.fetchgit not support preFetch
    # preFetch = ''export NIX_PREFETCH_GIT_CHECKOUT_HOOK="make -C $out init"'';
    NIX_PREFETCH_GIT_CHECKOUT_HOOK="make -C $out init";
  });
  # If you want to use other mill version, uncomment belowing
  # mill = pkgs.mill.overrideAttrs (finalAttrs: previousAttrs: {
  #   version = "0.11.8";
  #   src = pkgs.fetchurl {
  #     url = "https://github.com/com-lihaoyi/mill/releases/download/${finalAttrs.version}/${finalAttrs.version}-assembly";
  #     hash = "sha256-HORTexIzrxbWjcGrS59JqZboxGCzk8wKf3eKMoYGqrI=";
  #   };
  # });
  mill = pkgs.mill;
  mill-with-proxy = pkgs.writeShellScriptBin "mill" ''
    # -i/--interactive/--no-server/--bsp must be passed in as the first argument
    if [[ $1 == -i || $1 == --interactive ||  $1 == --no-server || $1 == --bsp  ]]; then
      FIRST_ARG=$1
      shift
    fi
    ${mill}/bin/mill $FIRST_ARG \
      -D http.proxyHost=$(echo $http_proxy | sed -E 's,(.*://)?([^:/]+):([0-9]*).*,\2,') \
      -D http.proxyPort=$(echo $http_proxy | sed -E 's,(.*://)?([^:/]+):([0-9]*).*,\3,') \
      -D https.proxyHost=$(echo $https_proxy | sed -E 's,(.*://)?([^:/]+):([0-9]*).*,\2,') \
      -D https.proxyPort=$(echo $https_proxy | sed -E 's,(.*://)?([^:/]+):([0-9]*).*,\3,') \
      "$@"
  '';
  # mill deps refer to https://github.com/com-lihaoyi/mill/discussions/1170
  COURSIER_CACHE = pkgs.stdenv.mkDerivation {
    name = "xs-mill-cache";
    src = xs-src;
    nativeBuildInputs = [ mill-with-proxy ];
    impureEnvVars = pkgs.lib.fetchers.proxyImpureEnvVars;
    # [COURSIER_CACHE with relative path cause artifacts download into process sandbox folder](https://github.com/com-lihaoyi/mill/issues/3946)
    # Thus, COURSIER_CACHE uses absolute path like below
    buildPhase = ''
      export COURSIER_CACHE=$PWD/.cache/coursier
      mill __.prepareOffline
    '';
    installPhase = ''
      cp -r $COURSIER_CACHE $out
    '';
    outputHashMode = "recursive";
    outputHash = "sha256-9qL+2W2KSHIV4KxhfY9F+2j1xP8NCW7mC/CO2EWbYh8=";
  };
in pkgs.stdenv.mkDerivation {
  name = "xs";
  src = xs-src;
  nativeBuildInputs = [
    pkgs.makeWrapper
    mill-with-proxy
    pkgs.time
    pkgs.espresso
    pkgs.verilator
    pkgs.sqlite
    pkgs.zlib
    pkgs.zstd
    pkgs.python3
  ];

  postPatch = ''
    patchShebangs scripts/
  ''
  # The .git/ folder format is not stable, thus hard to achieve deterministic.
  # For more information about .git/ and deterministic see the `leaveDotGit` option in
  # [nixpkgs manual: fetchgit](https://nixos.org/manual/nixpkgs/stable/#fetchgit).
  # 1. Clean vcs.version scala lib, which needs the .git/ folder.
  + ''
    find -name build.sc -exec sed -i '/vcs.version/d' {} \;
    sed -i '/def publishVersion/,/^  )$/c\  def publishVersion() = "deterministic-version"' build.sc
    find -name build.sc -exec sed -i 's/def publishVersion =.*vcs.version.*/def publishVersion = "miao"/' {} \;
  ''
  # 2. Clean git related operations in build.sc
  + ''
    sed -i '/def gitStatus:/,/^  }/c\  def gitStatus() = "SHA=${xs-src.rev}\\ndirty=0"' build.sc
    sed -i 's/"git", "ls-files"/"ls", "-1"/' build.sc
    sed -i 's/os.proc("git", "submodule", "status").call().out.text()/""/' build.sc
  ''
  # 3. Clean git in Makefile
  + ''
    sed -i '/@git log/,/rm .__head__/d' Makefile
  '';

  # current version of Chisel (6.6.0) was published against firtool version 1.62.1
  CHISEL_FIRTOOL_PATH = "${(import (pkgs.fetchFromGitHub {
    owner = "NixOS";
    repo = "nixpkgs";
    rev = "771b079bb84ac2395f3a24a5663ac8d1495c98d3";
    sha256 = "0l1l9ms78xd41xg768pkb6xym200zpf4zjbv4kbqbj3z7rzvhpb7";
  }){}).circt}/bin/";
  shellHook = ''
    export NOOP_HOME=$(realpath .)
  '';
  buildPhase = ''
    eval "$shellHook"
    # Q: Why not use COURSIER_CACHE as a variable in mkDerivation
    # A: To prevent COURSIER_CACHE (a read-only path in /nix/store) from affecting LSP metals' behaviour in nix-shell
    export COURSIER_CACHE=${COURSIER_CACHE}
    make emu CONFIG=${CONFIG} EMU_THREADS=${EMU_THREADS} NUM_CORES=${NUM_CORES} EMU_TRACE=${EMU_TRACE} -j $NIX_BUILD_CORES
  '';

  outputs = ["out"] ++ pkgs.lib.optional genRTL "rtl";
  installPhase = ''
    mkdir -p $out/bin
    cp build/emu $out/bin/
    wrapProgram $out/bin/emu --prefix PATH : ${pkgs.lib.makeBinPath [pkgs.spike]}
  '' + pkgs.lib.optionalString genRTL ''
    mkdir -p $rtl
    cp -r build/rtl/* $rtl/
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p>See all fhs-shell scripts on [Github repo: scripts/shell]({{ site.repo_url }}/scripts/shell)</p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  name = "LinkNan";
  pkgs = import &lt;nixpkgs&gt; {};
in pkgs.mkShell {
  inherit name;

  buildInputs = let
    h_content = builtins.toFile "h_content" ''
      # ${pkgs.lib.toUpper "${name} usage tips"}
    '';
    _h_ = pkgs.writeShellScriptBin "h" ''
      ${pkgs.glow}/bin/glow ${h_content}
    '';
    mill_0_11_2 = (import (pkgs.fetchFromGitHub {
      owner = "NixOS";
      repo = "nixpkgs";
      rev = "4ab8a3de296914f3b631121e9ce3884f1d34e1e5";
      hash = "sha256-mQUik6XZea6ZcCkMpUieq1oxlEDE0vqTTRU9RStgtSQ=";
    }){}).mill;
  in [
    _h_
    mill_0_11_2
  ] ++ (with pkgs; [
    xmake
    espresso
    verilator

    # libs
    sqlite
    zlib
    zstd
  ]);

  shellHook = let
    circt_1_62_0 = (import (pkgs.fetchFromGitHub {
      owner = "NixOS";
      repo = "nixpkgs";
      rev = "771b079bb84ac2395f3a24a5663ac8d1495c98d3";
      sha256 = "0l1l9ms78xd41xg768pkb6xym200zpf4zjbv4kbqbj3z7rzvhpb7";
    }){}).circt;
  in ''
    h
    export CHISEL_FIRTOOL_PATH=${circt_1_62_0}/bin/
    export NOOP_HOME=$(realpath .)
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  pkgs = import &lt;nixpkgs&gt; {};
  ccache_dir = toString ./. + "/.ccache";
  ccache14Stdenv = pkgs.ccacheStdenv.override {
    stdenv = pkgs.gcc14Stdenv;
    extraConfig = ''
      export CCACHE_COMPRESS=1
      export CCACHE_DIR="${ccache_dir}"
      export CCACHE_UMASK=007
      if [ ! -d "$CCACHE_DIR" ]; then
        echo "====="
        echo "Directory '$CCACHE_DIR' does not exist"
        echo "Please create it with:"
        echo "  mkdir -m0770 '$CCACHE_DIR'"
        echo "====="
        exit 1
      fi
      if [ ! -w "$CCACHE_DIR" ]; then
        echo "====="
        echo "Directory '$CCACHE_DIR' is not accessible for user $(whoami)"
        echo "Please verify its access permissions"
        echo "====="
        exit 1
      fi
    '';
  };
  ccacheMkShell = pkgs.mkShell.override {
    stdenv = ccache14Stdenv;
  };
in ccacheMkShell {
  name = "ccache-shell";
  shellHook = ''
    mkdir -m0770 -p ${ccache_dir}
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  name = "chipyard";
  pkgs = import &lt;nixpkgs&gt; {};
  pkgsCirct1_30_0 = import (builtins.fetchTarball {
      url = "https://github.com/NixOS/nixpkgs/archive/0aca8f43c8dba4a77aa0c16fb0130237c3da514c.tar.gz";
  }) {};

  # currently latest spike
  my-spike = pkgs.spike.overrideAttrs (old: {
    version = "1.1.1-dev";
    src = pkgs.fetchFromGitHub {
      owner = "riscv";
      repo = "riscv-isa-sim";
      rev = "4f916978cd17bd2e83cfca233d0fa40153fda5f4";
      sha256 = "sha256-84YY9YMIa4YO5mVJ0gGMOWnD2/CnpEjIbB9EjA5+Glc=";
    };
  });

  h_content = builtins.toFile "h_content" ''
    # ${pkgs.lib.toUpper "${name} usage tips"}

    The conda cannot gracefully manage the dependencies, e.g. gcc's dynamic libraries.
    Instead, I replace conda with nix to manage the dependencies.

    * Show this help: `h`

    Init Repos

    * edit common.mk:1 `SHELL=bash`
    * `./scripts/init-submodules-no-riscv-tools-nolog.sh`

    Compiling Verilator

    * `make -C sims/verilator`

    Run Verilator

    * `./sims/verilator/simulator-chipyard.harness-RocketConfig &lt;RISCV Executable&gt;`
  '';
  _h_ = pkgs.writeShellScriptBin "h" ''
    ${pkgs.glow}/bin/glow ${h_content}
  '';
in pkgs.mkShell {
  inherit name;
  packages = with pkgs; [
    verilator
    dtc
    jq
    pkgsCirct1_30_0.circt
    my-spike

    _h_
  ];
  shellHook = ''
    export RISCV=${pkgs.pkgsCross.riscv64-embedded.stdenv.cc}

    h
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
# xieby1: 2022.07.03
# let
#   pkgs = import &lt;nixpkgs&gt; {};
# in
# pkgs.mkShell {
#   buildInputs = [
#     pkgs.pkgsCross.mipsel-linux-gnu.stdenv.cc
#   ];
# }

# xieby1: 2022.05.16
let
  pkgs_mips_cross = import &lt;nixpkgs&gt; {
    crossSystem = "mips-linux";
  };
  pkgs = import &lt;nixpkgs&gt; {};
in
pkgs.mkShell {
  buildInputs = (with pkgs_mips_cross; [
    buildPackages.gdb
    buildPackages.gcc
  ]) ++ (with pkgs; [
    qemu
  ]);
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
# xieby1: 2022.04.26

let
  pkgs_arm_cross = import &lt;nixpkgs&gt; {
    # get this config on my android
    #   nix repl
    #   builtins.currentSystem
    crossSystem = "aarch64-linux";
  };
  pkgs_arm_native = import &lt;nixpkgs&gt; {
    localSystem = "aarch64-linux";
    crossSystem = "aarch64-linux";
  };
  pkgs = import &lt;nixpkgs&gt; {};
in
pkgs.mkShell {
  buildInputs = with pkgs_arm_cross; [
    # packages for cross compiling, run on local system (x86_64)
    stdenv.cc
    # here stdenv.cc is the same with buildPackages.gcc
  ] ++ (with pkgs_arm_native; [
    # packages run on aarch64
    figlet
  ]) ++ (with pkgs; [
    # packages run on local system (x86_64)
    qemu
  ]);
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
{ system ? builtins.currentSystem }:
let
  src = fetchTarball {
    url = "https://github.com/numtide/devshell/archive/9fddc998b4522694caaf4056e93154d2c11752cd.tar.gz";
    sha256 = "0d7ra00843n4iyadhdxcr9m0vcn6fz54hfymms6nbdz0d2pjff06";
  };
  devshell = import src { inherit system; };
in
devshell.mkShell {
  commands = [{
    name = "hello";
    command = "echo hello";
    help = "print hello miao";
  }];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
let
  pkgs = import &lt;nixpkgs&gt; {};
in pkgs.mkShellNoCC {
  name = "gcc11";
  packages = with pkgs; [
    gcc11
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
with import &lt;nixpkgs&gt; {};
# You will get a shell with hello executable,
# and environment variable $name, $miao.
mkShell {
  packages = [
    hello
  ];
  name = "test-env";
  miao = "miao!";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
#2022.05.18
# pip install is usable in venv
# e.g.
# $ nix-shell &lt;this_file&gt;
# $ pip install [--user] graphviz2drawio
let
  pkgs = import &lt;nixpkgs&gt; {};
in
pkgs.mkShell {
  propagatedBuildInputs = with pkgs.python3Packages; [
    pip
    venvShellHook
    ipython
    pygame
  ] ++ (with pkgs; [
  ]);
  venvDir = "pygame";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># https://nixos.wiki/wiki/Python
# Python virtual environment

# Execute this commands after entering fhs env
# python -m venv .venv
# source .venv/bin/activate

let
  pkgs = import &lt;nixpkgs&gt; {};
in (pkgs.buildFHSUserEnv {
  name = "venv";
  targetPkgs = p: (with p.python3Packages; [
    pip
    virtualenv
    ipython
  ]);
}).env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
let
  mach-nix = import (builtins.fetchGit {
    url = "https://github.com/DavHau/mach-nix";
    ref = "refs/tags/3.4.0";
  }) {
    pkgs = import &lt;nixpkgs&gt; {};
  };
in
mach-nix.mkPythonShell {
  requirements = ''
    expmcc
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
#2022.05.18
# pip install is usable in venv
# e.g.
# $ nix-shell &lt;this_file&gt;
# $ pip install [--user] graphviz2drawio
let
  pkgs = import &lt;nixpkgs&gt; {};
in
pkgs.mkShell {
  propagatedBuildInputs = with pkgs.python3Packages; [
    pip
    pygraphviz
    venvShellHook
    ipython
  ] ++ (with pkgs; [
    graphviz
  ]);
  venvDir = "venv";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
# lxy's qemu plugins: http://172.17.103.58/lixinyu/qemu_plugins

let
  pkgs = import &lt;nixpkgs&gt; {};
in pkgs.mkShell {
  packages = with pkgs; [
    zlib.dev
    pkg-config
    glib.dev
  ];
  QEMU_DIR = "~/Codes/qemu";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
# --pure: start a pure reproducible shell
# 2022.04.24
# Compile qemu/tests/tcg/x86_64/
# env CFLAGS=-O make -e build-tcg-tests-x86_64-linux-user
{ pkgs ? import &lt;nixpkgs&gt; {} }:
let
  name = "nix";
in
pkgs.mkShell {
  inherit name;
  buildInputs = with pkgs; [
    glibc.static
  ];
  inputsFrom = with pkgs; [
    qemu
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  name = "riscv-tests";
  pkgs = import &lt;nixpkgs&gt; {};
  h_content = builtins.toFile "h_content" ''
    # ${pkgs.lib.toUpper "${name} compiling tips"}

    * `git submodule update --init --recursive`
    * `autoconf`
    * `./configure`
    * `make -j`
  '';
  _h_ = pkgs.writeShellScriptBin "h" ''
    ${pkgs.glow}/bin/glow ${h_content}
  '';
in pkgs.mkShell {
  inherit name;
  packages = with pkgs; [
    autoconf
    pkgsCross.riscv64-embedded.stdenv.cc

    _h_
  ];
  shellHook = ''
    export RISCV_PREFIX=${pkgs.pkgsCross.riscv64-embedded.stdenv.cc}/bin/riscv64-none-elf-
    h
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
with import &lt;nixpkgs&gt; {};
mkShell {
  packages = [
    dtc
    pkgsCross.riscv64-embedded.stdenv.cc
  ];
  name = "spike";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
# --pure: start a pure reproducible shell
{ pkgs ? import &lt;nixpkgs&gt; {}
}:
pkgs.mkShell {
  name="dev-environment";
  buildInputs = with pkgs; [
    texlive.combined.scheme-full # HUGE SIZE!

    tmux
  ];
  shellHook = ''
    # install texlive permenant
    nix-env -q "texlive.*"
    if [[ ''$? -ne 0 ]]
    then
      nix-env -f '&lt;nixpkgs&gt;' -iA texlive.combined.scheme-full
    fi

    tmux
    exit
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
{pkgs ? import &lt;nixpkgs&gt; {}}:
let
  name = "ucasproposal";
  myTexlive = pkgs.texlive.combine {
    inherit (pkgs.texlive)
    scheme-basic

    xetex
    ctex
    checkcites

    # sty
    newtx
    xstring
    realscripts
    jknapltx
    mathalpha
    caption
    placeins
    enumitem
    listings
    algpseudocodex
    algorithms
    algorithmicx
    chemfig
    mhchem
    float

    # tex
    simplekv

    rsfs
    ;
  };
  myPython = pkgs.python3.withPackages (p: with p; [
    ipython
    matplotlib
    pandas
    numpy
    openpyxl
  ]);
in
pkgs.mkShell {
  inherit name;
  packages = with pkgs; [
    myTexlive
    myPython
    librsvg
  ];
  shellHook = ''
    # env
    export PYTHONPATH=${myPython}/${myPython.sitePackages}
    export debian_chroot=${name}
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
{ pkgsX86 ? import &lt;nixpkgs&gt; {
  localSystem.system="aarch64-linux";
  crossSystem="aarch64-linux";
} }:
pkgsX86.v8
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
#2022.05.18
# pip install is usable in venv
# e.g.
# $ nix-shell &lt;this_file&gt;
# $ pip install [--user] graphviz2drawio
let
  pkgs = import &lt;nixpkgs&gt; {};
in
pkgs.mkShell {
  propagatedBuildInputs = with pkgs.python3Packages; [
    pip
    venvShellHook
    ipython
  ];
  venvDir = "${builtins.getEnv "HOME"}/.venv";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
let
  pkgs = import (builtins.fetchTarball {
    url = "https://github.com/NixOS/nixpkgs/archive/5e15d5da4abb74f0dd76967044735c70e94c5af1.tar.gz";
    sha256 = "0mk86mlxamjxhywdfp5asylqb39z7w18dcy8ds6qvl8gqjrijmq9";
  }) {
    system = "x86_64-linux";
  };
in pkgs.mkShell {
  name = "wine6";
  packages = with pkgs; [
    wine64
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="shellnix"><a class="header" href="#shellnix">shell.nix</a></h1>
<p>这个shell.nix用于创建编译我的<a href="https://github.com/xieby1/nix_config">nix_config仓库</a>的
<a href="https://xieby1.github.io/nix_config/">GitHub Pages</a>的环境。
GitHub Pages的构建主要由<code>markcode</code>和<code>mdbook</code>这两个工具支持。</p>
<ul>
<li><a href="https://github.com/xieby1/markcode"><code>markcode</code></a>
是我为了方便在源文件里内嵌文档，写的一个小工具。
它能将源文件中带有特殊标记的注释抽取出，成为markdown文件。
nix_config仓库的几乎所有文档都内嵌在.nix文件中，
并都是通过<code>markcode</code>从.nix文件抽取出来。</li>
<li><a href="https://github.com/rust-lang/mdBook"><code>mdbook</code></a>
是一个非常纯粹且好用的静态网页生成框架，负责将markdown转换成网页。
因为第一次阅读<a href="https://nixos.org/manual/nix/stable/introduction.html">nix官方文档</a>时就喜欢上了这个文档框架，
所以我也采用的<code>mdbook</code>作为我的nix_config的文档框架。</li>
</ul>
<pre><code class="language-nix">let
  name = "nix_config";
  pkgs = import &lt;nixpkgs&gt; {};
  markcode = pkgs.callPackage (
    pkgs.fetchFromGitHub {
      owner = "xieby1";
      repo = "markcode";
      rev = "1c414aca28db7f2727f6da118f4e914743780ad0";
      hash = "sha256-B5kmpAIyUihlBqk7oNAdqBmdfCajCmleKBTgLyy0NqU=";
    }
  ) {};
in pkgs.mkShell {
  inherit name;
  buildInputs = with pkgs; [
    mdbook
    markcode
  ];
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>
            <script src="https://utteranc.es/client.js"
                    repo="xieby1/nix_config"
                    issue-term="pathname"
                    theme="github-light"
                    crossorigin="anonymous"
                    async>
            </script>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
