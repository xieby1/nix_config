<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Xieby1&#x27;s Nix/NixOS Config</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">ğŸ ä¸»é¡µ</li><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> ğŸ“”README.md</a></li><li class="chapter-item expanded affix "><li class="part-title">ğŸŒå…¨å±€é…ç½®</li><li class="chapter-item expanded "><a href="config.nix.html"><strong aria-hidden="true">2.</strong> config.nix</a></li><li class="chapter-item expanded "><a href="nix/nix.conf.html"><strong aria-hidden="true">3.</strong> TODO: nix/nix.conf</a></li><li class="chapter-item expanded "><a href="opt.nix.html"><strong aria-hidden="true">4.</strong> opt.nix</a></li><li class="chapter-item expanded affix "><li class="part-title">ğŸ–¥ï¸ç³»ç»Ÿé…ç½®(éœ€sudo,ç”¨äºNixOS)</li><li class="chapter-item expanded "><a href="system.nix.html"><strong aria-hidden="true">5.</strong> system.nix</a></li><li class="chapter-item expanded "><a href="sys/index.html"><strong aria-hidden="true">6.</strong> sys/</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">6.1.</strong> cli/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="sys/cli/build-machines.nix.html"><strong aria-hidden="true">6.1.1.</strong> build-machines.nix.md</a></li><li class="chapter-item expanded "><a href="sys/cli/default.nix.html"><strong aria-hidden="true">6.1.2.</strong> sys/cli</a></li></ol></li><li class="chapter-item expanded "><a href="sys/default.nix.html"><strong aria-hidden="true">6.2.</strong> sys/default.nix</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.3.</strong> gui/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="sys/gui/default.nix.html"><strong aria-hidden="true">6.3.1.</strong> default.nix.md</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.3.2.</strong> dms/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="sys/gui/dms/default.nix.html"><strong aria-hidden="true">6.3.2.1.</strong> default.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="sys/gui/gnome.html"><strong aria-hidden="true">6.3.3.</strong> Why moving away from GNOME?</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.4.</strong> modules/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="sys/modules/cachix.nix.html"><strong aria-hidden="true">6.4.1.</strong> cachix.nix.md</a></li><li class="chapter-item expanded "><a href="sys/modules/default.nix.html"><strong aria-hidden="true">6.4.2.</strong> default.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="sys/wayland.html"><strong aria-hidden="true">6.5.</strong> Currently, Not Wayland, But X11</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">ğŸ˜ºç”¨æˆ·é…ç½®(æ— éœ€sudo,ç”¨äºNix/NixOS)</li><li class="chapter-item expanded "><a href="home.nix.html"><strong aria-hidden="true">7.</strong> home.nix</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> usr/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/cli/index.html"><strong aria-hidden="true">8.1.</strong> cli/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/cli/clash.nix.html"><strong aria-hidden="true">8.1.1.</strong> clash.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/ctags.nix.html"><strong aria-hidden="true">8.1.2.</strong> ctags.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/default.nix.html"><strong aria-hidden="true">8.1.3.</strong> default.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/extra.nix.html"><strong aria-hidden="true">8.1.4.</strong> cli-extra.nix: Extra CLI configs (added to minimal cli config)</a></li><li class="chapter-item expanded "><a href="usr/cli/fzf.nix.html"><strong aria-hidden="true">8.1.5.</strong> fzf.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/gdb.nix.html"><strong aria-hidden="true">8.1.6.</strong> GDB configurations</a></li><li class="chapter-item expanded "><a href="usr/cli/git.nix.html"><strong aria-hidden="true">8.1.7.</strong> git.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/kaleido.nix.html"><strong aria-hidden="true">8.1.8.</strong> kaleido.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/ld.html"><strong aria-hidden="true">8.1.9.</strong> binutils's ld and gcc's ld collsion</a></li><li class="chapter-item expanded "><a href="usr/cli/node.html"><strong aria-hidden="true">8.1.10.</strong> Nodejs packages (npm) in NixOS</a></li><li class="chapter-item expanded "><a href="usr/cli/python.html"><strong aria-hidden="true">8.1.11.</strong> Python in Nix/NixOS</a></li><li class="chapter-item expanded "><a href="usr/cli/ssh.nix.html"><strong aria-hidden="true">8.1.12.</strong> ssh.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/static_qemu.html"><strong aria-hidden="true">8.1.13.</strong> é™æ€é“¾æ¥ï¼Œä»¥qemuä¸ºä¾‹</a></li><li class="chapter-item expanded "><a href="usr/cli/tailscale.html"><strong aria-hidden="true">8.1.14.</strong> Tailscale/Headscale</a></li><li class="chapter-item expanded "><a href="usr/cli/tailscale.nix.html"><strong aria-hidden="true">8.1.15.</strong> tailscale.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/tldr.nix.html"><strong aria-hidden="true">8.1.16.</strong> tldr.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/tmux.nix.html"><strong aria-hidden="true">8.1.17.</strong> tmux</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/index.html"><strong aria-hidden="true">8.1.18.</strong> ğŸ“‘neovim</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/cli/vim/auto-session.nix.html"><strong aria-hidden="true">8.1.18.1.</strong> auto sessions management</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/blink-cmp.nix.html"><strong aria-hidden="true">8.1.18.2.</strong> completion</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/close-windows.nix.html"><strong aria-hidden="true">8.1.18.3.</strong> key bindings of closing windows</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/codecompanion-nvim.nix.html"><strong aria-hidden="true">8.1.18.4.</strong> Code Companion: AI</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/color-scheme.nix.html"><strong aria-hidden="true">8.1.18.5.</strong> ğŸ¨My nvim color scheme</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/conform-nvim.nix.html"><strong aria-hidden="true">8.1.18.6.</strong> conform-nvim: formatter</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/default.nix.html"><strong aria-hidden="true">8.1.18.7.</strong> default.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/fold.nix.html"><strong aria-hidden="true">8.1.18.8.</strong> fold</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/git-wip.nix.html"><strong aria-hidden="true">8.1.18.9.</strong> git-wip: auto wip branch</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/gitsigns-nvim.nix.html"><strong aria-hidden="true">8.1.18.10.</strong> gitsigns-nvim: git support</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/hbac-nvim.nix.html"><strong aria-hidden="true">8.1.18.11.</strong> hbac-nvim: auto close buffer</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/leap-nvim.nix.html"><strong aria-hidden="true">8.1.18.12.</strong> leap-nvim.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/markdown-preview-nvim.nix.html"><strong aria-hidden="true">8.1.18.13.</strong> markdown-preview-nvim.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/mini-nvim.nix.html"><strong aria-hidden="true">8.1.18.14.</strong> mini-nvim: a nvim distro</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/minuet-ai-nvim.nix.html"><strong aria-hidden="true">8.1.18.15.</strong> minuet-ai-nvim.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-config-local.nix.html"><strong aria-hidden="true">8.1.18.16.</strong> nvim-config-local: secure load local vim config</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.1.18.17.</strong> nvim-lspconfig/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-lspconfig/c.nix.html"><strong aria-hidden="true">8.1.18.17.1.</strong> lspconfig for C/C++ language</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-lspconfig/default.nix.html"><strong aria-hidden="true">8.1.18.17.2.</strong> nvim-lspconfig</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-lspconfig/rust.nix.html"><strong aria-hidden="true">8.1.18.17.3.</strong> rust.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-lspconfig/scala.nix.html"><strong aria-hidden="true">8.1.18.17.4.</strong> If metals throw errors, check /.metals/metals.log</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-lspconfig/typst.nix.html"><strong aria-hidden="true">8.1.18.17.5.</strong> typst.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-nav.nix.html"><strong aria-hidden="true">8.1.18.18.</strong> nvim-nav.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-treesitter-context.nix.html"><strong aria-hidden="true">8.1.18.19.</strong> nvim-treesitter-context.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-treesitter.nix.html"><strong aria-hidden="true">8.1.18.20.</strong> nvim-treesitter: languages parsing</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/nvim-window-picker.nix.html"><strong aria-hidden="true">8.1.18.21.</strong> nvim-window-picker</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/outline-nvim.nix.html"><strong aria-hidden="true">8.1.18.22.</strong> outline-nvim.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/reject.avante-nvim.nix.html"><strong aria-hidden="true">8.1.18.23.</strong> avante-nvim: AI</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/reject.distant-nvim.nix.html"><strong aria-hidden="true">8.1.18.24.</strong> distant-nvim: edit remote files with local nvim</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/reject.remote-sshfs-nvim.nix.html"><strong aria-hidden="true">8.1.18.25.</strong> Deprecated: remote-sshfs.nvim: integrate sshfs into nvim</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/rustowl.nix.html"><strong aria-hidden="true">8.1.18.26.</strong> rustowl.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/smartyank-nvim.nix.html"><strong aria-hidden="true">8.1.18.27.</strong> smartyank-nvim: smart yank to clipboard</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/snacks-nvim.nix.html"><strong aria-hidden="true">8.1.18.28.</strong> image-nvim vs snacks-nvimé—®é¢˜</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/telescope-nvim.nix.html"><strong aria-hidden="true">8.1.18.29.</strong> telescope-nvim</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.1.18.30.</strong> treesitter-injections/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/cli/vim/treesitter-injections/default.nix.html"><strong aria-hidden="true">8.1.18.30.1.</strong> default.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="usr/cli/vim/venn-nvim.nix.html"><strong aria-hidden="true">8.1.18.31.</strong> DrawIt vs venn-nvim</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/vim-easy-align.nix.html"><strong aria-hidden="true">8.1.18.32.</strong> vim-easy-align: A simple, easy-to-use Vim alignment plugin.</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/vim-floaterm.nix.html"><strong aria-hidden="true">8.1.18.33.</strong> vim-floaterm: floating terminal</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/vim-hexokinase.nix.html"><strong aria-hidden="true">8.1.18.34.</strong> vim-hexokinase: display colors</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/vim-mark.nix.html"><strong aria-hidden="true">8.1.18.35.</strong> vim-mark: multi-color highlight</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/vim-matchup.nix.html"><strong aria-hidden="true">8.1.18.36.</strong> vim-matchup.nix.md</a></li><li class="chapter-item expanded "><a href="usr/cli/vim/winshift-nvim.nix.html"><strong aria-hidden="true">8.1.18.37.</strong> winshift-nvim: rearrange windows</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="usr/default.nix.html"><strong aria-hidden="true">8.2.</strong> usr/default.nix</a></li><li class="chapter-item expanded "><a href="usr/gui/index.html"><strong aria-hidden="true">8.3.</strong> gui/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/gui/cheatsheet_edit.nix.html"><strong aria-hidden="true">8.3.1.</strong> cheatsheet_edit.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/default.nix.html"><strong aria-hidden="true">8.3.2.</strong> default.nix.md</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.3.</strong> dms/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/gui/dms/default-settings.nix.html"><strong aria-hidden="true">8.3.3.1.</strong> default-settings.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/dms/default.nix.html"><strong aria-hidden="true">8.3.3.2.</strong> default.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/dms/plugins.nix.html"><strong aria-hidden="true">8.3.3.3.</strong> plugins.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/dms/settings.nix.html"><strong aria-hidden="true">8.3.3.4.</strong> settings.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="usr/gui/drawio.nix.html"><strong aria-hidden="true">8.3.4.</strong> drawio.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/eww.html"><strong aria-hidden="true">8.3.5.</strong> eww.md</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.6.</strong> fabric/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/gui/fabric/shell.nix.html"><strong aria-hidden="true">8.3.6.1.</strong> shell.nix.md</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.7.</strong> fcitx5/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/gui/fcitx5/default.nix.html"><strong aria-hidden="true">8.3.7.1.</strong> default.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/fcitx5/module.nix.html"><strong aria-hidden="true">8.3.7.2.</strong> module.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="usr/gui/feishu.html"><strong aria-hidden="true">8.3.8.</strong> å®‰è£…debåŒ…ï¼Œä»¥é£ä¹¦ä¸ºä¾‹</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.9.</strong> firefox/</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.9.1.</strong> apps/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/gui/firefox/apps/default.nix.html"><strong aria-hidden="true">8.3.9.1.1.</strong> firefox-apps</a></li><li class="chapter-item expanded "><a href="usr/gui/firefox/apps/module.nix.html"><strong aria-hidden="true">8.3.9.1.2.</strong> firefox module</a></li><li class="chapter-item expanded "><a href="usr/gui/firefox/apps/single-tab.nix.html"><strong aria-hidden="true">8.3.9.1.3.</strong> single-tab.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="usr/gui/firefox/default.nix.html"><strong aria-hidden="true">8.3.9.2.</strong> firefox configurations</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.9.3.</strong> extensions/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/gui/firefox/extensions/brotab.nix.html"><strong aria-hidden="true">8.3.9.3.1.</strong> brotab.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/firefox/extensions/chrome-mask.nix.html"><strong aria-hidden="true">8.3.9.3.2.</strong> chrome-mask.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/firefox/extensions/darkreader.nix.html"><strong aria-hidden="true">8.3.9.3.3.</strong> darkreader.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/firefox/extensions/default.nix.html"><strong aria-hidden="true">8.3.9.3.4.</strong> default.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/firefox/extensions/module.nix.html"><strong aria-hidden="true">8.3.9.3.5.</strong> module.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/firefox/extensions/sidebery.nix.html"><strong aria-hidden="true">8.3.9.3.6.</strong> TIPS (https://github.com/piroor/treestyletab/wiki/How-to-inspect-tree-of-tabs):</a></li><li class="chapter-item expanded "><a href="usr/gui/firefox/extensions/smart-toc.nix.html"><strong aria-hidden="true">8.3.9.3.7.</strong> smart-toc.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/firefox/extensions/smartproxy.nix.html"><strong aria-hidden="true">8.3.9.3.8.</strong> smartproxy.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/firefox/extensions/vimium.nix.html"><strong aria-hidden="true">8.3.9.3.9.</strong> vimium.nix.md</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="usr/gui/flameshot.nix.html"><strong aria-hidden="true">8.3.10.</strong> flameshot.nix.md</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.11.</strong> gnome/</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.11.1.</strong> calendar/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/gui/gnome/calendar/default.nix.html"><strong aria-hidden="true">8.3.11.1.1.</strong> default.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/calendar/module.nix.html"><strong aria-hidden="true">8.3.11.1.2.</strong> gnome-calendar module</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/calendar/template.nix.html"><strong aria-hidden="true">8.3.11.1.3.</strong> template.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="usr/gui/gnome/default.nix.html"><strong aria-hidden="true">8.3.11.2.</strong> default.nix.md</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.11.3.</strong> extensions/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/advanced-alttab-window-switcher.nix.html"><strong aria-hidden="true">8.3.11.3.1.</strong> advanced-alttab-window-switcher</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/auto-accent-colour.nix.html"><strong aria-hidden="true">8.3.11.3.2.</strong> auto-accent-colour.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/bing-wallpaper-changer.nix.html"><strong aria-hidden="true">8.3.11.3.3.</strong> BingWallpaper</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/bluetooth-battery-meter.nix.html"><strong aria-hidden="true">8.3.11.3.4.</strong> bluetooth battery meter</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/dash-to-dock.nix.html"><strong aria-hidden="true">8.3.11.3.5.</strong> dash-to-dock</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/default.nix.html"><strong aria-hidden="true">8.3.11.3.6.</strong> Gnome Extensions</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/deprecated.customize-ibus.nix.html"><strong aria-hidden="true">8.3.11.3.7.</strong> customize-ibus: input method customization</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/gtile.nix.html"><strong aria-hidden="true">8.3.11.3.8.</strong> gtile: tiled windows manager</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/hide-top-bar.nix.html"><strong aria-hidden="true">8.3.11.3.9.</strong> hide-top-bar</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/lunar-calendar.nix.html"><strong aria-hidden="true">8.3.11.3.10.</strong> lunar-calendar.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/new-workspace-shortcut.nix.html"><strong aria-hidden="true">8.3.11.3.11.</strong> new-workspace-shortcut.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/pano.nix.html"><strong aria-hidden="true">8.3.11.3.12.</strong> pano: Next-gen Clipboard Manager for Gnome Shell</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/system-monitor.nix.html"><strong aria-hidden="true">8.3.11.3.13.</strong> system-monitor</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/transparent-top-bar.nix.html"><strong aria-hidden="true">8.3.11.3.14.</strong> transparent-top-bar: able to adjust transparency</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/unite.nix.html"><strong aria-hidden="true">8.3.11.3.15.</strong> unite: unite style</a></li><li class="chapter-item expanded "><a href="usr/gui/gnome/extensions/wsp-windows-search-provider.nix.html"><strong aria-hidden="true">8.3.11.3.16.</strong> wsp-windows-search-provider.nix.md</a></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.12.</strong> hyprland/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/gui/hyprland/default.nix.html"><strong aria-hidden="true">8.3.12.1.</strong> Cons:</a></li><li class="chapter-item expanded "><a href="usr/gui/hyprland/hyprshell.nix.html"><strong aria-hidden="true">8.3.12.2.</strong> Hyprspace vs hyprshell</a></li><li class="chapter-item expanded "><a href="usr/gui/hyprland/hyprview.nix.html"><strong aria-hidden="true">8.3.12.3.</strong> hyprview.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/hyprland/ironbar.nix.html"><strong aria-hidden="true">8.3.12.4.</strong> ironbar.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="usr/gui/kdeconnect.nix.html"><strong aria-hidden="true">8.3.13.</strong> KDE Connect</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.14.</strong> kitty/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/gui/kitty/default.nix.html"><strong aria-hidden="true">8.3.14.1.</strong> kitty</a></li><li class="chapter-item expanded "><a href="usr/gui/kitty/search.nix.html"><strong aria-hidden="true">8.3.14.2.</strong> search.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/kitty/timer.nix.html"><strong aria-hidden="true">8.3.14.3.</strong> timer.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="usr/gui/mime.nix.html"><strong aria-hidden="true">8.3.15.</strong> https://nixos.org/manual/nixos/stable/#sec-writing-modules</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.16.</strong> niri/</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.16.1.</strong> config/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/gui/niri/config/binds.nix.html"><strong aria-hidden="true">8.3.16.1.1.</strong> Use wev to find out key name</a></li><li class="chapter-item expanded "><a href="usr/gui/niri/config/default.nix.html"><strong aria-hidden="true">8.3.16.1.2.</strong> default.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="usr/gui/niri/default.nix.html"><strong aria-hidden="true">8.3.16.2.</strong> Cons:</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.3.17.</strong> plasma/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/gui/plasma/default.nix.html"><strong aria-hidden="true">8.3.17.1.</strong> Cons:</a></li></ol></li><li class="chapter-item expanded "><a href="usr/gui/rofi.nix.html"><strong aria-hidden="true">8.3.18.</strong> rofi.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/rustdesk.nix.html"><strong aria-hidden="true">8.3.19.</strong> rustdesk, the remote desktop app</a></li><li class="chapter-item expanded "><a href="usr/gui/typora.html"><strong aria-hidden="true">8.3.20.</strong> Typora</a></li><li class="chapter-item expanded "><a href="usr/gui/warpd.nix.html"><strong aria-hidden="true">8.3.21.</strong> warpd.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/waydroid.html"><strong aria-hidden="true">8.3.22.</strong> Wayland</a></li><li class="chapter-item expanded "><a href="usr/gui/weixin.nix.html"><strong aria-hidden="true">8.3.23.</strong> weixin.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/wrapWine.nix.html"><strong aria-hidden="true">8.3.24.</strong> based on https://github.com/lucasew/nixcfg/blob/49d44c1a655f1c20d7354ecea942c78704067d50/pkgs/wrapWine.nix</a></li><li class="chapter-item expanded "><a href="usr/gui/wsl.nix.html"><strong aria-hidden="true">8.3.25.</strong> wsl.nix.md</a></li><li class="chapter-item expanded "><a href="usr/gui/xcolor.nix.html"><strong aria-hidden="true">8.3.26.</strong> XColor</a></li><li class="chapter-item expanded "><a href="usr/gui/xdot.nix.html"><strong aria-hidden="true">8.3.27.</strong> xdot, the dot (graphviz) viewer</a></li><li class="chapter-item expanded "><a href="usr/gui/xelfviewer.nix.html"><strong aria-hidden="true">8.3.28.</strong> xelfviewer.nix.md</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.4.</strong> modules/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/modules/cachix.nix.html"><strong aria-hidden="true">8.4.1.</strong> cachix.nix.md</a></li><li class="chapter-item expanded "><a href="usr/modules/default.nix.html"><strong aria-hidden="true">8.4.2.</strong> default.nix.md</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.4.3.</strong> yq-merge/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="usr/modules/yq-merge/default.nix.html"><strong aria-hidden="true">8.4.3.1.</strong> default.nix.md</a></li><li class="chapter-item expanded "><a href="usr/modules/yq-merge/test.nix.html"><strong aria-hidden="true">8.4.3.2.</strong> test.nix.md</a></li></ol></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">ğŸ¤–å®‰å“é…ç½®(æ— éœ€sudo,å¤ç”¨"ç”¨æˆ·é…ç½®")</li><li class="chapter-item expanded "><a href="nix-on-droid.nix.html"><strong aria-hidden="true">9.</strong> nix-on-droid.nix</a></li><li class="chapter-item expanded affix "><li class="part-title">ğŸ”©é€šç”¨æ¨¡å—</li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.</strong> modules/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="modules/cachix.nix.html"><strong aria-hidden="true">10.1.</strong> cachix.nix.md</a></li><li class="chapter-item expanded "><a href="modules/default.nix.html"><strong aria-hidden="true">10.2.</strong> default.nix.md</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">ğŸ“æ–‡æ¡£å’Œå¿ƒå¾—ä½“ä¼š</li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.</strong> docs/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="docs/explanation/index.html"><strong aria-hidden="true">11.1.</strong> explanation/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="docs/explanation/buildtime-deps-runtime-deps.html"><strong aria-hidden="true">11.1.1.</strong> buildtime-deps-runtime-deps.md</a></li><li class="chapter-item expanded "><a href="docs/explanation/dependency.html"><strong aria-hidden="true">11.1.2.</strong> Describing Dependency</a></li><li class="chapter-item expanded "><a href="docs/explanation/modules.html"><strong aria-hidden="true">11.1.3.</strong> Module</a></li><li class="chapter-item expanded "><a href="docs/explanation/nixpkgs.html"><strong aria-hidden="true">11.1.4.</strong> Nixpkgs</a></li></ol></li><li class="chapter-item expanded "><a href="docs/howto/index.html"><strong aria-hidden="true">11.2.</strong> howto/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="docs/howto/32bit.html"><strong aria-hidden="true">11.2.1.</strong> æ‰“åŒ…/ç¼–è¯‘32ä½ç¨‹åº</a></li><li class="chapter-item expanded "><a href="docs/howto/auto_push_to_cachix/index.html"><strong aria-hidden="true">11.2.2.</strong> Auto Push Packages to Cachix</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="docs/howto/auto_push_to_cachix/cachix-package.nix.html"><strong aria-hidden="true">11.2.2.1.</strong> cachixPackage</a></li><li class="chapter-item expanded "><a href="docs/howto/auto_push_to_cachix/example.nix.html"><strong aria-hidden="true">11.2.2.2.</strong> Example for cachixPackage</a></li></ol></li><li class="chapter-item expanded "><a href="docs/howto/backup_binary_cache.html"><strong aria-hidden="true">11.2.3.</strong> å¤‡ä»½binary cache</a></li><li class="chapter-item expanded "><a href="docs/howto/cross.html"><strong aria-hidden="true">11.2.4.</strong> äº¤å‰ç¼–è¯‘å’Œå®‰è£…è·¨å¹³å°ç¨‹åº</a></li><li class="chapter-item expanded "><a href="docs/howto/install_nixos.html"><strong aria-hidden="true">11.2.5.</strong> å®‰è£…NixOS</a></li><li class="chapter-item expanded "><a href="docs/howto/kernel_config.html"><strong aria-hidden="true">11.2.6.</strong> How To Config Linux Kernel in Nix</a></li></ol></li><li class="chapter-item expanded "><a href="docs/slides/index.html"><strong aria-hidden="true">11.3.</strong> slides/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="docs/slides/2023.nix-env.html"><strong aria-hidden="true">11.3.1.</strong> Nixè®©ä½ çš„å›¢é˜Ÿæˆå‘˜ä¸å†å—ç¯å¢ƒé—®é¢˜å›°æ‰°</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">ğŸ“ƒNixè„šæœ¬ï¼ˆnix-shellå’Œæ‰“åŒ…ï¼‰</li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.</strong> scripts/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="scripts/fhs-shell/index.html"><strong aria-hidden="true">12.1.</strong> fhs-shell/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="scripts/fhs-shell/dynamorio.nix.html"><strong aria-hidden="true">12.1.1.</strong> dynamorio.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/fhs-shell/hello.nix.html"><strong aria-hidden="true">12.1.2.</strong> hello.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/fhs-shell/pin.nix.html"><strong aria-hidden="true">12.1.3.</strong> pin.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/fhs-shell/spec.nix.html"><strong aria-hidden="true">12.1.4.</strong> spec.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/fhs-shell/x11.nix.html"><strong aria-hidden="true">12.1.5.</strong> x11.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/fhs-shell/xilinx.nix.html"><strong aria-hidden="true">12.1.6.</strong> xilinx.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="scripts/pkgs/index.html"><strong aria-hidden="true">12.2.</strong> pkgs/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="scripts/pkgs/7z.nix.html"><strong aria-hidden="true">12.2.1.</strong> TODO: 7z need dynamical link 7z.so</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/android.html"><strong aria-hidden="true">12.2.2.</strong> åœ¨NixOSä¸Šä½¿ç”¨Androidç¨‹åº</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/android.nix.html"><strong aria-hidden="true">12.2.3.</strong> android.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/appimage_runtime.nix.html"><strong aria-hidden="true">12.2.4.</strong> appimage_runtime.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/coremarks.nix.html"><strong aria-hidden="true">12.2.5.</strong> coremarks.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/cross_mips.nix.html"><strong aria-hidden="true">12.2.6.</strong> cross_mips.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/cross_static_hello.nix.html"><strong aria-hidden="true">12.2.7.</strong> cross_static_hello.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/fhs_helloworld.nix.html"><strong aria-hidden="true">12.2.8.</strong> fhs_helloworld.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/fhs_spec2000_perl.nix.html"><strong aria-hidden="true">12.2.9.</strong> fhs_spec2000_perl.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/herdtools7.nix.html"><strong aria-hidden="true">12.2.10.</strong> herdtools7.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/nix-binary-tarballs-new.nix.html"><strong aria-hidden="true">12.2.11.</strong> nix-binary-tarballs-new.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/nix-binary-tarballs.nix.html"><strong aria-hidden="true">12.2.12.</strong> nix-binary-tarballs.nix.md</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.2.13.</strong> nix-docker-isa/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="scripts/pkgs/nix-docker-isa/default.nix.html"><strong aria-hidden="true">12.2.13.1.</strong> ğŸ³Nix DockerğŸ‹ for Multiple ISAs</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/nix-docker-isa/dockers.nix.html"><strong aria-hidden="true">12.2.13.2.</strong> dockers.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="scripts/pkgs/nvchad.nix.html"><strong aria-hidden="true">12.2.14.</strong> nvchad.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/qemu-sys-static.nix.html"><strong aria-hidden="true">12.2.15.</strong> qemu-sys-static.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/qemu-sys_riscv64_static.nix.html"><strong aria-hidden="true">12.2.16.</strong> qemu-sys_riscv64_static.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/qemu_riscv64_static.nix.html"><strong aria-hidden="true">12.2.17.</strong> qemu_riscv64_static.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/qemu_static.nix.html"><strong aria-hidden="true">12.2.18.</strong> qemu_static.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/qemu_tests_tcg.nix.html"><strong aria-hidden="true">12.2.19.</strong> qemu_tests_tcg.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/qemus.nix.html"><strong aria-hidden="true">12.2.20.</strong> build by version</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/shellinabox.nix.html"><strong aria-hidden="true">12.2.21.</strong> https://github.com/NixOS/nixpkgs/issues/185773</a></li><li class="chapter-item expanded "><a href="scripts/pkgs/xiangshan.nix.html"><strong aria-hidden="true">12.2.22.</strong> xiangshan.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="scripts/shell/index.html"><strong aria-hidden="true">12.3.</strong> shell/</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="scripts/shell/LinkNan.nix.html"><strong aria-hidden="true">12.3.1.</strong> LinkNan.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/ccache.nix.html"><strong aria-hidden="true">12.3.2.</strong> ccache.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/chipyard.nix.html"><strong aria-hidden="true">12.3.3.</strong> chipyard.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/cross_mips.nix.html"><strong aria-hidden="true">12.3.4.</strong> cross_mips.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/cross_platform.nix.html"><strong aria-hidden="true">12.3.5.</strong> cross_platform.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/devshell_hello.nix.html"><strong aria-hidden="true">12.3.6.</strong> devshell_hello.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/gcc.nix.html"><strong aria-hidden="true">12.3.7.</strong> gcc.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/hello.nix.html"><strong aria-hidden="true">12.3.8.</strong> hello.nix.md</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.3.9.</strong> propagate/</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="scripts/shell/propagate/child.nix.html"><strong aria-hidden="true">12.3.9.1.</strong> child.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/propagate/grandchild.nix.html"><strong aria-hidden="true">12.3.9.2.</strong> grandchild.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/propagate/parent.nix.html"><strong aria-hidden="true">12.3.9.3.</strong> parent.nix.md</a></li></ol></li><li class="chapter-item expanded "><a href="scripts/shell/pygame.nix.html"><strong aria-hidden="true">12.3.10.</strong> pygame.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/python_fhs_venv.nix.html"><strong aria-hidden="true">12.3.11.</strong> https://nixos.wiki/wiki/Python</a></li><li class="chapter-item expanded "><a href="scripts/shell/python_mach.nix.html"><strong aria-hidden="true">12.3.12.</strong> python_mach.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/python_venv.nix.html"><strong aria-hidden="true">12.3.13.</strong> python_venv.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/qemu_plugins.nix.html"><strong aria-hidden="true">12.3.14.</strong> qemu_plugins.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/qemu_tests_tcg.nix.html"><strong aria-hidden="true">12.3.15.</strong> qemu_tests_tcg.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/riscv-tests.nix.html"><strong aria-hidden="true">12.3.16.</strong> riscv-tests.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/spike.nix.html"><strong aria-hidden="true">12.3.17.</strong> spike.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/texlive.nix.html"><strong aria-hidden="true">12.3.18.</strong> texlive.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/ucasproposal.nix.html"><strong aria-hidden="true">12.3.19.</strong> ucasproposal.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/v8.nix.html"><strong aria-hidden="true">12.3.20.</strong> v8.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/venv.nix.html"><strong aria-hidden="true">12.3.21.</strong> venv.nix.md</a></li><li class="chapter-item expanded "><a href="scripts/shell/wine6.nix.html"><strong aria-hidden="true">12.3.22.</strong> wine6.nix.md</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">ğŸ“Œå…¶ä»–</li><li class="chapter-item expanded "><a href="shell.nix.html"><strong aria-hidden="true">13.</strong> shell.nix</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Xieby1&#x27;s Nix/NixOS Config</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/xieby1/nix_config" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p>ğŸ—ï¸ <em>æˆ‘çš„Nix/NixOSé…ç½®è¯¦ç»†æ–‡æ¡£æ­£åœ¨æ–½å·¥ä¸­ï¼Œå®Œæˆè¿›åº¦ï¼š<span style="font-size:2em;"><strong>70/193</strong></span></em> ğŸ—ï¸</p>
<p>ä¸ºäº†æ›´å¥½çš„æ–‡æ¡£é˜…è¯»ä½“éªŒï¼Œè¯·çœ‹<a href="https://xieby1.github.io/nix_config/">GitHub Pages</a>çš„ç‰ˆæœ¬ã€‚</p>
<h2 id="ç›®å½•"><a class="header" href="#ç›®å½•">ç›®å½•</a></h2>
<!-- vim-markdown-toc GFM -->
<ul>
<li><a href="index.html#nixnixos%E7%AE%80%E4%BB%8B">Nix/NixOSç®€ä»‹</a></li>
<li><a href="index.html#xieby1%E5%92%8Cnixnixos">xieby1å’ŒNix/NixOS</a></li>
<li><a href="index.html#xieby1%E7%9A%84nixnixos%E9%85%8D%E7%BD%AE">xieby1çš„Nix/NixOSé…ç½®</a>
<ul>
<li><a href="index.html#%E6%96%87%E4%BB%B6%E5%A4%B9%E7%BB%93%E6%9E%84">æ–‡ä»¶å¤¹ç»“æ„</a></li>
<li><a href="index.html#nix%E8%84%9A%E6%9C%AC%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95">nixè„šæœ¬çš„ä½¿ç”¨æ–¹æ³•</a>
<ul>
<li><a href="index.html#nix-shell%E7%9A%84%E4%BE%8B%E5%AD%90">nix-shellçš„ä¾‹å­</a></li>
</ul>
</li>
<li><a href="index.html#nix%E9%85%8D%E7%BD%AE%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95">nixé…ç½®çš„ä½¿ç”¨æ–¹æ³•</a></li>
<li><a href="index.html#%E5%BC%95%E7%94%A8">å¼•ç”¨</a></li>
</ul>
</li>
</ul>
<!-- vim-markdown-toc -->
<h1 id="nixnixosç®€ä»‹"><a class="header" href="#nixnixosç®€ä»‹">Nix/NixOSç®€ä»‹</a></h1>
<p>Nixæ˜¯ä¸€ä¸ªå¯é‡ç°çš„ï¼ˆReproducibleï¼‰åŒ…ç®¡ç†å™¨ï¼Œä¹Ÿæ˜¯ä¸€é—¨çº¯å‡½æ•°å¼çš„ï¼ˆPure Functionalï¼‰ç¼–ç¨‹è¯­è¨€ã€‚
ç†è®ºä¸Šè®²ï¼ŒNixåŒ…ç®¡ç†å™¨å¯ä»¥å®‰è£…åœ¨ä»»ä½•Linuxå‘è¡Œç‰ˆä¸Š(æ¯”å¦‚Ubuntuã€Debianå’ŒArchç­‰)ï¼Œå¹¶ä¸è¿™äº›å‘è¡Œç‰ˆåŸæœ‰çš„åŒ…ç®¡ç†å™¨ï¼ˆæ¯”å¦‚snapã€aptå’Œpacmanç­‰ï¼‰å…±å­˜ã€‚
è€ŒNixOSåˆ™æ˜¯å®Œå…¨ç”±NixåŒ…ç®¡ç†å™¨è¿›è¡Œç®¡ç†çš„Linuxå‘è¡Œç‰ˆã€‚</p>
<p>Nix/NixOSé‡‡ç”¨äº†â€œåŒ…ï¼ˆPackageï¼‰â€çš„ç†å¿µï¼Œå°†Linuxå†…æ ¸ã€é©±åŠ¨ã€å‡½æ•°åº“ã€ç”¨æˆ·ç¨‹åºã€é…ç½®æ–‡ä»¶ç­‰æ–¹æ–¹é¢é¢æŠ½è±¡å‡ºæ¥ã€‚
è¿™ç±»ä¼¼äºLinuxå†…æ ¸å°†è®¾å¤‡ã€ç£ç›˜æ–‡ä»¶ã€ç®¡é“ç­‰éƒ½æŠ½è±¡ä¸ºæ–‡ä»¶çš„ç†å¿µã€‚
è¿™æ ·çš„æŠ½è±¡ä½¿å¾—Nix/NixOSèƒ½ä»¥ä¸€ç§ç»Ÿä¸€çš„æ–¹å¼ç®¡ç†æ‰€æœ‰çš„åŒ…ã€‚</p>
<p>ä¸ºäº†é˜²æ­¢â€œåŒ…â€è¢«ç”¨æˆ·æœ‰æ„æˆ–æ— æ„åœ°ä¿®æ”¹ï¼ˆå³ä¿è¯å¯é‡ç°æ€§ï¼‰ï¼ŒNix/NixOSå°†æ‰€æœ‰çš„åŒ…éƒ½æ”¾åœ¨ä¸€ä¸ªåªè¯»æ–‡ä»¶ç³»ç»Ÿä¸­ï¼ˆæŒ‚è½½åœ¨<code>/nix/store</code>ç›®å½•ä¸Šï¼‰ã€‚
è¿™ä¸ªç›®å½•ä¸­çš„åŒ…ä»…èƒ½é€šè¿‡NixåŒ…ç®¡ç†å™¨å’ŒNixè¯­è¨€ç¼–ç¨‹è¿›è¡Œå¢åˆ æ”¹ã€‚
ä¸ºäº†å°†<code>/nix/store</code>ä¸­çš„æ–‡ä»¶æ”¾ç½®åœ¨å®ƒä»¬åº”è¯¥åœ¨çš„åœ°æ–¹ï¼ˆæ¯”å¦‚æŸä¸ªç”¨æˆ·ä½¿ç”¨çš„åŒ…é‡Œå­˜åœ¨<code>bin/</code>ç›®å½•ï¼Œåˆ™åº”å½“æŠŠbin/ä¸­æ‰€æœ‰çš„æ–‡ä»¶æ”¾å…¥<code>/run/current-system/sw/bin/</code>ï¼‰ï¼ŒNix/NixOSå¤§é‡ä½¿ç”¨ç¬¦å·é“¾æ¥ã€‚</p>
<p>ä¸Šè¿°Nix/NixOSçš„ç‰¹ç‚¹å’Œä¼ ç»ŸLinuxå‘è¡Œç‰ˆæœ‰ç€æå¤§çš„åŒºåˆ«ã€‚
è¿™ä½¿å¾—Nix/NixOSçš„å­¦ä¹ æ›²çº¿ååˆ†é™¡å³­ã€‚
ä¸è¿‡å½“ä½ é€‚åº”Nix/NixOSçš„è¿™äº›ç‰¹ç‚¹åï¼Œå®ƒå¯ä»¥æå¤§æå‡å·¥ç¨‹æ•ˆç‡!</p>
<h1 id="xieby1å’Œnixnixos"><a class="header" href="#xieby1å’Œnixnixos">xieby1å’ŒNix/NixOS</a></h1>
<p>å¤šå¹´æ¥ï¼ŒNix/NixOSå·²æˆä¸ºæˆ‘å­¦ä¹ å’Œå·¥ä½œçš„é‡è¦åŸºç¡€ï¼Œä¸»è¦ç”¨äºä»¥ä¸‹æ–¹é¢ï¼š</p>
<ul>
<li>å­¦ä¹ Linuxã€‚
Nix/NixOSé‡‡ç”¨äº†â€œåŒ…ï¼ˆPackageï¼‰â€çš„ç†å¿µï¼Œå°†Linuxå†…æ ¸ã€é©±åŠ¨ã€å‡½æ•°åº“ã€ç”¨æˆ·ç¨‹åºã€é…ç½®æ–‡ä»¶ç­‰æ–¹æ–¹é¢é¢æŠ½è±¡å‡ºæ¥ã€‚
é€šè¿‡å­¦ä¹ Nixè¯­è¨€ï¼Œæˆ‘èƒ½å¤Ÿä»¥ç»Ÿä¸€çš„æ–¹å¼äº†è§£Linuxç³»ç»Ÿçš„å„ä¸ªæ–¹é¢ï¼Œè¿™æ˜¯å…¶ä»–å·¥å…·æ‰€æ— æ³•æä¾›çš„ã€‚</li>
<li>ç®¡ç†ç¯å¢ƒã€‚
é€šè¿‡ä½¿ç”¨nix-shellç®¡ç†æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬åº“ã€ç¯å¢ƒå˜é‡ã€é…ç½®ç­‰ï¼‰ï¼Œå¯ä»¥é¿å…é¡¹ç›®ç¯å¢ƒé‡ç°çš„é—®é¢˜ã€‚
ç±»ä¼¼çš„å·¥å…·è¿˜æœ‰è™šæ‹Ÿæœºå’ŒDockerã€‚
ç›¸æ¯”ä½¿ç”¨è™šæ‹Ÿæœºï¼Œå®ƒæ›´è½»é‡ã€‚
ç›¸æ¯”Dockerï¼Œå®ƒæ”¯æŒå¯å¤ç°æ„å»ºï¼Œé‡‡ç”¨Nixè¯­è¨€æ›´çµæ´»ã€‚
è¯¦ç»†å¯è§æˆ‘äº2023å¹´ä¸ºå®éªŒå®¤åŒå­¦ä»¬å‡†å¤‡çš„<a href="https://xieby1.github.io/nix_config/docs/slides/2023.nix-env.html">æ¨èNix/NixOSçš„å¹»ç¯ç‰‡</a>ã€‚</li>
<li>å¤‡ä»½ç”µè„‘ã€‚
Nix/NixOSèƒ½å¤Ÿç®¡ç†ç³»ç»Ÿã€è½¯ä»¶åŠå…¶é…ç½®ã€‚
è™½ç„¶Nix/NixOSä¸ç›´æ¥ç®¡ç†æ•°æ®ï¼Œä½†Nix/NixOSå¯ä»¥å¾ˆå¥½åœ°ç®¡ç†æ•°æ®åŒæ­¥è½¯ä»¶ï¼Œæ¯”å¦‚Syncthingã€‚
å› æ­¤åªè¦ä¿ç•™ç€Nix/NixOSçš„é…ç½®æ–‡ä»¶ï¼ˆç”±Nixè¯­è¨€ç¼–å†™ï¼‰ï¼Œå°±èƒ½æ¢å¤å‡ºä¸€ä¸ªå‡ ä¹ä¸€æ¨¡ä¸€æ ·<sup class="footnote-reference"><a href="#impure">1</a></sup>çš„è½¯ä»¶ç¯å¢ƒ/æ“ä½œç³»ç»Ÿã€‚</li>
</ul>
<h1 id="xieby1çš„nixnixosé…ç½®"><a class="header" href="#xieby1çš„nixnixosé…ç½®">xieby1çš„Nix/NixOSé…ç½®</a></h1>
<p>è¿™ä¸ªä»“åº“<a href="https://github.com/xieby1/nix_config">Github: xieby1/nix_config</a>é‡Œå­˜æ”¾ç€æˆ‘çš„Nix/NixOSé…ç½®å’Œæ–‡æ¡£ã€‚
è¯¥ä»“åº“ä½¿ç”¨nix expressionï¼Œè€Œénix flakesï¼›
ä½¿ç”¨NixOSç¨³å®šæºï¼ˆç›®å‰ç‰ˆæœ¬25.11ï¼‰ï¼Œè€Œééç¨³å®šæºï¼ˆunstableï¼‰ã€‚
è¯¥ä»“åº“çš„é…ç½®åœ¨å¤šä¸ªå¹³å°éƒ½å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼š</p>
<ul>
<li>NixOS: QEMUâœ…ï¼ŒNixOSå•ç³»ç»Ÿâœ…ï¼ŒNixOS+WindowsåŒç³»ç»Ÿâœ…</li>
<li>Nix: Linuxâœ…ï¼Œå®‰å“ï¼ˆnix-on-droidï¼‰âœ…ï¼ŒWSL2âœ…</li>
</ul>
<p>ä½ å¯ä»¥ä½¿ç”¨è¯¥ä»“åº“çš„é…ç½®ï¼Œé…ç½®å‡ºå®Œæ•´NixOSæ“ä½œç³»ç»Ÿã€‚
ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä¸­çš„éƒ¨åˆ†åŒ…ã€æ¨¡å—ï¼Œæ‰©å……è‡ªå·±çš„Nix/NixOSã€‚
è‹¥ä½ ä¸ä»…åªæ˜¯æƒ³å®‰è£…Nix/NixOSï¼Œè¿˜æƒ³äº†è§£æ›´å¤šNix/NixOSçš„çŸ¥è¯†ï¼Œ
æ¬¢è¿çœ‹çœ‹è¿™ä¸ªä»“åº“çš„æ–‡æ¡£<a href="https://xieby1.github.io/nix_config">xieby1.github.io/nix_config</a>ã€‚</p>
<h2 id="æ–‡ä»¶å¤¹ç»“æ„"><a class="header" href="#æ–‡ä»¶å¤¹ç»“æ„">æ–‡ä»¶å¤¹ç»“æ„</a></h2>
<ul>
<li>docs/: æ–‡æ¡£</li>
<li>scripts/: nixè„šæœ¬
<ul>
<li>fhs-shell/: é‡‡ç”¨FHSçš„nix-shellè„šæœ¬</li>
<li>shell/: nix-shellè„šæœ¬</li>
<li>pkgs/: ç‹¬ç«‹çš„è½¯ä»¶åŒ…è„šæœ¬</li>
</ul>
</li>
<li>sys/: ç³»ç»Ÿæ€»ä½“é…ç½®ï¼ˆnixos-rebuildçš„é…ç½®ï¼‰
<ul>
<li>cli/: ç³»ç»Ÿå‘½ä»¤è¡Œé…ç½®</li>
<li>gui/: ç³»ç»Ÿå›¾å½¢é…ç½®</li>
<li>modules/: ç³»ç»Ÿæ¨¡å—</li>
</ul>
</li>
<li>usr/: ç”¨æˆ·æ€»ä½“é…ç½®ï¼ˆhome-managerçš„é…ç½®ï¼‰
<ul>
<li>cli/: ç”¨æˆ·å‘½ä»¤è¡Œé…ç½®</li>
<li>gui/: ç”¨æˆ·å›¾å½¢é…ç½®</li>
<li>modules/: ç”¨æˆ·æ¨¡å—</li>
</ul>
</li>
<li>nix-on-droid.nix: å®‰å“æ€»ä½“é…ç½®ï¼ˆnix-on-droidçš„é…ç½®ï¼‰</li>
<li>modules/: nixos/home-manageré€šç”¨çš„æ¨¡å—</li>
</ul>
<h2 id="nixè„šæœ¬çš„ä½¿ç”¨æ–¹æ³•"><a class="header" href="#nixè„šæœ¬çš„ä½¿ç”¨æ–¹æ³•">nixè„šæœ¬çš„ä½¿ç”¨æ–¹æ³•</a></h2>
<p>å®‰è£…Nixä¸åœ¨æ­¤èµ˜è¿°ï¼Œå‚è€ƒ<a href="https://nixos.org/download.html">nixos.org/download.html</a>ã€‚</p>
<p>å®‰è£…å®ŒNixåï¼Œä¸‹è½½æ‰€éœ€çš„nixè„šæœ¬ï¼Œç„¶åï¼š</p>
<ul>
<li><code>fhs-shell/</code>å’Œ<code>shell/</code>è„šæœ¬ç”¨<code>nix-shell</code>å‘½ä»¤è¿›å…¥shellç¯å¢ƒï¼›</li>
<li><code>pkgs/</code>è„šæœ¬ç”¨<code>nix-build</code>å‘½ä»¤ç”Ÿæˆè½¯ä»¶åŒ…ã€‚</li>
</ul>
<h3 id="nix-shellçš„ä¾‹å­"><a class="header" href="#nix-shellçš„ä¾‹å­">nix-shellçš„ä¾‹å­</a></h3>
<pre><code class="language-bash"># ä»¥xiangshan.nixé…ç½®é¦™å±±å¼€å‘ç¯å¢ƒä¸ºä¾‹
# è¿›å…¥é¦™å±±çš„æ ¹ç›®å½•
cd Xiangshan
# ä¸‹è½½xiangshan.nixè„šæœ¬ï¼Œå¹¶é‡å‘½åä¸ºshell.nix
wget https://raw.githubusercontent.com/xieby1/nix_config/main/scripts/shell/xiangshan.nix -O shell.nix
# è¿›å…¥nix shell
nix-shell
</code></pre>
<h2 id="nixé…ç½®çš„ä½¿ç”¨æ–¹æ³•"><a class="header" href="#nixé…ç½®çš„ä½¿ç”¨æ–¹æ³•">nixé…ç½®çš„ä½¿ç”¨æ–¹æ³•</a></h2>
<p>è™šæ‹Ÿæœº/ç‰©ç†æœºå•ç³»ç»Ÿ/ç‰©ç†æœºåŒç³»ç»Ÿ å®‰è£…NixOS å¯ä»¥å‚è€ƒæˆ‘ä¸¤å¹´å‰çš„<a href="./docs/howto/install_nixos.html">NixOSå®‰è£…</a>è¿‡ç¨‹ã€‚
å®‰è£…Nix/NixOSä¸åœ¨æ­¤èµ˜è¿°ï¼Œå‚è€ƒ<a href="https://nixos.org/download.html">nixos.org/download.html</a>ã€‚</p>
<p>å®‰è£…å®ŒNix/NixOSåï¼Œé¦–å…ˆä¸‹è½½æˆ‘çš„é…ç½®</p>
<pre><code class="language-bash">git clone https://github.com/xieby1/nix_config.git ~/.config/nixpkgs
# [ä»…NixOS] åœ¨importsä¸­æ·»åŠ sys/çš„è·¯å¾„
vim /etc/nixos/configuration.nix
</code></pre>
<p>ç„¶åè®¾ç½®è½¯ä»¶æºï¼Œåœ¨NixOSä¸­æ¨èä½¿ç”¨<code>sudo</code>ã€‚</p>
<ul>
<li>æ³¨ä¸€ï¼šæ›´å¤šå…¶ä»–nix channelså‚è€ƒ
<a href="https://nixos.wiki/wiki/Nix_channels">NixOS Wiki: Nix channels</a>
å’Œ<a href="https://status.nixos.org/">Nix channel status</a>ã€‚</li>
<li>æ³¨äºŒï¼šä¸ºä»€ä¹ˆç”¨https://nixos.org/channels/nixos-25.11ï¼Œ
è€Œéhttps://github.com/NixOS/nixpkgs/archive/release-25.11.tar.gzï¼Ÿ
å‰è€…åŒ…å«é¢å¤–å†…å®¹ï¼Œæ¯”å¦‚programs.command-not-found.dbPathï¼Œè¯¦ç»†è§<code>man configuration.nix</code>ã€‚</li>
</ul>
<pre><code class="language-bash"># [å¯¹äºNixOS]
nix-channel --add https://nixos.org/channels/nixos-25.11 nixos
# [å¯¹äºNix]
nix-channel --add https://nixos.org/channels/nixos-25.11 nixpkgs
# æ·»åŠ home manageræº
nix-channel --add https://github.com/nix-community/home-manager/archive/release-25.11.tar.gz home-manager
nix-channel --update
</code></pre>
<p>æœ€åéƒ¨ç½²é…ç½®</p>
<pre><code class="language-bash"># [ä»…NixOS]
sudo nixos-rebuild switch
# å®‰è£…home-manager
nix-shell '&lt;home-manager&gt;' -A install
# åœ¨home-manageré…ç½®ä¸­æ·»åŠ usr/çš„è·¯å¾„
vim ~/.config/home-manager/home.nix
## ä¾‹å¦‚  imports = [ /home/xieby1/.config/nixpkgs/usr ];
# ç”¨nix expressionè€Œä¸ä½¿ç”¨nix flakes
rm ~/.config/home-manager/flake.nix
home-manager switch
</code></pre>
<h2 id="å¼•ç”¨"><a class="header" href="#å¼•ç”¨">å¼•ç”¨</a></h2>
<div class="footnote-definition" id="impure"><sup class="footnote-definition-label">1</sup>
<p>nix 2.8çš„impureç‰¹æ€§å’Œhome-managerç­‰ä¼šå¼•å…¥ä¸€äº›ä½ å‡ ä¹å¯Ÿè§‰ä¸åˆ°çš„å·®å¼‚ã€‚</p>
</div>
<div class="footnote-definition" id="doc_thesis"><sup class="footnote-definition-label">2</sup>
<p>Dolstra, Eelco. â€œThe purely functional software deployment model.â€ (2006).</p>
</div>
<div class="footnote-definition" id="nix-on-droid"><sup class="footnote-definition-label">3</sup>
<p><a href="https://github.com/t184256/nix-on-droid">github.com/t184256/nix-on-droid</a> termuxçš„åˆ†æ”¯ï¼Œæ”¯æŒnixã€‚</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="confignix"><a class="header" href="#confignix">config.nix</a></h1>
<p>å½“åˆå§‹åŒ–<code>nixpkgs</code>æ—¶ï¼Œä¾‹å¦‚<code>pkgs = import &lt;nixpkgs&gt; {}</code>ï¼Œ
<code>nixpkgs</code>çš„åˆå§‹åŒ–ä»£ç ä¼šè¯»å–<code>~/.config/nixpkgs/config.nix</code>ä½œä¸º<code>nixpkgs.config</code>å‚æ•°ã€‚
å¦‚æœä½ å¯¹<code>nixpkgs</code>çš„åˆå§‹åŒ–æ„Ÿå…´è¶£ï¼Œå¯ä»¥å»çœ‹çœ‹è¿™éƒ¨åˆ†çš„æºä»£ç <code>&lt;nixpkgs&gt;/pkgs/top-level/impure.nix</code>ã€‚</p>
<p><code>config.nix</code>æ–‡ä»¶ï¼ˆå³<code>nixpkgs.config</code>ï¼‰æ¥å—çš„å‚æ•°å¯ä»¥å‚è€ƒnixpkgsçš„å®˜æ–¹æ–‡æ¡£çš„
<a href="https://nixos.org/manual/nixpkgs/stable/#sec-config-options-reference">config Options Reference</a>ç« èŠ‚ï¼Œ
æˆ–æ˜¯å»çœ‹nixpkgsè¿™éƒ¨åˆ†çš„æºç <code>&lt;nixpkgs&gt;/pkgs/top-level/config.nix</code>ã€‚</p>
<p>ä¸‹é¢æ˜¯æ·»åŠ äº†æ³¨è§£çš„æˆ‘çš„<code>config.nix</code>ï¼š</p>
<pre><code class="language-nix">{
</code></pre>
<p>ç¦ç”¨å®‰è£…éæœ¬åœ°çš„åŒ…ï¼Œæ¯”å¦‚ç¦æ­¢x86_64-linuxçš„åŒ…è¢«å®‰è£…åˆ°aarch64-linuxä¸Šã€‚</p>
<pre><code class="language-nix">  allowUnsupportedSystem = false;
  allowUnfree = true;
  packageOverrides = pkgs: rec {
    # packages pinned by npins
    npinsed = import ./npins;
</code></pre>
<p>æ·»åŠ nix user repository (NUR)åˆ°nixpkgsé‡Œã€‚</p>
<pre><code class="language-nix">    nur = import npinsed.nur { pkgs = pkgsu; };
</code></pre>
<p>æ·»åŠ éç¨³å®šç‰ˆçš„nixpkgsåˆ°nixpkgsé‡Œï¼Œ
æ¯”å¦‚éç¨³å®šç‰ˆçš„helloå¯ä»¥é€šè¿‡<code>pkgs.pkgsu.hello</code>æ¥è®¿é—®ã€‚</p>
<pre><code class="language-nix">    pkgsu = import npinsed.pkgsu {};
</code></pre>
<p>æ·»åŠ flake-compatï¼Œç”¨äºåœ¨nix expressionä¸­ä½¿ç”¨flakeçš„åŒ…</p>
<pre><code class="language-nix">    flake-compat = import npinsed.flake-compat;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="todo-nixnixconf"><a class="header" href="#todo-nixnixconf">TODO: nix/nix.conf</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="optnix"><a class="header" href="#optnix">opt.nix</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="systemnix"><a class="header" href="#systemnix">system.nix</a></h1>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  system.activationScripts.ssh_config = let
    # nix-daemon's ssh cannot find nc,
    # so I replace nc with absolute path.
    # The absolute path is recommended way in ssh ProxyCommand,
    # see `man ssh_config`
    ssh_config = pkgs.runCommand "ssh_config" {} ''
      sed 's,\&lt;nc\&gt;,${pkgs.libressl.nc}/bin/nc,g' ${/home/xieby1/Gist/Config/ssh.conf} &gt; $out
    '';
  in ''
    ln -sfn ${ssh_config} /root/.ssh/config
    for user_id_pub in /home/xieby1/Gist/Vault/id_*.pub; do
        user_id=''${user_id_pub%.pub}
        root_id_pub=/root/.ssh/''${user_id_pub##*/}
        root_id=''${root_id_pub%.pub}
      if [[ ! -e $root_id_pub ]]; then
        cp $user_id_pub $root_id_pub
        cp $user_id     $root_id
        chmod 600 $root_id
      fi
    done
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="syscli"><a class="header" href="#syscli">sys/cli</a></h1>
<p>æœ¬æ–‡ä»¶æ˜¯NixOSçš„CLIé…ç½®ã€‚
ä¸»è¦åŒ…å«ä¸¤éƒ¨åˆ†å†…å®¹ï¼š</p>
<ul>
<li>ç³»ç»Ÿç¯å¢ƒç®¡ç†ï¼ˆrootçš„ç¯å¢ƒï¼‰</li>
<li>ç³»ç»Ÿé…ç½®</li>
</ul>
<pre><code class="language-nix">{ config, pkgs, ... }:

{
</code></pre>
<h2 id="ç³»ç»Ÿç¯å¢ƒç®¡ç†rootçš„ç¯å¢ƒ"><a class="header" href="#ç³»ç»Ÿç¯å¢ƒç®¡ç†rootçš„ç¯å¢ƒ">ç³»ç»Ÿç¯å¢ƒç®¡ç†ï¼ˆrootçš„ç¯å¢ƒï¼‰</a></h2>
<pre><code class="language-nix">  imports = [
    ./build-machines.nix
  ];

  # List packages installed in system profile. To search, run:
  # $ nix search wget
  environment.systemPackages = with pkgs; [
    git
    file
    wget
    fzf
    perf
  ];

  # neovim
  programs.neovim.enable = true;
  programs.neovim.defaultEditor = true;
  programs.neovim.viAlias = true;
  programs.neovim.vimAlias = true;

  # ssh
  services.openssh = {
    enable = true;
    settings = {
      X11Forwarding = true;
      PasswordAuthentication = false;
    };
  };

</code></pre>
<h2 id="ç³»ç»Ÿé…ç½®"><a class="header" href="#ç³»ç»Ÿé…ç½®">ç³»ç»Ÿé…ç½®</a></h2>
<p>å¯ç”¨NTFSæ–‡ä»¶ç³»ç»Ÿçš„æ”¯æŒã€‚
å¦‚æ­¤å°±å¯ä»¥åœ¨NixOS/WindowsåŒç³»ç»Ÿçš„ç”µè„‘ä¸ŠæŒ‚åœ¨Windowsçš„åˆ†åŒºå•¦ã€‚</p>
<pre><code class="language-nix">  boot.supportedFilesystems = [ "ntfs" ];

</code></pre>
<p>å¯ç”¨podmanã€‚
podmanæ˜¯ä¸€ä¸ªååˆ†å¥½ç”¨çš„dockerå®ç°ã€‚
æ”¯æŒç”¨æˆ·æ€å®¹å™¨ï¼ˆä¸éœ€è¦sudoï¼‰ï¼Œå¯ä»¥æ–¹ä¾¿åœ°æŒ‚åœ¨å®¹å™¨é•œåƒçš„æ–‡ä»¶ç³»ç»Ÿã€‚</p>
<pre><code class="language-nix">  virtualisation.podman.enable = true;

</code></pre>
<p>é…ç½®binfmtï¼Œè®©éæœ¬åœ°æŒ‡ä»¤é›†çš„ç”¨æˆ·ç¨‹åºå¯ä»¥æ­£å¸¸è¿è¡Œã€‚
æ¯”å¦‚åœ¨x86_64-linuxä¸Šè¿è¡Œaarch64-linuxçš„ç”¨æˆ·ç¨‹åºã€‚
æ³¨æ„ï¼šä¸èƒ½åœ¨é…å’Œæœ¬åœ°ä¸€æ ·çš„binfmtï¼Œæ¯”å¦‚ä¸èƒ½åœ¨x86_64-linuxçš„æœºå™¨ä¸Šé…ç½®x86_64-linuxçš„binfmtã€‚
ä¸ç„¶ä¼šå‡ºç°å¥‡æ€ªçš„åµŒå¥—ï¼Ÿä½ æ‰§è¡Œä»»ä½•ä¸€æ¡å‘½ä»¤ï¼ˆx86_64-linuxï¼‰éƒ½éœ€è¦å»è°ƒç”¨qemu-x86_64ï¼Œ
ä½†qemu-x86_64æœ¬äº‹ä¹Ÿæ˜¯x86_64-linuxçš„ï¼Œæ‰€ä»¥ä¼šæ­»å¾ªç¯ï¼Ÿ
æˆ‘åšäº†ä¸ªå®éªŒï¼šåœ¨x86_64-linuxçš„NixOSä¸­å¯ç”¨x86_64-linuxçš„binfmtã€‚
ä»»ä½•ç¨‹åºéƒ½æ‰§è¡Œä¸äº†äº†ï¼Œè¿å…³æœºéƒ½ä¸è¡Œï¼Œåªèƒ½å¼ºåˆ¶é‡å¯ã€‚
ä¸è¿‡å¥½åœ¨NixOSå¯ä»¥å›æ»šï¼Œè½»æ¾å¤åŸå®éªŒå‰çš„ç¯å¢ƒã€‚
ä¸‹é¢çš„<code>filterAttrs</code>å°±æ˜¯ç”¨æ¥ä¿è¯ä¸é…ç½®æœ¬åœ°çš„binfmtã€‚</p>
<pre><code class="language-nix">  boot.binfmt.registrations = pkgs.lib.filterAttrs (n: v: n!=builtins.currentSystem) {
    x86_64-linux = {
      interpreter = "${pkgs.pkgsStatic.qemu-user}/bin/qemu-x86_64";
      magicOrExtension = ''\x7fELF\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\x3e\x00'';
      mask = ''\xff\xff\xff\xff\xff\xfe\xfe\x00\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff'';
      wrapInterpreterInShell = false;
    };
    aarch64-linux = {
      interpreter = "${pkgs.pkgsStatic.qemu-user}/bin/qemu-aarch64";
      magicOrExtension = ''\x7fELF\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\xb7\x00'';
      mask = ''\xff\xff\xff\xff\xff\xff\xff\x00\xff\xff\xff\xff\xff\xff\x00\xff\xfe\xff\xff\xff'';
      wrapInterpreterInShell = false;
    };
    riscv64-linux = {
      interpreter = "${pkgs.pkgsStatic.qemu-user}/bin/qemu-riscv64";
      magicOrExtension = ''\x7fELF\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\xf3\x00'';
      mask = ''\xff\xff\xff\xff\xff\xff\xff\x00\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff'';
      wrapInterpreterInShell = false;
    };
  };

</code></pre>
<p>å¯ç”¨docdevã€‚
åœ¨home-managerä¸­è£…devdocä¼¼ä¹æœ‰é—®é¢˜ï¼Œå¾—åœ¨NixOSä¸­è£…æ‰è¡Œã€‚
ä¹‹åæœ‰ç©ºå†æ¥è¯¦ç»†ç ”ç©¶ã€‚</p>
<pre><code class="language-nix">  # Make sure devdoc outputs are installed.
  documentation.dev.enable = true;
  # Make sure legacy path is installed as well.
  environment.pathsToLink = [ "/share/gtk-doc" ];

</code></pre>
<p>å¯ç”¨ADBï¼Œå®‰å“æäº‹æƒ…å¿…å¤‡ã€‚</p>
<pre><code class="language-nix">  programs.adb.enable = true;
  users.users.xieby1.extraGroups = ["adbusers"];

  nix.settings.trusted-users = ["root" "xieby1"];

  zramSwap.enable = true;

  boot.kernelPackages = pkgs.linuxPackages_xanmod;

  networking.firewall.enable = false;

  # The following are mkDefault when desktopManager.gnome.enable is true
  networking.networkmanager.enable = true;
  hardware.bluetooth.enable = true;
  services.upower.enable = true;
  # TODO: remove, currently home-manager switch needs
  programs.dconf.enable = true;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sysdefaultnix"><a class="header" href="#sysdefaultnix">sys/default.nix</a></h1>
<p>æœ¬æ–‡ä»¶å­˜æ”¾å–†æˆ‘çš„NixOSçš„é…ç½®ã€‚
NixOSçš„é…ç½®é€šè¿‡å‘½ä»¤<code>sudo nixos-rebuild switch</code>ç”Ÿæ•ˆã€‚
å› ä¸ºNixOSçš„é…ç½®å…¥å£æ˜¯<code>/etc/nixos/configuration.nix</code>ï¼Œ
æ‰€ä»¥éœ€è¦åœ¨<code>/etc/nixos/configuration.nix</code>ä¸­importæœ¬æ–‡ä»¶ï¼Œä¾‹å¦‚</p>
<pre><code class="language-nix"># /etc/nixos/configuration.nix:
{ config, pkgs, ... }: {
  imports = [
    ./hardware-configuration.nix
    # import my sys/ here!
    /home/xieby1/.config/nixpkgs/sys
  ];
  # other configs ...
}
</code></pre>
<p>NixOSé…ç½®å¯ä»¥ä½¿ç”¨çš„å‚æ•°å¯å‚è€ƒconfiguration.nixçš„manpageï¼Œå³<code>man configuration.nix</code>ã€‚
ä¸‹é¢æ˜¯æˆ‘çš„NixOSçš„é…ç½®æºç åŠæ³¨è§£ï¼š</p>
<pre><code class="language-nix"># add this file to /etc/nixos/configuration.nix: imports
{ config, pkgs, ... }:

{
</code></pre>
<p>è®©NixOSçš„nixpkgsä½¿ç”¨å’Œhome-managerçš„nixpkgsé‡‡ç”¨ç›¸åŒçš„nixpkgs config</p>
<pre><code class="language-nix">  nixpkgs.config = import ../config.nix;

</code></pre>
<p>å¯¼å…¥æˆ‘çš„NixOSçš„CLIå’ŒGUIé…ç½®ï¼Œ
è¯¦ç»†å†…å®¹è§æ–‡æ¡£<a href="sys/./cli/default.nix.html">./cli</a>å’Œ<a href="sys/./gui/default.nix.html">./gui</a>ã€‚</p>
<pre><code class="language-nix">  imports = [
    ./modules
    ./cli
    ./gui
  ];

</code></pre>
<p>Nix binary cacheçš„åœ°å€ã€‚
è¶Šé å‰ä¼˜å…ˆçº§è¶Šé«˜ã€‚
ç”±äºcache.nixos.orgéœ€è¦æ¢¯å­ï¼Œ
è¿™é‡Œä½¿ç”¨äº†æ¸…åTunaæä¾›çš„Nix binary cacheé•œåƒæ¥åŠ é€Ÿã€‚</p>
<pre><code class="language-nix">  nix.settings.substituters = [
    # TODO: tuna
    "https://cache.nixos.org/"
    "https://xieby1.cachix.org"
  ];

  nix.channel.enable = false;
  # Preserve NIX_PATH for root and wheel
  # https://superuser.com/questions/232231/how-do-i-make-sudo-preserve-my-environment-variables
  security.sudo.extraConfig = ''
    Defaults:root,%wheel env_keep+=NIX_PATH
  '';

</code></pre>
<p>è®¾ç½®æ—¶åŒºã€‚</p>
<pre><code class="language-nix">  time.timeZone = "Asia/Shanghai";
  time.hardwareClockInLocalTime = true;

</code></pre>
<p>è®¾ç½®Linuxè´¦æˆ·ä¿¡æ¯ã€‚</p>
<pre><code class="language-nix">  users.mutableUsers = false;
</code></pre>
<p>å½“ç„¶GitHubä¸Šå½“ç„¶ä¸èƒ½æ˜æ–‡å­˜å‚¨å¯†ç ï¼Œè¿™é‡Œä½¿ç”¨hashè¿‡çš„å¯†ç ã€‚
å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·<code>mkpasswd</code>æ¥ç”Ÿæˆhashè¿‡çš„å¯†ç ã€‚
ç»™<code>root</code>ç”¨æˆ·è®¾ç½®hashè¿‡çš„å¯†ç ã€‚</p>
<pre><code class="language-nix">  users.users.root.hashedPassword = "$6$wRBpbr4zSTA/nh$XI/KUASw3mELIqyAxN1hUTWizz9ZBzPhP2u4HNDCA49h4KOWkZsyuiextyXkUti7jYsUHE9fTiRjGAoxBg0Gq/";
  users.users.xieby1 = {
    isNormalUser = true;
    createHome = true;
</code></pre>
<p>åŒä¸Šï¼Œç»™<code>xieby1</code>ç”¨æˆ·è®¾ç½®hashè¿‡çš„å¯†ç ã€‚</p>
<pre><code class="language-nix">    hashedPassword = "$6$Y4KJxhdaJTT$RSolbCpaUKK2UW1cdnuH.8n1Ky9p0Lnx0MP36BxGX9Q2AeVMjCp.bZOsZ11w689je/785TFRQoVgicMiOfA9B.";
</code></pre>
<p>ç»™ç”¨æˆ·<code>xieby1</code>å¯ç”¨sudoã€‚</p>
<pre><code class="language-nix">    extraGroups = [ "wheel" ];
</code></pre>
<p>sshæˆæƒçš„å…¬é’¥ã€‚è¿™æ ·è®¾ç½®åï¼Œæˆ‘çš„æ‰€æœ‰çš„NixOSéƒ½ç›¸å½“äºâ€œè‡ªåŠ¨æˆæƒâ€äº†ã€‚
æˆ‘çš„<code>/home/xieby1/Gist/</code>æ–‡ä»¶å¤¹å­˜æ”¾ç€ä¸€äº›ä¸æ–¹ä¾¿æ”¾å…¥Gitä»“åº“çš„æ–‡ä»¶ï¼Œæ¯”å¦‚äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæˆ–æ˜¯éšç§æ–‡ä»¶ã€‚
è¯¥æ–‡ä»¶ç”±<a href="https://github.com/syncthing/syncthing">syncthing</a>è¿›è¡Œå¤šè®¾å¤‡åŒæ­¥ã€‚
ç®€å•çš„è¯´ï¼Œæˆ‘çš„å¤‡ä»½ç†å¿µæ˜¯â€œgitå¤‡ä»½é…ç½®ï¼Œsyncthingå¤‡ä»½æ•°æ®â€ã€‚
â€œé…ç½®â€å³æŒ‡è¿™ä¸ª<a href="https://github.com/xieby1/nix_config">nix_configä»“åº“</a>ï¼Œâ€œæ•°æ®â€æŒ‡<code>~/Gist/</code>ã€<code>~/Documents/</code>ç­‰æ–‡ä»¶å¤¹ã€‚
æœ‰äº†è¿™äº›å¤‡ä»½å°±èƒ½è½»æ¾è¿˜åŸ/å¤ç°æˆ‘çš„æ•´ä¸ªå·¥ä½œç¯å¢ƒã€‚
TODOï¼šå•ç‹¬ä¸“é—¨ä»‹ç»æˆ‘çš„å¤‡ä»½ç†å¿µã€‚</p>
<pre><code class="language-nix">    openssh.authorizedKeys.keyFiles = [] ++ (
      if builtins.pathExists /home/xieby1/Gist/Vault/y50_70.pub
      then [/home/xieby1/Gist/Vault/y50_70.pub]
      else []
    ) ++ (
      if builtins.pathExists /home/xieby1/Gist/Vault/yoga14s.pub
      then [/home/xieby1/Gist/Vault/yoga14s.pub]
      else []
    );
  };

</code></pre>
<p>è®©TTYè‡ªåŠ¨ç™»å½•æˆ‘çš„è´¦æˆ·ï¼Œè¿™æ ·å°±å¯ä»¥è‡ªåŠ¨å¯åŠ¨ç”¨æˆ·çº§ï¼ˆuserï¼‰çš„systemdæœåŠ¡äº†ã€‚
è¿™æ ·å°±å¯ä»¥åœ¨<span style="color:teal"><strong>éNixOS</strong></span>ä¸­ï¼ˆæ¯”å¦‚UbuntuæœåŠ¡å™¨ã€WSL2ã€Debianæ ‘è“æ´¾ç­‰ï¼‰
è‡ªåŠ¨æ‹‰èµ·systemd<span style="color:teal"><strong>ç”¨æˆ·</strong></span>æœåŠ¡ï¼ˆæ¯”å¦‚syncthingã€clashã€tailscaleç­‰ï¼‰ã€‚</p>
<pre><code class="language-nix">  services.getty = {
    autologinUser = "xieby1";
    autologinOnce = true;
  };
</code></pre>
<p>æœ‰å…³systemdç”¨æˆ·æœåŠ¡çš„é…ç½®ï¼Œè¯¦ç»†å¯è§å‚è€ƒï¼š</p>
<ul>
<li>home-manageré…ç½®çš„manpageçš„servicesè¯æ¡ï¼Œ
æ¯”å¦‚<code>man home-configuration.nix</code>æœç´¢<code>services.syncthing</code></li>
<li>æˆ‘çš„syncthingé…ç½®<a href="sys/./usr/cli/default.nix.html#syncthing">./usr/cli: syncthing</a></li>
<li>æˆ‘çš„clashé…ç½®<a href="sys/./usr/cli/clash.nix.html">./usr/cli/clash.nix</a></li>
<li>æˆ‘çš„tailscaleé…ç½®<a href="sys/./usr/cli/tailscale.nix.html">./usr/cli/tailscale.nix</a></li>
</ul>
<pre><code class="language-nix">}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  imports = [
    # Bug: authentication error, thus, current use greetd
    # ./dms
  ];
  # Enable the X11 windowing system.
  services.xserver.enable = true;
  services.xserver.videoDrivers = [
    # "nvidia"
    # default video drivers
    "radeon" "nouveau" "modesetting" "fbdev"
    "modesetting" "amdgpu"
  ];

  # Cosmic
  # * Cons
  #   * bluetooth cannot disable auto connect,
  #     and no one discussed in comsic-applets/comsic-epoch github issues
  #   * dont have enough key binding settings
  #     * E.g. left/right half screen?
  # services.desktopManager.cosmic.enable = true;
  # services.displayManager.cosmic-greeter.enable = true;
  # services.desktopManager.gnome.enable = true;
  # services.displayManager.gdm.enable = true;
  services.greetd = {
    enable = true;
    settings = {
      default_session = {
        command = toString [
          "${pkgs.tuigreet}/bin/tuigreet"
          "--time" "--asterisks" "--remember"
          "--cmd niri-session"
        ];
      };
    };
  };

  # https://discourse.nixos.org/t/how-to-create-folder-in-var-lib-with-nix/15647
  system.activationScripts.user_account_conf = pkgs.lib.stringAfter [ "var" ] (let
    face = pkgs.fetchurl {
      url = "https://github.com/xieby1.png";
      sha256 = "1s20qy3205ljp29lk0wqs6aw5z67db3c0lvnp0p7v1q2bz97s9bm";
    };
  in ''
    mkdir -p /var/lib/AccountsService/users
    if [[ ! -f /var/lib/AccountsService/users/xieby1 ]]; then
    cat &gt; /var/lib/AccountsService/users/xieby1 &lt;&lt;XIEBY1_ACCOUNT
    [User]
    Session=
    Icon=/var/lib/AccountsService/icons/xieby1
    SystemAccount=false
    XIEBY1_ACCOUNT
    fi
    mkdir -p /var/lib/AccountsService/icons
    ln -sf ${face} /var/lib/AccountsService/icons/xieby1
  '');

  # Configure keymap in X11
  # services.xserver.layout = "us";
  # services.xserver.xkbOptions = "eurosign:e";

  # Enable CUPS to print documents.
  # https://nixos.wiki/wiki/Printing
  services.printing.enable = true;
  services.printing.drivers = [pkgs.hplip];
  services.avahi.enable = true;
  services.avahi.nssmdns4 = true;

  # Enable touchpad support (enabled default in most desktopManager).
  services.libinput.enable = true;

  nixpkgs.config.allowUnfree = true;

  # vim vista need nerd fonts
  # https://github.com/liuchengxu/vista.vim/issues/74
  # https://github.com/liuchengxu/space-vim/wiki/tips#programming-fonts
  # available nerd fonts: nixpkgs/pkgs/data/fonts/nerdfonts/shas.nix
  ## use non-variable noto font for feishu and other old electron apps
  ## for more details see: https://github.com/NixOS/nixpkgs/issues/171976
  fonts.packages = with pkgs; [
    noto-fonts-cjk-sans
    noto-fonts-cjk-serif
    noto-fonts-color-emoji
    noto-fonts
    # The best developer fonts, see https://www.nerdfonts.com/
    nerd-fonts.hack
    nerd-fonts.meslo-lg
    nerd-fonts.sauce-code-pro
    nerd-fonts.fira-code
    nerd-fonts.terminess-ttf
    nerd-fonts.iosevka
    nerd-fonts.monoid
    nerd-fonts.fantasque-sans-mono
  ];
  # enable fontDir /run/current-system/sw/share/X11/fonts
  fonts.fontDir.enable = true;
  fonts.fontconfig.defaultFonts = {
    monospace = [
      "DejaVu Sans Mono"
      "Noto Color Emoji"
      "Noto Emoji"
    ];
  };

  services.gpm.enable = true;

  hardware.xone.enable = true;

  # for x11 gesture
  services.touchegg.enable = true;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ ... }: let
  pkgs = import &lt;nixpkgs&gt; {};
  # TODO: nixos-rebuild re-use config.nix?
  flake-compat = import (builtins.fetchTarball {
    url = "https://github.com/edolstra/flake-compat/archive/0f9255e01c2351cc7d116c072cb317785dd33b33.tar.gz";
    sha256 = "0m9grvfsbwmvgwaxvdzv6cmyvjnlww004gfxjvcl806ndqaxzy4j";
  });
in {
  imports = [
    (let
      flake-dms = flake-compat {
        src = pkgs.fetchFromGitHub {
          owner = "AvengeMedia";
          repo = "DankMaterialShell";
          rev = "v1.2.3";
          hash = "sha256-P//moH3z9r4PXirTzXVsccQINsK5AIlF9RWOBwK3vLc=";
        };
      };
    in flake-dms.defaultNix.nixosModules.greeter)
  ];
  programs.dank-material-shell.greeter = {
    enable = true;
    compositor.name = "niri";
    configHome = "/home/xieby1";
    configFiles = ["/home/xieby1/.config/DankMaterialShell/settings.json"];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="why-moving-away-from-gnome"><a class="header" href="#why-moving-away-from-gnome">Why moving away from GNOME?</a></h1>
<ul>
<li><strong>Incompatibility issues</strong>: Updates frequently break extensions and addons.</li>
<li><strong>Conservative approach</strong>: GNOME doesn't support the layer_shell protocol, which is required by applications like rofi.
<ul>
<li>https://gitlab.gnome.org/GNOME/mutter/-/issues/973</li>
<li>Other protocols may also be unsupported.</li>
</ul>
</li>
<li><strong>JavaScript-based extensions with memory leaks</strong>:
The extension system appears to have memory leaks that consume significant memory. I often need to use <code>alt-f2 r</code> to reclaim some memory.</li>
<li><strong>Wayland limitations exacerbated by GNOME</strong>:
<ul>
<li>After transitioning from X11 to Wayland, several important desktop features stopped working,
such as using xdotool to move specific windows to specific workspaces.</li>
<li>While these limitations originate from Wayland itself, many window managers provide alternative solutions.
However, GNOME makes it particularly difficult to implement such workarounds.
Creating custom GNOME extensions is possible, but the learning curve is steep and the API lacks stability.</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, lib, ...}: {
  config = lib.mkIf (
    (builtins.pathExists config.cachix_dhall) &amp;&amp;
    (config.cachix_packages != [])
  ) {
    system.activationScripts = {
      cachix_push = config._cachix_push;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ ... }: {
  imports = [
    ../../modules
    ./cachix.nix
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="currently-not-wayland-but-x11"><a class="header" href="#currently-not-wayland-but-x11">Currently, Not Wayland, But X11</a></h1>
<p>Here list wayland problems I have met.</p>
<h2 id="warpd-not-work"><a class="header" href="#warpd-not-work">warpd not work</a></h2>
<h2 id="fcitx-input-method-not-work"><a class="header" href="#fcitx-input-method-not-work">fcitx input method not work</a></h2>
<h2 id="waydroid"><a class="header" href="#waydroid">waydroid</a></h2>
<p>waydroid tile not work</p>
<h2 id="tabbed-not-work"><a class="header" href="#tabbed-not-work">tabbed not work</a></h2>
<h2 id="gnome-terminal-headerbar-cannot-be-hidden"><a class="header" href="#gnome-terminal-headerbar-cannot-be-hidden">gnome terminal headerbar cannot be hidden</a></h2>
<p>Both gnome extension unite and gtk-title-bar
cannot hide gnome terminal(kitty and alacritty)'s headerbar.</p>
<ul>
<li>https://github.com/velitasali/gtktitlebar/issues/25</li>
<li>https://github.com/velitasali/gtktitlebar/issues/14</li>
</ul>
<h2 id="autokey-and-espanso-not-work-in-wayland"><a class="header" href="#autokey-and-espanso-not-work-in-wayland">autokey and espanso not work in wayland</a></h2>
<p>Autokey only works in X11,
while espanso officially disclaim it support wayland.
But my wayland experience is, espanso does not work either.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="homenix"><a class="header" href="#homenix">home.nix</a></h1>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }: {
  imports = [{
    home.packages = [
      pkgs.clash-meta
    ];
    systemd.user.services.clash = {
      Unit = {
        Description = "Auto start clash";
        After = ["network.target"];
      };
      Install = {
        WantedBy = ["default.target"];
      };
      Service = {
        ExecStart = "${pkgs.clash-meta.outPath}/bin/clash-meta -d ${config.home.homeDirectory}/Gist/clash";
      };
    };
    programs.bash.bashrcExtra = lib.mkBefore (lib.optionalString (!config.isNixOnDroid) ''
      # proxy
      ## default
      HTTP_PROXY="http://127.0.0.1:${toString config.proxyPort}"
      ## microsoft wsl
      # if [[ $(uname -r) == *"microsoft"* ]]; then
      #     hostip=$(cat /etc/resolv.conf | grep nameserver | awk '{ print $2 }')
      #     export HTTP_PROXY="http://$hostip:${toString config.proxyPort}"
      # fi
      export HTTPS_PROXY="$HTTP_PROXY"
      export HTTP_PROXY="$HTTP_PROXY"
      export FTP_PROXY="$HTTP_PROXY"
      export http_proxy="$HTTP_PROXY"
      export https_proxy="$HTTP_PROXY"
      export ftp_proxy="$HTTP_PROXY"
    '');
  }];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = with pkgs; [
    universal-ctags
  ];
  home.file.exclude_ctags = {
    text = ''
      # exclude ccls generated directories
      --exclude=.ccls*
    '';
    target = ".config/ctags/exclude.ctags";
  };
  home.file.scala_ctags = {
    target = ".config/ctags/scala.ctags";
    text = ''
      --langdef=Scala
      --langmap=Scala:.scala
      --regex-Scala=/^[ \t]*class[ \t]*([a-zA-Z0-9_]+)/\1/c,classes/
      --regex-Scala=/^[ \t]*object[ \t]*([a-zA-Z0-9_]+)/\1/o,objects/
      --regex-Scala=/^[ \t]*trait[ \t]*([a-zA-Z0-9_]+)/\1/t,traits/
      --regex-Scala=/^[ \t]*case[ \t]*class[ \t]*([a-zA-Z0-9_]+)/\1/r,cclasses/
      --regex-Scala=/^[ \t]*abstract[ \t]*class[ \t]*([a-zA-Z0-9_]+)/\1/a,aclasses/
      --regex-Scala=/^[ \t]*def[ \t]*([a-zA-Z0-9_=]+)[ \t]*.*[:=]/\1/m,methods/
      --regex-Scala=/[ \t]*val[ \t]*([a-zA-Z0-9_]+)[ \t]*[:=]/\1/V,values/
      --regex-Scala=/[ \t]*var[ \t]*([a-zA-Z0-9_]+)[ \t]*[:=]/\1/v,variables/
      --regex-Scala=/^[ \t]*type[ \t]*([a-zA-Z0-9_]+)[ \t]*[\[&lt;&gt;=]/\1/T,types/
      --regex-Scala=/^[ \t]*import[ \t]*([a-zA-Z0-9_{}., \t=&gt;]+$)/\1/i,includes/
      --regex-Scala=/^[ \t]*package[ \t]*([a-zA-Z0-9_.]+$)/\1/p,packages/
    '';
  };
  programs.neovim = {
    extraConfig = ''
      "" tags support, ';' means upward search, referring to http://vimdoc.sourceforge.net/htmldoc/editing.html#file-searching
      set tags=./tags;
    '';
    plugins = [{
</code></pre>
<h2 id="a-bug-in-neovim-or-lspconfig"><a class="header" href="#a-bug-in-neovim-or-lspconfig">A bug in neovim or lspconfig?</a></h2>
<p>I want to jump to the definition of QEMU's <code>qemu_clock_get_ns</code> using ctags.
More specifically, when I press <code>g]</code> with my cursor under a <code>qemu_clock_get_ns</code> call,
neovim only lists one definition:</p>
<pre><code class="language-vim">  # pri kind tag                file
  1 F   Functionqemu_clock_get_ns /home/xieby1/Codes/qemu/tests/unit/ptimer-test-stubs.c
               \%86l\%9c
Type number and &lt;Enter&gt; (q or empty cancels):
</code></pre>
<p>However, there should be two definitions!
After tweaking a lot, I found out that clangd's lspconfig config directly or indirectly causes this.</p>
<pre><code class="language-lua">vim.lsp.config("clangd", {
  filetypes = { "c", "cc", "cpp", "c++", "objc", "objcpp", "cuda", "proto" }
})
vim.lsp.enable("clangd")
</code></pre>
<p>As long as the filetype of the current buffer is not clangd-related, ctags works correctly.
For example, if I <code>cd &lt;qemu-source-code&gt;</code>, then run <code>vim</code>, and finally <code>:ts qemu_clock_get_ns</code>,
I get the expected result:</p>
<pre><code class="language-vim">  # pri kind tag                file
  1 F   f    qemu_clock_get_ns  tests/unit/ptimer-test-stubs.c
               typeref:typename:int64_t
               int64_t qemu_clock_get_ns(QEMUClockType type)
  2 F   f    qemu_clock_get_ns  util/qemu-timer.c
               typeref:typename:int64_t
               int64_t qemu_clock_get_ns(QEMUClockType type)
Type number and &lt;Enter&gt; (q or empty cancels):
</code></pre>
<p>I searched through neovim's and nvim-lspconfig's github issues but didn't find any related issues.
I also tried searching for the weird string <code>\%.*l\%.*c</code> (%86l%9c) in neovim and lspconfig source code,
but found nothing.</p>
<p>As a result, I've decided to use a wrapper plugin for tags functionality.</p>
<p>nvim-telescope has builtin support tags <code>:lua require'telescope.builtin'.tags{}</code>.
However it is VERY SLOW!
So, I choose to install a plugin: nvim-telescope-ctags-plus.</p>
<pre><code class="language-nix">      plugin = pkgs.vimUtils.buildVimPlugin {
        name = "nvim-telescope-ctags-plus";
        src = pkgs.fetchFromGitHub {
          owner = "gnfisher";
          repo = "nvim-telescope-ctags-plus";
          rev = "455f24c0dcc6126c89cd3a3278e3fe322df061b1";
          hash = "sha256-P9uYkWvY4NzwlAxG40/0sNZoGEHezDhlYL/gKfBI/dA=";
        };
        doCheck = false;
      };
      type = "lua";
      config =''
        require('telescope').load_extension('ctags_plus')

        -- in vimscript:
        -- nnoremap g] &lt;cmd&gt;lua require('telescope').extensions.ctags_plus.jump_to_tag()&lt;cr&gt;
        vim.keymap.set('n', 'g]', function()
          require('telescope').extensions.ctags_plus.jump_to_tag()
        end, { noremap = true, silent = true })
      '';
    }];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  sysconfig = (
    # &lt;...&gt; are expression search in NIX_PATH
    if (builtins.tryEval &lt;nixos-config&gt;).success
    then import &lt;nixpkgs/nixos&gt; {}
    else import &lt;nixpkgs/nixos&gt; {configuration={};}
  ).config;
in
{
  imports = [
    ./extra.nix
    ./vim
    ./tmux.nix
    ./clash.nix
    ./tailscale.nix
    ./gdb.nix
    ./ctags.nix
    ./ssh.nix
    ./git.nix
    ./fzf.nix
    ./tldr.nix
  ] ++ [{ # functions &amp; attrs
    home.packages = [pkgs.nix-index];
    home.file.nix_index_database = {
      source = builtins.fetchurl "https://github.com/Mic92/nix-index-database/releases/latest/download/index-${builtins.currentSystem}";
      target = ".cache/nix-index/files";
    };
  }{
</code></pre>
<h2 id="syncthing"><a class="header" href="#syncthing">Syncthing</a></h2>
<pre><code class="language-nix">    services.syncthing = {
      enable = true;
</code></pre>
<p>è®©syncthingçš„ç«¯å£å¤–éƒ¨å¯è®¿é—®ã€‚</p>
<pre><code class="language-nix">      extraOptions = lib.optional config.isCli "--gui-address=0.0.0.0:8384";
    };
</code></pre>
<p>å¯ç”¨ä»£ç†ï¼Œå› ä¸ºæœ‰äº›syncthingçš„æœåŠ¡å™¨ä¼¼ä¹æ˜¯è¢«å¢™äº†çš„ã€‚</p>
<pre><code class="language-nix">    systemd.user.services.syncthing.Service.Environment = [
      # https://docs.syncthing.net/users/proxying.html
      "http_proxy=http://127.0.0.1:${toString config.proxyPort}"
    ];
</code></pre>
<p>ä½¿ç”¨å‘½ä»¤è¡Œæµè§ˆå™¨browshæ¥å®ç°syncthing-tuiã€‚</p>
<pre><code class="language-nix">    home.packages = lib.optional (!config.isMinimalConfig) (
      pkgs.writeShellScriptBin "syncthing-tui" ''
        ${pkgs.browsh}/bin/browsh --firefox.path ${pkgs.firefox}/bin/firefox http://127.0.0.1:8384
      ''
    );
  }{
    home.packages = with pkgs; [
      cachix
    ];
    home.file.cachix_dhall = {
      source = if (builtins.pathExists ~/Gist/Config/cachix.dhall)
        then ~/Gist/Config/cachix.dhall
        else builtins.toFile "empty-cachix.dhall" "";
      target = ".config/cachix/cachix.dhall";
    };
  }{
    home.packages = [
      pkgs.pkgsu.claude-code
    ];
    systemd.user.tmpfiles.rules = [
      "L? %h/.claude/settings.json - - - - %h/Gist/Config/claude.settings.json"
    ];
  }];

  home.packages = with pkgs; [
    # tools
    parallel
    comma
    xclip
    python3Packages.qrcode
    ## archive
    unar
    ## manage
    htop
    nix-tree
    ## text
    pandoc
    ## compile
    gnumake
    makefile2graph
    remake
    ## draw
    graphviz
    figlet
    nyancat
    d2
    ## file system
    file
    # magika # detect file content types with deep learning
    tree
    ## network
    wget
    axel
    bind.dnsutils # nslookup
    netcat
    nload
    nmap
    nethogs
    nodePackages.browser-sync
    ## x11
    xdotool

    # programming
    inotify-tools
    clang-tools
    cmake
    capstone
    scc
    ## https://stackoverflow.com/questions/40165650/how-to-list-all-files-tracked-by-git-excluding-submodules
    (writeShellScriptBin "scc-git" "${scc}/bin/scc $(git grep --cached -l '')")
    flamegraph
    ## python
    ( python3.withPackages ( p: with p; [
      ipython
      pydot
      networkx
    ]))
    ## c
    (lib.setPrio # make bintools less prior
      (bintools-unwrapped.meta.priority + 1)
      bintools-unwrapped
    )
    (if builtins.currentSystem == "x86_64-linux"
      then gcc_multi
      else gcc
    )
    ### docs
    stdmanpages
    man-pages
    #gccStdenv
    bear
    ## xml
    libxml2
    ## bash
    bc
    ## nix
    nixos-option
    nix-output-monitor
    ### allow non-nixos access `man configuration.nix`
    # see: nixos/modules/misc/documentation.nix
    #        nixos/doc/manual/default.nix
    sysconfig.system.build.manual.nixos-configuration-reference-manpage
    nurl
    pkgsu.npins
  ];

  programs.eza.enable = true;

  # bash
  programs.bash.enable = true;
  programs.bash.bashrcExtra = ''
    # rewrite prompt format
    u_green="\[\033[01;32m\]"
    u_blue="\[\033[01;34m\]"
    u_white="\[\033[00m\]"
    PS1="''${debian_chroot:+($debian_chroot)}"
    if [[ $HOSTNAME =~ qemu.* ]]; then
        PS1+="(qemu)"
    fi
    if [[ -n "$IN_NIX_SHELL" ]]; then
        PS1+="(''${name}.$IN_NIX_SHELL)"
    fi
    PS1+="''${u_green}\u${lib.optionalString (!config.isNixOnDroid) "@\\h"}''${u_white}:"
    PS1+="''${u_blue}\w''${u_white}"
    PS1+="\n''${u_green}\$''${u_white} "
    unset u_green u_blue u_white
    ## change title
    ### https://unix.stackexchange.com/questions/177572/
    PS1+="\[\e]2;\w\a\]"

    # nixos obsidian
    export NIXPKGS_ALLOW_INSECURE=1

    # source my bashrc
    if [[ -f ~/Gist/Config/bashrc ]]; then
        source ~/Gist/Config/bashrc
    fi

    # user nix config setting
    export NIX_USER_CONF_FILES=~/.config/nixpkgs/nix/nix.conf
    if [[ -e ~/.nix-profile/etc/profile.d/nix.sh ]]; then
        source ~/.nix-profile/etc/profile.d/nix.sh
    fi

    # bash-completion, inspired by
    ##  https://discourse.nixos.org/t/whats-the-nix-way-of-bash-completion-for-packages/20209/16
    # system tools completion, e.g. nix
    XDG_DATA_DIRS+=":${sysconfig.system.path}/share"
    # home tools completion
    XDG_DATA_DIRS+=":${config.home.path}/share"
    export XDG_DATA_DIRS
    . ${pkgs.bash-completion}/etc/profile.d/bash_completion.sh

    # è§£å†³tmuxåœ¨nix-on-droidä¸Šä¸æ˜¾ç¤ºemojiå’Œä¸­æ–‡çš„é—®é¢˜
    export LANG=C.UTF-8

    if [[ -n $(command -v eza) ]]; then
        alias ls=eza
    fi
  '' + lib.optionalString config.isWSL2 ''
    # use the working directory of the current tab as the starting directory for a new tab
    # https://learn.microsoft.com/en-us/windows/terminal/tutorials/new-tab-same-directory#using-actions-to-duplicate-the-path
    PROMPT_COMMAND=''${PROMPT_COMMAND:+"$PROMPT_COMMAND"}'printf "\e]9;9;%s\e\\" "$(wslpath -w "$PWD")"'
  '';

  programs.direnv.enable = true;
  programs.direnv.nix-direnv.enable = true;

  programs.ripgrep = {
    enable = true;
    arguments = [
      "--no-ignore-vcs"
    ];
  };

  programs.command-not-found = {
    enable = true;
    dbPath = "${pkgs.npinsed.nixpkgs.outPath}/programs.sqlite";
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cli-extranix-extra-cli-configs-added-to-minimal-cli-config"><a class="header" href="#cli-extranix-extra-cli-configs-added-to-minimal-cli-config">cli-extra.nix: Extra CLI configs (added to minimal cli config)</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }: {
  imports = [{
    home.packages = [
      pkgs.act
      (pkgs.writeShellScriptBin "act-podman" ''
        export DOCKER_HOST=unix://$XDG_RUNTIME_DIR/podman/podman.sock
        CMD=(
          "${pkgs.act}/bin/act"
          "--bind"

          # use podman
          "--container-daemon-socket" "unix://$XDG_RUNTIME_DIR/podman/podman.sock"

          # use host proxy
          "--container-options" "--network=host"
          "--env" "HTTPS_PROXY='http://127.0.0.1:${toString config.proxyPort}'"
          "--env" "HTTP_PROXY='http://127.0.0.1:${toString config.proxyPort}'"
          "--env" "FTP_PROXY='http://127.0.0.1:${toString config.proxyPort}'"
          "--env" "https_proxy='http://127.0.0.1:${toString config.proxyPort}'"
          "--env" "http_proxy='http://127.0.0.1:${toString config.proxyPort}'"
          "--env" "ftp_proxy='http://127.0.0.1:${toString config.proxyPort}'"

          "$@"
        )
        eval "''${CMD[@]}"
      '')
    ];
  }];

config = lib.mkIf (!config.isMinimalConfig) {
  home.packages = with pkgs; [
    # tools
    imagemagick

    # programming
    ## c
    cling # c/cpp repl
    ## javascript
    nodePackages.typescript
    ### node
    nodejs
    ## java
    openjdk

    ### pdfcrop
    (texlive.combine {inherit (pkgs.texlive) scheme-minimal pdfcrop;})
    # runXonY
    qemu
  ] ++ lib.optional (builtins.currentSystem == "x86_64-linux") quickemu;
};
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: let
  go-there = pkgs.writeScriptBin "go-there" /*bash*/ ''
    dir=$(dirname "$1")
    cd "$dir" || exit
    bash -i
  '';
  fzf-doc = pkgs.writeScriptBin "fzf-doc" /*bash*/ ''
    allCmds() {
      # bash alias
      compgen -A alias

      # external commands
      # https://unix.stackexchange.com/questions/94775/list-all-commands-that-a-shell-knows
      case "$PATH" in
        (*[!:]:) PATH="$PATH:" ;;
      esac
      set -f
      IFS_OLD="$IFS"
      IFS=:
      for dir in $PATH; do
        set +f
        [ -z "$dir" ] &amp;&amp; dir="."
        for file in "$dir"/*; do
          if [ -x "$file" ] &amp;&amp; ! [ -d "$file" ]; then
            echo "''${file##*/}"
          fi
        done
      done
      IFS="$IFS_OLD"
    }

    cd ~/Documents
    FILE=$(fzf)
    [ -z "$FILE" ] &amp;&amp; exit
    cd $(dirname "$FILE")
    FILE=$(basename "$FILE")

    # move o and go-there to top
    { echo o; echo go-there; allCmds | grep -vw o | grep -vw go-there; } | fzf \
      --bind     "enter:execute(      bash -ic '{} \"$FILE\"'               )+accept" \
      --bind "alt-enter:execute(nohup bash -ic '{} \"$FILE\"' &amp;&gt; /dev/null &amp;)+accept"
  '';
in {
  home.packages = [
    go-there
    fzf-doc
  ];
  programs.bash.bashrcExtra = ''
    # FZF top-down display
    export FZF_DEFAULT_OPTS="--reverse"
  '';
  programs.fzf = {
    enable = true;
    # * hstr: not handle `~` correctly, always expand
    # * atuin: often not record my command, do know why
    #   * besides, the network sync is redundant for me
    # * mcfly: the fuzzy ranking algorithm is not as good/intuitive as fzf
    enableBashIntegration = true;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gdb-configurations"><a class="header" href="#gdb-configurations">GDB configurations</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.gdb
  ];
  home.file.gdbinit = {
    source = pkgs.fetchFromGitHub {
      owner = "cyrus-and";
      repo = "gdb-dashboard";
      rev = "616ed5100d3588bb70e3b86737ac0609ce0635cc";
      hash = "sha256-xoBkAFwkbaAsvgPwGwe1JxE1C8gPR6GP1iXeNKK5Z70=";
    } + /.gdbinit;
    target = ".gdbinit";
  };
  home.file.gdb_dashboard_init = {
    text = ''
      # gdb-dashboard init file

      # available layout modules
      #   stack registers history assembly
      #   breakpoints expressions memory
      #   source threads variables
      dashboard -layout source

      # https://en.wikipedia.org/wiki/ANSI_escape_code
      #dashboard -style prompt
      ## fg bold blue
      dashboard -style prompt_not_running "\\[\\e[1;34m\\]$\\[\\e[0m\\]"
      ## fg bold green
      dashboard -style prompt_running "\\[\\e[1;32m\\]$\\[\\e[0m\\]"
    '';
    target = ".gdbinit.d/init";
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: let
  git-wip = builtins.derivation {
    name = "git-wip";
    system = builtins.currentSystem;
    src = pkgs.fetchurl {
      url = "https://raw.githubusercontent.com/bartman/git-wip/1c095e93539261370ae811ebf47b8d3fe9166869/git-wip";
      sha256 = "00gq5bwwhjy68ig26a62307pww2i81y3zcx9yqr8fa36fsqaw37h";
    };
    builder = pkgs.writeShellScript "git-wip-builder" ''
      source ${pkgs.stdenv}/setup
      mkdir -p $out/bin
      dst=$out/bin/git-wip
      cp $src $dst
      chmod +w $dst
      sed -i 's/#!\/bin\/bash/#!\/usr\/bin\/env bash/g' $dst
      chmod -w $dst
      chmod a+x $dst
    '';
  };
in {
  home.packages = with pkgs; [
    mr
    git-wip
    git-quick-stats
  ];
  programs.git = {
    enable = true;
    package = pkgs.gitFull;
    settings = {
      core = {
        editor = "vim";
      };
      credential.helper = "store";
      init.defaultBranch = "main";
      alias = {
        viz = "log --all --decorate --oneline --graph";
      };
      user = {
        email = "xieby1@outlook.com";
        name = "xieby1";
      };
    };
    lfs.enable = true;
  };
  systemd.user.tmpfiles.rules = [
    "L? %h/.mrconfig - - - - %h/Gist/Config/mrconfig"
  ];
  # mr status not work in non-home dir
  programs.bash.shellAliases.mr = "mr -d ~";
  programs.lazygit = {
    enable = true;
    settings = {
      gui = {
        # screenMode = "half";
        mainPanelSplitMode = "horizontal";
        commitAuthorLongLength = builtins.stringLength "xieby1";

        # https://pkg.go.dev/time#Time.Format
        # Year: "2006" "06"
        # Month: "Jan" "January" "01" "1"
        # Day of the week: "Mon" "Monday"
        # Day of the month: "2" "_2" "02"
        # Day of the year: "__2" "002"
        # Hour: "15" "3" "03" (PM or AM)
        # Minute: "4" "04"
        # Second: "5" "05"
        # AM/PM mark: "PM"
        timeFormat = "2006.01.02";
        shortTimeFormat = "15:04";
      };
      keybinding = {
        universal = {
          rangeSelectDown = "";
          rangeSelectUp = "";
          scrollUpMain-alt1 = "&lt;s-up&gt;";
          scrollDownMain-alt1 = "&lt;s-down&gt;";
        };
      };
      promptToReturnFromSubprocess = false;
      git = {
        autoFetch = false;
      };
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ buildPythonPackage
, lib
, nss
, nspr
, expat
, fetchPypi
}:
let
  rpath = lib.makeLibraryPath [
    nss
    nspr
    expat
  ];
in buildPythonPackage rec {
  pname = "kaleido";
  version = "0.2.1";
  format = "wheel";
  src = fetchPypi {
    inherit pname version format;
    platform = "manylinux1_x86_64";
    hash = "sha256-qiHPG/HHj4+lCp99ReEAPDh709b+CnZ8+780S5W9w6g=";
  };
  doCheck = false;
  postFixup = ''
    for file in $(find $out -type f \( -perm /0111 -o -name \*.so\* \) ); do
      patchelf --set-interpreter "$(cat $NIX_CC/nix-support/dynamic-linker)" "$file" || true
      patchelf --set-rpath ${rpath}:$out/lib/x86_64-linux-gnu $file || true
    done
    sed -i 's,#!/bin/bash,#!/usr/bin/env bash,' $out/lib/python3.11/site-packages/kaleido/executable/kaleido
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="binutilss-ld-and-gccs-ld-collsion"><a class="header" href="#binutilss-ld-and-gccs-ld-collsion">binutils's ld and gcc's ld collsion</a></h1>
<p>Background: I want to install <code>gcc</code> and <code>objdump</code>, where <code>objdump</code> is contained in <code>binutils</code>.
Home-manager tolds me <code>gcc</code>'s <code>ld</code> collides with <code>binutils</code>'s <code>ld</code>.
As I explore into <code>gcc</code> and <code>binutils</code>, weird thing comes.</p>
<p>Packages <code>binutils</code> and <code>gcc</code> both contain ld executable.
<code>binutils</code> and <code>gcc</code> has the same priority 10.</p>
<p>The WEIRD thing is,</p>
<ul>
<li><code>binutils</code> wants to have a lower priority than gcc-wrapper,
so sets its priority to 10,
see nixpkgs: <code>pkgs/development/tools/misc/binutils/default.nix</code>
<blockquote>
<p>Give binutils a lower priority than gcc-wrapper to prevent a
collision due to the ld/as wrappers/symlinks in the latter.</p>
</blockquote>
</li>
<li>Both <code>gcc</code> wrapper and all-packages set gcc priority to 10,
see nixpkgs: <code>pkgs/top-level/all-packages.nix</code> and
<code>pkgs/build-support/cc-wrapper/default.nix</code>
All-packages set priority by lowPrio function,
which will set priority to 10.
Cc-wrapper directly set priority to 10.</li>
</ul>
<p>As a result, <code>binutils</code> will definitely collide with <code>gcc</code>!</p>
<p>My solution: assign <code>binutils</code> a lower priority, like this</p>
<pre><code class="language-nix">home.packages = with pkgs; [
  (lib.setPrio # higher value, less prior
    (bintools-unwrapped.meta.priority + 1)
    bintools-unwrapped
  )
  gdb
]
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nodejs-packages-npm-in-nixos"><a class="header" href="#nodejs-packages-npm-in-nixos">Nodejs packages (npm) in NixOS</a></h1>
<h1 id="nixosä¸­çš„nodejsåŒ…npm"><a class="header" href="#nixosä¸­çš„nodejsåŒ…npm">NixOSä¸­çš„NodejsåŒ…ï¼ˆnpmï¼‰</a></h1>
<p>å¤ªé•¿ä¸çœ‹ï¼šæ‰‹åŠ¨æš´éœ²<code>buildNodePackage</code>ï¼Œæ·»åŠ è‡ªå®šä¹‰çš„npmåŒ…ã€‚</p>
<p>nixpkgsä¸­çš„nodeåŒ…è™½å¤šä½†æœ‰é™ï¼Œ
é‡åˆ°éœ€è¦çš„nodeåŒ…ä¸å­˜åœ¨æ—¶ï¼Œæ˜¯ä¸ªéº»çƒ¦äº‹ã€‚</p>
<p>è®©æˆ‘è§‰å¾—ååˆ†è¯¡å¼‚çš„æ˜¯ï¼Œ
nixpkgsä¸­å­˜åœ¨ä¸€ä¸ªååˆ†æ–¹ä¾¿çš„æ·»åŠ nodeåŒ…çš„å‡½æ•°<code>nodeEnv.buildNodePackage</code>ï¼Œ
ä½†æ˜¯è¿™ä¸ªå‡½æ•°å´ä¸æš´éœ²å‡ºæ¥ç»™ç”¨æˆ·ã€‚
ç”šè‡³ï¼Œæœ‰äº›nixpkgsä¸­çš„åŒ…ä¸ºäº†ä½¿ç”¨è¿™ä¸ªå‡½æ•°ï¼Œ
å¤åˆ¶ç²˜è´´è¯¥å‡½æ•°åˆ°è‡ªå·±çš„åŒ…ä¸­ã€‚</p>
<p>åœ¨è¿™äº›å¥‡æ€ªçš„äº‹æƒ…çš„åŸºç¡€ä¸Šï¼Œ
è¿˜è¡ç”Ÿå‡ºæ¥è‡ªåŠ¨ç”Ÿæˆè¯¥<code>buildNodePackage</code>å‡½æ•°è½¯ä»¶<code>node2nix</code>ã€‚</p>
<p>æ‰€ä»¥è¿™çœŸçš„æ˜¯å­˜åœ¨å³åˆç†å˜›ï¼Ÿ
è¿˜æ˜¯æˆ‘å­¦è‰ºä¸ç²¾ï¼Œä¸èƒ½ç†è§£è®¾è®¡è€…çš„æ„å›¾ï¼Ÿ</p>
<p>ä¸€ä¸ªç®€å•çš„æš´éœ²<code>buildNodePackage</code>çš„æ–¹æ³•ï¼Œ
ç›´æ¥å¯¼å…¥<code>buildNodePackage</code>æ‰€åœ¨çš„æ–‡ä»¶ã€‚
ä¸ºäº†è·¨å¹³å°å¯ç”¨ï¼Œ
è·¯å¾„çš„æ„å»ºé‡‡ç”¨äº†ä¸€ç‚¹ä½¿ç”¨äº†ç‚¹ç‚¹å°æŠŠæˆï¼Œ</p>
<pre><code class="language-nix">&lt;nixpkgs&gt; + /pkgs/development/node-packages/node-env.nix
</code></pre>
<p>ä»¥@types/nodeä¸ºä¾‹å­ï¼Œnodepkgs.nixï¼š</p>
<pre><code class="language-nix">{ ... }:
let
  pkgs = import &lt;nixpkgs&gt; {};
  nodeEnv = import (&lt;nixpkgs&gt; + /pkgs/development/node-packages/node-env.nix) {
    inherit (pkgs) lib stdenv nodejs python2;
    inherit pkgs;
    inherit (pkgs) libtool runCommand writeTextFile writeShellScript;
  };
  globalBuildInputs = [];
in {
  "@types/node" = nodeEnv.buildNodePackage {
    name = "_at_types_slash_node";
    packageName = "@types/node";
    version = "18.7.15";
    src = pkgs.fetchurl {
      url = "https://registry.npmjs.org/@types/node/-/node-18.7.15.tgz";
      sha512 = "XnjpaI8Bgc3eBag2Aw4t2Uj/49lLBSStHWfqKvIuXD7FIrZyMLWp8KuAFHAqxMZYTF9l08N1ctUn9YNybZJVmQ==";
    };
    buildInputs = globalBuildInputs;
    meta = {
      description = "TypeScript definitions for Node.js";
      homepage = "https://github.com/DefinitelyTyped/DefinitelyTyped/tree/master/types/node";
      license = "MIT";
    };
    production = true;
    bypassCache = true;
    reconstructLock = true;
  };
}
</code></pre>
<p>è¯¥nodepkgs.nixæ–‡ä»¶ä¸ºç”¨æˆ·è‡ªå®šä¹‰çš„nodeåŒ…ï¼Œ
å¯ä»¥åƒnixpkgsä¸€æ ·ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶ï¼Œä¾‹å¦‚å¯¼å…¥</p>
<pre><code class="language-nix">myNodePkgs = import ./cli/nodepkgs.nix {}
</code></pre>
<p>åŒ…çš„è¡¨è¾¾å¼ä¸º<code>myNodePkgs."@types/node"</code>ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="python-in-nixnixos"><a class="header" href="#python-in-nixnixos">Python in Nix/NixOS</a></h1>
<div style="text-align:right; font-size:3em;">2023.05.03</div>
<div class="table-wrapper"><table><thead><tr><th>Project</th><th>Maintained</th><th>Description</th><th>Purity</th><th>Compatibility</th></tr></thead><tbody>
<tr><td>venv</td><td></td><td></td><td>âŒ</td><td>100%?</td></tr>
<tr><td>mach-nix</td><td>âœ…</td><td></td><td></td><td></td></tr>
<tr><td>pypi2nix</td><td>âŒ</td><td></td><td></td><td></td></tr>
<tr><td>pip2nix</td><td>âœ…</td><td></td><td>âœ…</td><td></td></tr>
<tr><td><code>buildPythonPackage</code></td><td>âœ…</td><td></td><td>âœ…</td><td></td></tr>
<tr><td>[TODO] poetry</td><td></td><td></td><td></td><td></td></tr>
<tr><td>[TODO] dream2nix</td><td></td><td></td><td></td><td></td></tr>
</tbody></table>
</div>
<h2 id="pip2nix"><a class="header" href="#pip2nix">pip2nix</a></h2>
<p>Noted: Latest version of pip2nix only use python39.
While nixpkgs 22.11 (current stable) is python310.
I dont to install multiple versions of python3.</p>
<p>If pip2nix can overcome the disadvantage of that
generate a long list of python packages,
and reuse python3Packages in nixpkgs,
I would prefer to use pip2nix completely.</p>
<p>Currently, I use <code>buildPythonPackage</code>.</p>
<h2 id="buildpythonpackage"><a class="header" href="#buildpythonpackage"><code>buildPythonPackage</code></a></h2>
<p><code>pkgs.python3Packages.buildPythonPackage</code></p>
<h2 id="venv"><a class="header" href="#venv">venv</a></h2>
<p>Use virtualenv, <code>pip</code> is available, no need to write nix expressions to install packages.</p>
<p>Code see https://xieby1.github.io/scripts/index.html#venvnix</p>
<h2 id="poetry"><a class="header" href="#poetry">poetry</a></h2>
<div style="text-align:right; font-size:3em;">2022.05.15</div>
<p>According to <a href="https://www.reddit.com/r/NixOS/comments/q71v0e/what_is_the_correct_way_to_setup_pip_with_nix_to/">What is the correct way to setup pip with nix to install any python package in an isolated nix environment</a>,
I found two useful tools to install python packages in Nix/NixOS</p>
<ul>
<li>[TODO] poetry</li>
<li>mach-nix</li>
</ul>
<h2 id="mach-nix"><a class="header" href="#mach-nix">mach-nix</a></h2>
<p>mach-nix github repo:
<a href="https://github.com/DavHau/mach-nix">github.com/DavHau/mach-nix</a></p>
<p>Here is [python_mach.nix]({{ site.repo_url }}/scripts/shell/python_mach.nix),
an example which create a shell with a python package called expmcc.</p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, lib, pkgs, ... }: {
  home.packages = [
    pkgs.sshfs
  ];
  programs.ssh.enable = true;
  programs.ssh.includes = lib.optional (builtins.pathExists ~/Gist/Config/ssh.conf) "~/Gist/Config/ssh.conf";
  # For compatibility
  programs.ssh.enableDefaultConfig = false;
  programs.ssh.matchBlocks."*" = {
    forwardAgent = false;
    addKeysToAgent = "no";
    compression = false;
    serverAliveInterval = 0;
    serverAliveCountMax = 3;
    hashKnownHosts = false;
    userKnownHostsFile = "~/.ssh/known_hosts";
    controlMaster = "no";
    controlPath = "~/.ssh/master-%r@%n:%p";
    controlPersist = "no";
  };
  programs.bash.bashrcExtra = lib.optionalString config.isNixOnDroid ''
    # start sshd
    if [[ -z "$(pidof sshd-start)" ]]; then
        tmux new -d -s sshd-start sshd-start
    fi
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><div style="text-align:right; font-size:3em;">2022.05.29</div>
<h1 id="é™æ€é“¾æ¥ä»¥qemuä¸ºä¾‹"><a class="header" href="#é™æ€é“¾æ¥ä»¥qemuä¸ºä¾‹">é™æ€é“¾æ¥ï¼Œä»¥qemuä¸ºä¾‹</a></h1>
<p>å¤ªé•¿ä¸çœ‹</p>
<ul>
<li>å®ç°äº†qemué™æ€é“¾æ¥ï¼Œæ— ä»»ä½•åŠ¨æ€é“¾æ¥åº“çš„ä¾èµ–ã€‚
é‡‡ç”¨äº†ä¸¤ä¸ªç‰ˆæœ¬çš„qemuï¼Œå½“å‰ç‰ˆæœ¬Nixçš„qemuï¼ˆnix 21.11, qemu 6.1.1ï¼‰
å’Œqemu3.1.0è¿™ä¸¤ä¸ªç‰ˆæœ¬ã€‚</li>
<li>nixè„šæœ¬ï¼š<a href="https://github.com/xieby1/xieby1.github.io/blob/main/src/scripts/nix/pkgs_qemu_static.nix">pkgs_qemu_static.nix</a></li>
</ul>
<h2 id="pkgsstaticåŠå…¶æºä»£ç "><a class="header" href="#pkgsstaticåŠå…¶æºä»£ç ">pkgsStaticåŠå…¶æºä»£ç </a></h2>
<p>Nixpkgså«æœ‰pkgsStaticè½¯ä»¶åŒ…ï¼Œä½†æ˜¯å¤§å¤šè½¯ä»¶æ— æ³•ç›´æ¥ä½¿ç”¨ã€‚
éœ€è¦è¿›è¡Œæ‰‹åŠ¨ä¿®å¤ã€‚</p>
<p>pkgsStaticåŠ è½½è¿‡ç¨‹çš„æºç </p>
<ul>
<li>
<p>pkgs/top-level/stage.nix
å°†crossSystemè®¾ç½®ä¸ºstaticä¸”abiä¸ºmuslã€‚
ä¹‹æ‰€ä»¥ç”¨Muslæ˜¯å› ä¸ºï¼Œ</p>
<blockquote>
<p>Currently uses Musl on Linux (couldnâ€™t get static glibc to work).</p>
</blockquote>
<p>å…¶ä»£ç å¤§è‡´çš„å¦‚ä¸‹ï¼Œ</p>
<pre><code class="language-nix">pkgsStatic = nixpkgsFun {
  crossSystem = {
    isStatic = true;
    parsed = stdenv.hostPlatform.parsed // {
      abi = musl;
};};};
</code></pre>
<ul>
<li>nixpkgsFun = newArgs: import pkgs/top-level/default.nix (...)
<ul>
<li>pkgs/top-level/default.nix: stdenvStages {..., crossSystem, ...}
<ul>
<li>pkgs/stdenv/default.nix: stagesCross
<ul>
<li>pkgs/stdenv/cross/default.nix: stdenvAdapters.makeStatic
<ul>
<li>pkgs/stdenv/adapters.nix: makeStatic
<ul>
<li>makeStaticLibraries
<ul>
<li>æ·»åŠ configureFlags "--enable-static" "--disable-shared"</li>
<li>æ·»åŠ cmakeFlags "-DBUILD_SHARED_LIBS:BOOL=OFF"</li>
<li>æ·»åŠ mesonFlags "-Ddefault_library=static"</li>
</ul>
</li>
<li>makeStaticBinaries
<ul>
<li>æ·»åŠ NIX_CFLAGS_LINK "-static"</li>
<li>æ·»åŠ configureFlags "--disable-shared"</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>TODO: è¯»æ‡‚makeStaticLibrarieså’ŒmakeStaticBinariesã€‚</p>
<h2 id="åŸºæœ¬æ€è·¯"><a class="header" href="#åŸºæœ¬æ€è·¯">åŸºæœ¬æ€è·¯</a></h2>
<p>å¯¹äºå½“å‰ç‰ˆæœ¬çš„qemuï¼Œä½¿ç”¨pkgsStatic.qemu
ï¼ŒæŒ¨ä¸ªä¿®å¤ç¼–è¯‘æŠ¥é”™å³å¯ã€‚</p>
<p>å¯¹äºå†å²ç‰ˆæœ¬çš„qemuï¼Œä»¥3.1.0ä¸ºä¾‹ï¼Œç¼–è¯‘æ–¹å¼å·²å’Œç°åœ¨æœ‰åŒºåˆ«ï¼Œ
æ¯”å¦‚ä¹‹å‰å®Œå…¨æ˜¯configure, makeï¼Œè€Œç°åœ¨å¼•å…¥äº†mesonã€‚
åˆæ­¥è®¾æƒ³ä¸¤ç§æ–¹æ¡ˆï¼Œ</p>
<ol>
<li>å«æ¥è€ç‰ˆæœ¬nixpkgsåˆ°å½“å‰ç‰ˆæœ¬
å°†qemu-3.1.0å¯¹åº”çš„nixpkgså«æ¥åˆ°å½“å‰çš„nixpkgs</li>
<li>æ”¹é€ æ–°ç‰ˆæœ¬nixpkgsä»¥é€‚åº”è€ç‰ˆæœ¬
é€šè¿‡overlay,overrideæ–¹æ³•ä¿®æ”¹å½“å‰nixpkgsçš„qemuçš„nixè¡¨è¾¾å¼</li>
</ol>
<p>æˆ‘é‡‡ç”¨çš„ç¬¬ä¸€ç§åŠæ³•ï¼Œå°†è€ç‰ˆæœ¬nixpkgså«æ¥åˆ°å½“å‰ç‰ˆæœ¬nixpkgsã€‚
ä½¿ç”¨<a href="https://lazamar.co.uk/nix-versions">lazamar.co.uk/nix-versions</a>
æŸ¥è¯¢æ”¯æŒqemu-3.1.0çš„nixpkgsç‰ˆæœ¬ã€‚
å¼•å…¥qemu-3.1.0çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼Œè¯¦ç»†è§<a href="https://github.com/xieby1/xieby1.github.io/blob/main/src/scripts/nix/pkgs_qemu_static.nix">pkgs_qemu_static.nix</a></p>
<pre><code class="language-nix"># get old nixpkgs which contains qemu-3.1.0
oldNixpkgsSrc = builtins.fetchTarball {...}
qemu31 = pkgs.callPackage (
  oldNixpkgsSrc + "/pkgs/applications/virtualization/qemu/default.nix"
) {...}
</code></pre>
<p>ç„¶åæŒ¨ä¸ªä¿®å¤ç¼–è¯‘æŠ¥é”™å³å¯ã€‚</p>
<h2 id="è°ƒè¯•æ‰‹æ®µ"><a class="header" href="#è°ƒè¯•æ‰‹æ®µ">è°ƒè¯•æ‰‹æ®µ</a></h2>
<h3 id="è¿˜åŸæ„å»ºç¯å¢ƒ"><a class="header" href="#è¿˜åŸæ„å»ºç¯å¢ƒ">è¿˜åŸæ„å»ºç¯å¢ƒ</a></h3>
<pre><code class="language-bash"># ä¿ç•™æ„å»ºå¤±è´¥çš„ç°åœº
nix-build pkgs_qemu_static.nix -K
</code></pre>
<p>è¿›å…¥ç°åœºåŒ…å«env-varsæ–‡ä»¶å’Œå¤±è´¥æ—¶çš„æºç æ–‡ä»¶å¤¹ã€‚
æ¢å¤ç¯å¢ƒï¼Œ</p>
<pre><code class="language-bash">. ./env-vars
. $stdenv/setup
</code></pre>
<h3 id="æŸ¥çœ‹ä¾èµ–æ ‘"><a class="header" href="#æŸ¥çœ‹ä¾èµ–æ ‘">æŸ¥çœ‹ä¾èµ–æ ‘</a></h3>
<pre><code class="language-bash">nix-store --query --tree &lt;xxx.drv&gt;
</code></pre>
<h3 id="ç»“æœ"><a class="header" href="#ç»“æœ">ç»“æœ</a></h3>
<p>ç›®å‰ä»…éœ€è¦å‘½ä»¤è¡Œçš„qemuï¼Œå› æ­¤ä¸ºäº†çœäº‹ï¼Œ
æˆ‘å»æ‰äº†å£°éŸ³å’Œå›¾åƒæ”¯æŒã€‚</p>
<p>æ³¨ï¼šåœ¨NixOS 21.11ä¸Šå’Œåœ¨ubuntu 22é…åˆnixä¸Šç¼–è¯‘å‡ºæ¥çš„qemuäºŒè¿›åˆ¶æ–‡ä»¶ä¸€æ¨¡ä¸€æ ·ã€‚</p>
<pre><font color="#4E9A06"><b>xieby1@yoga14s</b></font>:<font color="#3465A4"><b>~</b></font>
<font color="#4E9A06"><b>$</b></font> pkgs_qemu_static.nix 
/nix/store/gs6plgyc0jr9i5qams0ifksijnq9hkq2-qemu-static-x86_64-unknown-linux-musl-6.1.1
/nix/store/lm9kl1nm7bs4hy6l4qng03k4srx1x28n-qemu-3.1.0-x86_64-unknown-linux-musl
<font color="#4E9A06"><b>xieby1@yoga14s</b></font>:<font color="#3465A4"><b>~</b></font>
<font color="#4E9A06"><b>$</b></font> ldd result/bin/qemu-system-x86_64 
	not a dynamic executable
<font color="#4E9A06"><b>xieby1@yoga14s</b></font>:<font color="#3465A4"><b>~</b></font>
<font color="#4E9A06"><b>$</b></font> result/bin/qemu-system-x86_64 --version
QEMU emulator version 6.1.1
Copyright (c) 2003-2021 Fabrice Bellard and the QEMU Project developers
<font color="#4E9A06"><b>xieby1@yoga14s</b></font>:<font color="#3465A4"><b>~</b></font>
<font color="#4E9A06"><b>$</b></font> ldd result-2/bin/qemu-system-x86_64 
	not a dynamic executable
<font color="#4E9A06"><b>xieby1@yoga14s</b></font>:<font color="#3465A4"><b>~</b></font>
<font color="#4E9A06"><b>$</b></font> result-2/bin/qemu-system-x86_64  --version
QEMU emulator version 3.1.0
Copyright (c) 2003-2018 Fabrice Bellard and the QEMU Project developers</pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tailscaleheadscale"><a class="header" href="#tailscaleheadscale">Tailscale/Headscale</a></h1>
<h2 id="overview"><a class="header" href="#overview">overview</a></h2>
<ul>
<li>client
<ul>
<li>tailscale</li>
<li>tailscaled</li>
</ul>
</li>
<li>server
<ul>
<li>headscale</li>
</ul>
</li>
</ul>
<h2 id="command"><a class="header" href="#command">Command</a></h2>
<p>TODO: exit node</p>
<ul>
<li>https://www.reddit.com/r/Tailscale/comments/w9mtow/question_about_headscale_and_routing/</li>
<li>https://icloudnative.io/posts/how-to-set-up-or-migrate-headscale/</li>
</ul>
<p>TODO: headtail config
TODO: nix config</p>
<ul>
<li>rootless service</li>
<li>root service</li>
</ul>
<pre><code class="language-bash">tailscale --socket /tmp/tailscaled.sock up --login-server http://82.157.197.100
tailscale --socket /tmp/tailscaled.sock up --login-server http://82.157.197.100 --force-reauth
</code></pre>
<h3 id="enable-routes-exit-node"><a class="header" href="#enable-routes-exit-node">enable routes, exit node</a></h3>
<p>sudo tailscale --socket /tmp/tailscaled.sock up --login-server http://82.157.197.100 --advertise-routes=0.0.0.0/0,::/0 --accept-routes=true</p>
<p>sudo docker exec headscale headscale nodes routes enable -i 13 -a -r 0.0.0.0/0 -r ::/0</p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  tailscale-bash-completion = builtins.derivation {
    name = "tailscale-bash-completion";
    system = builtins.currentSystem;
    src = builtins.fetchurl "https://gist.githubusercontent.com/cmtsij/f0d0be209224a7bdd67592695e1427de/raw/tailscale";
    builder = pkgs.writeShellScript "tailscale-bash-completion-builder" ''
      source ${pkgs.stdenv}/setup
      dstdir=$out/share/bash-completion/completions
      dst=$dstdir/tailscale
      mkdir -p $dstdir
      cp $src $dst
    '';
  };
  tailscale-wrapper = {suffix, httpPort, socks5Port}: let
    tailscale-wrapped = pkgs.writeShellScriptBin "tailscale-${suffix}" ''
      tailscale --socket /tmp/tailscale-${suffix}.sock $@
    '';
    stateDir = "${config.home.homeDirectory}/.local/share/tailscale-${suffix}";
    tailscaled-wrapped = pkgs.writeShellScriptBin "tailscaled-${suffix}" ''
      TS_LOGS_DIR="${stateDir}" \
        ${pkgs.tailscale}/bin/tailscaled \
        --tun userspace-networking \
        --outbound-http-proxy-listen=localhost:${httpPort} \
        --socks5-server=localhost:${socks5Port} \
        --socket=/tmp/tailscale-${suffix}.sock \
        --state=${stateDir}/tailscaled.state \
        --statedir=${stateDir} \
        $@
    '';
    tailscale-wrapped-bash-completion = builtins.derivation {
      name = "tailscale-${suffix}-bash-completion";
      system = builtins.currentSystem;
      builder = pkgs.writeShellScript "tailscale-${suffix}-bash-completion-builder" ''
        source ${pkgs.stdenv}/setup
        reldir=share/bash-completion/completions
        dstdir=$out/$reldir
        dst=$dstdir/tailscale-${suffix}
        mkdir -p $dstdir
        touch $dst
        echo ". ${tailscale-bash-completion}/$reldir/tailscale" &gt;&gt; $dst
        echo "complete -F _tailscale tailscale-${suffix}" &gt;&gt; $dst
      '';
    };
  in {
    home.packages = [
      tailscale-wrapped
      tailscaled-wrapped
      tailscale-wrapped-bash-completion
    ];
    systemd.user.services."tailscaled-${suffix}" = {
      Unit = {
        Description = "Auto start tailscaled-${suffix} userspace network";
        After = ["clash.service"];
      };
      Install = {
        WantedBy = ["default.target"];
      };
      Service = {
        Environment = [
          "HTTPS_PROXY=http://127.0.0.1:${toString config.proxyPort}"
          "HTTP_PROXY=http://127.0.0.1:${toString config.proxyPort}"
          "https_proxy=http://127.0.0.1:${toString config.proxyPort}"
          "http_proxy=http://127.0.0.1:${toString config.proxyPort}"
        ];
        ExecStart = "${tailscaled-wrapped}/bin/tailscaled-${suffix}";
      };
    };
    programs.bash.bashrcExtra = lib.optionalString config.isNixOnDroid ''
      # start tailscale-${suffix}
      if [[ -z "$(pidof tailscaled-${suffix})" ]]; then
          tmux new -d -s tailscaled-${suffix} tailscaled-${suffix}
      fi
    '';
  };
in {
  imports = [{
    home.packages = [pkgs.tailscale tailscale-bash-completion];
  }
    # (tailscale-wrapper {suffix="headscale"; httpPort="1055"; socks5Port="1065";})
    (tailscale-wrapper {suffix="official";  httpPort="1056"; socks5Port="1066";})
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.tlrc
  ];
  home.file.tlrc_config = {
    target = ".config/tlrc/config.toml";
    text = pkgs.lib.generators.toINI {} {
      cache = {
        dir = ''"~/.cache/tlrc"''; # this is the default dir
        auto_update = false;
      };
    };
  };
  home.file.tldr_cache = {
    target = ".cache/tlrc";
    source = builtins.fetchTarball "https://github.com/tldr-pages/tldr/archive/main.tar.gz";
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tmux"><a class="header" href="#tmux">tmux</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }: {
  home.packages = [pkgs.tmux];
</code></pre>
<h2 id="bash-config-for-tmux"><a class="header" href="#bash-config-for-tmux">bash config for tmux</a></h2>
<p>Auto start tmux in non-GUI device.
mkAfter ensure the tmux config is appended to the tail of .bashrc.</p>
<pre><code class="language-nix">  programs.bash.bashrcExtra = lib.mkAfter (lib.optionalString (!config.isGui) ''
    # Auto start tmux
    # see: https://unix.stackexchange.com/questions/43601/how-can-i-set-my-default-shell-to-start-up-tmux
    # ~~1. tmux exists on the system~~, nix ensure that tmux does exist
    # 2. we're in an interactive shell, and
    # 3. tmux doesn't try to run within itself
    if [ -n "$PS1" ] &amp;&amp; [[ ! "$TERM" =~ screen ]] &amp;&amp; [[ ! "$TERM" =~ tmux ]] &amp;&amp; [ -z "$TMUX" ]; then
      exec tmux
    fi
  '');
</code></pre>
<h2 id="tmux-config-file"><a class="header" href="#tmux-config-file">tmux config file</a></h2>
<pre><code class="language-nix">  home.file.tmux = {
    text = ''
      # display status at top
      set -g status-position top
      set -g status-right ""

      # status bar
      ## display title on terminal
      set -g set-titles on
      set -g window-status-format "#F#I #W #{=/-20/â€¦:pane_title}"
      set -g window-status-current-format "ğŸ¶#F#I #W #{=/-20/â€¦:pane_title}"
      ## hide status bar when only one window
      ### refer to
      ### https://www.reddit.com/r/tmux/comments/6lwb07/is_it_possible_to_hide_the_status_bar_in_only_a/
      ### It not good, since its global!
      # if -F "#{==:#{session_windows},1}" "set -g status off" "set -g status on"
      # set-hook -g window-linked 'if -F "#{==:#{session_windows},1}" "set -g status off" "set -g status on"'
      # set-hook -g window-unlinked 'if -F "#{==:#{session_windows},1}" "set -g status off" "set -g status on"'
      ## color
      ### colour256çš„å‰10ä¸ªå’Œç»ˆç«¯(gnome-terminal tango)çš„é…è‰²ä¸€è‡´
      set -g status-style "bg=white fg=black"
      set -g window-status-last-style "bg=white fg=green bold"
      set -g window-status-current-style "bg=black fg=green bold"
      set -g window-status-separator " â”‡"

      # enable mouse scroll
      set -g mouse on

      # window index start from 1
      set -g base-index 1
      setw -g pane-base-index 1

      # auto re-number
      set -g renumber-windows on

      # Set new panes to open in current directory
      bind c new-window -c "#{pane_current_path}"
      bind '"' split-window -c "#{pane_current_path}"
      bind % split-window -h -c "#{pane_current_path}"

      # alt-num select window
      bind-key -n M-1 select-window -t 1
      bind-key -n M-2 select-window -t 2
      bind-key -n M-3 select-window -t 3
      bind-key -n M-4 select-window -t 4
      bind-key -n M-5 select-window -t 5
      bind-key -n M-6 select-window -t 6
      bind-key -n M-7 select-window -t 7
      bind-key -n M-8 select-window -t 8
      bind-key -n M-9 select-window -t 9
      # ctrl-t new window
      bind-key -n C-t new-window -c "#{pane_current_path}"

      # vi key bindings
      set -g mode-keys vi
      set -g status-keys vi

      # Home, End key not work in nix-on-droid
      # https://stackoverflow.com/questions/18600188/home-end-keys-do-not-work-in-tmux
      bind-key -n Home send Escape "OH"
      bind-key -n End send Escape "OF"

      set -g allow-passthrough on
    '';
    target = ".tmux.conf";
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="neovim"><a class="header" href="#neovim">ğŸ“‘neovim</a></h1>
<p>xieby1's neovim config!</p>
<p>See <a href="usr/cli/vim/./default.nix.html">default.nix</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="auto-sessions-management"><a class="header" href="#auto-sessions-management">auto sessions management</a></h1>
<p>auto-session vs persisted.nvim vs persistence-nvim</p>
<ul>
<li>auto-session support multiple sessions per path (customized session name),
while other two not support</li>
<li>persisted-nvim support telescope, while persistence-nvim not</li>
</ul>
<pre><code class="language-nix">{ pkgs, ... }: { programs.neovim.plugins = [{
  # TODO: replace this (2025.09.10) with nixpkgs's in future
  # use latest auto-session for auto use telescope
  plugin = pkgs.vimUtils.buildVimPlugin {
    name = "custom_session_tag";
    src = pkgs.fetchFromGitHub {
      owner = "rmagatti";
      repo = "auto-session";
      rev = "3b5d8947cf16ac582ef00443ede4cdd3dfa23af9";
      hash = "sha256-JOJNnz+1tzTJh5xTpkoTYPRAt4lR1HN7FP1fSXhzU2s=";
    };
    doCheck = false;
  };
  type = "lua";
  config = /*lua*/ ''
    require("auto-session").setup({
      -- auto_save will not update existing tag
      -- e.g.:
      -- * restore a session tag is (time1 win1â”‡win2)
      -- * ... some vim operations ...
      -- * when leave vim, there are only win1, the tag is expected to become (time2 win1)
      -- * However the tag is not updated, which is still (time1 win1â”‡win2)
      -- So I disable the original auto_save,
      -- and manually execute save when VimLeavePre,
      -- see VimLeavePre below.
      auto_save = false,
      auto_restore = false,
      args_allow_files_auto_save = true,
      -- auto purge session after 30 days
      purge_after_minutes = 60*24*30,
      session_lens = {
        -- for telescope
        picker_opts = { layout_config = { width = 0.95 } },
      },
    })
    vim.keymap.set('n', '&lt;space&gt;s', '&lt;cmd&gt;AutoSession search&lt;CR&gt;')
    vim.api.nvim_create_autocmd("VimLeavePre", { callback = function()
      -- close unnecessary buffers
      for _, win in ipairs(vim.api.nvim_list_wins()) do
        local buf = vim.api.nvim_win_get_buf(win)
        local ft = vim.api.nvim_buf_get_option(buf, 'filetype')
        if ft == "codecompanion" or ft == "Outline" then
          vim.api.nvim_buf_delete(buf, {})
        end
      end

      local buffers = {}
      for _, win in ipairs(vim.api.nvim_list_wins()) do
        local buf = vim.api.nvim_win_get_buf(win)
        local buf_name = vim.api.nvim_buf_get_name(buf)
        if buf_name ~= "" then
          -- Extract just the filename from the full path
          local filename = vim.fn.fnamemodify(buf_name, ":~:.")
          table.insert(buffers, filename)
        end
      end

      local buffers_occurrences = {}
      for _, buf in ipairs(buffers) do
        if buffers_occurrences[buf] then
          buffers_occurrences[buf] = buffers_occurrences[buf] + 1
        else
          buffers_occurrences[buf] = 1
        end
      end

      local buffers_strs = {}
      for buf, occurrence in pairs(buffers_occurrences) do
        if occurrence == 1 then
          table.insert(buffers_strs, buf)
        else --[[occurrence &gt; 1]]
          table.insert(buffers_strs, string.format("%s[%d]", buf, occurrence))
        end
      end

      table.sort(buffers_strs)
      local buffers_string = table.concat(buffers_strs, ", ")

      -- save session iff buffers_string is not empty
      if buffers_string ~= "" then
        require("auto-session").SaveSession(string.format("%s %s: %s",
          os.date("%dæ—¥"),
          vim.fn.fnamemodify(vim.fn.getcwd(), ":~"),
          buffers_string
        ))
      end
    end})
  '';
}];}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="completion"><a class="header" href="#completion">completion</a></h1>
<h1 id="blink-cmp-vs-nvim-cmp"><a class="header" href="#blink-cmp-vs-nvim-cmp">blink-cmp vs nvim-cmp</a></h1>
<h1 id="-as-the-config-looks-too-hacking-and-too-many-issues-remaining-unsolved-in-github"><a class="header" href="#-as-the-config-looks-too-hacking-and-too-many-issues-remaining-unsolved-in-github">* as the config looks too hacking and too many issues remaining unsolved in github</a></h1>
<h1 id="-and-nvim-cmp-last-maintain-is-5-months-ago-blink-cmp-is-5-days-ago"><a class="header" href="#-and-nvim-cmp-last-maintain-is-5-months-ago-blink-cmp-is-5-days-ago">* and nvim-cmp last maintain is 5 months ago, blink-cmp is 5 days ago.</a></h1>
<h1 id="-and-minuet-ai-nvim-delay-in-nvim-cmp-and-not-solved-blink-cmp-is-async"><a class="header" href="#-and-minuet-ai-nvim-delay-in-nvim-cmp-and-not-solved-blink-cmp-is-async">* and minuet-ai-nvim delay in nvim-cmp and not solved, blink-cmp is async</a></h1>
<pre><code class="language-nix"># TODO: split providers into separate files
{ pkgs, ... }: { programs.neovim = {
  plugins = [(pkgs.vimUtils.buildVimPlugin {
    name = "blink-cmp-dictionary";
    version = "2025-09-17";
    # current nixpkgs version does not support capitalize_first &amp; capitalize_whole_word
    # TODO: use latest version from nixpkgs when support above options
    src = pkgs.fetchFromGitHub {
      owner = "Kaiser-Yang";
      repo = "blink-cmp-dictionary";
      rev = "43b701fe9728a704bc63e4667c5d8b398bf129b2";
      hash = "sha256-szCNbYLWkJTAVGWz9iRFh7NfQfM5t5jcQHdQeKzBx30=";
    };
    doCheck = false;
  }) {
    # match unicode characters =&gt; match alphabet characters instead.
    # E.g. I don't want to completion a long CJK sentence.
    # E.g. I want alphabet next to CJK can be completed: "ä¾‹å­example"
    #      In original blink-fuzzy-lib, "example" cannot be completed.
    # (Due to the libblink_cmp_fuzzy being not easy to be patched,
    # the nix patch code becomes a large chunk as below.)
    plugin = pkgs.vimPlugins.blink-cmp.overrideAttrs (old: let
      postPatch = ''
        ## This is where texts being collected
        sed -i 's/\\p{L}/a-zA-Z/g' lua/blink/cmp/fuzzy/rust/lib.rs
        ## This is where trigger range is decided
        ## This change will break blink-fuzzy-lib check, so doCheck=false
        sed -i 's/\\p{L}/a-zA-Z/g' lua/blink/cmp/fuzzy/rust/keyword.rs
      '';
    in {
      # Here, postPatch does not effect blink-fuzzy-lib,
      # however, for consistency between source code and libblink_cmp_fuzzy.so,
      # I patch the source code as well.
      inherit postPatch;

      preInstall = let
        ext = pkgs.stdenv.hostPlatform.extensions.sharedLibrary;
        blink-fuzzy-lib = old.passthru.blink-fuzzy-lib.overrideAttrs { inherit postPatch; doCheck=false; };
      in ''
        mkdir -p target/release
        ln -s ${blink-fuzzy-lib}/lib/libblink_cmp_fuzzy${ext} target/release/libblink_cmp_fuzzy${ext}
      '';
    });
    type = "lua";
    config = /*lua*/ ''
      require("blink.cmp").setup({
        keymap = { preset = 'none',
          ['&lt;Tab&gt;']   = { 'select_next', 'fallback' },
          ['&lt;S-Tab&gt;'] = { 'select_prev', 'fallback' },
          ['&lt;Up&gt;']   = { function(cmp) return cmp.select_prev({ auto_insert = false }) end, 'fallback' },
          ['&lt;Down&gt;'] = { function(cmp) return cmp.select_next({ auto_insert = false }) end, 'fallback' },
          ['&lt;CR&gt;'] = { 'accept', 'fallback' },
          ['&lt;A-1&gt;'] = { function(cmp) cmp.accept({ index = 1 }) end },
          ['&lt;A-2&gt;'] = { function(cmp) cmp.accept({ index = 2 }) end },
          ['&lt;A-3&gt;'] = { function(cmp) cmp.accept({ index = 3 }) end },
          ['&lt;A-4&gt;'] = { function(cmp) cmp.accept({ index = 4 }) end },
          ['&lt;A-5&gt;'] = { function(cmp) cmp.accept({ index = 5 }) end },
          ['&lt;A-6&gt;'] = { function(cmp) cmp.accept({ index = 6 }) end },
          ['&lt;A-7&gt;'] = { function(cmp) cmp.accept({ index = 7 }) end },
          ['&lt;A-8&gt;'] = { function(cmp) cmp.accept({ index = 8 }) end },
          ['&lt;A-9&gt;'] = { function(cmp) cmp.accept({ index = 9 }) end },
          ['&lt;A-0&gt;'] = { function(cmp) cmp.accept({ index = 10 }) end },
          ['&lt;A-y&gt;'] = require('minuet').make_blink_map(),
        },
        completion = {
          documentation = { auto_show = true },
          menu = {
            draw = {
              columns = {
                {'item_idx'},
                {'kind_icon'}, {'label', 'label_description', gap = 1},
                {'source_name'},
              },
              components = {
                item_idx = {
                  text = function(ctx) return ctx.idx == 10 and '0' or ctx.idx &gt;= 10 and ' ' or tostring(ctx.idx) end,
                  highlight = 'BlinkCmpSource' -- optional, only if you want to change its color
                },
              },
            },
          },
          list = { selection = { preselect = false }, },
        },
        sources = {
          default = {
            'lsp', 'path', 'buffer', 'snippets',
            'minuet',
            "dictionary"
          },
          providers = {
            -- &gt; By default, the buffer source will only show when the LSP source returns no items
            -- Always show buffer completion, defaults to `{ 'buffer' }`
            lsp = { fallbacks = {}, },
            minuet = {
              name = 'minuet',
              module = 'minuet.blink',
              async = true,
              -- Should match minuet.config.request_timeout * 1000,
              -- since minuet.config.request_timeout is in seconds
              timeout_ms = 3000,
              score_offset = 50, -- Gives minuet higher priority among suggestions
            },
            -- blink-cmp-dictionary vs blink-cmp-dat-word
            -- former can handle capitalization proper, while latter cannot
            dictionary = {
              name = 'dict',
              module = 'blink-cmp-dictionary',
              min_keyword_length = 3,
              score_offset = -4, -- lower priority than buffer's -3
              opts = {
                dictionary_files = { "${pkgs.fetchurl {
                  url = "https://github.com/first20hours/google-10000-english/raw/bdf4c221bc120b0b7f6c3f1eff1cc1abb975f8d8/google-10000-english-no-swears.txt";
                  sha256 = "11pd0p6ckixr1b5qvi6qxj389wmzq1k42is1bm9fc2y3397y1cyn";
                }}" },
                dictionary_directories = { vim.fn.expand('~/Gist/dicts/blink-cmp') },
              },
            },
          },
        },
        cmdline = {
          -- TODO: blink-cmp cmdline cannot complete `'`,
          -- for example: `:h statusline` cannot complete to `:h 'statusline'`
          -- thus disable it currently
          enabled = false,
          keymap = { preset = 'inherit',
            ['&lt;Tab&gt;'] = { 'show_and_insert', 'select_next' },
            ['&lt;CR&gt;'] = { 'accept_and_enter', 'fallback' },
          },
          completion = { list = { selection = { preselect = false }, }, },
        },
      })
      vim.lsp.config('*', {
        capabilities = require('blink.cmp').get_lsp_capabilities(),
      })
    '';
  }];
};
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="key-bindings-of-closing-windows"><a class="header" href="#key-bindings-of-closing-windows">key bindings of closing windows</a></h1>
<pre><code class="language-nix">{ ... }: { programs.neovim.extraLuaConfig = /*lua*/ ''
  for Dir, cmd in pairs({Left="h", Down="j", Up="k", Right="l"}) do
    local f = function()
      local beg = vim.api.nvim_get_current_win()
      local cur
      while true do
        vim.api.nvim_set_current_win(beg)
        vim.cmd(string.format("wincmd %s", cmd))
        cur = vim.api.nvim_get_current_win()
        if cur == beg then break end
        vim.cmd("q")
      end
    end
    vim.keymap.set('n', string.format("Z&lt;%s&gt;", Dir), f)
    vim.keymap.set('n', string.format("Z&lt;S-%s&gt;", Dir), f)
  end
  vim.keymap.set('n', "ZA", "&lt;CMD&gt;qa!&lt;CR&gt;")
'';}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="code-companion-ai"><a class="header" href="#code-companion-ai">Code Companion: AI</a></h1>
<pre><code class="language-nix">{ lib, pkgs, ... }: {
  programs.neovim.plugins = [{
    plugin = pkgs.vimPlugins.codecompanion-nvim;
    type = "lua";
    # https://codecompanion.olimorris.dev/configuration/adapters.html
    config = /*lua*/ ''
      require("codecompanion").setup({
        adapters = {
          http = {
            deepseek = function() return require("codecompanion.adapters").extend("deepseek", {
              env = { api_key = "cmd:cat ~/Gist/Vault/deepseek_api_key_nvim.txt" },
              schema = { model = { default = "deepseek-chat" } },
            }) end,
          },
        },
        display = {
          chat = {
            window = {
              position = "left",
              width = 40,
              -- call api.nvim_set_option_value(k, v, { scope = "local", win = winnr }) for each k,v in opts
              opts = {
                winfixwidth = true,
              },
            },
            diff = { enabled = true },
          },
        },
        strategies = {
          chat = { adapter = "deepseek" },
          inline = { adapter = "deepseek" },
        },
      })

      -- key bindings of AI
      vim.keymap.set('n', '&lt;leader&gt;a', ':CodeCompanionChat Toggle&lt;CR&gt;')
      vim.keymap.set('v', '&lt;leader&gt;a', ':CodeCompanionChat Add&lt;CR&gt;')
    '';
  }];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="my-nvim-color-scheme"><a class="header" href="#my-nvim-color-scheme">ğŸ¨My nvim color scheme</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-color-scheme = {
    plugin = pkgs.vimPlugins.sonokai;
    config = ''
      set termguicolors

      let g:sonokai_transparent_background = 1

      let g:sonokai_colors_override = {
      \ 'black':    ['#111215', '237'],
      \ 'bg0':      ['#22232a', '235'],
      \ 'bg1':      ['#33353f', '236'],
      \ 'bg2':      ['#444754', '236'],
      \ 'bg3':      ['#555869', '237'],
      \ 'bg4':      ['#666a7e', '237'],
      \ 'grey':     ['#a5a5a6', '246'],
      \ 'grey_dim': ['#787879', '240'],
      \}

      " custom sonokai,
      " see section "How to use custom colors" of `:h sonokai.vim`
      function! s:sonokai_custom() abort
        let l:palette = sonokai#get_palette('default', {})
        call sonokai#highlight('StatusLine', l:palette.black, l:palette.fg, 'bold')
        call sonokai#highlight('StatusLineNC', l:palette.black, l:palette.grey, 'bold')
      endfunction
      augroup SonokaiCustom
        autocmd!
        autocmd ColorScheme sonokai call s:sonokai_custom()
      augroup END

      colorscheme sonokai
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-color-scheme
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="conform-nvim-formatter"><a class="header" href="#conform-nvim-formatter">conform-nvim: formatter</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim = {
   plugins = [{
    plugin = pkgs.vimPlugins.conform-nvim;
    type = "lua";
    config = ''
      require("conform").setup({
        formatters_by_ft = {
          nix = { "nixfmt" },
          c = { "clang_format" },
          cpp = { "clang_format" },
          json = { "js_beautify" },
          javascript = { "js_beautify" },
        },
      })

      -- refer to https://github.com/stevearc/conform.nvim/blob/master/doc/recipes.md#format-command
      vim.api.nvim_create_user_command("TrimWhitespace", function(args)
        local range = nil
        if args.count ~= -1 then
          local end_line = vim.api.nvim_buf_get_lines(0, args.line2 - 1, args.line2, true)[1]
          range = {
            start = { args.line1, 0 },
            ["end"] = { args.line2, end_line:len() },
          }
        end
        require("conform").format({ formatters = {"trim_whitespace"}, range = range })
      end, { range = true })
      vim.keymap.set({'n','v'}, '&lt;leader&gt;f', ':TrimWhitespace&lt;CR&gt;')

      vim.api.nvim_create_user_command("Format", function(args)
        local range = nil
        if args.count ~= -1 then
          local end_line = vim.api.nvim_buf_get_lines(0, args.line2 - 1, args.line2, true)[1]
          range = {
            start = { args.line1, 0 },
            ["end"] = { args.line2, end_line:len() },
          }
        end
        require("conform").format({ async = true, lsp_fallback = true, range = range })
      end, { range = true })
      vim.keymap.set({'n','v'}, '&lt;leader&gt;F', ':Format&lt;CR&gt;')
    '';
   }];
    extraPackages = with pkgs; [
      nixfmt-rfc-style
      clang-tools
      nodePackages.js-beautify
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }: {
</code></pre>
<p>Plugins with customizations:</p>
<pre><code class="language-nix">  imports = [
    ./fold.nix
    ./conform-nvim.nix
    ./nvim-lspconfig
    ./blink-cmp.nix
    ./vim-mark.nix
    ./nvim-treesitter.nix
    ./nvim-config-local.nix
    ./leap-nvim.nix
    ./telescope-nvim.nix
    ./git-wip.nix
    ./vim-floaterm.nix
    ./outline-nvim.nix
    ./vim-hexokinase.nix
    ./gitsigns-nvim.nix
    ./color-scheme.nix
    ./hbac-nvim.nix
    ./winshift-nvim.nix
    ./smartyank-nvim.nix
    ./mini-nvim.nix
    ./vim-easy-align.nix
    ./codecompanion-nvim.nix
    ./close-windows.nix
    ./nvim-window-picker.nix
    ./vim-matchup.nix
    ./nvim-nav.nix
    ./markdown-preview-nvim.nix
    ./venn-nvim.nix
    ./snacks-nvim.nix
    ./minuet-ai-nvim.nix
    ./auto-session.nix
    ./nvim-treesitter-context.nix
    ./rustowl.nix
    ./treesitter-injections
  ];

  programs.bash.shellAliases.view = "nvim -R";
</code></pre>
<p>Set nvim as manpager.
see nvim <code>:h :Man</code>.
nvim manpage huge mange is SLOW! E.g. man configuration.nix.</p>
<pre><code class="language-nix">  programs.bash.shellAliases.nman = "env MANPAGER='nvim +Man!' man";

  programs.neovim = {
    enable = true;
    viAlias = true;
    vimAlias = true;
    vimdiffAlias = true;

</code></pre>
<p>Plugins without customizations:</p>
<pre><code class="language-nix">    plugins = with pkgs.vimPlugins; [
      vim-fugitive
      vim-nix
      vim-markdown-toc
      vim-commentary
      vim-surround
      otter-nvim
    ];

</code></pre>
<p>Vim config</p>
<pre><code class="language-nix">    extraConfig = /*vim*/ ''
      " vim
      "" Highlight searches
      set hlsearch
      nnoremap &lt;F3&gt; :nohlsearch&lt;CR&gt;
      "" Show line number
      set number
      "" Always show the signcolumn, otherwise it would shift the text each time
      "" diagnostics appear/become resolved
      set signcolumn=number
      "" indent
      """ On pressing tab, insert spaces
      set expandtab
      """ no markdown recommended indent style (recommended shiftwidth=4)
      let g:markdown_recommended_style = 0
      """ line wrap with ident
      set breakindent

      """ mouse support " select by pressing shift key!
      set mouse=a
      "" Preview
      nnoremap &lt;leader&gt;[ :pc&lt;CR&gt;
      "" highlight unwanted whitespace
      set list
      set listchars=tab:&gt;-,trail:-
      "" syntax
      syntax on
      "" backspace
      set backspace=indent,eol,start
      "" wrap line
      """ https://stackoverflow.com/questions/248102/is-there-any-command-to-toggle-enable-auto-text-wrapping
      :function ToggleWrap()
      : if (&amp;wrap == 1)
      :   set nowrap
      : else
      :   set wrap
      : endif
      :endfunction
      nnoremap &lt;F9&gt; :call ToggleWrap()&lt;CR&gt;
      set updatetime=400
      "" highlight current line
      set cursorlineopt=number
      augroup CursorLine
        au!
        au VimEnter,WinEnter,BufWinEnter * setlocal cursorline
        au WinLeave * setlocal nocursorline
      augroup END

      " filetype
      augroup filetype
          " detect LLVM IR file
          au! BufRead,BufNewFile *.ll     set filetype=llvm
          " cpp " from gem5
          au! BufRead,BufNewFile *.hh.inc,*.cc.inc set filetype=cpp
          " d2
          au! BufRead,BufNewFile *.d2 set filetype=d2
          au! FileType d2 setlocal commentstring=#\ %s
      augroup END

      " set terminal title
      "" https://stackoverflow.com/questions/15123477/tmux-tabs-with-name-of-file-open-in-vim
      autocmd BufEnter * let &amp;titlestring = "" . expand("%:t")
      set title

      nnoremap &lt;F10&gt; :echo "hi&lt;" . synIDattr(synID(line("."),col("."),1),"name") . '&gt; trans&lt;'
      \ . synIDattr(synID(line("."),col("."),0),"name") . "&gt; lo&lt;"
      \ . synIDattr(synIDtrans(synID(line("."),col("."),1)),"name") . "&gt;"&lt;CR&gt;

      " highlight
      augroup HiglightTODO
          autocmd!
          autocmd WinEnter,VimEnter * :silent! call matchadd('Todo', 'TODO', -1)
      augroup END

      " TODO: replace wildmenu with blink-cmp cmdline
      " wildmenu
      " see: https://github.com/neovim/neovim/pull/11001
      cnoremap &lt;expr&gt; &lt;Up&gt;    pumvisible() ? "\&lt;Left&gt;"  : "\&lt;Up&gt;"
      cnoremap &lt;expr&gt; &lt;Down&gt;  pumvisible() ? "\&lt;Right&gt;" : "\&lt;Down&gt;"
      cnoremap &lt;expr&gt; &lt;Left&gt;  pumvisible() ? "\&lt;Up&gt;"    : "\&lt;Left&gt;"
      cnoremap &lt;expr&gt; &lt;Right&gt; pumvisible() ? "\&lt;Down&gt;"  : "\&lt;Right&gt;"

      " prevent resizing other windows when splitting/closing a window
      set noequalalways
      nnoremap &lt;C-W&gt;&lt;C-Left&gt;  &lt;C-W&gt;&lt;Left&gt;
      nnoremap &lt;C-W&gt;&lt;C-Right&gt; &lt;C-W&gt;&lt;Right&gt;
      nnoremap &lt;C-W&gt;&lt;C-Up&gt;    &lt;C-W&gt;&lt;Up&gt;
      nnoremap &lt;C-W&gt;&lt;C-Down&gt;  &lt;C-W&gt;&lt;Down&gt;
    '';
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="fold"><a class="header" href="#fold">fold</a></h1>
<pre><code class="language-nix">{ ... }: {
  programs.neovim = {
    extraConfig = ''
      "" Fold
      """ fold text to be the first and last line
      """ refer to sbernheim4's reply at
      """ https://github.com/nvim-treesitter/nvim-treesitter/pull/390
      function! GetSpaces(foldLevel)
          if &amp;expandtab == 1
              " Indenting with spaces
              let str = repeat(" ", a:foldLevel / (&amp;shiftwidth + 1) - 1)
              return str
          elseif &amp;expandtab == 0
              " Indenting with tabs
              return repeat(" ", indent(v:foldstart) - (indent(v:foldstart) / &amp;shiftwidth))
          endif
      endfunction
      function! MyFoldText()
          let startLineText = getline(v:foldstart)
          let endLineText = trim(getline(v:foldend))
          let indentation = GetSpaces(foldlevel("."))
          let spaces = repeat(" ", 200)
          let str = indentation . startLineText . " â€¦â€¦ " . endLineText . spaces
          return str
      endfunction
      "" toggle foldmethod between manual and indent
      set foldmethod=indent
      :function ToggleFoldmethod()
      : if (&amp;foldmethod == "manual")
      :   set foldmethod=indent
      : else
      :   set foldmethod=manual
      : endif
      :endfunction
      nnoremap &lt;Leader&gt;z :call ToggleFoldmethod()&lt;CR&gt;:echo &amp;foldmethod&lt;CR&gt;
      "" Custom display for text when folding
      set foldtext=MyFoldText()
      """ Set the foldlevel to a high setting,
      """ files are always loaded with opened folds.
      set foldlevel=20
    '';
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="git-wip-auto-wip-branch"><a class="header" href="#git-wip-auto-wip-branch">git-wip: auto wip branch</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  git-wip = pkgs.vimUtils.buildVimPlugin {
    name = "git-wip";
    src = pkgs.fetchFromGitHub {
      owner = "bartman";
      repo = "git-wip";
      rev = "1c095e93539261370ae811ebf47b8d3fe9166869";
      hash = "sha256-rjvg6sTOuUM3ltD3DuJqgBEDImLrsfdnK52qxCbu8vo=";
    };
    preInstall = "cd vim";
  };
in {
  programs.neovim = {
    plugins = [
      git-wip
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gitsigns-nvim-git-support"><a class="header" href="#gitsigns-nvim-git-support">gitsigns-nvim: git support</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-gitsigns-nvim = {
    plugin = pkgs.vimPlugins.gitsigns-nvim;
    type = "lua";
    config = /*lua*/ ''
      require('gitsigns').setup {
        signs_staged_enable = false,
        signcolumn = false,
        numhl      = true,
        linehl     = true,

        current_line_blame = true,
        current_line_blame_formatter = 'ğŸ–‚ &lt;author&gt; ğŸ–ƒ &lt;author_time:%R&gt; ğŸ–† &lt;summary&gt;',

        -- keymaps
        on_attach = function(bufnr)
          local gs = package.loaded.gitsigns

          local function map(mode, l, r, opts)
            opts = opts or {}
            opts.buffer = bufnr
            vim.keymap.set(mode, l, r, opts)
          end

          -- Navigation
          map('n', ']c', function()
            if vim.wo.diff then return ']c' end
            vim.schedule(function() gs.next_hunk() end)
            return '&lt;Ignore&gt;'
          end, {expr=true})

          map('n', '[c', function()
            if vim.wo.diff then return '[c' end
            vim.schedule(function() gs.prev_hunk() end)
            return '&lt;Ignore&gt;'
          end, {expr=true})

          -- Actions
          map({'n', 'v'}, '&lt;leader&gt;hs', ':Gitsigns stage_hunk&lt;CR&gt;')
          map({'n', 'v'}, '&lt;leader&gt;hr', ':Gitsigns reset_hunk&lt;CR&gt;')
          map('n', '&lt;leader&gt;hS', gs.stage_buffer)
          map('n', '&lt;leader&gt;hu', gs.undo_stage_hunk)
          map('n', '&lt;leader&gt;hR', gs.reset_buffer)
          map('n', '&lt;leader&gt;hp', gs.preview_hunk)
          map('n', '&lt;leader&gt;hb', function() gs.blame_line{full=true} end)
          -- map('n', '&lt;leader&gt;tb', gs.toggle_current_line_blame)
          map('n', '&lt;leader&gt;hd', gs.diffthis)
          map('n', '&lt;leader&gt;hD', function() gs.diffthis('~') end)
          -- map('n', '&lt;leader&gt;td', gs.toggle_deleted)

          -- Text object
          map({'o', 'x'}, 'ih', ':&lt;C-U&gt;Gitsigns select_hunk&lt;CR&gt;')
        end
      }
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-gitsigns-nvim
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hbac-nvim-auto-close-buffer"><a class="header" href="#hbac-nvim-auto-close-buffer">hbac-nvim: auto close buffer</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-hbac = {
    plugin = pkgs.vimUtils.buildVimPlugin {
      name = "hbac.nvim";
      src = pkgs.fetchFromGitHub {
        owner = "axkirillov";
        repo = "hbac.nvim";
        rev = "2c85485ea28e5e3754650829e0bca612960e1b73";
        hash = "sha256-A+C9N7xorS7DV0w8N5TjyD7OvWdxUQ4PJaKW3kwkQS0=";
      };
      doCheck = false;
    };
    type = "lua";
    config = /*lua*/ ''
      require("hbac").setup({
        autoclose     = true, -- set autoclose to false if you want to close manually
        threshold     = 20, -- hbac will start closing unedited buffers once that number is reached
        close_command = function(bufnr)
          vim.api.nvim_buf_delete(bufnr, {})
        end,
        close_buffers_with_windows = false, -- hbac will close buffers with associated windows if this option is `true`
        telescope = {
          -- See #telescope-configuration below
          },
      })
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-hbac
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim = {
    plugins = [{
      plugin = pkgs.vimPlugins.leap-nvim;
      type = "lua";
      config = /*lua*/ ''
        vim.keymap.set({'n', 'x', 'o'}, 's', '&lt;Plug&gt;(leap)')
        vim.keymap.set('n',             'S', '&lt;Plug&gt;(leap-from-window)')
        '';
    }];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim = {
    plugins = [{
      plugin = pkgs.vimPlugins.markdown-preview-nvim.overrideAttrs (old: {
        postPatch = toString [
        # use cjk2ch.js
        (let
          cjk2ch_js = pkgs.fetchurl {
            url = "https://github.com/xieby1/markdown_revealjs/raw/c9c91257d06b63adcf67d3464efbc392f55677ff/share/markdown_revealjs/cjk2ch.js";
            sha256 = "0d2xjy8g89zq8677ggklfpr3f9jd8lny37lbcdqr0asvmiqjgx9x";
          };
        # æ·»åŠ cjk2ch.js
        # ç»™æ··æ·†è¿‡çš„index.jsæ‰“è¡¥ä¸ï¼ˆè¿™ç”Ÿæˆä»£ç å±…ç„¶ç›´æ¥æ”¾gitï¼ŒğŸ˜¼ğŸ˜¼ğŸ˜¼å•§å•§å•§ï¼Œæºç æ˜¯index.jsxï¼‰
        # é€šè¿‡code:not(:has(span))æ¥è¯†åˆ«å“ªäº›codeå¯èƒ½æ˜¯ascii art
        # åœ¨refreshContentæœ€åï¼Œå³renderDotçš„åé¢è°ƒç”¨cjk2ch(...)
        in ''
          cp ${cjk2ch_js} app/_static/cjk2ch.js
          sed -i 's,&lt;head&gt;,&amp;&lt;script src="/_static/cjk2ch.js"&gt;&lt;/script&gt;,' app/out/index.html
          sed -i 's,}var e;G(),;cjk2ch("code:not(:has(span))");&amp;,' app/out/_next/static/s7O4q0ISzv1r8jtwIkXLb/pages/index.js
        '')
        # set port to 7700~7799
        ''
          sed -i 's/port = port ||.*/port = port || (7700 + Number(`''${Date.now()}`.slice(-2)))/' app/server.js
        ''
        # set line-height of &lt;pre&gt;&lt;/pre&gt;
        ''
          sed -i 's/line-height: 1.45;/line-height: 1em;/' app/_static/markdown.css
        ''
        # upgrade mermaid
        (let
          mermaid_js = pkgs.fetchurl {
            url = "https://cdn.jsdelivr.net/npm/mermaid@11.9.0/dist/mermaid.min.js";
            sha256 = "1658hsyxrg9sh3nmafsisiylsw7z436dznpgv8akhdhp84vx8ghb";
          };
        in ''
          cp ${mermaid_js} app/_static/mermaid.min.js
        '')];
      });
      config = ''
        " allow LAN
        let g:mkdp_open_to_the_world = 1
        let g:mkdp_theme = 'light'

        " Use chromium-like browser to open rendered markdown instead of firefox,
        " because firefox only copy css in selected region, causing lost of styles!
        " See same bug report here:
        " https://discourse.mozilla.org/t/copy-rich-text-from-firefox-does-not-capture-style/97862/3
        function OpenMarkdownPreview (url)
          " run chromium in app mode in background
          execute "silent ! chromium --app='" . a:url . "' &amp;"
        endfunction
        let g:mkdp_browserfunc = 'OpenMarkdownPreview'
      '';
    }];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mini-nvim-a-nvim-distro"><a class="header" href="#mini-nvim-a-nvim-distro">mini-nvim: a nvim distro</a></h1>
<p>mini-nvim is wonderful nvim plugin!
I found it due to below link:
indent-blankline.nvim is too complex.
However, it does not support basic functionality like highlight current indentation
See: https://github.com/lukas-reineke/indent-blankline.nvim/issues/649</p>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-mini-nvim = {
    plugin = pkgs.vimPlugins.mini-nvim;
    type = "lua";
    config = ''
      require('mini.indentscope').setup{
        options = {
          try_as_border = true,
        },
      }

      -- mini.animate looks promising, and can totally replace vim-smoothie
      -- However, bugs seem exist:
      -- * touchpad scroll become slow
      -- * background color blinks when create window
      -- * background color broken after q::q
      -- require('mini.animate').setup()

      require('mini.icons').setup()
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-mini-nvim
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, lib, ... }: let
  api_key_file = "${config.home.homeDirectory}/Gist/Vault/siliconflow_api_key_chatbox.txt";
in { config = lib.mkIf (builtins.pathExists api_key_file) {
  # mkAfter makes sure statusline setting is after nvim-nav.nix
  programs.neovim.plugins = lib.mkAfter [pkgs.vimPlugins.plenary-nvim {
    plugin = pkgs.vimPlugins.minuet-ai-nvim;
    type = "lua";
    config = /*lua*/ ''
      require('minuet').setup {
        blink = { enable_auto_complete = false },
        provider = 'openai_fim_compatible',
        provider_options = {
          openai_fim_compatible = {
            name = 'Qwen',
            end_point = 'https://api.siliconflow.cn/v1/completions',
            api_key = function() return '${lib.fileContents api_key_file}' end,
            model = "Qwen/Qwen3-Coder-30B-A3B-Instruct",
            optional = {
              max_tokens = 256,
              top_p = 0.9,
            },
          },
          --[[
            Enable ollama:
            * ollama serve
            * ollama pull qwen2.5-coder:0.5b
            * or other model support completion and insert capabilities
              (I dont why need insert, and the ollama docs and minuet-ai-nvim docs don't explain about this)
          ]]
          -- openai_fim_compatible = {
          --   model = "qwen2.5-coder:0.5b",
          --   end_point = "localhost:11434/v1/completions",
          --   name = "Qwen2.5",
          --   stream = true,
          --   api_key = 'TERM',
          --   optional = {
          --     max_tokens = 5,
          --   },
          -- },
        },
        --context_window = 512,
      }

      -- function update_minuet_statusline()
      --   local minuet = require("minuet")
      --   vim.o.statusline = string.gsub(vim.o.statusline, "[á¯¤]*$",
      --     minuet.config.blink.enable_auto_complete and "á¯¤" or "")
      -- end
      -- vim.keymap.set({'n','i'}, '&lt;A-a&gt;', function()
      --   local minuet = require("minuet")
      --   minuet.config.blink.enable_auto_complete = not minuet.config.blink.enable_auto_complete
      --   update_minuet_statusline()
      -- end)
      -- update_minuet_statusline()
    '';
  }];
};}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nvim-config-local-secure-load-local-vim-config"><a class="header" href="#nvim-config-local-secure-load-local-vim-config">nvim-config-local: secure load local vim config</a></h1>
<pre><code class="language-nix">{ pkgs, ... }:
let
  my-nvim-config-local = {
    plugin = pkgs.vimPlugins.nvim-config-local;
    type = "lua";
    config = ''
      require('config-local').setup {
        config_files = { ".nvim.lua", ".nvimrc", ".exrc", ".vimrc" },
        lookup_parents = true,
        silent = true,
      }
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-nvim-config-local
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="lspconfig-for-cc-language"><a class="header" href="#lspconfig-for-cc-language">lspconfig for C/C++ language</a></h1>
<pre><code class="language-nix">{ pkgs, ...}: {
  programs.neovim = {
</code></pre>
<h2 id="cc"><a class="header" href="#cc">C/C++</a></h2>
<h3 id="why-use-clangd-instead-of-ccls"><a class="header" href="#why-use-clangd-instead-of-ccls">Why use clangd instead of ccls?</a></h3>
<p>I encountered the problem below,
when view https://github.com/xieby1/openc910 smart_run/logical/tb/sim_main1.cpp</p>
<pre><code>LSP[ccls]: Error NO_RESULT_CALLBACK_FOUND: {
  error = {
    code = -32603,
    message = "failed to index /home/xieby1/Codes/openc910/smart_run/work/fputc.c"
  },
  id = 1,
  jsonrpc = "2.0"
}
</code></pre>
<p>After some searching, I found</p>
<p><a href="https://github.com/neovim/neovim/issues/15844">GitHub: neovim: issue: lsp: NO_RESULT_CALLBACK_FOUND with ccls, rust-analyzer #15844</a></p>
<p>sapphire-arches found:</p>
<blockquote>
<p>Something is causing the r-a LSP to send two replies with the same ID, see the attached log:
lsp_debug.log</p>
<p>It would be nice for the neovim LSP to handle this more gracefully (not filling my screen with garbage and taking focus), but I do think the bug is in R-A here? The problem seems to be related to editor.action.triggerParameterHints?</p>
</blockquote>
<p><a href="https://github.com/MaskRay/ccls/issues/836">GitHub: ccls: issue: I'm very confused about this question, it's about ccls or neovim built in LSP? #836</a></p>
<p>No one try to fix the two-replies problem in ccls.
However, nimaipatel recommanded <a href="https://github.com/p00f/clangd_extensions.nvim">clangd_extensions</a>.</p>
<pre><code class="language-nix">    extraLuaConfig = ''
      vim.lsp.config('clangd', {
        filetypes = { "c", "cc", "cpp", "c++", "objc", "objcpp", "cuda", "proto" }
      })
      vim.lsp.enable("clangd")
    '';
    plugins = [
      pkgs.vimPlugins.clangd_extensions-nvim
    ];
    extraPackages = with pkgs; [
      clang-tools
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nvim-lspconfig"><a class="header" href="#nvim-lspconfig">nvim-lspconfig</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  imports = [
    ./c.nix
    # bash
    {programs.neovim={extraLuaConfig="vim.lsp.enable('bashls')\n";extraPackages=[pkgs.bash-language-server];};}
    # html
    {programs.neovim={extraLuaConfig="vim.lsp.enable('html')\n";extraPackages=[pkgs.vscode-langservers-extracted];};}
    # lua
    {programs.neovim={extraLuaConfig="vim.lsp.enable('lua_ls')\n";extraPackages=[pkgs.lua-language-server];};}
    # nix
    {programs.neovim={extraLuaConfig="vim.lsp.enable('nixd')\n";extraPackages=[pkgs.nixd];};}
    # python
    {programs.neovim={extraLuaConfig="vim.lsp.enable('pyright')\n";extraPackages=[pkgs.pyright];};}
    # typos
    {programs.neovim={extraLuaConfig="vim.lsp.enable('typos_lsp')\n";extraPackages=[pkgs.typos-lsp];};}
    # xml
    {programs.neovim={extraLuaConfig="vim.lsp.enable('lemminx')\n";extraPackages=[pkgs.lemminx];};}
    # markdown
    {programs.neovim={extraLuaConfig="vim.lsp.enable('marksman')\n";extraPackages=[pkgs.marksman];};}
    # language checker
    {programs.neovim={extraLuaConfig="vim.lsp.enable('harper_ls')\n";extraPackages=[pkgs.harper];};}
    ./rust.nix
    ./scala.nix
    ./typst.nix
  ];
  programs.neovim = {
    plugins = [{
      plugin = pkgs.vimPlugins.nvim-lspconfig;
      type = "lua";
</code></pre>
<h2 id="global-mappings"><a class="header" href="#global-mappings">Global mappings.</a></h2>
<pre><code class="language-nix">      config = /*lua*/ ''
        -- See `:help vim.diagnostic.*` for documentation on any of the below functions
        vim.keymap.set('n', '&lt;leader&gt;d', vim.diagnostic.open_float)
        vim.keymap.set('n', '[d', function() vim.diagnostic.jump({ count=-1, float=true, severity = { min = vim.diagnostic.severity.WARN } }) end)
        vim.keymap.set('n', ']d', function() vim.diagnostic.jump({ count= 1, float=true, severity = { min = vim.diagnostic.severity.WARN } }) end)
        vim.keymap.set('n', '[D', function() vim.diagnostic.jump({ count=-1, float=true, }) end)
        vim.keymap.set('n', ']D', function() vim.diagnostic.jump({ count= 1, float=true, }) end)
        vim.keymap.set('n', '&lt;space&gt;d', function() require('telescope.builtin').diagnostics({bufnr=0}) end)
        vim.keymap.set('n', '&lt;space&gt;D', require('telescope.builtin').diagnostics)
        vim.diagnostic.config({
          float = {
            source = true,  -- Show the source (LSP server name)
          }
        })

        -- Use LspAttach autocommand to only map the following keys
        -- after the language server attaches to the current buffer
        vim.api.nvim_create_autocmd('LspAttach', {
          group = vim.api.nvim_create_augroup('UserLspConfig', {}),
          callback = function(ev)
            local opts = { buffer = ev.buf }
            local builtin = require("telescope.builtin")
            vim.keymap.set('n', 'gd', builtin.lsp_definitions, opts)
            vim.keymap.set('n', 'gD', vim.lsp.buf.declaration, opts)
            vim.keymap.set('n', 'gt', builtin.lsp_type_definitions, opts)
            vim.keymap.set('n', 'gr', builtin.lsp_references, opts)
            vim.keymap.set('n', 'gi', builtin.lsp_implementations, opts)
            vim.keymap.set('n', 'K', vim.lsp.buf.hover, opts)
            vim.keymap.set('n', '&lt;space&gt;rn', vim.lsp.buf.rename, opts)

            -- make sure lsp/vim native indent(share/nvim/runtime/indent/python.vim)
            -- don't override my setting
            vim.opt.tabstop = 2
            vim.opt.shiftwidth = 2
          end,
        })
      '';
    }];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim={
    extraLuaConfig = /*lua*/ ''
      vim.lsp.config("rust_analyzer", {
        settings = {
          ["rust-analyzer"] = {
            cargo = {
              -- goto definition of rust's lib needs this
              sysrootSrc = "${pkgs.rustPlatform.rustLibSrc}",
            },
          }
        },
      })
      vim.lsp.enable("rust_analyzer")
    '';
    extraPackages = [ pkgs.rust-analyzer ];
  };
  home.packages = [
    pkgs.cargo
    # prevent rust_analyzer throw error: `rust-analyzer: no sysroot [macro-error]`
    pkgs.rustc
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># If metals throw errors, check &lt;workspace&gt;/.metals/metals.log
# Try following steps:
# * rm -rf .metals/ ~/.bloop/* ~/.cache/mill/ ~/.cache/coursier/
# * check all dependent libs have been downloaded to workspace, e.g. update git submodule
{ config, pkgs, ... }: let
  jre-with-proxy = let
    java-with-proxy = pkgs.writeShellScript "java" ''
      ${pkgs.jre}/bin/java \
        -Dhttp.proxyHost=127.0.0.1 \
        -Dhttp.proxyPort=${toString config.proxyPort} \
        -Dhttps.proxyHost=127.0.0.1 \
        -Dhttps.proxyPort=${toString config.proxyPort} \
        "$@"
    '';
  in pkgs.runCommand "jre_with_proxy" {} ''
    mkdir -p $out
    ${pkgs.xorg.lndir}/bin/lndir -silent ${pkgs.jre} $out
    rm $out/bin/java
    ln -s ${java-with-proxy} $out/bin/java
  '';
in {
  programs.neovim = {
    extraLuaConfig = /*lua*/ ''
      vim.lsp.enable("metals")
    '';
    extraPackages = [
      ((pkgs.metals.override {
        jre=jre-with-proxy;
      }).overrideAttrs (old: {
        extraJavaOpts = toString [
          old.extraJavaOpts
          /*
            User configuration options can optionally be provided via server properties using the -Dmetals. prefix.
            For more user configuration, see: https://scalameta.org/metals/docs/integrations/new-editor/#metals-user-configuration
          */
          # [Note1]: use mill in system, preventing the situation where I can compile but I cannot use metals
          "-Dmetals.millScript=mill"

          # If mill command (specified by millScript) is not found,
          # then metals will use java to run mill.contrib.bloop.Bloop/install
          "-Dmetals.javaHome=${jre-with-proxy}"
        ];
      }))
      (pkgs.coursier.override { jre = jre-with-proxy; })
    ];
    # extraWrapperArgs = [
    #   "--set-default" "JAVA_HOME" "${jre-with-proxy}"
    # ];
  };
  # [Paired with above Note1]:
  # If system does not have mill, then metals will use a 0.5.0 mill script to run:
  # Optional absolute path to a mill executable to use for running
  # `mill mill.contrib.bloop.Bloop/install`.
  # This mill needs JAVA_HOME.
  programs.bash.bashrcExtra = /*bash*/''
    # make .metals/mill happy.
    export JAVA_HOME=${jre-with-proxy};
  '';

  # nvim-metals proxy for bloop
  home.file.jvmopts = {
    text = ''
      -Dhttps.proxyHost=127.0.0.1
      -Dhttps.proxyPort=${toString config.proxyPort}
      -Dhttp.proxyHost=127.0.0.1
      -Dhttp.proxyPort=${toString config.proxyPort}
    '';
    target = ".bloop/.jvmopts";
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim = {
    plugins = [{
      plugin = pkgs.vimPlugins.typst-preview-nvim;
      type = "lua";
      config = /*lua*/ ''
        require ('typst-preview').setup({
          open_cmd = "single-tab %s",
        })
      '';
    }];
    extraLuaConfig = /*lua*/ ''
      -- https://www.reddit.com/r/neovim/comments/1iiqwb1/treesitter_injection_and_priority_issues/
      -- The `@lsp.type.comment.typst` can be obtained by hovering on the text, then `:Inspect`
      -- TLDR: I want to use typst injections.scm,
      --       while treesitter default highlight priority is 100,
      --       typst lsp highlight priority is 125.
      -- My failed attempts:
      -- * (#set! priority ): it only works in highlights.scm, does not work in injections.scm
      --   * See: https://github.com/nvim-treesitter/nvim-treesitter/issues/3110
      -- * Turn of tinymist lsp highlight:
      --   * `semanticTokens = "disable"` does not turn off tinymist lsp syntax highlight.
      -- So current my approach is keeping tinymist lsp highlight,
      -- only clear @lsp.type.comment.typst group.
      vim.api.nvim_set_hl(0, "@lsp.type.comment.typst", {})
      vim.lsp.enable('tinymist')
      vim.api.nvim_create_user_command("TypstExportPdfOnSaveToggle", function(args)
        if vim.lsp.get_clients({name="tinymist"})[1].settings.exportPdf ~= "onSave" then
          -- more settings see https://github.com/Myriad-Dreamin/tinymist/editors/neovim/Configuration.md
          vim.lsp.config("tinymist", {settings = {exportPdf = "onSave"}})
          -- compile and open pdf in evince
          local file_typ = vim.fn.expand('%:p')
          local file_pdf = vim.fn.expand('%:p:r') .. '.pdf'
          vim.system({'bash', '-c',
            'typst compile ' .. file_typ .. ' ' .. file_pdf .. ';' ..
            'evince ' .. file_pdf
          }, { text = true }, function()end)
          print("exportPdf = onSave")
        else
          vim.lsp.config("tinymist", {settings = {exportPdf = "never"}})
          print("exportPdf = never")
        end
        -- restart tinymist lsp, see `:h vim.lsp.enable`
        vim.lsp.enable("tinymist", false)
        vim.lsp.enable("tinymist", true)
      end, {})
    '';
    extraPackages = [ pkgs.tinymist ];
  };
  home.packages = [
    pkgs.typst
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim = {
    plugins = [{
      plugin = pkgs.vimPlugins.nvim-navic;
      type = "lua";
      config = ''
        require("nvim-navic").setup {
          lsp = {
            auto_attach = true,
          },
        }
        -- https://unix.stackexchange.com/questions/224771/what-is-the-format-of-the-default-statusline
        -- %&lt;%f %h%w%m%r%=%-14.(%l,%c%V%) %P
        vim.o.statusline = "%&lt;%f %h%w%m%râ”‡" ..
          -- set maximum width of nvim-navic str: winwidth-40
          -- exec %{%...%} results in '%.xx(yyyy%)', where xx is the max width, yyyy is the navic str
          "%{%'%.' .. (winwidth(0)-40) .. '(' .. v:lua.require'nvim-navic'.get_location() .. '%)'%}" ..
          "%=â”‡%-8.(%l,%c%) %P"
      '';
    }{
      plugin = pkgs.vimPlugins.nvim-navbuddy;
      type = "lua";
      config = ''
        require("nvim-navbuddy").setup {
          lsp = {
            auto_attach = true,
          },
          mappings = {
            ["&lt;S-Tab&gt;"] = require("nvim-navbuddy.actions").parent(),
            ["&lt;Tab&gt;"]   = require("nvim-navbuddy.actions").children(),
          },
        }
      '';
    }];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim = {
    plugins = [{
      plugin = pkgs.vimPlugins.nvim-treesitter-context;
      type = "lua";
      config = /*lua*/ ''
        require'treesitter-context'.setup({enable = false})
        vim.cmd("hi TreesitterContextBottom gui=underline guisp=Grey")
        vim.cmd("hi link TreesitterContext NONE")
        vim.keymap.set("n", "&lt;leader&gt;c", "&lt;Cmd&gt;TSContext toggle&lt;CR&gt;")
      '';
    }];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nvim-treesitter-languages-parsing"><a class="header" href="#nvim-treesitter-languages-parsing">nvim-treesitter: languages parsing</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim = {
    plugins = [{
      # Available languages see:
      #   https://github.com/nvim-treesitter/nvim-treesitter
      # see `pkgs.tree-sitter.builtGrammars.`
      # with `tree-sitter-` prefix and `-grammar` suffix removed
      plugin = pkgs.vimPlugins.nvim-treesitter.withPlugins (_:
      pkgs.vimPlugins.nvim-treesitter.allGrammars ++ [
</code></pre>
<p>When edit a large d2 file using d2-vim, the cursor movement becomes lag.
However, tree-sitter-d2 works fluently.
So I replace the d2-vim with tree-sitter-d2.</p>
<pre><code class="language-nix">        (pkgs.tree-sitter.buildGrammar rec {
          language = "d2";
          # tree-sitter language version 14
          version = "0.5.1";
          src = pkgs.fetchFromGitHub {
            owner = "ravsii";
            repo = "tree-sitter-d2";
            rev = "v${version}";
            hash = "sha256-Ru+EAtnBl+Td4HxHPXLwcXOiFB/NbYPE5AhMNFyP2Kg=";
          };
        })
      ]);
      type = "lua";
      config = /*lua*/''
        require 'nvim-treesitter.configs'.setup {
          -- TODO: https://github.com/NixOS/nixpkgs/issues/189838
          -- ensure_installed = {"c", "cpp", "python", "markdown"},
          ensure_installed = {},
          sync_install = false,
          highlight = {
            enable = true,
          },
        }
      '';
    }];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nvim-window-picker"><a class="header" href="#nvim-window-picker">nvim-window-picker</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim = {
    plugins = [{
      plugin = pkgs.vimPlugins.nvim-window-picker;
      type = "lua";
      config = ''
        require 'window-picker'.setup({
          selection_chars = 'abcdefghijklmnopqrstuvwxyz',
          picker_config = {
            statusline_winbar_picker = {
              selection_display = function(char, windowid)
                return '[' .. char .. ']' .. vim.o.statusline
              end,
            },
          },
          show_prompt = false,
          highlights = {
            statusline = {
              unfocused = {
                fg = '#2c2e34',
                bg = '#7f8490',
                bold = true,
              },
            },
          },
        })
        vim.keymap.set('n', '&lt;C-j&gt;', function()
          vim.api.nvim_set_current_win( require('window-picker').pick_window() )
        end)
        vim.keymap.set('n', '&lt;C-w&gt;j', function()
          vim.api.nvim_set_current_win( require('window-picker').pick_window() )
        end)
      '';
    }];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim = {
    plugins = [{
      plugin = pkgs.vimPlugins.outline-nvim;
      type = "lua";
      config = /*lua*/ ''
        require("outline").setup({
          -- Outline.nvim seems not support setup multiple times
          -- So I merge outline-treesitter-provider's config here
          providers = {
            -- append "treesitter" to original priority
            priority = (function() -- start of a local scope
              local original = require("outline.config").defaults.providers.priority
              table.insert(original, "treesitter")
              return original
            end)(), -- end of a local scope
          },
          outline_window = {
            relative_width = false,
          },
          guides = {
            enabled = false, -- I already have mini indentscope
          },
          symbol_folding = {
            autofold_depth = 99,
          },
          keymaps = {
            close = {}, -- disable close key
          },
        })
        vim.keymap.set('n', '&lt;leader&gt;o', require('outline').toggle)
      '';
    }(
      pkgs.vimUtils.buildVimPlugin {
        name = "outline-treesitter-provider.nvim";
        src = pkgs.fetchFromGitHub {
          owner = "epheien";
          repo = "outline-treesitter-provider.nvim";
          rev = "22dda7329cf608368cbf725effd43daf98c27f32";
          hash = "sha256-PFRiaQPxh+PPFGF1+yMIJIM/tGDOH7CO0xyoayDn78I=";
        };
        doCheck = false;
      }
    )];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="avante-nvim-ai"><a class="header" href="#avante-nvim-ai">avante-nvim: AI</a></h1>
<p>2025.1.27ï¼šä½¿ç”¨ä¸­å‘ç°çš„é—®é¢˜ï¼š</p>
<ul>
<li>æ²¡æœ‰:h</li>
<li>è¯´äº†è¦å»æ‰nuiä½†ä»ç„¶æ²¡æœ‰https://news.ycombinator.com/item?id=41353835</li>
<li>å®‰è£…äº†dressingã€nuiã€plenaryï¼ˆtelescopeéƒ½æ²¡é—®é¢˜ï¼‰æ’ä»¶ä»ç„¶ä¸è¯†åˆ«
<pre><code class="language-vim">avante: require("avante.health").check()

avante.nvim ~
- ERROR Missing required plugin: stevearc/dressing.nvim
- ERROR Missing required plugin: MunifTanjim/nui.nvim
- ERROR Missing required plugin: nvim-lua/plenary.nvim
- OK Found required plugin: nvim-treesitter/nvim-treesitter
- OK Found icons plugin (nvim-web-devicons or mini.icons)
</code></pre>
ç®€å•çœ‹äº†ä»£ç avante checkhealthï¼šlua/avante/utils/init.lua
å±…ç„¶è¦ä½¿ç”¨lazyã€‚æŒ‰claude.aiçš„è¯´æ³•
â€œå•Š,è¿™æ˜¯å®é™…çš„æºç å®ç°,æ¯”æˆ‘ä¹‹å‰è§£é‡Šçš„è¦ç®€å•å¾ˆå¤šã€‚è®©æˆ‘è¯¦ç»†è§£é‡Šä¸€ä¸‹è¿™ä¸ªå‡½æ•°:â€
æ˜¯ä¸æ˜¯å°±æ˜¯å› ä¸ºç®€å•ï¼Œä½†æ˜¯åˆæ²¡æœ‰å¼ºåˆ¶è¦æ±‚å®‰è£…lazyï¼Œé‡åˆ°çš„é—®é¢˜ï¼Ÿ</li>
</ul>
<pre><code class="language-nix">{ lib, pkgs, ... }:
{
  programs.neovim = {
    plugins = with pkgs.pkgsu.vimPlugins; (lib.mkAfter [
      nui-nvim
      dressing-nvim
      {
        plugin = avante-nvim;
        type = "lua";
        config = ''
          require('avante_lib').load()
          require('avante').setup ({
            provider = "deepseek",
            vendors = {
              deepseek = {
                __inherited_from = "openai",
                api_key_name = "DEEPSEEK_API_KEY",
                endpoint = "https://api.deepseek.com",
                model = "deepseek-chat",
              },
            },
          })
        '';
      }
    ]);
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="distant-nvim-edit-remote-files-with-local-nvim"><a class="header" href="#distant-nvim-edit-remote-files-with-local-nvim">distant-nvim: edit remote files with local nvim</a></h1>
<p>ä¸è¶³:</p>
<ul>
<li>æ–‡æ¡£ä¸åœ¨æºç é‡Œï¼Œæ²¡æœ‰:h</li>
<li>æ–‡æ¡£å†™çš„å¾ˆä¸æ¸…æ™°ï¼Œæ‰¾äº†åŠå¤©æ‰çŸ¥é“:DistantConnectå’Œ:DistantOpen</li>
<li>ç°æœ‰nvimæ–‡ä»¶æ“ä½œä¼¼ä¹éƒ½ä¸èƒ½ç”¨ï¼Œæ¯”å¦‚:Exæ¯”å¦‚<leader>ffç­‰ï¼Œéƒ½éœ€è¦ç”¨å®ƒçš„:DistantOpen</li>
<li>ç®€å•å°è¯•äº†xiangshané¡¹ç›®çš„è·³è½¬ï¼Œæ²¡åŠæ³•æ­£å¸¸ä½¿ç”¨ã€‚ä½†æ˜¯sshfsä¸€åˆ‡æ­£å¸¸</li>
</ul>
<pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim = {
    plugins = [{
      plugin = pkgs.pkgsu.vimPlugins.distant-nvim;
      type = "lua";
      config = ''
        require('distant'):setup()
      '';
    }];
    extraPackages = [
      pkgs.pkgsu.distant
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deprecated-remote-sshfsnvim-integrate-sshfs-into-nvim"><a class="header" href="#deprecated-remote-sshfsnvim-integrate-sshfs-into-nvim">Deprecated: remote-sshfs.nvim: integrate sshfs into nvim</a></h1>
<p>Reason of Deprecation: It is better to use sshfs CLI!</p>
<p>In my opinion, sshfs provides a better experience than distant.nvim</p>
<pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim = {
    plugins = [{
      plugin = pkgs.vimUtils.buildVimPlugin {
        pname = "remote-sshfs.nvim";
        version = "2025-2-10";
        src = pkgs.fetchFromGitHub {
          owner = "NOSDuco";
          repo = "remote-sshfs.nvim";
          rev = "03f6c40c4032eeb1ab91368e06db9c3f3a97a75d";
          hash = "sha256-vFEIISxhTIGSl9LzDYHuEIkjLGkU0y5XhfWI/i5DgN4=";
        };
      };
      type = "lua";
      config = ''
        require('telescope').load_extension 'remote-sshfs'
        require('remote-sshfs').setup{
          connections = {
            ssh_configs = {
              vim.fn.expand "$HOME" .. "/.ssh/config",
              vim.fn.expand "$HOME" .. "/Gist/Config/ssh.conf",
              "/etc/ssh/ssh_config",
            },
          },
        }
      '';
    }];
    extraPackages = [
      pkgs.sshfs
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: let
  rustowl-pkgs = (pkgs.flake-compat {
    src = pkgs.fetchFromGitHub {
      owner = "nix-community";
      repo = "rustowl-flake";
      rev = "a84881d43ecd4914b6e2791f7777c6133f489bf9";
      hash = "sha256-ejraI1mCGebB98mH/cIR+GG1UwDTVnZojrHPLFErCxE=";
    };
  }).defaultNix.packages."${builtins.currentSystem}";
  rustowl = rustowl-pkgs.rustowl;
  rustowl-nvim = rustowl-pkgs.rustowl-nvim.overrideAttrs (old: {
    # This patch because:
    # The ftplugin/*.lua, is loaded before init.lua, see `:h init.lua`
    # As a result the user config does not work.
    # (It is this commit cause it: https://github.com/cordx56/rustowl/pull/48)
    # So we move ftplugin/rust.lua to lua/rustowl/autosetup.lua,
    # and call require("rustowl/autosetup") after require("rustowl").setup
    postPatch = ''
      mv ftplugin/rust.lua lua/rustowl/autosetup.lua
    '';
  });
in {
  programs.neovim = {
    plugins = [{
      plugin = rustowl-nvim;
      type = "lua";
      config = /*lua*/ ''
        require("rustowl").setup({
          auto_enable = true,
          highlight_style = 'underline',
          -- drawio preset border colors
          colors = {
            lifetime = '#82B366',
            imm_borrow = '#6C8EBF',
            mut_borrow = '#9673A6',
            move = '#D79B00',
            call = '#D6B656',
            outlive = '#B85450',
          },
        })
        vim.api.nvim_create_autocmd("FileType", {
          pattern = {"rust"},
          callback = function() require("rustowl.autosetup") end
        })
      '';
    }];
    extraPackages = [ rustowl ];
  };

  cachix_packages = [ rustowl rustowl-nvim ];

  # Set the rustowl toolchain, which is a nightly toolchain.
  home.file.rustowl_sysroot = {
    source = rustowl.RUSTOWL_SYSROOTS;
    target = ".rustowl/sysroot/${rustowl.RUSTUP_TOOLCHAIN}";
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="smartyank-nvim-smart-yank-to-clipboard"><a class="header" href="#smartyank-nvim-smart-yank-to-clipboard">smartyank-nvim: smart yank to clipboard</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-smartyank-nvim = {
    plugin = pkgs.vimPlugins.smartyank-nvim;
    type = "lua";
    config = ''
      require('smartyank').setup {
        highlight = {
          enabled = false, -- not enable highlight yanked text
        },
        validate_yank = function() return vim.v.operator == '"+y' end,
      }
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-smartyank-nvim
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># image-nvim vs snacks-nvimé—®é¢˜
# * image-nvim
#   * svgä¼šå˜æˆpngï¼Œéå¸¸ä¸æ¸…æ™°ï¼Œä¹Ÿæ²¡äººæé—®é¢˜
#   * ï¼ˆå¹»ç¯ç‰‡é‡Œï¼‰å›¾ç‰‡å¤šäº†éå¸¸å¡ï¼Œä¼šæ˜¾ç¤ºä¸å‡ºæ¥
#   * æ’ç‰ˆæœ‰é—®é¢˜ï¼Œæ€»æœ‰é”™ä½ï¼Œissuesè¯´è§£å†³äº†ï¼Œæˆ‘è¿™é‡Œç”¨çš„æœ€æ–°ç‰ˆï¼Œä»ç„¶éƒ¨åˆ†æœ‰é—®é¢˜
#   * ç»“è®ºï¼Œä¸å¦‚ç”¨MarkdownPreviewæˆ–snacks-nvim/image
{ pkgs, ... }: {
  programs.neovim = {
    plugins = [{
      plugin = pkgs.vimPlugins.snacks-nvim;
      type = "lua";
      # TODO: [feature: Ability to disable/toggle image inline rendering for buffer #1739](https://github.com/folke/snacks.nvim/issues/1739#issuecomment-3413850508)
      config = /*lua*/ ''
        require("snacks").setup({
          image = {
            enabled = true,
            convert = {
              ---@type table&lt;string,snacks.image.args&gt;
              magick = (function() -- start of a local scope
                original = {
                  default = { "{src}[0]", "-scale", "1920x1080&gt;" }, -- default for raster images
                  vector = { "-density", 192, "{src}[0]" }, -- used by vector images like svg
                  -- math = { "-density", 192, "{src}[0]", "-trim" },
                  pdf = { "-density", 192, "{src}[0]", "-background", "white", "-alpha", "remove", "-trim" },
                }
                -- if vim background is dark then negate the image color
                for _, opts in pairs(original) do
                  if vim.o.background == "dark" then
                    table.insert(opts, "-channel")
                    table.insert(opts, "RGB")
                    table.insert(opts, "-negate")
                  end
                end
                return original
              end)(), -- end of a local scope
            },
          },
          scroll = {
            enabled = true,
          },
        })
      '';
    }];
    extraPackages = [
      # for drawing math.tex as images
      (pkgs.texlive.combine {
        inherit (pkgs.texlive)
        scheme-basic
        standalone
        varwidth
        preview
        mathtools
        xcolor
      ;})
      pkgs.ghostscript
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="telescope-nvim"><a class="header" href="#telescope-nvim">telescope-nvim</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-telescope-nvim = {
    plugin = pkgs.vimPlugins.telescope-nvim;
    type = "lua";
    config = /*lua*/ ''
      -- search relative to file
      -- https://github.com/nvim-telescope/telescope.nvim/pull/902
      vim.keymap.set('n', '&lt;space&gt;f', function() require('telescope.builtin').find_files({cwd=require'telescope.utils'.buffer_dir()}) end)
      vim.keymap.set('n', '&lt;space&gt;F', require('telescope.builtin').find_files)
      vim.keymap.set('n', '&lt;space&gt;b', require('telescope.builtin').buffers)
      vim.keymap.set('n', '&lt;space&gt;h', require('telescope.builtin').help_tags)
      vim.keymap.set('n', '&lt;space&gt;t', require('telescope.builtin').treesitter)
      vim.keymap.set('n', '&lt;space&gt;c', require('telescope.builtin').command_history)
      vim.keymap.set('n', '&lt;space&gt;C', require('telescope.builtin').commands)
    '';
  };
  # Problem: unable to fuzzy search parenthesis '('
  # https://github.com/nvim-telescope/telescope-fzf-native.nvim/issues/141
  my-telescope-fzf-native-nvim = {
    plugin = pkgs.vimPlugins.telescope-fzf-native-nvim;
    type = "lua";
    config = /*lua*/ ''
      require('telescope').setup {
        extensions = {fzf = {}},
        defaults = {
          layout_strategy = 'vertical',
          layout_config = {
            height = 0.95,
            width = 0.95,
            -- do not disable preview
            preview_cutoff = 1,
          },
        },
      }
      require('telescope').load_extension('fzf')
    '';
  };
  my-telescope-live-grep-args-nvim = {
    plugin = pkgs.vimPlugins.telescope-live-grep-args-nvim;
    type = "lua";
    config = /*lua*/ ''
      require('telescope').load_extension("live_grep_args")
      vim.keymap.set('n', '&lt;space&gt;g', function() require("telescope").extensions.live_grep_args.live_grep_args({search_dirs={require"telescope.utils".buffer_dir()}}) end)
      vim.keymap.set('n', '&lt;space&gt;G', require("telescope").extensions.live_grep_args.live_grep_args)
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-telescope-nvim
      my-telescope-fzf-native-nvim
      pkgs.vimPlugins.plenary-nvim
      my-telescope-live-grep-args-nvim
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: let
  # /*lang*//* content... */
  gen_c_style_query = node: set-lang: /*query*/''
    ; extends
    (
      (${node}) @injection.language
      (#lua-match? @injection.language "/%*[%w%p]+%*/")
      .
      (${node}) @injection.content
      (#lua-match? @injection.content "/%*.*%*/")
      (#offset! @injection.content 0 2 0 -2)
      (#gsub! @injection.language "/%*([%w%p]+)%*/" "${if set-lang then "%1" else ""}")
      (#set! injection.combined)
    )
  '';
  gen_c_style_toggle_fn = lang: node: /*lua*/ ''function()
    if _G.${lang}_doccom_injection_enabled then
      vim.treesitter.query.set("${lang}", "injections", [[${gen_c_style_query node false}]])
      _G.${lang}_doccom_injection_enabled = false
    else
      vim.treesitter.query.set("${lang}", "injections", [[${gen_c_style_query node true}]])
      _G.${lang}_doccom_injection_enabled = true
    end
    -- refresh current buffer
    vim.cmd("e")
  end'';
in {
  programs.neovim = {
    extraLuaConfig = /*lua*/ ''
      vim.api.nvim_create_user_command('DoccomInjectionToggle', function()
        local fns = {
          rust = ${gen_c_style_toggle_fn "rust" "block_comment"},
          typst = ${gen_c_style_toggle_fn "typst" "comment"},
        }
        local fn = fns[vim.bo.filetype]
        if fn ~= nil then fns[vim.bo.filetype]() end
      end, {})
    '';
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># DrawIt vs venn-nvim
# * DrawIt is slow when moving cursor adding spaces
{ pkgs, ... }: {
  programs.neovim = {
    plugins = [(
      pkgs.vimPlugins.venn-nvim.overrideAttrs (old: {
        # â–² â–¼ â—€ â–¶
        postPatch = ''
          sed -i 's/â–º/â–¶/' lua/venn/init.lua
          sed -i 's/â—„/â—€/' lua/venn/init.lua
          sed -i 's/â–º/â–¶/' src/primitives/box.lua.t
          sed -i 's/â—„/â—€/' src/primitives/box.lua.t
        '';
      })
    )];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vim-easy-align-a-simple-easy-to-use-vim-alignment-plugin"><a class="header" href="#vim-easy-align-a-simple-easy-to-use-vim-alignment-plugin">vim-easy-align: A simple, easy-to-use Vim alignment plugin.</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-vim-easy-align = {
    plugin = pkgs.vimPlugins.vim-easy-align;
    config = ''
      " Start interactive EasyAlign in visual mode (e.g. vipga)
      xmap ga &lt;Plug&gt;(EasyAlign)

      " Start interactive EasyAlign for a motion/text object (e.g. gaip)
      nmap ga &lt;Plug&gt;(EasyAlign)

      let g:easy_align_delimiters = {
      \ '&gt;': { 'pattern': '&gt;&gt;\|=&gt;\|&gt;' },
      \ '/': {
      \     'pattern':         '//\+\|/\*\|\*/',
      \     'delimiter_align': 'l',
      \     'ignore_groups':   ['!Comment'] },
      \ ']': {
      \     'pattern':       '[\]]',
      \     'left_margin':   0,
      \     'right_margin':  0,
      \     'stick_to_left': 0
      \   },
      \ '[': {
      \     'pattern':       '[\[]',
      \     'left_margin':   0,
      \     'right_margin':  0,
      \     'stick_to_left': 0
      \   },
      \ ')': {
      \     'pattern':       '[)]',
      \     'left_margin':   0,
      \     'right_margin':  0,
      \     'stick_to_left': 0
      \   },
      \ '(': {
      \     'pattern':       '[(]',
      \     'left_margin':   0,
      \     'right_margin':  0,
      \     'stick_to_left': 0
      \   },
      \ }

      let g:easy_align_ignore_groups = [] " default: ['Comment', 'String']
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-vim-easy-align
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vim-floaterm-floating-terminal"><a class="header" href="#vim-floaterm-floating-terminal">vim-floaterm: floating terminal</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim.plugins = [{
    plugin = pkgs.vimPlugins.vim-floaterm;
    config = /*vim*/ ''
      nmap &lt;Leader&gt;t :FloatermNew --cwd=&lt;buffer&gt;&lt;CR&gt;
      nmap &lt;Leader&gt;T :FloatermNew&lt;CR&gt;
      " let g:floaterm_keymap_new = '&lt;Leader&gt;t'
      let g:floaterm_width = 0.8
      let g:floaterm_height = 0.8
    '';
  }];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vim-hexokinase-display-colors"><a class="header" href="#vim-hexokinase-display-colors">vim-hexokinase: display colors</a></h1>
<h2 id="highlight-color-code"><a class="header" href="#highlight-color-code">highlight color code</a></h2>
<p>TLDR: vim-hexokinase isn't perfect but works.
It need works in <code>termguicolors</code> mode.
It is better to choose a color scheme which is visualized in gui mode.
And it is very tricky to setting colors in <code>termguicolors</code> &amp; <code>notermguicolors</code> the same, which is insane.</p>
<p>It would be convenient, if color code can be visualised in editor, especially in web programming.
I found two candidates plugins to achieve this goal,
<a href="https://github.com/ap/vim-css-color">vim-css-color</a>,
<a href="https://github.com/RRethy/vim-hexokinase">vim-hexokinase</a>.</p>
<p>Vim-css-color is not compatible with tree-sitter, due to regex based highlight.
See <a href="https://github.com/ap/vim-css-color/issues/164">Github Issue: Neovim tree sitter support</a> for details.
Vim-css-color sometimes cannot render same text color.
I need to scroll my vim viewport, then it <strong>may</strong> render color correctly.</p>
<p>Vim-hexokinase is good, but must depends on <code>termguicolors</code> is turned on.
<code>termguicolors</code> will enable 24-bit RGB color,
while originally vim uses Base16 color.
The result is the color theme you familiar with will be changed.</p>
<p>Here is the visual comparison between vim-css-color and vim-hexokinase.
I copy these text as html from my vim.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">vcc</th><th style="text-align: center">vcc tgc</th><th style="text-align: center">vh tgc</th></tr></thead><tbody>
<tr><td style="text-align: center"><span style="background-color:#FF0000"><font color="#EEEEEC">#ff0000</font></span></td><td style="text-align: center"><span style="background-color:#FF0000"><font color="#FFFFFF">#ff0000</font></span></td><td style="text-align: center"><span style="background-color:#FF0000"><font color="#FFFFFF">#ff0000</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF0000"><font color="#EEEEEC">#ff1111</font></span></td><td style="text-align: center"><span style="background-color:#FF1111"><font color="#FFFFFF">#ff1111</font></span></td><td style="text-align: center"><span style="background-color:#FF1111"><font color="#FFFFFF">#ff1111</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF0000"><font color="#EEEEEC">#ff2222</font></span></td><td style="text-align: center"><span style="background-color:#FF2222"><font color="#FFFFFF">#ff2222</font></span></td><td style="text-align: center"><span style="background-color:#FF2222"><font color="#FFFFFF">#ff2222</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF0000"><font color="#EEEEEC">#ff3333</font></span></td><td style="text-align: center"><span style="background-color:#FF3333"><font color="#FFFFFF">#ff3333</font></span></td><td style="text-align: center"><span style="background-color:#FF3333"><font color="#FFFFFF">#ff3333</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF5F5F"><font color="#2E3436">#ff4444</font></span></td><td style="text-align: center"><span style="background-color:#FF4444"><font color="#000000">#ff4444</font></span></td><td style="text-align: center"><span style="background-color:#FF4444"><font color="#FFFFFF">#ff4444</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF5F5F"><font color="#2E3436">#ff5555</font></span></td><td style="text-align: center"><span style="background-color:#FF5555"><font color="#000000">#ff5555</font></span></td><td style="text-align: center"><span style="background-color:#FF5555"><font color="#FFFFFF">#ff5555</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF5F5F"><font color="#2E3436">#ff6666</font></span></td><td style="text-align: center"><span style="background-color:#FF6666"><font color="#000000">#ff6666</font></span></td><td style="text-align: center"><span style="background-color:#FF6666"><font color="#FFFFFF">#ff6666</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF8787"><font color="#2E3436">#ff7777</font></span></td><td style="text-align: center"><span style="background-color:#FF7777"><font color="#000000">#ff7777</font></span></td><td style="text-align: center"><span style="background-color:#FF7777"><font color="#FFFFFF">#ff7777</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF8787"><font color="#2E3436">#ff8888</font></span></td><td style="text-align: center"><span style="background-color:#FF8888"><font color="#000000">#ff8888</font></span></td><td style="text-align: center"><span style="background-color:#FF8888"><font color="#FFFFFF">#ff8888</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FF8787"><font color="#2E3436">#ff9999</font></span></td><td style="text-align: center"><span style="background-color:#FF9999"><font color="#000000">#ff9999</font></span></td><td style="text-align: center"><span style="background-color:#FF9999"><font color="#FFFFFF">#ff9999</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FFAFAF"><font color="#2E3436">#ffaaaa</font></span></td><td style="text-align: center"><span style="background-color:#FFAAAA"><font color="#000000">#ffaaaa</font></span></td><td style="text-align: center"><span style="background-color:#FFAAAA"><font color="#000000">#ffaaaa</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FFAFAF"><font color="#2E3436">#ffbbbb</font></span></td><td style="text-align: center"><span style="background-color:#FFBBBB"><font color="#000000">#ffbbbb</font></span></td><td style="text-align: center"><span style="background-color:#FFBBBB"><font color="#000000">#ffbbbb</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FFD7D7"><font color="#2E3436">#ffcccc</font></span></td><td style="text-align: center"><span style="background-color:#FFCCCC"><font color="#000000">#ffcccc</font></span></td><td style="text-align: center"><span style="background-color:#FFCCCC"><font color="#000000">#ffcccc</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FFD7D7"><font color="#2E3436">#ffdddd</font></span></td><td style="text-align: center"><span style="background-color:#FFDDDD"><font color="#000000">#ffdddd</font></span></td><td style="text-align: center"><span style="background-color:#FFDDDD"><font color="#000000">#ffdddd</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#EEEEEE"><font color="#2E3436">#ffeeee</font></span></td><td style="text-align: center"><span style="background-color:#FFEEEE"><font color="#000000">#ffeeee</font></span></td><td style="text-align: center"><span style="background-color:#FFEEEE"><font color="#000000">#ffeeee</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FFFFFF"><font color="#2E3436">#ffffff</font></span></td><td style="text-align: center"><span style="background-color:#FFFFFF"><font color="#000000">#ffffff</font></span></td><td style="text-align: center"><span style="background-color:#FFFFFF"><font color="#000000">#ffffff</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#000000"><font color="#EEEEEC">#000000</font></span></td><td style="text-align: center"><span style="background-color:#000000"><font color="#FFFFFF">#000000</font></span></td><td style="text-align: center"><span style="background-color:#000000"><font color="#FFFFFF">#000000</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#121212"><font color="#EEEEEC">#111111</font></span></td><td style="text-align: center"><span style="background-color:#111111"><font color="#FFFFFF">#111111</font></span></td><td style="text-align: center"><span style="background-color:#111111"><font color="#FFFFFF">#111111</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#262626"><font color="#EEEEEC">#222222</font></span></td><td style="text-align: center"><span style="background-color:#222222"><font color="#FFFFFF">#222222</font></span></td><td style="text-align: center"><span style="background-color:#222222"><font color="#FFFFFF">#222222</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#303030"><font color="#EEEEEC">#333333</font></span></td><td style="text-align: center"><span style="background-color:#333333"><font color="#FFFFFF">#333333</font></span></td><td style="text-align: center"><span style="background-color:#333333"><font color="#FFFFFF">#333333</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#444444"><font color="#EEEEEC">#444444</font></span></td><td style="text-align: center"><span style="background-color:#444444"><font color="#FFFFFF">#444444</font></span></td><td style="text-align: center"><span style="background-color:#444444"><font color="#FFFFFF">#444444</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#585858"><font color="#EEEEEC">#555555</font></span></td><td style="text-align: center"><span style="background-color:#555555"><font color="#FFFFFF">#555555</font></span></td><td style="text-align: center"><span style="background-color:#555555"><font color="#FFFFFF">#555555</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#626262"><font color="#EEEEEC">#666666</font></span></td><td style="text-align: center"><span style="background-color:#666666"><font color="#FFFFFF">#666666</font></span></td><td style="text-align: center"><span style="background-color:#666666"><font color="#FFFFFF">#666666</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#767676"><font color="#EEEEEC">#777777</font></span></td><td style="text-align: center"><span style="background-color:#777777"><font color="#FFFFFF">#777777</font></span></td><td style="text-align: center"><span style="background-color:#777777"><font color="#FFFFFF">#777777</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#878787"><font color="#2E3436">#888888</font></span></td><td style="text-align: center"><span style="background-color:#888888"><font color="#000000">#888888</font></span></td><td style="text-align: center"><span style="background-color:#888888"><font color="#FFFFFF">#888888</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#9E9E9E"><font color="#2E3436">#999999</font></span></td><td style="text-align: center"><span style="background-color:#999999"><font color="#000000">#999999</font></span></td><td style="text-align: center"><span style="background-color:#999999"><font color="#FFFFFF">#999999</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#A8A8A8"><font color="#2E3436">#aaaaaa</font></span></td><td style="text-align: center"><span style="background-color:#AAAAAA"><font color="#000000">#aaaaaa</font></span></td><td style="text-align: center"><span style="background-color:#AAAAAA"><font color="#FFFFFF">#aaaaaa</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#BCBCBC"><font color="#2E3436">#bbbbbb</font></span></td><td style="text-align: center"><span style="background-color:#BBBBBB"><font color="#000000">#bbbbbb</font></span></td><td style="text-align: center"><span style="background-color:#BBBBBB"><font color="#000000">#bbbbbb</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#D0D0D0"><font color="#2E3436">#cccccc</font></span></td><td style="text-align: center"><span style="background-color:#CCCCCC"><font color="#000000">#cccccc</font></span></td><td style="text-align: center"><span style="background-color:#CCCCCC"><font color="#000000">#cccccc</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#DADADA"><font color="#2E3436">#dddddd</font></span></td><td style="text-align: center"><span style="background-color:#DDDDDD"><font color="#000000">#dddddd</font></span></td><td style="text-align: center"><span style="background-color:#DDDDDD"><font color="#000000">#dddddd</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#EEEEEE"><font color="#2E3436">#eeeeee</font></span></td><td style="text-align: center"><span style="background-color:#EEEEEE"><font color="#000000">#eeeeee</font></span></td><td style="text-align: center"><span style="background-color:#EEEEEE"><font color="#000000">#eeeeee</font></span></td></tr>
<tr><td style="text-align: center"><span style="background-color:#FFFFFF"><font color="#2E3436">#ffffff</font></span></td><td style="text-align: center"><span style="background-color:#FFFFFF"><font color="#000000">#ffffff</font></span></td><td style="text-align: center"><span style="background-color:#FFFFFF"><font color="#000000">#ffffff</font></span></td></tr>
</tbody></table>
</div>
<p>Vim-css-color with out <code>termguicolors</code> cannot display color correctly (or say precisely),
if you dont believe your eye, see the source code of this page.</p>
<p>I think vim-hexokinase with a <code>termguicolors</code> toggle is a acceptable compromise.
Toggle <code>termguicolors</code> by <code>:set termguicolors!</code>.
I personally prefer to assign <code>&lt;leader&gt;c</code> to toggle <code>termguicolors</code>.</p>
<h3 id="cterm--gui"><a class="header" href="#cterm--gui">cterm &amp; gui</a></h3>
<p>TLDR: I still haven't find a elegant solution to keep <code>termguicolors</code> and <code>notermguicolors</code> visually same.</p>
<p>neovim has 2 color schemes cterm &amp; gui,
see <code>:h cterm-colors</code> &amp; <code>:h gui-colors</code>.
Default sntax colors are different in these two schemes.
For example, <code>:verbose highlight Comment</code> returns</p>
<pre><code class="language-vim">Comment        xxx ctermfg=14 guifg=#80a0ff
        Last set from /nix/store/pr1pwjjsm3k45rwi3w0xh2296rpymjlz-neovim-unwrapped-0.5.1/share/nvim/runtime/syntax/syncolor.vim
</code></pre>
<p>which means ctermfg uses the 14th color in ANSI colors,
while guifg use a hex color code.
The detailed setting is located in <code>${VIMRUNTIME}/syntax/syncolor.vim</code>.</p>
<p>I create a new syncolor.vim based the default one,
and modify the all ctermfg and guifg to same color name, like below.
The colors in two schemes are still different.</p>
<pre><code class="language-vim">if !exists("syntax_cmd") || syntax_cmd == "on"
  " ":syntax on" works like in Vim 5.7: set colors but keep links
  command -nargs=* SynColor hi &lt;args&gt;
  command -nargs=* SynLink hi link &lt;args&gt;
else
  if syntax_cmd == "enable"
    " ":syntax enable" keeps any existing colors
    command -nargs=* SynColor hi def &lt;args&gt;
    command -nargs=* SynLink hi def link &lt;args&gt;
  elseif syntax_cmd == "reset"
    " ":syntax reset" resets all colors to the default
    command -nargs=* SynColor hi &lt;args&gt;
    command -nargs=* SynLink hi! link &lt;args&gt;
  else
    " User defined syncolor file has already set the colors.
    finish
  endif
endif

" Many terminals can only use six different colors (plus black and white).
" Therefore the number of colors used is kept low. It doesn't look nice with
" too many colors anyway.
" Careful with "cterm=bold", it changes the color to bright for some terminals.
" There are two sets of defaults: for a dark and a light background.
if &amp;background == "dark"
  SynColor Comment	term=bold cterm=NONE ctermfg=Cyan ctermbg=NONE gui=NONE guifg=Cyan guibg=NONE
  SynColor Constant	term=underline cterm=NONE ctermfg=Magenta ctermbg=NONE gui=NONE guifg=Magenta guibg=NONE
  SynColor Special	term=bold cterm=NONE ctermfg=LightRed ctermbg=NONE gui=NONE guifg=LightRed guibg=NONE
  SynColor Identifier	term=underline cterm=bold ctermfg=Cyan ctermbg=NONE gui=bold guifg=Cyan guibg=NONE
  SynColor Statement	term=bold cterm=NONE ctermfg=Yellow ctermbg=NONE gui=NONE guifg=Yellow guibg=NONE
  SynColor PreProc	term=underline cterm=NONE ctermfg=LightBlue ctermbg=NONE gui=NONE guifg=LightBlue guibg=NONE
  SynColor Type		term=underline cterm=NONE ctermfg=LightGreen ctermbg=NONE gui=NONE guifg=LightGreen guibg=NONE
  SynColor Underlined	term=underline cterm=underline ctermfg=LightBlue gui=underline guifg=LightBlue
  SynColor Ignore	term=NONE cterm=NONE ctermfg=black ctermbg=NONE gui=NONE guifg=black guibg=NONE
else
  SynColor Comment	term=bold cterm=NONE ctermfg=DarkBlue ctermbg=NONE gui=NONE guifg=DarkBlue guibg=NONE
  SynColor Constant	term=underline cterm=NONE ctermfg=DarkRed ctermbg=NONE gui=NONE guifg=DarkBlue guibg=NONE
  SynColor Special	term=bold cterm=NONE ctermfg=DarkMagenta ctermbg=NONE gui=NONE guifg=DarkMagenta guibg=NONE
  SynColor Identifier	term=underline cterm=NONE ctermfg=DarkCyan ctermbg=NONE gui=NONE guifg=DarkCyan guibg=NONE
  SynColor Statement	term=bold cterm=NONE ctermfg=Brown ctermbg=NONE gui=bold guifg=Brown guibg=NONE
  SynColor PreProc	term=underline cterm=NONE ctermfg=DarkMagenta ctermbg=NONE gui=NONE guifg=DarkMagenta guibg=NONE
  SynColor Type		term=underline cterm=NONE ctermfg=DarkGreen ctermbg=NONE gui=NONE guifg=DarkGreen guibg=NONE
  SynColor Underlined	term=underline cterm=underline ctermfg=DarkMagenta gui=underline guifg=DarkMagenta
  SynColor Ignore	term=NONE cterm=NONE ctermfg=white ctermbg=NONE gui=NONE guifg=white guibg=NONE
endif
SynColor Error		term=reverse cterm=NONE ctermfg=White ctermbg=Red gui=NONE guifg=White guibg=Red
SynColor Todo		term=standout cterm=NONE ctermfg=Black ctermbg=Yellow gui=NONE guifg=Black guibg=Yellow
</code></pre>
<p>The Magenta is especially dazzling,
and cannot change it by below tries.</p>
<p>Refers to <a href="https://github.com/vim/vim/issues/2353">Change Vim's terminal colors when termguicolors is set #2353</a>,
<a href="http://neovim.io/doc/user/nvim_terminal_emulator.html#nvim-terminal-emulator-configuration">nvim-terminal-emulator-configuration</a>,</p>
<p><code>let g:terminal_color_13 = '#AD7FA8' " Magenta</code> doesn't work.</p>
<p>Finally I choose to add a color-scheme manager,
and choose a theme which has both cterm &amp; gui color scheme.</p>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-vim-hexokinase = {
    plugin = pkgs.vimPlugins.vim-hexokinase;
    config = ''
      let g:Hexokinase_highlighters = ['backgroundfull']
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-vim-hexokinase
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vim-mark-multi-color-highlight"><a class="header" href="#vim-mark-multi-color-highlight">vim-mark: multi-color highlight</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  vim-ingo-library = pkgs.vimUtils.buildVimPlugin {
    name = "vim-ingo-library";
    src = pkgs.fetchFromGitHub {
      owner = "inkarkat";
      repo = "vim-ingo-library";
      rev = "c93c33f803356b16bf4b4d122404d8251dc7b24d";
      hash = "sha256-85h3S+5IjVIbTkYJasPXU+z/ALc9oT+MzdyjvTOhIwg=";
    };
  };
  my-vim-mark = {
    plugin = pkgs.vimUtils.buildVimPlugin {
      name = "vim-mark";
      src = pkgs.fetchFromGitHub {
        owner = "inkarkat";
        repo = "vim-mark";
        rev = "76a25085d7c46f90fd5dfd7c43c3ba05b86ee192";
        hash = "sha256-h2uaZ8dCUopNJ7fpf3BEoZNRk+25zqFukcHa3LomPSk=";
      };
    };
    config = ''
      " clear highlight created by vim-mark
      nnoremap &lt;leader&gt;&lt;F3&gt; :MarkClear&lt;CR&gt;
      " show all marks
      nnoremap &lt;leader&gt;M :Marks&lt;CR&gt;
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-vim-mark
      vim-ingo-library
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  programs.neovim = {
    plugins = [{
      plugin = pkgs.vimPlugins.vim-matchup;
      type = "lua";
      config = /*lua*/ ''
        -- use nvim-treesitter-context to show match lines
        vim.g.matchup_matchparen_offscreen = {}
        -- ä¸è¦åŠ ç²—å…‰æ ‡ä¸‹çš„å¯åŒ¹é…æ–‡å­—ï¼Œä¸ç„¶å†™ä»£ç æ—¶å¸¸é‡åˆ°çš„ä¸åè°ƒæ„Ÿè§‰
        -- æ¯”å¦‚å†™{}æ—¶{æ˜¯æ™®é€šå­—ä½“}æ˜¯åŠ ç²—å­—ä½“ï¼Œå…‰æ ‡å·¦ç§»ä¸€ä¸‹ï¼Œ{å˜æˆåŠ ç²—}æ˜¯æ™®é€šå­—ä½“ã€‚
        vim.cmd("highlight MatchParenCur cterm=NONE gui=NONE")
      '';
    }];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="winshift-nvim-rearrange-windows"><a class="header" href="#winshift-nvim-rearrange-windows">winshift-nvim: rearrange windows</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  my-winshift-nvim = {
    plugin = pkgs.vimPlugins.winshift-nvim;
    type = "lua";
    config = ''
      -- Lua
      require("winshift").setup({
        highlight_moving_win = true,  -- Highlight the window being moved
        focused_hl_group = "Visual",  -- The highlight group used for the moving window
        -- moving_win_options = {
        --   -- These are local options applied to the moving window while it's
        --   -- being moved. They are unset when you leave Win-Move mode.
        --   wrap = true,
        --   cursorline = false,
        --   cursorcolumn = false,
        --   colorcolumn = "",
        -- },
        keymaps = {
          disable_defaults = false, -- Disable the default keymaps
          win_move_mode = {
            ["h"] = "left",
            ["j"] = "down",
            ["k"] = "up",
            ["l"] = "right",
            ["H"] = "far_left",
            ["J"] = "far_down",
            ["K"] = "far_up",
            ["L"] = "far_right",
            ["&lt;left&gt;"] = "left",
            ["&lt;down&gt;"] = "down",
            ["&lt;up&gt;"] = "up",
            ["&lt;right&gt;"] = "right",
            ["&lt;S-left&gt;"] = "far_left",
            ["&lt;S-down&gt;"] = "far_down",
            ["&lt;S-up&gt;"] = "far_up",
            ["&lt;S-right&gt;"] = "far_right",
          },
        },
        ---A function that should prompt the user to select a window.
        ---
        ---The window picker is used to select a window while swapping windows with
        ---`:WinShift swap`.
        ---@return integer? winid # Either the selected window ID, or `nil` to
        ---   indicate that the user cancelled / gave an invalid selection.
        window_picker = function()
          return require("winshift.lib").pick_window({
            -- A string of chars used as identifiers by the window picker.
            picker_chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890",
            filter_rules = {
              -- This table allows you to indicate to the window picker that a window
              -- should be ignored if its buffer matches any of the following criteria.
              cur_win = true, -- Filter out the current window
              floats = true,  -- Filter out floating windows
              filetype = {},  -- List of ignored file types
              buftype = {},   -- List of ignored buftypes
              bufname = {},   -- List of vim regex patterns matching ignored buffer names
            },
            ---A function used to filter the list of selectable windows.
            ---@param winids integer[] # The list of selectable window IDs.
            ---@return integer[] filtered # The filtered list of window IDs.
            filter_func = nil,
          })
        end,
      })

      vim.keymap.set('n', '&lt;C-W&gt;m', '&lt;Cmd&gt;WinShift&lt;CR&gt;')
    '';
  };
in {
  programs.neovim = {
    plugins = [
      my-winshift-nvim
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="usrdefaultnix"><a class="header" href="#usrdefaultnix">usr/default.nix</a></h1>
<p>home-managerçš„å…¥å£é…ç½®æ–‡ä»¶ï¼Œå®ƒå¯¼å…¥äº†ï¼š</p>
<ul>
<li><a href="usr/./usr/cli/default.nix.html"><code>./usr/cli</code></a>ï¼šæˆ‘çš„æ‰€æœ‰CLIç¨‹åºçš„é…ç½®</li>
<li><a href="usr/./usr/gui/default.nix.html"><code>./usr/gui</code></a>ï¼šæˆ‘çš„æ‰€æœ‰GUIç¨‹åºçš„é…ç½®</li>
</ul>
<p>å› ä¸ºéƒ¨åˆ†ç³»ç»Ÿä¸éœ€è¦GUIç¨‹åºï¼Œæ¯”å¦‚å®‰å“æ‰‹æœºnix-on-droidæˆ–æ˜¯æ ‘è“æ´¾ç­‰ã€‚
æˆ‘åˆ©ç”¨ç¯å¢ƒå˜é‡<code>DISPLAY</code>ç”¨äºåˆ¤æ–­æ˜¯å¦å¯¼å…¥GUIç¨‹åºçš„é…ç½®ã€‚</p>
<pre><code class="language-nix">{ ... }: {
  imports = [
    ./modules
    ./cli
    ./gui
  ];
  news.display = "silent";

  programs.bash.bashrcExtra = ''
    . ${toString ../scripts/nix-path.sh}
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, config, ... }: let
  app-id = "cheatsheet_edit";
  open_my_cheatsheet_md_sh = pkgs.writeShellScript "open_my_cheatsheet_md" ''
    cd ${config.home.homeDirectory}/Documents/Tech
    # Open Outline and focus on code
    kitty --app-id ${app-id} nvim my_cheatsheet.mkd -c Outline!
    if [[ ! -f my_cheatsheet.html || my_cheatsheet.html -ot my_cheatsheet.mkd ]]; then
      ~/Codes/MyRepos/markdown_cheatsheet/cheatsheet.sh my_cheatsheet.mkd
    fi
  '';
in {
  xdg.desktopEntries = {
    # singleton apps
    my_cheatsheet_md = {
      name = "Cheatsheet Edit MD";
      genericName = "cheatsheet";
      exec = "${open_my_cheatsheet_md_sh}";
      icon = builtins.toFile "cheatsheet.svg" ''
        &lt;svg width="64" height="64" xmlns="http://www.w3.org/2000/svg"&gt;
          &lt;rect width="100%" height="100%" rx="20%" ry="20%" fill="#666666"/&gt;
          &lt;text x="50%" y="50%" text-anchor="middle" dominant-baseline="middle" font-size="18" font-weight="bold" fill="#F5F5F5"&gt;
            &lt;tspan x="50%" dy="-1.0em"&gt;CS&lt;/tspan&gt;
            &lt;tspan x="50%" dy="1.0em"&gt;Edit&lt;/tspan&gt;
            &lt;tspan x="50%" dy="1.0em"&gt;MD&lt;/tspan&gt;
          &lt;/text&gt;
        &lt;/svg&gt;
      '';
      settings = {
        StartupWMClass = app-id;
      };
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
  xelfviewer = pkgs.callPackage ./xelfviewer.nix {};
in
{
  imports = [
    ./mime.nix
    ./kdeconnect.nix
    ./xdot.nix
    ./firefox
    ./warpd.nix
    ./rustdesk.nix
    ./gnome
    ./kitty
    ./cheatsheet_edit.nix
    ./xcolor.nix
    ./wsl.nix
    ./drawio.nix
    ./flameshot.nix
    ./fcitx5
    # TODO: remove
    ./niri
    ./rofi.nix
    # ./plasma
    # ./hyprland
    ./dms
  ];

config = lib.mkIf config.isGui {
  home.packages = with pkgs; [
    (pkgs.writeShellScriptBin "o" ''nohup xdg-open "$@" &amp;&gt; /dev/null &amp;'')
    libnotify
    # browser
    # dont ask me for keyring chromium-like browsers!
    (chromium.override {commandLineArgs="--password-store=basic";})
  ] ++ [
    # network
  ] ++ pkgs.lib.optionals (builtins.currentSystem=="x86_64-linux") [
    feishu
    (wechat-uos.override {
      buildFHSEnv = args: buildFHSEnv (args // {
        # bubble wrap wechat-uos's home directory
        extraBwrapArgs = ["--bind ${config.home.homeDirectory}/.local/share/wechat-uos /home"];
        chdirToPwd = false;
      });
    })
    # wine weixin waste too much memory, more than 4GB!!!
    #(import ./weixin.nix {})
    # Non-xwayland wemeet will crash with "Segmentation fault", when start a meeting.
    # So we add a WemeetApp-XWayland .desktop file
    wemeet
    (pkgs.makeDesktopItem {
      name = "WemeetApp-XWayland";
      desktopName = "WemeetApp-XWayland";
      exec = "wemeet-xwayland %u";
      icon = "wemeet";
      type = "Application";
      terminal = false;
      categories = ["AudioVideo"];
      mimeTypes = ["x-scheme-handler/wemeet"];
    })
    (nur.repos.xddxdd.dingtalk.overrideAttrs (old: {
      installPhase = builtins.replaceStrings [
        "libcef.so"
        "--prefix LD_PRELOAD"
      ][
        "plugins/dtwebview/libcef.so"
        # Fix: cannot enable executable stack as shared object requires: Invalid argument
        # https://unix.stackexchange.com/questions/792460/dlopen-fails-after-debian-trixie-libc-transition-cannot-enable-executable-st
        "--prefix GLIBC_TUNABLES : glibc.rtld.execstack=2 --prefix LD_PRELOAD"
      ] old.installPhase;
    }))
  ] ++ [
    transmission_4-gtk
    # text
    #wpsoffice
    libreoffice
    meld
    # TODO: use this after switching to wayland
    #wl-clipboard
    textsnatcher
    # draw
    #aseprite-unfree
    inkscape
    gimp
    # viewer
  ] ++ pkgs.lib.optionals (builtins.currentSystem=="x86_64-linux") [
    imhex
    xelfviewer
  ] ++ [
    vlc
    obsidian
  ] ++ pkgs.lib.optionals (builtins.currentSystem=="x86_64-linux") [
    ghidra
  ] ++ [
    # management
  ] ++ pkgs.lib.optionals (builtins.currentSystem=="x86_64-linux") [
    zotero
  ] ++ [
    keepassxc
    # entertainment
    antimicrox
  ];

  # deskflow vs input-leap
  # deskflow not support metakeys: window, alt-tab, alt-f4, ...
  home.file.autostart_input_leap = {
    source = "${pkgs.input-leap}/share/applications/io.github.input_leap.input-leap.desktop";
    target = ".config/autostart/input-leap.desktop";
  };
};}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  pkgs = import &lt;nixpkgs&gt; {};
  dms-src = (pkgs.npinsed {input=./sources.json;}).DankMaterialShell;
  SPEC = pkgs.runCommand "SPEC" {} ''
    awk '/^var SPEC/,/^}/' ${dms-src}/quickshell/Common/settings/SettingsSpec.js &gt; $out
  '';
  configVersion = pkgs.runCommand "configVersion" {} ''
    sed -n 's/.*readonly property int settingsConfigVersion: \([0-9]*\).*/\1/p' \
      ${dms-src}/quickshell/Common/SettingsData.qml | tr -d '\n' &gt; $out
  '';
  gen-settings_js =  pkgs.writeTextFile {
    name = "gen-settings.js";
    text = /*js*/ ''
      const percentToUnit = null;
      ${builtins.readFile SPEC}
      var root = {};
      for (var k in SPEC) {
        if (SPEC[k].persist === false) continue;
        root[k] = SPEC[k].def;
      }
      root.configVersion = ${builtins.readFile configVersion};
      console.log(JSON.stringify(root, null, 2));
    '';
  };
in pkgs.runCommand "settings.json" {} ''
  ${pkgs.nodejs}/bin/node ${gen-settings_js} &gt; $out
''
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  imports = [
    (let
      # TODO: Why does `pkgs` above not work?
      pkgs = import &lt;nixpkgs&gt; {};
      flake-dms = pkgs.flake-compat {
        src = (pkgs.npinsed {input = ./sources.json;}).DankMaterialShell;
      };
    in flake-dms.defaultNix.homeModules.dank-material-shell)
    ./settings.nix
    ./plugins.nix
  ];
  programs.dank-material-shell = {
    enable = true;
    # https://github.com/AvengeMedia/DankMaterialShell/issues/1489
    dgop.package = let
      flake-dgop = pkgs.flake-compat {
        src = (pkgs.npinsed {input = ./sources.json;}).dgop;
      };
    in flake-dgop.defaultNix.packages.${builtins.currentSystem}.default;
  };
  home.packages = [
    # App icons for many apps not showing in App Launcher.
    # https://github.com/AvengeMedia/DankMaterialShell/issues/1132
    pkgs.papirus-icon-theme
    pkgs.adwaita-icon-theme
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  programs.dank-material-shell.plugins = {
    wallpaperBing.src = pkgs.fetchFromGitHub {
      owner = "max72bra";
      repo = "DankPluginBingWallpaper";
      rev = "b6ed00fe037dec84cc4738e87eeec4fb9d4cfedf";
      hash = "sha256-30I7RZk5Wq4vJxL8753QnMG2rplw6b2iOR2vcSQmdw8=";
    };
  };
  yq-merge.".config/DankMaterialShell/plugin_settings.json".text = builtins.toJSON {
    wallpaperBing = {
      enabled = true;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ ... }: let
  settings-relpath = ".config/DankMaterialShell/settings.json";
in {
  yq-merge.${settings-relpath} = {
    preOnChange = ''
      if [[ ! -e ~/${settings-relpath} ]]; then
        cat ${import ./default-settings.nix} &gt; ~/${settings-relpath}
      fi
    '';
    text = builtins.toJSON {
      showDock = true;
      dockAutoHide = true;
      dockOpenOnOverview = true;
      barConfigs = [{
        autoHide = true;
        showOnWindowsOpen = true;
        openOnOverview = true;
        leftWidgets = [
          { enabled = true; id = "launcherButton"; }
          { enabled = true; id = "wallpaperBing"; }
          # { enabled = true; id = "workspaceSwitcher"; }
          { enabled = true; id = "network_speed_monitor"; }
          { enabled = true; id = "focusedWindow"; }
        ];
        centerWidgets = [
          { enabled = true; id = "music"; }
          { enabled = true; id = "clock"; }
          { enabled = true; id = "weather"; }
          { enabled = true; id = "privacyIndicator"; }
        ];
        rightWidgets = [
          { enabled = true; id = "systemTray"; }
          { enabled = true; id = "cpuUsage"; }
          { enabled = true; id = "memUsage"; showSwap = true; }
          { enabled = true; id = "diskUsage"; }
          { enabled = true; id = "clipboard"; }
          { enabled = true; id = "notificationButton"; }
          { enabled = true; id = "battery"; }
          { enabled = true; id = "controlCenterButton"; }
        ];
      }];
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.drawio
  ];
  xdg.mime.types = {
    drawio = {
      name = "draw-io";
      type = "text/draw-io";
      pattern = "*.drawio";
      defaultApp = "drawio.desktop";
    };
  };
  programs.neovim = {
    extraConfig = ''
      augroup filetype
        au! BufRead,BufNewFile *.drawio set filetype=xml
      augroup END
    '';
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p>Thoughts about the volume issue <a href="https://github.com/elkowar/eww/issues/787">Failed to turn `` into a value of type f64</a> and my adoption of eww.
I followed the link to the user's eww configuration (https://github.com/HardoMX/eww/tree/master) and discovered it hasn't been updated in three years.
This made me realize there aren't many eww configuration repositories on GitHub, and most of them haven't been updated for years.
Searching through his repository, I found in his <a href="https://github.com/HardoMX/hypr/blob/3cd672b8df798f7c11cb9efad94846e59b980614/startup.conf#L14">hypr configuration</a>:</p>
<blockquote>
<p>(# exec-once = $HOME/.config/eww/launch_bar.sh # Change away from EWW in progress)
He has switched to waybar instead.
This led me to reconsider: Why does eww have so many GitHub stars, yet people seem to be abandoning it?</p>
</blockquote>
<ul>
<li><strong>Why so many stars:</strong> eww's appearance is visually impressive, creating a great first impression for newcomers.</li>
<li><strong>Why people leave:</strong> The documentation is lacking, and there are persistent bugs that go unfixed.
So my conclusion is eww may not be a good choice for my desktop environment.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  flake-compat = import (builtins.fetchTarball {
    url = "https://github.com/edolstra/flake-compat/archive/0f9255e01c2351cc7d116c072cb317785dd33b33.tar.gz";
    sha256 = "0m9grvfsbwmvgwaxvdzv6cmyvjnlww004gfxjvcl806ndqaxzy4j";
  });
  fabric-flake = flake-compat {
   src = (import &lt;nixpkgs&gt; {}).fetchFromGitHub {
      owner = "Fabric-Development";
      repo = "fabric";
      rev = "7809cc831c701531ea1461b5f0da11c13d78612e";
      hash = "sha256-JkScB31Iq9A3mB4dHTskMTir31pm2AkcpTSU8PIG+qs=";
    };
  };
  pkgs = import fabric-flake.defaultNix.inputs.nixpkgs.outPath {};
  fabric = fabric-flake.defaultNix.packages."${builtins.currentSystem}".default;
in pkgs.mkShell {
  name = "fabric";
  packages = [
    fabric
    pkgs.gtk3
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p>Input method</p>
<p>Why replace ibus with fcitx5</p>
<ul>
<li>ibus mozc not support shift toggle activation</li>
<li>ibus configuration use db, not file</li>
<li>ibus cannot be configured by user (home-manager)</li>
</ul>
<pre><code class="language-nix">{ pkgs, ... }: let
  # è‡ªå»ºæ‹¼éŸ³å­—å…¸
  #   å‚è€ƒï¼šhttps://wiki.archlinux.org/title/Fcitx5
  #         https://github.com/fcitx/libime/blob/master/tools/libime_pinyindict.cpp
  #         TLDR: libime_pinyindictï¼šè¯­æ³•: è¯ pin'yin é¢‘ç‡
  my-dict = pkgs.runCommand "my-fcitx-dict" {} ''
    DIR=$out/share/fcitx5/pinyin/dictionaries
    mkdir -p $DIR
    ${pkgs.libime}/bin/libime_pinyindict ${~/Gist/dicts/fcitx/main.txt} $DIR/main.dict
  '';
in {
  i18n.inputMethod = {
    enable = true;
    type = "fcitx5";
    fcitx5 = {
      addons = [
        pkgs.qt6Packages.fcitx5-chinese-addons
        pkgs.fcitx5-pinyin-zhwiki
        pkgs.fcitx5-mozc-ut
        pkgs.fcitx5-hangul
        my-dict
      ];
    };
  };

  imports = [ ./module.nix ];
  config_fcitx5 = {
    profile = (pkgs.formats.ini {}).generate "profile" {
      "Groups/0" = {
        Name="Default";
        "Default Layout"="us";
      };
      "Groups/0/Items/0" = {
        Name="keyboard-us";
      };
      "Groups/0/Items/1" = {
        Name="pinyin";
      };
      "Groups/0/Items/2" = {
        Name="mozc";
      };
      "Groups/0/Items/3" = {
        Name="hangul";
      };
    };
    config = (pkgs.formats.ini {}).generate "config" {
      "Hotkey" = {
        # Disable default super+space, shift+super+space
        EnumerateGroupForwardKeys="";
        EnumerateGroupBackwardKeys="";
      };
      "Hotkey/TriggerKeys" = {
        "0"="Shift_L";
      };
      "Hotkey/EnumerateForwardKeys" = {
        "0"="Control+space";
      };
      "Hotkey/EnumerateBackwardKeys" = {
        "0"="Control+Shift+space";
      };
    };
    "conf/classicui.conf" = (pkgs.formats.keyValue {}).generate "classicui.conf" {
      Font=''"Sans Serif 16"'';
      MenuFont=''"Sans Serif 16"'';
      TrayFont=''"Sans Serif 16"'';
      Theme="default";
      DarkTheme="default-dark";
      # Follow system light/dark color scheme
      UseDarkTheme="True";
      # Follow system accent color if it is supported by theme and desktop
      UseAccentColor="True";
    };
    "conf/punctuation.conf" = (pkgs.formats.keyValue {}).generate "punctuation.conf" {
      # Half width punctuation after latin letter or number
      HalfWidthPuncAfterLetterOrNumber = "False";
    };
    # simplified/traditional chinese conversion
    "conf/chttrans.conf" = (pkgs.formats.ini {}).generate "chttrans.conf" {
      Hotkey."0" = "Alt+F";
    };
  };
  home.file.punc_mb_zh_CN = {
    source = pkgs.runCommand "punc.mb.zh_CN" {} /*bash*/ ''
      sed '/_ â€”â€”/d' ${pkgs.qt6Packages.fcitx5-chinese-addons}/share/fcitx5/punctuation/punc.mb.zh_CN &gt; $out
      {
      cat &lt;&lt;APPEND
      &lt; &lt;
      &gt; &gt;
      ^ ^
      APPEND
      } &gt;&gt; $out
    '';
    target = ".local/share/fcitx5/punctuation/punc.mb.zh_CN";
  };

  dconf.settings = {
    # Disable ibus input method shortcuts
    "org/gnome/desktop/wm/keybindings" = {
      switch-input-source=[];
      switch-input-source-backward=[];
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, config, lib, ... }: {
  options = {
    config_fcitx5 = lib.mkOption {
      type = lib.types.attrsOf lib.types.path;
      default = {};
      description = ''
        The fcitx5 config files in ~/.config/fcitx5/
      '';
    };
  };
  config = {
    xdg.configFile = lib.mapAttrs' (path: source: lib.nameValuePair
      "config_fcitx5_${baseNameOf path}"
      (let
        relDir = "fcitx5";
        absDir = "${config.xdg.configHome}/${relDir}";
        _path_ = "${dirOf path}/_${baseNameOf path}_";
      in {
        target = "${relDir}/${_path_}";
        inherit source;
        onChange = ''
          if [[ -e ${absDir}/${path} ]]; then
            ${pkgs.crudini}/bin/crudini --merge ${absDir}/${path} &lt; ${absDir}/${_path_}
          else
            cat ${absDir}/${_path_} &gt; ${absDir}/${path}
          fi
        '';
      })
    ) config.config_fcitx5;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><div style="text-align:right; font-size:3em;">2022.05.11</div>
<h1 id="å®‰è£…debåŒ…ä»¥é£ä¹¦ä¸ºä¾‹"><a class="header" href="#å®‰è£…debåŒ…ä»¥é£ä¹¦ä¸ºä¾‹">å®‰è£…debåŒ…ï¼Œä»¥é£ä¹¦ä¸ºä¾‹</a></h1>
<p><strong>å¤ªé•¿ä¸çœ‹</strong></p>
<ul>
<li>nixæ–‡ä»¶: https://github.com/xieby1/nix_config/blob/main/usr/gui/feishu.nix</li>
<li>ä½¿ç”¨æ–¹æ³•:
<pre><code class="language-nix">home.packages = with pkgs; [
  (callPackage ./feishu.nix {})
];
</code></pre>
</li>
</ul>
<p>å‚è€ƒnixpkgs/pkgs/applications/networking/instant-messengers/skypeforlinux/default.nix</p>
<h2 id="æµ‹è¯•ç¯å¢ƒ"><a class="header" href="#æµ‹è¯•ç¯å¢ƒ">æµ‹è¯•ç¯å¢ƒ</a></h2>
<p>nix-build -E "with import <nixpkgs> {}; callPackage ./default.nix {}"</p>
<h2 id="æƒé™é—®é¢˜"><a class="header" href="#æƒé™é—®é¢˜">æƒé™é—®é¢˜</a></h2>
<p>nix-buildé‡åˆ°dpkg -xè§£å‹å¤±è´¥ã€‚
ä½†æ˜¯æ‰‹åŠ¨æ‰§è¡Œdpkg -xä¸€åˆ‡æ­£å¸¸ã€‚</p>
<p>https://unix.stackexchange.com/questions/138188/easily-unpack-deb-edit-postinst-and-repack-deb</p>
<p>ç¡®è®¤æ˜¯æƒé™é—®é¢˜çš„å®éªŒ</p>
<p>æ˜¯sæƒé™çš„é—®é¢˜ã€‚
nix-buildä¸‹ä¸èƒ½æ·»åŠ sæƒé™ã€‚
åŸå› æœªçŸ¥</p>
<p>å¤ç°æ–¹æ³•</p>
<pre><code class="language-bash">touch $out/miao
chmox +s $out/miao
ls -l $out/miao
</code></pre>
<p>è§£å†³æ–¹æ³•ï¼Œä½¿ç”¨fakeroot.</p>
<h2 id="è¡¥å…¨åº“"><a class="header" href="#è¡¥å…¨åº“">è¡¥å…¨åº“</a></h2>
<p>ä½¿ç”¨lddè„šæœ¬ï¼Œè·å–æ‰€æœ‰elfæ‰€éœ€çš„åº“ï¼ŒæŒ¨ä¸ªæ·»åŠ è¿›rpathå³å¯ã€‚</p>
<h2 id="æ¡Œé¢"><a class="header" href="#æ¡Œé¢">æ¡Œé¢</a></h2>
<p>application/<em>.desktop
menu/</em>.menu // è´Ÿè´£å›¾æ ‡</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="firefox-apps"><a class="header" href="#firefox-apps">firefox-apps</a></h1>
<h2 id="comparison-of-chromium-based-browsers-and-firefox"><a class="header" href="#comparison-of-chromium-based-browsers-and-firefox">Comparison of chromium-based browsers and firefox</a></h2>
<ul>
<li>list windows: <code>wmctrl -l</code></li>
<li>list windows properties: <code>xprop -name &lt;WIN_NAME&gt; [PROP]</code></li>
</ul>
<p>second instance of chrome ignores <code>--class</code></p>
<ul>
<li>bing: chrome wm_class new instance
<ul>
<li>https://superuser.com/questions/1457060/how-can-you-start-two-chrome-windows-with-different-wm-class-attributes
<ul>
<li>https://issues.chromium.org/issues/40172351</li>
<li>ç›®å‰çœ‹æ¥æœ€å¥½çš„æ–¹æ³•ï¼š--user-data-dir</li>
<li>firefoxç±»ä¼¼ï¼Œç”¨ä¸åŒçš„profile</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>https://superuser.com/questions/1770285/custom-firefox-profiles-with-different-wm-class-and-icons</p>
<p>set WM_CLASS</p>
<ul>
<li>https://stackoverflow.com/questions/36650865/set-wm-class-with-wnck-xprop-or-something-else
èƒ½æ­£å¸¸è®¾ç½®kittyçš„WM_CLASSï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆchromeä¸è¡Œï¼Ÿ</li>
</ul>
<p>æ‰€ä»¥é€‰æ‹©firefoxï¼</p>
<pre><code class="language-nix">{ config, pkgs, ... }: {
  imports = [
    ./module.nix
    ./single-tab.nix
  ];

  firefox-apps = [{
    name = "ms-todo";
    url = "https://to-do.live.com/";
    desktopEntryExtras = {
      name = "Microsoft To Do";
    };
    keybinding = "&lt;Super&gt;t";
  }{
    name = "ms-calendar"; # avoid singleton xdotool conflicts with system calendar
    url = "https://outlook.live.com/calendar";
    desktopEntryExtras = {
      name = "Microsoft Calendar";
      genericName = "outlook calendar mail";
    };
    keybinding = "&lt;Super&gt;c";
  }{
    name = "webweixin";
    url = "https://wx.qq.com";
    desktopEntryExtras = {
      name = "ç½‘é¡µå¾®ä¿¡";
      genericName = "weixin";
    };
  }{
    name = "my_cheatsheet_html";
    url = "${config.home.homeDirectory}/Documents/Tech/my_cheatsheet.html";
    keybinding = "&lt;Super&gt;space";
    desktopEntryExtras = {
      name = "Cheatsheet HTML";
      genericName = "cheatsheet";
      icon = builtins.toFile "cheatsheet.svg" ''
        &lt;svg width="64" height="64" xmlns="http://www.w3.org/2000/svg"&gt;
          &lt;rect width="100%" height="100%" rx="20%" ry="20%" fill="#666666"/&gt;
          &lt;text x="50%" y="50%" text-anchor="middle" dominant-baseline="middle" font-size="18" font-weight="bold" fill="#F5F5F5"&gt;
            &lt;tspan x="50%" dy="-0.6em"&gt;CS&lt;/tspan&gt;
            &lt;tspan x="50%" dy="1.2em"&gt;html&lt;/tspan&gt;
          &lt;/text&gt;
        &lt;/svg&gt;
      '';
    };
  }{
    name = "bing_dict";
    url = "https://cn.bing.com/dict";
    keybinding = "&lt;Super&gt;b";
    desktopEntryExtras = {
      name = "Bing Dict";
      genericName = "dictionary";
    };
  }{
    name = "riyucidian";
    url = "https://www.mojidict.com";
    keybinding = "&lt;Super&gt;j";
    desktopEntryExtras = {
      name = "æ—¥è¯­è¯å…¸";
    };
  }{
    name = "devdocs";
    url = "https://devdocs.io";
    desktopEntryExtras = {
      name = "DevDocs";
    };
  }(let
    metacubexd = builtins.fetchTarball "https://github.com/MetaCubeX/metacubexd/archive/gh-pages.zip";
  in {
    name = "clash";
    url = "${metacubexd}/index.html";
    desktopEntryExtras = {
      icon = "${metacubexd}/pwa-192x192.png";
    };
  }){
    name = "ai";
    url = "https://web.chatboxai.app";
    desktopEntryExtras = {
      name = "AI Chatbox";
    };
  }{
    name = "deepseek";
    url = "https://chat.deepseek.com";
    keybinding = "&lt;Super&gt;a";
    desktopEntryExtras = {
      name = "DeepSeek";
    };
  }{
    name = "doubao";
    url = "https://www.doubao.com/chat";
    desktopEntryExtras = {
      name = "è±†åŒ…";
    };
  }{
    name = "spotify";
    url = "https://open.spotify.com/search";
    desktopEntryExtras = {
      name = "Spotify (Search)";
    };
  }{
    name = "syncthing";
    url = "http://127.0.0.1:8384";
    icon = "${pkgs.syncthingtray-minimal}/share/icons/hicolor/scalable/apps/syncthingtray.svg";
  }{
    name = "emojidb";
    url = "https://emojidb.org";
    desktopEntryExtras = {
      name = "EmojiDB";
    };
  }{
    name = "wangyiyunyinyue-wyyyy";
    url = "https://music.163.com";
    desktopEntryExtras = {
      name = "ç½‘æ˜“äº‘éŸ³ä¹";
    };
  }];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="firefox-module"><a class="header" href="#firefox-module">firefox module</a></h1>
<pre><code class="language-nix">{ config, pkgs, lib, ... }: let
  singleton = pkgs.writeShellScript "singleton.sh" ''
    if [[ $# -lt 2 || $1 == "-h" ]]
    then
      echo "Usage: ''${0##*/} &lt;wmclass&gt; &lt;command and its args&gt;"
      echo "  Only start a app once, if the app is running"
      echo "  then bring it to foreground"
      exit 0
    fi

    WID=$(${pkgs.xdotool}/bin/xdotool search --class "$1")
    if [[ -z $WID ]]; then
      eval "''${@:2}"
    else
      for WIN in $WID; do
        CURDESK=$(${pkgs.xdotool}/bin/xdotool get_desktop)
        ${pkgs.xdotool}/bin/xdotool set_desktop_for_window $WIN $CURDESK
        ${pkgs.xdotool}/bin/xdotool windowactivate $WIN
      done
    fi
  '';
in {
  options = {
    firefox-apps = lib.mkOption {
      type = lib.types.listOf (lib.types.submodule {
        options = {
          name = lib.mkOption {
            type = lib.types.str;
            default = null;
          };
          url = lib.mkOption {
            type = lib.types.str;
            default = null;
          };
          icon = lib.mkOption {
            type = lib.types.nullOr lib.types.path;
            default = null;
          };
          enableDesktopEntry = lib.mkOption {
            type = lib.types.bool;
            default = true;
          };
          desktopEntryExtras = lib.mkOption {
            type = lib.types.attrs;
            default = {};
            description = "extra settings for desktopEntry, see xdg.desktopEntries.&lt;xxx&gt;";
          };
          keybinding = lib.mkOption {
            default = null;
          };
        };
      });
    };
  };

  config = {
    programs.firefox.profiles = builtins.listToAttrs (
      lib.imap1 (i: firefox-app: {
        name = assert firefox-app.name!=null; firefox-app.name;
        value = {
          id = i;
          extensions.packages = with pkgs.nur.repos.rycee.firefox-addons; [
            # auto open all windows in fullscreen mode
            i-auto-fullscreen
            darkreader
            vimium
            ublock-origin
          ];
          settings = {
            # https://superuser.com/questions/1483037/making-firefox-fullscreen-like-without-actually-maximizing-the-window
            # the full screen hotkey/button will trigger fullscreen like normal, except it won't resize the window.
            "full-screen-api.ignore-widgets" = true;
            # Automatically enable extensions
            "extensions.autoDisableScopes" = 0;
            # https://stackoverflow.com/questions/51081754/cross-origin-request-blocked-when-loading-local-file
            "security.fileuri.strict_origin_policy" = false;
            # enable userChrome.css
            "toolkit.legacyUserProfileCustomizations.stylesheets" = true;
            # disable extensions auto update
            "extensions.update.enabled" = false;
          };
          userChrome = ''
            /* [Disabling the mouseover to reveal the address/toolbar while in fullscreen - old method doesn't work](https://support.mozilla.org/en-US/questions/1324666) */
            /* [prevent firefox from showing the address bar in fullscreen mode](https://support.mozilla.org/en-US/questions/1323320) */
            *|div#fullscr-toggler {display:none!important;}
          '';
        };
      }) config.firefox-apps
    );

    xdg.desktopEntries = let
      firefox-apps-with-desktopEntry = (builtins.filter (firefox-app: firefox-app.enableDesktopEntry) config.firefox-apps);
    in builtins.listToAttrs (
      map (firefox-app: {
        name = assert firefox-app.name!=null; firefox-app.name;
        value = {
          name = firefox-app.name;
          genericName = firefox-app.name;
          exec = assert firefox-app.url!=null;
            # https://superuser.com/questions/1770285/custom-firefox-profiles-with-different-wm-class-and-icons
            "firefox -P ${firefox-app.name} --name ${firefox-app.name} ${firefox-app.url}";
          icon = if firefox-app.icon != null then firefox-app.icon
          else builtins.fetchurl {
            url = "http://www.google.com/s2/favicons?domain=${firefox-app.url}&amp;sz=128";
            name = "${firefox-app.name}.png";
          };
          settings = {
            StartupWMClass = firefox-app.name;
          };
        } // firefox-app.desktopEntryExtras;
      }) firefox-apps-with-desktopEntry
    );

    dconf.settings = let
      firefox-apps-with-keybinding = (builtins.filter (firefox-app: firefox-app.keybinding!=null ) config.firefox-apps);
    in {
      "org/gnome/settings-daemon/plugins/media-keys".custom-keybindings = map (
        firefox-app: "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/${firefox-app.name}/"
      ) firefox-apps-with-keybinding;
    } // (builtins.listToAttrs (
      map (firefox-app: {
        name = "org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/${firefox-app.name}";
        value = {
          binding = firefox-app.keybinding;
          command = "${singleton} ${firefox-app.name} gtk-launch ${firefox-app.name}.desktop";
          name = firefox-app.name;
        };
      }) firefox-apps-with-keybinding
    ));
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: let
  name = "firefox-single-tab";
in {
  firefox-apps = [{
    inherit name;
    url = "";
    icon = builtins.toFile "${name}.svg" ''
      &lt;svg width="64" height="64" xmlns="http://www.w3.org/2000/svg"&gt;
        &lt;rect width="100%" height="100%" rx="20%" ry="20%" fill="white"/&gt;
        &lt;text x="50%" y="50%" text-anchor="middle" dominant-baseline="middle" font-size="14" font-weight="bold" fill="#6155d2"&gt;
          &lt;tspan x="50%" dy="-1em"&gt;Firefox&lt;/tspan&gt;
          &lt;tspan x="50%" dy="1em"&gt;Single&lt;/tspan&gt;
          &lt;tspan x="50%" dy="1em"&gt;Tab&lt;/tspan&gt;
        &lt;/text&gt;
      &lt;/svg&gt;
    '';
  }];

  home.packages = map (n: (
    # https://superuser.com/questions/1770285/custom-firefox-profiles-with-different-wm-class-and-icons
    pkgs.writeScriptBin n ''
      nohup firefox -P ${name} --name ${name} --new-window "$@" &amp;&gt; /dev/null &amp;
    ''
  )) [name "single-tab"];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="firefox-configurations"><a class="header" href="#firefox-configurations">firefox configurations</a></h1>
<pre><code class="language-nix">{ pkgs, config, ... }:
{
  imports = [
    ./apps
    ./extensions
  ];
  programs.firefox = {
    enable = true;
    # If state versionÂ â‰¥Â 19.09 then this should be a wrapped Firefox
    package = pkgs.firefox.overrideAttrs (old: {
      # MOZ_USE_XINPUT2=1 allow more smooth (pixel-level) scroll and zoom
      buildCommand = old.buildCommand + ''
        mv $out/bin/firefox $out/bin/firefox-no-xinput2
        makeWrapper $out/bin/firefox-no-xinput2 $out/bin/firefox --set-default MOZ_USE_XINPUT2 1
      '';
    });
    # id is default 0, thus this profile is default
    profiles.xieby1 = {
      settings = {
        # https://superuser.com/questions/1483037/making-firefox-fullscreen-like-without-actually-maximizing-the-window
        # the full screen hotkey/button will trigger fullscreen like normal, except it won't resize the window.
        "full-screen-api.ignore-widgets" = true;
        # Disable `alt` key of toggling menu bar
        "ui.key.menuAccessKeyFocuses" = false;
        "ui.key.menuAccessKey" = -1; # original number 18
        # enable userChrome.css
        "toolkit.legacyUserProfileCustomizations.stylesheets" = true;

        # Bookmark import only triggered when first open firefox.
        # Bookmark exposure only triggered when all firefox instances are closed.
        # As a result, there are so many sync conflicts!
        # # enable bookmarks sync to file
        # "browser.bookmarks.autoExportHTML" = true;
        # "browser.bookmarks.file" = "${config.home.homeDirectory}/Gist/Config/firefox-bookmarks.html";
        # "browser.places.importBookmarksHTML" = true;
      };
      userChrome =
      # [Disabling the mouseover to reveal the address/toolbar while in fullscreen - old method doesn't work](https://support.mozilla.org/en-US/questions/1324666)
      # [prevent firefox from showing the address bar in fullscreen mode](https://support.mozilla.org/en-US/questions/1323320)
      ''
        *|div#fullscr-toggler {display:none!important;}
      '';
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  programs.firefox = {
    profiles.xieby1 = {
      extensions.packages = [ pkgs.nur.repos.rycee.firefox-addons.brotab ];
    };
  };

  home.packages = [ pkgs.brotab ];
  home.file.brotab_mediator = rec {
    target = ".mozilla/native-messaging-hosts/brotab_mediator.json";
    source = pkgs.runCommand "brotab_mediator" {} ''
      export HOME=.
      ${pkgs.brotab}/bin/brotab install
      cp ${target} $out
    '';
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  programs.firefox.profiles.xieby1.extensions.packages = [(
    pkgs.nur.repos.rycee.firefox-addons.buildFirefoxXpiAddon {
      pname = "chrome-mask";
      version = "8.0.0";
      addonId = "chrome-mask@overengineer.dev";
      url = "https://addons.mozilla.org/firefox/downloads/file/4618461/chrome_mask-8.0.0.xpi";
      sha256 = "0w11la8sgg9pyw5zl3ki679g3353qxrd14gd0jq9m3i4fx35d250";
      meta = {
        mozPermissions = [ "storage" "tabs" "webRequest" "webRequestBlocking" "&lt;all_urls&gt;" ];
        platforms = pkgs.lib.platforms.all;
      };
    }
  )];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: let
  darkreader = pkgs.nur.repos.rycee.firefox-addons.darkreader;
in {
  programs.firefox = {
    profiles.xieby1 = {
      extensions.packages = [ darkreader ];
    };
  };
  firefox-extensions.xieby1.browser-extension-data."${darkreader.addonId}" = {
    storage = {
      schemeVersion = 2;
      syncSettings = false;
      disabledFor = [
        # markdown-preview-nvim: x.x.x.x:7768
        # markdown_revealjs daemon: x.x.x.x:7782
        "/.*:77[0-9][0-9]/"
        # markdown_revealjs
        "//home/.*/slides/index.html/"
      ];
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  # How to self package a firefox extension?
  # 1. Add the addon to firefox manually (by firefox addon store or ...)
  # 2. Get needed info by ~/.mozilla/firefox/xieby1/extensions.json
  imports = [
    ./module.nix

    ./sidebery.nix
    ./darkreader.nix
    ./smartproxy.nix
    ./smart-toc.nix
    ./brotab.nix
    ./vimium.nix
    ./chrome-mask.nix
  ];

  programs.firefox = {
    profiles.xieby1 = {
      extensions.packages = with pkgs.nur.repos.rycee.firefox-addons; [
        # ğŸ˜¾ğŸ˜¾ğŸ˜¾ Chinese users cannot use ad block extensions
        # https://discourse.mozilla.org/t/chinese-users-cant-use-ad-blocker-extensions/94823
        ublock-origin
        auto-tab-discard
        refined-github
        furiganaize
      ];
      settings = {
        # Automatically enable extensions
        "extensions.autoDisableScopes" = 0;
        # Disable extension auto update
        "extensions.update.enabled" = false;
      };
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, lib, ... }: {
  options = {
    firefox-extensions = lib.mkOption {
      #      per-profile
      type = lib.types.attrsOf (lib.types.submodule { options = {
        browser-extension-data = lib.mkOption {
          #      per-extension
          type = lib.types.attrsOf (lib.types.submodule { options = {
            storage = lib.mkOption {
              type = lib.types.attrs;
              default = {};
              description = ''
                Attrs that will be converted to json and merged to storage.js
              '';
            };
          };});
        };
        extension-settings = lib.mkOption {
          type = lib.types.mkOptionType {
            name = "attrsRecursiveUpdate";
            description = "attribute set";
            check = lib.isAttrs;
            merge = loc: lib.foldl' (res: def: lib.recursiveUpdate res def.value) { };
            emptyValue = {
              value = { };
            };
          };
          default = {};
          description = ''
            The extension-settings.json
          '';
        };
      };});
      default = {};
      description = ''
        Attrs of firefox-extensions settings

        You may ask: why not using `programs.firefox.profiles.&lt;name&gt;.extensions.settings`?
        Because it do not support partially updating the settings.

        Example:

        firefox-extensions = {
          profile0 = {
            browser-extension-data = {
              darkreader = {
                storage = {
                  schemeVersion = 2;
                  syncSettings = false;
                  disabledFor = [
                    "http://127.0.0.1:7768"
                  ];
                };
              };
            };
            extension-settings = {
              ...
            };
          };
          profile1 = {...};
        };
      '';
    };
  };

  config = {
    yq-merge = (builtins.listToAttrs (lib.flatten (
      lib.mapAttrsToList (profile: per-profile-settings: (
        lib.mapAttrsToList (extensionId: per-extension-settings: {
          name = "${config.programs.firefox.configPath}/${profile}/browser-extension-data/${extensionId}/storage.js";
          value.text = builtins.toJSON per-extension-settings.storage;
        }) per-profile-settings.browser-extension-data
      )) config.firefox-extensions
    ))) // (
      lib.mapAttrs' (profile: per-profile-settings: {
        name = "${config.programs.firefox.configPath}/${profile}/extension-settings.json";
        value.text = builtins.toJSON ({
          version = 3;
        } // per-profile-settings.extension-settings);
      }) config.firefox-extensions
    );

    programs.firefox.profiles = lib.mapAttrs (profile: _: {
      settings = {
        "extensions.webextensions.ExtensionStorageIDB.enabled" = false;
      };
    }) config.firefox-extensions;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># TIPS (https://github.com/piroor/treestyletab/wiki/How-to-inspect-tree-of-tabs):
# How to start debugger?
# 1. Type about:debugging into the address bar and hit the Enter key.
# 2. Choose "This Firefox" at the left pane.
# 3. Find "Tree Style Tab" from the list and click the Inspect button.
# 4. Then a debugger tab is opened.
#
# How to inspect the sidebar?
# 1. Start the debugger for TST.
# 2. On the top-right corner of the debugger window, there are some buttons, so click the Select an iframe as the currently targeted document button.
# 3. Choose /sidebar/sidebar.html from the list.
#   3.1. If you are opening multiple browser windows with their sidebar, you'll see multiple entries in the list.
#   3.2. /sidebar/sidebar.html items are sorted by the order they are initialized. If you hope to inspect the sidebar in the first browser window, you should choose first /sidebar/sidebar.html item in the list.
# 4. Choose the Inspector tab.

{ pkgs, ... }: let
  sidebery = pkgs.nur.repos.rycee.firefox-addons.sidebery;
in {
  programs.firefox = {
    profiles.xieby1 = {
      extensions.packages = [ sidebery ];
      # transparent floating sidebar
      # Why not use it?
      # Because: I tried two ways to adjust the height of sidebar dynamically, but all failed:
      # * user.js cannot inject js code
      # * css counter cannot used in height
      #
      #settings = {
      #  "browser.tabs.allow_transparent_browser" = true;
      #};
      #userChrome = ''
      #  #sidebar-box {
      #    height: 90%;
      #    top: 5%;
      #    right: 0;
      #    position: absolute;
      #    z-index: 99;
      #  }
      #  #browser,
      #  tabbox#tabbrowser-tabbox,
      #  #tabbrowser-tabpanels,
      #  #sidebar-box,
      #  #sidebar,
      #  window#webextpanels-window {
      #    background-color: transparent !important;
      #    background-image: none !important;
      #  }
      #'';
      #userContent = ''
      #  @-moz-document regexp("^moz-extension://.*/sidebar/sidebar.html") {
      #    :root {
      #      background-color: transparent !important;
      #    }
      #    #root.root {
      #      --frame-bg: transparent !important;
      #      --toolbar-bg: black !important;
      #      --frame-el-bg: black !important;
      #    }
      #  }
      #'';
      settings = {
        "sidebar.position_start" = false; # sidebar on the right
      };
      userChrome = ''
        /* Completely Remove Firefox Tab Bar */
        /* https://bricep.net/completely-remove-firefox-tab-bar/ */
        #TabsToolbar { visibility: collapse !important; }

        #sidebar-header { display: none; }
        #sidebar-splitter { display: none; }
        #sidebar-box {
          width: 13vw !important;
          min-width: 8em !important;
          max-width: 15em !important;
          padding: 0 !important;
        }
      '';
    };
  };

  firefox-extensions.xieby1 = {
    extension-settings = {
      commands = {
        # toggle sidebery
        _execute_sidebar_action = { precedenceList = [{
           id = sidebery.addonId;
           installDate = 0;
           value = { shortcut = "F1"; };
           enabled = true;
        }];};
        search = { precedenceList = [{
          id = sidebery.addonId;
          installDate = 0;
          value = { shortcut = "F2"; };
          enabled = true;
        }];};
        up_shift = { precedenceList = [{
          id = sidebery.addonId;
          installDate = 0;
          value = { shortcut = "Alt+Shift+Left"; };
          enabled = true;
        }];};
        down_shift = { precedenceList = [{
          id = sidebery.addonId;
          installDate = 0;
          value = { shortcut = "Alt+Shift+Right"; };
          enabled = true;
        }];};
        rm_tab_on_panel = { precedenceList = [{
          id = sidebery.addonId;
          installDate = 0;
          value = { shortcut = "Alt+Shift+Delete"; };
          enabled = true;
        }];};
        switch_to_next_tab = { precedenceList = [{
          id = sidebery.addonId;
          installDate = 0;
          value = { shortcut = "Alt+Shift+Down"; };
          enabled = true;
        }];};
        switch_to_prev_tab = { precedenceList = [{
          id = sidebery.addonId;
          installDate = 0;
          value = { shortcut = "Alt+Shift+Up"; };
          enabled = true;
        }];};
      };
    };
  };
  firefox-extensions.xieby1.browser-extension-data."${sidebery.addonId}" = {
    storage = {
      sidebarCSS = /*css*/ ''
        #root.root {
          /* make vertical line more clear */
          /* original: --tabs-lvl-opacity: 0.16 */
          --tabs-lvl-opacity: 0.8;
          /* white border for activated tab */
          --tabs-activated-shadow: 0 0 0 1px white;
        }
        /* make sure the top tab shadow (--tabs-activated-shadow) is not clipped */
        /* Why not using border?
           Because border will add size to the div, thus changing the layout.
           As a result, the vertical line is not aligned.
        */
        .AnimatedTabList { padding-top: 1px; }

        /* compact fav margin */
        .Tab[data-pin="false"] .fav {
          /* original: 0 var(--tabs-inner-gap)0 calc(var(--tabs-inner-gap) + 2px); */
          margin: 0;
        }
      '';
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, lib, ... }: let
  smart-toc = pkgs.nur.repos.rycee.firefox-addons.buildFirefoxXpiAddon {
    pname = "smart-toc";
    version = "0.11.25";
    addonId = "{40289693-01fe-4740-91ae-07344bf5b09b}";
    url = "https://addons.mozilla.org/firefox/downloads/file/4485577/smart_toc-0.11.25.xpi";
    sha256 = "17jpqy2qs3qc1m9l4kbqw14m5bkwfzb253wpf1x1b5p9q6sap8w8";
    meta = with lib; {
      mozPermissions = [
        "activeTab"
        "scripting"
        "storage"
        "tabs"
        "*://*/*"
        "file:///*"
      ];
      platforms = platforms.all;
    };
  };
in {
  programs.firefox = {
    profiles.xieby1 = {
      extensions.packages = [ smart-toc ];
    };
  };
  firefox-extensions.xieby1 = {
    extension-settings = {
      commands = {
        toggle = {precedenceList = [{
          id = smart-toc.addonId;
          installDate = 0;
          value = { shortcut = "Alt+E"; };
          enabled = true;
        }];};
      };
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, ... }: let
  inherit (pkgs.nur.repos.rycee.firefox-addons) smartproxy;
in {
  programs.firefox = {
    profiles.xieby1 = {
      extensions.packages = [ smartproxy ];
    };
  };
  firefox-extensions.xieby1 = {
    browser-extension-data."${smartproxy.addonId}" = {
      storage = {
        activeProfileId = "InternalProfile_SmartRules";
        defaultProxyServerId = "defaultProxyServerId";
        proxyServers = [{
          name = "nix";
          id = "defaultProxyServerId";
          order = 0;
          host = "127.0.0.1";
          port = config.proxyPort;
          protocol = "HTTP";
          username = "";
          password = "";
          proxyDNS = true;
          failoverTimeout = null;
        }];
        proxyProfiles = [{
          profileName = "Smart Proxy";
          profileId = "InternalProfile_SmartRules";
          profileProxyServerId = "defaultProxyServerId";
          profileType = 2;
          enabled = true;
          rulesSubscriptions = [{
            enabled = true;
            refreshRate = 6000;
            id = "gfwlist";
            name = "gfwlist";
            url = "https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt";
            obfuscation = "Base64";
            format = 0;
            applyProxy = 1;
            username = "";
            password = "";
          }];
          profileTypeConfig =  {
            builtin = true;
            editable = true;
            selectable = true;
            supportsSubscriptions = true;
            supportsProfileProxy = true;
            customProxyPerRule = true;
            canBeDisabled = true;
            supportsRuleActionWhitelist = true;
            defaultRuleActionIsWhitelist = false;
          };
        }];
      };
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, lib, ... }: let
  inherit (pkgs.nur.repos.rycee.firefox-addons) vimium;
in {
  programs.firefox = {
    profiles.xieby1 = {
      extensions.packages = [
        vimium
      ];
    };
  };

  home.file.vimium_sql = let
    # retrieve json:
    # sqlite3 storage-sync-v2.sqlite "SELECT data FROM storage_sync_data WHERE ext_id='{d7742d87-e61d-4b78-b8a1-b469842139fa}';"
    json = /*json*/ ''{
      "exclusionRules": [{
        "passKeys": "",
        "pattern": "*:77[0-9][0-9]*"
      }],
      "settingsVersion": "${lib.removePrefix "vimium-" vimium.name}"
    }'';
    relDir = "${config.programs.firefox.profilesPath}/xieby1";
    absDir = "${config.home.homeDirectory}/${relDir}";
    relTarget = "${relDir}/browser-extension-data/${vimium.addonId}/sql";
    absTarget = "${config.home.homeDirectory}/${relTarget}";
  in {
    text = /*sql*/ "UPDATE storage_sync_data SET data = '${json}' WHERE ext_id = '${vimium.addonId}';";
    target = relTarget;
    onChange = /*bash*/ ''
      if [[ -e ${absDir}/storage-sync-v2.sqlite ]]; then
        echo â› updating vimium settings in ${absDir}/storage-sync-v2.sqlite
        ${pkgs.sqlite}/bin/sqlite3 ${absDir}/storage-sync-v2.sqlite &lt; ${absTarget}
      else
        echo â›ƒ next time update vimium settings in ${absDir}/storage-sync-v2.sqlite
        rm ${absTarget}
      fi
    '';
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p>Advanced screenshot: flameshot</p>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.flameshot
  ];
  dconf.settings = {
    "org/gnome/shell/keybindings" = {
      screenshot = [];
      screenshot-window = [];
      show-screen-recording-ui = [];
      show-screenshot-ui = ["&lt;Shift&gt;Print"];
    };
    "org/gnome/settings-daemon/plugins/media-keys".custom-keybindings = [
      "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/flameshot/"
    ];
    "org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/flameshot" = {
      binding="Print";
      command="${pkgs.flameshot}/bin/flameshot gui";
      name="flameshot";
    };
  };
  home.file.autostart_flameshot = {
    source = "${pkgs.flameshot}/share/applications/org.flameshot.Flameshot.desktop";
    target = ".config/autostart/org.flameshot.Flameshot.desktop";
  };
  systemd.user.tmpfiles.rules = [
    "L? %h/.config/flameshot/flameshot.ini - - - - %h/Gist/Config/flameshot.ini"
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, ... }: {
  imports = [
    ./module.nix
    { # my private calendars
      gnome-calendar = let
        caldavs = "${config.home.homeDirectory}/Gist/Vault/caldavs.nix";
      in if builtins.pathExists caldavs then import caldavs else {};
    }
  ];

  # public calendars
  gnome-calendar = {
    china_calendar = {
      # åŒ…å«æ‰€æœ‰ç±»å‹æ—¥å†ï¼ˆæš‚æ—¶é™¤å†œå†ã€å¤©å¹²åœ°æ”¯ï¼‰(æ—¶é—´æ®µç‰ˆæœ¬)
      url = "https://yangh9.github.io/ChinaCalendar/calendar_1.ics";
      settings = {
        Calendar = {
          Color = "#82B366";
        };
        # do not show notifications for this calendar
        Alarms = {
          IncludeMe = false;
          ForEveryEvent = false;
        };
      };
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gnome-calendar-module"><a class="header" href="#gnome-calendar-module">gnome-calendar module</a></h1>
<pre><code class="language-nix">{ config, pkgs, lib, ... }: {
  options = {
    gnome-calendar = lib.mkOption {
      # entry type
      type = lib.types.attrsOf (lib.types.submodule {
        options = {
          url = lib.mkOption {
            type = lib.types.str;
            default = "";
          };
          settings = lib.mkOption {
            type = lib.types.attrs;
            default = {};
          };
        };
      });
      default = {};
      description = ''
        Attrs of calendars settings.

        gnome-calendar = {
          calendar1 = {
            url = "...calendar1.ics";
            settings = {...calendar1 settings...}
          };
          calendar2 = {
            url = "...calendar2.ics";
            settings = {...calendar2 settings...}
          };
          ...
        };
      '';
    };
  };

  config = {
    # Available options: &lt;evolution-data-server&gt;/glib-2.0/schemas/org.gnome.evolution-data-server.calendar.gschema.xml
    dconf.settings."org/gnome/evolution-data-server/calendar" = {
      # Currently, cannot use audio, otherwise no notification pops out.
      # * https://gitlab.gnome.org/GNOME/gnome-calendar/-/issues/1226
      #   * https://gitlab.gnome.org/GNOME/gnome-calendar/-/issues/1280
      notify-enable-audio = false;
      notify-enable-display = true;

      # Default reminder for all events in chosen calendars
      defall-reminder-enabled = true;
      # defall-reminder-interval = 15
      # defall-reminder-units = minutes
    };
    home.file = lib.mapAttrs (name: entry:
      let
        parseUrl = urlString:
        let
          protocolSplit = lib.strings.splitString "://" urlString;
          protocol = builtins.head protocolSplit;
          afterProtocol = builtins.elemAt protocolSplit 1;
          hostPathSplit = lib.strings.splitString "/" afterProtocol;
          host = builtins.head hostPathSplit;
          path = "/" + lib.strings.concatStringsSep "/" (builtins.tail hostPathSplit);
        in {
          inherit protocol host path;
          port = if protocol == "http" then 80
            else if protocol == "https" then 443
            else throw "unknown protocol: ${protocol}";
          security = if protocol == "https" then "tls"
            else "";
        };
        parsedUrl = parseUrl entry.url;
        mergeCfg = lib.foldl lib.recursiveUpdate {};
        cal_cfg = mergeCfg [
          (import ./template.nix)
          {
            "Data Source" = {
              DisplayName = name;
            };
            Authentication = {
              Host=parsedUrl.host;
              Port=parsedUrl.port;
            };
            Security = {
              Method=parsedUrl.security;
            };
            "WebDAV Backend" = {
              ResourcePath=parsedUrl.path;
            };
          }
          entry.settings
        ];
        src = (pkgs.formats.ini {}).generate "${name}.source" cal_cfg;
        dst = "${config.home.homeDirectory}/.config/evolution/sources/${name}.source";
      # Why not using yq, due to Color=#xxxxxx, '#' will be identified as comment, and be striped
      in rec {
        target = ".config/evolution/sources/${name}.source.onChange";
        source = (pkgs.formats.ini {}).generate "${name}.source" cal_cfg;
        onChange = ''
          sed 's/LastNotified=.*/LastNotified='$(date -u +"%Y-%m-%dT%H:%M:%SZ")'/g' \
            ${target} &gt; ${lib.removeSuffix ".onChange" target}
        '';
      }
    ) config.gnome-calendar;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{
  "Data Source" = {
    DisplayName = "toBeFilled";
    Enabled=true;
    Parent="webcal-stub";
  };
  Authentication = {
    Host= "toBeFilled";
    Method="plain/password";
    Port=443;
    ProxyUid="system-proxy";
    RememberPassword=true;
    User="";
    CredentialName="";
    IsExternal=false;
  };
  Security = {
    Method="tls";
  };
  "WebDAV Backend" = {
    AvoidIfmatch=false;
    CalendarAutoSchedule=false;
    Color="";
    DisplayName="";
    EmailAddress="";
    ResourcePath= "toBeFilled";
    ResourceQuery="";
    SslTrust="";
    Order=4294967295;
    Timeout=90;
  };
  Calendar = {
    BackendName="webcal";
    Color = "#B85450";
    Selected=true;
    Order=0;
  };
  Offline = {
    StaySynchronized=true;
  };
  Refresh = {
    Enabled=true;
    EnabledOnMeteredNetwork=true;
    IntervalMinutes=30;
  };
  Alarms = {
    IncludeMe=true;
    # LastNotified="2025-02-24T13:27:00Z";
    LastNotified="";
    ForEveryEvent=true;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p>Gnome settings</p>
<pre><code class="language-nix">{ config, pkgs, lib, ... }: {
  imports = [
    ./calendar
    ./extensions
  ];
  home.packages = with pkgs; [
    gnome-sound-recorder
    dconf-editor
    devhelp
  ];

  # Setting: `gsettings set &lt;key(dot)&gt; &lt;value&gt;`
  # Getting: `dconf dump /&lt;key(path)&gt;`
  dconf.settings = {
    "org/gnome/shell" = {
      ## dock icons
      favorite-apps = [
        "org.gnome.Nautilus.desktop"
        "firefox.desktop"
        "firefox-single-tab.desktop"
        "chromium-browser.desktop"
        "wangyiyunyinyue-wyyyy.desktop"
        "spotify.desktop"
      ];
    };
    "org/gnome/shell/keybindings" = {
      # disable original super+A
      toggle-application-view = [];
    };

    "org/gnome/desktop/session" = {
      idle-delay=lib.hm.gvariant.mkUint32 0; # never turn off screen
    };
    "org/gnome/settings-daemon/plugins/power" = {
      ambient-enabled=false;
      idle-dim=false;
      power-button-action="nothing";
      sleep-inactive-ac-timeout=3600;
      sleep-inactive-ac-type="nothing";
      sleep-inactive-battery-type="suspend";
    };

    # predefined keyboard shortcuts
    "org/gnome/desktop/wm/keybindings" = {
      switch-applications=[];
      switch-applications-backward=[];
      switch-windows=["&lt;Alt&gt;Tab"];
      switch-windows-backward=["&lt;Shift&gt;&lt;Alt&gt;Tab"];
      maximize=["&lt;Super&gt;Up"];
      unmaximize=["&lt;Super&gt;Down"];
      minimize=[];
      move-to-workspace-left=["&lt;Control&gt;&lt;Super&gt;Left"];
      move-to-workspace-right=["&lt;Control&gt;&lt;Super&gt;Right"];
      # Disable alt+space binding
      activate-window-menu=[];
    };

    # nautilus
    "org/gtk/settings/file-chooser" = {
      sort-directories-first=true;
    };

    "org/gnome/desktop/interface" = {
      enable-hot-corners=false;
      show-battery-percentage=true;
      clock-show-weekday=true;
    };

    # proxy
    "system/proxy" = {mode = "manual";};
    "system/proxy/ftp" = {host="127.0.0.1"; port=config.proxyPort;};
    "system/proxy/http" = {host="127.0.0.1"; port=config.proxyPort;};
    "system/proxy/https" = {host="127.0.0.1"; port=config.proxyPort;};

    "org/gnome/mutter" = {
      dynamic-workspaces = true;
    };
  };

  systemd.user.tmpfiles.rules = [
    "L? %h/.config/gtk-3.0/bookmarks - - - - %h/Gist/Config/nautilus_bookmarks"
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="advanced-alttab-window-switcher"><a class="header" href="#advanced-alttab-window-switcher">advanced-alttab-window-switcher</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.gnomeExtensions.advanced-alttab-window-switcher
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "advanced-alt-tab@G-dH.github.com"
      ];
    };
    "org/gnome/shell/extensions/advanced-alt-tab-window-switcher" = {
      # do not show preview for selected window
      switcher-popup-preview-selected=1;
      # all workspaces
      win-switcher-popup-filter=1;
      win-switch-include-modals=true;

      # enable-super=true;
      # # super =&gt; window switcher
      # super-key-mode=3;
      # # show overview
      # super-double-press-action=3;
      # # Activate app after mouse out. But why needs this?
      # # If not enable this, the app switcher will not exit automatically,
      # # which may be a bug.
      # switcher-popup-activate-on-hide=true;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [(
    pkgs.gnomeExtensions.auto-accent-colour.overrideAttrs (old: {
      postPatch = ''
        substituteInPlace extension.js --replace "gjs" "${pkgs.gjs}/bin/gjs"
      '';
    })
  )];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "auto-accent-colour@Wartybix"
      ];
    };
    "org/gnome/shell/extensions/auto-accent-colour" = {
      hide-indicator = true;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bingwallpaper"><a class="header" href="#bingwallpaper">BingWallpaper</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.gnomeExtensions.bing-wallpaper-changer
    # random-wallpaper-wip-v3
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "BingWallpaper@ineffable-gmail.com"
        # "randomwallpaper@iflow.space"
      ];
    };
    "org/gnome/shell/extensions/bingwallpaper" = {
      market="zh-CN";
      delete-previous=true;
      download-folder="/tmp/pictures";
    };
    # "org/gnome/shell/extensions/space-iflow-randomwallpaper" = {
    #   auto-fetch = true;
    #   change-lock-screen = true;
    #   hours = 8;
    #   minutes = 29;
    #   source = "genericJSON";
    #   # source = "wallhaven";
    # };
    # "org/gnome/shell/extensions/space-iflow-randomwallpaper/genericJSON" = {
    #   generic-json-request-url = "http://www.bing.com/HPImageArchive.aspx?format=js&amp;idx=0&amp;n=1&amp;mkt=zh-CN";
    #   generic-json-response-path = "$.images[0].url";
    #   generic-json-url-prefix = "http://www.bing.com";
    # };
    # "org/gnome/shell/extensions/space-iflow-randomwallpaper/wallhaven" ={
    #   wallhaven-keyword="cardcaptor sakura";
    # };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bluetooth-battery-meter"><a class="header" href="#bluetooth-battery-meter">bluetooth battery meter</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.gnomeExtensions.bluetooth-battery-meter
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "Bluetooth-Battery-Meter@maniacx.github.com"
      ];
    };
    "org/gnome/shell/extensions/Bluetooth-Battery-Meter" = {
      enable-battery-level-text = true;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="dash-to-dock"><a class="header" href="#dash-to-dock">dash-to-dock</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.gnomeExtensions.dash-to-dock
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "dash-to-dock@micxgx.gmail.com"
      ];
    };
    "org/gnome/shell/extensions/dash-to-dock" = {
      intellihide-mode="ALL_WINDOWS";
      # DOTS support at most 4 windows counting,
      # BINARY supports at most 2^4-1 windows counting
      running-indicator-style="BINARY";
      custom-theme-customize-running-dots=true;
      custom-theme-running-dots-border-color="rgb(0,0,0)";
      custom-theme-running-dots-border-width=4;
      custom-theme-running-dots-color="rgb(255,255,255)";

      click-action="focus-or-appspread";
      transparency-mode = "FIXED";
      background-opacity = 0.4;
      shortcut=["&lt;Shift&gt;&lt;Super&gt;h"];
      shortcut-text="&lt;Super&gt;&lt;Shift&gt;h";
      scroll-action="cycle-windows";
      shift-click-action="launch";
      middle-click-action="previews";
      # shift-middle-click-action="launch";
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gnome-extensions"><a class="header" href="#gnome-extensions">Gnome Extensions</a></h1>
<p>Each time home-manager switched, no need log out.
Just reload extension by <alt>+F2 r</p>
<pre><code class="language-nix">{ pkgs, ... }: {
  imports = [
    ./advanced-alttab-window-switcher.nix
    ./bing-wallpaper-changer.nix
    ./bluetooth-battery-meter.nix
    ./dash-to-dock.nix
    ./gtile.nix
    ./hide-top-bar.nix
    ./pano.nix
    ./system-monitor.nix
    ./transparent-top-bar.nix
    ./unite.nix
    ./lunar-calendar.nix
    ./auto-accent-colour.nix
    ./new-workspace-shortcut.nix
    ./wsp-windows-search-provider.nix
  ];
  home.packages = with pkgs.gnomeExtensions; [
    always-show-titles-in-overview
  ] ++ [
    pkgs.gnome45Extensions."permanent-notifications@bonzini.gnu.org"
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      disable-extension-version-validation = true;
      ## enabled gnome extensions
      disable-user-extensions = false;
      disabled-extensions = [];
      enabled-extensions = [
        "Always-Show-Titles-In-Overview@gmail.com"
        "permanent-notifications@bonzini.gnu.org"
      ];
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="customize-ibus-input-method-customization"><a class="header" href="#customize-ibus-input-method-customization">customize-ibus: input method customization</a></h1>
<pre><code class="language-nix">{ pkgs, lib, ... }: {
  home.packages = [
    pkgs.gnomeExtensions.customize-ibus
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "customize-ibus@hollowman.ml"
      ];
    };
    "org/gnome/desktop/input-sources" = {
      sources = with lib.hm.gvariant; mkArray
      "(${lib.concatStrings [type.string type.string]})" [
        (mkTuple ["xkb"  "us"])
        (mkTuple ["ibus" "rime"])
        (mkTuple ["ibus" "mozc-jp"])
        (mkTuple ["ibus" "hangul"])
      ];
    };
    "org/gnome/shell/extensions/customize-ibus" = {
      candidate-orientation = lib.hm.gvariant.mkUint32 1;
      custom-font="Iosevka Nerd Font 16";
      enable-orientation=true;
      input-indicator-only-on-toggle=false;
      input-indicator-only-use-ascii=false;
      use-custom-font=true;
      use-indicator-show-delay=true;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gtile-tiled-windows-manager"><a class="header" href="#gtile-tiled-windows-manager">gtile: tiled windows manager</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.gnomeExtensions.gtile
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "gTile@vibou"
      ];
    };
    "org/gnome/shell/extensions/gtile" = {
      animation=true;
      global-presets=true;
      grid-sizes="16x10";
      preset-resize-1=["&lt;Super&gt;bracketleft"];
      preset-resize-2=["&lt;Super&gt;bracketright"];
      preset-resize-3=["&lt;Super&gt;comma"];
      preset-resize-4=["&lt;Super&gt;period"];
      preset-resize-5=["&lt;Super&gt;semicolon"];
      preset-resize-6=["&lt;Super&gt;apostrophe"];
      preset-resize-7=["&lt;Super&gt;slash"];
      resize1="2x2 1:1 1:1";
      resize2="2x2 2:1 2:1";
      resize3="2x2 1:2 1:2";
      resize4="2x2 2:2 2:2";
      resize5="4x8 2:2 3:7";
      resize6="1x2 1:1 1:1";
      resize7="1x2 1:2 1:2";
      show-icon=false;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hide-top-bar"><a class="header" href="#hide-top-bar">hide-top-bar</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.gnomeExtensions.hide-top-bar
    # https://extensions.gnome.org/extension/545/hide-top-bar/
    # &gt; straydog77:
    # &gt; If anyone is having issues with this extension behaving strangely like the top bar sometimes won't appear or appear briefly and disappear use the "disable-unredirect" extension in conjunction
    # &gt; https://extensions.gnome.org/extension/8008/disable-unredirect/
    pkgs.gnomeExtensions.disable-unredirect
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "hidetopbar@mathieu.bidon.ca"
        "disable-unredirect@exeos"
      ];
    };
    "org/gnome/shell/extensions/hidetopbar" = {
      mouse-sensitive = true;
      enable-active-window=false;
      enable-intellihide=true;
      # enable shortcut &lt;Super&gt;+v show nofication list, &lt;Super&gt;+s show quick settings, and so on
      keep-round-corners=true;
      shortcut-delay = 0.0;
      shortcut-keybind = ["&lt;Super&gt;h"];
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = with pkgs.gnomeExtensions; [
    lunar-calendar
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "lunarcal@ailin.nemui"
      ];
    };
    "org/gnome/shell/extensions/lunar-calendar" = {
      # æ—¥å†å†…çš„èŠ‚æ—¥
      jrrilinei = true;
      # é¡¶æ æ—¥æœŸ
      show-date = true;
      # é¡¶æ æ—¶é—´
      show-time = false;
      # è¯­è¨€ï¼šå¤§é™†
      yuyan = 0;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.gnomeExtensions.new-workspace-shortcut
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "newworkspaceshortcut@barnix.io"
      ];
    };
    "org/gnome/shell/extensions/newworkspaceshortcut" = {
      empty-workspace-left = ["&lt;Alt&gt;&lt;Control&gt;&lt;Shift&gt;Left"];
      empty-workspace-right = ["&lt;Alt&gt;&lt;Control&gt;&lt;Shift&gt;Right"];
      move-window-to-left-workspace = ["&lt;Super&gt;&lt;Control&gt;&lt;Shift&gt;Left"];
      move-window-to-right-workspace = ["&lt;Super&gt;&lt;Control&gt;&lt;Shift&gt;Right"];
      workspace-left = [""];
      workspace-right = [""];
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="pano-next-gen-clipboard-manager-for-gnome-shell"><a class="header" href="#pano-next-gen-clipboard-manager-for-gnome-shell">pano: Next-gen Clipboard Manager for Gnome Shell</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    (pkgs.gnomeExtensions.pano.overrideAttrs (old: {
      # Referring to https://github.com/NixOS/nixpkgs/pull/461745/files
      # prepend_search_path =&gt; dup_default().prepend_search_path
      preInstall = builtins.replaceStrings
        ["prepend_search_path"]
        ["dup_default().prepend_search_path"]
        old.preInstall;
    }))
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "pano@elhan.io"
      ];
    };
    "org/gnome/shell/extensions/pano" = {
      play-audio-on-copy=false;
      send-notification-on-copy=false;
      paste-on-select=false;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="system-monitor"><a class="header" href="#system-monitor">system-monitor</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    # replace system-monitor(-next) with vitals
    # refers to https://github.com/mgalgs/gnome-shell-system-monitor-applet/issues/57
    # vitals
    pkgs.gnomeExtensions.system-monitor-next
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        # "Vitals@CoreCoding.com"
        "system-monitor-next@paradoxxx.zero.gmail.com"
      ];
    };
    # "org/gnome/shell/extensions/vitals" = {
    #   fixed-widths = true;
    #   hide-icons = true;
    #   hot-sensors = [
    #     "_processor_usage_"
    #     "_memory_usage_"
    #     "__network-rx_max__"
    #     "__network-tx_max__"
    #   ];
    #   show-fan = false;
    #   show-system = false;
    #   show-temperature = false;
    #   show-voltage = false;
    #   update-time = 2;
    # };
    "org/gnome/shell/extensions/system-monitor-next-applet" = {
      compact-display = true;
      icon-display = false;
      swap-display = true;
      cpu-style = "digit";
      memory-style = "digit";
      net-style = "digit";
      swap-style = "digit";
      cpu-show-text = false;
      memory-show-text = false;
      net-show-text = false;
      swap-show-text = false;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="transparent-top-bar-able-to-adjust-transparency"><a class="header" href="#transparent-top-bar-able-to-adjust-transparency">transparent-top-bar: able to adjust transparency</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.gnomeExtensions.transparent-top-bar-adjustable-transparency
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "transparent-top-bar@ftpix.com"
      ];
    };
    "com/ftpix/transparentbar" = {
      dark-full-screen = false;
      transparency = 40;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="unite-unite-style"><a class="header" href="#unite-unite-style">unite: unite style</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.gnomeExtensions.unite
  ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [ "unite@hardpixel.eu" ];
    };
    "org/gnome/shell/extensions/unite" = {
      app-menu-ellipsize-mode="end";
      extend-left-box=false;
      greyscale-tray-icons=false;
      hide-app-menu-icon=false;
      hide-dropdown-arrows=true;
      hide-window-titlebars="always";
      notifications-position="center";
      reduce-panel-spacing=true;
      show-window-buttons="always";
      use-activities-text = false;
      window-buttons-placement="last";
      window-buttons-theme="materia";
      restrict-to-primary-screen=false;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [ pkgs.gnomeExtensions.wsp-windows-search-provider ];
  dconf.settings = {
    "org/gnome/shell" = {
      enabled-extensions = [
        "windows-search-provider@G-dH.github.com"
      ];
    };
    # Disable file index
    "org/freedesktop/tracker/miner/files" = {
      index-recursive-directories=[];
      index-single-directories=[];
    };
    # Disable all gnome providers, we use only wsp-windows-search-provider
    "org/gnome/desktop/search-providers" = {
      disable-external=true;
    };
    "org/gnome/shell/extensions/windows-search-provider" = {
      # fuzzy search
      search-method=1;
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># Cons:
# * Static workspace (id: 1,2,3,...)
#   * As a result, it is not easy to insert a new workspace into a place.
#   * Though we can write a script to swap workspace from tail to the place,
#     it is very inelegant.
{ pkgs, ... }: {
  imports = [
    ./ironbar.nix
    ./hyprshell.nix
  ];
  wayland.windowManager.hyprland = {
    enable = true;
    settings = {
      windowrule = "float, class:.*";
      animation = "global, 1, 3, default";
      exec-once = "ironbar";
      general = {
        gaps_in = 0;
        gaps_out = 0;
        border_size = 0;
      };
      input = {
        follow_mouse = 2;
      };
      gestures = {
        workspace_swipe_invert = false;
      };
      gesture = "3, horizontal, workspace";
      "$mainMod" = "SUPER";
      bind = [
        "Ctrl+Alt, T, exec, kitty"
        "Alt, F4, killactive,"
        "Super, M, exit,"
        "Super, D, exec, rofi -show drun"

# # Toggle overview, show windows from current workspace only (default)
# "SUPER, H, hyprview:toggle"

# # Toggle overview, show windows from all workspaces
# "SUPER, H, hyprview:toggle, all"

# # Toggle overview, show windows from all workspaces including special workspaces
# "SUPER, S, hyprview:toggle, all special"

# # Close the overview
# "SUPER, ESC, hyprview:toggle, off"

# # Toggle overview with different placement algorithms
# "SUPER, G, hyprview:toggle, placement:spiral"
# "SUPER, T, hyprview:toggle, placement:flow"
# "SUPER, A, hyprview:toggle, placement:adaptive"
# "SUPER, W, hyprview:toggle, placement:wide"
# "SUPER, F, hyprview:toggle, placement:scale"

        "Ctrl+Alt, left, workspace, -1"
        "Ctrl+Alt, right, workspace, +1"
        "Ctrl+Super, left, movetoworkspace, -1"
        "Ctrl+Super, right, movetoworkspace, +1"
        "Ctrl+Shift+Alt, left, workspace, e-1"
        "Ctrl+Shift+Alt, right, workspace, e+1"
        "Ctrl+Shift+Super, left, movetoworkspace, e-1"
        "Ctrl+Shift+Super, right, movetoworkspace, e+1"

        "Super, left, movewindowpixel, exact 0 0 ,activewindow"
        "Super, left, resizewindowpixel, exact 50% 100% ,activewindow"
        "Super, right, movewindowpixel, exact 50% 0 ,activewindow"
        "Super, right, resizewindowpixel, exact 50% 100% ,activewindow"
        # If use fullscreen then cannot see the ironbar
        # "Super, up, fullscreen, 1, set"
        # "Super, down, fullscreen, 1, unset"
        "Super, up, movewindowpixel, exact 0 0 ,activewindow"
        "Super, up, resizewindowpixel, exact 100% 100% ,activewindow"

        "Super, bracketleft, movewindowpixel, exact 0 0 ,activewindow"
        "Super, bracketleft, resizewindowpixel, exact 50% 50% ,activewindow"
        "Super, bracketright, movewindowpixel, exact 50% 0 ,activewindow"
        "Super, bracketright, resizewindowpixel, exact 50% 50% ,activewindow"
        "Super, comma, movewindowpixel, exact 0 50% ,activewindow"
        "Super, comma, resizewindowpixel, exact 50% 50% ,activewindow"
        "Super, period, movewindowpixel, exact 50% 50% ,activewindow"
        "Super, period, resizewindowpixel, exact 50% 50% ,activewindow"
        "Super, apostrophe, movewindowpixel, exact 0 0 ,activewindow"
        "Super, apostrophe, resizewindowpixel, exact 100% 50% ,activewindow"
        "Super, slash, movewindowpixel, exact 0 50% ,activewindow"
        "Super, slash, resizewindowpixel, exact 100% 50% ,activewindow"
        "Super, semicolon, movewindowpixel, exact 25% 25% ,activewindow"
        "Super, semicolon, resizewindowpixel, exact 50% 50% ,activewindow"

        ",XF86AudioRaiseVolume, exec, ${pkgs.wireplumber}/bin/wpctl set-volume -l 1 @DEFAULT_AUDIO_SINK@ 5%+"
        ",XF86AudioLowerVolume, exec, ${pkgs.wireplumber}/bin/wpctl set-volume @DEFAULT_AUDIO_SINK@ 5%-"
        ",XF86AudioMute, exec, ${pkgs.wireplumber}/bin/wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle"
        ",XF86AudioMicMute, exec, ${pkgs.wireplumber}/bin/wpctl set-mute @DEFAULT_AUDIO_SOURCE@ toggle"
        ",XF86MonBrightnessUp, exec, ${pkgs.brightnessctl}/bin/brightnessctl -e4 -n2 set 5%+"
        ",XF86MonBrightnessDown, exec, ${pkgs.brightnessctl}/bin/brightnessctl -e4 -n2 set 5%-"
        ",XF86AudioNext, exec, ${pkgs.playerctl}/bin/playerctl next"
        ",XF86AudioPause, exec, ${pkgs.playerctl}/bin/playerctl play-pause"
        ",XF86AudioPlay, exec, ${pkgs.playerctl}/bin/playerctl play-pause"
        ",XF86AudioPrev, exec, ${pkgs.playerctl}/bin/playerctl previous"
      ];
    };
    plugins = [
      # (import ./hyprview.nix)
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># Hyprspace vs hyprshell
# * Hyprspace's display seem buggy in my config
# * Hyprspace's author does not have enough time and recommand user to try niri.
{ pkgs, ... }: {
  services.hyprshell = {
    enable = true;
    package = pkgs.hyprshell.overrideAttrs (final: prev: {
      # https://github.com/H3rmt/hyprshell/issues/372
      src = pkgs.fetchFromGitHub {
        owner = "H3rmt";
        repo = "hyprshell";
        rev = "69011f802ebfd14e710f9cccd6f856ce2e0d4c40";
        hash = "sha256-nemSN4dqwKKTqHyRwFKpEf54PPoHUvhCtrRBvasXEVg=";
      };
      cargoDeps = pkgs.rustPlatform.fetchCargoVendor {
        src = final.src;
        hash = "sha256-g23W5cgGxWNyJ4uew2x12vgF5Bvaid1+phV2fxyHbas=";
      };
      # Unnecessary due to cargoDeps having higher priority than cargoHash,
      # but to make it explicitly that cargoHash is not used after overrideAttrs.
      cargoHash = null;
    });
    settings = {
      version = 3;
      windows = {
        overview = {
          launcher = {
            default_terminal = "kitty";
            launch_modifier = "alt";
          };
          key = "super_l";
          modifier = "super";
        };
        switch = {
          modifier = "alt";
          filter_by = ["current_workspace"];
          switch_workspaces = false;
        };
      };
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  pkgs = import &lt;nixpkgs&gt; {};
in pkgs.hyprlandPlugins.mkHyprlandPlugin (finalAttrs: {
  pluginName = "hyprview";
  version = "main";

  src = pkgs.fetchFromGitHub {
    owner = "yz778";
    repo = finalAttrs.pluginName;
    rev = "817c2543bbe6eff8d6ad40ebb4adf41c265762eb";
    hash = "sha256-nPSHF7kcVEwUIKTji9IiP1LPmkFxyaGakgAt9Ke1k9c=";
  };

  patchPhase = ''
    sed -i 's,g_pInputManager-&gt;unsetCursorImage,g_pPointerManager-&gt;resetCursorImage,g' src/hyprview.cpp
    # sed -i '/std::string HASH/,+6d' src/main.cpp
  '';
  buildPhase = ''
    make -C src all -j $NIX_BUILD_CORES
  '';
  installPhase = ''
    mkdir -p $out/lib
    cp build/hyprview.so $out/lib/lib${finalAttrs.pluginName}.so
  '';

  meta = {};
})
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [ pkgs.pkgsu.ironbar ];
  home.file.ironbar_config = {
    text = builtins.toJSON {
      position = "top";
      autohide = 0;
      start = [{
        type = "launcher";
        favorites = [
          "firefox"
        ];
        # truncate = {
        #   mode = "end";
        #   max_length = 30;
        # };
      }];
      center = [{
        type = "clock";
        format = "%Y.%m.%d | %H:%M";
      }];
      end = [{
        type = "tray";
        icon_size = 24;
      }{
        type = "sys_info";
        format = [
          "â²{cpu_percent:2}"
          "â›{memory_percent:2.0}|{swap_percent:2.0}"
          "â‡„{net_up#MB/s}|{net_down#MB/s}"
        ];
        interval.cpu = 1;
      }{
        type = "clipboard";
        max_items = 15;
      }{
        type = "volume";
      }{
        type = "network_manager";
        icon_size = 16;
      }{
        type = "bluetooth";
      }{
        type = "battery";
        icon_size = 16;
        show_if = "[ -e /sys/class/power_supply/LCBT ]";
      }{
        type = "notifications";
      }];
    };
    target = ".config/ironbar/config.json";
  };
  home.file.ironbar_style = {
    text = /*css*/ ''
      :root {
        --color-dark-primary: #1c1c1c;
        --color-dark-secondary: #2d2d2d;
        --color-active: #6699cc;
      }
      * {
        background-image: none;
        font-family: noto mono;
      }
      #bar, popover, popover contents, calendar {
        background-color: var(--color-dark-primary);
      }
      button {
        padding: 0;
      }
      button:hover, button:active {
        background-color: var(--color-dark-secondary);
      }
      #end &gt; * + * {
        margin: 0.5em;
      }
      .clock {
        font-weight: bold;
      }
      .popup-clock .calendar-clock {
        font-size: 2.0em;
      }
      .popup-clock .calendar .today {
        background-color: var(--color-active);
      }
    '';
    target = ".config/ironbar/style.css";
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="kde-connect"><a class="header" href="#kde-connect">KDE Connect</a></h1>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    pkgs.kdePackages.kdeconnect-kde
  ];
</code></pre>
<p>Auto startup KDE Connect after Gnome GUI login.</p>
<pre><code class="language-nix">  home.file.kde_connect_indicator = {
    source = "${pkgs.kdePackages.kdeconnect-kde}/share/applications/org.kde.kdeconnect.nonplasma.desktop";
    target = ".config/autostart/org.kde.kdeconnect.nonplasma.desktop";
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="kitty"><a class="header" href="#kitty">kitty</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
{
  # Terminal Comparsion
  # * gnome-terminal
  #   * Pros
  #   * Cons
  #     * Wrong window size, when window is tiled (e.g. use gTile)
  #     * Icon display incorrectly (e.g. Vim-vista)
  #     * It's hard to hide top bar
  # * alacritty
  #   * Pros
  #     * Esay configurable
  #     * Icon display correctly (e.g. Vim-vista)
  #     * input method fcitx works
  #   * Cons
  #     * Not native tab support
  #       https://github.com/alacritty/alacritty/issues/3129
  #       The developer(s?) with poor attitude
  #       * Compromise: tabbed
  #     * Alacritty is not work with espanso
  #       https://github.com/federico-terzi/espanso/issues/787
  #       https://github.com/federico-terzi/espanso/issues/1088
  #       In espanso auto mode, alacritty definitely will be stucked.
  #       In clipboard, alacritty may be stucked.
  #     * emoji display poorly.
  # * kitty
  #   * Pros
  #     * Esay configurable
  #   * Cons
  #     * Icon display incorrectly (e.g. Vim-vista)
  #     * input method support solved by fcitx5
  # * hyper
  #   * Cons
  #     * scroll speed is too fast!

  imports = [
    ./timer.nix
    ./search.nix
  ];

  # shortcuts
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys".custom-keybindings = [
    "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/kitty/"
    "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/fzf-doc/"
    "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/fzf-doc-background/"
  ];
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/kitty" = {
    binding="&lt;Primary&gt;&lt;Alt&gt;t";
    command = "kitty";
    name="terminal";
  };
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/fzf-doc" = {
    binding="&lt;Super&gt;f";
    # bash alias needs interative bash (-i)
    # https://askubuntu.com/questions/1109564/alias-not-working-inside-bash-shell-script
    command="kitty bash -i fzf-doc";
    name="fzf-doc";
  };

  programs.kitty = {
    enable = true;
    environment = {
      "TERM" = "xterm";
    };
    font = {
      name = "";
      size = 16;
    };
    settings = {
      allow_remote_control = "yes";
      listen_on = "unix:/tmp/mykitty";

      hide_window_decorations = "yes";
      cursor_blink_interval = "0.8";
      remember_window_size = "no";
      initial_window_width = "80c";
      initial_window_height = "20c";

      # Note that this is only used for high precision scrolling devices on platforms such as macOS and Wayland.
      touch_scroll_multiplier = "5.0";

      # tab
      tab_bar_edge = "top";
      tab_bar_style = "separator";
      # tab_separator = " â”‡"; This is default, a space before the vertical line
      active_tab_foreground   = "#e2e2e3";
      active_tab_background   = "#2c2e34";
      active_tab_title_template = "ğŸ±{fmt.fg.red}{bell_symbol}{activity_symbol}{fmt.fg.tab}{title}";
      inactive_tab_foreground = "#2c2e34";
      inactive_tab_background = "#e2e2e3";

      # tango dark
      background              = "#2c2e34";
      foreground              = "#e2e2e3";
      cursor                  = "#e2e2e3";
      color0                  = "#2c2e34";
      color8                  = "#555753";
      color1                  = "#cc0000";
      color9                  = "#ef2929";
      color2                  = "#4e9a06";
      color10                 = "#8ae234";
      color3                  = "#c4a000";
      color11                 = "#fce94f";
      color4                  = "#3465a4";
      color12                 = "#729fcf";
      color5                  = "#75507b";
      color13                 = "#ad7fa8";
      color6                  = "#06989a";
      color14                 = "#34e2e2";
      color7                  = "#e2e2e3";
      color15                 = "#eeeeec";
      # selection_foreground    = "#2c2e34";
      # selection_background    = "#e2e2e3";
    };
    extraConfig = ''
      map ctrl+equal change_font_size all +2.0
      map ctrl+plus change_font_size all +2.0
      map ctrl+kp_add change_font_size all +2.0
      map ctrl+minus change_font_size all -2.0
      map ctrl+kp_subtract change_font_size all -2.0
      map ctrl+0 change_font_size all 0

      map ctrl+shift+t new_tab_with_cwd
      map ctrl+shift+n new_os_window_with_cwd

      # disable opening of URLs with a plain click
      mouse_map left click ungrabbed no_op

      #: asks which tab to move the window into
      map f2 detach_window ask


      action_alias launch_window launch --cwd=current
      # Window layout
      enabled_layouts splits

      # Split and Create a new window
      map f5 launch_window --location=hsplit
      map f6 launch_window --location=vsplit

      # Goto window
      map alt+left neighboring_window left
      map alt+right neighboring_window right
      map alt+up neighboring_window up
      map alt+down neighboring_window down
    '';
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: let
  kitty-kitten-search = pkgs.runCommand "kitty-kitten-search" {
    src = pkgs.fetchFromGitHub {
      owner = "trygveaa";
      repo = "kitty-kitten-search";
      rev = "0760138fad617c5e4159403cbfce8421ccdfe571";
      hash = "sha256-egisza7V5dWplRYHIYt4bEQdqXa4E7UhibyWJAup8as=";
    };
  } ''
    mkdir $out
    cp $src/scroll_mark.py $out/scroll_mark.py
    sed 's/typing/typing_compat/' $src/search.py &gt; $out/search.py
  '';
in {
  home.file.kitty_search = {
    source = "${kitty-kitten-search}/search.py";
    target = ".config/kitty/search.py";
  };
  home.file.kitty_scroll_mark = {
    source = "${kitty-kitten-search}/scroll_mark.py";
    target = ".config/kitty/scroll_mark.py";
  };
  programs.kitty = {
    extraConfig = ''
      map ctrl+shift+f launch --location=hsplit --allow-remote-control kitty +kitten search.py @active-kitty-window-id
    '';
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ lib, ... }: {
  ## after direnv's bash.initExtra
  programs.bash.initExtra = lib.mkOrder 2000 ''
    # https://stackoverflow.com/questions/1862510/how-can-the-last-commands-wall-time-be-put-in-the-bash-prompt
    function timer_start {
      _timer=''${_timer:-$SECONDS}
    }
    function timer_stop {
      last_timer=$(($SECONDS - $_timer))
      unset _timer

      _notification="[''${last_timer}sâ°] Job finished!"
      if [[ "$TERM" =~ tmux ]]; then
        # https://github.com/tmux/tmux/issues/846
        printf '\033Ptmux;\033\x1b]99;;%s\033\x1b\\\033\\' "$_notification"
      else
        printf '\x1b]99;;%s\x1b\\' "$_notification"
      fi
    }
  '';
  programs.kitty = {
    extraConfig = ''
      # Notify when a long running command is finished
      ## https://github.com/kovidgoyal/kitty/issues/1892
      map f1 send_text all \x1a timer_start; fg; timer_stop \r
    '';
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># https://nixos.org/manual/nixos/stable/#sec-writing-modules
# refers to syncthing module

# list options:
#   home-manager option xdg.mime.types.\"*\"
#   nixos option
{ config
, lib
, pkgs
, ...
}:
with lib;
let
  cfg = config.xdg.mime.types;
in
{
  options = {
    xdg.mime.types = mkOption {
      default = {};
      description = "Set MIME types and default applications.";
      example = ''
        xdg.mime.types.dot = {
          name = "graphviz-dot";
          type = "text/graphviz-dot";
          pattern = "*.dot";
          defaultApp = "xdot.desktop";
        };
      '';
      type = types.attrsOf (types.submodule ({name, ...}:
      {
        options = {
          name = mkOption {
            type = types.str;
            default = name;
            description = "The name of the xml file.";
          };
          type = mkOption {
            type = types.str;
            default = "";
            description = "The mime-type.";
          };
          pattern = mkOption {
            type = types.str;
            default = "";
            description = "The glob pattern.";
          };
          defaultApp = mkOption {
            type = types.str;
            default = "";
            description = "Default application for opening this MIME type.";
          };
        };
      }));
    };
  };

  # builtins.mapAttrs (n: v: {wang=v.miao;}) {file1={miao=1;}; file2={miao=2;};}
  # =&gt; {file1={wang=1;}; file2={wang=2;};}
  config = {
    home.file = builtins.mapAttrs (n: v: {
      text = ''
        &lt;?xml version="1.0"?&gt;
        &lt;mime-info xmlns='http://www.freedesktop.org/standards/shared-mime-info'&gt;
          &lt;mime-type type="${v.type}"&gt;
            &lt;glob pattern="${v.pattern}"/&gt;
          &lt;/mime-type&gt;
        &lt;/mime-info&gt;
      '';
      target = ".local/share/mime-types/${v.name}.xml";
      onChange = ''
        ${pkgs.xdg-utils}/bin/xdg-mime install ~/.local/share/mime-types/${v.name}.xml
        ${pkgs.xdg-utils}/bin/xdg-mime default ${v.defaultApp} ${v.type}
      '';
    }) cfg;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># Use `wev` to find out key name
{ pkgs }: {
  "Ctrl+Alt+T".spawn = "kitty";
  "Mod+D".spawn-sh = "dms ipc call spotlight toggle";
  "Mod+W".spawn-sh = "rofi -show window -window-format '{c} {t}'";
  "Mod+Alt+L".spawn-sh = "dms ipc lock lock";
  "Mod+N".spawn-sh = "dms ipc notifications toggle";
  "Mod+X".spawn-sh = "dms ipc powermenu toggle";
  "Mod+V".spawn-sh = "dms ipc clipboard toggle";
  "Mod+H".spawn-sh = "dms ipc bar toggleAutoHide name 'Main Bar'";
  "Mod+F".spawn-sh = "kitty bash -i fzf-doc";

  XF86AudioRaiseVolume = {
    _props.allow-when-locked = true;
    spawn-sh = "${pkgs.wireplumber}/bin/wpctl set-volume @DEFAULT_AUDIO_SINK@ 0.05+ -l 1.0";
  };
  XF86AudioLowerVolume = {
    _props.allow-when-locked = true;
    spawn-sh = "${pkgs.wireplumber}/bin/wpctl set-volume @DEFAULT_AUDIO_SINK@ 0.05-";
  };
  XF86AudioMute = {
    _props.allow-when-locked = true;
    spawn-sh = "${pkgs.wireplumber}/bin/wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle";
  };
  XF86AudioMicMute = {
    _props.allow-when-locked = true;
    spawn-sh  = "${pkgs.wireplumber}/bin/wpctl set-mute @DEFAULT_AUDIO_SOURCE@ toggle";
  };
  XF86AudioPlay = {
    _props.allow-when-locked = true;
    spawn-sh = "${pkgs.playerctl}/bin/playerctl play-pause";
  };
  XF86AudioStop = {
    _props.allow-when-locked = true;
    spawn-sh = "${pkgs.playerctl}/bin/playerctl stop";
  };
  XF86AudioPrev = {
    _props.allow-when-locked = true;
    spawn-sh = "${pkgs.playerctl}/bin/playerctl previous";
  };
  XF86AudioNext = {
    _props.allow-when-locked = true;
    spawn-sh = "${pkgs.playerctl}/bin/playerctl next";
  };
  XF86MonBrightnessUp = {
    _props.allow-when-locked = true;
    spawn-sh = "${pkgs.brightnessctl}/bin/brightnessctl --class=backlight set +5%";
  };
  XF86MonBrightnessDown = {
    _props.allow-when-locked = true;
    spawn-sh = "${pkgs.brightnessctl}/bin/brightnessctl --class=backlight set 5%-";
  };

  # Open/close the Overview: a zoomed-out view of workspaces and windows.
  # You can also move the mouse into the top-left hot corner,
  # or do a four-finger swipe up on a touchpad.
  "Mod" = {
    _props = { repeat = false; release = true; };
    toggle-overview = {};
  };

  "Alt+F4" = {
    _props.repeat = false;
    close-window = {};
  };
  "Mod+BackSpace" = {
    _props.repeat = false;
    close-window = {};
  };

  "Mod+T".toggle-column-tabbed-display = {};

  "Mod+Left".focus-column-or-monitor-left = {};
  "Mod+Right".focus-column-or-monitor-right = {};
  "Mod+Up".focus-window-or-workspace-up = {};
  "Mod+Down".focus-window-or-workspace-down = {};

  "Ctrl+Mod+Left".move-column-left = {};
  "Ctrl+Mod+Right".move-column-right = {};
  "Ctrl+Mod+Up".move-window-up = {};
  "Ctrl+Mod+Down".move-window-down = {};

  "Ctrl+Alt+Left".focus-monitor-left = {};
  "Ctrl+Alt+Right".focus-monitor-right = {};
  "Ctrl+Alt+Up".focus-workspace-up = {};
  "Ctrl+Alt+Down".focus-workspace-down = {};

  "Mod+Home".focus-column-first = {};
  "Mod+End".focus-column-last = {};
  "Mod+Ctrl+Home".move-column-to-first = {};
  "Mod+Ctrl+End".move-column-to-last = {};

  "Shift+Mod+Left".move-column-to-monitor-left = {};
  "Shift+Mod+Right".move-column-to-monitor-right = {};
  "Shift+Mod+Up".move-column-to-workspace-up = {};
  "Shift+Mod+Down".move-column-to-workspace-down = {};

  "Mod+Shift+Page_Down".move-workspace-down = {};
  "Mod+Shift+Page_Up".move-workspace-up = {};

  "Mod+WheelScrollDown" = {
    _props.cooldown-ms = 150;
    focus-workspace-down = {};
  };
  "Mod+WheelScrollUp" = {
    _props.cooldown-ms = 150;
    focus-workspace-up = {};
  };
  "Mod+Ctrl+WheelScrollDown" = {
    _props.cooldown-ms = 150;
    move-column-to-workspace-down = {};
  };
  "Mod+Ctrl+WheelScrollUp" = {
    _props.cooldown-ms = 150;
    move-column-to-workspace-up = {};
  };

  "Mod+WheelScrollRight".focus-column-right = {};
  "Mod+WheelScrollLeft".focus-column-left = {};
  "Mod+Ctrl+WheelScrollRight".move-column-right = {};
  "Mod+Ctrl+WheelScrollLeft".move-column-left = {};

  "Mod+Shift+WheelScrollDown".focus-column-right = {};
  "Mod+Shift+WheelScrollUp".focus-column-left = {};
  "Mod+Ctrl+Shift+WheelScrollDown".move-column-right = {};
  "Mod+Ctrl+Shift+WheelScrollUp".move-column-left = {};

  "Mod+BracketLeft".consume-or-expel-window-left = {};
  "Mod+BracketRight".consume-or-expel-window-right = {};

  "Mod+Comma".consume-window-into-column = {};
  "Mod+Period".expel-window-from-column = {};

  "Mod+Semicolon".align-column-left = {};
  "Mod+Apostrophe".align-column-right = {};

  "Mod+R".switch-preset-column-width = {};
  "Mod+Shift+R".switch-preset-window-height = {};
  "Mod+Ctrl+R".reset-window-height = {};
  "Mod+Shift+F".fullscreen-window = {};

  "Mod+Ctrl+F".expand-column-to-available-width = {};

  "Mod+C".center-column = {};
  "Mod+Ctrl+C".center-visible-columns = {};

  "Mod+Minus".set-column-width = "50%";
  "Mod+Equal".set-column-width = "100%";
    # set-column-height = "100%";
  "Mod+Shift+Minus".set-column-width = "-25%";
  "Mod+Shift+Equal".set-column-width = "+25%";

  "Mod+Backslash".toggle-window-floating = {};
  "Print".screenshot = {};
  "Mod+P".screenshot = {};
  "Ctrl+Print".screenshot-screen = {};
  "Ctrl+Mod+P".screenshot-screen = {};
  "Alt+Print".screenshot-window = {};
  "Alt+Mod+P".screenshot-window = {};

  "Mod+Escape" = {
    _props.allow-inhibiting = false;
    toggle-keyboard-shortcuts-inhibit = {};
  };

  "Mod+Shift+E".quit = {};
  "Ctrl+Alt+Delete".quit = {};
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, ... }: {
  home.file.niri_config = {
    text = config.lib.generators.toKDL {} {
      # TODO: support multiple same name attr, e.g. include
      include = "./dms/outputs.kdl";
      prefer-no-csd = {};
      output = {
        _args = ["eDP-1"];
        scale = 2.0;
      };
      input = {
        touchpad = {
          tap = {};
        };
      };
      layout = {
        gaps = 0;
        focus-ring.off = {};
        shadow = {
          on = {};
          spread = 2;
          offset._props = {x=2; y=2;};
        };
        empty-workspace-above-first = {};
      };
      spawn-at-startup = ["dms" "run"];
      screenshot-path = "~/Pictures/Screenshots/Screenshot from %Y-%m-%d %H-%M-%S.png";
      binds = import ./binds.nix {inherit pkgs;};
      gestures.hot-corners.off = {};
      overview.zoom = 0.4;
      switch-events = {
        lid-close.spawn = ["dms" "ipc" "lock" "lock"];
      };
    };
    target = ".config/niri/config.kdl";
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># Cons:
# * does not support viewport query and control (only support hard-coded touch gesture move view)!
# * does not support window movement (This is a common problem for wayland, in X11 there is wmctrl)
# * does not work well with ironbar: autohide double-trigger bug
{ pkgs, ... }: let
  niri = pkgs.niri.overrideAttrs (final: prev: {
    # Implement release keybinds and modifier-only binds
    # https://github.com/YaLTeR/niri/pull/2456/commits
    # src = pkgs.fetchFromGitHub {
    #   owner = "flowerysong";
    #   repo = "niri";
    #   rev = "86edeb3b0b3d1a08d4d4f59705cbc99a732f5e95";
    #   hash = "sha256-VFOGkBKA03fIXf/BaXsN6CZqkwUTq1gPvTIGrEMmlTQ=";
    # };
    src = pkgs.fetchFromGitHub {
      owner = "flowerysong";
      repo = "niri";
      rev = "53447431c4adcfe1572fed5f39ebddc239ca381c";
      hash = "sha256-onL4kGGpNHYNIaU11hN440RruSJKcTblSi7CwqMbYeM=";
    };
    patches = [
      # Fix dingtalk screen casting.
      # https://forum.archlinuxcn.org/t/topic/15526/3
      # [Support shm sharing #1791](https://github.com/YaLTeR/niri/pull/1791)
      (pkgs.fetchurl {
        name = "shm-sharing";
        url = "https://github.com/wrvsrx/niri/compare/tag_support-shm-sharing_2~19..tag_support-shm-sharing_2.patch";
        sha256 = "0rs0rb0f7hhk3847ay3rvhbhbpw4y2wkpg7dh9knj768qsqvm324";
      })
      # [feat: add window alignment actions#1929](https://github.com/niri-wm/niri/pull/1929)
      (pkgs.fetchurl {
        name = "window-alignment";
        url = "https://github.com/niri-wm/niri/compare/d7184a04b904e07113f4623610775ae78d32394c..78d10a28e8a7a046e52ef16ad78bee4cdeee3d81.patch";
        sha256 = "18zjnp2hgh9wsiab0w5m90gvdx0i4ab8wvpgnf9y0qjza6shwi7d";
      })
    ];
    # https://nixos.wiki/wiki/Rust#Using_overrideArgs_with_Rust_Packages
    cargoDeps = pkgs.rustPlatform.fetchCargoVendor {
      src = final.src;
      hash = "sha256-bh3NrnlFz2m8aCCakgpblFrswh02ByJVPVgxBbTZ6ts=";
    };
    # Unnecessary due to cargoDeps having higher priority than cargoHash,
    # but to make it explicitly that cargoHash is not used after overrideAttrs.
    cargoHash = null;
  });
in {
  imports = [
    ./config
  ];
  cachix_packages = [ niri ];
  home.packages = [
    niri
    # Use latest xwayland-satellite for wechat popup
    # https://github.com/Supreeeme/xwayland-satellite/pull/281
    pkgs.pkgsu.xwayland-satellite
  ];
  services.gnome-keyring.enable = true;
  xdg.portal = {
    enable = true;
    extraPortals = [ pkgs.xdg-desktop-portal-gnome ];
    configPackages = [ niri ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># Cons:
# * Does not support set 3-finger swipe directions
# * Extensions use JS
{ pkgs, ... }: let
  plasma-manager = (import &lt;nixpkgs&gt; {}).fetchFromGitHub {
    owner = "nix-community";
    repo = "plasma-manager";
    rev = "51816be33a1ff0d4b22427de83222d5bfa96d30e";
    hash = "sha256-d5Q1GmQ+sW1Bt8cgDE0vOihzLaswsm8cSdg8124EqXE=";
  };
in {
  imports = [
    (plasma-manager + "/modules")
  ];
  home.packages = [
    # Plasma6 extension also uses javascript! It is insane!
    pkgs.kdePackages.dynamic-workspaces
  ];
  programs = {
    plasma = {
      enable = true;
      shortcuts = {
        kwin = {
          "Window Maximize" = "Meta+Up";
          "Window Quick Tile Top Left" = "Meta+[";
          "Window Quick Tile Top Right" = "Meta+]";
          "Window Quick Tile Bottom Left" = "Meta+,";
          "Window Quick Tile Bottom Right" = "Meta+.";
          "Switch One Desktop to the Left" = "Ctrl+Alt+Left";
          "Switch One Desktop to the Right" = "Ctrl+Alt+Right";
          "Window One Desktop to the Left" = "Ctrl+Meta+Left";
          "Window One Desktop to the Right" = "Ctrl+Meta+Right";
        };
      };
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [
    (pkgs.rofi.override { plugins = [ /*pkgs.rofi-file-browser*/ ]; })
    pkgs.wmctrl
  ];

  # gnome keyboard shortcuts
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys".custom-keybindings = [
    "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/rofi_window/"
    "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/rofi_drun/"
    "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/rofi_wm/"
  ];
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/rofi_window" = {
    binding="&lt;Super&gt;w";
    # The default -window-command is `wmctrl -i -R {window}` which is move window to current desktop
    # The only thing we need to do is to install wmctrl
    command=/*bash*/"rofi -show window -window-format '{c} {t}'";
    name="rofi window";
  };
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/rofi_drun" = {
    binding="&lt;Super&gt;d";
    command="rofi -show drun";
    name="rofi drun";
  };
  dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/rofi_wm" = let
    wm = pkgs.python3Packages.callPackage (pkgs.fetchFromGitHub {
      owner = "xieby1";
      repo = "rofi-wm";
      rev = "5d3a13d3293b2e3a06a528f03bdfa99db5d4fd7b";
      hash = "sha256-rWn4k2AD5vRv0Dz+K1aIOmG74Nilw5NZPs3xQCIS3Ew=";
    }) {};
  in {
    binding="&lt;Super&gt;q";
    command="rofi -show wm -modes wm:${wm}/bin/wm.py";
    name="rofi wm";
  };

  home.file.rofi_config = {
    target = ".config/rofi/config.rasi";
    text = ''
      /* This is a comment */
      /* rofi -dump-config */

      configuration {
        modes: [
          window,
          drun,
          run,
          ssh
          /* file-browser-extended */
        ];
        terminal: "kitty";
        dpi: 1;
        show-icons: true;
      }
      filebrowser {
        directory: "~/Documents";
      }

      /* man rofi-theme */

      window {
        width: 80%;
      }
    '';
  };

  # home.file.rofi_file_browser_config = let
  #   openDir = pkgs.writeScript "openDir" ''
  #     if [[ -d "$1" ]]; then
  #       xdg-open "$1"
  #     elif [[ -f "$1" ]]; then
  #       xdg-open "''${1%/*}"
  #     fi
  #   '';
  # in {
  #   target = ".config/rofi/file-browser";
  #   text = ''
  #     # This is a comment
  #     dir ~/Documents
  #     depth 0
  #     no-sort-by-type
  #     sort-by-depth

  #     # BUG: rofi -show-icons causes segmentation fault
  #     # oc-search-path
  #     # oc-cmd "nautilus"
  #     # oc-cmd "${openDir}"
  #   '';
  # };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rustdesk-the-remote-desktop-app"><a class="header" href="#rustdesk-the-remote-desktop-app">rustdesk, the remote desktop app</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
{
  home.packages = [
</code></pre>
<p>The new version of rustdesk is rustdesk-flutter,
which is cached in official nix binary cache.</p>
<pre><code class="language-nix">    pkgs.rustdesk-flutter
  ];
</code></pre>
<p>Auto startup rustdesk after Gnome GUI login.</p>
<pre><code class="language-nix">  # home.file.autostart_rustdesk_desktop = {
  #   source = "${pkgs.rustdesk-flutter}/share/applications/rustdesk.desktop";
  #   target = ".config/autostart/rustdesk.desktop";
  # };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="typora"><a class="header" href="#typora">Typora</a></h1>
<p>é‡‡ç”¨nixpkgsæ”¯æŒçš„æœ€åçš„typoraç‰ˆæœ¬ï¼Œå³0.9.98ã€‚</p>
<pre><code class="language-nix">mytypora = (pkgs.callPackage (pkgs.fetchurl {
  url = "https://raw.githubusercontent.com/NixOS/nixpkgs/137f19d1d48b6d7c7901bb86729a2bce3588d4e9/pkgs/applications/editors/typora/default.nix";
  sha256 = "057dk4hl4fljn50098g7l35sh7gwm7zqqqlrczv5lhmpgxi971c1";
}) {}).overrideAttrs (old: {
  src = pkgs.fetchurl {
    url = "https://web.archive.org/web/20211222112532/https://download.typora.io/linux/typora_0.9.98_amd64.deb";
    sha256 = "1srj1fdcblfdsfvdnrqnwsxd3y8qd1h45p4sf1mxn6hr7z2s6ai6";
  };
});
</code></pre>
<p>æ³¨ï¼šæˆ‘å°è¯•æ‰“åŒ…0.11.18ï¼Œ
å‘ç°è¿™ä¸ªç‰ˆæœ¬ä¼šæ£€æµ‹æ–‡ä»¶å®Œæ•´æ€§ï¼Œ
å› æ­¤åŸºæœ¬ä¸Šæ²¡åŠæ³•ç”¨nixè¿›è¡ŒäºŒæ¬¡æ‰“åŒ…ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs, lib, ... }: {
  home.packages = [ pkgs.warpd ];
  home.file.autostart_warpd = {
    target = ".config/autostart/warpd.desktop";
    text = ''
      [Desktop Entry]
      Type=Application
      Name=warpd
      Exec=${pkgs.warpd}/bin/warpd
    '';
  };

  # ä¸ºä»€ä¹ˆä¸ç”¨gnomeå¿«æ·é”®ï¼Ÿ
  # * ä¸€æ¬¡æ€§warpdå¯åŠ¨æ¯”warpdåå°è¿è¡Œæ…¢
  # ä¸ºä»€ä¹ˆç”¨gnomeå¿«æ·é”®
  # * warpdæ²¡åŠæ³•æ­£ç¡®è¯†åˆ«M-ké”®ï¼Ÿæˆ–è€…æ˜¯gnomeæŠ¢äº†ï¼Ÿè¦M-kkæ‰è¡Œ
  # dconf.settings."org/gnome/settings-daemon/plugins/media-keys".custom-keybindings = [
  #   "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/warpd-hint/"
  #   "/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/warpd-normal/"
  # ];
  # dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/warpd-hint" = {
  #   binding="&lt;Super&gt;k";
  #   command = "warpd --hint";
  #   name="warpd-hint";
  # };
  # dconf.settings."org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/warpd-normal" = {
  #   binding="&lt;Alt&gt;k";
  #   command = "warpd --normal";
  #   name="warpd-normal";
  # };
  home.file.warpd_config = {
    target = ".config/warpd/config";
    # Available options see `warpd --list-options`.
    # Available modifiers (according to warpd source code):
    # * alt: A-
    # * super/meta: M-
    # * shift: S-
    # * ctrl: C-
    # Available X11 key names by removing "XK_" prefix in ${pkgs.xorg.xorgproto}/include/X11/keysymdef.h
    text = lib.generators.toKeyValue {mkKeyValue=lib.generators.mkKeyValueDefault {} ": ";} {
      activation_key = "A-M-z"; # ä¸€åªæ‰‹æŒ‰A-M-zæ¯”A-M-cæ›´æ–¹ä¾¿ï¼
      buttons = "q w e";
      left  = "Left";
      up    = "Up";
      right = "Right";
      down  = "Down";
      scroll_up   = "S-Up";
      scroll_down = "S-Down";
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="wayland"><a class="header" href="#wayland">Wayland</a></h1>
<pre><code class="language-nix">virtualisation.waydroid.enable = true;
</code></pre>
<p>å°è¯•ä½¿ç”¨westonï¼Œæ¶ˆæ¯æ¥æºå‚è€ƒï¼š</p>
<ul>
<li>https://github.com/waydroid/waydroid/issues/470
<ul>
<li>https://wiki.archlinux.org/title/Waydroid</li>
</ul>
</li>
</ul>
<p>wayland images: <code>/var/lib/waydroid/images/</code></p>
<pre><code class="language-bash">weston --scale=2

# åœ¨westoné‡Œ
waydroid show-full-ui
</code></pre>
<p>westonå¿«æ·é”®å‚è€ƒ<code>man weston-bindings</code></p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs ? import &lt;nixpkgs&gt; {}
, wrapWine ? import ./wrapWine.nix {inherit pkgs;}
}:

let
  name = "weixin";
  installer = builtins.fetchurl "https://dldir1.qq.com/weixin/Windows/WeChatSetup.exe";
  regfile = builtins.toFile "${name}.reg" ''
    Windows Registry Editor Version 5.00

    # [HKEY_LOCAL_MACHINE\System\CurrentControlSet\Hardware Profiles\Current\Software\Fonts]
    # "LogPixels"=dword:000000F0

    [HKEY_CURRENT_USER\Software\Wine\X11 Driver]
    "Decorated"="N"
  '';
  bin = wrapWine {
    inherit name;
    executable = "$WINEPREFIX/drive_c/Program Files/Tencent/WeChat/WeChat.exe";
    tricks = ["riched20" "msls31"];
    setupScript = ''
      LANG="zh_CN.UTF-8"
    '';
    firstrunScript = ''
      # prevent weixin polluting my Documents folder
      rm -f $WINEPREFIX/drive_c/users/$USER/Documents
      mkdir -p $WINEPREFIX/drive_c/users/$USER/Documents

      wine ${installer}

      # å ç”¨ç£ç›˜ç©ºé—´æŒç»­å¢åŠ 
      # https://github.com/vufa/deepin-wine-wechat-arch/issues/225
      mkdir -p $WINEPREFIX/drive_c/users/xieby1/AppData/Roaming/Tencent/WeChat/xweb/crash/Crashpad/
      touch $WINEPREFIX/drive_c/users/xieby1/AppData/Roaming/Tencent/WeChat/xweb/crash/Crashpad/reports
    '';
    inherit regfile;
  };
  desktop = pkgs.makeDesktopItem {
    inherit name;
    desktopName = "Wineå¾®ä¿¡";
    genericName = "weixin";
    type = "Application";
    exec = "${bin}/bin/${name}";
    icon = pkgs.fetchurl {
      url = "https://cdn.cdnlogo.com/logos/w/79/wechat.svg";
      sha256 = "1xk1dsia6favc3p1rnmcncasjqb1ji4vkmlajgbks0i3xf60lskw";
    };
  };
in
pkgs.symlinkJoin {
  inherit name;
  paths = [bin desktop];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># based on https://github.com/lucasew/nixcfg/blob/49d44c1a655f1c20d7354ecea942c78704067d50/pkgs/wrapWine.nix
{ pkgs ? import &lt;nixpkgs&gt; {} }:
let
  inherit (builtins) length concatStringsSep;
  inherit (pkgs) lib cabextract
    writeShellScriptBin symlinkJoin;
  inherit (lib) makeBinPath;
in
{ is64bits ? false
, wine ? if is64bits then pkgs.wineWowPackages.stable else pkgs.wine
, wineFlags ? ""
, executable
, chdir ? null
, name
, tricks ? [ ]
, setupScript ? ""
, firstrunScript ? ""
, home ? ""
, regfile ? null
}:
let
  wineBin = "${wine}/bin/wine${if is64bits then "64" else ""}";
  requiredPackages = [
    wine
    cabextract
  ];
  PATH = makeBinPath requiredPackages;
  NAME = name;
  WINEARCH =
    if is64bits
    then "win64"
    else "win32";
  WINE_NIX = "$HOME/.wine-nix";
  WINEPREFIX = "${WINE_NIX}/${name}";
  setupHook = ''
    ${wine}/bin/wineboot
  '';
  tricksHook =
    if (length tricks) &gt; 0 then
      let
        tricksStr = concatStringsSep " " tricks;
        tricksCmd = ''
          ${pkgs.winetricks}/bin/winetricks ${tricksStr}
        '';
      in
      tricksCmd
    else "";
  run = writeShellScriptBin name ''
    export APP_NAME="${NAME}"
    export WINEARCH=${WINEARCH}
    export WINE_NIX=${WINE_NIX}
    export PATH=$PATH:${PATH}
    export WINEPREFIX="${WINEPREFIX}"
    export EXECUTABLE="${executable}"
    mkdir -p "$WINE_NIX"
    ${setupScript}
    if [ ! -e "$EXECUTABLE" ] # if the executable does not exist
    then
      ${if regfile!=null
        then ''${wineBin} regedit /C ${regfile}''
        else ""
      }
      ${setupHook}
      ${tricksHook}
      ${firstrunScript}
    else # no automatically run after installation!
      ${if chdir != null
        then ''cd "${chdir}"''
        else ""}
      if [ ! "$REPL" == "" ]; # if $REPL is setup then start a shell in the context
      then
        bash
        exit 0
      fi

      ${wineBin} ${wineFlags} "$EXECUTABLE" "$@"
    fi
  '';
  clean = writeShellScriptBin "${name}-clean" ''
    read -p "Are you sure you want to clean ${WINEPREFIX}? &lt;y/N&gt; " prompt
    if [[ $prompt =~ [yY](es)* ]]; then
      rm ${WINEPREFIX} -rf
    fi
  '';
  winecfg = writeShellScriptBin "${name}-cfg" ''
    export WINEARCH=${WINEARCH}
    WINEPREFIX=${WINE_NIX}/${name} winecfg $@
  '';
  _wine = writeShellScriptBin "${name}-wine" ''
    export WINEARCH=${WINEARCH}
    WINEPREFIX=${WINE_NIX}/${name} ${wineBin} $@
  '';
in
symlinkJoin {
  inherit name;
  paths = [run clean winecfg _wine];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, lib, pkgs, ... }: {
  config = lib.mkIf config.isWSL2 {
    fonts.fontconfig.enable = true;
    home.packages = with pkgs; [
      noto-fonts-cjk-sans
      noto-fonts-cjk-serif
      noto-fonts-emoji
    ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="xcolor"><a class="header" href="#xcolor">XColor</a></h1>
<p>Why use XColor instead of gcolor3 or eyedropper?
Because they do not support zoom: e.g. https://github.com/FineFindus/eyedropper/issues/79</p>
<pre><code class="language-nix">{ pkgs, ... }: {
  home.packages = [(
    let
      name = "xcolor-sleep";
      # [Error when launching xcolor from the Activities overview: Could not grab pointer #38](https://github.com/Soft/xcolor/issues/38)
      exec = pkgs.writeShellScript name ''
        for ((n=0; n&lt;3; n++)); do
          ${pkgs.xcolor}/bin/xcolor -s &amp;&amp; break
          sleep 0.2
        done
      '';
    in
    pkgs.runCommand name {} ''
      mkdir -p $out
      ${pkgs.xorg.lndir}/bin/lndir -silent ${pkgs.xcolor} $out
      rm $out/share/applications/XColor.desktop
      sed 's,^Exec.*,Exec=${exec},' ${pkgs.xcolor}/share/applications/XColor.desktop &gt; $out/share/applications/XColor.desktop
    ''
  )];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="xdot-the-dot-graphviz-viewer"><a class="header" href="#xdot-the-dot-graphviz-viewer">xdot, the dot (graphviz) viewer</a></h1>
<pre><code class="language-nix">{ config, pkgs, stdenv, lib, ... }:
let
</code></pre>
<p>Add a xdot.desktop for my xdot.</p>
<pre><code class="language-nix">  myxdot = pkgs.symlinkJoin {
    name = "myxdot";
    paths = [
      pkgs.xdot
      (pkgs.makeDesktopItem {
        name = "xdot";
        desktopName = "xdot";
        exec = "xdot %U";
        icon = builtins.toFile "cheatsheet.svg" ''
          &lt;svg width="64" height="64" xmlns="http://www.w3.org/2000/svg"&gt;
            &lt;rect width="100%" height="100%" rx="20%" ry="20%" fill="#F5F5F5"/&gt;
            &lt;text x="50%" y="50%" text-anchor="middle" dominant-baseline="middle" font-size="18" font-weight="bold" fill="#333333"&gt;
              xdot
            &lt;/text&gt;
          &lt;/svg&gt;
        '';
  })];};
in {
  home.packages = [
    myxdot
  ];
</code></pre>
<p>Open *.dot files with xdot.desktop by default.</p>
<pre><code class="language-nix">  xdg.mime.types.dot = {
    name = "graphviz-dot";
    type = "text/graphviz-dot";
    pattern = "*.dot";
    defaultApp = "xdot.desktop";
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{
  lib,
  stdenv,
  fetchurl,
  dpkg,
  qt5
}:
let
  version = "0.05";
  rpath = lib.makeLibraryPath [
    qt5.qtbase
  ] + ":${stdenv.cc.cc.lib}/lib64";
  src =
    if stdenv.hostPlatform.system == "x86_64-linux" then
      fetchurl {
        urls = [
          "https://github.com/horsicq/XELFViewer/releases/download/0.05/xelfviewer_0.05_Ubuntu_22.04_amd64.deb"
        ];
        sha256 = "0l6j0pnpfzwr8205xzis95k4x2la0mfy08bv6hfg32rh3bw906bz";
      }
    else
      throw "xelfviewer is not supported on ${stdenv.hostPlatform.system}";
in
stdenv.mkDerivation {
  pname = "xelfviewer";
  inherit version;

  system = "x86_64-linux";

  inherit src;

  nativeBuildInputs = [ qt5.wrapQtAppsHook ];

  buildInputs = [ dpkg ];

  dontUnpack = true;
  installPhase = ''
    mkdir -p $out
    dpkg-deb -x $src $out
    mv $out/usr/* $out/
    rm -r $out/usr
  '';

  postFixup = ''
    for file in $(find $out -type f \( -perm /0111 -o -name \*.so\* \) ); do
      patchelf --set-interpreter "$(cat $NIX_CC/nix-support/dynamic-linker)" "$file" || true
      patchelf --set-rpath ${rpath}:$out/lib/xelfviewer $file || true
    done
  '';

  meta = with lib; {
    description = "XELFViewer";
    homepage = "https://github.com/horsicq/XELFViewer";
    license = licenses.mit;
    maintainers = with maintainers; [ xieby1 ];
    platforms = [ "x86_64-linux" ];
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, lib, ...}: {
  config = lib.mkIf (
    (builtins.pathExists config.cachix_dhall) &amp;&amp;
    (config.cachix_packages != [])
  ) {
    home.activation.cachix_push = lib.hm.dag.entryAfter ["writeBoundary"] config._cachix_push;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ ... }: {
  imports = [
    ../../modules
    ./cachix.nix
    ./yq-merge
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ config, pkgs, lib, ... }: {
  options = {
    yq-merge = lib.mkOption {
      type = lib.types.attrsOf (
        lib.types.submodule {
          options = {
            text = lib.mkOption {
              default = null;
              type = lib.types.nullOr lib.types.lines;
              description = "Pass to home.home.&lt;xxx&gt;.text";
            };
            preOnChange = lib.mkOption {
              default = "";
              type = lib.types.lines;
            };
            postOnChange = lib.mkOption {
              default = "";
              type = lib.types.lines;
            };
          };
        }
      );
      default = {};
      description = ''
        Use yq to merge config file.
        The yq-merge."&lt;name&gt;" receive attr same as `home.file`.
      '';
      example = ./test.nix;
    };
  };
  config = {
    home.file = builtins.mapAttrs (old_target: value: rec {
      inherit (value) text;
      target = "${dirOf old_target}/yq-merge.${baseNameOf old_target}";
      onChange = /*bash*/ ''
        ${value.preOnChange}
        if [[ -e ${old_target} ]]; then
          # Operator: `*d` means deeply merge and deeply merge array
          # See: https://mikefarah.gitbook.io/yq/operators/multiply-merge
          # Noted: If the element of array is string, the old array will be overwrite.
          ${pkgs.yq-go}/bin/yq -i ea '. as $item ireduce ({}; . *d $item )' ~/${old_target} ~/${target}
        else
          cat ~/${target} &gt; ~/${old_target}
        fi
        ${value.postOnChange}
      '';
    }) config.yq-merge;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  pkgs = import &lt;nixpkgs&gt; {};
  hm = import &lt;home-manager/modules&gt; {
    inherit pkgs;
    configuration = {
      imports = [./.];
      home = {stateVersion="25.11"; username="dummy"; homeDirectory="/dummy";};
      # Config to be tested
      yq-merge.".config/miao.json" = {
        text = "miao miao!";
        preOnChange = ''
          echo wang
        '';
        postOnChange = ''
          echo zhi
        '';
      };
    };
  };
in pkgs.lib.runTests {
  test-target = {
    expr = hm.config.home.file.".config/miao.json".target;
    expected = ".config/yq-merge.miao.json";
  };
  test-text = {
    expr = hm.config.home.file.".config/miao.json".text;
    expected = "miao miao!";
  };
  test-onChange = {
    expr = hm.config.home.file.".config/miao.json".onChange != "";
    expected = true;
  };
  test-preOnChange = {
    expr = pkgs.lib.hasInfix "echo wang" hm.config.home.file.".config/miao.json".onChange;
    expected = true;
  };
  test-postOnChange = {
    expr = pkgs.lib.hasInfix "echo zhi" hm.config.home.file.".config/miao.json".onChange;
    expected = true;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nix-on-droidnix"><a class="header" href="#nix-on-droidnix">nix-on-droid.nix</a></h1>
<p><code>nix-on-droid.nix</code>æ˜¯å®‰å“nix-on-droidçš„å…¥å£é…ç½®æ–‡ä»¶ã€‚
å› ä¸ºåŸç”Ÿtermuxå¹¶ä¸èƒ½ç›´æ¥è¿è¡Œnixï¼Œ
æ‰€ä»¥nix-on-droidçš„ä½œè€…åŸºäºtermuxä½¿ç”¨prootæå‡ºæ¥ä¸€ä¸ªèƒ½è¿è¡Œnixçš„termuxåˆ†æ”¯ã€‚</p>
<p>nix-on-droidå¹¶æœªè‡ªå¸¦å¾ˆå¤šå¸¸ç”¨linuxå‘½ä»¤è¡Œå·¥å…·ï¼Œ
å› æ­¤<code>nix-on-droid.nix</code>ä¸»è¦è´Ÿè´£é…ç½®é‚£äº›åœ¨linuxå¸¸ç”¨çš„ï¼Œä½†nix-on-droidæ²¡æœ‰é»˜è®¤æä¾›çš„å‘½ä»¤è¡Œå·¥å…·ã€‚
å…¶ä»–å‘½ä»¤è¡Œå·¥å…·çš„é…ç½®åˆ™å¤ç”¨home-managerçš„é…ç½®<a href="./usr/default.nix.html"><code>./usr</code></a>ã€‚
ä¸‹é¢æ˜¯æˆ‘çš„å¸¦æ³¨è§£çš„<code>nix-on-droid.nix</code>ä»£ç ã€‚</p>
<pre><code class="language-nix">{ pkgs, config, ... }:

{
</code></pre>
<p>æ·»åŠ <code>sshd-start</code>å‘½ä»¤ï¼Œç”¨äºåœ¨å®‰å“ä¸Šå¯åŠ¨sshdæœåŠ¡ã€‚
é€šå¸¸å®‰å“ä¸Šæ˜¯æ²¡æœ‰rootæƒé™çš„ï¼Œæ— æ³•å†™/etc/ç›®å½•çš„æ–‡ä»¶ï¼Œ
å› æ­¤å°†sshçš„tmpç›®å½•å’Œé…ç½®ç›®å½•è®¾å®šåˆ°homeä¸‹é¢ã€‚
è¿™éƒ¨åˆ†å†…å®¹å‚è€ƒ<a href="https://github.com/t184256/nix-on-droid/wiki/SSH-access">nix-on-droid wiki: SSH access</a></p>
<pre><code class="language-nix">  imports = [(let
    sshdTmpDirectory = "${config.user.home}/sshd-tmp";
    sshdDirectory = "${config.user.home}/sshd";
    pathToPubKey = "${config.user.home}/.ssh/id_rsa.pub";
    port = 8022;
    sshd-start = pkgs.writeScriptBin "sshd-start" ''
      #!${pkgs.runtimeShell}

      echo "Starting sshd in non-daemonized way on port ${toString port}"
      ${pkgs.openssh}/bin/sshd -f "${sshdDirectory}/sshd_config" -D
    '';
  in {
    environment.packages = with pkgs; [
      sshd-start
    ];
    build.activation.sshd = ''
      $DRY_RUN_CMD mkdir $VERBOSE_ARG --parents "${config.user.home}/.ssh"
      $DRY_RUN_CMD cat ${pathToPubKey} &gt; "${config.user.home}/.ssh/authorized_keys"

      if [[ ! -d "${sshdDirectory}" ]]; then
        $DRY_RUN_CMD rm $VERBOSE_ARG --recursive --force "${sshdTmpDirectory}"
        $DRY_RUN_CMD mkdir $VERBOSE_ARG --parents "${sshdTmpDirectory}"

        $VERBOSE_ECHO "Generating host keys..."
        $DRY_RUN_CMD ${pkgs.openssh}/bin/ssh-keygen -t rsa -b 4096 -f "${sshdTmpDirectory}/ssh_host_rsa_key" -N ""

        $VERBOSE_ECHO "Writing sshd_config..."
        $DRY_RUN_CMD echo -e "HostKey ${sshdDirectory}/ssh_host_rsa_key\nPort ${toString port}\n" &gt; "${sshdTmpDirectory}/sshd_config"

        $DRY_RUN_CMD mv $VERBOSE_ARG "${sshdTmpDirectory}" "${sshdDirectory}"
      fi
    '';
  }) ({
</code></pre>
<p>è‡ªåŠ¨é…ç½®termuxã€‚</p>
<pre><code class="language-nix">    build.activation.termux = ''
      DIR=${config.user.home}/.termux
      mkdir -p $DIR
      symlink() {
        if [[ -e $1 &amp;&amp; ! -e $2 ]]; then
          #echo "ln -s $1 $2"
          ln -s $1 $2
        fi
      }
      SRC=${config.user.home}/Gist/Config/termux.properties
      DST=$DIR/termux.properties
      symlink $SRC $DST
      SRC=${config.user.home}/Gist/Config/colors.properties
      DST=$DIR/colors.properties
      symlink $SRC $DST
    '';
  })];

</code></pre>
<p>ä¸‹é¢æ˜¯éå¸¸ç›´è§‚çš„è½¯ä»¶å®‰è£…ã€‚</p>
<pre><code class="language-nix">  # Simply install just the packages
  environment.packages = with pkgs; [
    # User-facing stuff that you really really want to have
    vim  # or some other editor, e.g. nano or neovim
    # Some common stuff that people expect to have
    diffutils
    findutils
    utillinux
    tzdata
    hostname
    man
    gnugrep
    gnupg
    gnused
    gnutar
    bzip2
    gzip
    xz
    zip
    unzip
    gawk
    openssh
    nettools
    (lib.setPrio # make bintools less prior
      (busybox.meta.priority + 10)
      busybox
    )
  ];

  # Backup etc files instead of failing to activate generation if a file already exists in /etc
  environment.etcBackupExtension = ".bak";

  # Read the changelog before changing this value
  system.stateVersion = "21.11";

</code></pre>
<p>å¯¼å…¥home-managerçš„é…ç½®æ–‡ä»¶<a href="./usr/default.nix">./usr</a>çš„é…ç½®ã€‚
å¦‚æ­¤æ“ä½œï¼Œæ‰€æœ‰home-managerçš„è½¯ä»¶å’Œé…ç½®éƒ½èƒ½nix-on-droidä¸­å¤ç”¨ã€‚</p>
<pre><code class="language-nix">  home-manager.config = import ./usr;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p>ç”¨äºè‡ªåŠ¨pushåŒ…åˆ°cachixçš„æ¨¡å—ã€‚
å°½ç®¡cachix watch-storeèƒ½è‡ªåŠ¨pushï¼Œä½†æ˜¯æˆ‘æƒ³æ›´ç»†ç²’åº¦åœ°ç®¡ç†éœ€è¦pushçš„åŒ…ï¼Œæ‰€ä»¥æœ‰äº†è¿™ä¸ªæ¨¡å—ã€‚</p>
<pre><code class="language-nix">{ config, pkgs, lib, ...}:

{
  options = {
    cachix_packages = lib.mkOption {
      type = lib.types.listOf lib.types.package;
      default = [];
      description = ''
        This list of packages.

        If the the cachix.dhall file exists and cachix_packages is not empty,
        then the packages in cachix_packages will be pushed to cachix.
      '';
    };
    cachix_dhall = lib.mkOption {
      type = lib.types.str;
      default = "/home/xieby1/Gist/Config/cachix.dhall";
      description = ''
        The path of cachix.dhall.
      '';
    };
    cachix_name = lib.mkOption {
      type = lib.types.str;
      default = "xieby1";
      description = ''
        The cachix name.
      '';
    };
    _cachix_push = lib.mkOption {
      type = lib.types.str;
      default = ''
        mkdir -p ~/.config/cachix_push
        ${lib.concatMapStrings (pkg: ''
          symlink=~/.config/cachix_push/${pkg.name}
          if [[ ! (-h "$symlink" &amp;&amp; $(realpath "$symlink") == ${pkg}) ]]; then
            # the symlink are not the same to pkg, need to cachix push
            echo ğŸ“¦ ${pkg}
            ${pkgs.cachix}/bin/cachix -c ${config.cachix_dhall} push ${config.cachix_name} ${pkg}
            rm -f "$symlink"
            ln -s ${pkg} "$symlink"
          fi
        '') config.cachix_packages}
      '';
      description = ''
        (Internal usage) The script of pushing packages to cachix.
      '';
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ lib, ... }: {
  imports = [
    ./cachix.nix
  ];

  options = {
    isMinimalConfig = lib.mkOption {
      type = lib.types.bool;
      default = false;
    };
    proxyPort = lib.mkOption {
      type = lib.types.number;
      default = 8889;
      description = "ä»£ç†ç«¯å£å·ï¼Œè¯¸å¤šç½‘ç»œç¨‹åºéœ€è¦ç”¨ï¼Œæ¯”å¦‚clashå’Œtailscale";
    };
    isCli = lib.mkOption {
      type = lib.types.bool;
      default = (builtins.getEnv "DISPLAY")=="";
      description = ''
        `isCli`å’Œ`isGui`çš„é»˜è®¤å€¼é€šè¿‡ç¯å¢ƒå˜é‡`DISPLAY`æ¥åˆ¤æ–­æ˜¯å¦æ˜¯CLIæˆ–GUIç¯å¢ƒã€‚
        è¿™ä¸ªæ–¹æ³•æœ‰**å±€é™**ï¼Œæ¯”å¦‚sshè¿æ¥åˆ°ä¸€å°æœ‰GUIçš„ç”µè„‘ä¸Šï¼Œsshé‡Œæ˜¯æ²¡æœ‰è®¾ç½®ç¯å¢ƒå˜é‡`DISPLAY`çš„ã€‚
        å› æ­¤æ›´å¥½çš„æ–¹æ³•æ˜¯æ˜¾ç¤ºåœ°å£°æ˜sCliå’ŒisGuiçš„å€¼ã€‚
      '';
    };
    isGui = lib.mkOption {
      type = lib.types.bool;
      default = (builtins.getEnv "DISPLAY")!="";
    };
    isNixOnDroid = lib.mkOption {
      type = lib.types.bool;
      default = (builtins.getEnv "USER")=="nix-on-droid";
      description = ''
        é»˜è®¤å€¼æ˜¯é€šè¿‡ç”¨æˆ·åæ¥åˆ¤æ–­æ˜¯å¦æ˜¯nix-on-droidã€‚
      '';
    };
    isWSL2 = lib.mkOption {
      type = lib.types.bool;
      default = (builtins.getEnv "WSL_DISTRO_NAME")!="";
      description = ''
        é»˜è®¤å€¼æ˜¯é€šè¿‡ç¯å¢ƒå˜é‡`WSL_DISTRO_NAME`æ¥åˆ¤æ–­æ˜¯å¦æ˜¯WSL2ã€‚
      '';
    };
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><p>èµ·å› ï¼šlocal-typst-envå°†pkgsBuildTargetçš„æ–¹æ³•æ¢æˆäº†buildEnvã€‚
ä»”ç»†ä¸€é¡¹ä¸å¯¹å•Šï¼ŒpkgsBuildTargetæ˜¯buildtime depsï¼ŒbuildEnvï¼ˆæœ¬è´¨æ˜¯writeClosuresï¼‰æ˜¯runtime depsã€‚
ä¸ºä½•buildEnvä¹Ÿä¼šç”Ÿæ•ˆå‘¢ï¼Ÿ</p>
<p>ä»”ç»†çœ‹äº†çœ‹ï¼Œæ˜¯å› ä¸º<code>stdenv/setup.sh</code>æŠŠpropagatedXXXéƒ½å†™å…¥åˆ°äº†<code>$out/nix-support/propagated-xxx</code>ã€‚
å³å°†buildtime depsè½¬åŒ–ä¸ºäº†runtime depsã€‚</p>
<p>TODOï¼šnixå¦‚ä½•å¯»æ‰¾runtime depsè¿™ä¸ªæˆ‘æ²¡ç»†çœ‹ï¼Œä¾ç¨€è®°å¾—æ˜¯æ‰«æ<code>$out</code>é‡Œçš„æ‰€æœ‰è·¯å¾„ï¼Ÿ</p>
<ul>
<li>DONEï¼šå»çœ‹çœ‹ä¸ºä»€ä¹ˆ<code>stdenv/setup.sh</code>è¦è¿™ä¹ˆåšï¼Ÿ
æˆ‘è¿˜çœ‹åˆ°äº†ä¸å°‘packagesé‡Œï¼Œä¸ºäº†é¿å…ä¼ æ’­é”™è¯¯ï¼Œæ˜¾å¼åœ°<code>rm $out/nix-support/propagated-build-inputs</code>ã€‚</li>
<li>æˆ‘å»è¿½è¸ªäº†å†™<code>$out/nix-support/propagated-build-inputs</code>çš„å†å²ï¼Œ
f1166e0bbbc5b (Eelco Dolstra 2006-08-07) å°±å¼•å…¥äº†ï¼Œæ‰€ä»¥è¿™ç®—æ˜¯ä¸ªæ˜¯â€œç‰¹æ€§â€ï¼Ÿ
è‹¥ä¸æƒ³åšè‡ªåŠ¨buildtime deps =&gt; runtime depsè½¬æ¢ï¼Œåˆ™æ‰‹åŠ¨åˆ æ‰<code>$out/nix-support/propagated-xxx</code>å³å¯ï¼Ÿ</li>
<li>A: å› ä¸º<code>stdenv/setup.sh</code>è¿è¡Œçš„æ—¶å€™ï¼Œå·²ç»è·å–ä¸åˆ°derivationçš„ä¿¡æ¯äº†ï¼Ÿæ‰€ä»¥å¾—æŠŠ<code>propagated-xxx</code>ä¿¡æ¯å†™å…¥åˆ°<code>$out/</code>ç›®å½•é‡Œ</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><p>ä¿¡æ¯æ¥æºï¼š<code>&lt;nixpkgs&gt;/doc/stdenv/stdenv.chapter.md</code>å’Œnixpkgsæºç </p>
<h1 id="describing-dependency"><a class="header" href="#describing-dependency">Describing Dependency</a></h1>
<p>è¿™ä¸€éƒ¨åˆ†çš„å†…å®¹æ€»ç»“: è¯´æ˜stdenvé‡Œ6ä¸ªæè¿°ä¾èµ–çš„å˜é‡
depsBuildBuild, nativeBuildInputs, depsBuildTarget, depsHostHost, buildInputs, depsTargetTargetã€‚</p>
<ul>
<li><a href="https://nixos.org/manual/nixpkgs/unstable/#sec-cross-packaging">Packaging in a cross-friendly manner</a></li>
</ul>
<blockquote>
<p>Nixpkgs follows the conventions of GNU autoconf.
We distinguish between 3 types of platforms when building a derivation: build, host, and target.
In summary, build is the platform on which a package is being built,
host is the platform on which it will run.
The third attribute, target, is relevant only for certain specific compilers and build tools.</p>
</blockquote>
<ul>
<li><a href="https://nixos.org/manual/nixpkgs/unstable/#ssec-cross-dependency-categorization">Theory of dependency categorization</a></li>
</ul>
<blockquote>
<p>Possible dependency types</p>
<div class="table-wrapper"><table><thead><tr><th>Dep type</th><th>Depâ€™s host platform</th><th>Depâ€™s target platform</th></tr></thead><tbody>
<tr><td>build â†’ *</td><td>build</td><td>(none)</td></tr>
<tr><td>build â†’ build</td><td>build</td><td>build</td></tr>
<tr><td>build â†’ host</td><td>build</td><td>host</td></tr>
<tr><td>build â†’ target</td><td>build</td><td>target</td></tr>
<tr><td>host â†’ *</td><td>host</td><td>(none)</td></tr>
<tr><td>host â†’ host</td><td>host</td><td>host</td></tr>
<tr><td>host â†’ target</td><td>host</td><td>target</td></tr>
<tr><td>target â†’ *</td><td>target</td><td>(none)</td></tr>
<tr><td>target â†’ target</td><td>target</td><td>target</td></tr>
</tbody></table>
</div></blockquote>
<p>æ‰€æœ‰è¿™äº›è§†è§’æ˜¯æˆ‘ä»¬è¦ç¼–è¯‘çš„åŒ…å®ƒçœ‹åˆ°çš„ï¼Œç›¸å¯¹å®ƒè€Œè¨€çš„ï¼Œbuildã€hostã€targetæ˜¯æŒ‡å®ƒçš„buildã€hostã€targetå¹³å°</p>
<p>åˆ æ‰äº†ä¸‰ä¸ª*ï¼Œçœ‹æ¥æ˜¯</p>
<ul>
<li><code>build-&gt;*</code>è¢«<code>build-&gt;host</code>(nativeBuildInputs)ä»£æ›¿äº†</li>
<li><code>host-&gt;*</code>è¢«<code>host-&gt;target</code>(buildInputs)ä»£æ›¿äº†</li>
<li><code>target-&gt;*</code>ï¼Œ*ä»…åŒ…å«(none)å’Œtargetï¼Œè¢«<code>target-&gt;target</code>ä»£æ›¿äº†</li>
</ul>
<blockquote>
<div class="table-wrapper"><table><thead><tr><th>host â†’ target</th><th>attribute name</th><th>offset</th></tr></thead><tbody>
<tr><td>build --&gt; build</td><td>depsBuildBuild</td><td>-1, -1</td></tr>
<tr><td>build --&gt; host</td><td>nativeBuildInputs</td><td>-1, 0</td></tr>
<tr><td>build --&gt; target</td><td>depsBuildTarget</td><td>-1, 1</td></tr>
<tr><td>host --&gt; host</td><td>depsHostHost</td><td>0, 0</td></tr>
<tr><td>host --&gt; target</td><td>buildInputs</td><td>0, 1</td></tr>
<tr><td>target --&gt; target</td><td>depsTargetTarget</td><td>1, 1</td></tr>
</tbody></table>
</div></blockquote>
<h1 id="propagating-dependency"><a class="header" href="#propagating-dependency">Propagating Dependency</a></h1>
<ul>
<li><a href="https://nixos.org/manual/nixpkgs/unstable/#ssec-stdenv-dependencies-propagated">Dependency propagation</a></li>
</ul>
<p>è¿™ä¸€éƒ¨åˆ†çš„å†…å®¹æ€»ç»“ï¼š</p>
<ul>
<li>è¯´æ˜stdenvé‡Œ6ä¸ªæè¿°<strong>ç›´æ¥</strong>ä¼ é€’ä¾èµ–çš„å˜é‡
depsBuildBuildPropagated, propagatedNativeBuildInputs, depsBuildTargetPropagated,
depsHostHostPropagated, propagatedBuildInputs,
depsTargetTargetPropagatedã€‚</li>
<li>è¯´æ˜æ‰€æœ‰<strong>ç›´æ¥+é—´æ¥</strong>ï¼ˆä¼ é€’é—­åŒ…ï¼‰ä¾èµ–çš„å˜é‡åœ¨stdenv/setupé‡Œçš„å˜é‡
pkgsBuildBuild, pkgsBuildHost, pkgsBuildTarget,
pkgsHostHost, pkgsHostTarget,
pkgsTargetTargetã€‚</li>
</ul>
<h2 id="propagating-algorithm"><a class="header" href="#propagating-algorithm">Propagating Algorithm</a></h2>
<p>æ€»ç»“ï¼š
Nixæ–‡æ¡£å¹¶æœªè¯´æ˜è¿™ä¸ªç®—æ³•çš„æ™®é€‚æ€§ã€‚ï¼ˆè¿™ä¸ªç­‰æœªæ¥æœ‰éœ€æ±‚äº†å†è€ƒè™‘å§ï¼‰
è¿™ä¸ªç®—æ³•çš„ä¸€äº›ç‰¹æ®Šæƒ…å†µç¡®å®æ˜¯ç¬¦åˆç›´è§‰çš„ã€‚</p>
<h3 id="é—®é¢˜æè¿°"><a class="header" href="#é—®é¢˜æè¿°">é—®é¢˜æè¿°</a></h3>
<ul>
<li>Xä¾èµ–Yï¼ŒYä¾èµ–Zã€‚å…¶ä¸­ä¾èµ–é€šè¿‡ä¸Šä¸€èŠ‚çš„6ä¸ªå˜é‡æè¿°ã€‚è¿™æ ·æ²¡å•¥é—®é¢˜ã€‚</li>
<li>è‹¥ç°åœ¨Xä¾èµ–Yï¼ŒYä¼ é€’ä¾èµ–Zã€‚é‚£Xå¯¹Zçš„ä¾èµ–æ€ä¹ˆæè¿°ï¼Ÿ</li>
</ul>
<p>ç¬¦å·åŒ–ä¸Šé¢çš„é—®é¢˜ï¼š</p>
<ul>
<li>Xä¾èµ–Y &lt;=&gt; <code>dep(h, t, X, Y)</code>ï¼Œå…¶ä¸­hå’Œtä¸ºXä¾èµ–Yçš„ç±»å‹æ‰€å†³å®šçš„host/target offsetï¼Œè§ä¸Šä¸€èŠ‚çš„è¡¨æ ¼
<ul>
<li>ä¾‹å­<code>X.nativeBuildInputs = [Y]</code> =&gt; <code>dep(-1, 0, X, Y)</code></li>
</ul>
</li>
<li>Xä¼ é€’ä¾èµ–Y &lt;=&gt; <code>propagated-dep(h, t, X, Y)</code>
<ul>
<li>ä¾‹å­<code>X.depsBuildTargetPropagated = [T]</code> =&gt; <code>propagated-dep(-1, 1, X, Y)</code></li>
</ul>
</li>
<li>æ³¨ï¼šä¸ºä»€ä¹ˆä¸Šé¢çš„æ¨å¯¼ç¬¦å·ç”¨çš„æ˜¯=&gt;è€Œä¸æ˜¯&lt;=&gt;ï¼Ÿ
<ul>
<li>å› ä¸ºnixé‡Œæè¿°ä¾èµ–çš„6+6ä¸ªå˜é‡æ˜¯æè¿°çš„ç›´æ¥ä¾èµ–ï¼Œè€ŒæœªåŒ…å«é—´æ¥ï¼ˆä¼ é€’å¾—åˆ°çš„ï¼‰ä¾èµ–ã€‚
å³å­˜åœ¨<code>dep(h, t, X, Y)</code>ä½†<code>X.xxx = [...]</code>é‡ŒæœªåŒ…å«Yçš„æƒ…å†µã€‚
<ul>
<li>ä½ æƒ³çŸ¥é“ä»€ä¹ˆå˜é‡é‡Œè®°å½•ç€æ‰€æœ‰ï¼ˆç›´æ¥+é—´æ¥ï¼‰ä¾èµ–ï¼Ÿ
å¾€ä¸‹çœ‹ï¼Œåœ¨pkgs{Build/Host/Target}{Build/Host/Target}é‡Œã€‚
è¿™äº›å˜é‡éœ€è¦stdenvçš„setupé˜¶æ®µå¾—åˆ°ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>åˆ™ç¬¦å·åŒ–æè¿°ï¼š
<ul>
<li>å·²çŸ¥<code>dep(h_xy, t_xy, X, Y)</code>, <code>propagated-dep(h_yz, t_yz, Y, Z)</code></li>
<li>æ±‚<code>dep(h_xz, t_xz, X, Z)</code></li>
</ul>
</li>
</ul>
<p>nixç»™å‡ºçš„ç®—æ³•ï¼š</p>
<ul>
<li><code>h_xz = mapOffset(h_xy, t_xy, h_yz)</code></li>
<li><code>t_xz = mapOffset(h_xy, t_xy, t_yz)</code></li>
</ul>
<h4 id="æˆ‘çš„é€»è¾‘åˆ†æ"><a class="header" href="#æˆ‘çš„é€»è¾‘åˆ†æ">æˆ‘çš„é€»è¾‘åˆ†æ</a></h4>
<ul>
<li>å·²çŸ¥ï¼šdep(h_xy, t_xy, X, Y)</li>
<li>Yè§†è§’ä¸‹3ä¸ªå¹³å°ï¼šb_y(-1), h_y(0), t_y(1)åˆ°Xè§†è§’ä¸‹çš„å¹³å°çš„æ˜ å°„å…³ç³»ï¼š
<ul>
<li>b_yæœªçŸ¥/æ²¡æœ‰å•¥é€»è¾‘ï¼ŸYçš„buildå¹³å°åœ¨Xè§†è§’ä¸‹æ²¡æœ‰ä»»ä½•æ„ä¹‰æ‰å¯¹ã€‚
<ul>
<li>è¯´äººè¯ï¼Œç”¨X86-64åŸç”Ÿç¼–è¯‘çš„Y1å’Œç”¨AArch64äº¤å‰ç¼–è¯‘å‡ºçš„Y2ï¼Œå¯¹äºXéƒ½æ²¡å½±å“æ‰å¯¹ã€‚</li>
<li>æ›´è¿›ä¸€æ­¥æ€è€ƒï¼ŒNixé‡Œä¸Šè¿°ä¸¤ä¸ªåŒ…Y1å’ŒY2å…¶å®æ˜¯ä¸ä¸€æ ·çš„ã€‚è¿™æ˜¯ä¸æ˜¯æºè‡ªäºè¿™é‡Œï¼Ÿ
<ul>
<li>è¿™ä¸ªæœªæ¥å†è¯´å§</li>
</ul>
</li>
</ul>
</li>
<li>h_y -&gt; h_xyï¼šé€»è¾‘è§£è¯»ï¼šå­—é¢æ„æ€è€Œå·²ã€‚h_xyå°±æ˜¯å°±æ˜¯yçš„hï¼ˆh_yï¼‰åœ¨Xè§†è§’ä¸‹çš„å¹³å°ã€‚</li>
<li>t_y -&gt; t_xyï¼šé€»è¾‘è§£è¯»ï¼šå­—é¢æ„æ€è€Œå·²ã€‚t_xyå°±æ˜¯å°±æ˜¯yçš„tï¼ˆt_yï¼‰åœ¨Xè§†è§’ä¸‹çš„å¹³å°ã€‚</li>
</ul>
</li>
</ul>
<h4 id="mapoffseth-t-iåˆ†æ"><a class="header" href="#mapoffseth-t-iåˆ†æ"><code>mapOffset(h, t, i)</code>åˆ†æ</a></h4>
<ul>
<li>nixæ–‡æ¡£çš„å®šä¹‰<code>let mapOffset(h, t, i) = i + (if i &lt;= 0 then h else t - 1)</code>
<ul>
<li>è¿™ä¸ªå…¬å¼å†™è¿™ä¹ˆå¤æ‚ï¼Œå®å±å¾’å¢ä»£ç é˜…è¯»å¤æ‚åº¦ã€‚å…¶å®å°±æ˜¯ä¸‹é¢3ç§æƒ…å†µï¼ˆå®Œå…¨æšä¸¾ï¼‰ï¼š</li>
<li>mapOffset(h_xy, t_xy, -1) = -1 + h_xy
<ul>
<li>b_y -&gt; h_xy - 1</li>
</ul>
</li>
<li>mapOffset(h_xy, t_xy,  0) = h_xy
<ul>
<li>h_y -&gt; h_xy</li>
</ul>
</li>
<li>mapOffset(h_xy, t_xy,  1) = t_xy
<ul>
<li>t_y -&gt; t_xy</li>
</ul>
</li>
</ul>
</li>
<li>å³ç¬¦åˆæˆ‘çš„é€»è¾‘åˆ†æã€‚b_y -&gt; h_xy - 1ç®—æ˜¯ä¸€ä¸ªè‡ªç„¶å»¶ä¼¸ã€‚</li>
</ul>
<h2 id="see-how-propagating-algorithm-runs"><a class="header" href="#see-how-propagating-algorithm-runs">See How Propagating Algorithm Runs</a></h2>
<p>ä¸Šè¿°ä¼ é€’ç®—æ³•çš„å®é™…è¿ä½œè¿‡ç¨‹ï¼Œåœ¨stdenv/setupï¼ˆ<code>&lt;nixpkgs&gt;/pkgs/stdenv/generic/setup.sh</code>ï¼‰ä¸­ã€‚
æ ¸å¿ƒä»£ç æ¡†æ¶ç²¾ç®€å¦‚ä¸‹ï¼ˆä¼ªä»£ç ç”¨äº†rustçš„é«˜äº®ï¼Œå®é™…æ˜¯bashä»£ç ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>findInputs(pkg, hostOffset, targetOffset) {
  // å¾€6ä¸ªpkgsXXXå˜é‡ä¸­å¯¹åº”çš„ä¸€ä¸ªé‡Œæ·»åŠ pkg
  // eval "$var"'+=("$pkg")'
  pkgs{Build/Host/Target}{Build/Host/Target} += pkg

  for pkgNext in 6ä¸ªç›´æ¥ä¼ é€’ä¾èµ–å˜é‡é‡Œçš„åŒ… {
    hostOffsetNext = mapOffset(h, t, relHostOffset)
    targetOffsetNext = mapOffset(h, t, relTargetOffset)
    // è‡ªè¿­ä»£
    findInputs(pkgNext, hostOffsetNext, targetOffsetNext)
  }
}
<span class="boring">}</span></code></pre></pre>
<p>æ‰€ä»¥ä¾èµ–å›¾çš„éå†è¿‡ç¨‹åœ¨stdenv/setupä¸­findInputså‡½æ•°å®Œæˆã€‚
éå†åå¾—åˆ°æ‰€æœ‰ä¾èµ–ï¼ˆç›´æ¥ä¾èµ–ã€é—´æ¥ä¾èµ–ï¼‰æ”¾å…¥äº†6ä¸ªpkgs{Build/Host/Target}{Build/Host/Target}å˜é‡ä¸­ã€‚
è¿˜éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¾èµ–ä¼ é€’é€šè¿‡$pkg/nix-support/å¯¹åº”çš„æ–‡ä»¶propogateæ–‡ä»¶å®ç°ã€‚</p>
<p>æ³¨ï¼š6ä¸ªpkgs{Build/Host/Target}{Build/Host/Target}ä¸º<strong>æ•°ç»„å˜é‡</strong>ï¼Œ</p>
<ul>
<li>è‹¥ç”¨$pkgs{Build/Host/Target}{Build/Host/Target}åˆ™ä»…æ˜¾ç¤ºç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œè¿™æ˜¯bashçš„ç‰¹æ€§
<ul>
<li>ä¾‹ï¼š$pkgsHostTargetä»…ä¸ºç¬¬ä¸€ä¸ªå…ƒç´ </li>
</ul>
</li>
<li>éœ€è¦ç”¨${pkgs{Build/Host/Target}{Build/Host/Target}[@]}æ‰ä¼šæ˜¾ç¤ºæ‰€æœ‰å…ƒç´ ã€‚
<ul>
<li>ä¾‹ï¼š${pkgsHostTarget[@]}ä¸ºæ‰€æœ‰å…ƒç´ </li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="module"><a class="header" href="#module">Module</a></h1>
<p>nixpkgs/lib/modules.nix:
ä»<code>loadModule</code>å¯ä»¥çœ‹å‡ºï¼Œimportså¯ä»¥æ¥å—Functionã€Attrã€è·¯å¾„ï¼Œä¸èƒ½å¤ŸåµŒå¥—Listã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nixpkgs"><a class="header" href="#nixpkgs">Nixpkgs</a></h1>
<h2 id="nixpkgs-crosssystem"><a class="header" href="#nixpkgs-crosssystem">nixpkgs crossSystem</a></h2>
<ul>
<li>default.nix
<ul>
<li>pkgs/top-level/impure.nix
<ul>
<li>pkgs/top-level/default.nix
<ul>
<li>lib.systems.elaborate crossSystem0;
<ul>
<li>lib/systems/default.nix: elaborate
<ul>
<li>parsed = parse.mkSystemFromString ... args.system; // args.system = crossSystem
<ul>
<li>lib/systems/parse.nix
<ul>
<li>mkSystemFromString = s: mkSystemFromSkeleton (mkSkeletonFromList (lib.splitString "-" s));
<ul>
<li>mkSkeletonFromList</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>æ³¨æ„mkSkeletonFromListé€šè¿‡
<code>${toString (length l)}</code>
å®ç°äº†ä¸€ä¸ªæ ¹æ®lé•¿åº¦çš„switch caseã€‚</p>
<p>crossSystemçš„4ä¸ªåŸŸåˆ†åˆ«ä¸ºcpu-vendor-kernel-abi</p>
<h2 id="import-nixpkgs"><a class="header" href="#import-nixpkgs">import nixpkgs</a></h2>
<p><code>import &lt;nixpgks&gt; {}</code>
çš„åŠ è½½æµç¨‹</p>
<ul>
<li>default.nix
<ul>
<li>pkgs/top-level/impure.nix
<ul>
<li>pkgs/top-level/default.nix
<ul>
<li>stdenvStages import pkgs/stdenv/default.nix
<ul>
<li>stagesLinux = import pkgs/stdenv/linux/
<ul>
<li>thisStdenv, stdenv = import pkgs/stdenv/generic/default.nix
<ul>
<li>import lib/default.nix
<h1 id="this-is-where-customisationnix-come-from"><a class="header" href="#this-is-where-customisationnix-come-from">this is where customisation.nix come from</a></h1>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>allPackages import pkgs/top-level/stage.nix
<ul>
<li>allPackages import pkgs/top-level/all-packages.nix</li>
</ul>
</li>
<li>boot = import pkgs/stdenv/booter.nix</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>vim_configurable.override {python = python3}
vimUtils.makeCustomizable (vim.override {python = python3})
vimUtils.makeCustomizable (vim.override {python = python3})</p>
<p>ä¼¼ä¹æ˜¯ä¸€ä¸ªæµ®ç°overrideå˜é‡çš„æœ€å°é›†
f = a:{res = a+1;}
fo = pkgsMiao.makeOverride f
f 2</p>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><h1 id="æ‰“åŒ…ç¼–è¯‘32ä½ç¨‹åº"><a class="header" href="#æ‰“åŒ…ç¼–è¯‘32ä½ç¨‹åº">æ‰“åŒ…/ç¼–è¯‘32ä½ç¨‹åº</a></h1>
<p>å‚è€ƒ<a href="https://nixos.wiki/wiki/Packaging/32bit_Applications">Packaging/32bit Applications</a>ã€‚</p>
<h2 id="ä»…32ä½"><a class="header" href="#ä»…32ä½">ä»…32ä½</a></h2>
<p>æ‰“åŒ…ä½¿ç”¨pkgs.pkgsi686Linux.stdenv.mkDerivation</p>
<p>ç¼–è¯‘ä½¿ç”¨pkgs.pkgsi686Linux.gcc</p>
<h2 id="32ä½ä¸”64ä½"><a class="header" href="#32ä½ä¸”64ä½">32ä½ä¸”64ä½</a></h2>
<p>æ‰“åŒ…ä½¿ç”¨pkgs.multiStdenv.mkDerivationã€‚</p>
<p>ç¼–è¯‘ä½¿ç”¨pkgs.gcc_multiã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="auto-push-packages-to-cachix"><a class="header" href="#auto-push-packages-to-cachix">Auto Push Packages to Cachix</a></h1>
<p><strong>Objective</strong>:
Automatically push specific built packages to cachix during <code>home-manager switch</code>/<code>nixos-rebuild switch</code>/<code>nix-shell</code>.</p>
<p>Although there are several existing ways to achieve this:</p>
<ul>
<li>cachix's <a href="https://docs.cachix.org/pushing">watch-exec and watch-store</a></li>
<li>nix-build's <a href="https://nixos.org/manual/nix/stable/advanced-topics/post-build-hook">post-build-hook</a></li>
</ul>
<p>However, the granularity of these methods is coarse; they push all packages to cachix.
Is there a way to allow users to control which packages are pushed?</p>
<h2 id="conclusion-first"><a class="header" href="#conclusion-first">Conclusion First</a></h2>
<p>Use <strong>hooks</strong> to push the selected packages to cachix:</p>
<div class="table-wrapper"><table><thead><tr><th>Scenario</th><th>Hook</th><th>Example</th></tr></thead><tbody>
<tr><td>home-manager</td><td><code>home.activation</code></td><td><a href="docs/howto/auto_push_to_cachix/../../../modules/cachix.nix.html">modules/cachix.nix</a>, <a href="docs/howto/auto_push_to_cachix/../../../usr/modules/cachix.nix.html">usr/modules/cachix.nix</a></td></tr>
<tr><td>nixos-rebuild</td><td><code>system.activationScripts</code></td><td><a href="docs/howto/auto_push_to_cachix/../../../modules/cachix.nix.html">modules/cachix.nix</a>, <a href="docs/howto/auto_push_to_cachix/../../../sys/modules/cachix.nix.html">sys/modules/cachix.nix</a></td></tr>
<tr><td>nix-shell</td><td><code>shellHook</code></td><td><a href="https://github.com/xieby1/openc910/blob/main/shell.nix">openc910/shell.nix</a></td></tr>
</tbody></table>
</div>
<hr />
<h2 id="my-explorations"><a class="header" href="#my-explorations">My Explorations</a></h2>
<p><strong>Possible solutions</strong>:
Add a wrapper called <code>cachixPackages</code>, which recives the packages to be pushed and cachix information.
This <code>cachixPackages</code> is a dummy package whose build stages will push the packages to cachix.
However, normal nix packages are not allowed network access during building.
To tackle this, like how fetch* series functions are implemented, the <a href="https://nixos.org/manual/nix/stable/language/advanced-attributes#adv-attr-outputHash">fixed-output derivation</a> can be utilized to allow network access.</p>
<p>However, the above method seems not work as below,
because cachix needs accesses to some resources beyond nix-build process (such as nix-build's sandbox).</p>
<pre><code class="language-bash">nix-build example.nix
...
cachix: CppStdException e "\ESC[31;1merror:\ESC[0m creating directory '\ESC[35;1m/nix/var\ESC[0m': \ESC[35;1mPermission denied\ESC[0m"(Just "nix::SysError")
result 1
...
</code></pre>
<p>Even though I disable the nix-build sandbox by using <code>--no-sandbox</code>,
the cachix still does not satisfy as below.</p>
<pre><code class="language-bash">$ nix-build example.nix --no-sandbox
...
cachix: CppStdException e "\ESC[31;1merror:\ESC[0m cannot open connection to remote store '\ESC[35;1mdaemon\ESC[0m': \ESC[35;1m\ESC[31;1merror:\ESC[0m reading from file: \ESC[35;1mConnection reset by peer\ESC[0m\ESC[0m"(Just "nix::Error")
...
</code></pre>
<p>If you curious about my demo of <code>cachixPackages</code> and its example,
see <a href="docs/howto/auto_push_to_cachix/./cachix-package.nix.html">cachix-package.nix</a> and <a href="docs/howto/auto_push_to_cachix/./example.nix.html">example.nix</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cachixpackage"><a class="header" href="#cachixpackage">cachixPackage</a></h1>
<p>This file try to implement a package wrapper, which will automatically push <code>pkg</code> to cachix upon building.
However, this method seems not work, due to limited resources in nix-build environment.
For more details, see <a href="docs/howto/auto_push_to_cachix/./index.html">here</a>.</p>
<pre><code class="language-nix">{ cachix
, stdenv
, writeShellScript
}:

{ pkg
, sha256
, cachix_dhall
, cachix_name
, name ? "cachixed"
}:

builtins.derivation {
  inherit name;
  system = builtins.currentSystem;
  builder = writeShellScript "cachix-package-builder" ''
    source ${stdenv}/setup
    echo ${pkg} &gt; $out
    if [[ -f "${cachix_dhall}" ]]; then
      ${cachix}/bin/cachix -c ${cachix_dhall} push ${cachix_name} ${pkg}
      result=$?
      echo result $result
      exit $result
    fi
  '';

  outputHashMode = "flat";
  outputHashAlgo = "sha256";
  outputHash = sha256;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="example-for-cachixpackage"><a class="header" href="#example-for-cachixpackage">Example for cachixPackage</a></h1>
<p>To run the example:</p>
<pre><code class="language-bash"># run with nix-build sandbox
nix-build example.nix
# run without nix-build sandbox
nix-build example.nix --no-sandbox
</code></pre>
<pre><code class="language-nix">let
  pkgs = import &lt;nixpkgs&gt; {};
  cachixPackage = import ./cachix-package.nix {inherit (pkgs) cachix stdenv writeShellScript;};
in cachixPackage {
  pkg = pkgs.hello;
  sha256 = "01vm275n169r0ly8ywgq0shgk8lrzg79d1aarshwybwxwffj4q0q";
  cachix_dhall = /home/xieby1/Gist/Config/cachix.dhall;
  cachix_name = "xieby1";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å¤‡ä»½binary-cache"><a class="header" href="#å¤‡ä»½binary-cache">å¤‡ä»½binary cache</a></h1>
<h2 id="åœºæ™¯"><a class="header" href="#åœºæ™¯">åœºæ™¯</a></h2>
<p>å®˜æ–¹binary cacheæ²¡æœ‰çš„åŒ…ï¼Œ è‡ªå·±èŠ±äº†å¾ˆé•¿æ—¶é—´ç¼–è¯‘å‡ºæ¥ã€‚
å€¼å¾—æŠŠç¼–è¯‘å‡ºæ¥çš„çš„åŒ…åŠå…¶ä¾èµ–å…¨éƒ¨ä¿å­˜ä¸‹æ¥ã€‚</p>
<h2 id="ç›®å‰çš„é—®é¢˜"><a class="header" href="#ç›®å‰çš„é—®é¢˜">ç›®å‰çš„é—®é¢˜</a></h2>
<p>nix copy --to <path> å¤‡ä»½çš„/nix/storeå¦‚ä½•ä½¿ç”¨ï¼Ÿ</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="äº¤å‰ç¼–è¯‘å’Œå®‰è£…è·¨å¹³å°ç¨‹åº"><a class="header" href="#äº¤å‰ç¼–è¯‘å’Œå®‰è£…è·¨å¹³å°ç¨‹åº">äº¤å‰ç¼–è¯‘å’Œå®‰è£…è·¨å¹³å°ç¨‹åº</a></h1>
<p>nixpkgsåŸç”Ÿæ”¯æŒx86å’ŒarmæŒ‡ä»¤é›†ã€‚
é€šè¿‡å¯¹nixpkgsé…ç½®å¯ä»¥è½»æ¾å®ç°äº¤å‰ç¼–è¯‘ï¼Œ
è·¨å¹³å°ç¨‹åºçš„å®‰è£…ç­‰åŠŸèƒ½ã€‚</p>
<h2 id="å¤ªé•¿ä¸çœ‹"><a class="header" href="#å¤ªé•¿ä¸çœ‹">å¤ªé•¿ä¸çœ‹</a></h2>
<ul>
<li>
<p>x86_64ä¸Šçš„aarch64äº¤å‰ç¼–è¯‘å™¨</p>
<p><code>(with import &lt;nixpkgs&gt; {crossSystem="aarch64-linux";}; stdenv.cc)</code></p>
</li>
<li>
<p>aarch64çš„helloåº”ç”¨ç¨‹åº</p>
<p><code>(with import &lt;nixpkgs&gt; {localSystem.system="aarch64-linux";crossSystem="aarch64-linux";}; hello)</code></p>
</li>
<li>
<p>åº”ç”¨äºnix-shellçš„ä¾‹å­</p>
<p><a href="https://xieby1.github.io/scripts/index.html#shell_cross_platformnix">shell_cross_platform.nix</a></p>
</li>
</ul>
<h2 id="ç›®å½•-1"><a class="header" href="#ç›®å½•-1">ç›®å½•</a></h2>
<!-- vim-markdown-toc GFM -->
<ul>
<li><a href="docs/howto/cross.html#%E7%AE%80%E4%BB%8B">ç®€ä»‹</a></li>
<li><a href="docs/howto/cross.html#localsystem%E5%92%8Ccrosssystem%E7%9A%84%E8%AF%AD%E6%B3%95"><code>localSystem</code>å’Œ<code>crossSystem</code>çš„è¯­æ³•</a>
<ul>
<li><a href="docs/howto/cross.html#cpu-vendor-kernel-abi">cpu-vendor-kernel-abi</a>
<ul>
<li><a href="docs/howto/cross.html#cpu">cpu</a>
<ul>
<li><a href="docs/howto/cross.html#cputypes">cpuTypes</a></li>
</ul>
</li>
<li><a href="docs/howto/cross.html#vendor">vendor</a></li>
<li><a href="docs/howto/cross.html#kernel">kernel</a></li>
<li><a href="docs/howto/cross.html#abi">abi</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="docs/howto/cross.html#localsystem%E5%92%8Ccrosssystem%E7%9A%84%E5%BA%94%E7%94%A8"><code>localSystem</code>å’Œ<code>crossSystem</code>çš„åº”ç”¨</a>
<ul>
<li><a href="docs/howto/cross.html#aarch64%E4%BA%A4%E5%8F%89%E5%B7%A5%E5%85%B7%E9%93%BE%E5%92%8C%E7%A8%8B%E5%BA%8F%E7%9A%84%E8%AF%A6%E7%BB%86%E4%BE%8B%E5%AD%90">aarch64äº¤å‰å·¥å…·é“¾å’Œç¨‹åºçš„è¯¦ç»†ä¾‹å­</a></li>
<li><a href="docs/howto/cross.html#mips%E4%BA%A4%E5%8F%89%E5%B7%A5%E5%85%B7%E9%93%BE%E7%9A%84%E4%BE%8B%E5%AD%90">mipsäº¤å‰å·¥å…·é“¾çš„ä¾‹å­</a></li>
</ul>
</li>
<li><a href="docs/howto/cross.html#crosssystem%E7%9A%84%E4%BC%A0%E9%80%92">crossSystemçš„ä¼ é€’</a></li>
<li><a href="docs/howto/cross.html#%E5%BC%95%E7%94%A8">å¼•ç”¨</a></li>
</ul>
<!-- vim-markdown-toc -->
<h2 id="ç®€ä»‹"><a class="header" href="#ç®€ä»‹">ç®€ä»‹</a></h2>
<p>nixpkgs<sup class="footnote-reference"><a href="#version">1</a></sup>ä¼—å¤šè¾“å…¥å‚æ•°ä¸­ï¼ŒåŒ…å«<code>localSystem</code>å’Œ<code>crossSystem</code><sup class="footnote-reference"><a href="#localSystem_crossSystem">2</a></sup>ã€‚</p>
<ul>
<li>
<p><code>localSystem</code></p>
<blockquote>
<p>The system packages will be built on.</p>
</blockquote>
<p>æœ¬åœ°ç³»ç»Ÿï¼Œå³å·¥å…·é“¾è¿è¡Œçš„å¹³å°ã€‚</p>
</li>
<li>
<p><code>crossSystem</code></p>
<blockquote>
<p>The system packages will ultimately be run on.</p>
</blockquote>
<p>ç¨‹åºè¿è¡Œçš„å¹³å°ã€‚</p>
</li>
</ul>
<p>é€šè¿‡<code>localSystem</code>å’Œ<code>crossSystem</code>ä¸åŒå€¼çš„ç»„åˆï¼Œ
å¯ä»¥å®ç°äº¤å‰ç¼–è¯‘ã€å®‰è£…å…¶ä»–æ¶æ„çš„åŸç”Ÿåº”ç”¨ã€‚
ä¸‹é¢ä»<code>localSystem</code>å’Œ<code>crossSystem</code>çš„è¯­æ³•å’Œåº”ç”¨ä¸¤æ–¹é¢è¿›è¡Œä»‹ç»ã€‚
è¯­æ³•ç« èŠ‚ä»nixpkgsæºç çš„è§’åº¦å‡ºå‘ï¼Œä»‹ç»å…¶è¯­æ³•çš„ç»„æˆã€‚
åº”ç”¨ç« èŠ‚å›´ç»•ä¸€ä¸ªnix-shellè„šæœ¬çš„å®é™…ä¾‹å­ï¼Œ
ä»‹ç»x86_64å¹³å°çš„äº¤å‰ç¼–è¯‘å’Œå®‰è£…aarch64æ¶æ„çš„åŸç”Ÿåº”ç”¨çš„æ–¹æ³•ã€‚</p>
<h2 id="localsystemå’Œcrosssystemçš„è¯­æ³•"><a class="header" href="#localsystemå’Œcrosssystemçš„è¯­æ³•"><code>localSystem</code>å’Œ<code>crossSystem</code>çš„è¯­æ³•</a></h2>
<p><code>localSystem</code>å’Œ<code>crossSystem</code>ç”±4ä¸ªç»´åº¦å»åˆ»ç”»ä¸€ä¸ªç³»ç»Ÿï¼šcpu, vendor, kernel, abiã€‚
<code>localSystem</code>å’Œ<code>crossSystem</code>çš„å€¼ä¸ºå­—ç¬¦ä¸²æˆ–è€…<code>{system=å­—ç¬¦ä¸²;}</code><sup class="footnote-reference"><a href="#localSystem_crossSystem_type">3</a></sup>ã€‚
systemå­—ç¬¦ä¸²ä¸ºå¯ä»¥åŒ…å«å‰è¿°4ä¸ªç»´åº¦çš„1~4ä¸ªç»´åº¦ã€‚
nixåœ¨è§£ææ—¶ä¼šå°†çœç•¥çš„ç»´åº¦æŒ‰ä»¥æŸäº›é»˜è®¤å€¼è¡¥å……å®Œæ•´ã€‚
ç»´åº¦ä¹‹é—´ä¹‹é—´ç”¨<code>-</code>åˆ†å‰²ã€‚
å› æ­¤systemå­—ç¬¦ä¸²å½¢å¼ä¸Šä¸º<code>"cpu-vendor-kernel-abi"</code>ã€‚
å­—ç¬¦ä¸²ä¸åŒæ•°é‡çš„ç»´åº¦åŠå…¶å¯ç”¨çš„å€¼ï¼Œ
æŒ‰åŒ¹é…ä¼˜å…ˆçº§ç”±é«˜åˆ°ä½åˆ—ä¸¾å¦‚ä¸‹<sup class="footnote-reference"><a href="#skeleton">4</a></sup>ï¼Œ</p>
<h3 id="cpu-vendor-kernel-abi"><a class="header" href="#cpu-vendor-kernel-abi">cpu-vendor-kernel-abi</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">systemå­—ç¬¦ä¸²</th><th style="text-align: center">cpu</th><th style="text-align: center">vendor</th><th style="text-align: center">kernel</th><th style="text-align: center">abi</th></tr></thead><tbody>
<tr><td style="text-align: center">"avr"</td><td style="text-align: center">avr</td><td style="text-align: center"></td><td style="text-align: center">none</td><td style="text-align: center">unknown</td></tr>
<tr><td style="text-align: center">"{cpu}-cygwin"</td><td style="text-align: center">{cpu}</td><td style="text-align: center"></td><td style="text-align: center">windows</td><td style="text-align: center">cygnus</td></tr>
<tr><td style="text-align: center">"{cpu}-windows"</td><td style="text-align: center">{cpu}</td><td style="text-align: center"></td><td style="text-align: center">windows</td><td style="text-align: center">msvc</td></tr>
<tr><td style="text-align: center">"{cpu}-elf"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">unknown</td><td style="text-align: center">none</td><td style="text-align: center">elf</td></tr>
<tr><td style="text-align: center">"{cpu}-{kernel}"</td><td style="text-align: center">{cpu}</td><td style="text-align: center"></td><td style="text-align: center">{kernel}</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-apple-{kernel}"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">apple</td><td style="text-align: center">{kernel}</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-linux-gnu"</td><td style="text-align: center">{cpu}</td><td style="text-align: center"></td><td style="text-align: center">linux</td><td style="text-align: center">gnu</td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-mingw32"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">{vendor}</td><td style="text-align: center">windows</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-wasi"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">{vendor}</td><td style="text-align: center">wasi</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-redox"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">{vendor}</td><td style="text-align: center">redox</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-mmixware"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">{vendor}</td><td style="text-align: center">mmixware</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-netbsd*"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">{vendor}</td><td style="text-align: center">netbsd*</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-eabi"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">unknown</td><td style="text-align: center">{kernel}</td><td style="text-align: center">eabi</td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-eabihf"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">unknown</td><td style="text-align: center">{kernel}</td><td style="text-align: center">eabihf</td></tr>
<tr><td style="text-align: center">"{cpu}-{kernel}-elf"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">unknown</td><td style="text-align: center">{kernel}</td><td style="text-align: center">elf</td></tr>
<tr><td style="text-align: center">"{cpu}-*-{ghcjs}"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">unknown</td><td style="text-align: center">ghcjs</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-genode"</td><td style="text-align: center">{cpu}</td><td style="text-align: center">{vendor}</td><td style="text-align: center">genode</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"{cpu}-{vendor}-{kernel}-{abi} "</td><td style="text-align: center">{cpu}</td><td style="text-align: center">{vendor}</td><td style="text-align: center">{kernel}</td><td style="text-align: center">{abi}</td></tr>
</tbody></table>
</div>
<h4 id="cpu"><a class="header" href="#cpu">cpu</a></h4>
<p>cpuå­—ç¬¦ä¸²å¯å–çš„å€¼åˆ—ä¸¾å¦‚ä¸‹<sup class="footnote-reference"><a href="#cpuTypes">5</a></sup>,</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">cpuå­—ç¬¦ä¸²</th><th style="text-align: center">bits</th><th style="text-align: center">significantByte</th><th style="text-align: center">family</th><th style="text-align: center">version</th><th style="text-align: center">arch</th></tr></thead><tbody>
<tr><td style="text-align: center">"arm"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"armv5tel"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"5"</td><td style="text-align: center">"armv5t"</td></tr>
<tr><td style="text-align: center">"armv6m"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"6"</td><td style="text-align: center">"armv6-m"</td></tr>
<tr><td style="text-align: center">"armv6l"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"6"</td><td style="text-align: center">"armv6"</td></tr>
<tr><td style="text-align: center">"armv7a"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"7"</td><td style="text-align: center">"armv7-a"</td></tr>
<tr><td style="text-align: center">"armv7r"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"7"</td><td style="text-align: center">"armv7-r"</td></tr>
<tr><td style="text-align: center">"armv7m"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"7"</td><td style="text-align: center">"armv7-m"</td></tr>
<tr><td style="text-align: center">"armv7l"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"7"</td><td style="text-align: center">"armv7"</td></tr>
<tr><td style="text-align: center">"armv8a"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"8"</td><td style="text-align: center">"armv8-a"</td></tr>
<tr><td style="text-align: center">"armv8r"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"8"</td><td style="text-align: center">"armv8-a"</td></tr>
<tr><td style="text-align: center">"armv8m"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"8"</td><td style="text-align: center">"armv8-m"</td></tr>
<tr><td style="text-align: center">"aarch64"</td><td style="text-align: center">64</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"8"</td><td style="text-align: center">"armv8-a"</td></tr>
<tr><td style="text-align: center">"aarch64_be"</td><td style="text-align: center">64</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"arm"</td><td style="text-align: center">"8"</td><td style="text-align: center">"armv8-a"</td></tr>
<tr><td style="text-align: center">"i386"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"x86"</td><td style="text-align: center"></td><td style="text-align: center">"i386"</td></tr>
<tr><td style="text-align: center">"i486"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"x86"</td><td style="text-align: center"></td><td style="text-align: center">"i486"</td></tr>
<tr><td style="text-align: center">"i586"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"x86"</td><td style="text-align: center"></td><td style="text-align: center">"i586"</td></tr>
<tr><td style="text-align: center">"i686"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"x86"</td><td style="text-align: center"></td><td style="text-align: center">"i686"</td></tr>
<tr><td style="text-align: center">"x86_64"</td><td style="text-align: center">64</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"x86"</td><td style="text-align: center"></td><td style="text-align: center">"x86-64"</td></tr>
<tr><td style="text-align: center">"mips"</td><td style="text-align: center">32</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"mips"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"mipsel"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"mips"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"mips64"</td><td style="text-align: center">64</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"mips"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"mips64el"</td><td style="text-align: center">64</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"mips"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"mmix"</td><td style="text-align: center">64</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"mmix"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"m68k"</td><td style="text-align: center">32</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"m68k"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"powerpc"</td><td style="text-align: center">32</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"power"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"powerpc64"</td><td style="text-align: center">64</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"power"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"powerpc64le"</td><td style="text-align: center">64</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"power"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"powerpcle"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"power"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"riscv32"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"riscv"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"riscv64"</td><td style="text-align: center">64</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"riscv"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"s390"</td><td style="text-align: center">32</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"s390"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"s390x"</td><td style="text-align: center">64</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"s390"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"sparc"</td><td style="text-align: center">32</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"sparc"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"sparc64"</td><td style="text-align: center">64</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"sparc"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"wasm32"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"wasm"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"wasm64"</td><td style="text-align: center">64</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"wasm"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"alpha"</td><td style="text-align: center">64</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"alpha"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"msp430"</td><td style="text-align: center">16</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"msp430"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"avr"</td><td style="text-align: center">8</td><td style="text-align: center"></td><td style="text-align: center">"avr"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"vc4"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"vc4"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"or1k"</td><td style="text-align: center">32</td><td style="text-align: center">bigEndian</td><td style="text-align: center">"or1k"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"js"</td><td style="text-align: center">32</td><td style="text-align: center">littleEndian</td><td style="text-align: center">"js"</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
</tbody></table>
</div>
<h5 id="cputypes"><a class="header" href="#cputypes">cpuTypes</a></h5>
<p>cpuä¹‹é—´çš„å…¼å®¹æ€§ï¼ˆå…·æœ‰ä¼ é€’æ€§å’Œè‡ªåæ€§ï¼‰å¦‚ä¸‹<sup class="footnote-reference"><a href="#isCompatible">6</a></sup>ï¼Œ</p>
<p><img src="docs/howto/./images/cpu_isCompatible.dot.svg" alt="" /></p>
<h4 id="vendor"><a class="header" href="#vendor">vendor</a></h4>
<p>vendorå­—ç¬¦ä¸²å¯å–å€¼<code>"apple"</code>, <code>"pc"</code>(windows), <code>"w64"</code>(MinGW-w64), <code>"none"</code>, <code>"unknown"</code>(default)ã€‚</p>
<h4 id="kernel"><a class="header" href="#kernel">kernel</a></h4>
<p>kernelå­—ç¬¦ä¸²å¯å–å€¼å¦‚ä¸‹è¡¨<sup class="footnote-reference"><a href="#kernels">7</a></sup>ï¼Œ</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">kernelå­—ç¬¦ä¸²</th><th style="text-align: center">execFormat</th><th style="text-align: center">families</th></tr></thead><tbody>
<tr><td style="text-align: center">"macos"</td><td style="text-align: center">macho</td><td style="text-align: center">darwin</td></tr>
<tr><td style="text-align: center">"darwin"</td><td style="text-align: center">â†‘</td><td style="text-align: center">â†‘</td></tr>
<tr><td style="text-align: center">"ios"</td><td style="text-align: center">macho</td><td style="text-align: center">darwin</td></tr>
<tr><td style="text-align: center">"watchos"</td><td style="text-align: center">â†‘</td><td style="text-align: center">â†‘</td></tr>
<tr><td style="text-align: center">"tvos"</td><td style="text-align: center">â†‘</td><td style="text-align: center">â†‘</td></tr>
<tr><td style="text-align: center">"freebsd"</td><td style="text-align: center">elf</td><td style="text-align: center">bsd</td></tr>
<tr><td style="text-align: center">"linux"</td><td style="text-align: center">elf</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"netbsd"</td><td style="text-align: center">elf</td><td style="text-align: center">bsd</td></tr>
<tr><td style="text-align: center">"none"</td><td style="text-align: center">unknown</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"openbsd"</td><td style="text-align: center">elf</td><td style="text-align: center">bsd</td></tr>
<tr><td style="text-align: center">"solaris"</td><td style="text-align: center">elf</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"wasi"</td><td style="text-align: center">wasm</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"redox"</td><td style="text-align: center">elf</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"windows"</td><td style="text-align: center">pe</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"win32"</td><td style="text-align: center">â†‘</td><td style="text-align: center">â†‘</td></tr>
<tr><td style="text-align: center">"ghcjs"</td><td style="text-align: center">unknown</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"genode"</td><td style="text-align: center">elf</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"mmixware"</td><td style="text-align: center">unknown</td><td style="text-align: center"></td></tr>
</tbody></table>
</div>
<h4 id="abi"><a class="header" href="#abi">abi</a></h4>
<p>abiå­—ç¬¦ä¸²å¯å–çš„å€¼åˆ—ä¸¾å¦‚ä¸‹<sup class="footnote-reference"><a href="#abis">8</a></sup>ï¼Œ</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">abiå­—ç¬¦ä¸²</th><th style="text-align: center">float</th><th style="text-align: center">abi</th><th style="text-align: center">Note</th></tr></thead><tbody>
<tr><td style="text-align: center">"cygnus"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"msvc"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"eabi"</td><td style="text-align: center">soft</td><td style="text-align: center"></td><td style="text-align: center">for ARM, PowerPC</td></tr>
<tr><td style="text-align: center">"eabihf"</td><td style="text-align: center">hard</td><td style="text-align: center"></td><td style="text-align: center">for ARM, PowerPC</td></tr>
<tr><td style="text-align: center">"elf"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"androideabi"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"android"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center">not 32-bit</td></tr>
<tr><td style="text-align: center">"gnueabi"</td><td style="text-align: center">soft</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"gnueabihf"</td><td style="text-align: center">hard</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"gnu"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center">not 32-bit</td></tr>
<tr><td style="text-align: center">"gnuabi64"</td><td style="text-align: center"></td><td style="text-align: center">64</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"musleabi"</td><td style="text-align: center">soft</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"musleabihf"</td><td style="text-align: center">hard</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"musl"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"uclibceabihf"</td><td style="text-align: center">soft</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"uclibceabi"</td><td style="text-align: center">hard</td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"uclibc"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"unknown"</td><td style="text-align: center"></td><td style="text-align: center"></td><td style="text-align: center"></td></tr>
</tbody></table>
</div>
<h2 id="localsystemå’Œcrosssystemçš„åº”ç”¨"><a class="header" href="#localsystemå’Œcrosssystemçš„åº”ç”¨"><code>localSystem</code>å’Œ<code>crossSystem</code>çš„åº”ç”¨</a></h2>
<h3 id="aarch64äº¤å‰å·¥å…·é“¾å’Œç¨‹åºçš„è¯¦ç»†ä¾‹å­"><a class="header" href="#aarch64äº¤å‰å·¥å…·é“¾å’Œç¨‹åºçš„è¯¦ç»†ä¾‹å­">aarch64äº¤å‰å·¥å…·é“¾å’Œç¨‹åºçš„è¯¦ç»†ä¾‹å­</a></h3>
<p>ä»¥x86ä¸ºæœ¬åœ°æŒ‡ä»¤é›†ï¼Œ<code>localSystem</code>å’Œ<code>crossSystem</code>çš„ç»„åˆæœ‰ä»¥ä¸‹æ•ˆæœ</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">â†“<code>crossSystem</code>â†“ â†’<code>localSystem</code>â†’</th><th style="text-align: center">"x86_64-linux"</th><th style="text-align: center">"aarch64-linux"</th></tr></thead><tbody>
<tr><td style="text-align: center">"x86_64-linux"</td><td style="text-align: center">é€šå¸¸æƒ…å†µ</td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">"aarch64-linux"</td><td style="text-align: center">äº¤å‰ç¼–è¯‘aarch64</td><td style="text-align: center">åŸç”Ÿaarch64åº”ç”¨</td></tr>
</tbody></table>
</div>
<p>å› æ­¤åŸºäºè¿™3ç§ç»„åˆï¼Œå¯ä»¥åœ¨åŒä¸€ä¸ªshellç¯å¢ƒä¸­é…ç½®å‡º3ç§è½¯ä»¶ï¼Œ
ä»£ç è§[cross_platform.nix]({{ site.repo_url }}/scripts/shell/cross_platform.nix)ã€‚</p>
<p><code>pkgs_arm_cross</code>è½¯ä»¶åŒ…çš„<code>stdenv.cc</code>ä¸ºx86å¹³å°çš„armäº¤å‰ç¼–è¯‘å™¨ã€‚
nixpkgs channelåªåŒ…å«äº†åŸç”Ÿx86åº”ç”¨å’ŒåŸç”Ÿarmåº”ç”¨ã€‚
äº¤å‰ç¼–è¯‘çš„armåº”ç”¨å’ŒåŸç”Ÿarmåº”ç”¨çš„derivationä¸ä¸€æ ·ã€‚
å› æ­¤ä½¿ç”¨<code>pkgs_arm_cross</code>ä¸­çš„åº”ç”¨ï¼Œ
åˆ™ä¼šä½¿ç”¨äº¤å‰ç¼–è¯‘å™¨ä»æºç å¼€å§‹ç¼–è¯‘armåº”ç”¨ï¼Œ
è€Œä¸æ˜¯ç›´æ¥æ‹‰å–nixpkgs channelçš„åŸç”Ÿarmåº”ç”¨ã€‚</p>
<p><code>pkgs_arm_native</code>è½¯ä»¶åŒ…åŒ…å«åŸç”Ÿarmè½¯ä»¶åŒ…ã€‚
ä»è¿™ä¸ªè½¯ä»¶åŒ…æ‹‰å–çš„åº”ç”¨å’Œåœ¨armå¹³å°çš„æ‹‰å–åˆ°çš„åº”ç”¨ä¸€è‡´ã€‚
ä¾‹å¦‚<code>figlet</code>å°†ç›´æ¥ä»nix channelä¸­æ‹‰å–ã€‚</p>
<p><code>pkgs</code>å³x86åŸç”Ÿçš„è½¯ä»¶åŒ…ã€‚</p>
<p>shell_cross_platform.nixä½¿ç”¨ä¾‹å­ï¼Œ</p>
<pre><code class="language-bash"># åˆ›å»ºä¸€ä¸ªæ–°çš„shellç¯å¢ƒï¼ŒåŒ…å«stdenv.cc, figlet, qemu
$ nix-shell shell_cross_platform.nix

# ä½¿ç”¨äº¤å‰ç¼–è¯‘å·¥å…·é“¾çš„cç¼–è¯‘å™¨
$ aarch64-unknown-linux-gnu-gcc helloworld.c -o helloworld
$ file helloworld
helloworld: ELF 64-bit LSB executable, ARM aarch64, version 1 (SYSV), dynamically linked, interpreter /nix/store/01kw0gb38phviarfv3fca49dpqh0qwlx-glibc-aarch64-unknown-linux-gnu-2.33-123/lib/ld-linux-aarch64.so.1, for GNU/Linux 2.6.32, with debug_info, not stripped

# armåŸç”Ÿåº”ç”¨
$ file `command -v figlet`
/nix/store/4f70f04bvd664n00jlnzccyzxd35lykw-figlet-2.2.5/bin/figlet: ELF 64-bit LSB executable, ARM aarch64, version 1 (SYSV), dynamically linked, interpreter /nix/store/rjc27shzir243n1w3127w713fijamf6v-glibc-2.33-123/lib/ld-linux-aarch64.so.1, for GNU/Linux 2.6.32, not stripped

# ç›´æ¥æ‰§è¡Œfigletä¼šå‡ºé”™
$ figlet
bash: /nix/store/4f70f04bvd664n00jlnzccyzxd35lykw-figlet-2.2.5/bin/figlet: cannot execute binary file: Exec format error

# ä½¿ç”¨QEMUæ‰§è¡Œfigletå³å¯
$ qemu-aarch64 `command -v figlet` miao!
           _             _
 _ __ ___ (_) __ _  ___ | |
| '_ ` _ \| |/ _` |/ _ \| |
| | | | | | | (_| | (_) |_|
|_| |_| |_|_|\__,_|\___/(_)
</code></pre>
<h3 id="mipsäº¤å‰å·¥å…·é“¾çš„ä¾‹å­"><a class="header" href="#mipsäº¤å‰å·¥å…·é“¾çš„ä¾‹å­">mipsäº¤å‰å·¥å…·é“¾çš„ä¾‹å­</a></h3>
<p>[cross_mips.nix]({{ site.repo_url }}/scripts/shell/cross_mips.nix)</p>
<h2 id="crosssystemçš„ä¼ é€’"><a class="header" href="#crosssystemçš„ä¼ é€’">crossSystemçš„ä¼ é€’</a></h2>
<ul>
<li>pkgs/top-level/stage.nix:
<ul>
<li>
<pre><code class="language-nix">pkgsCross = lib.mapAttrs (n: crossSystem:
  nixpkgsFun { inherit crossSystem; })
  lib.systems.examples;
</code></pre>
</li>
</ul>
</li>
<li>å…¶ä¸­pkgs/top-level/default.nix: <code>nixpkgsFun = newArgs: import ./. (args // newArgs);</code></li>
<li>ä¹Ÿå°±æ˜¯è¯´lib.systems.examplesçš„æ¯ä¸ªå…ƒç´ ä½œä¸ºcrossSystemä¼ é€’ç»™äº†pkgs/top-level/default.nix</li>
<li>pkgs/top-level/default.nix:
<ul>
<li>é¦–å…ˆcrossSystem = lib.systems.elaborate crossSystem0</li>
<li>æ¥ä¸‹æ¥æ˜¯æ¨å¯¼</li>
<li>pkgs = boot stages;</li>
<li>pkgs = boot (stdenvStages {inherit crossSystem ...});</li>
<li>pkgs = boot (import ../stdenv {inherit crossSystem ...})</li>
</ul>
</li>
<li>pkgs/stdenv/default.nix:
<ul>
<li>pkgs = boot (import ./cross {inherit crossSystem ...})</li>
</ul>
</li>
<li>pkgs/stdenv/cross/default.nix:
<ul>
<li>pkgs = boot (lib.init bootStages ++ [(...) (..crossSystem..) (..crossSystem..)])</li>
<li>åŒ…å«äº†è‹¥å¹²ä¸ªstagesï¼ŒåŒ…æ‹¬æœ¬åœ°çš„bootStagesçš„å‰å‡ ä¸ªstagesã€å’ŒcrossSystemç›¸å…³çš„3ä¸ªstagesï¼ˆå…¶å®åªæœ‰æœ€åä¸¤ä¸ªstagesä½¿ç”¨äº†crossSystemï¼‰</li>
<li>è¿™é‡Œéœ€è¦ææ¸…æ¥šbootæ˜¯æ€ä¹ˆè°ƒç”¨stagesçš„</li>
<li>pkgs/top-level/default.nix:
<ul>
<li>boot = import ../stdenv/boï¼ˆ__raw=falseæˆ–æœªå®šä¹‰ï¼‰oter.nix { inherit lib allPackages; };</li>
<li>boot = import ../stdenv/booter.nix { ...; allPackages = newArgs: import ./stage.nix ({inherit lib nixpkgsFun;} // newArgs);};</li>
</ul>
</li>
<li>pkgs/stdenv/booter.nix:
<ul>
<li>
<p>æ³¨é‡Šå†™äº†bootçš„åŠŸèƒ½ï¼Œå¦‚ä¸‹ï¼š
å‚æ•°ä¸ºä¸€ä¸ªå‡½æ•°æ•°ç»„ï¼Œæ¯ä¸ªå‡½æ•°çš„è¾“å…¥ä¸ºpkgsetï¼Œè¾“å‡ºè¦ä¹ˆæ˜¯pkgsetçš„å‚æ•°ï¼ˆ__raw=falseæˆ–æœªå®šä¹‰ï¼‰ï¼Œè¦ä¹ˆæ˜¯pkgssetï¼ˆ__raw=trueï¼‰ã€‚
ï¼ˆè¿™é‡Œè¯´çš„â€œpkgsetçš„å‚æ•°â€ä¼šä¼ ç»™allPackagesï¼ˆæ˜¯ä¸ªå‡½æ•°ï¼Œè§ä¸Šï¼‰ï¼‰</p>
<pre><code class="language-nix"># Type:
#   [ pkgset -&gt; (args to stage/default.nix) or ({ __raw = true; } // pkgs) ]
#   -&gt; pkgset
#
# In english: This takes a list of function from the previous stage pkgset and
# returns the final pkgset. Each of those functions returns, if `__raw` is
# undefined or false, args for this stage's pkgset (the most complex and
# important arg is the stdenv), or, if `__raw = true`, simply this stage's
# pkgset itself.
</code></pre>
</li>
</ul>
</li>
<li>æ‰€ä»¥æœ€ç»ˆè¿˜æ˜¯å¾—çœ‹ä¸‹é¢ä¸¤ä¸ªä½¿ç”¨äº†crossSystemçš„stages</li>
</ul>
</li>
<li>pkgs/stdenv/cross/default.nix:
<ul>
<li>
<p>pkgs = boot (lib.init bootStages ++ [(...) â¶(..crossSystem..) â·(..crossSystem..)])</p>
</li>
<li>
<p>â¶</p>
<pre><code class="language-nix">  # Build tool Packages
  (vanillaPackages: {
    ...
    stdenv = assert ...;
      vanillaPackages.stdenv.override { targetPlatform = crossSystem; };
    ...
  })
</code></pre>
<p>è¾“å…¥æ˜¯vanillaPackagesï¼Œè¾“å‡ºæ˜¯buildPackagesçš„å‚æ•°ï¼ˆä¸ºç”Ÿæˆä¸‹ä¸€çº§çš„è¾“å…¥pkgsetå³buildPackagesï¼‰ã€‚
å› æ­¤ï¼Œè¿™ä¸€çº§ï¼ˆå³buildPackagesï¼ŒpkgsCross.<xxx>.buildPackagesï¼‰çš„3ä¸ªå¹³å°ä¸ºï¼š</p>
<div class="table-wrapper"><table><thead><tr><th>build</th><th>host</th><th>target</th></tr></thead><tbody>
<tr><td>localSystem</td><td>localSystem</td><td>crossSystem</td></tr>
</tbody></table>
</div>
<p>å› æ­¤è¿™ä¸€çº§çš„åŒ…æ˜¯ç”¨æ¥æ„å»ºå„ç§äº¤å‰å·¥å…·é“¾çš„åŒ…ã€‚</p>
<p>æ³¨ï¼šnixpkgsé‡Œä¹Ÿæœ‰å«buildPackagesçš„åŒ…ï¼Œå®šä¹‰ä½äºpkgs/top-level/stage.nixï¼š
buildPackagesæ˜¯pkgsBuildHostçš„åˆ«åï¼Œå…¶ä¸­pkgs<theirHost><theirTarget>ã€‚</p>
</li>
<li>
<p>â·</p>
<pre><code class="language-nix"># Run Packages
(buildPackages: let
  ...
  stdenNoCC = adaptStdenv (buildPackages.stdenv.override (old: rec {
    buildPlatform = localSystem;
    hostPlatform = crossSystem;
    targetPlatform = crossSystem;
    ...
  }));
in {
  ...
  stdenv = let
    baseStdenv = stdenNoCC.override {
      cc = ... buildPackages.gcc;
    }
  in ... baseStdenv;
  ...
})
</code></pre>
<p>è¿™ä¸€çº§è¾“å…¥æ˜¯buildPackagesï¼Œè¾“å‡ºå°±æ˜¯æˆ‘ä»¬å¹³æ—¶pkgsCross.<xxx>çš„åŒ…é›†åˆäº†ã€‚
è¿™ä¸€çº§ï¼ˆå³pkgsCross.<xxx>ï¼‰çš„3ä¸ªå¹³å°ä¸º</p>
<div class="table-wrapper"><table><thead><tr><th>build</th><th>host</th><th>target</th></tr></thead><tbody>
<tr><td>localSystem</td><td>crossSystem</td><td>crossSystem</td></tr>
</tbody></table>
</div>
<p>å…¶ä¸­è¦æ³¨æ„çš„æ˜¯ï¼ŒpkgsCross.<xxx>.stdenv.ccå°±æ˜¯pkgsCross.<xxx>.buildPackages.gccã€‚</p>
</li>
</ul>
</li>
</ul>
<h2 id="å¼•ç”¨-1"><a class="header" href="#å¼•ç”¨-1">å¼•ç”¨</a></h2>
<div class="footnote-definition" id="version"><sup class="footnote-definition-label">1</sup>
<p>nixpkgsç‰ˆæœ¬2022.01.20, commit hash: 7e149abe9db1509fa974bb2286f862a761ca0a07</p>
</div>
<div class="footnote-definition" id="localSystem_crossSystem"><sup class="footnote-definition-label">2</sup>
<p>nixpkgs/pkgs/top-level/default.nix</p>
</div>
<div class="footnote-definition" id="localSystem_crossSystem_type"><sup class="footnote-definition-label">3</sup>
<p>nixpkgs/lib/systems/default.nix: <code>elaborate</code></p>
</div>
<div class="footnote-definition" id="skeleton"><sup class="footnote-definition-label">4</sup>
<p>nixpkgs/lib/systems/parse.nix: <code>mkSkeletonFromList</code></p>
</div>
<div class="footnote-definition" id="cpuTypes"><sup class="footnote-definition-label">5</sup>
<p>nixpkgs/lib/systems/parse.nix: <code>cpuTypes</code></p>
</div>
<div class="footnote-definition" id="isCompatible"><sup class="footnote-definition-label">6</sup>
<p>nixpkgs/lib/systems/parse.nix: <code>isCompatible</code></p>
</div>
<div class="footnote-definition" id="kernels"><sup class="footnote-definition-label">7</sup>
<p>nixpkgs/lib/systems/parse.nix: <code>kernels</code></p>
</div>
<div class="footnote-definition" id="abis"><sup class="footnote-definition-label">8</sup>
<p>nixpkgs/lib/systems/parse.nix: <code>abis</code></p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å®‰è£…nixos"><a class="header" href="#å®‰è£…nixos">å®‰è£…NixOS</a></h1>
<p>å®‰è£…è¿‡ç¨‹é‡‡ç”¨<a href="https://nixos.org/manual/nixos/stable/#sec-installation">å®˜æ–¹å®‰è£…æ–‡æ¡£</a>ã€‚
è‹¥å·²å®‰è£…NixOSï¼Œåˆ™å¯è·³è¿‡è¯¥æ­¥éª¤ï¼Œç›´æ¥çœ‹å®‰è£…æˆ‘çš„é…ç½®ã€‚</p>
<h2 id="å‡†å¤‡é•œåƒ"><a class="header" href="#å‡†å¤‡é•œåƒ">å‡†å¤‡é•œåƒ</a></h2>
<p>QEMU:</p>
<pre><code class="language-bash"># ä¸‹è½½minimal ISOé•œåƒï¼šhttps://nixos.org/download.html
# åˆ›å»ºqemuç¡¬ç›˜ï¼ˆå¤§å°32GBï¼‰
qemu-img create -f qcow2 &lt;output/path/to/nix.qcow2&gt; 32G
# å°†ISOå®‰è£…åˆ°qemuç¡¬ç›˜
qemu-system-x86_64 -display gtk,window-close=off -vga virtio -device e1000,netdev=net0 -netdev user,id=net0,hostfwd=tcp::5556-:22,smb=/home/xieby1/ -m 4G -smp 3 -enable-kvm -hda &lt;/path/to/nix.qcow2&gt; -cdrom &lt;/path/to/nixos-minial.iso&gt; -boot d &amp;
</code></pre>
<p>ç‰©ç†æœº:</p>
<pre><code class="language-bash"># æš‚æ—¶æœªæ¢ç©¶å‘½ä»¤è¡Œè¿æ¥wifiçš„æ–¹æ³•
# æ‰€ä»¥ç›®å‰ä½¿ç”¨gnomeç‰ˆISOï¼Œè€Œéminimal ISOã€‚
# ä¸‹è½½gnome ISOé•œåƒï¼šhttps://nixos.org/download.html
# å¯åŠ¨Uç›˜åˆ¶ä½œ
sudo dd if=&lt;path/to/nixos.iso&gt; of=&lt;/dev/your_usb&gt;
sync
# é‡å¯è¿›å…¥Uç›˜ç³»ç»Ÿ
# æ³¨ï¼šéœ€è¦åœ¨BIOSä¸­å–æ¶ˆsecure bootï¼Œå¦åˆ™Uç›˜æ— æ³•å¯åŠ¨ã€‚
</code></pre>
<h2 id="åˆ†åŒº"><a class="header" href="#åˆ†åŒº">åˆ†åŒº</a></h2>
<p>è¿›å…¥ISOç³»ç»Ÿåï¼Œåˆ›å»ºåˆ†åŒºã€‚
ä¸€å…±éœ€è¦3ä¸ªåˆ†åŒºï¼šå¯åŠ¨åˆ†åŒºï¼Œæ“ä½œç³»ç»Ÿåˆ†åŒºï¼Œswapåˆ†åŒºã€‚
QEMUå’Œç‰©ç†æœºå•ç³»ç»Ÿéœ€è¦åˆ›å»ºè¿™3ä¸ªåˆ†åŒºã€‚
ç‰©ç†æœºåŒç³»ç»Ÿä¸­å¯åŠ¨åˆ†åŒºå·²æœ‰ï¼Œåªéœ€åˆ›å»ºå‰©ä¸‹2ä¸ªåˆ†åŒºã€‚</p>
<p>QEMU:</p>
<pre><code class="language-bash">sudo bash
parted /dev/sda -- mklabel msdos
parted /dev/sda -- mkpart primary 1MiB -8GiB
parted /dev/sda -- mkpart primary linux-swap -8GiB 100%
</code></pre>
<p>ç‰©ç†æœºå•ç³»ç»Ÿ:</p>
<pre><code class="language-bash">parted /dev/sda -- mklabel gpt
parted /dev/sda -- mkpart primary 512MiB -8GiB
parted /dev/sda -- mkpart primary linux-swap -8GiB 100%
parted /dev/sda -- mkpart ESP fat32 1MiB 512MiB
parted /dev/sda -- set 3 esp on
</code></pre>
<p>ç‰©ç†æœºåŒç³»ç»Ÿ:</p>
<p><strong>æ³¨</strong>ï¼šç”¨diskåˆ›å»ºçš„æ–‡ä»¶ç³»ç»Ÿï¼Œæƒé™ä¸å¯¹ï¼Œå®‰è£…å®Œåä¼šæœ‰å„ç§å¥‡æ€ªçš„é—®é¢˜ã€‚
å› æ­¤æ¨èå‘½ä»¤è¡Œæ“ä½œï¼Œæˆ–è€…diskä¹‹åå†æ‰§è¡Œä¸‹ä¸€èŠ‚çš„æŒ‡ä»¤ã€‚</p>
<p>è¿˜æœªæ¢ç´¢partedè¯¦ç»†ç”¨æ³•ï¼Œç›®å‰ä½¿ç”¨diskè½¯ä»¶å¯è§†åŒ–åˆ†åŒºã€‚</p>
<ul>
<li>åˆ›å»ºExt4åˆ†åŒºï¼Œå–åä¸ºnixos</li>
<li>åˆ›å»ºOther-&gt;swapåˆ†åŒº</li>
</ul>
<h2 id="æ–‡ä»¶ç³»ç»Ÿ"><a class="header" href="#æ–‡ä»¶ç³»ç»Ÿ">æ–‡ä»¶ç³»ç»Ÿ</a></h2>
<pre><code class="language-bash">mkfs.ext4 -L nixos /dev/&lt;ç³»ç»Ÿåˆ†åŒº&gt;
mkswap -L swap /dev/&lt;swapåˆ†åŒº&gt;
swapon /dev/&lt;swapåˆ†åŒº&gt;
mkfs.fat -F 32 -n boot /dev/&lt;å¯åŠ¨åˆ†åŒº&gt;      # ç‰©ç†æœºå•ç³»ç»Ÿ
mount /dev/disk/by-label/nixos /mnt
mkdir -p /mnt/boot                          # ç‰©ç†æœºå•ç³»ç»Ÿ&amp;åŒç³»ç»Ÿ
mount /dev/disk/by-label/boot /mnt/boot     # ç‰©ç†æœºå•ç³»ç»Ÿ&amp;åŒç³»ç»Ÿ
</code></pre>
<h2 id="åŸºç¡€é…ç½®"><a class="header" href="#åŸºç¡€é…ç½®">åŸºç¡€é…ç½®</a></h2>
<ul>
<li>ç”Ÿæˆé…ç½®æ–‡ä»¶</li>
</ul>
<pre><code class="language-bash">nixos-generate-config --root /mnt
</code></pre>
<ul>
<li>ä¿®æ”¹/mnt/etc/nixos/configuration.nixï¼Œ
<ul>
<li>ä¿®æ”¹åå­—<code>networking.hostName</code></li>
<li>å¯ç”¨ä»£ç†
<ul>
<li>QEMUä¸­å®¿ä¸»æœºå™¨çš„ipä¸º10.0.2.2</li>
<li>å®‰è£…è¿‡ç¨‹ä¸­éœ€è¦å€ŸåŠ©åˆ«çš„è®¡ç®—æœºæˆ–å®¿ä¸»æœºçš„çš„ä»£ç†æœåŠ¡</li>
<li>éƒ¨ç½²å®Œæˆ‘çš„nixosé…ç½®åï¼Œå°†ä¼šæœ‰clashæœåŠ¡ï¼Œå¯ä»¥ç”¨è™šæ‹Ÿæœºçš„ä»£ç†æœåŠ¡</li>
<li><code>networking.proxy.default = "http://user:password@proxy:port/";</code></li>
<li><code>networking.proxy.noProxy = "127.0.0.1,localhost,internal.domain";</code></li>
</ul>
</li>
<li>ï¼ˆQEMUå’Œç‰©ç†æœºå•ç³»ç»Ÿï¼‰å–æ¶ˆä»¥ä¸‹æ³¨é‡Šä»¥å¼€å¯grubæ”¯æŒ
<ul>
<li><code>boot.loader.grub.device = "/dev/sda";</code></li>
</ul>
</li>
<li>å–æ¶ˆé˜²ç«å¢™ï¼Œä»¥ä¾¿kdeconnectæ­£å¸¸è¿è¡Œ
<ul>
<li><code>networking.firewall.enable = false;</code></li>
</ul>
</li>
<li>ï¼ˆç‰©ç†æœºåŒç³»ç»Ÿï¼‰è‡ªåŠ¨æ¢æµ‹æ“ä½œç³»ç»Ÿå¯åŠ¨é¡¹
<ul>
<li><code>boot.loader.grub.useOSProber = true;</code></li>
</ul>
</li>
<li>æ·»åŠ ç”¨æˆ·
<ul>
<li><code>users.users.xieby1</code></li>
</ul>
</li>
<li>æ·»åŠ è½¯ä»¶
<ul>
<li><code>environment.systemPackages = with pkgs; [vim git];</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>æœ€å</p>
<pre><code class="language-bash">nixos-install
reboot
</code></pre>
<p>é‡å¯ä¹‹åï¼Œè¿›å…¥NixOSã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="how-to-config-linux-kernel-in-nix"><a class="header" href="#how-to-config-linux-kernel-in-nix">How To Config Linux Kernel in Nix</a></h1>
<p>Basic configuration tricks referring to <a href="https://nixos.wiki/wiki/Linux_kernel">nixos.wiki: Linux Kernel</a>.</p>
<h2 id="the-override-system-in-kernel"><a class="header" href="#the-override-system-in-kernel">The Override System in Kernel</a></h2>
<p>What do the <code>pkgs.linux.override</code>, <code>pkgs.linux.overrideAttrs</code> override?</p>
<p>To answer these questions, we need first to explore how kernel derivation is generated.
When we type <code>pkgs.linux</code>, how this derivation is generated by nix?</p>
<pre><code>* pkgs.linux
* pkgs/top-level/all-packages:
  * linuxPackages.kernel;
  * (linuxPackages = linuxKernel.packageAliases.linux_default).kernel;
  * (linuxPackages = (linuxKernel = recurseIntoAttrs (callPackage ./linux-kernels.nix { });).packageAliases.linux_default).kernel;
  * (recurseIntoAttrs (callPackage ./linux-kernels.nix { });).packageAliases.linux_default.kernel;
* pkgs/top-level/linux-kernels.nix:
  * packages.linux_6_6.kernel;
  * (recurseIntoAttrs (vanillaPackages // rtPackages // rpiPackages // { ... })).linux_6_6.kernel
  * (recurseIntoAttrs ({...; linux_6_6 = recurseIntoAttrs (packagesFor kernels.linux_6_6);...} // rtPackages // rpiPackages // { ... })).linux_6_6.kernel
  * (packagesFor kernels.linux_6_6).kernel
  * ((kernel_: {kernel = kernel_;}) kernels.linux_6_6).kernel
  * kernels.linux_6_6
  * â¶callPackage ../os-specific/linux/kernel/mainline.nix {
      branch = "6.6";
      kernelPatches = [
        kernelPatches.bridge_stp_helper
        kernelPatches.request_key_helper
      ];
    };
* pkgs/os-specific/linux/kernel/mainline.nix
  * buildLinux args'
  * â·buildLinux ((builtins.removeAttrs args [ "branch" ])
    // {
      inherit src version;

      modDirVersion = lib.versions.pad 3 version;
      extraMeta.branch = branch;
    }
    // (args.argsOverride or { }))
  * (callPackage pkgs/os-specific/linux/kernel/generic.nix {}) args'
  * overridableKernel args'
  * (lib.makeOverridable ({...}: kernel.overrideAttrs (...))) args'
  * kernel.overrideAttrs (...)
  * â¸((callPackage ./manual-config.nix { inherit lib stdenv buildPackages; }) (basicArgs // { ... })).overrideAttrs (...)
</code></pre>
<p>å› æ­¤</p>
<ul>
<li>â¶ <code>override</code> is applied to <code>pkgs/os-specific/linux/kernel/mainline.nix</code></li>
<li>â· <code>argsOverride</code> in <code>override (old: {argsOverride = {...} })</code> is applied to <code>pkgs/os-specific/linux/kernel/generic.nix</code></li>
<li>â¸ <code>overrideAttrs</code> is applied to <code>pkgs/os-specific/linux/kernel/manual-config.nix</code></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><div style="break-before: page; page-break-before: always;"></div><h1 id="nixè®©ä½ çš„å›¢é˜Ÿæˆå‘˜ä¸å†å—ç¯å¢ƒé—®é¢˜å›°æ‰°"><a class="header" href="#nixè®©ä½ çš„å›¢é˜Ÿæˆå‘˜ä¸å†å—ç¯å¢ƒé—®é¢˜å›°æ‰°">Nixè®©ä½ çš„å›¢é˜Ÿæˆå‘˜ä¸å†å—ç¯å¢ƒé—®é¢˜å›°æ‰°</a></h1>
<p>æ³¨ï¼šå·¦ä¸‹è§’èœå•é‡Œå¯åˆ‡æ¢å…¨å±</p>
<iframe src="./2023.nix-env.slides.html" style="width: 100%;aspect-ratio:12/7;" frameBorder="0"></iframe>
<div style="break-before: page; page-break-before: always;"></div><p>See all fhs-shell scripts on [Github repo: scripts/fhs-shell]({{ site.repo_url }}/scripts/fhs-shell)</p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
{ pkgs ? import &lt;nixpkgs&gt; {} }:
(pkgs.buildFHSUserEnv {
  name = "dynamoRIO";
  targetPkgs = pkgs: with pkgs; [
    (hiPrio gcc)
    snappy
    zlib
    zlib.dev
    lz4
    lz4.dev
    libunwind
    libunwind.dev
  ];
  profile = ''
    export CC=gcc
    export CXX=g++
  '';
}).env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
let
  pkgs = import &lt;nixpkgs&gt; {};
  fhs = pkgs.buildFHSUserEnv {
    name = "hello";
    targetPkgs = p: with p; [
      hello
    ];
    profile = ''
      export MIAO=1
    '';
  };
in
  fhs.env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
{ pkgs ? import &lt;nixpkgs&gt; {} }:
let
  pin = builtins.derivation {
    name = "pin-3.25";
    system = builtins.currentSystem;
    src = pkgs.fetchurl {
      url = "https://software.intel.com/sites/landingpage/pintool/downloads/pin-3.25-98650-g8f6168173-gcc-linux.tar.gz";
      hash = "sha256-Q8D0QSNLDly2XK+XFOYdMxbx5N33eGVzESGTCgWGX6E=";
    };
    builder = pkgs.writeShellScript "pin-builder" ''
      # make mkdir and tar and other useful tools added to PATH
      source ${pkgs.stdenv}/setup
      mkdir -p $out
      # strip leading directory
      tar -xf $src --strip-components=1 --directory=$out
    '';
  };
in
(pkgs.buildFHSUserEnv {
  name = "pin";
  targetPkgs = pkgs: with pkgs; [
  ];
  profile = ''
    PATH+=":${pin}"
  '';
}).env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
{ pkgs ? import &lt;nixpkgs&gt; {} }:
let
  zigenv = import /home/xieby1/Codes/nix-zig-stdenv {
    target = "x86_64-unknown-linux-musl";
  };
  noPrefixStaticStdenvCC = pkgs.runCommand "linkCC" {} ''
    mkdir -p $out/bin
    for file in ${pkgs.pkgsStatic.stdenv.cc}/bin/*; do
      ln -s $file $out/bin/''${file##*-}
    done
  '';
in
(pkgs.buildFHSUserEnv {
  name = "spec";
  targetPkgs = pkgs: with pkgs; [
    # (hiPrio zigenv.pkgs.stdenv.cc)
    # (hiPrio clangStdenv.cc)
    # (hiPrio gcc)
    # (hiPrio pkgsStatic.stdenv.cc)
    # noPrefixStaticStdenvCC
    gfortran
    # uclibc
    # musl
    # musl.dev
    glibc.static
    glibc.dev
  ];
}).env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
# https://ryantm.github.io/nixpkgs/builders/special/fhs-environments/

{ pkgs ? import &lt;nixpkgs&gt; {} }:

(pkgs.buildFHSUserEnv {
  name = "simple-x11-env";
  targetPkgs = pkgs: (with pkgs;
    [ udev
      alsa-lib
    ]) ++ (with pkgs.xorg;
    [ libX11
      libXcursor
      libXrandr
    ]);
  multiPkgs = pkgs: (with pkgs;
    [ udev
      alsa-lib
    ]);
  runScript = "bash";
}).env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
# based on https://github.com/nix-community/nix-environments
#   git commit: 40d9d98bab7750bb5a1a9a3b5bcc1c91a652f3be
{ pkgs ? import &lt;nixpkgs&gt; {} }:
let
  name = "xilinx-fhs";
  h_content = builtins.toFile "h_content" ''
    # ${pkgs.lib.toUpper "${name} usage"}

    **Commands**

    * Show this help: `h`
    * Start Vitis HLS IDE: `vitis_hls`
    * Start Vitis HLS REPL: `vitis_hls -i`

    **Files**

    * Vitis HLS Doc: `2022.vitis_hls.ug1399.pdf`
    * Local command doc: `Xilinx/Vitis/2022.2/doc/eng/man/`
    * TODO: `ug871-vivado-high-level-synthesis-tutorial.pdf`
    * TODO: `ug902-vivado-high-level-synthesis.pdf`

    **Examples**

    * [Vitis HLS examples](https://github.com/Xilinx/Vitis-HLS-Introductory-Examples)
    * Run an example: `vitis_hls -f run_hls.tcl`
  '';
  _h_ = pkgs.writeShellScriptBin "h" ''
    ${pkgs.glow}/bin/glow ${h_content}
  '';
in
(pkgs.buildFHSUserEnv {
  inherit name;
  targetPkgs = pkgs: with pkgs; [
    _h_

    bash
    coreutils
    zlib
    lsb-release
    stdenv.cc.cc
    ncurses5
    xorg.libXext
    xorg.libX11
    xorg.libXrender
    xorg.libXtst
    xorg.libXi
    xorg.libXft
    xorg.libxcb
    xorg.libxcb
    # common requirements
    freetype
    fontconfig
    glib
    gtk2
    gtk3
    # vitis_hls gcc needs
    glibc.dev

    # to compile some xilinx examples
    opencl-clhpp
    ocl-icd
    opencl-headers

    # from installLibs.sh
    graphviz
    (lib.hiPrio gcc)
    unzip
    nettools
  ];
  multiPkgs = null;
  profile = ''
    export LC_NUMERIC="en_US.UTF-8"
    source ~/Xilinx/Vitis_HLS/*/settings64.sh
    h
  '';
}).env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p>See all fhs-shell scripts on [Github repo: scripts/pkgs]({{ site.repo_url }}/scripts/pkgs)</p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># TODO: 7z need dynamical link 7z.so
#   but static compilation prevents this behavior?
{pkgs ? import &lt;nixpkgs&gt; {}}:
let cross = import /home/xieby1/Codes/nix-zig-stdenv {
  inherit pkgs;
  target = "x86_64-unknown-linux-musl";
};
in
cross.pkgs.p7zip.overrideAttrs (old: {
  postPatch = old.postPatch + ''
    sed -i '/CC=/d' makefile.machine
    sed -i '/CXX=/d' makefile.machine
  '';
})
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><div style="text-align:right; font-size:3em;">2022.04.19</div>
<h1 id="åœ¨nixosä¸Šä½¿ç”¨androidç¨‹åº"><a class="header" href="#åœ¨nixosä¸Šä½¿ç”¨androidç¨‹åº">åœ¨NixOSä¸Šä½¿ç”¨Androidç¨‹åº</a></h1>
<p>TLDR: ä½¿ç”¨Android Studioæä¾›çš„Android Emulatorä½“éªŒæœ€å¥½ï¼Œå…¶æ¬¡æ˜¯ä½¿ç”¨QEMU+x86Androidã€‚</p>
<!-- vim-markdown-toc GFM -->
<ul>
<li><a href="scripts/pkgs/android.html#anbox--waydroid">Anbox &amp; Waydroid</a></li>
<li><a href="scripts/pkgs/android.html#qemu--x86-android">qemu + x86 Android</a></li>
<li><a href="scripts/pkgs/android.html#google-android-emulator">Google Android Emulator</a>
<ul>
<li><a href="scripts/pkgs/android.html#%E8%8E%B7%E5%8F%96apk-package%E5%92%8Cactivity">è·å–apk packageå’Œactivity</a></li>
<li><a href="scripts/pkgs/android.html#avdmanager%E6%89%BE%E4%B8%8D%E5%88%B0%E9%95%9C%E5%83%8F">avdmanageræ‰¾ä¸åˆ°é•œåƒ</a></li>
<li><a href="scripts/pkgs/android.html#%E6%A8%A1%E6%8B%9F%E5%99%A8%E9%97%AA%E9%80%80">æ¨¡æ‹Ÿå™¨é—ªé€€</a></li>
<li><a href="scripts/pkgs/android.html#debug-%E6%96%B9%E6%B3%95">debug æ–¹æ³•</a></li>
<li><a href="scripts/pkgs/android.html#pci-bus-not-available-for-hda">PCI bus not available for hda</a></li>
</ul>
</li>
<li><a href="scripts/pkgs/android.html#google-android-studio">Google Android Studio</a></li>
<li><a href="scripts/pkgs/android.html#redroid">redroid</a></li>
</ul>
<!-- vim-markdown-toc -->
<h2 id="anbox--waydroid"><a class="header" href="#anbox--waydroid">Anbox &amp; Waydroid</a></h2>
<p>Anbox &amp; Waydroidå±äºå°†Android runtimeç§»æ¤åˆ°Linuxä¸Šçš„é¡¹ç›®ã€‚
éƒ½éœ€è¦å®‰è£…å†…æ ¸æ¨¡å—ã€‚</p>
<p>Anboxå·²æœªç»´æŠ¤ã€‚</p>
<p>Waydroidéœ€è¦Waylandæ”¯æŒã€‚ç›®å‰æˆ‘è¿˜é‡‡ç”¨X11ã€‚</p>
<h2 id="qemu--x86-android"><a class="header" href="#qemu--x86-android">qemu + x86 Android</a></h2>
<p>è™šæ‹Ÿæœºï¼Œæ²¡æœ‰æ‰¾åˆ°å›¾å½¢å’ŒéŸ³é¢‘çš„åŠ é€Ÿæ–¹æ³•ã€‚åŸºæœ¬å¯ç”¨çš„ç¨‹åº¦ã€‚</p>
<ul>
<li>vanilla x86 android: OK</li>
<li>lineageOS: OK
<ul>
<li>same to vanilla x86 android</li>
<li>wechat not work</li>
</ul>
</li>
<li>phoenixOS: stuck in booting</li>
</ul>
<pre><code class="language-bash"># å®‰è£…åœ¨è¿è¡Œå‘½ä»¤åæ·»åŠ -cdrom &lt;/path/to/iso&gt; -boot -d
# è¿è¡Œå‘½ä»¤
qemu-system-x86_64 -m 4G -smp 3 -hda ~/Img/andx64_vcm141r5.qcow2 -enable-kvm -display gtk,window-close=off -device AC97
</code></pre>
<p>æ³¨ï¼š-vga virtioä¸èƒ½å¯åŠ¨å›¾å½¢ç•Œé¢ï¼ŒåŸå› æœªæ¢ç´¢ã€‚</p>
<h2 id="google-android-emulator"><a class="header" href="#google-android-emulator">Google Android Emulator</a></h2>
<p>ä½¿ç”¨nixæä¾›çš„emulate-app.nixç›´æ¥è¿è¡ŒGoogle Android Emulator (é­”æ”¹çš„QEMU)ã€‚</p>
<p>æ¨¡æ‹Ÿå™¨é—ªé€€æ— æ³•å¯åŠ¨ï¼Œæš‚æ—¶æ²¡æœ‰å°è¯•å»è§£å†³ã€‚</p>
<p>å‚è€ƒ</p>
<ul>
<li>https://nixos.wiki/wiki/Android
<ul>
<li><a href="https://sandervanderburg.blogspot.com/2014/02/reproducing-android-app-deployments-or.html">2014: Reproducing Android app deployments (or playing Angry Birds on NixOS)</a></li>
</ul>
</li>
<li><a href="https://stackoverflow.com/questions/24627978/run-android-app-in-qemu-arm">SO: Run Android app in qemu-arm?</a>
<ul>
<li><a href="https://www.linaro.org/blog/running-64bit-android-l-qemu/index.html">2014: Running Android L Developer Preview on 64-bit Arm QEMU</a></li>
</ul>
</li>
</ul>
<p>ä½¿ç”¨çš„nixè„šæœ¬è§android.nix</p>
<h3 id="è·å–apk-packageå’Œactivity"><a class="header" href="#è·å–apk-packageå’Œactivity">è·å–apk packageå’Œactivity</a></h3>
<p>aaptå·²ç»æ·˜æ±°ï¼Œç°åœ¨ä½¿ç”¨çš„æ˜¯<a href="https://developer.android.com/studio/command-line/aapt2#download_aapt2">aapt2</a>ï¼Œrun by <a href="https://github.com/thiagokokada/nix-alien">nix-alien</a>ã€‚
ä¾‹å­ï¼Œ</p>
<pre><code class="language-bash">nix-alien aapt2 dump badging &lt;/path/to/apk&gt;
</code></pre>
<h3 id="avdmanageræ‰¾ä¸åˆ°é•œåƒ"><a class="header" href="#avdmanageræ‰¾ä¸åˆ°é•œåƒ">avdmanageræ‰¾ä¸åˆ°é•œåƒ</a></h3>
<p>Error: Package path is not valid. Valid system image paths are:ository...</p>
<p>ç›¸å…³é—®é¢˜</p>
<ul>
<li><a href="https://github.com/NixOS/nixpkgs/issues/154898">GH: avdmanager create avd fails with "Probably the SDK is read-only" #154898</a>
<ul>
<li><a href="https://github.com/NixOS/nixpkgs/issues/121146">GH: androidenv.emulateApp fails to start emulator (libvulkan.so.1: full) #121146</a></li>
</ul>
</li>
<li><a href="https://stackoverflow.com/questions/66597053">SO: error: package path is not valid. valid system image paths are:ository... null</a></li>
</ul>
<p>ä»pkgs/development/mobile/androidenv/compose-android-packages.nixçœ‹ï¼Œ
platformVersions, systemImageTypes, abiVersionséœ€è¦å’Œ
pkgs/development/mobile/androidenv/repo.json
ä¸­çš„emulatoré¡¹ä¸­çš„æ•°æ®åŒ¹é…ã€‚</p>
<p>çœ‹repo.jsonï¼Œè€Œä¸æ˜¯çœ‹<code>sdkmanager --list</code>ï¼Œä¸ä¸€å®šæœ‰ï¼Œä½†èƒ½çœ‹åˆ°å·²å®‰è£…ã€‚</p>
<p>ä¸åŒ¹é…ï¼Œåœ¨nix-buildä¸­ä¸ä¼šæŠ¥é”™ï¼Œè¿è¡Œè¿‡ç¨‹æŠ¥ä¸Šé¢çš„é”™è¯¯ã€‚</p>
<h3 id="æ¨¡æ‹Ÿå™¨é—ªé€€"><a class="header" href="#æ¨¡æ‹Ÿå™¨é—ªé€€">æ¨¡æ‹Ÿå™¨é—ªé€€</a></h3>
<p>å’Œé—®é¢˜ç±»ä¼¼<a href="https://github.com/NixOS/nixpkgs/issues/121146">GH: androidenv.emulateApp fails to start emulator (libvulkan.so.1: full) #121146</a></p>
<p>æŠ¥é”™å†…å®¹ï¼Œæ²¡è§£å†³</p>
<pre><code class="language-bash">cannot add library /nix/store/yz1p6cw09h3im4z7wmx7nshi054fzhw4-emulator-30.8.4/libexec/android-sdk/emulator/qemu/linux-x86_64/lib64/vulkan/libvulkan.so: failed
added library /nix/store/yz1p6cw09h3im4z7wmx7nshi054fzhw4-emulator-30.8.4/libexec/android-sdk/emulator/lib64/vulkan/libvulkan.so
emulator: WARNING: Ignoring invalid http proxy: Bad format: invalid port number (must be decimal)
Device state has been reached
LLVM ERROR: Cannot select: intrinsic %llvm.x86.sse41.pblendvb
</code></pre>
<h3 id="debug-æ–¹æ³•"><a class="header" href="#debug-æ–¹æ³•">debug æ–¹æ³•</a></h3>
<p>å‚è€ƒhttps://nixos.wiki/wiki/Nixpkgs/Create_and_debug_packages#How_to_install_from_the_local_repository</p>
<p>ä½¿ç”¨æœ¬åœ°nixpkgsï¼Œä¿®æ”¹ï¼Œnix-shellçœ‹å˜é‡
ä¾‹å­ï¼š</p>
<pre><code class="language-bash">nix-shell -E 'with import "/home/xieby1/temp-nixpkgs" {config.android_sdk.accept_license = true;}; (androidenv.composeAndroidPackages {includeSystemImages =true; platformVersions=["16"];}).androidsdk'
</code></pre>
<p>nix expressionè°ƒç”¨å…³ç³»</p>
<ul>
<li>emulate-app.nix
<ul>
<li>compose-android-packages.nix
<ul>
<li>tools.nix
<ul>
<li>tools/26.nix
<ul>
<li>deploy-androidpackage.nix</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="pci-bus-not-available-for-hda"><a class="header" href="#pci-bus-not-available-for-hda">PCI bus not available for hda</a></h3>
<p>https://stackoverflow.com/questions/69297141/android-11-emulator-gives-pci-bus-not-available-for-hda</p>
<p>ä¿®æ”¹./result/bin/run-test-emulatoræ·»åŠ -qemu -machine virtåˆ°Launch the emulatorçš„æŒ‡ä»¤å</p>
<pre><code class="language-bash">/nix/store/0q68cfq7rnbw752l89fkxf425v1pb2r6-androidsdk/libexec/android-sdk/emulator/emulator -avd device -no-boot-anim -port $port $NIX_ANDROID_EMULATORFLAGS -qemu -machine virt &amp;
</code></pre>
<h2 id="google-android-studio"><a class="header" href="#google-android-studio">Google Android Studio</a></h2>
<p>ä½¿ç”¨Android Studioçš„AVDå®‰è£…Android emulatoræœ€çœå¿ƒã€‚</p>
<p>å¯ä»¥ä½¿ç”¨å¾®ä¿¡ï¼ˆå…¬ä¼—å·é—ªé€€ï¼‰ï¼Œè¯­éŸ³è§†é¢‘æµç•…ï¼Œå°æ¸¸æˆæµç•…ã€‚</p>
<h2 id="redroid"><a class="header" href="#redroid">redroid</a></h2>
<p>æš‚æ—¶æ²¡æˆåŠŸ</p>
<p>æ–‡æ¡£å¹¶æœªæä¾›å’Œå„ä¸ªå‚æ•°ç›¸å…³çš„æºæ–‡ä»¶ï¼Ÿ</p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build

# https://nixos.wiki/wiki/Android
#  Building Android applications with the Nix package manager: https://sandervanderburg.blogspot.com/2014/02/reproducing-android-app-deployments-or.html
let
  # current nixpkgs-unstable
  pkgs = import (with import &lt;nixpkgs&gt; {}; fetchFromGitHub {
    owner = "NixOS";
    repo = "nixpkgs";
    rev = "1c851e8c92b76a00ce84167984a7ec7ba2b1f29c";
    hash = "sha256-vRxti8pOuXS0rJmqjbD8ueEEFXWSK22ISHoCWkhgzzg=";
  }){
    config.android_sdk.accept_license = true;
    config.allowUnfree = true;
  };
in pkgs.androidenv.emulateApp {
  name = "androidEmuApp";
  app = pkgs.fetchurl {
    url = "https://github.com/SimpleMobileTools/Simple-Calendar/releases/download/6.13.5/calendar-release.apk";
    sha256 = "12vzcd6klnk38b55szmd5a8ydc70fk6aak31qvlild83jy9z21zk";
  };
  enableGPU = false;
  # get these info by `pkgs/development/mobile/androidenv/repo.json`
  # see if installed `sdkmanager --list`
  platformVersion = "32";
  abiVersion = "x86";
  systemImageType = "google_apis";

  package = "com.simplemobiletools.calendar.pro";

  avdHomeDir = "$HOME/.android";
  sdkExtraArgs = {
    includeSystemImages = true;
  };
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  pkgs = import &lt;nixpkgs&gt; {};
  squashfuse-with-headers = pkgs.pkgsStatic.squashfuse.overrideAttrs (old: {
    src = pkgs.fetchurl {
      url = "https://github.com/vasi/squashfuse/archive/e51978c.tar.gz";
      hash = "sha256-9UQCmtMNj73k5FQMV0uM3G04uU3wJamNhVGpRB8H00E=";
    };
    postInstall = ''
      mkdir -p $out/include/squashfuse
      cp *.h $out/include/squashfuse
    '';
  });
  srcRev = "c1ea7509bc179a05d907baca64f41875662f35f2";
in pkgs.stdenv.mkDerivation {
  name = "appimage-runtime";
  src = pkgs.fetchFromGitHub {
    owner = "AppImage";
    repo = "type2-runtime";
    rev = "${srcRev}";
    sha256 = "1gr853iz1x6pgyav3w1kqaaaz2ybbx67dcg74kj54yrwlakrh165";
  };
  nativeBuildInputs = with pkgs; [
    pkg-config
  ];
  buildInputs = (with pkgs.pkgsStatic; [
    squashfuse-with-headers
    fuse
    zstd
    zlib

    lz4.out
    lzo
    lzma.out
  ]) ++ (with pkgs; [
    glibc.static
  ]);
  sourceRoot = "source/src/runtime";
  buildPhase = ''
    export CFLAGS="-std=gnu99 -s -Os -D_FILE_OFFSET_BITS=64 -DGIT_COMMIT=\"${srcRev}\" -T data_sections.ld -ffunction-sections -fdata-sections -Wl,--gc-sections -static"
    export LIBS="-lsquashfuse -lsquashfuse_ll -lzstd -lz -llz4 -llzo2 -llzma"
    $CC -I${squashfuse-with-headers}/include/squashfuse -I${pkgs.pkgsStatic.fuse}/include/fuse -o runtime-fuse2.o -c $CFLAGS runtime.c
    $CC $CFLAGS runtime-fuse2.o $LIBS -lfuse -o runtime-fuse2
  '';
  installPhase = ''
    mkdir -p $out/bin
    cp runtime-fuse2 $out/bin/
  '';
}

# in pkgs.mkShell {
#   name = "appimage-runtime";
#   packages = (with pkgs.pkgsStatic; [
#     squashfuse-with-headers
#     fuse
#     zstd
#     zlib

#     lz4.out
#     lzo
#     lzma.out
#   ]) ++ (with pkgs; [
#     glibc.static
#     pkg-config
#   ]);
# }

# in (pkgs.buildFHSUserEnv {
#   name = "appimage-runtime-fhs";
#   targetPkgs = pkgs: (with pkgs.pkgsStatic; [
#     squashfuse-with-headers
#     fuse
#     zstd
#     zlib

#     lz4.out
#     lzo
#     lzma.out
#   ]) ++ (with pkgs; [
#     glibc.static
#     pkg-config
#   ]);
# }).env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-build -o coremarks
{pkgs ? import &lt;nixpkgs&gt; {}}:
let
  # function mkCoremark
  mkCoremark = {
    pkgs ? import &lt;nixpkgs&gt; {},
    stdenv ? pkgs.stdenv,
    simple ? false,
  }:
  let
    name = "coremark";
    variant = pkgs.lib.concatStrings [
      "${stdenv.targetPlatform.config}"
      # TODO: all zig-env are static?
      # (if stdenv.targetPlatform.isStatic then ".static" else "")
      (if simple then ".simple" else "")
    ];
  in
  stdenv.mkDerivation {
    inherit name;
    src = pkgs.fetchFromGitHub {
      owner = "eembc";
      repo = "coremark";
      rev = "d26d6fdcefa1f9107ddde70024b73325bfe50ed2";
      sha256 = "0kd6bnrnd3f325ypxzn0w5ii4fmc98h16sbvvjikvzhm78y60wz3";
    };
    preBuild = ''
      # no float point insts
      export CFLAGS="-DHAS_FLOAT=0"

      # simple assumes CC = gcc, this is a bug!
      sed -i '/CC =/d' simple/core_portme.mak
      ${if simple
        then "export PORT_DIR=simple"
        else ""}
    '';
    buildFlags = ["compile"];
    installPhase = ''
      mkdir -p $out/bin
      mv coremark.exe $out/bin/${name}.${variant}.exe
    '';
  };
  zig-env-src = pkgs.fetchFromGitHub {
    owner = "Cloudef";
    repo = "nix-zig-stdenv";
    rev = "6de72ec32ecf0cfb9ad9dab5a8400d532e17f8c5";
    hash = "sha256-hQHOzjkHWO5YxQb3mgZJOfyIuvbiLFocVCMK/A9HTic=";
  };
in
pkgs.symlinkJoin {
  name = "coremarks";
  paths = [
    # x86_64 linux
    (mkCoremark {
      inherit (import zig-env-src {
        target = "x86_64-unknown-linux-gnu";
      }) stdenv;
    })
    # x86_64 linux static
    (mkCoremark {
      inherit (import zig-env-src {
        target = "x86_64-unknown-linux-musl";
      }) stdenv;
    })
    # aarch64 linux
    (mkCoremark {
      inherit (import zig-env-src {
        target = "aarch64-unknown-linux-gnu";
      }) stdenv;
    })
    # aarch64 linux static
    (mkCoremark {
      inherit (import zig-env-src {
        target = "aarch64-unknown-linux-musl";
      }) stdenv;
    })
    # riscv64 linux
    # (mkCoremark {
    #   inherit (import zig-env-src {
    #     target = "riscv64-unknown-linux-gnu";
    #   }) stdenv;
    # })
    # riscv64 linux static
    (mkCoremark {
      inherit (import zig-env-src {
        target = "riscv64-unknown-linux-musl";
      }) stdenv;
    })
    # x86_64 windows
    (mkCoremark {
      inherit (import zig-env-src {
        target = "x86_64-w64-mingw32";
      }) stdenv;
      simple = true;
    })
    # x86_64 darwin can only compiled on x86_64/aarch64 darwin
    #   https://github.com/NixOS/nixpkgs/issues/165804
    # while it is possible compile manually inside darling
    #(mkCoremark {
    #  stdenv = pkgs.pkgsCross.x86_64-darwin.stdenv;
    #})
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-env -i -f
# xieby1: 2022.05.16
with (import &lt;nixpkgs&gt; {crossSystem = "mips-linux";}); {
  gdb = lib.lowPrio buildPackages.gdb;
  gcc = lib.lowPrio buildPackages.gcc;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build
let
  pkgs = import (builtins.fetchTarball {
    url = "https://github.com/NixOS/nixpkgs/archive/e60c3e2abb8ae9df3d89820c706cc736fad01ff7.tar.gz";
    sha256 = "0vyjpf1jw4cvw7kfbk055faq08q4swz6v1h2mf9zw4r8frhqa73w";
  }) {};
in
pkgs.pkgsCross.aarch64-multiplatform.pkgsStatic.glib
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-build -o fhs_helloworld

# xieby1: 2022.11.17
# inspired by
#   https://discourse.nixos.org/t/derivation-that-builds-standard-linux-binaries/21557/4
#   https://github.com/NixOS/nixpkgs/compare/master...ElvishJerricco:nixpkgs:run-in-fhs
# TODO-1:
#   I have copy all dependencies to a directory (ld-linux-x86-64.so.2, libc.so)
#   But result cannot run in chroot, error message is `cannot find libc.so`.
# TODO-2:
#   I didn't find a proper package/bundle tool
#   * nix-bundle: not work
#   * appimage: depends on libfuse.so, cannot run directly on nixos

{ pkgs ? import &lt;nixpkgs&gt; {} }:
let
  name = "helloworld";
  fhsEnv = pkgs.buildFHSUserEnv {
    name = "${name}-fhs";
    targetPkgs = pkgs: with pkgs; [
      gcc
      # gcc-unwrapped binutils-unwrapped
      glibc
      glibc.dev
    ];
    # refer to https://discourse.nixos.org/t/using-a-raw-gcc-inside-buildfhsuserenv/12864
    runScript = (pkgs.writeShellScript "${name}-fhsbuilder" ''
      # For gcc-unwrapped and binutils-unwrapped
      # export LIBRARY_PATH=/usr/lib
      # export C_INCLUDE_PATH=/usr/include
      # export CPLUS_INCLUDE_PATH=/usr/include
      # export CMAKE_LIBRARY_PATH=/usr/lib
      # export CMAKE_INCLUDE_PATH=/usr/include
      ## TODO: not work? have to add gcc -Wl,--dynamic-linker=/usr/lib64/ld-linux-x86-64.so.2 ?
      # export LDFLAGS=--dynamic-linker=/usr/lib64/ld-linux-x86-64.so.2

      # For gcc
      export NIX_LDFLAGS="--dynamic-linker=/usr/lib64/ld-linux-x86-64.so.2"
      gcc $src -o $out
    '');
  };
in
builtins.derivation {
  inherit name;
  system = builtins.currentSystem;
  src = builtins.toFile "${name}.c" ''
    #include &lt;stdio.h&gt;
    int main(void) {
      printf("Hello, world! \n");
      return 0;
    }
  '';
  builder = "${fhsEnv}/bin/${fhsEnv.name}";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  name = "perl";
  pkgs = import &lt;nixpkgs&gt; {};
  fhsEnv = pkgs.buildFHSUserEnv {
    name = "${name}-fhs";
    targetPkgs = pkgs: with pkgs; [
      gnumake
    ];
    runScript = (pkgs.writeShellScript "${name}-fhsbuilder" ''
      ls
      cd $src/tools/src
      ls
      DOPERL=1 ./buildtools
    '');
  };
in builtins.derivation {
  inherit name;
  system = builtins.currentSystem;
  src = /home/xieby1/Codes/spec2000;
  builder = "${fhsEnv}/bin/${fhsEnv.name}";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
 pkgs = import &lt;nixpkgs&gt; {};
in
pkgs.stdenv.mkDerivation {
  name = "herdtool7";
  src = pkgs.fetchFromGitHub {
    owner = "herd";
    repo = "herdtools7";
    rev = "7c36d32e7e0dd546296ddd05c5279ae42665a4cf";
    hash = "sha256-gGxM2JYZwbtveQu3PRMKvr4XePJA0jtQK9WUEpCTn8c=";
  };
  buildInputs = [
    pkgs.which
    pkgs.ocamlPackages.ocaml
    pkgs.ocamlPackages.findlib
    pkgs.ocamlPackages.dune_3
    pkgs.ocamlPackages.menhir
    pkgs.ocamlPackages.menhirLib
    pkgs.ocamlPackages.zarith
  ];
  makeFlags = [
    "PREFIX=$(out)"
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-build -o nix-binary-tarballs
</code></pre>
<h1 id="nix-official-installer-new"><a class="header" href="#nix-official-installer-new">Nix official installer (new)</a></h1>
<p>Use nix (&gt;2.18) binary-tarball script, which has not been merged into mainline nixpkgs.</p>
<p>See <a href="scripts/pkgs/./nix-binary-tarballs.nix.html">nix-binary-tarballs.nix</a> for current nix binary-tarball script.</p>
<pre><code class="language-nix">let
  pkgs = import &lt;nixpkgs&gt; {};
  nix_src = pkgs.fetchFromGitHub {
    owner = "NixOS";
    repo = "nix";
    rev = "d0c7da131fb64526bc72144949b6955c25367d92";
    hash = "sha256-Z4RlluZjNXH5BdJiXoe0k43Ry9ptK3jHAsKjlQ3jVZg=";
  };
in pkgs.symlinkJoin {
  name = "nix-binary-tarballs";
  paths = [
    (pkgs.callPackage "${nix_src}/scripts/binary-tarball.nix" {})
    (pkgs.callPackage "${nix_src}/scripts/binary-tarball.nix" {
      nix    = pkgs.pkgsCross.riscv64.nix;
      system = pkgs.pkgsCross.riscv64.nix.stdenv.system;
    })
    (pkgs.callPackage "${nix_src}/scripts/binary-tarball.nix" {
      nix    = pkgs.pkgsCross.loongarch64-linux.nix;
      system = pkgs.pkgsCross.loongarch64-linux.nix.stdenv.system;
    })
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-build -o nix-binary-tarballs
</code></pre>
<h1 id="nix-official-installer"><a class="header" href="#nix-official-installer">Nix official installer</a></h1>
<p>The <code>binaryTarball</code> function is extracted from <a href="https://github.com/NixOS/nix/blob/2.18.2/flake.nix">nix-2.18's flake.nix</a></p>
<p><strong>Noted</strong>:
Although the latest nix has seperate binaryTarball as a independent file,
current unstable nixpkgs still use nix-2.18,
which embed binaryTarball function in nix/flake.nix.
If reuse the binaryTarball file in new nix, then this script can be hugely simplified,
e.g. <a href="scripts/pkgs/./nix-binary-tarballs-new.nix.html">nix-binary-tarballs-new.nix</a>.
As long as, new nix is merged to mainline nixpkgs,
I will deprecate this script and adopt the new script.</p>
<pre><code class="language-nix">let
  pkgs = import &lt;nixpkgs&gt; {};
  binaryTarball =
    { nix
    , buildPackages
    , cacert
    }:
    let
      installerClosureInfo = buildPackages.closureInfo { rootPaths = [ nix cacert ]; };
    in buildPackages.runCommand "nix-binary-tarball-${nix.version}" {
      #nativeBuildInputs = lib.optional (system != "aarch64-linux") shellcheck;
      meta.description = "Distribution-independent Nix bootstrap binaries for ${nix.stdenv.system}";
    } ''
      cp ${installerClosureInfo}/registration $TMPDIR/reginfo
      cp ${nix.src}/scripts/create-darwin-volume.sh $TMPDIR/create-darwin-volume.sh
      substitute ${nix.src}/scripts/install-nix-from-closure.sh $TMPDIR/install \
        --subst-var-by nix ${nix} \
        --subst-var-by cacert ${cacert}
    
      substitute ${nix.src}/scripts/install-darwin-multi-user.sh $TMPDIR/install-darwin-multi-user.sh \
        --subst-var-by nix ${nix} \
        --subst-var-by cacert ${cacert}
      substitute ${nix.src}/scripts/install-systemd-multi-user.sh $TMPDIR/install-systemd-multi-user.sh \
        --subst-var-by nix ${nix} \
        --subst-var-by cacert ${cacert}
      substitute ${nix.src}/scripts/install-multi-user.sh $TMPDIR/install-multi-user \
        --subst-var-by nix ${nix} \
        --subst-var-by cacert ${cacert}
    
      if type -p shellcheck; then
        # SC1090: Don't worry about not being able to find
        #         $nix/etc/profile.d/nix.sh
        shellcheck --exclude SC1090 $TMPDIR/install
        shellcheck $TMPDIR/create-darwin-volume.sh
        shellcheck $TMPDIR/install-darwin-multi-user.sh
        shellcheck $TMPDIR/install-systemd-multi-user.sh
    
        # SC1091: Don't panic about not being able to source
        #         /etc/profile
        # SC2002: Ignore "useless cat" "error", when loading
        #         .reginfo, as the cat is a much cleaner
        #         implementation, even though it is "useless"
        # SC2116: Allow ROOT_HOME=$(echo ~root) for resolving
        #         root's home directory
        shellcheck --external-sources \
          --exclude SC1091,SC2002,SC2116 $TMPDIR/install-multi-user
      fi
    
      chmod +x $TMPDIR/install
      chmod +x $TMPDIR/create-darwin-volume.sh
      chmod +x $TMPDIR/install-darwin-multi-user.sh
      chmod +x $TMPDIR/install-systemd-multi-user.sh
      chmod +x $TMPDIR/install-multi-user
      dir=nix-${nix.version}-${nix.stdenv.system}
      fn=$out/$dir.tar.xz
      mkdir -p $out/nix-support
      echo "file binary-dist $fn" &gt;&gt; $out/nix-support/hydra-build-products
      tar cvfJ $fn \
        --owner=0 --group=0 --mode=u+rw,uga+r \
        --mtime='1970-01-01' \
        --absolute-names \
        --hard-dereference \
        --transform "s,$TMPDIR/install,$dir/install," \
        --transform "s,$TMPDIR/create-darwin-volume.sh,$dir/create-darwin-volume.sh," \
        --transform "s,$TMPDIR/reginfo,$dir/.reginfo," \
        --transform "s,$NIX_STORE,$dir/store,S" \
        $TMPDIR/install \
        $TMPDIR/create-darwin-volume.sh \
        $TMPDIR/install-darwin-multi-user.sh \
        $TMPDIR/install-systemd-multi-user.sh \
        $TMPDIR/install-multi-user \
        $TMPDIR/reginfo \
        $(cat ${installerClosureInfo}/store-paths)
    '';
in pkgs.symlinkJoin {
  name = "nix-binary-tarballs";
  paths = [
    # local nix installer
    (pkgs.callPackage binaryTarball {})
    # riscv64 nix installer
    (pkgs.callPackage binaryTarball {nix=pkgs.pkgsCross.riscv64.nix;})
    # loongarch64 nix installer
    (pkgs.callPackage binaryTarball {nix=pkgs.pkgsCross.loongarch64-linux.nix;})
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nix-docker-for-multiple-isas"><a class="header" href="#nix-docker-for-multiple-isas">ğŸ³Nix DockerğŸ‹ for Multiple ISAs</a></h1>
<p>This script is inspired by https://github.com/nix-community/docker-nixpkgs/images/nix</p>
<p>currently: this riscv64 nix docker can <code>nix-env -iA nixpkgs.hello/tmux</code> and so on,
which is completely built from source including toolchains (stdenv) in x86/aarch64/riscv64/...</p>
<pre><code class="language-nix">{ pkgs ? import &lt;nixpkgs&gt; {}
, pkgsCross ? pkgs
, useTmux ? true
}:
let
  name = "nix-docker-${pkgsCross.stdenv.system}";
  image = pkgs.dockerTools.buildImageWithNixDb {
    inherit name;
    copyToRoot = pkgs.buildEnv {
      name = "image-root";
      paths = (with pkgsCross; [
        bashInteractive
        cacert
        coreutils
        file
        gitMinimal
        gnutar
        nix
        openssh
        vim
        wget
      ]
      ++ lib.optional useTmux (tmux.override {withSystemd=false;})
      ) ++ [
        ./imageFiles
      ];
    };
    extraCommands = ''
      # for /usr/bin/env
      mkdir usr
      ln -s bin usr/bin

      # make sure /tmp exists
      mkdir -m 1777 tmp

      # need a HOME
      mkdir -vp root
    '';
    config = {
      Cmd = if useTmux
        then [ "/bin/tmux" ]
        else [ "/bin/bash" ];
      Env = [
        "NIX_BUILD_SHELL=/bin/bash"
        "PAGER=cat"
        "PATH=/bin"
        "SSL_CERT_FILE=${pkgs.cacert}/etc/ssl/certs/ca-bundle.crt"
        "USER=root"
      ];
    };
  };
in pkgs.writeShellScriptBin name ''
  command -v podman &amp;&gt; /dev/null || echo "podman not found TODO: install" || exit 1

  outName="$(basename ${image})"
  outHash=$(echo "$outName" | cut -d - -f 1)
  imageName=localhost/${name}:$outHash

  # check whether image has been loaded
  podman images $imageName | grep ${name} | grep $outHash &amp;&gt; /dev/null
  # image has not been loaded, then load it
  if [[ $? != 0 ]]; then
    podman load -i ${image}
  fi

  BINFMTS=""
  for binfmt in /run/binfmt/*; do
      BINFMTS+=" -v $(realpath $binfmt):$binfmt"
  done

  containerName=${name}-$outHash
  # run container
  OPTS=(
    "--name=$containerName"
    "$BINFMTS"
    "--network=host"
    "-it"
    "$imageName"
  )
  eval "podman run ''${OPTS[@]}"
  podman commit $containerName $imageName
  podman rm $containerName
''
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build
</code></pre>
<h1 id="instantiatio-of-nix-dockers"><a class="header" href="#instantiatio-of-nix-dockers">Instantiatio of nix dockers</a></h1>
<p>For more details, see <a href="scripts/pkgs/nix-docker-isa/./default.nix.html">default.nix</a></p>
<pre><code class="language-nix">{ pkgs ? import &lt;nixpkgs&gt; {}
, ...
}: [
</code></pre>
<h2 id="x86_64-docker"><a class="header" href="#x86_64-docker">x86_64 docker</a></h2>
<pre><code class="language-nix">  (import ./. {inherit pkgs; pkgsCross=pkgs.pkgsCross.gnu64;})
</code></pre>
<h2 id="aarhc64-docker"><a class="header" href="#aarhc64-docker">aarhc64 docker</a></h2>
<pre><code class="language-nix">  (import ./. {inherit pkgs; pkgsCross=pkgs.pkgsCross.aarch64-multiplatform;})
</code></pre>
<h2 id="riscv64-docker"><a class="header" href="#riscv64-docker">riscv64 docker</a></h2>
<pre><code class="language-nix">  (import ./. {inherit pkgs; pkgsCross=pkgs.pkgsCross.riscv64;})
]
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  flake-compat = import (builtins.fetchTarball {
    url = "https://github.com/edolstra/flake-compat/archive/0f9255e01c2351cc7d116c072cb317785dd33b33.tar.gz";
    sha256 = "0m9grvfsbwmvgwaxvdzv6cmyvjnlww004gfxjvcl806ndqaxzy4j";
  });
  nix2nvchad = flake-compat {
    src=  builtins.fetchTarball {
      url = "https://github.com/nix-community/nix4nvchad/archive/360ff667893eab066b3db906a856de2956fc710e.tar.gz";
      sha256 = "01gvcg7nhzpizp4yzvww2x42i1ifsb7sygfwmqzrshqz47p1ir5y";
    };
  };
in nix2nvchad.defaultNix.packages."${builtins.currentSystem}".default
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build
# xieby1: 2022.05.24
# build static qemu (current version 6.1.1) into ./result/
# $ nix-build &lt;this-file&gt; -A qemu
# build static qemu-3.1.0 into ./result/
# $ nix-build &lt;this-file&gt; -A qemu31
# build and install static qemu
# $ nix-env -i -f &lt;this-file&gt; -A qemu
# build and install static qemu-3.1.0
# $ nix-env -i -f &lt;this-file&gt; -A qemu31
let
  # https://lazamar.co.uk/nix-versions
  pinnedPkgsForQemu31Src = builtins.fetchTarball {
    name = "nixos-20.03-with-qemu-3.1.0";
    url = "https://github.com/NixOS/nixpkgs/archive/81d4e65891f92e8e72c244da663c83c1e40dc919.tar.gz";
    sha256 = "0dk1k1zqy2bnp9gsy9mdxk0idkazyvnmqrj2jpbwzfnhjzpmzq1w";
  };
  pinnedPkgsSrc = builtins.fetchTarball {
    name = "nixos-static-qemu";
    url = "https://github.com/nixos/nixpkgs/archive/e7d63bd0d50df412f5a1d8acfa3caae75522e347.tar.gz";
    sha256 = "132pc4f9ixisyv4117p2jirmlyl6sd76bfaz33rhlcwakg7bhjm7";
  };
  pkgsForQemu31 = import pinnedPkgsForQemu31Src {};
  pkgs = import pinnedPkgsSrc {};
  mypkgs = import pinnedPkgsSrc {
    overlays = [(self: super: {

      cdparanoiaIII = super.pkgsStatic.cdparanoiaIII.overrideAttrs (old: {
        preConfigure = old.preConfigure + ''
          cp ${super.gnu-config}/config.sub configure.sub
          cp ${super.gnu-config}/config.guess configure.guess
        '';
        # Makefile needs this to compile static
        STATIC="TRUE";
        buildPhase = ''
          make lib
          make cdparanoia
        '';
        preInstallPhases = ["preInstallPhase"];
        preInstallPhase = ''
          sed -i '/so/d' Makefile
        '';
      });

      liburing = super.pkgsStatic.liburing.overrideDerivation (old: {
        configureFlags = "";
        ENABLE_SHARED = 0;
      });

      # p11-kit cannot be used as a static library
      # https://github.com/p11-glue/p11-kit/issues/355
      p11-kit = super.pkgsMusl.p11-kit;
      # gnutls depends on p11-kit
      gnutls = super.pkgsMusl.gnutls;

      pam = super.pkgsStatic.openpam;

      # support both static and shared
      libselinux = (super.pkgsMusl.libselinux.override {
        libsepol = super.pkgsStatic.libsepol;
      }).overrideAttrs (old: {
         makeFlags = old.makeFlags ++ [
           "LIBDIR=$(out)/lib"
         ];
      });

      glib = (super.pkgsStatic.glib.override {
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        pkg-config = pkgs.pkg-config;
        perl = pkgs.perl;
        python3 = pkgs.python3;
        gettext = pkgs.gettext;
        gtk-doc = pkgs.gtk-doc;
        docbook_xsl = pkgs.docbook_xsl;
        docbook_xml_dtd_45 = pkgs.docbook_xml_dtd_45;
        libxml2 = pkgs.libxml2;
      }).overrideAttrs (old: {
        outputs = super.lib.lists.remove "devdoc" old.outputs;
        buildInputs = old.buildInputs ++ [
          super.pkgsStatic.libsepol
        ];
        preBuild = ''
          sed -i "s/get_option('libmount')/get_option('libmount'), static: true/g" ../meson.build
          sed -i "s/get_option('selinux')/get_option('selinux'), static: true/g" ../meson.build
        '';
        # no devdoc from non-static glibc
        # ${pname} &amp; ${version} is correct due to lazy assignment
        postInstall = pkgs.glib.postInstall;
      });

      gtk3 = super.pkgsStatic.gtk3.override {
        trackerSupport = false;
        cupsSupport = false;
        withGtkDoc = false;

        # nativeBuildInputs
        inherit (pkgs) gettext gobject-introspection makeWrapper meson ninja
        pkg-config python3 sassc docbook_xml_dtd_43 docbook-xsl-nons gtk-doc libxml2;
      };

      qemu = ((super.pkgsStatic.qemu.override {
        alsaSupport = false;
        spiceSupport = false;
        sdlSupport = false;
        smartcardSupport = false;
        gtkSupport = false;
        pulseSupport = false;

        # nativeBuildInputs
        makeWrapper = pkgs.makeWrapper;
        python = pkgs.python3;
        pkg-config = pkgs.pkg-config;
        flex = pkgs.flex;
        bison = pkgs.bison;
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        perl = pkgs.perl;
      }).overrideAttrs (old: {
        nativeBuildInputs = old.nativeBuildInputs ++ [
          pkgs.binutils
          # perl as nativeBuildInputs has been added in nixpkgs master
          # while it is backported to nixpkgs 21.11 (nixos 21.11).
          # If without perl as nativeBuildInputs,
          # ./scripts/shaderinclude.pl can not be patchShebangs'ed.
          pkgs.perl # without it cannot patchShebangs
        ];
        # qemu-6.1.1 has contained sigrtminmax patch, can not be patched again
        patches = builtins.filter (
          x: ! super.lib.hasSuffix "sigrtminmax.patch" x
        ) old.patches;
      })).overrideDerivation (old: let
        # qemu configure uses "--static" instead of standard "--disable-shared" and "--enable-static"
        configureFlags_no_DS = super.lib.lists.remove "--disable-shared" old.configureFlags;
        configureFlags_no_DS_no_ES = super.lib.lists.remove "--enable-static" configureFlags_no_DS;
      in {
        configureFlags = configureFlags_no_DS_no_ES ++ [
          "--static"
          # "--target-list-exclude="
          "--target-list=x86_64-softmmu"
        ];
      });

      qemu31 = (((super.callPackage (
        pinnedPkgsForQemu31Src + "/pkgs/applications/virtualization/qemu/default.nix"
      ) {
        inherit (super.darwin.apple_sdk.frameworks) CoreServices Cocoa Hypervisor;
        inherit (super.darwin.stubs) rez setfile;
      }).override {
        # In nixpkgs 20.03, stdenv contains lib attr.
        stdenv = pkgs.pkgsStatic.stdenv // {lib = super.lib;};
        alsaLib = null;
        spiceSupport = false;
        sdlSupport = false;
        smartcardSupport = false;
        gtkSupport = false;
        pulseSupport = false;

        # nativeBuildInputs
        makeWrapper = pkgs.makeWrapper;
        python2 = pkgs.python2;
        pkgconfig = pkgs.pkgconfig;
        flex = pkgs.flex;
        bison = pkgs.bison;
        perl = pkgs.perl;
      }).overrideAttrs (old: {
        nativeBuildInputs = old.nativeBuildInputs ++ [
          # Several issues report ld version &gt;= 2.34 will failed due to
          # PHDR segment not covered by LOAD segment.
          # https://github.com/OpenOrbis/OpenOrbis-PS4-Toolchain/issues/122
          # https://github.com/genodelabs/genode/issues/4003
          # So I downgrade ld version &lt; 2.34.
          # I still do not figure out why the same version ld in
          # qemu 6.1.1 static works correctly?
          pkgsForQemu31.binutils
        ];
      })).overrideDerivation (old: let
        # drop audio configure flag
        configureFlags_no_audio = builtins.filter (
          x: ! super.lib.hasPrefix "--audio-drv-list" x
        ) old.configureFlags;
        # qemu configure uses "--static" instead of standard "--disable-shared" and "--enable-static"
        configureFlags_no_DS = super.lib.lists.remove "--disable-shared" configureFlags_no_audio;
        configureFlags_no_DS_no_ES = super.lib.lists.remove "--enable-static" configureFlags_no_DS;
      in {
        configureFlags = configureFlags_no_DS_no_ES ++ [
          # "--static"
          # "--target-list-exclude="
          "--target-list=x86_64-softmmu"
          "--disable-gnutls"
          "--disable-tools"
        ];
        makeFlags = [
          # "V=1" # qemu Makefile verbose
          # It is neccessary to use ld in binutils, otherwise pc-bios build will fail.
          # In qemu 6.1.1 static, it is using ld in binutils, instead of ld from musl-gcc
          "AR=${pkgs.binutils-unwrapped}/bin/ar"
          "AS=${pkgs.binutils}/bin/as"
          "LD=${pkgs.binutils}/bin/ld"
          "NIX_BINTOOLS=${pkgs.binutils}"
        ];
      });
    })];

  };
in
{
  inherit (mypkgs.pkgsStatic) qemu qemu31;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build
# xieby1: 2022.05.24
# build static qemu (current version 6.1.1) into ./result/
# $ nix-build &lt;this-file&gt; -A qemu
# build static qemu-3.1.0 into ./result/
# $ nix-build &lt;this-file&gt; -A qemu31
# build and install static qemu
# $ nix-env -i -f &lt;this-file&gt; -A qemu
# build and install static qemu-3.1.0
# $ nix-env -i -f &lt;this-file&gt; -A qemu31
let
  pinnedPkgsSrc = builtins.fetchTarball {
    name = "nixos-static-qemu";
    url = "https://github.com/nixos/nixpkgs/archive/e7d63bd0d50df412f5a1d8acfa3caae75522e347.tar.gz";
    sha256 = "132pc4f9ixisyv4117p2jirmlyl6sd76bfaz33rhlcwakg7bhjm7";
  };
  # pkgs = import pinnedPkgsSrc {};
  # mypkgs = import pinnedPkgsSrc {
  pkgs = import &lt;nixpkgs&gt; {};
  mypkgs = import &lt;nixpkgs&gt; {
    overlays = [(self: super: {

      cdparanoiaIII = super.pkgsStatic.cdparanoiaIII.overrideAttrs (old: {
        preConfigure = old.preConfigure + ''
          cp ${super.gnu-config}/config.sub configure.sub
          cp ${super.gnu-config}/config.guess configure.guess
        '';
        # Makefile needs this to compile static
        STATIC="TRUE";
        buildPhase = ''
          make lib
          make cdparanoia
        '';
        preInstallPhases = ["preInstallPhase"];
        preInstallPhase = ''
          sed -i '/so/d' Makefile
        '';
      });

      liburing = super.pkgsStatic.liburing.overrideDerivation (old: {
        configureFlags = "";
        ENABLE_SHARED = 0;
      });

      # p11-kit cannot be used as a static library
      # https://github.com/p11-glue/p11-kit/issues/355
      p11-kit = super.pkgsMusl.p11-kit;
      # gnutls depends on p11-kit
      gnutls = super.pkgsMusl.gnutls;

      pam = super.pkgsStatic.openpam;

      # support both static and shared
      libselinux = (super.pkgsMusl.libselinux.override {
        libsepol = super.pkgsStatic.libsepol;
      }).overrideAttrs (old: {
         makeFlags = old.makeFlags ++ [
           "LIBDIR=$(out)/lib"
         ];
      });

      glib = (super.pkgsStatic.glib.override {
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        pkg-config = pkgs.pkg-config;
        perl = pkgs.perl;
        python3 = pkgs.python3;
        gettext = pkgs.gettext;
        gtk-doc = pkgs.gtk-doc;
        docbook_xsl = pkgs.docbook_xsl;
        docbook_xml_dtd_45 = pkgs.docbook_xml_dtd_45;
        libxml2 = pkgs.libxml2;
      }).overrideAttrs (old: {
        outputs = super.lib.lists.remove "devdoc" old.outputs;
        buildInputs = old.buildInputs ++ [
          super.pkgsStatic.libsepol
        ];
        preBuild = ''
          sed -i "s/get_option('libmount')/get_option('libmount'), static: true/g" ../meson.build
          sed -i "s/get_option('selinux')/get_option('selinux'), static: true/g" ../meson.build
        '';
        # no devdoc from non-static glibc
        # ${pname} &amp; ${version} is correct due to lazy assignment
        postInstall = pkgs.glib.postInstall;
      });

      gtk3 = super.pkgsStatic.gtk3.override {
        trackerSupport = false;
        cupsSupport = false;
        withGtkDoc = false;

        # nativeBuildInputs
        inherit (pkgs) gettext gobject-introspection makeWrapper meson ninja
        pkg-config python3 sassc docbook_xml_dtd_43 docbook-xsl-nons gtk-doc libxml2;
      };

      qemu = ((super.pkgsStatic.qemu.override {
        alsaSupport = false;
        spiceSupport = false;
        sdlSupport = false;
        smartcardSupport = false;
        gtkSupport = false;
        pulseSupport = false;

        # nativeBuildInputs
        makeWrapper = pkgs.makeWrapper;
        python = pkgs.python3;
        pkg-config = pkgs.pkg-config;
        flex = pkgs.flex;
        bison = pkgs.bison;
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        perl = pkgs.perl;
      }).overrideAttrs (old: {
        nativeBuildInputs = old.nativeBuildInputs ++ [
          pkgs.binutils
          # perl as nativeBuildInputs has been added in nixpkgs master
          # while it is backported to nixpkgs 21.11 (nixos 21.11).
          # If without perl as nativeBuildInputs,
          # ./scripts/shaderinclude.pl can not be patchShebangs'ed.
          pkgs.perl # without it cannot patchShebangs
        ];
        # qemu-6.1.1 has contained sigrtminmax patch, can not be patched again
        patches = builtins.filter (
          x: ! super.lib.hasSuffix "sigrtminmax.patch" x
        ) old.patches;
      })).overrideDerivation (old: let
        # qemu configure uses "--static" instead of standard "--disable-shared" and "--enable-static"
        configureFlags_no_DS = super.lib.lists.remove "--disable-shared" old.configureFlags;
        configureFlags_no_DS_no_ES = super.lib.lists.remove "--enable-static" configureFlags_no_DS;
      in {
        configureFlags = configureFlags_no_DS_no_ES ++ [
          "--static"
          # "--target-list-exclude="
          "--target-list=x86_64-softmmu"
        ];
      });
    })];
  };
in
{
  inherit (mypkgs.pkgsStatic.pkgsCross.riscv64) qemu;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build
# xieby1: 2022.05.24
# build static qemu (current version 6.1.1) into ./result/
# $ nix-build &lt;this-file&gt; -A qemu
# build static qemu-3.1.0 into ./result/
# $ nix-build &lt;this-file&gt; -A qemu31
# build and install static qemu
# $ nix-env -i -f &lt;this-file&gt; -A qemu
# build and install static qemu-3.1.0
# $ nix-env -i -f &lt;this-file&gt; -A qemu31
let
  pinnedPkgsSrc = builtins.fetchTarball {
    name = "nixos-static-qemu";
    url = "https://github.com/nixos/nixpkgs/archive/e7d63bd0d50df412f5a1d8acfa3caae75522e347.tar.gz";
    sha256 = "132pc4f9ixisyv4117p2jirmlyl6sd76bfaz33rhlcwakg7bhjm7";
  };
  # pkgs = import pinnedPkgsSrc {};
  # mypkgs = import pinnedPkgsSrc {
  pkgs = import &lt;nixpkgs&gt; {};
  mypkgs = import &lt;nixpkgs&gt; {
    overlays = [(self: super: {

      cdparanoiaIII = super.pkgsStatic.cdparanoiaIII.overrideAttrs (old: {
        preConfigure = old.preConfigure + ''
          cp ${super.gnu-config}/config.sub configure.sub
          cp ${super.gnu-config}/config.guess configure.guess
        '';
        # Makefile needs this to compile static
        STATIC="TRUE";
        buildPhase = ''
          make lib
          make cdparanoia
        '';
        preInstallPhases = ["preInstallPhase"];
        preInstallPhase = ''
          sed -i '/so/d' Makefile
        '';
      });

      liburing = super.pkgsStatic.liburing.overrideDerivation (old: {
        configureFlags = "";
        ENABLE_SHARED = 0;
      });

      # p11-kit cannot be used as a static library
      # https://github.com/p11-glue/p11-kit/issues/355
      p11-kit = super.pkgsMusl.p11-kit;
      # gnutls depends on p11-kit
      gnutls = super.pkgsMusl.gnutls;

      pam = super.pkgsStatic.openpam;

      # support both static and shared
      libselinux = (super.pkgsMusl.libselinux.override {
        libsepol = super.pkgsStatic.libsepol;
      }).overrideAttrs (old: {
         makeFlags = old.makeFlags ++ [
           "LIBDIR=$(out)/lib"
         ];
      });

      glib = (super.pkgsStatic.glib.override {
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        pkg-config = pkgs.pkg-config;
        perl = pkgs.perl;
        python3 = pkgs.python3;
        gettext = pkgs.gettext;
        gtk-doc = pkgs.gtk-doc;
        docbook_xsl = pkgs.docbook_xsl;
        docbook_xml_dtd_45 = pkgs.docbook_xml_dtd_45;
        libxml2 = pkgs.libxml2;
      }).overrideAttrs (old: {
        outputs = super.lib.lists.remove "devdoc" old.outputs;
        buildInputs = old.buildInputs ++ [
          super.pkgsStatic.libsepol
        ];
        preBuild = ''
          sed -i "s/get_option('libmount')/get_option('libmount'), static: true/g" ../meson.build
          sed -i "s/get_option('selinux')/get_option('selinux'), static: true/g" ../meson.build
        '';
        # no devdoc from non-static glibc
        # ${pname} &amp; ${version} is correct due to lazy assignment
        postInstall = pkgs.glib.postInstall;
      });

      gtk3 = super.pkgsStatic.gtk3.override {
        trackerSupport = false;
        cupsSupport = false;
        withGtkDoc = false;

        # nativeBuildInputs
        inherit (pkgs) gettext gobject-introspection makeWrapper meson ninja
        pkg-config python3 sassc docbook_xml_dtd_43 docbook-xsl-nons gtk-doc libxml2;
      };

      qemu = ((super.pkgsStatic.qemu.override {
        alsaSupport = false;
        spiceSupport = false;
        sdlSupport = false;
        smartcardSupport = false;
        gtkSupport = false;
        pulseSupport = false;

        # nativeBuildInputs
        makeWrapper = pkgs.makeWrapper;
        python = pkgs.python3;
        pkg-config = pkgs.pkg-config;
        flex = pkgs.flex;
        bison = pkgs.bison;
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        perl = pkgs.perl;
      }).overrideAttrs (old: {
        nativeBuildInputs = old.nativeBuildInputs ++ [
          pkgs.binutils
          # perl as nativeBuildInputs has been added in nixpkgs master
          # while it is backported to nixpkgs 21.11 (nixos 21.11).
          # If without perl as nativeBuildInputs,
          # ./scripts/shaderinclude.pl can not be patchShebangs'ed.
          pkgs.perl # without it cannot patchShebangs
        ];
        # qemu-6.1.1 has contained sigrtminmax patch, can not be patched again
        patches = builtins.filter (
          x: ! super.lib.hasSuffix "sigrtminmax.patch" x
        ) old.patches;
      })).overrideDerivation (old: let
        # qemu configure uses "--static" instead of standard "--disable-shared" and "--enable-static"
        configureFlags_no_DS = super.lib.lists.remove "--disable-shared" old.configureFlags;
        configureFlags_no_DS_no_ES = super.lib.lists.remove "--enable-static" configureFlags_no_DS;
      in {
        configureFlags = configureFlags_no_DS_no_ES ++ [
          "--static"
          # "--target-list-exclude="
          "--target-list=x86_64-softmmu"
        ];
      });
    })];
  };
in
{
  inherit (mypkgs.pkgsStatic.pkgsCross.riscv64) qemu;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build
# xieby1: 2022.05.24
# build static qemu (current version 6.1.1) into ./result/
# $ nix-build &lt;this-file&gt; -A qemu
# build static qemu-3.1.0 into ./result/
# $ nix-build &lt;this-file&gt; -A qemu31
# build and install static qemu
# $ nix-env -i -f &lt;this-file&gt; -A qemu
# build and install static qemu-3.1.0
# $ nix-env -i -f &lt;this-file&gt; -A qemu31
let
  # https://lazamar.co.uk/nix-versions
  pinnedPkgsForQemu31Src = builtins.fetchTarball {
    name = "nixos-20.03-with-qemu-3.1.0";
    url = "https://github.com/NixOS/nixpkgs/archive/81d4e65891f92e8e72c244da663c83c1e40dc919.tar.gz";
    sha256 = "0dk1k1zqy2bnp9gsy9mdxk0idkazyvnmqrj2jpbwzfnhjzpmzq1w";
  };
  pinnedPkgsSrc = builtins.fetchTarball {
    name = "nixos-static-qemu";
    url = "https://github.com/nixos/nixpkgs/archive/e7d63bd0d50df412f5a1d8acfa3caae75522e347.tar.gz";
    sha256 = "132pc4f9ixisyv4117p2jirmlyl6sd76bfaz33rhlcwakg7bhjm7";
  };
  pkgsForQemu31 = import pinnedPkgsForQemu31Src {};
  pkgs = import pinnedPkgsSrc {};
  mypkgs = import pinnedPkgsSrc {
    overlays = [(self: super: {

      cdparanoiaIII = super.pkgsStatic.cdparanoiaIII.overrideAttrs (old: {
        preConfigure = old.preConfigure + ''
          cp ${super.gnu-config}/config.sub configure.sub
          cp ${super.gnu-config}/config.guess configure.guess
        '';
        # Makefile needs this to compile static
        STATIC="TRUE";
        buildPhase = ''
          make lib
          make cdparanoia
        '';
        preInstallPhases = ["preInstallPhase"];
        preInstallPhase = ''
          sed -i '/so/d' Makefile
        '';
      });

      liburing = super.pkgsStatic.liburing.overrideDerivation (old: {
        configureFlags = "";
        ENABLE_SHARED = 0;
      });

      # p11-kit cannot be used as a static library
      # https://github.com/p11-glue/p11-kit/issues/355
      p11-kit = super.pkgsMusl.p11-kit;
      # gnutls depends on p11-kit
      gnutls = super.pkgsMusl.gnutls;

      pam = super.pkgsStatic.openpam;

      # support both static and shared
      libselinux = (super.pkgsMusl.libselinux.override {
        libsepol = super.pkgsStatic.libsepol;
      }).overrideAttrs (old: {
         makeFlags = old.makeFlags ++ [
           "LIBDIR=$(out)/lib"
         ];
      });

      glib = (super.pkgsStatic.glib.override {
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        pkg-config = pkgs.pkg-config;
        perl = pkgs.perl;
        python3 = pkgs.python3;
        gettext = pkgs.gettext;
        gtk-doc = pkgs.gtk-doc;
        docbook_xsl = pkgs.docbook_xsl;
        docbook_xml_dtd_45 = pkgs.docbook_xml_dtd_45;
        libxml2 = pkgs.libxml2;
      }).overrideAttrs (old: {
        outputs = super.lib.lists.remove "devdoc" old.outputs;
        buildInputs = old.buildInputs ++ [
          super.pkgsStatic.libsepol
        ];
        preBuild = ''
          sed -i "s/get_option('libmount')/get_option('libmount'), static: true/g" ../meson.build
          sed -i "s/get_option('selinux')/get_option('selinux'), static: true/g" ../meson.build
        '';
        # no devdoc from non-static glibc
        # ${pname} &amp; ${version} is correct due to lazy assignment
        postInstall = pkgs.glib.postInstall;
      });

      gtk3 = super.pkgsStatic.gtk3.override {
        trackerSupport = false;
        cupsSupport = false;
        withGtkDoc = false;

        # nativeBuildInputs
        inherit (pkgs) gettext gobject-introspection makeWrapper meson ninja
        pkg-config python3 sassc docbook_xml_dtd_43 docbook-xsl-nons gtk-doc libxml2;
      };

      qemu = ((super.pkgsStatic.qemu.override {
        alsaSupport = false;
        spiceSupport = false;
        sdlSupport = false;
        smartcardSupport = false;
        gtkSupport = false;
        pulseSupport = false;

        # nativeBuildInputs
        makeWrapper = pkgs.makeWrapper;
        python = pkgs.python3;
        pkg-config = pkgs.pkg-config;
        flex = pkgs.flex;
        bison = pkgs.bison;
        meson = pkgs.meson;
        ninja = pkgs.ninja;
        perl = pkgs.perl;
      }).overrideAttrs (old: {
        nativeBuildInputs = old.nativeBuildInputs ++ [
          pkgs.binutils
          # perl as nativeBuildInputs has been added in nixpkgs master
          # while it is backported to nixpkgs 21.11 (nixos 21.11).
          # If without perl as nativeBuildInputs,
          # ./scripts/shaderinclude.pl can not be patchShebangs'ed.
          pkgs.perl # without it cannot patchShebangs
        ];
        # qemu-6.1.1 has contained sigrtminmax patch, can not be patched again
        patches = builtins.filter (
          x: ! super.lib.hasSuffix "sigrtminmax.patch" x
        ) old.patches;
      })).overrideDerivation (old: let
        # qemu configure uses "--static" instead of standard "--disable-shared" and "--enable-static"
        configureFlags_no_DS = super.lib.lists.remove "--disable-shared" old.configureFlags;
        configureFlags_no_DS_no_ES = super.lib.lists.remove "--enable-static" configureFlags_no_DS;
      in {
        configureFlags = configureFlags_no_DS_no_ES ++ [
          "--static"
          # "--target-list-exclude="
          "--target-list=x86_64-softmmu"
        ];
      });

      qemu31 = (((super.callPackage (
        pinnedPkgsForQemu31Src + "/pkgs/applications/virtualization/qemu/default.nix"
      ) {
        inherit (super.darwin.apple_sdk.frameworks) CoreServices Cocoa Hypervisor;
        inherit (super.darwin.stubs) rez setfile;
      }).override {
        # In nixpkgs 20.03, stdenv contains lib attr.
        stdenv = pkgs.pkgsStatic.stdenv // {lib = super.lib;};
        alsaLib = null;
        spiceSupport = false;
        sdlSupport = false;
        smartcardSupport = false;
        gtkSupport = false;
        pulseSupport = false;

        # nativeBuildInputs
        makeWrapper = pkgs.makeWrapper;
        python2 = pkgs.python2;
        pkgconfig = pkgs.pkgconfig;
        flex = pkgs.flex;
        bison = pkgs.bison;
        perl = pkgs.perl;
      }).overrideAttrs (old: {
        nativeBuildInputs = old.nativeBuildInputs ++ [
          # Several issues report ld version &gt;= 2.34 will failed due to
          # PHDR segment not covered by LOAD segment.
          # https://github.com/OpenOrbis/OpenOrbis-PS4-Toolchain/issues/122
          # https://github.com/genodelabs/genode/issues/4003
          # So I downgrade ld version &lt; 2.34.
          # I still do not figure out why the same version ld in
          # qemu 6.1.1 static works correctly?
          pkgsForQemu31.binutils
        ];
      })).overrideDerivation (old: let
        # drop audio configure flag
        configureFlags_no_audio = builtins.filter (
          x: ! super.lib.hasPrefix "--audio-drv-list" x
        ) old.configureFlags;
        # qemu configure uses "--static" instead of standard "--disable-shared" and "--enable-static"
        configureFlags_no_DS = super.lib.lists.remove "--disable-shared" configureFlags_no_audio;
        configureFlags_no_DS_no_ES = super.lib.lists.remove "--enable-static" configureFlags_no_DS;
      in {
        configureFlags = configureFlags_no_DS_no_ES ++ [
          # "--static"
          # "--target-list-exclude="
          "--target-list=x86_64-softmmu"
          "--disable-gnutls"
          "--disable-tools"
        ];
        makeFlags = [
          # "V=1" # qemu Makefile verbose
          # It is neccessary to use ld in binutils, otherwise pc-bios build will fail.
          # In qemu 6.1.1 static, it is using ld in binutils, instead of ld from musl-gcc
          "AR=${pkgs.binutils-unwrapped}/bin/ar"
          "AS=${pkgs.binutils}/bin/as"
          "LD=${pkgs.binutils}/bin/ld"
          "NIX_BINTOOLS=${pkgs.binutils}"
        ];
      });
    })];

  };
in
{
  inherit (mypkgs.pkgsStatic) qemu qemu31;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env nix-build
# TODO
# Ref: ~/Documents/Tech/BT/QEMU/test.md
let
  pkgs = import &lt;nixpkgs&gt; {};
in
pkgs.stdenv.mkDerivation {
  buildInputs = with pkgs; [
    # configure needs
    ninja
    pkg-config
    glib
    # make needs
    glibc.static # TODO: this will cause configure failed
  ];
  buildFlags = [
    "CFLAGS=-O" # override CFLAGS
    "build-tcg-tests-x86_64-linux-user"
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># build by version
# nix-build pkgs_qemu.nix -A v1_0
# build by date
# nix-build pkgs_qemu.nix -A d2011_12_01
{ pkgs ? import &lt;nixpkgs&gt; {} }:
let
  pname = "qemu";
in rec {
  v1_0 = let
    version = "1.0";
  in pkgs.gcc49Stdenv.mkDerivation {
    inherit pname version;
    src = pkgs.fetchurl {
      url = "https://download.qemu.org/qemu-${version}.tar.xz";
      sha256 = "0y1018xia238pcqb7ad9v299b478c0838fiayl6qkzyd95gk0xbb";
    };
    buildInputs = with pkgs; [
      zlib
      pkg-config
      glib
      python2
    ];
    patches = [
      ./qemu-v1.0.patch
    ];
    configureFlags = [
      "--target-list=x86_64-linux-user"
      "--disable-docs"
    ];
  };
  d2011_12_01 = v1_0;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># https://github.com/NixOS/nixpkgs/issues/185773
{ lib, callPackage, fetchFromGitHub, fetchurl, openssl_1_1 }:

((callPackage (import (fetchFromGitHub {
  owner = "NixOS";
  repo = "nixpkgs";
  rev = "363ef08971726937cd6a63de0efef7f8ba657b18";
  sha256 = "sha256-QRKAn5yLMyohZKsK72Vkd6HQUh3t5tDpFyI/Y7T3ASg=";
}) { }).shellinabox.override) { openssl = openssl_1_1; }).overrideAttrs
({ patches, ... }: {
  patches = patches ++ [
    # OpenSSL 1.1
    (fetchurl {
      url =
        "https://github.com/shellinabox/shellinabox/commit/c32f3d365a0848eb6b3350ec521fcd4d1d098295.patch";
      hash = "sha256-Q8otJUip1YQJb0ZSF89BjSvrCh4PQe4R7Rb7mtm33tk=";
    })
  ];
})
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">{ pkgs ? import (fetchTarball {
    url = "https://github.com/NixOS/nixpkgs/archive/1dab772dd4a68a7bba5d9460685547ff8e17d899.tar.gz";
    sha256 = "18qwmspcsmi0ryhcg66p9i42qwismm7l0706m39zw5ziq6n11fc9";
  }) {}
, CONFIG ? "XSNoCTopConfig" # "DefaultConfig"
, EMU_THREADS ? "4"
, NUM_CORES ? "1"
, EMU_TRACE ? "fst" # "fst" or "vcd"
, DISABLE_PERF ? "1"
, genRTL ? false
}:
let
  xs-src = (pkgs.fetchFromGitHub {
    owner = "OpenXiangShan";
    repo = "XiangShan";
    rev = "ff4344e4e52d4e58ba1570da9ace0dafaca74de0";
    hash = "sha256-2vaeqiEOGRlEkcSZLzneqwVe1IldhPMK552ydUnKS+s=";
    forceFetchGit = true;
  }).overrideAttrs (old: {
    # NOTE: Why not use leaveDotGit/deepClone here?
    # see pkgs/build-support/fetchgit/nix-prefetch-git:
    # # &gt; # shallow with leaveDotGit will change hashes
    # In other words: If deepClone/leaveDotGit co-exists with fetchSubmodules
    # (here we only fetch selected submodules by NIX_PREFETCH_GIT_CHECKOUT_HOOK)
    # then hash changes every time.
    #
    # old nixpkgs.fetchgit not support preFetch
    # preFetch = ''export NIX_PREFETCH_GIT_CHECKOUT_HOOK="make -C $out init"'';
    NIX_PREFETCH_GIT_CHECKOUT_HOOK="make -C $out init";
  });
  # If you want to use other mill version, uncomment belowing
  # mill = pkgs.mill.overrideAttrs (finalAttrs: previousAttrs: {
  #   version = "0.11.8";
  #   src = pkgs.fetchurl {
  #     url = "https://github.com/com-lihaoyi/mill/releases/download/${finalAttrs.version}/${finalAttrs.version}-assembly";
  #     hash = "sha256-HORTexIzrxbWjcGrS59JqZboxGCzk8wKf3eKMoYGqrI=";
  #   };
  # });
  mill = pkgs.mill;
  mill-with-proxy = pkgs.writeShellScriptBin "mill" ''
    # -i/--interactive/--no-server/--bsp must be passed in as the first argument
    if [[ $1 == -i || $1 == --interactive ||  $1 == --no-server || $1 == --bsp  ]]; then
      FIRST_ARG=$1
      shift
    fi
    ${mill}/bin/mill $FIRST_ARG \
      -D http.proxyHost=$(echo $http_proxy | sed -E 's,(.*://)?([^:/]+):([0-9]*).*,\2,') \
      -D http.proxyPort=$(echo $http_proxy | sed -E 's,(.*://)?([^:/]+):([0-9]*).*,\3,') \
      -D https.proxyHost=$(echo $https_proxy | sed -E 's,(.*://)?([^:/]+):([0-9]*).*,\2,') \
      -D https.proxyPort=$(echo $https_proxy | sed -E 's,(.*://)?([^:/]+):([0-9]*).*,\3,') \
      "$@"
  '';
  # mill deps refer to https://github.com/com-lihaoyi/mill/discussions/1170
  COURSIER_CACHE = pkgs.stdenv.mkDerivation {
    name = "xs-mill-cache";
    src = xs-src;
    nativeBuildInputs = [ mill-with-proxy ];
    impureEnvVars = pkgs.lib.fetchers.proxyImpureEnvVars;
    # [COURSIER_CACHE with relative path cause artifacts download into process sandbox folder](https://github.com/com-lihaoyi/mill/issues/3946)
    # Thus, COURSIER_CACHE uses absolute path like below
    buildPhase = ''
      export COURSIER_CACHE=$PWD/.cache/coursier
      mill __.prepareOffline
    '';
    installPhase = ''
      cp -r $COURSIER_CACHE $out
    '';
    outputHashMode = "recursive";
    outputHash = "sha256-9qL+2W2KSHIV4KxhfY9F+2j1xP8NCW7mC/CO2EWbYh8=";
  };
in pkgs.stdenv.mkDerivation {
  name = "xs";
  src = xs-src;
  nativeBuildInputs = [
    pkgs.makeWrapper
    mill-with-proxy
    pkgs.time
    pkgs.espresso
    pkgs.verilator
    pkgs.sqlite
    pkgs.zlib
    pkgs.zstd
    pkgs.python3
  ];

  postPatch = ''
    patchShebangs scripts/
  ''
  # The .git/ folder format is not stable, thus hard to achieve deterministic.
  # For more information about .git/ and deterministic see the `leaveDotGit` option in
  # [nixpkgs manual: fetchgit](https://nixos.org/manual/nixpkgs/stable/#fetchgit).
  # 1. Clean vcs.version scala lib, which needs the .git/ folder.
  + ''
    find -name build.sc -exec sed -i '/vcs.version/d' {} \;
    sed -i '/def publishVersion/,/^  )$/c\  def publishVersion() = "deterministic-version"' build.sc
    find -name build.sc -exec sed -i 's/def publishVersion =.*vcs.version.*/def publishVersion = "miao"/' {} \;
  ''
  # 2. Clean git related operations in build.sc
  + ''
    sed -i '/def gitStatus:/,/^  }/c\  def gitStatus() = "SHA=${xs-src.rev}\\ndirty=0"' build.sc
    sed -i 's/"git", "ls-files"/"ls", "-1"/' build.sc
    sed -i 's/os.proc("git", "submodule", "status").call().out.text()/""/' build.sc
  ''
  # 3. Clean git in Makefile
  + ''
    sed -i '/@git log/,/rm .__head__/d' Makefile
  '';

  # current version of Chisel (6.6.0) was published against firtool version 1.62.1
  CHISEL_FIRTOOL_PATH = "${(import (pkgs.fetchFromGitHub {
    owner = "NixOS";
    repo = "nixpkgs";
    rev = "771b079bb84ac2395f3a24a5663ac8d1495c98d3";
    sha256 = "0l1l9ms78xd41xg768pkb6xym200zpf4zjbv4kbqbj3z7rzvhpb7";
  }){}).circt}/bin/";
  shellHook = ''
    export NOOP_HOME=$(realpath .)
  '';
  buildPhase = ''
    eval "$shellHook"
    # Q: Why not use COURSIER_CACHE as a variable in mkDerivation
    # A: To prevent COURSIER_CACHE (a read-only path in /nix/store) from affecting LSP metals' behaviour in nix-shell
    export COURSIER_CACHE=${COURSIER_CACHE}
    make emu CONFIG=${CONFIG} EMU_THREADS=${EMU_THREADS} NUM_CORES=${NUM_CORES} EMU_TRACE=${EMU_TRACE} DISABLE_PERF=${DISABLE_PERF} -j $NIX_BUILD_CORES
  '';

  outputs = ["out"] ++ pkgs.lib.optional genRTL "rtl";
  installPhase = ''
    mkdir -p $out/bin
    cp build/emu $out/bin/
    wrapProgram $out/bin/emu --prefix PATH : ${pkgs.lib.makeBinPath [pkgs.spike]}
  '' + pkgs.lib.optionalString genRTL ''
    mkdir -p $rtl
    cp -r build/rtl/* $rtl/
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><p>See all fhs-shell scripts on [Github repo: scripts/shell]({{ site.repo_url }}/scripts/shell)</p>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  name = "LinkNan";
  pkgs = import &lt;nixpkgs&gt; {};
in pkgs.mkShell {
  inherit name;

  buildInputs = let
    h_content = builtins.toFile "h_content" ''
      # ${pkgs.lib.toUpper "${name} usage tips"}
    '';
    _h_ = pkgs.writeShellScriptBin "h" ''
      ${pkgs.glow}/bin/glow ${h_content}
    '';
    mill_0_11_2 = (import (pkgs.fetchFromGitHub {
      owner = "NixOS";
      repo = "nixpkgs";
      rev = "4ab8a3de296914f3b631121e9ce3884f1d34e1e5";
      hash = "sha256-mQUik6XZea6ZcCkMpUieq1oxlEDE0vqTTRU9RStgtSQ=";
    }){}).mill;
  in [
    _h_
    mill_0_11_2
  ] ++ (with pkgs; [
    xmake
    espresso
    verilator

    # libs
    sqlite
    zlib
    zstd
  ]);

  shellHook = let
    circt_1_62_0 = (import (pkgs.fetchFromGitHub {
      owner = "NixOS";
      repo = "nixpkgs";
      rev = "771b079bb84ac2395f3a24a5663ac8d1495c98d3";
      sha256 = "0l1l9ms78xd41xg768pkb6xym200zpf4zjbv4kbqbj3z7rzvhpb7";
    }){}).circt;
  in ''
    h
    export CHISEL_FIRTOOL_PATH=${circt_1_62_0}/bin/
    export NOOP_HOME=$(realpath .)
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  pkgs = import &lt;nixpkgs&gt; {};
  ccache_dir = toString ./. + "/.ccache";
  ccache14Stdenv = pkgs.ccacheStdenv.override {
    stdenv = pkgs.gcc14Stdenv;
    extraConfig = ''
      export CCACHE_COMPRESS=1
      export CCACHE_DIR="${ccache_dir}"
      export CCACHE_UMASK=007
      if [ ! -d "$CCACHE_DIR" ]; then
        echo "====="
        echo "Directory '$CCACHE_DIR' does not exist"
        echo "Please create it with:"
        echo "  mkdir -m0770 '$CCACHE_DIR'"
        echo "====="
        exit 1
      fi
      if [ ! -w "$CCACHE_DIR" ]; then
        echo "====="
        echo "Directory '$CCACHE_DIR' is not accessible for user $(whoami)"
        echo "Please verify its access permissions"
        echo "====="
        exit 1
      fi
    '';
  };
  ccacheMkShell = pkgs.mkShell.override {
    stdenv = ccache14Stdenv;
  };
in ccacheMkShell {
  name = "ccache-shell";
  shellHook = ''
    mkdir -m0770 -p ${ccache_dir}
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  name = "chipyard";
  pkgs = import &lt;nixpkgs&gt; {};
  pkgsCirct1_30_0 = import (builtins.fetchTarball {
      url = "https://github.com/NixOS/nixpkgs/archive/0aca8f43c8dba4a77aa0c16fb0130237c3da514c.tar.gz";
  }) {};

  # currently latest spike
  my-spike = pkgs.spike.overrideAttrs (old: {
    version = "1.1.1-dev";
    src = pkgs.fetchFromGitHub {
      owner = "riscv";
      repo = "riscv-isa-sim";
      rev = "4f916978cd17bd2e83cfca233d0fa40153fda5f4";
      sha256 = "sha256-84YY9YMIa4YO5mVJ0gGMOWnD2/CnpEjIbB9EjA5+Glc=";
    };
  });

  h_content = builtins.toFile "h_content" ''
    # ${pkgs.lib.toUpper "${name} usage tips"}

    The conda cannot gracefully manage the dependencies, e.g. gcc's dynamic libraries.
    Instead, I replace conda with nix to manage the dependencies.

    * Show this help: `h`

    Init Repos

    * edit common.mk:1 `SHELL=bash`
    * `./scripts/init-submodules-no-riscv-tools-nolog.sh`

    Compiling Verilator

    * `make -C sims/verilator`

    Run Verilator

    * `./sims/verilator/simulator-chipyard.harness-RocketConfig &lt;RISCV Executable&gt;`
  '';
  _h_ = pkgs.writeShellScriptBin "h" ''
    ${pkgs.glow}/bin/glow ${h_content}
  '';
in pkgs.mkShell {
  inherit name;
  packages = with pkgs; [
    verilator
    dtc
    jq
    pkgsCirct1_30_0.circt
    my-spike

    _h_
  ];
  shellHook = ''
    export RISCV=${pkgs.pkgsCross.riscv64-embedded.stdenv.cc}

    h
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
# xieby1: 2022.07.03
# let
#   pkgs = import &lt;nixpkgs&gt; {};
# in
# pkgs.mkShell {
#   buildInputs = [
#     pkgs.pkgsCross.mipsel-linux-gnu.stdenv.cc
#   ];
# }

# xieby1: 2022.05.16
let
  pkgs_mips_cross = import &lt;nixpkgs&gt; {
    crossSystem = "mips-linux";
  };
  pkgs = import &lt;nixpkgs&gt; {};
in
pkgs.mkShell {
  buildInputs = (with pkgs_mips_cross; [
    buildPackages.gdb
    buildPackages.gcc
  ]) ++ (with pkgs; [
    qemu
  ]);
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
# xieby1: 2022.04.26

let
  pkgs_arm_cross = import &lt;nixpkgs&gt; {
    # get this config on my android
    #   nix repl
    #   builtins.currentSystem
    crossSystem = "aarch64-linux";
  };
  pkgs_arm_native = import &lt;nixpkgs&gt; {
    localSystem = "aarch64-linux";
    crossSystem = "aarch64-linux";
  };
  pkgs = import &lt;nixpkgs&gt; {};
in
pkgs.mkShell {
  buildInputs = with pkgs_arm_cross; [
    # packages for cross compiling, run on local system (x86_64)
    stdenv.cc
    # here stdenv.cc is the same with buildPackages.gcc
  ] ++ (with pkgs_arm_native; [
    # packages run on aarch64
    figlet
  ]) ++ (with pkgs; [
    # packages run on local system (x86_64)
    qemu
  ]);
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
{ system ? builtins.currentSystem }:
let
  src = fetchTarball {
    url = "https://github.com/numtide/devshell/archive/9fddc998b4522694caaf4056e93154d2c11752cd.tar.gz";
    sha256 = "0d7ra00843n4iyadhdxcr9m0vcn6fz54hfymms6nbdz0d2pjff06";
  };
  devshell = import src { inherit system; };
in
devshell.mkShell {
  commands = [{
    name = "hello";
    command = "echo hello";
    help = "print hello miao";
  }];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
let
  pkgs = import &lt;nixpkgs&gt; {};
in pkgs.mkShellNoCC {
  name = "gcc11";
  packages = with pkgs; [
    gcc11
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
with import &lt;nixpkgs&gt; {};
# You will get a shell with hello executable,
# and environment variable $name, $miao.
mkShell {
  packages = [
    hello
  ];
  name = "test-env";
  miao = "miao!";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  pkgs = import &lt;nixpkgs&gt; {};
in pkgs.stdenv.mkDerivation {
  name = "child";
  propagatedBuildInputs = [
    (import ./grandchild.nix)
  ];
  dontUnpack = true;
  buildPhase = "mkdir -p $out";
  installPhase = "touch $out/miao";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  pkgs = import &lt;nixpkgs&gt; {};
in pkgs.stdenv.mkDerivation {
  name = "grandchild";
  dontUnpack = true;
  propagatedBuildInputs = [
    pkgs.hello
  ];
  buildPhase = "mkdir -p $out";
  installPhase = "touch $out/miao";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  pkgs = import &lt;nixpkgs&gt; {};
in pkgs.stdenv.mkDerivation {
  name = "parent";
  propagatedBuildInputs = [
    (import ./child.nix)
  ];
  dontUnpack = true;
  buildPhase = "mkdir -p $out";
  installPhase = "touch $out/miao";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
#2022.05.18
# pip install is usable in venv
# e.g.
# $ nix-shell &lt;this_file&gt;
# $ pip install [--user] graphviz2drawio
let
  pkgs = import &lt;nixpkgs&gt; {};
in
pkgs.mkShell {
  propagatedBuildInputs = with pkgs.python3Packages; [
    pip
    venvShellHook
    ipython
    pygame
  ] ++ (with pkgs; [
  ]);
  venvDir = "pygame";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix"># https://nixos.wiki/wiki/Python
# Python virtual environment

# Execute this commands after entering fhs env
# python -m venv .venv
# source .venv/bin/activate

let
  pkgs = import &lt;nixpkgs&gt; {};
in (pkgs.buildFHSUserEnv {
  name = "venv";
  targetPkgs = p: (with p.python3Packages; [
    pip
    virtualenv
    ipython
  ]);
}).env
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
let
  mach-nix = import (builtins.fetchGit {
    url = "https://github.com/DavHau/mach-nix";
    ref = "refs/tags/3.4.0";
  }) {
    pkgs = import &lt;nixpkgs&gt; {};
  };
in
mach-nix.mkPythonShell {
  requirements = ''
    expmcc
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
#2022.05.18
# pip install is usable in venv
# e.g.
# $ nix-shell &lt;this_file&gt;
# $ pip install [--user] graphviz2drawio
let
  pkgs = import &lt;nixpkgs&gt; {};
in
pkgs.mkShell {
  propagatedBuildInputs = with pkgs.python3Packages; [
    pip
    pygraphviz
    venvShellHook
    ipython
  ] ++ (with pkgs; [
    graphviz
  ]);
  venvDir = "venv";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
# lxy's qemu plugins: http://172.17.103.58/lixinyu/qemu_plugins

let
  pkgs = import &lt;nixpkgs&gt; {};
in pkgs.mkShell {
  packages = with pkgs; [
    zlib.dev
    pkg-config
    glib.dev
  ];
  QEMU_DIR = "~/Codes/qemu";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
# --pure: start a pure reproducible shell
# 2022.04.24
# Compile qemu/tests/tcg/x86_64/
# env CFLAGS=-O make -e build-tcg-tests-x86_64-linux-user
{ pkgs ? import &lt;nixpkgs&gt; {} }:
let
  name = "nix";
in
pkgs.mkShell {
  inherit name;
  buildInputs = with pkgs; [
    glibc.static
  ];
  inputsFrom = with pkgs; [
    qemu
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">let
  name = "riscv-tests";
  pkgs = import &lt;nixpkgs&gt; {};
  h_content = builtins.toFile "h_content" ''
    # ${pkgs.lib.toUpper "${name} compiling tips"}

    * `git submodule update --init --recursive`
    * `autoconf`
    * `./configure`
    * `make -j`
  '';
  _h_ = pkgs.writeShellScriptBin "h" ''
    ${pkgs.glow}/bin/glow ${h_content}
  '';
in pkgs.mkShell {
  inherit name;
  packages = with pkgs; [
    autoconf
    pkgsCross.riscv64-embedded.stdenv.cc

    _h_
  ];
  shellHook = ''
    export RISCV_PREFIX=${pkgs.pkgsCross.riscv64-embedded.stdenv.cc}/bin/riscv64-none-elf-
    h
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
with import &lt;nixpkgs&gt; {};
mkShell {
  packages = [
    dtc
    pkgsCross.riscv64-embedded.stdenv.cc
  ];
  name = "spike";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
# --pure: start a pure reproducible shell
{ pkgs ? import &lt;nixpkgs&gt; {}
}:
pkgs.mkShell {
  name="dev-environment";
  buildInputs = with pkgs; [
    texlive.combined.scheme-full # HUGE SIZE!

    tmux
  ];
  shellHook = ''
    # install texlive permenant
    nix-env -q "texlive.*"
    if [[ ''$? -ne 0 ]]
    then
      nix-env -f '&lt;nixpkgs&gt;' -iA texlive.combined.scheme-full
    fi

    tmux
    exit
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
{pkgs ? import &lt;nixpkgs&gt; {}}:
let
  name = "ucasproposal";
  myTexlive = pkgs.texlive.combine {
    inherit (pkgs.texlive)
    scheme-basic

    xetex
    ctex
    checkcites

    # sty
    newtx
    xstring
    realscripts
    jknapltx
    mathalpha
    caption
    placeins
    enumitem
    listings
    algpseudocodex
    algorithms
    algorithmicx
    chemfig
    mhchem
    float

    # tex
    simplekv

    rsfs
    ;
  };
  myPython = pkgs.python3.withPackages (p: with p; [
    ipython
    matplotlib
    pandas
    numpy
    openpyxl
  ]);
in
pkgs.mkShell {
  inherit name;
  packages = with pkgs; [
    myTexlive
    myPython
    librsvg
  ];
  shellHook = ''
    # env
    export PYTHONPATH=${myPython}/${myPython.sitePackages}
    export debian_chroot=${name}
  '';
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
{ pkgsX86 ? import &lt;nixpkgs&gt; {
  localSystem.system="aarch64-linux";
  crossSystem="aarch64-linux";
} }:
pkgsX86.v8
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
#2022.05.18
# pip install is usable in venv
# e.g.
# $ nix-shell &lt;this_file&gt;
# $ pip install [--user] graphviz2drawio
let
  pkgs = import &lt;nixpkgs&gt; {};
in
pkgs.mkShell {
  propagatedBuildInputs = with pkgs.python3Packages; [
    pip
    venvShellHook
    ipython
  ];
  venvDir = "${builtins.getEnv "HOME"}/.venv";
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><pre><code class="language-nix">#!/usr/bin/env -S nix-shell --keep miao
let
  pkgs = import (builtins.fetchTarball {
    url = "https://github.com/NixOS/nixpkgs/archive/5e15d5da4abb74f0dd76967044735c70e94c5af1.tar.gz";
    sha256 = "0mk86mlxamjxhywdfp5asylqb39z7w18dcy8ds6qvl8gqjrijmq9";
  }) {
    system = "x86_64-linux";
  };
in pkgs.mkShell {
  name = "wine6";
  packages = with pkgs; [
    wine64
  ];
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="shellnix"><a class="header" href="#shellnix">shell.nix</a></h1>
<p>è¿™ä¸ªshell.nixç”¨äºåˆ›å»ºç¼–è¯‘æˆ‘çš„<a href="https://github.com/xieby1/nix_config">nix_configä»“åº“</a>çš„
<a href="https://xieby1.github.io/nix_config/">GitHub Pages</a>çš„ç¯å¢ƒã€‚
GitHub Pagesçš„æ„å»ºä¸»è¦ç”±<code>markcode</code>å’Œ<code>mdbook</code>è¿™ä¸¤ä¸ªå·¥å…·æ”¯æŒã€‚</p>
<ul>
<li><a href="https://github.com/xieby1/markcode"><code>markcode</code></a>
æ˜¯æˆ‘ä¸ºäº†æ–¹ä¾¿åœ¨æºæ–‡ä»¶é‡Œå†…åµŒæ–‡æ¡£ï¼Œå†™çš„ä¸€ä¸ªå°å·¥å…·ã€‚
å®ƒèƒ½å°†æºæ–‡ä»¶ä¸­å¸¦æœ‰ç‰¹æ®Šæ ‡è®°çš„æ³¨é‡ŠæŠ½å–å‡ºï¼Œæˆä¸ºmarkdownæ–‡ä»¶ã€‚
nix_configä»“åº“çš„å‡ ä¹æ‰€æœ‰æ–‡æ¡£éƒ½å†…åµŒåœ¨.nixæ–‡ä»¶ä¸­ï¼Œ
å¹¶éƒ½æ˜¯é€šè¿‡<code>markcode</code>ä».nixæ–‡ä»¶æŠ½å–å‡ºæ¥ã€‚</li>
<li><a href="https://github.com/rust-lang/mdBook"><code>mdbook</code></a>
æ˜¯ä¸€ä¸ªéå¸¸çº¯ç²¹ä¸”å¥½ç”¨çš„é™æ€ç½‘é¡µç”Ÿæˆæ¡†æ¶ï¼Œè´Ÿè´£å°†markdownè½¬æ¢æˆç½‘é¡µã€‚
å› ä¸ºç¬¬ä¸€æ¬¡é˜…è¯»<a href="https://nixos.org/manual/nix/stable/introduction.html">nixå®˜æ–¹æ–‡æ¡£</a>æ—¶å°±å–œæ¬¢ä¸Šäº†è¿™ä¸ªæ–‡æ¡£æ¡†æ¶ï¼Œ
æ‰€ä»¥æˆ‘ä¹Ÿé‡‡ç”¨çš„<code>mdbook</code>ä½œä¸ºæˆ‘çš„nix_configçš„æ–‡æ¡£æ¡†æ¶ã€‚</li>
</ul>
<pre><code class="language-nix">let
  name = "nix_config";
  pkgs = import &lt;nixpkgs&gt; {};
  markcode = pkgs.callPackage (
    pkgs.fetchFromGitHub {
      owner = "xieby1";
      repo = "markcode";
      rev = "1c414aca28db7f2727f6da118f4e914743780ad0";
      hash = "sha256-B5kmpAIyUihlBqk7oNAdqBmdfCajCmleKBTgLyy0NqU=";
    }
  ) {};
in pkgs.mkShell {
  inherit name;
  buildInputs = with pkgs; [
    mdbook
    markcode
  ];
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>
            <script src="https://utteranc.es/client.js"
                    repo="xieby1/nix_config"
                    issue-term="pathname"
                    theme="github-light"
                    crossorigin="anonymous"
                    async>
            </script>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
