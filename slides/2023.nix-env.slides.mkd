---
title: Nixè®©ä½ çš„å›¢é˜Ÿæˆå‘˜ä¸å†å—ç¯å¢ƒé—®é¢˜å›°æ‰°
author: ğŸ¤“è°¢æœ¬å£¹
date: 2023.05

headerr: <img src="https://raw.githubusercontent.com/NixOS/nixos-artwork/master/logo/nix-snowflake.svg" style="height:24pt;">

title-slide-background-image: ./images/nix-wallpaper-nineish.src.svg
toc-slide-background-image: ./images/nix-wallpaper-nineish.src.svg
level1-slide-background-image: ./images/nix-wallpaper-nineish.src.svg
level2-slide-background-image: ./images/efi-background.png
---

# Nix/NixOSç®€ä»‹

## Nix/NixOSæ˜¯ä»€ä¹ˆ

:::{.container}
::::{.col style="width:50%;"}
<h3>Nix</h3>

* åŒ…ç®¡ç†å™¨ (Package Manager)
::::
::::{.col style="width:50%;"}
<h3>NixOS</h3>

åŸºäºNixçš„Linuxå‘è¡Œç‰ˆ (Distro)
::::
:::

## Nix/NixOSå‘å±•ç®€å²

::: {.container}
:::: {.col style="width:30%;"}
* 2006: åšå£«è®ºæ–‡[1]
* 2012: Github[2,3]
* 2021: 100%å¯é‡ç°[4]
::::
:::: {.col style="width:60%;"}
<img src="https://api.star-history.com/svg?repos=NixOS/nixpkgs,NixOS/nix&type=Date" style="height: 400px;">
::::
:::

::: {style="font-size:12pt;"}
* \[1\]: Dolstra, Eelco. â€œThe purely functional software deployment model.â€ (2006).
* \[2\]: https://github.com/NixOS/nixpkgs
* \[3\]: https://github.com/NixOS/nix
* \[4\]: Nixos-unstableâ€™s iso_minimal.x86_64-linux is 100% reproducible! https://discourse.nixos.org/t/nixos-unstable-s-iso-minimal-x86-64-linux-is-100-reproducible/13723
:::

## Nix/NixOSç‰¹ç‚¹ {data-auto-animate=1}

::: {style="font-size:20pt;"}
* Imperativeï¼ˆå‘½ä»¤å¼ï¼‰/Declarativeï¼ˆå£°æ˜å¼ï¼‰
* **çº¯**å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ (Purely Functional)
* å¯é‡ç° (Reproducible)
:::

## Nix/NixOSç‰¹ç‚¹-ç»­ {data-auto-animate=1}

::: {style="font-size:20pt;"}
* Imperativeï¼ˆå‘½ä»¤å¼ï¼‰/Declarativeï¼ˆå£°æ˜å¼ï¼‰
* ğŸŸ¢Imperative
  * `apt install vim`
  * `nix-env -iA nixpkgs.vim`
* ğŸŸ¢Declarativeå³éœ€è¦ç¼–ç¨‹
* **çº¯**å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ (Purely Functional)
* ğŸŸ¢åœ¨nixé…ç½®ä»£ç ä¸­ï¼š`home.packages = [nixpkgs.vim];`
* å¯é‡ç° (Reproducible)
* ğŸ”´apt installï¼Œä¸åŒæ—¶é—´å®‰è£…çš„å†…å®¹ä¸ä¸€æ ·
:::

## <img src="images/nix-snowflake.svg" style="height:1em;">Nix/NixOS vs <img src="images/ubuntu-icon.svg" style="height:1em;">APT/Ubuntu

::: {style="zoom: 70%;"}
|          | Nix/NixOS                           | APT/Ubuntu            |
|----------|-------------------------------------|-----------------------|
| ä½¿ç”¨ç”¨æˆ· | root(system wide), æ™®é€šç”¨æˆ·         | ä»…root(system wide)   |
| ç‰ˆæœ¬å‡çº§ | éšæ—¶å‡çº§channel                     | è·¨ç‰ˆæœ¬å‡çº§éš¾          |
| å®‰è£…ä½ç½® | å…¨å±€/å„ç”¨æˆ·ï¼š/nix/storeé…åˆç¬¦å·é“¾æ¥ | å…¨å±€ï¼š/bin, /usr, ... |
| åŒ…çš„ç‰ˆæœ¬ | èƒ½å¤ŸåŒæ—¶å®‰è£…å¤šä¸ªç‰ˆæœ¬çš„åŒ…            | å•ä¸€ç‰ˆæœ¬              |
| åŒ…çš„æ•°é‡ | >80,000[1]                          | 72,514[2]             |
| æ›´æ–°é€Ÿåº¦ | æ¯å¤©å‡ ç™¾ä¸ªcommits[3]                | -                     |
| å¼€æ”¾ç¨‹åº¦ | å¼€æ”¾ã€å¯å»ä¸­å¿ƒåŒ–                    | Canonical Ltdç»´æŠ¤     |
| å†å²å›æ»š | æ”¯æŒ                                | -                     |
| äº¤äº’æ–¹å¼ | Declarative/Imperative              | ä»…Imperative          |
:::

::: {style="font-size: 12pt;"}
</br>

* \[1\]: https://search.nixos.org/packages
* \[2\]: `apt list | wc -l`
* \[3\]: `git log --date=short --pretty=format:%ad | sort | uniq -c`
:::

## <img src="images/nix-snowflake.svg" style="height:1em;">Nix/NixOS vs <img src="images/Moby-logo.png" style="height:1em;">Docker

Dockerèå…¥ç°æœ‰ç¯å¢ƒ

æ²¡åŠæ³•ç®€å•çš„åœ¨dockerç¯å¢ƒä¸­ç”¨è‡ªå·±çš„vim/vscodeé…ç½®

## å­¦ä¹ Nix/NixOS

[å­¦ä¹ æ›²çº¿é™¡å³­ğŸ“ˆï¼Œä½†ä¹Ÿåˆ«æ‹…å¿ƒğŸ˜¸]{.fragment}

::: {.container}
:::: {.col}
<h3>å…¥é—¨æ–‡æ¡£</h3>

* [å®˜æ–¹å­¦ä¹ æ–‡æ¡£](https://nixos.org/learn.html)
  * [Nix Pills](https://nixos.org/guides/nix-pills/)
  * [Nix Ref Man](https://nixos.org/manual/nix/stable/introduction.html)
* éå®˜æ–¹æ–‡æ¡£
  * [NixOS Wiki](https://nixos.wiki/)
  * [nix.dev](https://nix.dev/)
::::
:::: {.col}
<h3>é‡åˆ°é—®é¢˜</h3>

* [NixOSè®ºå›](http://discourse.nixos.org/)
* [Github nixpkgs issues](https://github.com/NixOS/nixpkgs/issues)
* [Reddit NixOS](https://github.com/NixOS/nixpkgs/issues)
* StackOverflow
* é—®åŒå­¦
* ...
::::
:::

# Nixå±•ç¤º

## Nixä½¿ç”¨æ¨¡å¼

::: {.container}
:::: {.col}
<h3>nix-env</h3>

* æ°¸ä¹…çš„(Permanent)
* å’Œå…¶ä»–åŒ…ç®¡ç†å™¨å·®ä¸å¤š
::::
:::: {.col}
<h3>nix-shell</h3>

* ç¨çºµå³é€çš„ï¼ˆEphemeralï¼‰
* ç±»ä¼¼pythonçš„venv
::::
:::

</br>

[nix-shellé€‚åˆåˆ›å»ºå¼€å‘ç¯å¢ƒ]{.fragment}

## nix-shellä½¿ç”¨åœºæ™¯å®ä¾‹

::: {.container}
:::: {.col .fragment}
åŒå­¦å£¹ğŸ¤“

---

æäº†ä¸€ä¸ª

gem5é¡¹ç›®
::::
:::: {.col .fragment}
åŒå­¦è´°ğŸ« 

---

åœ¨ubuntu22ä¸Š

æ­»æ´»ç¼–è¯‘ä¸æˆåŠŸ
::::
:::: {.col .fragment}
åŒå­¦åğŸ˜¨

---

åœ¨æœåŠ¡å™¨ï¼ˆubuntu16ï¼‰ä¸Š

å¥½å¤šåº“éƒ½æ²¡æœ‰
::::
:::

</br>

[é¡¹ç›®ä¸€å¼€å§‹å°±ä½“éªŒæå·®ğŸ˜–ğŸ˜¤ğŸ˜±]{.fragment}

## nix-shellä½¿ç”¨åœºæ™¯å®ä¾‹-ç»­ {data-auto-animate=1}

::: {.container}
:::: {.col}
`shell.nix`

```nix
let
  pkgs = import (fetchTarball {
    url = ...; # url of nixpkgs
    sha256 = ...;
  }) {};
in pkgs.mkShell {
  packages = with pkgs; [
    # for compilation
    python3 scons zlib ...
  ];
  shellHook = ''
    PYTHONPATH+=":..."
    export PYTHONPATH
  '';
}
```
::::
:::: {.col}
* åŒ…é›†åˆï¼ˆnixpkgsï¼‰çš„ç‰ˆæœ¬
* è£…å“ªäº›åŒ…
* ç¯å¢ƒå˜é‡
::::
:::

## nix-shellä½¿ç”¨åœºæ™¯å®ä¾‹-ç»­ {data-auto-animate=1}

::: {.container}
:::: {.col}
`shell.nix`

```nix
let
  pkgs = import (fetchTarball {
    url = ...; # url of nixpkgs
    sha256 = ...;
  }) {};
in pkgs.mkShell {
  packages = with pkgs; [
    # for compilation
    python3 scons zlib ...
  ];
  shellHook = ''
    PYTHONPATH+=":..."
    export PYTHONPATH
  '';
}
```
::::
:::: {.col}
* åŒ…é›†åˆï¼ˆnixpkgsï¼‰çš„ç‰ˆæœ¬
*
  ```nix
  pkgs = import (fetchTarball {
    url = ...; # url of nixpkgs
    sha256 = ...;
  }) {};
  ```
* è£…å“ªäº›åŒ…
* ç¯å¢ƒå˜é‡
::::
:::

## nix-shellä½¿ç”¨åœºæ™¯å®ä¾‹-ç»­ {data-auto-animate=1}

::: {.container}
:::: {.col}
`shell.nix`

```nix
let
  pkgs = import (fetchTarball {
    url = ...; # url of nixpkgs
    sha256 = ...;
  }) {};
in pkgs.mkShell {
  packages = with pkgs; [
    # for compilation
    python3 scons zlib ...
  ];
  shellHook = ''
    PYTHONPATH+=":..."
    export PYTHONPATH
  '';
}
```
::::
:::: {.col}
* åŒ…é›†åˆï¼ˆnixpkgsï¼‰çš„ç‰ˆæœ¬
* è£…å“ªäº›åŒ…
*
  ```nix
  packages = with pkgs; [
    # for compilation
    python3 scons zlib ...
  ];
  ```
* ç¯å¢ƒå˜é‡
::::
:::

## nix-shellä½¿ç”¨åœºæ™¯å®ä¾‹-ç»­ {data-auto-animate=1}

::: {.container}
:::: {.col}
`shell.nix`

```nix
let
  pkgs = import (fetchTarball {
    url = ...; # url of nixpkgs
    sha256 = ...;
  }) {};
in pkgs.mkShell {
  packages = with pkgs; [
    # for compilation
    python3 scons zlib ...
  ];
  shellHook = ''
    PYTHONPATH+=":..."
    export PYTHONPATH
  '';
}
```
::::
:::: {.col}
* åŒ…é›†åˆï¼ˆnixpkgsï¼‰çš„ç‰ˆæœ¬
* è£…å“ªäº›åŒ…
* ç¯å¢ƒå˜é‡
*
  ```nix
  shellHook = ''
    PYTHONPATH+=":..."
    export PYTHONPATH
  '';
  ```
::::
:::

## nix-shellä½¿ç”¨åœºæ™¯å®ä¾‹-ç»“æœ

::: {.container}
:::: {.col}
åŒå­¦å£¹ğŸ¤“

---

æäº†ä¸€ä¸ªgem5é¡¹ç›®

```bash
cd ~/Codes/gem5/
å†™å¥½äº†nix-shell.nix
# æäº¤åˆ°gitlabä»“åº“
```
::::
:::: {.col .fragment data-fragment-index="1"}
åŒå­¦è´°[ğŸ˜]{.fragment data-fragment-index="3"}

---

åœ¨ubuntu22ä¸Š

```bash
cd ~/Codes/gem5/
nix-shell
# å¼€å§‹ç¼–è¯‘
```
::::
:::: {.col .fragment data-fragment-index="2"}
åŒå­¦å[ğŸ¥°]{.fragment data-fragment-index="3"}

---

åœ¨æœåŠ¡å™¨ï¼ˆubuntu16ï¼‰ä¸Š

```bash
cd ~/Codes/gem5/
nix-shell
# å¼€å§‹ç¼–è¯‘
```
::::
:::

</br>


[æˆåŠŸç¼–è¯‘ğŸ‰ğŸ‰ğŸ‰]{.fragment data-fragment-index="3"}

::: {.fragment data-fragment-index="4"}
å¹¶ä¸”
:::

## ç¼–è¯‘ç»“æœäºŒè¿›åˆ¶çº§åˆ«ä¸€è‡´ï¼ {data-background-video="./images/ohhh.mp4"}

::: {.container .fragment data-fragment-index=1}
:::: {.col}
åŒå­¦å£¹ğŸ¤“
::::
:::: {.col}
åŒå­¦è´°ğŸ˜
::::
:::: {.col}
åŒå­¦åğŸ¥°
::::
:::

::: {.fragment data-fragment-index=1 style="font-size: 48pt;"}
```bash
md5sum ~/Codes/gem5/build/X86/gem5.debug
```

ä¸€æ¨¡ä¸€æ ·ï¼
:::

# NixåŸç†

## å¤šç‰ˆæœ¬

* æŠ›å¼ƒFHS (Filesystem Hierarchy Standard): `/bin`, `/lib`, ...
* æ‰€æœ‰çš„åŒ…å°†è¢«hashï¼Œå…¨éƒ¨æ”¾åœ¨`/nix/store/`é‡Œ
* å‘½åæ–¹å¼`/nix/store/<hash>-<pname>-<version>`

::: {.fragment}
```bash
bap4d0lpcrhpwmpb8ayjcgkmvfj62lnq-bash-interactive-5.1-p16
bjp36ahgqs5m2j29kp3ni8x8zb3s7crc-bash-interactive-5.1-p16
f01r6lmbi7mg0xg80mvzdwqhlmrzvy4v-bash-interactive-5.2-p15
gmz9kyy7m7dvbp34wjpmqjyir58z0xch-bash-interactive-5.1-p16
```
:::

[æ··ä¹±çš„ç”¨æˆ·ç¯å¢ƒï¼Ÿ]{.fragment}

## å¤šç‰ˆæœ¬-ç»Ÿä¸€çš„ç”¨æˆ·ç¯å¢ƒ

ç¬¦å·é“¾æ¥

::: {.fragment}
<h3>ä»¥å¯æ‰§è¡Œç¨‹åºä¸ºä¾‹</h3>

`PATH=~/.nix-profile/bin:...`

æ‰€æœ‰ç”¨æˆ·éœ€è¦ç¨‹åºä¼šè¢«ç¬¦å·é“¾æ¥åˆ°æ”¹æ–‡ä»¶å¤¹

:::: {.fragment style="font-size: 36pt;"}
```bash
$ which vim
~/.nix-profile/bin/vim
```
::::
:::: {.fragment style="font-size: 36pt;"}
```bash
$ realpath ~/.nix-profile/bin/vim
/nix/store/9gzxr4ij4i0h1zyvkai8k7jq2dpprr2k-neovim-0.8.1/bin/nvim
```
::::
:::

## å¤šç‰ˆæœ¬-æ€»

<img src="images/multi-versions.svg" style="width: 80%;">

## æ­£ç¡®çš„ä¾èµ–å…³ç³» {data-auto-animate=1}

* ç”¨æˆ·è§†è§’åªèƒ½çœ‹åˆ°å•ä¸€çš„
  * `~/.nix-profile/bin/`
  * `~/.nix-profile/lib/`
  * ...

::: {.fragment}
* æŸä¸ªåŒ…ä¾èµ–æŸä¸ªç‰¹å®šç‰ˆæœ¬çš„å¯æ‰§è¡Œç¨‹åºï¼Ÿ
* æŸä¸ªåŒ…ä¾èµ–æŸä¸ªç‰¹å®šç‰ˆæœ¬çš„åŠ¨æ€é“¾æ¥åº“ï¼Ÿ
* ...
:::

## æ­£ç¡®çš„ä¾èµ–å…³ç³»-è§£å†³ {data-auto-animate=1}

* æŸä¸ªåŒ…ä¾èµ–æŸä¸ªç‰¹å®šç‰ˆæœ¬çš„å¯æ‰§è¡Œç¨‹åºï¼Ÿ

å†™ç»å¯¹è·¯å¾„

* æŸä¸ªåŒ…ä¾èµ–æŸä¸ªç‰¹å®šç‰ˆæœ¬çš„åŠ¨æ€é“¾æ¥åº“ï¼Ÿ

ELFæ–‡ä»¶Dynamic sectionçš„`RUNPATH`

å¯ä½¿ç”¨`readelf -d`æŸ¥çœ‹

åŠ¨æ€é“¾æ¥å™¨`ld.so`ä¼šæ ¹æ®å¯»æ‰¾`RUNPATH`å»æ‰¾åŠ¨æ€é“¾æ¥åº“

## å…¶ä»–çš„åŸç†ç­‰å¾…ä½ æ¥æ¢ç´¢

* å¤šç”¨æˆ·
* å›æ»š
* åƒåœ¾å›æ”¶
* ...

# è°¢è°¢

::: {.container}
:::: {.col style="width:30%;"}
<img src="./images/slides_location.svg" style="width:100%;">
::::
:::: {.col}
* [æˆ‘çš„Nix/NixOSé…ç½®](https://github.com/xieby1/nix_config)
* [æˆ‘çš„Nixè„šæœ¬](https://xieby1.github.io/scripts/index.html#nix-scripts)
* [Martins3çš„Nix/NixOSé…ç½®](https://github.com/Martins3/My-Linux-Config/tree/master/nixpkgs)
* [Innor6çš„Nix/NixOSé…ç½®](https://github.com/innor6/My-Linux-Config/tree/fire-nixos/nix)
::::
:::
